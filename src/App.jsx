import React, { useState, useEffect, createContext, useContext, useRef, useMemo } from 'react'
import {
  Home, Package, Factory, Receipt, Truck, Users, Settings, BarChart3,
  Sparkles, MessageCircle, Building2, ChevronRight, ChevronDown, ChevronLeft,
  DollarSign, ShoppingCart, Wrench, Calendar, Clock, AlertTriangle,
  CheckCircle, CheckCircle2, TrendingUp, TrendingDown, FileText, Bell, Eye, Edit3,
  Search, Filter, Plus, Trash2, Send, RotateCcw, Layers, TreePine,
  Calculator, Zap, Upload, Camera, Scan, Target, ClipboardList,
  Globe, Phone, Shield, Key, Menu, Loader2, X, UserCheck, UserX,
  Wallet, MapPin, Activity, CreditCard, PieChart, Printer, Download,
  Save, RefreshCw, LogOut, User, Lock, Mail, Hash, Tag, Box,
  Warehouse, ArrowRight, ArrowLeft, MoreVertical, Copy, Archive,
  Languages, Check, AlertCircle, Info, HelpCircle, ExternalLink, Play,
  Car, Hammer, CalendarDays, FileUp, Briefcase, UserPlus, Banknote,
  Fuel, MapPinned, Navigation, FileImage, FileScan, Brain, BookOpen,
  Cog, AlertOctagon, ClipboardCheck, Timer, BadgeCheck, QrCode, History,
  List, FileOutput
} from 'lucide-react'

// ============================================
// VERSION INFO
// ============================================
const VERSION = '11.0'
const VERSION_DATE = '2026-02-02'

// v11.0 COMPLETE IND ERP - PRODUCTION READY
// =========================================
// ALL 36 LOCKED SPECIFICATIONS + PRODUCTION MAPPING FROM EXCEL
// (Production Mapping constants defined below with INITIAL_DEPARTMENTS)

// v11.0 COMPLETE IND ERP - PRODUCTION READY
// =========================================
// Best practices extracted from: SAP, Oracle, Microsoft Dynamics, Odoo, ERPNext, NetSuite, 
// Epicor, Fishbowl, Cin7, Salesforce, Monday.com, Asana, Notion, Airtable, ClickUp, 
// Zoho, Freshworks, Jira, Trello, Workday, QuickBooks, Xero
//
// ALL 36 LOCKED SPECIFICATIONS IMPLEMENTED:
// ----------------------------------------
// 1. LOT NUMBER SYSTEM - IND Code (IND-MLH/H/W/L) + Lot# (LP14926, TH14928, etc.)
// 2. INVENTORY DISPLAY - Grouped by IND Code, click to expand lots
// 3. WOOD TYPE COLORS - MLH=Yellow, PW=Green, PLY=Blue, PRTB=Orange
// 4. LABEL FORMAT - QR code with lot#, IND code, qty, date
// 5. 6 STORES - RM(STORE1), IND2(STORE2), Consumables(STORE3), Office(STORE4), Maintenance(STORE5), FG(STORE6)
// 6. 11 DEPARTMENTS - C1, C2, P1, P2, P3, ASM1, ASM2, OVN, QC, QA, FG (Flow: Cutting‚ÜíProcessing‚ÜíAssembly‚ÜíOven‚ÜíQC‚ÜíFG)
// 7. APPROVAL HIERARCHY - ‚â§‡∏ø10K=Production Manager, ‚â§‡∏ø50K=GM, >‡∏ø50K=CEO
// 8. PR‚ÜíPO FLOW - Need‚ÜíPR‚ÜíApproval‚ÜíPO‚ÜíVendor (via Email/LINE, NO FAX)
// 9. IND vs IND2 - Separate entities, IND2 manufactures plywood
// 10. WORK ORDER FORMAT - WO-YYMMDD-XXX
// 11. LOGISTICS - G Thru handles import/export (Container#, ETD, ETA, Customs)
// 12. LC PROCESS - Track on bank website, ERP tracks LC opened/ref#/status
// 13. QR LABELS - ALL 6 stores use QR labels
// 14. WO RULE - 1 WO per PO/PR, no sharing materials
// 15. QC CHECKLIST - Product-by-product configurable
// 16. CUSTOMER LABELS - Allianz QR (vendor 115050), Polyplex 4-column (FILM=white, CPP=peach, Line10=red)
// 17. STAFF HOUSING - Room rent(flat) + Water(flat) + Electric(metered) ‚Üí Payroll deduction
// 18. IMPORT COSTING - 13 types (FOB, Freight, Insurance, LC, Bank, Duty, Customs, Logistics, Warehouse, Transport, THT, Fumigation, Other)
// 19. HEAT TREATMENT - TH-0950, 56¬∞C/30min, Cert#: YYMMDD+seq
// 20. PRODUCTION - Order-based planning, 1-3 day lead time, PLN scenarios
// 21. WASTAGE PROGRAM - Make plant holders/tables/coasters
// 22. OCR FOR PO/DRAWINGS - Extract BOM from technical drawings
// 23-28. SALES - QT/IV/DO formats, Customer-YY-XXX for DO, 15/30 day returns, CEO discount approval
// 29. TRANSPORT - 4 trucks (Mayo, W, T, C), 100%+50% allowance, bonuses (45+ trips, after 7PM, holiday)
// 30-31. ACCOUNTING - Day book (Noon), VAT I/O, WHT 3%, KBank+TTB
// 32-34. INVENTORY - Receiving (can reject), Issue (WO# mandatory for RM), Monthly stock count, Low stock alert
// 35. MAINTENANCE - STORE5 (spare parts, tools, diesel ~8L/week), MWO-YYMMDD-XXX
// 36. HR/PAYROLL - SSO, tax calc, housing deduction, driver allowance, Thai payslip
//
// KEY FEATURES:
// - ORDER TRACKER: 4-level expansion (Order‚ÜíLines‚ÜíSchedule‚ÜíHistory)
// - PRODUCTION PO TRACKER: Same data, production view with WO linkage
// - OCR PO UPLOAD: Upload image/PDF, auto-extract PO#, date, items
// - SALES REPORT: Monthly consolidated, 3-level drill-down
// - ALL PRINT VIEWS: Invoice, Export Invoice, DO, Quotation, HT Cert, CN, Receipt
// - STORE 5 ‚Üî MAINTENANCE: Fully linked, issue parts against MWO
// - QUOTATION WORKFLOW: Draft‚ÜíSent‚ÜíAccepted/Rejected‚ÜíSO conversion

// v10.3 PRODUCTION PO TRACKER & OCR:
// 1. PO TRACKER TAB IN PRODUCTION - View all POs with production status at glance
//    - Shows: Customer PO, Items, WO#, Production Progress, Delivery Status
//    - Expandable rows: Line items ‚Üí WO details ‚Üí Production path
// 2. OCR PO UPLOAD - Upload PO image/PDF, extract PO#, date, items
//    - Accessible from Order Tracker ‚Üí Click order ‚Üí Update/Upload PO
// 3. STORE 5 LINKAGE VERIFIED - Maintenance Store properly connected

// v9.0 NEW FEATURES - ORDER-TO-DELIVERY TRACKER:
// 1. COMPLETE ORDER TRACKER - Running table with 4-level expansion (Order ‚Üí Lines ‚Üí Schedule ‚Üí History)
// 2. PRODUCTION PATH VISUALIZATION - Shows department flow (Singh‚ÜíP1‚ÜíQA‚ÜíA1‚ÜíOven‚ÜíQC‚ÜíFG‚ÜíTransport)
// 3. DELIVERY CALENDAR - 3 views (Monthly, Weekly, Customer)
// 4. FULL REVISION HISTORY - Every change tracked with who/when/why
// 5. CUSTOMER VIEW - Delivery timeline and order summary per customer
// 6. AUTO STATUS TRACKING - Draft ‚Üí Producing ‚Üí Ready ‚Üí Partial ‚Üí Complete
// 7. PRODUCTION SCENARIO MAPPING - PLN 0, PLN 1, PLN 1.1.1, etc. from Production Mapping
// 8. REAL-TIME BALANCE - Total/Produced/Delivered/Balance at glance

// v8.7 FEATURES - DELIVERY SCHEDULE MANAGEMENT:
// 1. CUSTOMER DELIVERY LOCATIONS - Multiple locations per customer (e.g. Polyplex PLOT 1/2/3)
// 2. DELIVERY SCHEDULE PER ITEM - Split orders into partial deliveries at different locations/dates
// 3. CUSTOMER REQUEST-BASED REVISIONS - Sales updates schedules based on customer requests (not capacity)
// 4. REVISION HISTORY TRACKING - Full audit trail: who changed, when, from/to dates, reason
// 5. ORDER TYPE FLAGS - PR/PO/Direct per customer
// 6. SCHEDULE STATUS - Planned ‚Üí Revised ‚Üí Confirmed workflow
// 7. WO CREATED BY PRODUCTION - Production creates WO from SO dropdown (not Sales)
// 8. PRODUCTION WO FORM ENHANCED - Dropdown to select pending SOs, auto-fill customer/product

// v8.6 FEATURES - CRITICAL BUSINESS LOGIC:
// 1. TRANSPORT ALLOWANCES - Full calculation per spec (100% furthest + 50% additional, bonuses)
// 2. DISCOUNT APPROVAL WORKFLOW - CEO approval required, reason tracking, approval status
// 3. SO ‚Üí WO DISPLAY - Sales Orders show linked Work Orders (display only, WO created by Production)
// 4. CN ‚Üí INVOICE BALANCE - Credit Notes now automatically reduce invoice balance
// 5. QUOTATION DISCOUNT BLOCKING - Cannot save quotation with unapproved discount
//
// v8.5 FEATURES:
// 1. SALES KPI DASHBOARD - Collection rate, DSO, overdue amount, win rate, avg order value
// 2. TOP CUSTOMERS - Revenue ranking with click to statement
// 3. CUSTOMER STATEMENT PRINT - All invoices/payments/CN for customer
// 4. CREDIT NOTE PRINT VIEW - Professional CN document with signatures
// 5. RECEIPT ACKNOWLEDGMENT - For driver to get customer signature on delivery
// 6. AR AGING ENHANCEMENTS - Customer filter, bucket filter, action buttons
// 7. QUOTATION TABLE ENHANCED - Category (new/potential/existing), reason columns
// 8. CUSTOMERS TAB - Customer list with special requirements, revenue, outstanding
// 9. PRICE HISTORY TAB - Track all price changes with email ref and approval (per policy)
// 10. CUSTOMER SPECIAL REQUIREMENTS - Allianz QR, Polyplex labels, HT cert flags
//
// v8.3 FEATURES - QUOTATION ENHANCEMENTS & CUSTOMER LABELS:
// 1. QUOTATION CUSTOMER CATEGORY - new/potential/existing classification
// 2. QUOTATION REASON - new_product/price_change/new_customer/special_request
// 3. ALLIANZ QR LABELS - Invoice QR + Packaging labels with vendor code 115050
//    Format: PO$Invoice$VendorCode and PartNo$Qty$PO$VendorCode
// 4. POLYPLEX 4-COLUMN LABELS - Color coded by delivery location
//    FILM=White, CPP=Peach, Line10=Red
// 5. SMART LABEL BUTTONS - Show only for relevant customers (ALL-013, PLX-002)
//
// v8.2 FEATURES - PRINT VIEWS & CERTIFICATES:
// 1. TAX INVOICE PRINT - Full Thai Tax Invoice format with signatures
// 2. EXPORT INVOICE PRINT - Commercial Invoice (NO VAT) + Packing List
// 3. HEAT TREATMENT CERTIFICATE - ISPM15 TH-0950 format, 56¬∞C/30min
// 4. DELIVERY ORDER PRINT - With driver/truck info, customer signature
// 5. QUOTATION PRINT - Professional quote with terms & conditions
// 6. PRINT CONTROLS - Print button with preview in all documents
// 7. ENHANCED CUSTOMERS - 8 customers with trip costs, special requirements
// 8. ALLIANZ/POLYPLEX - QR labels, HT cert, 4-column labels config
//
// v8.1 FEATURES - COMPLETE SALES MODULE:
// 1. REJECTION FORM (REJ-YYMM-XXX) - Record goods returns with reasons, actions
// 2. CLAIM FORM (CLM-YYMM-XXX) - Customer disputes/compensation tracking
// 3. CREDIT NOTE (CN-YYMM-XXX) - Auto-generate from rejections, apply to invoices
// 4. SALES MEETING LOG - Track customer visits, outcomes, follow-ups due
// 5. MEETING DASHBOARD - This month, follow-ups due, orders won stats
// 6. ENHANCED CUSTOMERS - Type (local/export), trip cost, special requirements
// 7. ALLIANZ/POLYPLEX SUPPORT - QR labels, HT certificate, 4-column labels
// 8. 10 SALES TABS - Dashboard, Quotations, SO, DO, Invoices, Payments, AR Aging, Returns, Claims, Meetings
//
// v8.0 FEATURES - COMPLETE SALES FLOW (Order-to-Cash):
// 1. QUOTATION MODULE - Create/Edit/Send quotations (QT-YYMM-XXX), validity tracking, convert to SO
// 2. ENHANCED SALES ORDERS - Full line item management, link from quotation, delivery tracking
// 3. DELIVERY ORDER (DO) - Create from SO, partial deliveries, truck/driver assignment, status tracking
// 4. ENHANCED INVOICES - Auto-create from DO, proper due date calculation, payment terms
// 5. PAYMENT RECORDING - Record payments against invoices, partial payments, multiple methods
// 6. AR AGING REPORT - Current/30/60/90/90+ days buckets, overdue highlighting, customer analysis
// 7. SALES DASHBOARD - Visual flow diagram, revenue summary, recent activity
// 8. FULL AUDIT TRAIL - Quote‚ÜíSO‚ÜíDO‚ÜíInvoice‚ÜíPayment linking
//
// v7.9 FEATURES - COMPLETE MWO TRACKING:
// 1. MAINTENANCE TEAM DASHBOARD - Shows all technicians, skills, hourly rates, current assignments
// 2. ENHANCED MWO CARDS - Shows assigned technicians, work logs, parts used, total costs
// 3. MWO DETAIL MODAL - 4 tabs: Info, Work Log, Parts Used, Cost Summary
// 4. WORK LOG ENTRY - Add technician hours with auto-calculated labor costs
// 5. EQUIPMENT COST ANALYSIS - Track maintenance cost per equipment, cost ratio vs purchase price
// 6. TECHNICIAN TRACKING - Hours logged, labor cost breakdown per technician
// 7. COST EFFECTIVENESS - Color-coded cost ratios (green/yellow/orange/red)
//
// v7.8 FEATURES:
// 1. ISSUE HISTORY VIEW - Full table showing all issued parts with date, qty, MWO#, cost, notes
// 2. STORE VIEW TOGGLE - Switch between Inventory and Issue History views
// 3. ISSUE STATS - Total issues, qty, value, MWO-linked count
// 4. DEMO ISSUE DATA - 5 sample issue records to demonstrate feature
//
// v7.7 FEATURES:
// 1. STORE5 LINKAGE - Inventory Module now shows STORE5 (Maintenance) items
// 2. UNIFIED DATA - Maintenance Store synced between Inventory & Maintenance modules
// 3. ENHANCED STORE5 VIEW - Special table layout for maintenance parts (SKU, Unit, Min/Max, Location)
//
// v7.6 FEATURES (Inspired by Odoo, ClickUp, ERPNext, SAP):
// 1. GLOBAL SEARCH (‚åòK / Ctrl+K) - Search all: customers, WOs, invoices, inventory, POs, employees
// 2. NOTIFICATION CENTER - Overdue WOs, Low stock alerts, Pending PO approvals, QC labels pending
// 3. QUICK ACTIONS (Q key) - New WO, SO, PO, Invoice, Maintenance Request shortcuts
// 4. KANBAN BOARD - Drag-drop WOs between departments (C1‚ÜíC2‚ÜíP1‚ÜíP2‚ÜíP3‚ÜíASM1‚ÜíASM2‚ÜíOVN‚ÜíQC‚ÜíFG)
// 5. PRODUCTION VIEW TOGGLE - Switch between Tabs and Kanban board views
// 6. KEYBOARD SHORTCUTS - ‚åòK (search), Q (quick actions), ESC (close all)
// 7. ENHANCED MAINTENANCE - 7 tabs: Dashboard, Requests, MWO, Equipment, Building, Store, PM Schedule

// ============================================
// IND LOGO (SVG as base64)
// ============================================
const IND_LOGO_SVG = `data:image/svg+xml,${encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 220">
  <polygon points="30,180 100,50 30,50" fill="#1A5276"/>
  <polygon points="100,50 170,180 170,50" fill="#2ECC40"/>
  <polygon points="100,50 170,180 100,180" fill="#5DADE2"/>
  <polygon points="70,130 100,80 130,130" fill="white"/>
  <text x="100" y="210" text-anchor="middle" font-family="Arial Black, sans-serif" font-size="36" font-weight="bold" fill="#8B4513">IND</text>
</svg>
`)}`

// ============================================
// BRAND COLORS & THEME
// ============================================
const BRAND = {
  green: '#2ECC40',
  teal: '#1A5276',
  sky: '#5DADE2',
  brown: '#8B4513',
  gradientPrimary: 'from-[#1A5276] to-[#2ECC40]',
  gradientSecondary: 'from-[#5DADE2] to-[#2ECC40]',
}

// ============================================
// AUTHENTICATION CONTEXT
// ============================================
const AuthContext = createContext()
const useAuth = () => useContext(AuthContext)

// ============================================
// ROLE-BASED ACCESS CONTROL
// ============================================
const ROLES = {
  admin: {
    id: 'admin',
    name: 'Administrator',
    nameTh: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
    color: 'bg-purple-600',
    modules: ['dashboard', 'admin', 'inventory', 'purchase', 'production', 'sales', 'hr', 'accounting', 'transport', 'maintenance', 'reports'],
    permissions: ['all']
  },
  sales: {
    id: 'sales',
    name: 'Sales Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢',
    color: 'bg-blue-500',
    modules: ['dashboard', 'sales'],
    permissions: ['sales.view', 'sales.create', 'sales.edit']
  },
  production: {
    id: 'production',
    name: 'Production Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏¥‡∏ï',
    color: 'bg-orange-500',
    modules: ['dashboard', 'production', 'inventory'],
    permissions: ['production.view', 'production.edit', 'inventory.view']
  },
  warehouse: {
    id: 'warehouse',
    name: 'Warehouse Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á',
    color: 'bg-yellow-600',
    modules: ['dashboard', 'inventory', 'purchase'],
    permissions: ['inventory.all', 'purchase.receive']
  },
  hr: {
    id: 'hr',
    name: 'HR Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HR',
    color: 'bg-pink-500',
    modules: ['dashboard', 'hr'],
    permissions: ['hr.all']
  },
  accounting: {
    id: 'accounting',
    name: 'Accounting Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ',
    color: 'bg-green-500',
    modules: ['dashboard', 'accounting', 'reports', 'sales'],
    permissions: ['accounting.all', 'reports.view', 'sales.view']
  },
  transport: {
    id: 'transport',
    name: 'Transport Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á',
    color: 'bg-cyan-500',
    modules: ['dashboard', 'transport'],
    permissions: ['transport.all']
  },
  maintenance: {
    id: 'maintenance',
    name: 'Maintenance Staff',
    nameTh: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á',
    color: 'bg-purple-500',
    modules: ['dashboard', 'maintenance'],
    permissions: ['maintenance.all']
  },
}

// ============================================
// DEMO USER ACCOUNTS
// ============================================
const DEMO_USERS = [
  { id: 1, username: 'admin', password: 'admin123', name: 'Vinit Dhariwal', nameTh: '‡∏ß‡∏¥‡∏ô‡∏¥‡∏ï ‡∏ò‡∏≤‡∏£‡∏µ‡∏ß‡∏≤‡∏•', role: 'admin', department: 'office', entity: 'IND', email: 'vinit@indthai.com' },
  { id: 2, username: 'sales1', password: 'sales123', name: 'Kanya Srisuk', nameTh: '‡∏Å‡∏±‡∏ç‡∏ç‡∏≤ ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç', role: 'sales', department: 'sales', entity: 'IND', email: 'kanya@indthai.com' },
  { id: 3, username: 'prod1', password: 'prod123', name: 'Somchai Yodrak', nameTh: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏Å', role: 'production', department: 'production', entity: 'IND', email: 'somchai@indthai.com' },
  { id: 4, username: 'wh1', password: 'wh123', name: 'Prasert Thongdee', nameTh: '‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏ó‡∏≠‡∏á‡∏î‡∏µ', role: 'warehouse', department: 'warehouse', entity: 'IND', email: 'prasert@indthai.com' },
  { id: 5, username: 'hr1', password: 'hr123', name: 'Nanthana Boonmee', nameTh: '‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏°‡∏µ', role: 'hr', department: 'hr', entity: 'IND', email: 'nanthana@indthai.com' },
  { id: 6, username: 'acc1', password: 'acc123', name: 'Pakamas Rattana', nameTh: '‡∏ú‡∏Å‡∏≤‡∏°‡∏≤‡∏® ‡∏£‡∏±‡∏ï‡∏ô‡∏∞', role: 'accounting', department: 'accounting', entity: 'IND2', email: 'pakamas@indthai.com' },
  { id: 7, username: 'trans1', password: 'trans123', name: 'Vichai Kaewsri', nameTh: '‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÅ‡∏Å‡πâ‡∏ß‡∏®‡∏£‡∏µ', role: 'transport', department: 'transport', entity: 'IND', email: 'vichai@indthai.com' },
  { id: 8, username: 'maint1', password: 'maint123', name: 'Boonlert Jaidee', nameTh: '‡∏ö‡∏∏‡∏ç‡πÄ‡∏•‡∏¥‡∏® ‡πÉ‡∏à‡∏î‡∏µ', role: 'maintenance', department: 'maintenance', entity: 'IND', email: 'boonlert@indthai.com' },
]

// ============================================
// LANGUAGE SYSTEM (6 Languages)
// ============================================
const LanguageContext = createContext()

const LANGUAGES = {
  en: { name: 'English', flag: 'üá¨üáß', dir: 'ltr' },
  th: { name: '‡πÑ‡∏ó‡∏¢', flag: 'üáπüá≠', dir: 'ltr' },
  my: { name: '·Äô·Äº·Äî·Ä∫·Äô·Ä¨', flag: 'üá≤üá≤', dir: 'ltr' },
  kh: { name: '·ûÅ·üí·ûò·üÇ·ûö', flag: 'üá∞üá≠', dir: 'ltr' },
  zh: { name: '‰∏≠Êñá', flag: 'üá®üá≥', dir: 'ltr' },
  jp: { name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ', dir: 'ltr' },
}

const TRANSLATIONS = {
  // Common
  'app.title': {
    en: 'IND Thai Packwell',
    th: 'IND ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå',
    my: 'IND ·Äë·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äï·ÄÄ·Ä∫·ÄÅ·Ä∫·Äù·Ä≤·Äú·Ä∫',
    kh: 'IND ·ûê·üÉ ·ûï·üÇ·ûÄ·ûú·üÇ·ûõ',
    zh: 'IND Ê≥∞ÂõΩÂåÖË£Ö',
    jp: 'IND „Çø„Ç§„Éë„ÉÉ„ÇØ„Ç¶„Çß„É´',
  },
  'app.subtitle': {
    en: 'Enterprise Resource Planning',
    th: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£',
    my: '·Äú·ÄØ·Äï·Ä∫·ÄÑ·Äî·Ä∫·Ä∏·Äõ·ÄÑ·Ä∫·Ä∏·Äô·Äº·ÄÖ·Ä∫·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ',
    kh: '·ûÄ·û∂·ûö·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûí·ûì·ûí·û∂·ûì·ûü·û†·ûÇ·üí·ûö·û∂·ûü',
    zh: '‰ºÅ‰∏öËµÑÊ∫êËßÑÂàí',
    jp: '‰ºÅÊ•≠Ë≥áÊ∫êË®àÁîª',
  },
  'nav.dashboard': { en: 'Dashboard', th: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î', my: '·Äí·ÄÄ·Ä∫·Äõ·Äæ·Ä∫·Äò·ÄØ·Äê·Ä∫', kh: '·ûï·üí·ûë·û∂·üÜ·ûÑ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ', zh: '‰ª™Ë°®Êùø', jp: '„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ' },
  'nav.admin': { en: 'Admin Hub', th: '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', my: '·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ·Äó·Äü·Ä≠·ÄØ', kh: '·ûò·ûá·üí·ûà·ûò·ûé·üí·ûå·ûõ·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ', zh: 'ÁÆ°ÁêÜ‰∏≠ÂøÉ', jp: 'ÁÆ°ÁêÜ„Éè„Éñ' },
  'nav.inventory': { en: 'Inventory', th: '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', my: '·ÄÖ·Äê·Ä±·Ä¨·Ä∑', kh: '·ûü·üí·ûè·ûª·ûÄ', zh: 'Â∫ìÂ≠ò', jp: 'Âú®Â∫´' },
  'nav.purchase': { en: 'Purchase', th: '‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠', my: '·Äù·Äö·Ä∫·Äö·Ä∞·Äõ·Ä±·Ä∏', kh: '·ûÄ·û∂·ûö·ûë·û∑·ûâ', zh: 'ÈááË¥≠', jp: 'Ë≥ºË≤∑' },
  'nav.production': { en: 'Production', th: '‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï', my: '·Äë·ÄØ·Äê·Ä∫·Äú·ÄØ·Äï·Ä∫·Äõ·Ä±·Ä∏', kh: '·ûï·ûõ·û∑·ûè·ûÄ·ûò·üí·ûò', zh: 'Áîü‰∫ß', jp: 'ÁîüÁî£' },
  'nav.sales': { en: 'Sales', th: '‡∏Ç‡∏≤‡∏¢', my: '·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Äª·Äõ·Ä±·Ä∏', kh: '·ûÄ·û∂·ûö·ûõ·ûÄ·üã', zh: 'ÈîÄÂîÆ', jp: 'Ë≤©Â£≤' },
  'nav.hr': { en: 'HR', th: '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', my: 'HR', kh: '·ûí·ûì·ûí·û∂·ûì·ûò·ûì·ûª·ûü·üí·ûü', zh: '‰∫∫ÂäõËµÑÊ∫ê', jp: '‰∫∫‰∫ã' },
  'nav.accounting': { en: 'Accounting', th: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', my: '·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ·ÄÑ·Ä∫', kh: '·ûÇ·ûé·ûì·üÅ·ûô·üí·ûô', zh: '‰ºöËÆ°', jp: '‰ºöË®à' },
  'nav.transport': { en: 'Transport', th: '‡∏Ç‡∏ô‡∏™‡πà‡∏á', my: '·Äû·Äö·Ä∫·Äö·Ä∞·Äï·Ä≠·ÄØ·Ä∑·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Ä±·Ä∏', kh: '·ûä·ûπ·ûÄ·ûá·ûâ·üí·ûá·ûº·ûì', zh: 'ËøêËæì', jp: 'Ëº∏ÈÄÅ' },
  'nav.maintenance': { en: 'Maintenance', th: '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', my: '·Äï·Äº·ÄØ·Äï·Äº·ÄÑ·Ä∫·Äë·Ä≠·Äî·Ä∫·Ä∏·Äû·Ä≠·Äô·Ä∫·Ä∏·Äõ·Ä±·Ä∏', kh: '·ûê·üÇ·ûë·û∂·üÜ', zh: 'Áª¥Êä§', jp: '„É°„É≥„ÉÜ„Éä„É≥„Çπ' },
  'nav.reports': { en: 'Reports', th: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', my: '·Ä°·ÄÖ·ÄÆ·Äõ·ÄÑ·Ä∫·ÄÅ·Ä∂·ÄÖ·Ä¨·Äô·Äª·Ä¨·Ä∏', kh: '·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç', zh: 'Êä•Âëä', jp: '„É¨„Éù„Éº„Éà' },
  // Admin
  'admin.stores': { en: 'Store Builder', th: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á', my: '·ÄÖ·Äê·Ä≠·ÄØ·Ä∏·Äê·Ää·Ä∫·ÄÜ·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä∞', kh: '·û¢·üí·ûì·ûÄ·ûü·û∂·ûÑ·ûü·ûÑ·üã·û†·û∂·ûÑ', zh: '‰ªìÂ∫ìÁÆ°ÁêÜ', jp: 'ÂÄâÂ∫´ÁÆ°ÁêÜ' },
  'admin.categories': { en: 'Categories', th: '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', my: '·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏', kh: '·ûî·üí·ûö·ûó·üÅ·ûë', zh: 'Á±ªÂà´', jp: '„Ç´„ÉÜ„Ç¥„É™„Éº' },
  'admin.materials': { en: 'Material Types', th: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏™‡∏î‡∏∏', my: '·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Ä°·Äô·Äª·Ä≠·ÄØ·Ä∏·Ä°·ÄÖ·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏', kh: '·ûî·üí·ûö·ûó·üÅ·ûë·ûü·ûò·üí·ûó·û∂·ûö·üà', zh: 'ÊùêÊñôÁ±ªÂûã', jp: 'ÊùêÊñô„Çø„Ç§„Éó' },
  'admin.customers': { en: 'Customers', th: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', my: '·Äñ·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ää·Ä∫·Äô·Äª·Ä¨·Ä∏', kh: '·û¢·ûè·û∑·ûê·û∑·ûá·ûì', zh: 'ÂÆ¢Êà∑', jp: 'È°ßÂÆ¢' },
  'admin.vendors': { en: 'Vendors', th: '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢', my: '·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÅ·Äª·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏', kh: '·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã', zh: '‰æõÂ∫îÂïÜ', jp: '„Éô„É≥„ÉÄ„Éº' },
  'admin.users': { en: 'Users & Roles', th: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó', my: '·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Äô·Äª·Ä¨·Ä∏·Äî·Äæ·ÄÑ·Ä∑·Ä∫·Ä°·ÄÅ·Äî·Ä∫·Ä∏·ÄÄ·Äè·Äπ·Äç·Äô·Äª·Ä¨·Ä∏', kh: '·û¢·üí·ûì·ûÄ·ûî·üí·ûö·ûæ·ûî·üí·ûö·û∂·ûü·üã·ûì·û∑·ûÑ·ûè·ûΩ·ûì·û∂·ûë·û∏', zh: 'Áî®Êà∑‰∏éËßíËâ≤', jp: '„É¶„Éº„Ç∂„Éº„Å®ÂΩπÂâ≤' },
  // Inventory
  'inventory.title': { en: 'Inventory Management', th: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', my: '·ÄÖ·Äê·Ä±·Ä¨·Ä∑·ÄÖ·ÄÆ·Äô·Ä∂·ÄÅ·Äî·Ä∑·Ä∫·ÄÅ·ÄΩ·Ä≤·Äô·Äæ·ÄØ', kh: '·ûÄ·û∂·ûö·ûÇ·üí·ûö·ûî·üã·ûÇ·üí·ûö·ûÑ·ûü·üí·ûè·ûª·ûÄ', zh: 'Â∫ìÂ≠òÁÆ°ÁêÜ', jp: 'Âú®Â∫´ÁÆ°ÁêÜ' },
  'inventory.totalValue': { en: 'Total Value', th: '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°', my: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äê·Äî·Ä∫·Äñ·Ä≠·ÄØ·Ä∏', kh: '·ûè·ûò·üí·ûõ·üÉ·ûü·ûö·ûª·ûî', zh: 'ÊÄª‰ª∑ÂÄº', jp: 'Á∑èÈ°ç' },
  'inventory.totalLots': { en: 'Total Lots', th: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡πá‡∏≠‡∏ï', my: '·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Ä°·ÄÖ·ÄØ·Ä∂·Äô·Äª·Ä¨·Ä∏', kh: '·û°·ûª·ûè·ûü·ûö·ûª·ûî', zh: 'ÊÄªÊâπÊ¨°', jp: 'Á∑è„É≠„ÉÉ„Éà' },
  'inventory.lowStock': { en: 'Low Stock', th: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î', my: '·ÄÖ·Äê·Ä±·Ä¨·Ä∑·Äî·Ää·Ä∫·Ä∏·Äû·Ää·Ä∫', kh: '·ûü·üí·ûè·ûª·ûÄ·ûë·û∂·ûî', zh: 'Â∫ìÂ≠ò‰∏çË∂≥', jp: 'Âú®Â∫´Â∞ë' },
  // Actions
  'action.save': { en: 'Save', th: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', my: '·Äû·Ä≠·Äô·Ä∫·Ä∏·ÄÜ·Ää·Ä∫·Ä∏·Äõ·Äî·Ä∫', kh: '·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ', zh: '‰øùÂ≠ò', jp: '‰øùÂ≠ò' },
  'action.cancel': { en: 'Cancel', th: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', my: '·Äï·Äö·Ä∫·Äñ·Äª·ÄÄ·Ä∫·Äõ·Äî·Ä∫', kh: '·ûî·üÑ·üá·ûî·ûÑ·üã', zh: 'ÂèñÊ∂à', jp: '„Ç≠„É£„É≥„Çª„É´' },
  'action.edit': { en: 'Edit', th: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', my: '·Äê·Ää·Ä∫·Ä∏·Äñ·Äº·Äê·Ä∫·Äõ·Äî·Ä∫', kh: '·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ', zh: 'ÁºñËæë', jp: 'Á∑®ÈõÜ' },
  'action.delete': { en: 'Delete', th: '‡∏•‡∏ö', my: '·Äñ·Äª·ÄÄ·Ä∫·Äõ·Äî·Ä∫', kh: '·ûõ·ûª·ûî', zh: 'Âà†Èô§', jp: 'ÂâäÈô§' },
  'action.search': { en: 'Search...', th: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...', my: '·Äõ·Äæ·Ä¨·Äñ·ÄΩ·Ä±·Äõ·Äî·Ä∫...', kh: '·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ...', zh: 'ÊêúÁ¥¢...', jp: 'Ê§úÁ¥¢...' },
  'action.upload': { en: 'Upload Document', th: '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', my: '·ÄÖ·Ä¨·Äõ·ÄΩ·ÄÄ·Ä∫·ÄÖ·Ä¨·Äê·Äô·Ä∫·Ä∏·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫', kh: '·ûî·ûâ·üí·ûá·ûº·ûì·ûØ·ûÄ·ûü·û∂·ûö', zh: '‰∏ä‰º†ÊñáÊ°£', jp: '„Éâ„Ç≠„É•„É°„É≥„Éà„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ' },
  'action.logout': { en: 'Logout', th: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', my: '·Äë·ÄΩ·ÄÄ·Ä∫·Äõ·Äî·Ä∫', kh: '·ûÖ·û∂·ûÄ·ûÖ·üÅ·ûâ', zh: 'ÈÄÄÂá∫', jp: '„É≠„Ç∞„Ç¢„Ç¶„Éà' },
  // Login
  'login.title': { en: 'Sign In', th: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', my: '·Äù·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·Äî·Ä∫', kh: '·ûÖ·ûº·ûõ', zh: 'ÁôªÂΩï', jp: '„Çµ„Ç§„É≥„Ç§„É≥' },
  'login.username': { en: 'Username', th: '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', my: '·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äû·Ä∞·Ä°·Äô·Ää·Ä∫', kh: '·ûà·üí·ûò·üÑ·üá·û¢·üí·ûì·ûÄ·ûî·üí·ûö·ûæ', zh: 'Áî®Êà∑Âêç', jp: '„É¶„Éº„Ç∂„ÉºÂêç' },
  'login.password': { en: 'Password', th: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', my: '·ÄÖ·ÄÄ·Ä¨·Ä∏·Äù·Äæ·ÄÄ·Ä∫', kh: '·ûñ·û∂·ûÄ·üí·ûô·ûü·ûò·üí·ûÑ·û∂·ûè·üã', zh: 'ÂØÜÁ†Å', jp: '„Éë„Çπ„ÉØ„Éº„Éâ' },
  'login.signin': { en: 'Sign In', th: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', my: '·Äù·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·Äî·Ä∫', kh: '·ûÖ·ûº·ûõ', zh: 'ÁôªÂΩï', jp: '„Çµ„Ç§„É≥„Ç§„É≥' },
  'login.demo': { en: 'Demo Accounts', th: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏î‡∏•‡∏≠‡∏á', my: 'Demo ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äª·Ä¨·Ä∏', kh: '·ûÇ·ûé·ûì·û∏·ûü·û∂·ûÄ·ûõ·üí·ûî·ûÑ', zh: 'ÊºîÁ§∫Ë¥¶Êà∑', jp: '„Éá„É¢„Ç¢„Ç´„Ç¶„É≥„Éà' },
  // Document Upload
  'upload.title': { en: 'Smart Document Upload', th: '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞', my: '·ÄÖ·Äô·Äê·Ä∫·ÄÖ·Ä¨·Äõ·ÄΩ·ÄÄ·Ä∫·ÄÖ·Ä¨·Äê·Äô·Ä∫·Ä∏·Äê·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏', kh: '·ûî·ûâ·üí·ûá·ûº·ûì·ûØ·ûÄ·ûü·û∂·ûö·ûÜ·üí·ûõ·û∂·ûè·ûú·üÉ', zh: 'Êô∫ËÉΩÊñáÊ°£‰∏ä‰º†', jp: '„Çπ„Éû„Éº„Éà„Éâ„Ç≠„É•„É°„É≥„Éà„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ' },
  'upload.processing': { en: 'Processing document...', th: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...', my: '·ÄÖ·Ä¨·Äõ·ÄΩ·ÄÄ·Ä∫·ÄÖ·Ä¨·Äê·Äô·Ä∫·Ä∏·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫...', kh: '·ûÄ·üÜ·ûñ·ûª·ûÑ·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö·ûØ·ûÄ·ûü·û∂·ûö...', zh: 'Â§ÑÁêÜÊñáÊ°£‰∏≠...', jp: '„Éâ„Ç≠„É•„É°„É≥„ÉàÂá¶ÁêÜ‰∏≠...' },
  'upload.success': { en: 'Document processed successfully!', th: '‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', my: '·ÄÖ·Ä¨·Äõ·ÄΩ·ÄÄ·Ä∫·ÄÖ·Ä¨·Äê·Äô·Ä∫·Ä∏·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨·Äú·ÄØ·Äï·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏!', kh: '·ûä·üÜ·ûé·ûæ·ûö·ûÄ·û∂·ûö·ûØ·ûÄ·ûü·û∂·ûö·ûî·û∂·ûì·ûá·üÑ·ûÇ·ûá·üê·ûô!', zh: 'ÊñáÊ°£Â§ÑÁêÜÊàêÂäü!', jp: '„Éâ„Ç≠„É•„É°„É≥„ÉàÂá¶ÁêÜÊàêÂäü!' },
}

const t = (key, lang) => TRANSLATIONS[key]?.[lang] || TRANSLATIONS[key]?.['en'] || key

// ============================================
// MASTER DATA - 6 STORES
// ============================================
const INITIAL_STORES = [
  { id: 'STORE1', code: 'STORE1', nameEn: 'RM Wood', nameTh: '‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πâ', type: 'raw_material', branch: 'IND', categories: ['MLH', 'PW', 'PWKD', 'PWGRN', 'PRTB', 'PLYWW', 'PLYRR', 'PLYRW'], isActive: true, itemCount: 658, value: 2450000 },
  { id: 'STORE2', code: 'STORE2', nameEn: 'IND 2 Ply', nameTh: '‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏°‡πâ‡∏≠‡∏±‡∏î IND-2', type: 'branch_stock', branch: 'IND-2', categories: ['PLYWW', 'PLYRR', 'PLYRW'], isActive: true, itemCount: 234, value: 680000 },
  { id: 'STORE3', code: 'STORE3', nameEn: 'Consumables', nameTh: '‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á', type: 'consumables', branch: 'IND', categories: ['CONS'], isActive: true, itemCount: 145, value: 145000 },
  { id: 'STORE4', code: 'STORE4', nameEn: 'Office', nameTh: '‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô', type: 'office', branch: 'IND', categories: ['OFFICE'], isActive: true, itemCount: 85, value: 25000 },
  { id: 'STORE5', code: 'STORE5', nameEn: 'Maintenance', nameTh: '‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà', type: 'maintenance', branch: 'IND', categories: ['MAINT'], isActive: true, itemCount: 320, value: 320000 },
  { id: 'STORE6', code: 'STORE6', nameEn: 'Finished FG', nameTh: '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ', type: 'finished_goods', branch: 'IND', categories: ['FG'], isActive: true, itemCount: 1250, value: 1250000 },
]

// ============================================
// MASTER DATA - 12 CATEGORIES
// ============================================
const INITIAL_CATEGORIES = [
  // Raw Material - Wood Types (8 categories)
  { id: 'MLH', code: 'MLH', nameEn: 'Mixed Hardwood', nameTh: '‡πÑ‡∏°‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏Ç‡πá‡∏á‡∏ú‡∏™‡∏°', color: '#F1C40F', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PW', code: 'PW', nameEn: 'Pine Wood', nameTh: '‡πÑ‡∏°‡πâ‡∏™‡∏ô', color: '#27AE60', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PWKD', code: 'PWKD', nameEn: 'Pine Wood Kiln Dried', nameTh: '‡πÑ‡∏°‡πâ‡∏™‡∏ô‡∏≠‡∏ö‡πÅ‡∏´‡πâ‡∏á', color: '#1E8449', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PWGRN', code: 'PWGRN', nameEn: 'Pine Wood Green', nameTh: '‡πÑ‡∏°‡πâ‡∏™‡∏ô‡∏™‡∏î', color: '#58D68D', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PLYWW', code: 'PLYWW', nameEn: 'Plywood White-White', nameTh: '‡πÑ‡∏°‡πâ‡∏≠‡∏±‡∏î‡∏Ç‡∏≤‡∏ß-‡∏Ç‡∏≤‡∏ß', color: '#5DADE2', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PLYRR', code: 'PLYRR', nameEn: 'Plywood Red-Red', nameTh: '‡πÑ‡∏°‡πâ‡∏≠‡∏±‡∏î‡πÅ‡∏î‡∏á-‡πÅ‡∏î‡∏á', color: '#2E86C1', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PLYRW', code: 'PLYRW', nameEn: 'Plywood Red-White', nameTh: '‡πÑ‡∏°‡πâ‡∏≠‡∏±‡∏î‡πÅ‡∏î‡∏á-‡∏Ç‡∏≤‡∏ß', color: '#1A5276', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  { id: 'PRTB', code: 'PRTB', nameEn: 'Particle Board', nameTh: '‡πÑ‡∏°‡πâ‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Å‡∏¥‡∏•', color: '#E9967A', costMethod: 'FIFO', isActive: true, type: 'raw_material' },
  // Other Categories
  { id: 'CONS', code: 'CONS', nameEn: 'Consumables', nameTh: '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á', color: '#708090', costMethod: 'AVG', isActive: true, type: 'consumables' },
  { id: 'FG', code: 'FG', nameEn: 'Finished Goods', nameTh: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ', color: '#2ECC40', costMethod: 'STD', isActive: true, type: 'finished_goods' },
  { id: 'OFFICE', code: 'OFFICE', nameEn: 'Office Supplies', nameTh: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', color: '#9B59B6', costMethod: 'AVG', isActive: true, type: 'office' },
  { id: 'MAINT', code: 'MAINT', nameEn: 'Maintenance Parts', nameTh: '‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á', color: '#E67E22', costMethod: 'AVG', isActive: true, type: 'maintenance' },
]

// ============================================
// MASTER DATA - INVENTORY (with CBM & costPerCbm)
// ============================================
const INITIAL_INVENTORY = [
  // STORE1 - MLH (LP prefix)
  { id: 1, lotNo: 'LP14899', category: 'MLH', code: 'IND-MLH/0.5/3/1', store: 'STORE1', qty: 700, cbm: 0.859, cost: 4218, costPerCbm: 4912, status: 'available', dateIn: '2024-07-03', vendor: 'Thai Timber Co., Ltd' },
  { id: 2, lotNo: 'LP14900', category: 'MLH', code: 'IND-MLH/0.5/3/1', store: 'STORE1', qty: 650, cbm: 0.797, cost: 3914, costPerCbm: 4912, status: 'available', dateIn: '2024-07-03', vendor: 'Thai Timber Co., Ltd' },
  { id: 3, lotNo: 'LP14901', category: 'MLH', code: 'IND-MLH/0.5/3/1', store: 'STORE1', qty: 45, cbm: 0.055, cost: 271, costPerCbm: 4912, status: 'low', dateIn: '2024-07-03', vendor: 'Thai Timber Co., Ltd' },
  { id: 4, lotNo: 'LP14902', category: 'MLH', code: 'IND-MLH/0.5/3.4/1.3', store: 'STORE1', qty: 241, cbm: 0.344, cost: 1689, costPerCbm: 4912, status: 'available', dateIn: '2024-05-25', vendor: 'Green Wood Enterprise' },
  { id: 5, lotNo: 'LP14903', category: 'MLH', code: 'IND-MLH/0.5/3.8/1.3', store: 'STORE1', qty: 254, cbm: 0.405, cost: 1990, costPerCbm: 4912, status: 'available', dateIn: '2024-04-30', vendor: 'Green Wood Enterprise' },
  // STORE1 - PW (Vendor initials prefix: TH=Thongsiri, ARC=ARC Wood, SE=SE Trading)
  { id: 6, lotNo: 'TH14904', category: 'PW', code: 'IND-PW/39/145/3960', store: 'STORE1', qty: 128, cbm: 2.87, cost: 8500, costPerCbm: 2962, status: 'low', dateIn: '2024-06-15', vendor: 'Thongsiri' },
  { id: 7, lotNo: 'TH14905', category: 'PW', code: 'IND-PW/39/145/3960', store: 'STORE1', qty: 350, cbm: 7.84, cost: 23200, costPerCbm: 2962, status: 'available', dateIn: '2024-06-20', vendor: 'Thongsiri' },
  { id: 8, lotNo: 'ARC14906', category: 'PW', code: 'IND-PW/40/100/4000', store: 'STORE1', qty: 200, cbm: 3.2, cost: 12800, costPerCbm: 4000, status: 'available', dateIn: '2024-07-10', vendor: 'ARC Wood Supply' },
  { id: 9, lotNo: 'SE14907', category: 'PW', code: 'IND-PW/38/95/3800', store: 'STORE1', qty: 180, cbm: 2.6, cost: 10400, costPerCbm: 4000, status: 'available', dateIn: '2024-07-12', vendor: 'SE Trading' },
  // STORE1 - More PW
  { id: 10, lotNo: 'TH14908', category: 'PW', code: 'IND-PW/38/140/3900', store: 'STORE1', qty: 450, cbm: 9.35, cost: 18700, costPerCbm: 2000, status: 'available', dateIn: '2024-07-08', vendor: 'Thongsiri' },
  { id: 11, lotNo: 'ARC14909', category: 'PW', code: 'IND-PW/40/150/4000', store: 'STORE1', qty: 320, cbm: 7.68, cost: 15360, costPerCbm: 2000, status: 'available', dateIn: '2024-07-15', vendor: 'ARC Wood Supply' },
  // STORE2 - PLYWW (category prefix)
  { id: 12, lotNo: 'PLYWW14910', category: 'PLYWW', code: 'IND2-PLYWW/12/1220/2440', store: 'STORE2', qty: 150, cbm: 5.34, cost: 45000, costPerCbm: 8427, status: 'available', dateIn: '2024-07-01', vendor: 'Malaysia Wood Import' },
  { id: 13, lotNo: 'PLYWW14911', category: 'PLYWW', code: 'IND2-PLYWW/18/1220/2440', store: 'STORE2', qty: 80, cbm: 4.27, cost: 42000, costPerCbm: 9836, status: 'available', dateIn: '2024-07-05', vendor: 'Malaysia Wood Import' },
  // STORE2 - PLYRR (category prefix)
  { id: 14, lotNo: 'PLYRR14912', category: 'PLYRR', code: 'IND2-PLYRR/15/1220/2440', store: 'STORE2', qty: 100, cbm: 4.46, cost: 52000, costPerCbm: 11659, status: 'available', dateIn: '2024-07-02', vendor: 'Malaysia Wood Import' },
  { id: 15, lotNo: 'PLYRR14913', category: 'PLYRR', code: 'IND2-PLYRR/12/1220/2440', store: 'STORE2', qty: 65, cbm: 2.31, cost: 27500, costPerCbm: 11905, status: 'low', dateIn: '2024-07-08', vendor: 'Malaysia Wood Import' },
  // STORE2 - PLYRW (category prefix)
  { id: 16, lotNo: 'PLYRW14914', category: 'PLYRW', code: 'IND2-PLYRW/12/1220/2440', store: 'STORE2', qty: 120, cbm: 4.27, cost: 38000, costPerCbm: 8900, status: 'available', dateIn: '2024-07-03', vendor: 'Malaysia Wood Import' },
  { id: 17, lotNo: 'PLYRW14915', category: 'PLYRW', code: 'IND2-PLYRW/15/1220/2440', store: 'STORE2', qty: 90, cbm: 4.01, cost: 36000, costPerCbm: 8978, status: 'available', dateIn: '2024-07-10', vendor: 'Malaysia Wood Import' },
  // STORE1 - PRTB (category prefix)
  { id: 18, lotNo: 'PRTB14916', category: 'PRTB', code: 'IND-PRTB/9/70/2440', store: 'STORE1', qty: 500, cbm: 0.77, cost: 3500, costPerCbm: 4545, status: 'available', dateIn: '2024-07-10', vendor: 'Thai Timber Co., Ltd' },
  { id: 19, lotNo: 'PRTB14917', category: 'PRTB', code: 'IND-PRTB/12/100/2440', store: 'STORE1', qty: 300, cbm: 0.88, cost: 4200, costPerCbm: 4773, status: 'available', dateIn: '2024-07-12', vendor: 'Thai Timber Co., Ltd' },
  // More recent receipts
  { id: 20, lotNo: 'LP14918', category: 'MLH', code: 'IND-MLH/0.5/4/1.5', store: 'STORE1', qty: 500, cbm: 1.23, cost: 6042, costPerCbm: 4912, status: 'available', dateIn: '2024-07-20', vendor: 'Thai Timber Co., Ltd' },
]

// ============================================
// VENDORS
// ============================================
const INITIAL_VENDORS = [
  { id: 'V001', code: 'V001', name: 'Thai Timber Co., Ltd', nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏ó‡∏¢‡∏ó‡∏¥‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î', initials: 'TT', type: 'local', category: 'MLH', paymentTerms: 30, contact: 'Somchai', phone: '081-234-5678', isActive: true },
  { id: 'V002', code: 'V002', name: 'Thongsiri', nameTh: '‡∏ó‡∏≠‡∏á‡∏®‡∏¥‡∏£‡∏¥', initials: 'TH', type: 'local', category: 'PW', paymentTerms: 30, contact: 'Wilai', phone: '089-876-5432', isActive: true },
  { id: 'V003', code: 'V003', name: 'ARC Wood Supply', nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏≤‡∏£‡πå‡∏Ñ ‡∏ß‡∏π‡πâ‡∏î ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢', initials: 'ARC', type: 'local', category: 'PW', paymentTerms: 30, contact: 'Prasert', phone: '086-333-4444', isActive: true },
  { id: 'V004', code: 'V004', name: 'SE Trading', nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡∏™‡∏≠‡∏µ ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á', initials: 'SE', type: 'local', category: 'PW', paymentTerms: 45, contact: 'Sakchai', phone: '087-555-6666', isActive: true },
  { id: 'V005', code: 'V005', name: 'Green Wood Enterprise', nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏£‡∏µ‡∏ô‡∏ß‡∏π‡∏î ‡πÄ‡∏≠‡πá‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏û‡∏£‡∏™‡πå', initials: 'GW', type: 'local', category: 'MLH', paymentTerms: 45, contact: 'Prasit', phone: '086-111-2222', isActive: true },
  { id: 'V006', code: 'V006', name: 'Malaysia Wood Import', nameTh: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πâ‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢', initials: 'MY', type: 'import', category: 'MLH', paymentTerms: 60, contact: 'Mr. Lee', phone: '+60-12-345-6789', isActive: true },
  { id: 'V007', code: 'V007', name: 'Vietnam Pine Export', nameTh: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏™‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°', initials: 'VN', type: 'import', category: 'PW', paymentTerms: 60, contact: 'Mr. Nguyen', phone: '+84-90-123-4567', isActive: true },
]

// ============================================
// 13 IMPORT COST TYPES (CRITICAL)
// ============================================
const IMPORT_COST_TYPES = [
  { id: 'fob', nameEn: 'FOB', nameTh: '‡∏Ñ‡πà‡∏≤ FOB' },
  { id: 'freight', nameEn: 'Freight', nameTh: '‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ß‡∏≤‡∏á' },
  { id: 'insurance', nameEn: 'Insurance', nameTh: '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô' },
  { id: 'customDuty', nameEn: 'Custom Duty', nameTh: '‡∏≠‡∏≤‡∏Å‡∏£‡∏®‡∏∏‡∏•‡∏Å‡∏≤‡∏Å‡∏£' },
  { id: 'thcDoStorage', nameEn: 'THC/DO/Storage', nameTh: '‡∏Ñ‡πà‡∏≤ THC/DO/Storage' },
  { id: 'forestOfficer', nameEn: 'Forest Officer', nameTh: '‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡πà‡∏≤‡πÑ‡∏°‡πâ' },
  { id: 'phytoOffice', nameEn: 'Phyto Office', nameTh: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏û‡∏∑‡∏ä' },
  { id: 'transport', nameEn: 'Transport', nameTh: '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á' },
  { id: 'surcharge', nameEn: 'Surcharge', nameTh: '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' },
  { id: 'advanceThc', nameEn: 'Advance THC', nameTh: '‡∏Ñ‡πà‡∏≤ THC ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤' },
  { id: 'bankCharges', nameEn: 'Bank Charges', nameTh: '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£' },
  { id: 'lcCommission', nameEn: 'LC/Commission', nameTh: '‡∏Ñ‡πà‡∏≤ LC/‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô' },
  { id: 'other', nameEn: 'Other', nameTh: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' },
]

// ============================================
// APPROVAL HIERARCHY (Spec 7)
// PM ‚â§‡∏ø10k | GM ‡∏ø10k-50k | CEO >‡∏ø50k
// ============================================
const APPROVAL_THRESHOLDS = {
  pm: { min: 0, max: 10000, role: 'production_manager', title: 'Production Manager', titleTh: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï' },
  gm: { min: 10001, max: 50000, role: 'general_manager', title: 'General Manager', titleTh: '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' },
  ceo: { min: 50001, max: Infinity, role: 'ceo', title: 'CEO', titleTh: '‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' },
}

const getRequiredApprover = (amount) => {
  if (amount <= APPROVAL_THRESHOLDS.pm.max) return APPROVAL_THRESHOLDS.pm
  if (amount <= APPROVAL_THRESHOLDS.gm.max) return APPROVAL_THRESHOLDS.gm
  return APPROVAL_THRESHOLDS.ceo
}

const canUserApprove = (userRole, requiredLevel) => {
  const roleHierarchy = ['staff', 'supervisor', 'production_manager', 'general_manager', 'ceo', 'admin']
  const userLevel = roleHierarchy.indexOf(userRole)
  const requiredIdx = roleHierarchy.indexOf(requiredLevel)
  return userLevel >= requiredIdx
}

// ============================================
// REJECTION REASONS (for GRN - Spec 3-4)
// ============================================
const REJECTION_REASONS = [
  { id: 'damaged', labelEn: 'Damaged goods', labelTh: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢' },
  { id: 'wrong_spec', labelEn: 'Wrong specification', labelTh: '‡∏™‡πÄ‡∏õ‡∏Ñ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á' },
  { id: 'wrong_qty', labelEn: 'Wrong quantity', labelTh: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á' },
  { id: 'quality_issue', labelEn: 'Quality issue', labelTh: '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô' },
  { id: 'not_ordered', labelEn: 'Not ordered', labelTh: '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏±‡πà‡∏á' },
  { id: 'late_delivery', labelEn: 'Too late / Rejected', labelTh: '‡∏™‡πà‡∏á‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ' },
  { id: 'other', labelEn: 'Other', labelTh: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' },
]

// ============================================
// VARIANCE TYPES (for GRN)
// ============================================
const VARIANCE_TYPES = [
  { id: 'qty_short', labelEn: 'Quantity Short', labelTh: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏î' },
  { id: 'qty_over', labelEn: 'Quantity Over', labelTh: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô' },
  { id: 'size_different', labelEn: 'Size Different', labelTh: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πà‡∏≤‡∏á' },
  { id: 'mixed_sizes', labelEn: 'Mixed Sizes', labelTh: '‡∏Ç‡∏ô‡∏≤‡∏î‡∏ú‡∏™‡∏°' },
  { id: 'damaged_partial', labelEn: 'Some Damaged', labelTh: '‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢' },
]

// ============================================
// IMPORT TRACKING STATUS (Spec 11 - G Thru)
// ============================================
const IMPORT_STATUS = [
  { id: 'pending', label: 'Pending Shipment', labelTh: '‡∏£‡∏≠‡∏™‡πà‡∏á', color: 'bg-gray-500' },
  { id: 'shipped', label: 'Shipped', labelTh: '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-blue-500' },
  { id: 'in_transit', label: 'In Transit', labelTh: '‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏ô‡∏™‡πà‡∏á', color: 'bg-yellow-500' },
  { id: 'at_port', label: 'At Port', labelTh: '‡∏ñ‡∏∂‡∏á‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠', color: 'bg-orange-500' },
  { id: 'customs', label: 'Customs Clearance', labelTh: '‡∏ú‡πà‡∏≤‡∏ô‡∏®‡∏∏‡∏•‡∏Å‡∏≤‡∏Å‡∏£', color: 'bg-purple-500' },
  { id: 'released', label: 'Released', labelTh: '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-green-500' },
  { id: 'delivered', label: 'Delivered', labelTh: '‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß', color: 'bg-emerald-500' },
]

// ============================================
// CUSTOMS STATUS
// ============================================
const CUSTOMS_STATUS = [
  { id: 'not_started', label: 'Not Started', labelTh: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°' },
  { id: 'docs_submitted', label: 'Documents Submitted', labelTh: '‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'inspection', label: 'Under Inspection', labelTh: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à' },
  { id: 'duty_paid', label: 'Duty Paid', labelTh: '‡∏à‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏µ‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'cleared', label: 'Cleared', labelTh: '‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' },
]

// ============================================
// LC STATUS (Spec 12 - Letter of Credit)
// ============================================
const LC_STATUS = [
  { id: 'not_required', label: 'Not Required', labelTh: '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ' },
  { id: 'pending', label: 'Pending Opening', labelTh: '‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î' },
  { id: 'opened', label: 'LC Opened', labelTh: '‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'amended', label: 'Amended', labelTh: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'docs_submitted', label: 'Documents Submitted', labelTh: '‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'negotiated', label: 'Negotiated', labelTh: '‡πÄ‡∏à‡∏£‡∏à‡∏≤‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'paid', label: 'Paid', labelTh: '‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' },
  { id: 'closed', label: 'Closed', labelTh: '‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß' },
]

// ============================================
// CREDIT NOTE REASONS
// ============================================
const CREDIT_NOTE_REASONS = [
  { id: 'qty_short', label: 'Quantity Short', labelTh: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏≤‡∏î' },
  { id: 'damaged', label: 'Damaged Goods', labelTh: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢' },
  { id: 'wrong_spec', label: 'Wrong Specification', labelTh: '‡∏™‡πÄ‡∏õ‡∏Ñ‡∏ú‡∏¥‡∏î' },
  { id: 'price_error', label: 'Price Error', labelTh: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏¥‡∏î' },
  { id: 'returned', label: 'Goods Returned', labelTh: '‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
  { id: 'other', label: 'Other', labelTh: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' },
]


// ============================================
// PURCHASE ORDERS (with Import Costing)
// ============================================
const INITIAL_PURCHASE_ORDERS = [
  {
    id: 'PO-2407-001',
    vendorId: 'V001',
    type: 'local',
    poDate: '2024-07-01',
    vendorInvoice: 'INV-TT-2407-001',
    vendorInvoiceDate: '2024-07-01',
    deliveryDate: '2024-07-03',
    items: [
      { id: 1, categoryId: 'MLH', thickness: 50, width: 100, length: 2400, qty: 1395, unit: 'pcs', cbm: 1.711, unitPrice: 4912, total: 8403 },
    ],
    subtotal: 8403,
    vat: 588,
    total: 8991,
    importCosts: {},
    totalImportCosts: 0,
    status: 'received',
    receivedDate: '2024-07-03',
    receivedBy: 'Warehouse Staff',
    entity: 'IND',
  },
  {
    id: 'PO-2407-002',
    vendorId: 'V004',
    type: 'import',
    poDate: '2024-06-15',
    vendorInvoice: 'MYS-2024-0456',
    vendorInvoiceDate: '2024-06-15',
    deliveryDate: '2024-07-10',
    container: 'MSCU7654321',
    blNumber: 'MSKU123456789',
    items: [
      { id: 1, categoryId: 'MLH', thickness: 50, width: 100, length: 2400, qty: 5000, unit: 'pcs', cbm: 6.0, unitPrice: 3500, total: 21000 },
    ],
    subtotal: 21000,
    vat: 0,
    total: 21000,
    importCosts: {
      fob: 21000,
      freight: 35000,
      insurance: 2100,
      customDuty: 8500,
      thcDoStorage: 15000,
      forestOfficer: 3500,
      phytoOffice: 2500,
      transport: 5000,
      surcharge: 1500,
      advanceThc: 0,
      bankCharges: 1242,
      lcCommission: 0,
      other: 1000,
    },
    totalImportCosts: 96342,
    status: 'received',
    receivedDate: '2024-07-10',
    receivedBy: 'Warehouse Staff',
    entity: 'IND',
  },
  {
    id: 'PO-2407-003',
    vendorId: 'V002',
    type: 'local',
    poDate: '2024-07-05',
    vendorInvoice: 'PSC-2024-789',
    vendorInvoiceDate: '2024-07-05',
    deliveryDate: '2024-07-08',
    items: [
      { id: 1, categoryId: 'PW', thickness: 39, width: 145, length: 3960, qty: 478, unit: 'pcs', cbm: 10.71, unitPrice: 2962, total: 31703 },
    ],
    subtotal: 31703,
    vat: 2219,
    total: 33922,
    importCosts: {},
    totalImportCosts: 0,
    status: 'pending',
    entity: 'IND',
  },
]

// ============================================
// CUSTOMERS
// ============================================
const INITIAL_CUSTOMERS = [
  { id: 'C001', code: 'RYL-016', name: 'Royal Ceramics', nameTh: '‡∏£‡∏≠‡∏¢‡∏±‡∏• ‡πÄ‡∏ã‡∏£‡∏≤‡∏°‡∏¥‡∏Ñ', contact: 'Khun Preeda', phone: '038-123-456', email: 'purchasing@royalceramics.co.th', paymentTerms: 30, 
    deliveryLocations: [
      { id: 'RYL-L1', name: 'Main Plant', address: 'Rayong Industrial Estate', tripCost: 60, isDefault: true }
    ],
    orderType: 'PO', type: 'local', specialRequirements: null, isActive: true },
  { id: 'C002', code: 'SHN-004', name: 'Shin Steel Industries', nameTh: '‡∏ä‡∏¥‡∏ô‡∏™‡∏ï‡∏µ‡∏• ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå', contact: 'Khun Somsak', phone: '038-234-567', email: 'po@shinsteel.com', paymentTerms: 45, 
    deliveryLocations: [
      { id: 'SHN-L1', name: 'Factory 1', address: 'Chonburi Main', tripCost: 60, isDefault: true },
      { id: 'SHN-L2', name: 'Factory 2', address: 'Chonburi Branch', tripCost: 70, isDefault: false }
    ],
    orderType: 'PO', type: 'local', specialRequirements: null, isActive: true },
  { id: 'C003', code: 'BVI-031', name: 'BV Industries', nameTh: '‡∏ö‡∏µ‡∏ß‡∏µ ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå', contact: 'Khun Napat', phone: '02-345-6789', email: 'procurement@bvindustries.com', paymentTerms: 60, 
    deliveryLocations: [
      { id: 'BVI-L1', name: 'Bangkok Warehouse', address: 'Bangkok', tripCost: 80, isDefault: true }
    ],
    orderType: 'Direct', type: 'local', specialRequirements: null, isActive: true },
  { id: 'C004', code: 'PLX-002', name: 'Polyplex Thailand', nameTh: '‡πÇ‡∏û‡∏•‡∏µ‡πÄ‡∏û‡∏•‡πá‡∏Å‡∏ã‡πå ‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏ô‡∏î‡πå', contact: 'Khun Varunthanat', phone: '+66 38 627074', email: 'vthongkhumsan@polyplex.com', paymentTerms: 30, 
    deliveryLocations: [
      { id: 'PLX-L1', name: 'PLOT 1', address: 'Siam Eastern Industrial Park, Rayong - Plot 1', tripCost: 50, isDefault: true },
      { id: 'PLX-L2', name: 'PLOT 2', address: 'Siam Eastern Industrial Park, Rayong - Plot 2', tripCost: 50, isDefault: false },
      { id: 'PLX-L3', name: 'PLOT 3', address: 'Siam Eastern Industrial Park, Rayong - Plot 3', tripCost: 55, isDefault: false }
    ],
    orderType: 'PO', type: 'local', specialRequirements: { labelFormat: 'polyplex_4column', colorCoding: { FILM: 'white', CPP: 'peach', Line10: 'red' } }, isActive: true },
  { id: 'C005', code: 'ALL-013', name: 'Alliance Laundry', nameTh: '‡∏≠‡∏±‡∏•‡πÑ‡∏•‡πÅ‡∏≠‡∏ô‡∏ã‡πå ‡∏•‡∏≠‡∏ô‡∏î‡∏£‡∏µ‡πâ', contact: 'Khun Somchai', phone: '038-456-789', email: 'purchasing@alliance.com', paymentTerms: 30, 
    deliveryLocations: [
      { id: 'ALL-L1', name: 'Main Factory', address: 'Amata City, Chonburi', tripCost: 50, isDefault: true }
    ],
    orderType: 'PR', type: 'local', specialRequirements: { qrLabels: true, htCertificate: true }, isActive: true },
  { id: 'C006', code: 'FRKW-001', name: 'Furukawa Electric', nameTh: '‡∏ü‡∏π‡∏£‡∏π‡∏Ñ‡∏≤‡∏ß‡∏≤ ‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Ñ‡∏ó‡∏£‡∏¥‡∏Ñ', contact: 'Khun Tanaka', phone: '038-567-890', email: 'procurement@furukawa.co.th', paymentTerms: 45, 
    deliveryLocations: [
      { id: 'FRK-L1', name: 'Plant A', address: 'Eastern Seaboard Industrial Estate - A', tripCost: 60, isDefault: true },
      { id: 'FRK-L2', name: 'Plant B', address: 'Eastern Seaboard Industrial Estate - B', tripCost: 65, isDefault: false }
    ],
    orderType: 'PO', type: 'export', specialRequirements: { htCertificate: true }, isActive: true },
  { id: 'C007', code: 'JYP-011', name: 'JY Packing', nameTh: '‡πÄ‡∏à‡∏ß‡∏≤‡∏¢ ‡πÅ‡∏û‡∏Ñ‡∏Å‡∏¥‡πâ‡∏á', contact: 'Khun Jiraporn', phone: '038-678-901', email: 'po@jypacking.com', paymentTerms: 30, 
    deliveryLocations: [
      { id: 'JYP-L1', name: 'Self Pick-up', address: 'Customer collects from IND', tripCost: 0, isDefault: true }
    ],
    orderType: 'Direct', type: 'local', specialRequirements: { selfPickup: true }, isActive: true },
  { id: 'C008', code: 'OKMT-020', name: 'Okamoto Industries', nameTh: '‡πÇ‡∏≠‡∏Ñ‡∏≤‡πÇ‡∏°‡πÇ‡∏ï‡∏∞ ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå', contact: 'Khun Yamamoto', phone: '038-789-012', email: 'purchasing@okamoto.co.th', paymentTerms: 60, 
    deliveryLocations: [
      { id: 'OKM-L1', name: 'Main Plant', address: 'Amata Nakorn, Chonburi', tripCost: 120, isDefault: true }
    ],
    orderType: 'PO', type: 'export', specialRequirements: null, isActive: true },
]

// ============================================
// STORE TYPES
// ============================================
const STORE_TYPES = [
  { id: 'raw_material', nameEn: 'Raw Material', nameTh: '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö' },
  { id: 'branch_stock', nameEn: 'Branch Stock', nameTh: '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤' },
  { id: 'consumables', nameEn: 'Consumables', nameTh: '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á' },
  { id: 'office', nameEn: 'Office Supplies', nameTh: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô' },
  { id: 'maintenance', nameEn: 'Maintenance', nameTh: '‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ã‡πà‡∏≠‡∏°' },
  { id: 'finished_goods', nameEn: 'Finished Goods', nameTh: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' },
]

// ============================================
// PRODUCTION DEPARTMENTS (10 Departments)
// ============================================
// ============================================
// DEPARTMENTS - From Production Mapping Excel (operators shown)
// Row 2: Singh, One (P1, P2), Khem (P3), Khwai (A1), Pngsak (A2), P Toon (W), Mas (Oven), Pongsak (FG/Transport)
// ============================================
const INITIAL_DEPARTMENTS = [
  { id: 'C1', code: 'C1', nameEn: 'Cutting 1 (Singh)', nameTh: '‡∏ï‡∏±‡∏î 1 (‡∏™‡∏¥‡∏á‡∏´‡πå)', operator: 'Singh', hourlyRate: 200, type: 'cutting', sequence: 1, isActive: true },
  { id: 'C2', code: 'C2', nameEn: 'Cutting 2', nameTh: '‡∏ï‡∏±‡∏î 2', operator: '', hourlyRate: 200, type: 'cutting', sequence: 2, isActive: true },
  { id: 'P1', code: 'P1', nameEn: 'Processing 1 (Singh)', nameTh: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ 1 (‡∏™‡∏¥‡∏á‡∏´‡πå)', operator: 'Singh', hourlyRate: 180, type: 'processing', sequence: 3, isActive: true },
  { id: 'P2', code: 'P2', nameEn: 'Processing 2 (One)', nameTh: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ 2 (‡∏ß‡∏±‡∏ô)', operator: 'One', hourlyRate: 180, type: 'processing', sequence: 4, isActive: true },
  { id: 'P3', code: 'P3', nameEn: 'Processing 3 (Khem)', nameTh: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ 3 (‡πÄ‡∏Ç‡πá‡∏°)', operator: 'Khem', hourlyRate: 180, type: 'processing', sequence: 5, isActive: true },
  { id: 'A1', code: 'A1', nameEn: 'Assembly 1 (Khwai)', nameTh: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö 1 (‡∏Ñ‡∏ß‡∏≤‡∏¢)', operator: 'Khwai', hourlyRate: 180, type: 'assembly', sequence: 6, isActive: true },
  { id: 'A2', code: 'A2', nameEn: 'Assembly 2 (Pngsak)', nameTh: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö 2 (‡∏õ‡∏±‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå)', operator: 'Pngsak', hourlyRate: 180, type: 'assembly', sequence: 7, isActive: true },
  { id: 'W', code: 'W', nameEn: 'Standby (P Toon)', nameTh: '‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡∏û‡∏µ‡πà‡∏ï‡∏π‡∏ô)', operator: 'P Toon', hourlyRate: 150, type: 'standby', sequence: 8, isActive: true },
  { id: 'OVEN', code: 'OVEN', nameEn: 'Oven / Heat Treatment (Mas)', nameTh: '‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô (‡∏°‡∏≤‡∏™)', operator: 'Mas', hourlyRate: 150, type: 'treatment', sequence: 9, isActive: true },
  { id: 'QC', code: 'QC', nameEn: 'Quality Control (P Toon)', nameTh: '‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û (‡∏û‡∏µ‡πà‡∏ï‡∏π‡∏ô)', operator: 'P Toon', hourlyRate: 200, type: 'qa', sequence: 10, isActive: true },
  { id: 'QA', code: 'QA', nameEn: 'Quality Assurance', nameTh: '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', operator: '', hourlyRate: 200, type: 'qa', sequence: 11, isActive: true },
  { id: 'FG', code: 'FG', nameEn: 'Finished Goods (Pongsak)', nameTh: '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ (‡∏õ‡∏≠‡∏á‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå)', operator: 'Pongsak', hourlyRate: 150, type: 'fg', sequence: 12, isActive: true },
  { id: 'TRANS', code: 'TRANS', nameEn: 'Transport', nameTh: '‡∏Ç‡∏ô‡∏™‡πà‡∏á', operator: 'Drivers', hourlyRate: 200, type: 'transport', sequence: 13, isActive: true },
]

// ============================================
// PRODUCTION SCENARIOS (PLN) - From Production Mapping
// Format: PLN X.Y.Z where X=processing station, Y=assembly, Z=oven
// ============================================
const PRODUCTION_SCENARIOS = [
  // PLN 0: Direct
  { id: 'PLN_0', code: 'PLN 0', name: 'FG+T', description: 'Direct from FG', path: ['FG', 'TRANS'], requiresHT: false, remarks: '' },
  // PLN 1.x: Processing 1 (Singh/P1)
  { id: 'PLN_1', code: 'PLN 1', name: 'P1+FG+T', description: 'Processing 1 only', path: ['P1', 'QA', 'FG', 'TRANS'], requiresHT: false, remarks: 'PW Cutting 2' },
  { id: 'PLN_1_0_1', code: 'PLN 1.0.1', name: 'P1+O+FG+T', description: 'P1 + Oven', path: ['P1', 'QA', 'OVEN', 'QC', 'FG', 'TRANS'], requiresHT: true, remarks: 'MLH Cutting 1' },
  { id: 'PLN_1_1_1', code: 'PLN 1.1.1', name: 'P1+A1+QC+FG+T', description: 'P1 + Assembly 1 (no oven)', path: ['P1', 'QA', 'A1', 'QA', 'QC', 'FG', 'TRANS'], requiresHT: false, remarks: 'KD - no oven' },
  { id: 'PLN_1_1_2', code: 'PLN 1.1.2', name: 'P1+A1+O+QC+FG+T', description: 'P1 + A1 + Oven', path: ['P1', 'QA', 'A1', 'QA', 'OVEN', 'QC', 'FG', 'TRANS'], requiresHT: true, remarks: 'PLY Cutting 2 - No Oven' },
  { id: 'PLN_1_2_1', code: 'PLN 1.2.1', name: 'P1+A2+QC+FG+T', description: 'P1 + Assembly 2 (no oven)', path: ['P1', 'QA', 'A2', 'QA', 'QC', 'FG', 'TRANS'], requiresHT: false, remarks: 'PRTB Cutting 2 - No Oven' },
  { id: 'PLN_1_2_2', code: 'PLN 1.2.2', name: 'P1+A2+O+QC+FG+T', description: 'P1 + A2 + Oven', path: ['P1', 'QA', 'A2', 'QA', 'OVEN', 'QC', 'FG', 'TRANS'], requiresHT: true, remarks: 'BOX No Oven' },
  // PLN 2.x: Processing 2 (One/P2)
  { id: 'PLN_2', code: 'PLN 2', name: 'P2+FG+T', description: 'Processing 2 only', path: ['P2', 'QA', 'FG', 'TRANS'], requiresHT: false, remarks: 'Alliance-Thung' },
  { id: 'PLN_2_0_1', code: 'PLN 2.0.1', name: 'P2+O+FG+T', description: 'P2 + Oven', path: ['P2', 'QA', 'OVEN', 'QC', 'FG', 'TRANS'], requiresHT: true, remarks: 'Box Thung' },
  { id: 'PLN_2_1_1', code: 'PLN 2.1.1', name: 'P2+A1+QC+FG+T', description: 'P2 + Assembly 1', path: ['P2', 'QA', 'A1', 'QA', 'QC', 'FG', 'TRANS'], requiresHT: false, remarks: 'PW Above 6m No Oven' },
  { id: 'PLN_2_1_2', code: 'PLN 2.1.2', name: 'P2+A1+O+QC+FG+T', description: 'P2 + A1 + Oven', path: ['P2', 'QA', 'A1', 'QA', 'OVEN', 'QC', 'FG', 'TRANS'], requiresHT: true, remarks: '' },
  { id: 'PLN_2_2_1', code: 'PLN 2.2.1', name: 'P2+A2+QC+FG+T', description: 'P2 + Assembly 2', path: ['P2', 'QA', 'A2', 'QA', 'QC', 'FG', 'TRANS'], requiresHT: false, remarks: '' },
  { id: 'PLN_2_2_2', code: 'PLN 2.2.2', name: 'P2+A2+O+QC+FG+T', description: 'P2 + A2 + Oven', path: ['P2', 'QA', 'A2', 'QA', 'OVEN', 'QC', 'FG', 'TRANS'], requiresHT: true, remarks: '' },
]

// ============================================
// MATERIAL TYPE PRODUCTION PATHS - From Production Mapping rows 21-26
// ============================================
const MATERIAL_PRODUCTION_PATHS = {
  'PRTB': { name: 'PRTB', path: ['C2', 'QC', 'TRANS'], description: 'Cutting 2 + QC + Transport' },
  'Pallets': { name: 'Pallets', path: ['C1', 'C2', 'A1', 'A2', 'OVEN', 'QC', 'TRANS'], description: 'Cutting1/Cutting2 + Assembly1/Assembly2 + Oven + QC + Transport' },
  'Pallets_P3': { name: 'Pallets (with P3)', path: ['C1', 'C2', 'P3', 'A1', 'A2', 'OVEN', 'QC', 'TRANS'], description: 'Cutting1/Cutting2 + Cutting3 + Assembly1/Assembly2 + Oven + QC + Transport' },
  'Box': { name: 'Box', path: ['C1', 'C2', 'A1', 'A2', 'QC', 'TRANS'], description: 'Cutting1/Cutting2 + Assembly1/Assembly2 + QC + Transport' },
  'HT_Standard': { name: 'HT Standard', path: ['C1', 'C2', 'OVEN', 'QC', 'TRANS'], description: 'Cutting 1/Cutting 2 + Oven + QC + Transport' },
}

// ============================================
// STORE MODULE ACCESS - Which stores each module can see
// CRITICAL: Links stores to specific modules
// ============================================
const STORE_MODULE_ACCESS = {
  sales: ['STORE1', 'STORE2', 'STORE6'], // RM Wood, IND2, FG - for checking material availability and FG dispatch
  production: ['STORE1', 'STORE2', 'STORE3', 'STORE6'], // RM Wood, IND2, Consumables, FG - for issuing materials and receiving FG
  maintenance: ['STORE5'], // Maintenance store only - spare parts, tools, diesel
  inventory: ['STORE1', 'STORE2', 'STORE3', 'STORE4', 'STORE5', 'STORE6'], // All stores visible
}

// ============================================
// TRUCKS / VEHICLES - 4 trucks from spec (Mayo, W, T, C)
// ============================================
const INITIAL_TRUCKS = [
  { id: 'T1', code: 'T1', nameEn: 'Truck 1 - Mayo', nameTh: '‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å 1 - ‡∏°‡∏∞‡πÇ‡∏¢', capacity: '6 tons', licensePlate: '‡∏ä‡∏ö-1234', driver: 'Mayo', driverId: 7, fuelType: 'diesel', status: 'available', isActive: true },
  { id: 'T2', code: 'T2', nameEn: 'Truck 2 - W', nameTh: '‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å 2 - ‡∏î‡∏±‡∏ö‡∏ö‡∏•‡∏¥‡∏ß', capacity: '10 tons', licensePlate: '‡∏ä‡∏ö-5678', driver: 'W', driverId: null, fuelType: 'diesel', status: 'available', isActive: true },
  { id: 'T3', code: 'T3', nameEn: 'Truck 3 - T', nameTh: '‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å 3 - ‡∏ó‡∏µ', capacity: '10 tons', licensePlate: '‡∏ä‡∏ö-9012', driver: 'T', driverId: null, fuelType: 'diesel', status: 'available', isActive: true },
  { id: 'T4', code: 'T4', nameEn: 'Truck 4 - C', nameTh: '‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å 4 - ‡∏ã‡∏µ', capacity: '6 tons', licensePlate: '‡∏ä‡∏ö-3456', driver: 'C', driverId: null, fuelType: 'diesel', status: 'available', isActive: true },
]

// ============================================
// COMPANY ENTITIES (IND vs IND2)
// ============================================
const COMPANY_ENTITIES = [
  { 
    id: 'IND', 
    name: 'IND THAI PACKWELL INDUSTRIES CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏¥‡∏ô‡∏î‡πå ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ï‡∏£‡∏µ‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 Moo 8, Bo Thong, Chonburi 20270',
    addressTh: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    taxId: '0-2055-56010-51-8',
    tel: '094-7866886, 081-8358435',
    invoicePrefix: 'INV',
    materials: ['MLH', 'PW', 'PWKD', 'PWGRN'],
  },
  { 
    id: 'IND2', 
    name: 'IND THAI PACKWELL INDUSTRIES (2) CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏¥‡∏ô‡∏î‡πå ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ï‡∏£‡∏µ‡∏™‡πå (2) ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 Moo 8, Bo Thong, Chonburi 20270',
    addressTh: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    taxId: '0-2055-56010-52-6',
    tel: '094-7866886, 081-8358435',
    invoicePrefix: 'IND2',
    materials: ['PLYRW', 'PLYRR', 'PLYWW', 'PRTB'],
  },
]

// ============================================
// PAYMENT TERMS
// ============================================
const PAYMENT_TERMS = [
  { id: 'cash', label: 'Cash / ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', days: 0 },
  { id: 'net7', label: 'Net 7 Days', days: 7 },
  { id: 'net15', label: 'Net 15 Days', days: 15 },
  { id: 'net30', label: 'Net 30 Days', days: 30 },
  { id: 'net45', label: 'Net 45 Days', days: 45 },
  { id: 'net60', label: 'Net 60 Days', days: 60 },
]

// ============================================
// DEPARTMENT TYPES (for Production)
// ============================================
const DEPARTMENT_TYPES = [
  { id: 'cutting', nameEn: 'Cutting', nameTh: '‡∏ï‡∏±‡∏î', color: '#E74C3C' },
  { id: 'processing', nameEn: 'Processing', nameTh: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ', color: '#F39C12' },
  { id: 'assembly', nameEn: 'Assembly', nameTh: '‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö', color: '#3498DB' },
  { id: 'treatment', nameEn: 'Treatment', nameTh: '‡∏≠‡∏ö', color: '#9B59B6' },
  { id: 'qa', nameEn: 'Quality', nameTh: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', color: '#1ABC9C' },
  { id: 'fg', nameEn: 'Finished', nameTh: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', color: '#2ECC71' },
]

// ============================================
// PRODUCTS
// ============================================
const INITIAL_PRODUCTS = [
  { id: 'PROD001', code: 'PROD001', name: 'Pallet 1100x1100', materialType: 'MLH', unitPrice: 350, unit: 'pcs' },
  { id: 'PROD002', code: 'PROD002', name: 'Pallet 1100x950x950', materialType: 'MLH', unitPrice: 303, unit: 'pcs' },
  { id: 'PROD003', code: 'PROD003', name: 'Box 600x400x300', materialType: 'MLH', unitPrice: 280, unit: 'pcs' },
  { id: 'PROD004', code: 'PROD004', name: 'Upper 9x70x2440', materialType: 'PRTB', unitPrice: 12, unit: 'pcs' },
]

// ============================================
// WORK ORDERS (with Cost Tracking)
// ============================================
const INITIAL_WORK_ORDERS = [
  {
    id: 'WO-2407-001',
    soId: 'SO-2407-001',
    customerId: 'C001',
    productId: 'PROD002',
    productName: 'Pallet 1100x950x950',
    quantity: 500,
    completedQty: 350,
    materialType: 'MLH',
    department: 'C1',
    status: 'in_progress',
    priority: 'high',
    startDate: '2024-07-15',
    targetDate: '2024-07-25',
    operations: [
      { dept: 'C1', status: 'completed', startTime: '2024-07-15 08:00', endTime: '2024-07-16 17:00', hours: 16, operator: 'Somchai' },
      { dept: 'P1', status: 'completed', startTime: '2024-07-17 08:00', endTime: '2024-07-18 12:00', hours: 12, operator: 'Prasit' },
      { dept: 'A1', status: 'in_progress', startTime: '2024-07-19 08:00', endTime: null, hours: 8, operator: 'Manop' },
    ],
    materialsIssued: [
      { lotNo: 'LP14899', category: 'MLH', code: 'IND-MLH/0.5/3/1', qty: 400, cbm: 0.49, cost: 2407 },
      { lotNo: 'LP14900', category: 'MLH', code: 'IND-MLH/0.5/3/1', qty: 350, cbm: 0.43, cost: 2112 },
    ],
    costs: {
      material: 4519,
      labor: 7200,
      overhead: 1500,
      total: 13219,
      perUnit: 37.77,
    },
    totalRevenue: 151500,
    profit: {
      amount: 138281,
      margin: 91.26,
    },
    entity: 'IND',
  },
  {
    id: 'WO-2407-002',
    soId: 'SO-2407-002',
    customerId: 'C002',
    productId: 'PROD004',
    productName: 'Upper 9x70x2440',
    quantity: 4000,
    completedQty: 0,
    materialType: 'PRTB',
    department: 'P2',
    status: 'pending',
    priority: 'medium',
    startDate: null,
    targetDate: '2024-08-05',
    operations: [],
    materialsIssued: [],
    costs: {
      material: 0,
      labor: 0,
      overhead: 0,
      total: 0,
      perUnit: 0,
    },
    totalRevenue: 48000,
    profit: {
      amount: 0,
      margin: 0,
    },
    entity: 'IND',
  },
]

// ============================================
// SALES ORDERS
// ============================================
const INITIAL_SALES_ORDERS = [
  {
    id: 'SO-2407-001',
    customerId: 'C001',
    customerPO: 'PO.RPR6802-003',
    orderDate: '2024-07-10',
    dueDate: '2024-07-25',
    deliveryDate: '2024-07-25',
    status: 'in_production',
    items: [
      { id: 1, productId: 'PROD002', productName: 'Pallet 1100x950x950', materialType: 'MLH', qty: 500, qtyDelivered: 200, unit: 'pcs', unitPrice: 303, total: 151500, woId: 'WO-2407-001' },
    ],
    subtotal: 151500,
    vatRate: 7,
    vat: 10605,
    grandTotal: 162105,
    entity: 'IND',
    paymentTerms: 'net30',
    deliveryAddress: 'Rayong Factory',
    notes: 'Urgent order - priority delivery',
  },
  {
    id: 'SO-2407-002',
    customerId: 'C002',
    customerPO: 'PO20250168',
    orderDate: '2024-07-12',
    dueDate: '2024-08-05',
    deliveryDate: '2024-08-05',
    status: 'confirmed',
    items: [
      { id: 1, productId: 'PROD004', productName: 'Upper 9x70x2440', materialType: 'PRTB', qty: 4000, qtyDelivered: 0, unit: 'pcs', unitPrice: 12, total: 48000, woId: 'WO-2407-002' },
    ],
    subtotal: 48000,
    vatRate: 7,
    vat: 3360,
    grandTotal: 51360,
    entity: 'IND',
    paymentTerms: 'net45',
    deliveryAddress: 'Chonburi Plant',
    notes: '',
  },
]

// ============================================
// INVOICES
// ============================================
const INITIAL_INVOICES = [
  {
    id: 'INV-2407-001',
    entity: 'IND',
    soId: 'SO-2407-001',
    customerId: 'C001',
    customerPO: 'PO.RPR6802-003',
    invoiceDate: '2024-07-20',
    dueDate: '2024-08-19',
    items: [
      { id: 1, description: 'Pallet 1100x950x950', descriptionTh: '‡∏û‡∏≤‡πÄ‡∏•‡∏ó 1100x950x950', qty: 200, unit: 'pcs', unitPrice: 303, total: 60600, soItemId: 1 },
    ],
    subtotal: 60600,
    vatRate: 7,
    vat: 4242,
    discount: 0,
    grandTotal: 64842,
    status: 'sent',
    paidAmount: 30000,
    balance: 34842,
    payments: [
      { id: 1, date: '2024-07-25', amount: 30000, method: 'transfer', reference: 'TRF-2407-001', notes: 'Partial payment' },
    ],
    createdAt: '2024-07-20',
  },
]

// ============================================
// QUOTATIONS
// ============================================
const INITIAL_QUOTATIONS = [
  {
    id: 'QT-2601-001',
    customerId: 'C001',
    customerContact: 'Khun Preeda',
    customerCategory: 'existing', // new, potential, existing
    quotationReason: 'new_product', // new_product, price_change, new_customer, special_request
    quoteDate: '2026-01-15',
    validUntil: '2026-02-15',
    status: 'accepted', // draft, sent, accepted, rejected, expired, converted
    items: [
      { id: 1, productId: 'PROD002', productName: 'Pallet 1100x950x950', description: 'Standard export pallet', qty: 500, unit: 'pcs', unitPrice: 303, total: 151500 },
    ],
    subtotal: 151500,
    vatRate: 7,
    vat: 10605,
    discount: 0,
    discountReason: '',
    grandTotal: 162105,
    paymentTerms: 'net30',
    deliveryTerms: 'Delivered to customer site',
    notes: 'Urgent requirement for Q1 shipments',
    preparedBy: 'Darunda',
    approvedBy: '',
    entity: 'IND',
    convertedToSO: 'SO-2407-001',
    createdAt: '2026-01-15',
  },
  {
    id: 'QT-2601-002',
    customerId: 'C003',
    customerContact: 'Khun Napat',
    customerCategory: 'new', // new customer inquiry
    quotationReason: 'new_customer',
    quoteDate: '2026-01-20',
    validUntil: '2026-02-20',
    status: 'sent',
    items: [
      { id: 1, productId: 'PROD001', productName: 'Pallet 1100x1100', description: 'Heavy duty pallet', qty: 200, unit: 'pcs', unitPrice: 350, total: 70000 },
      { id: 2, productId: 'PROD003', productName: 'Box 600x400x300', description: 'Storage box', qty: 100, unit: 'pcs', unitPrice: 280, total: 28000 },
    ],
    subtotal: 98000,
    vatRate: 7,
    vat: 6860,
    discount: 0,
    discountReason: '',
    grandTotal: 104860,
    paymentTerms: 'net60',
    deliveryTerms: 'Ex-works',
    notes: 'New customer inquiry - follow up required',
    preparedBy: 'Darunda',
    approvedBy: '',
    entity: 'IND',
    convertedToSO: null,
    createdAt: '2026-01-20',
  },
  {
    id: 'QT-2601-003',
    customerId: 'C004',
    customerContact: 'Khun Prawit',
    customerCategory: 'potential', // spoke before, not yet ordered
    quotationReason: 'price_change',
    quoteDate: '2026-01-25',
    validUntil: '2026-02-10',
    status: 'draft',
    items: [
      { id: 1, productId: 'PROD004', productName: 'Upper 9x70x2440', description: 'PRTB slats for pallets', qty: 5000, unit: 'pcs', unitPrice: 12, total: 60000 },
    ],
    subtotal: 60000,
    vatRate: 7,
    vat: 4200,
    discount: 3000,
    discountReason: 'Volume discount - CEO approved',
    grandTotal: 61200,
    paymentTerms: 'net30',
    deliveryTerms: 'Delivered to customer site',
    notes: 'Large volume order - check inventory',
    preparedBy: 'Darunda',
    approvedBy: 'CEO',
    entity: 'IND',
    convertedToSO: null,
    createdAt: '2026-01-25',
  },
]

// ============================================
// REJECTIONS (Returns/Rejections at delivery)
// ============================================
const INITIAL_REJECTIONS = [
  {
    id: 'REJ-2601-001',
    date: '2026-01-28',
    customerId: 'C001',
    invoiceId: 'INV-2407-001',
    doId: 'DO-2407-001',
    items: [
      { productName: 'Pallet 1100x950x950', qtyRejected: 5, qtyDelivered: 200, reason: 'Damaged', notes: 'Broken corners' }
    ],
    totalRejected: 5,
    reason: 'damaged', // wrong_size, damaged, quality_issue, wrong_product, other
    description: 'Customer found 5 pallets with broken corners upon inspection',
    photos: [],
    action: 'credit_note', // replace, repair, credit_note, scrap_invoice
    status: 'resolved', // open, in_progress, resolved
    resolutionDate: '2026-01-30',
    resolutionNotes: 'Credit note CN-2601-001 issued',
    creditNoteId: 'CN-2601-001',
    handledBy: 'Darunda',
    createdAt: '2026-01-28',
  },
]

// ============================================
// CLAIMS (Customer disputes/compensation)
// ============================================
const INITIAL_CLAIMS = [
  {
    id: 'CLM-2601-001',
    date: '2026-01-25',
    customerId: 'C002',
    relatedDocs: {
      invoiceId: null,
      doId: null,
      rejectionId: null,
    },
    claimType: 'quality', // quality, shortage, damage, price_dispute, other
    claimAmount: 5000,
    description: 'Customer claims product dimensions were not as specified in quotation',
    supportingDocs: [],
    investigationNotes: 'Verified measurements - within tolerance but customer unhappy',
    resolution: 'partial', // accepted_full, accepted_partial, rejected, pending
    resolvedAmount: 2500,
    creditNoteId: null,
    status: 'under_review', // open, under_review, resolved, closed
    approvedBy: '',
    createdAt: '2026-01-25',
  },
]

// ============================================
// CREDIT NOTES
// ============================================
const INITIAL_CREDIT_NOTES = [
  {
    id: 'CN-2601-001',
    date: '2026-01-30',
    customerId: 'C001',
    originalInvoiceId: 'INV-2407-001',
    rejectionId: 'REJ-2601-001',
    claimId: null,
    reason: 'Goods returned - damaged',
    items: [
      { description: 'Pallet 1100x950x950 (damaged)', qty: 5, unitPrice: 303, total: 1515 }
    ],
    subtotal: 1515,
    vatRate: 7,
    vat: 106.05,
    grandTotal: 1621.05,
    status: 'issued', // draft, issued, applied
    appliedToInvoice: 'INV-2407-001',
    appliedDate: '2026-01-30',
    preparedBy: 'Darunda',
    approvedBy: 'CEO',
    entity: 'IND',
    createdAt: '2026-01-30',
  },
]

// ============================================
// SALES MEETINGS LOG
// ============================================
const INITIAL_SALES_MEETINGS = [
  {
    id: 'MTG-001',
    date: '2026-01-20',
    timeStart: '10:00',
    timeEnd: '11:30',
    customerId: 'C001',
    customerType: 'existing', // new, potential, existing
    contactPerson: 'Khun Preeda',
    indAttendees: ['Darunda', 'MAs'],
    location: 'customer_site', // customer_site, ind, other
    locationDetail: 'Royal Ceramics - Rayong Factory',
    reason: 'relationship', // new_business, quotation_followup, complaint, relationship, price_negotiation, technical, other
    meetingNotes: 'Discussed Q1 requirements. Customer planning to increase order volume by 20%.',
    outcome: 'order_received', // order_received, quotation_requested, followup_required, no_action, lost
    nextAction: 'Send revised quotation for Q2',
    nextFollowupDate: '2026-02-15',
    attachments: [],
    createdBy: 'Darunda',
    createdAt: '2026-01-20',
  },
  {
    id: 'MTG-002',
    date: '2026-01-22',
    timeStart: '14:00',
    timeEnd: '15:00',
    customerId: 'C003',
    customerType: 'potential',
    contactPerson: 'Khun Napat',
    indAttendees: ['Darunda'],
    location: 'ind',
    locationDetail: 'IND Meeting Room',
    reason: 'new_business',
    meetingNotes: 'New customer inquiry for wooden pallets. Showed factory tour. Very interested in MLH products.',
    outcome: 'quotation_requested',
    nextAction: 'Prepare quotation for 500 pallets',
    nextFollowupDate: '2026-01-25',
    attachments: [],
    createdBy: 'Darunda',
    createdAt: '2026-01-22',
  },
]

// ============================================
// DELIVERY ORDERS
// ============================================
const INITIAL_DELIVERY_ORDERS = [
  {
    id: 'DO-2407-001',
    invoiceId: 'INV-2407-001',
    soId: 'SO-2407-001',
    customerId: 'C001',
    deliveryDate: '2024-07-20',
    scheduledTime: '09:00',
    truckId: 'T1',
    driverId: 7,
    status: 'delivered',
    items: [
      { productName: 'Pallet 1100x950x950', qty: 200, unit: 'pcs' },
    ],
    deliveryAddress: 'Royal Ceramics - Rayong Factory',
    receivedBy: 'Khun Preeda',
    receivedAt: '2024-07-20 10:30',
    notes: 'Delivered on time',
    entity: 'IND',
  },
]

// ============================================
// HR - EMPLOYEES
// ============================================
const INITIAL_EMPLOYEES = [
  { id: 1, empId: 'EMP001', name: 'Wuttipong Srisuk', nameTh: '‡∏ß‡∏∏‡∏í‡∏¥‡∏û‡∏á‡∏©‡πå ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç', department: 'office', designation: 'MG', empType: 'FT', salary: 35000, positionInc: 5000, labourInc: 0, phone: 500, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2018-01-15', hourlyRate: 200 },
  { id: 2, empId: 'EMP002', name: 'Somchai Yodrak', nameTh: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏Å', department: 'production', subDept: 'C1', designation: 'LEAD', empType: 'FT', salary: 18000, positionInc: 2000, labourInc: 1500, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2019-03-01', hourlyRate: 100 },
  { id: 3, empId: 'EMP003', name: 'Nanthana Boonmee', nameTh: '‡∏ô‡∏±‡∏ô‡∏ó‡∏ô‡∏≤ ‡∏ö‡∏∏‡∏ç‡∏°‡∏µ', department: 'hr', designation: 'HR', empType: 'FT', salary: 16000, positionInc: 1500, labourInc: 0, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2020-06-01', hourlyRate: 90 },
  { id: 4, empId: 'EMP004', name: 'Pakamas Rattana', nameTh: '‡∏ú‡∏Å‡∏≤‡∏°‡∏≤‡∏® ‡∏£‡∏±‡∏ï‡∏ô‡∏∞', department: 'accounting', designation: 'ACC', empType: 'FT', salary: 15000, positionInc: 0, labourInc: 0, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND2', status: 'active', joinDate: '2021-01-10', hourlyRate: 85 },
  { id: 5, empId: 'EMP005', name: 'Prasert Thongdee', nameTh: '‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏ó‡∏≠‡∏á‡∏î‡∏µ', department: 'warehouse', designation: 'WH', empType: 'FT', salary: 12000, positionInc: 0, labourInc: 1000, phone: 0, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2019-08-15', hourlyRate: 70 },
  { id: 6, empId: 'EMP006', name: 'Somporn Kaewjai', nameTh: '‡∏™‡∏°‡∏û‡∏£ ‡πÅ‡∏Å‡πâ‡∏ß‡πÉ‡∏à', department: 'production', subDept: 'P1', designation: 'OP', empType: 'PT', dailyRate: 400, entity: 'IND', status: 'active', joinDate: '2022-03-01', hourlyRate: 50 },
  { id: 7, empId: 'EMP007', name: 'Vichai Kaewsri', nameTh: '‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡πÅ‡∏Å‡πâ‡∏ß‡∏®‡∏£‡∏µ', department: 'transport', designation: 'DRIVER', empType: 'FT', salary: 14000, positionInc: 0, labourInc: 500, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2020-02-01', hourlyRate: 80 },
  // MAINTENANCE DEPARTMENT STAFF
  { id: 8, empId: 'EMP008', name: 'Boonlert Jaidee', nameTh: '‡∏ö‡∏∏‡∏ç‡πÄ‡∏•‡∏¥‡∏® ‡πÉ‡∏à‡∏î‡∏µ', department: 'maintenance', designation: 'TECH-SR', empType: 'FT', salary: 18000, positionInc: 2000, labourInc: 500, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2019-05-15', hourlyRate: 120, skills: ['Electrical', 'Mechanical', 'Welding', 'PLC'], certifications: ['Electrical License', 'Forklift Operator'] },
  { id: 9, empId: 'EMP009', name: 'Kanya Srisuk', nameTh: '‡∏Å‡∏±‡∏ç‡∏ç‡∏≤ ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç', department: 'sales', designation: 'SALES', empType: 'FT', salary: 15000, positionInc: 0, labourInc: 0, phone: 500, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2021-07-01', hourlyRate: 85 },
  { id: 10, empId: 'EMP010', name: 'Manop Saelee', nameTh: '‡∏°‡∏≤‡∏ô‡∏û ‡πÅ‡∏™‡∏•‡∏µ', department: 'production', subDept: 'A1', designation: 'OP', empType: 'FT', salary: 11000, positionInc: 0, labourInc: 1000, phone: 0, socialSecurity: 750, bank: 'cash', entity: 'IND', status: 'active', joinDate: '2022-01-10', hourlyRate: 65 },
  // Additional Maintenance Staff
  { id: 11, empId: 'EMP011', name: 'Sakchai Wongsri', nameTh: '‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏ä‡∏±‡∏¢ ‡∏ß‡∏á‡∏®‡πå‡∏®‡∏£‡∏µ', department: 'maintenance', designation: 'TECH', empType: 'FT', salary: 15000, positionInc: 1000, labourInc: 500, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2020-08-01', hourlyRate: 100, skills: ['Mechanical', 'Hydraulics', 'Pneumatics'], certifications: ['Crane Operator'] },
  { id: 12, empId: 'EMP012', name: 'Wichai Phumiphat', nameTh: '‡∏ß‡∏¥‡∏ä‡∏±‡∏¢ ‡∏†‡∏π‡∏°‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå', department: 'maintenance', designation: 'TECH', empType: 'FT', salary: 14000, positionInc: 500, labourInc: 500, phone: 300, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2021-03-15', hourlyRate: 90, skills: ['Electrical', 'HVAC', 'Plumbing'], certifications: ['HVAC Technician'] },
  { id: 13, empId: 'EMP013', name: 'Anong Thongsuk', nameTh: '‡∏≠‡∏ô‡∏á‡∏Ñ‡πå ‡∏ó‡∏≠‡∏á‡∏™‡∏∏‡∏Ç', department: 'maintenance', designation: 'TECH-JR', empType: 'FT', salary: 12000, positionInc: 0, labourInc: 500, phone: 0, socialSecurity: 750, bank: 'transfer', entity: 'IND', status: 'active', joinDate: '2023-06-01', hourlyRate: 75, skills: ['General Maintenance', 'Painting'], certifications: [] },
  { id: 14, empId: 'EMP014', name: 'Thanakorn Saetang', nameTh: '‡∏ò‡∏ô‡∏≤‡∏Å‡∏£ ‡πÅ‡∏ã‡πà‡∏ï‡∏±‡πâ‡∏á', department: 'maintenance', designation: 'HELPER', empType: 'PT', dailyRate: 400, entity: 'IND', status: 'active', joinDate: '2024-01-10', hourlyRate: 50, skills: ['General Helper'], certifications: [] },
]

// ============================================
// MAINTENANCE TASKS (Enhanced with Work Logs & Cost Tracking)
// ============================================
const INITIAL_MAINTENANCE_TASKS = [
  { 
    id: 'MWO-2601-001', 
    mwoNumber: 'MWO-2601-001',
    equipment: 'CNC Router #1', 
    equipmentId: 'EQ001', 
    type: 'preventive', 
    description: 'Monthly maintenance check - oil change, belt inspection, calibration', 
    // Assignment
    assignedTechnicians: [8, 11], // Boonlert (lead), Sakchai
    leadTechnician: 8,
    // Schedule
    scheduledDate: '2025-01-28', 
    startedDate: '2025-01-28',
    completedDate: null, 
    status: 'in_progress', 
    priority: 'medium', 
    estimatedHours: 4,
    // Work Logs
    workLogs: [
      { id: 'WL-001', date: '2025-01-28', technicianId: 8, hours: 2.5, description: 'Drained old oil, inspected belts - found V-belt worn', laborCost: 300 },
      { id: 'WL-002', date: '2025-01-28', technicianId: 11, hours: 1.5, description: 'Assisted with oil change, cleaned filters', laborCost: 150 },
    ],
    // Parts Used
    partsUsed: [
      { issueId: 'ISS-001', itemId: 'MS-001', itemName: 'Motor Oil 15W-40', sku: 'LUB-OIL-15W40', qty: 4, unitCost: 180, totalCost: 720 },
    ],
    // Cost Summary
    laborHours: 4,
    laborCost: 450,
    partsCost: 720,
    totalCost: 1170,
  },
  { 
    id: 'MWO-2601-002', 
    mwoNumber: 'MWO-2601-002',
    equipment: 'Forklift #2', 
    equipmentId: 'EQ002', 
    type: 'repair', 
    description: 'Hydraulic system repair - cylinder leaking', 
    assignedTechnicians: [8, 12],
    leadTechnician: 8,
    scheduledDate: '2025-01-26', 
    startedDate: '2025-01-26',
    completedDate: '2025-01-27', 
    status: 'completed', 
    priority: 'high', 
    estimatedHours: 6,
    workLogs: [
      { id: 'WL-003', date: '2025-01-26', technicianId: 8, hours: 3, description: 'Diagnosed hydraulic leak, disassembled cylinder', laborCost: 360 },
      { id: 'WL-004', date: '2025-01-26', technicianId: 12, hours: 2, description: 'Assisted with disassembly, prepared new seals', laborCost: 180 },
      { id: 'WL-005', date: '2025-01-27', technicianId: 8, hours: 2.5, description: 'Installed new seals, reassembled, tested', laborCost: 300 },
      { id: 'WL-006', date: '2025-01-27', technicianId: 12, hours: 1.5, description: 'Refilled hydraulic fluid, cleaned area', laborCost: 135 },
    ],
    partsUsed: [
      { issueId: 'ISS-006', itemId: 'MS-002', itemName: 'Hydraulic Fluid ISO 46', sku: 'LUB-HYD-46', qty: 8, unitCost: 250, totalCost: 2000 },
      { issueId: 'ISS-007', itemId: 'MS-029', itemName: 'Hydraulic Oil Filter', sku: 'FLT-OIL-HYD', qty: 1, unitCost: 280, totalCost: 280 },
    ],
    laborHours: 9,
    laborCost: 975,
    partsCost: 2280,
    totalCost: 3255,
  },
  { 
    id: 'MWO-2601-003', 
    mwoNumber: 'MWO-2601-003',
    equipment: 'Band Saw #3', 
    equipmentId: 'EQ003', 
    type: 'preventive', 
    description: 'Blade replacement and calibration', 
    assignedTechnicians: [11],
    leadTechnician: 11,
    scheduledDate: '2025-02-05', 
    startedDate: null,
    completedDate: null, 
    status: 'scheduled', 
    priority: 'low', 
    estimatedHours: 2,
    workLogs: [],
    partsUsed: [],
    laborHours: 0,
    laborCost: 0,
    partsCost: 0,
    totalCost: 0,
  },
  { 
    id: 'MWO-2601-004', 
    mwoNumber: 'MWO-2601-004',
    equipment: 'Air Compressor', 
    equipmentId: 'EQ004', 
    type: 'preventive', 
    description: 'Filter replacement and pressure check', 
    assignedTechnicians: [13],
    leadTechnician: 13,
    scheduledDate: '2025-02-10', 
    startedDate: null,
    completedDate: null, 
    status: 'scheduled', 
    priority: 'medium', 
    estimatedHours: 1.5,
    workLogs: [],
    partsUsed: [],
    laborHours: 0,
    laborCost: 0,
    partsCost: 0,
    totalCost: 0,
  },
  { 
    id: 'MWO-2601-005', 
    mwoNumber: 'MWO-2601-005',
    equipment: 'Control Panel Section B', 
    equipmentId: 'EQ005', 
    type: 'repair', 
    description: 'Rewiring damaged section after power surge', 
    assignedTechnicians: [8, 12, 13],
    leadTechnician: 8,
    scheduledDate: '2025-01-30', 
    startedDate: '2025-01-30',
    completedDate: null, 
    status: 'in_progress', 
    priority: 'high', 
    estimatedHours: 8,
    workLogs: [
      { id: 'WL-007', date: '2025-01-30', technicianId: 8, hours: 3, description: 'Traced damaged circuits, identified 4 faulty breakers', laborCost: 360 },
      { id: 'WL-008', date: '2025-01-30', technicianId: 12, hours: 2.5, description: 'Removed old wiring, prepared conduits', laborCost: 225 },
    ],
    partsUsed: [
      { issueId: 'ISS-004', itemId: 'MS-021', itemName: 'Electrical Wire 2.5mm¬≤', sku: 'ELC-WIRE-25', qty: 20, unitCost: 15, totalCost: 300 },
      { issueId: 'ISS-008', itemId: 'MS-023', itemName: 'Circuit Breaker 20A', sku: 'ELC-BREAKER-20', qty: 2, unitCost: 180, totalCost: 360 },
      { issueId: 'ISS-009', itemId: 'MS-024', itemName: 'Circuit Breaker 32A', sku: 'ELC-BREAKER-32', qty: 2, unitCost: 250, totalCost: 500 },
    ],
    laborHours: 5.5,
    laborCost: 585,
    partsCost: 1160,
    totalCost: 1745,
  },
]

// ============================================
// MAINTENANCE STORE (STORE5) INVENTORY
// Parts, Supplies, Consumables for Maintenance Department
// ============================================
const INITIAL_MAINTENANCE_STORE = [
  // Lubricants
  { id: 'MS-001', sku: 'LUB-OIL-15W40', name: 'Motor Oil 15W-40', nameTh: '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 15W-40', category: 'Lubricants', storeId: 'STORE5', qty: 24, unit: 'L', minQty: 10, maxQty: 50, unitCost: 180, location: 'Shelf A1', supplier: 'Shell Thailand', lastRestock: '2026-01-15' },
  { id: 'MS-002', sku: 'LUB-HYD-46', name: 'Hydraulic Fluid ISO 46', nameTh: '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Ñ ISO 46', category: 'Lubricants', storeId: 'STORE5', qty: 15, unit: 'L', minQty: 5, maxQty: 30, unitCost: 250, location: 'Shelf A2', supplier: 'PTT Lubricants', lastRestock: '2026-01-10' },
  { id: 'MS-003', sku: 'LUB-GREASE', name: 'Multi-Purpose Grease', nameTh: '‡∏à‡∏≤‡∏£‡∏∞‡∏ö‡∏µ‡∏≠‡πÄ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå', category: 'Lubricants', storeId: 'STORE5', qty: 12, unit: 'kg', minQty: 5, maxQty: 20, unitCost: 120, location: 'Shelf A3', supplier: 'Shell Thailand', lastRestock: '2026-01-20' },
  // Belts & Bearings
  { id: 'MS-004', sku: 'BLT-V-A68', name: 'V-Belt A68', nameTh: '‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô V A68', category: 'Belts', storeId: 'STORE5', qty: 4, unit: 'pcs', minQty: 2, maxQty: 10, unitCost: 450, location: 'Shelf B1', supplier: 'Mitsuboshi', lastRestock: '2026-01-05' },
  { id: 'MS-005', sku: 'BLT-V-B65', name: 'V-Belt B65', nameTh: '‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô V B65', category: 'Belts', storeId: 'STORE5', qty: 3, unit: 'pcs', minQty: 2, maxQty: 10, unitCost: 520, location: 'Shelf B1', supplier: 'Mitsuboshi', lastRestock: '2026-01-05' },
  { id: 'MS-006', sku: 'BRG-6205', name: 'Bearing 6205 2RS', nameTh: '‡∏ï‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏õ‡∏∑‡∏ô 6205 2RS', category: 'Bearings', storeId: 'STORE5', qty: 8, unit: 'pcs', minQty: 4, maxQty: 20, unitCost: 180, location: 'Shelf B2', supplier: 'SKF Thailand', lastRestock: '2026-01-12' },
  { id: 'MS-007', sku: 'BRG-6208', name: 'Bearing 6208 2RS', nameTh: '‡∏ï‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏õ‡∏∑‡∏ô 6208 2RS', category: 'Bearings', storeId: 'STORE5', qty: 6, unit: 'pcs', minQty: 3, maxQty: 15, unitCost: 280, location: 'Shelf B2', supplier: 'SKF Thailand', lastRestock: '2026-01-12' },
  // Fuel
  { id: 'MS-008', sku: 'FUEL-DIESEL', name: 'Diesel B7', nameTh: '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏î‡∏µ‡πÄ‡∏ã‡∏• B7', category: 'Fuel', storeId: 'STORE5', qty: 200, unit: 'L', minQty: 50, maxQty: 500, unitCost: 32, location: 'Tank-1', supplier: 'PTT Station', lastRestock: '2026-01-25' },
  { id: 'MS-009', sku: 'FUEL-GASOLINE', name: 'Gasoline 95', nameTh: '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ö‡∏ô‡∏ã‡∏¥‡∏ô 95', category: 'Fuel', storeId: 'STORE5', qty: 50, unit: 'L', minQty: 20, maxQty: 100, unitCost: 38, location: 'Tank-2', supplier: 'PTT Station', lastRestock: '2026-01-25' },
  // Consumables
  { id: 'MS-010', sku: 'CON-WELD-26', name: 'Welding Rod 2.6mm', nameTh: '‡∏•‡∏ß‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° 2.6mm', category: 'Consumables', storeId: 'STORE5', qty: 100, unit: 'pcs', minQty: 50, maxQty: 500, unitCost: 5, location: 'Shelf C1', supplier: 'Kobe', lastRestock: '2026-01-18' },
  { id: 'MS-011', sku: 'CON-WELD-32', name: 'Welding Rod 3.2mm', nameTh: '‡∏•‡∏ß‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° 3.2mm', category: 'Consumables', storeId: 'STORE5', qty: 80, unit: 'pcs', minQty: 40, maxQty: 400, unitCost: 6, location: 'Shelf C1', supplier: 'Kobe', lastRestock: '2026-01-18' },
  { id: 'MS-012', sku: 'CON-DISC-CUT', name: 'Cutting Disc 4"', nameTh: '‡πÉ‡∏ö‡∏ï‡∏±‡∏î 4 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Consumables', storeId: 'STORE5', qty: 25, unit: 'pcs', minQty: 10, maxQty: 100, unitCost: 35, location: 'Shelf C2', supplier: 'Makita', lastRestock: '2026-01-20' },
  { id: 'MS-013', sku: 'CON-DISC-GRIND', name: 'Grinding Disc 4"', nameTh: '‡πÉ‡∏ö‡πÄ‡∏à‡∏µ‡∏¢‡∏£‡πå 4 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Consumables', storeId: 'STORE5', qty: 20, unit: 'pcs', minQty: 10, maxQty: 100, unitCost: 45, location: 'Shelf C2', supplier: 'Makita', lastRestock: '2026-01-20' },
  // Paint
  { id: 'MS-014', sku: 'PNT-WHITE', name: 'Paint - White', nameTh: '‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß', category: 'Paint', storeId: 'STORE5', qty: 20, unit: 'L', minQty: 10, maxQty: 50, unitCost: 350, location: 'Shelf D1', supplier: 'TOA Paint', lastRestock: '2026-01-08' },
  { id: 'MS-015', sku: 'PNT-BLUE-IND', name: 'Paint - Blue (IND Brand)', nameTh: '‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô IND', category: 'Paint', storeId: 'STORE5', qty: 10, unit: 'L', minQty: 5, maxQty: 30, unitCost: 380, location: 'Shelf D1', supplier: 'TOA Paint', lastRestock: '2026-01-08' },
  { id: 'MS-016', sku: 'PNT-GREEN-IND', name: 'Paint - Green (IND Brand)', nameTh: '‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß IND', category: 'Paint', storeId: 'STORE5', qty: 8, unit: 'L', minQty: 5, maxQty: 30, unitCost: 380, location: 'Shelf D1', supplier: 'TOA Paint', lastRestock: '2026-01-08' },
  { id: 'MS-017', sku: 'PNT-THINNER', name: 'Paint Thinner', nameTh: '‡∏ó‡∏¥‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå', category: 'Paint', storeId: 'STORE5', qty: 15, unit: 'L', minQty: 5, maxQty: 40, unitCost: 120, location: 'Shelf D2', supplier: 'TOA Paint', lastRestock: '2026-01-08' },
  // Blades
  { id: 'MS-018', sku: 'BLD-SAW-10', name: 'Saw Blade 10"', nameTh: '‡πÉ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏¢‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 10 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Blades', storeId: 'STORE5', qty: 3, unit: 'pcs', minQty: 2, maxQty: 10, unitCost: 850, location: 'Shelf B3', supplier: 'Makita', lastRestock: '2026-01-15' },
  { id: 'MS-019', sku: 'BLD-SAW-14', name: 'Saw Blade 14"', nameTh: '‡πÉ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏¢‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 14 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Blades', storeId: 'STORE5', qty: 2, unit: 'pcs', minQty: 1, maxQty: 5, unitCost: 1200, location: 'Shelf B3', supplier: 'Makita', lastRestock: '2026-01-15' },
  { id: 'MS-020', sku: 'BLD-BAND-24', name: 'Band Saw Blade 24"', nameTh: '‡πÉ‡∏ö‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏¢‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô 24 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Blades', storeId: 'STORE5', qty: 4, unit: 'pcs', minQty: 2, maxQty: 8, unitCost: 1500, location: 'Shelf B3', supplier: 'Starrett', lastRestock: '2026-01-15' },
  // Electrical
  { id: 'MS-021', sku: 'ELC-WIRE-25', name: 'Electrical Wire 2.5mm¬≤', nameTh: '‡∏™‡∏≤‡∏¢‡πÑ‡∏ü 2.5 ‡∏ï‡∏£.‡∏°‡∏°.', category: 'Electrical', storeId: 'STORE5', qty: 100, unit: 'm', minQty: 50, maxQty: 300, unitCost: 15, location: 'Shelf E1', supplier: 'Thai Yazaki', lastRestock: '2026-01-10' },
  { id: 'MS-022', sku: 'ELC-WIRE-40', name: 'Electrical Wire 4.0mm¬≤', nameTh: '‡∏™‡∏≤‡∏¢‡πÑ‡∏ü 4.0 ‡∏ï‡∏£.‡∏°‡∏°.', category: 'Electrical', storeId: 'STORE5', qty: 80, unit: 'm', minQty: 30, maxQty: 200, unitCost: 25, location: 'Shelf E1', supplier: 'Thai Yazaki', lastRestock: '2026-01-10' },
  { id: 'MS-023', sku: 'ELC-BREAKER-20', name: 'Circuit Breaker 20A', nameTh: '‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå 20A', category: 'Electrical', storeId: 'STORE5', qty: 5, unit: 'pcs', minQty: 2, maxQty: 10, unitCost: 180, location: 'Shelf E2', supplier: 'Schneider', lastRestock: '2026-01-12' },
  { id: 'MS-024', sku: 'ELC-BREAKER-32', name: 'Circuit Breaker 32A', nameTh: '‡πÄ‡∏ö‡∏£‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå 32A', category: 'Electrical', storeId: 'STORE5', qty: 4, unit: 'pcs', minQty: 2, maxQty: 10, unitCost: 250, location: 'Shelf E2', supplier: 'Schneider', lastRestock: '2026-01-12' },
  // Plumbing
  { id: 'MS-025', sku: 'PLB-PIPE-1', name: 'PVC Pipe 1"', nameTh: '‡∏ó‡πà‡∏≠ PVC 1 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Plumbing', storeId: 'STORE5', qty: 20, unit: 'pcs', minQty: 10, maxQty: 50, unitCost: 85, location: 'Shelf F1', supplier: 'SCG', lastRestock: '2026-01-05' },
  { id: 'MS-026', sku: 'PLB-PIPE-2', name: 'PVC Pipe 2"', nameTh: '‡∏ó‡πà‡∏≠ PVC 2 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Plumbing', storeId: 'STORE5', qty: 15, unit: 'pcs', minQty: 5, maxQty: 30, unitCost: 120, location: 'Shelf F1', supplier: 'SCG', lastRestock: '2026-01-05' },
  { id: 'MS-027', sku: 'PLB-VALVE-1', name: 'Ball Valve 1"', nameTh: '‡∏ß‡∏≤‡∏•‡πå‡∏ß‡∏ö‡∏≠‡∏• 1 ‡∏ô‡∏¥‡πâ‡∏ß', category: 'Plumbing', storeId: 'STORE5', qty: 8, unit: 'pcs', minQty: 4, maxQty: 20, unitCost: 150, location: 'Shelf F2', supplier: 'SCG', lastRestock: '2026-01-05' },
  // Filters
  { id: 'MS-028', sku: 'FLT-AIR-COMP', name: 'Air Compressor Filter', nameTh: '‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏±‡πä‡∏°‡∏•‡∏°', category: 'Filters', storeId: 'STORE5', qty: 6, unit: 'pcs', minQty: 2, maxQty: 12, unitCost: 350, location: 'Shelf G1', supplier: 'Atlas Copco', lastRestock: '2026-01-18' },
  { id: 'MS-029', sku: 'FLT-OIL-HYD', name: 'Hydraulic Oil Filter', nameTh: '‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Ñ', category: 'Filters', storeId: 'STORE5', qty: 5, unit: 'pcs', minQty: 2, maxQty: 10, unitCost: 280, location: 'Shelf G1', supplier: 'Parker', lastRestock: '2026-01-18' },
  { id: 'MS-030', sku: 'FLT-FUEL-DIESEL', name: 'Diesel Fuel Filter', nameTh: '‡πÑ‡∏™‡πâ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏î‡∏µ‡πÄ‡∏ã‡∏•', category: 'Filters', storeId: 'STORE5', qty: 8, unit: 'pcs', minQty: 4, maxQty: 20, unitCost: 180, location: 'Shelf G2', supplier: 'Toyota', lastRestock: '2026-01-18' },
]

// ============================================
// EQUIPMENT LIST (Enhanced with Cost Tracking)
// ============================================
const INITIAL_EQUIPMENT = [
  { id: 'EQ001', code: 'CNC-01', name: 'CNC Router #1', nameTh: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á CNC #1', location: 'Production Hall A', department: 'P1', purchaseDate: '2020-06-15', purchaseCost: 850000, warrantyEnd: '2023-06-15', status: 'operational', lastMaintenance: '2025-01-28', totalMaintenanceCost: 15420, maintenanceCount: 8 },
  { id: 'EQ002', code: 'FLT-02', name: 'Forklift #2', nameTh: '‡∏£‡∏ñ‡∏¢‡∏Å #2', location: 'Warehouse', department: 'warehouse', purchaseDate: '2019-03-10', purchaseCost: 450000, warrantyEnd: '2022-03-10', status: 'operational', lastMaintenance: '2025-01-27', totalMaintenanceCost: 28750, maintenanceCount: 12 },
  { id: 'EQ003', code: 'SAW-03', name: 'Band Saw #3', nameTh: '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏¢‡∏™‡∏≤‡∏¢‡∏û‡∏≤‡∏ô #3', location: 'Cutting Area', department: 'C1', purchaseDate: '2021-01-20', purchaseCost: 180000, warrantyEnd: '2024-01-20', status: 'operational', lastMaintenance: '2025-01-10', totalMaintenanceCost: 8200, maintenanceCount: 5 },
  { id: 'EQ004', code: 'COMP-01', name: 'Air Compressor', nameTh: '‡∏õ‡∏±‡πä‡∏°‡∏•‡∏°', location: 'Utility Room', department: 'maintenance', purchaseDate: '2018-08-05', purchaseCost: 120000, warrantyEnd: '2021-08-05', status: 'operational', lastMaintenance: '2024-10-01', totalMaintenanceCost: 12350, maintenanceCount: 15 },
  { id: 'EQ005', code: 'PNL-B', name: 'Control Panel Section B', nameTh: '‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° B', location: 'Production Hall A', department: 'P1', purchaseDate: '2019-06-01', purchaseCost: 280000, warrantyEnd: '2022-06-01', status: 'under_repair', lastMaintenance: '2025-01-30', totalMaintenanceCost: 6800, maintenanceCount: 3 },
  { id: 'EQ006', code: 'PRESS-01', name: 'Hydraulic Press #1', nameTh: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏î‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Ñ #1', location: 'Assembly Area', department: 'ASM1', purchaseDate: '2020-02-15', purchaseCost: 320000, warrantyEnd: '2023-02-15', status: 'operational', lastMaintenance: '2024-12-20', totalMaintenanceCost: 18500, maintenanceCount: 7 },
  { id: 'EQ007', code: 'DRY-01', name: 'Drying Oven #1', nameTh: '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö #1', location: 'Oven Area', department: 'OVN', purchaseDate: '2018-11-10', purchaseCost: 550000, warrantyEnd: '2021-11-10', status: 'operational', lastMaintenance: '2025-01-05', totalMaintenanceCost: 42000, maintenanceCount: 18 },
  { id: 'EQ008', code: 'GEN-01', name: 'Backup Generator', nameTh: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á', location: 'Utility Room', department: 'maintenance', purchaseDate: '2017-05-20', purchaseCost: 380000, warrantyEnd: '2020-05-20', status: 'operational', lastMaintenance: '2024-11-15', totalMaintenanceCost: 35600, maintenanceCount: 22 },
]

// ============================================
// TRANSPORT - SCHEDULED DELIVERIES
// ============================================
const INITIAL_SCHEDULED_DELIVERIES = [
  { id: 'SD-001', date: '2025-01-30', soId: 'SO-2407-001', customerId: 'C001', customerName: 'Royal Ceramics', destination: 'Rayong', truckId: 'T1', driverId: 7, items: 150, status: 'scheduled', departureTime: '08:00', estimatedArrival: '10:30', distance: 85, notes: 'Call 30 min before arrival' },
  { id: 'SD-002', date: '2025-01-31', soId: 'SO-2407-002', customerId: 'C002', customerName: 'Shin Star Industries', destination: 'Chonburi', truckId: 'T2', driverId: null, items: 500, status: 'pending_driver', departureTime: '07:00', estimatedArrival: '08:30', distance: 45, notes: '' },
  { id: 'SD-003', date: '2025-02-01', soId: null, customerId: 'C003', customerName: 'BV Industries', destination: 'Bangkok', truckId: 'T2', driverId: null, items: 200, status: 'scheduled', departureTime: '06:00', estimatedArrival: '09:00', distance: 120, notes: 'Heavy traffic expected' },
]

// ============================================
// UTILITY FUNCTIONS
// ============================================
const formatCurrency = (amount) => {
  if (amount === null || amount === undefined) return '‡∏ø0'
  return new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount)
}

const formatNumber = (num, decimals = 0) => {
  if (num === null || num === undefined) return '0'
  return new Intl.NumberFormat('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(num)
}

const formatDate = (dateStr) => {
  if (!dateStr) return '-'
  const date = new Date(dateStr)
  return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
}

const generateId = (prefix) => `${prefix}-${Date.now().toString(36).toUpperCase()}`

// ============================================
// UI COMPONENTS
// ============================================
const Badge = ({ children, variant = 'default', className = '' }) => {
  const variants = {
    default: 'bg-gray-100 text-gray-700',
    success: 'bg-green-100 text-green-700',
    warning: 'bg-yellow-100 text-yellow-700',
    danger: 'bg-red-100 text-red-700',
    info: 'bg-blue-100 text-blue-700',
    purple: 'bg-purple-100 text-purple-700',
    teal: 'bg-teal-100 text-teal-700',
    orange: 'bg-orange-100 text-orange-700',
    pink: 'bg-pink-100 text-pink-700',
    cyan: 'bg-cyan-100 text-cyan-700',
    IND: 'bg-teal-100 text-teal-700',
    IND2: 'bg-sky-100 text-sky-700',
  }
  return (
    <span className={`px-2 py-1 rounded-full text-xs font-medium ${variants[variant] || variants.default} ${className}`}>
      {children}
    </span>
  )
}

const Button = ({ children, variant = 'primary', size = 'md', icon: Icon, onClick, disabled, className = '', type = 'button' }) => {
  const variants = {
    primary: 'bg-gradient-to-r from-[#1A5276] to-[#2ECC40] text-white hover:opacity-90',
    secondary: 'bg-gray-100 text-gray-700 hover:bg-gray-200',
    outline: 'border border-gray-300 text-gray-700 hover:bg-gray-50',
    danger: 'bg-red-500 text-white hover:bg-red-600',
    ghost: 'text-gray-600 hover:bg-gray-100',
    success: 'bg-green-500 text-white hover:bg-green-600',
    info: 'bg-blue-500 text-white hover:bg-blue-600',
    warning: 'bg-orange-500 text-white hover:bg-orange-600',
  }
  const sizes = {
    sm: 'px-3 py-1.5 text-sm',
    md: 'px-4 py-2',
    lg: 'px-6 py-3 text-lg',
  }
  return (
    <button
      type={type}
      onClick={onClick}
      disabled={disabled}
      className={`inline-flex items-center justify-center gap-2 rounded-lg font-medium transition-all ${variants[variant]} ${sizes[size]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`}
    >
      {Icon && <Icon className="w-4 h-4" />}
      {children}
    </button>
  )
}

const Card = ({ children, className = '', onClick }) => (
  <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-gray-100 ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''} ${className}`}>
    {children}
  </div>
)

const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
  if (!isOpen) return null
  const sizes = { sm: 'max-w-md', md: 'max-w-2xl', lg: 'max-w-4xl', xl: 'max-w-6xl', full: 'max-w-[95vw]' }
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className={`bg-white rounded-xl w-full ${sizes[size]} max-h-[90vh] flex flex-col`}>
        <div className="flex items-center justify-between px-6 py-4 border-b bg-gradient-to-r from-[#1A5276] to-[#2ECC40] rounded-t-xl">
          <h2 className="text-lg font-bold text-white">{title}</h2>
          <button onClick={onClose} className="text-white/80 hover:text-white"><X className="w-5 h-5" /></button>
        </div>
        <div className="flex-1 overflow-y-auto p-6">{children}</div>
      </div>
    </div>
  )
}

const StatCard = ({ title, value, icon: Icon, color = 'blue', trend, subtitle }) => (
  <Card className="p-5">
    <div className="flex items-start justify-between">
      <div>
        <p className="text-sm text-gray-500 mb-1">{title}</p>
        <p className="text-2xl font-bold text-gray-800">{value}</p>
        {subtitle && <p className="text-xs text-gray-400 mt-1">{subtitle}</p>}
        {trend && (
          <div className={`flex items-center gap-1 mt-2 text-sm ${trend > 0 ? 'text-green-600' : 'text-red-600'}`}>
            {trend > 0 ? <TrendingUp className="w-4 h-4" /> : <TrendingDown className="w-4 h-4" />}
            <span>{Math.abs(trend)}%</span>
          </div>
        )}
      </div>
      <div className={`w-12 h-12 rounded-xl bg-${color}-100 flex items-center justify-center`}>
        <Icon className={`w-6 h-6 text-${color}-600`} />
      </div>
    </div>
  </Card>
)

// ============================================
// LOGIN SCREEN
// ============================================
const LoginScreen = ({ onLogin, lang, setLang }) => {
  const [username, setUsername] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [showDemo, setShowDemo] = useState(true)
  const [isLoading, setIsLoading] = useState(false)

  const handleSubmit = (e) => {
    e.preventDefault()
    setError('')
    setIsLoading(true)
    
    setTimeout(() => {
      const user = DEMO_USERS.find(u => u.username === username && u.password === password)
      if (user) {
        onLogin(user)
      } else {
        setError(lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : 'Invalid username or password')
      }
      setIsLoading(false)
    }, 500)
  }

  const handleDemoLogin = (user) => {
    setIsLoading(true)
    setTimeout(() => {
      onLogin(user)
      setIsLoading(false)
    }, 300)
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#1A5276] via-[#2980B9] to-[#2ECC40] flex items-center justify-center p-4">
      {/* Background Pattern */}
      <div className="absolute inset-0 opacity-10">
        <div className="absolute inset-0" style={{
          backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
        }} />
      </div>

      <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-[#1A5276] to-[#2ECC40] p-8 text-center">
          <div className="w-24 h-24 mx-auto mb-4 bg-white rounded-2xl p-3 shadow-lg">
            <img src={IND_LOGO_SVG} alt="IND" className="w-full h-full" />
          </div>
          <h1 className="text-2xl font-bold text-white">{t('app.title', lang)}</h1>
          <p className="text-white/80 text-sm mt-1">{t('app.subtitle', lang)}</p>
          <p className="text-white/60 text-xs mt-2">Version {VERSION}</p>
        </div>

        {/* Language Toggle */}
        <div className="flex justify-center gap-2 -mt-4 relative z-10">
          {Object.entries(LANGUAGES).slice(0, 2).map(([code, { flag, name }]) => (
            <button
              key={code}
              onClick={() => setLang(code)}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-all shadow-md ${
                lang === code 
                  ? 'bg-white text-[#1A5276] ring-2 ring-[#2ECC40]' 
                  : 'bg-white/90 text-gray-600 hover:bg-white'
              }`}
            >
              {flag} {name}
            </button>
          ))}
        </div>

        {/* Login Form */}
        <form onSubmit={handleSubmit} className="p-8 space-y-5">
          {error && (
            <div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm flex items-center gap-2">
              <AlertCircle className="w-4 h-4" />
              {error}
            </div>
          )}

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('login.username', lang)}
            </label>
            <div className="relative">
              <User className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1A5276] focus:border-transparent transition-all"
                placeholder={lang === 'th' ? '‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' : 'Enter username'}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('login.password', lang)}
            </label>
            <div className="relative">
              <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#1A5276] focus:border-transparent transition-all"
                placeholder={lang === 'th' ? '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô' : 'Enter password'}
              />
            </div>
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className="w-full bg-gradient-to-r from-[#1A5276] to-[#2ECC40] text-white py-3 rounded-lg font-semibold hover:opacity-90 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {isLoading ? (
              <>
                <Loader2 className="w-5 h-5 animate-spin" />
                {lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...' : 'Signing in...'}
              </>
            ) : (
              <>
                <LogOut className="w-5 h-5" />
                {t('login.signin', lang)}
              </>
            )}
          </button>
        </form>

        {/* Demo Accounts */}
        <div className="px-8 pb-8">
          <button 
            onClick={() => setShowDemo(!showDemo)} 
            className="w-full text-sm text-gray-500 flex items-center justify-center gap-2 hover:text-gray-700 transition-colors"
          >
            {showDemo ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
            {t('login.demo', lang)}
          </button>
          
          {showDemo && (
            <div className="mt-4 grid grid-cols-2 gap-2">
              {DEMO_USERS.map(user => (
                <button
                  key={user.id}
                  onClick={() => handleDemoLogin(user)}
                  disabled={isLoading}
                  className={`${ROLES[user.role].color} text-white text-xs py-2.5 px-3 rounded-lg hover:opacity-90 transition-all disabled:opacity-50 text-left`}
                >
                  <div className="font-medium truncate">{user.name}</div>
                  <div className="opacity-75 text-[10px] truncate">{ROLES[user.role].name}</div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

// ============================================
// SMART DOCUMENT UPLOAD MODAL
// ============================================
const SmartDocumentUploadModal = ({ isOpen, onClose, module, lang, onProcessed, categories, vendors }) => {
  const [file, setFile] = useState(null)
  const [processing, setProcessing] = useState(false)
  const [stage, setStage] = useState('upload') // upload, processing, review, complete
  const [extractedData, setExtractedData] = useState(null)
  const [manualMode, setManualMode] = useState(false)
  const [selectedCategory, setSelectedCategory] = useState('')
  const [confidence, setConfidence] = useState(0)
  const inputRef = useRef(null)

  const documentTypes = {
    purchase: [
      { id: 'vendor_invoice', name: 'Vendor Invoice', nameTh: '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢', icon: FileText },
      { id: 'delivery_note', name: 'Delivery Note', nameTh: '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á', icon: Truck },
      { id: 'quotation', name: 'Quotation', nameTh: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', icon: FileText },
      { id: 'import_docs', name: 'Import Documents', nameTh: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', icon: FileUp },
    ],
    inventory: [
      { id: 'stock_count', name: 'Stock Count Sheet', nameTh: '‡πÉ‡∏ö‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å', icon: ClipboardList },
      { id: 'transfer_note', name: 'Transfer Note', nameTh: '‡πÉ‡∏ö‡πÇ‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢', icon: ArrowRight },
    ],
    sales: [
      { id: 'customer_po', name: 'Customer PO', nameTh: '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', icon: FileText },
      { id: 'delivery_plan', name: 'Delivery Plan', nameTh: '‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á', icon: Calendar },
    ],
    hr: [
      { id: 'id_card', name: 'ID Card', nameTh: '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', icon: User },
      { id: 'contract', name: 'Contract', nameTh: '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á', icon: FileText },
    ],
  }

  const handleFile = async (f) => {
    setFile(f)
    setStage('processing')
    setProcessing(true)

    // Simulate AI document processing
    await new Promise(resolve => setTimeout(resolve, 2000))

    // Mock extraction based on module
    const mockExtraction = {
      purchase: {
        docType: 'vendor_invoice',
        vendor: vendors?.[0]?.name || 'Thai Timber Co., Ltd',
        vendorId: vendors?.[0]?.id || 'V001',
        invoiceNo: 'INV-TT-2501-' + Math.floor(Math.random() * 1000),
        invoiceDate: new Date().toISOString().split('T')[0],
        items: [
          { category: 'MLH', description: 'Mixed Hardwood 50x100x2400mm', qty: 500, unit: 'pcs', cbm: 0.6, unitPrice: 4912, total: 2947 },
          { category: 'MLH', description: 'Mixed Hardwood 50x150x2400mm', qty: 300, unit: 'pcs', cbm: 0.54, unitPrice: 4912, total: 2652 },
        ],
        subtotal: 5599,
        vat: 392,
        total: 5991,
        suggestedCategory: 'MLH',
        confidence: 94,
      },
      inventory: {
        docType: 'stock_count',
        store: 'STORE1',
        countDate: new Date().toISOString().split('T')[0],
        items: [
          { code: 'IND-MLH/0.5/3/1', lotNo: 'LP14899', counted: 695, system: 700, variance: -5 },
        ],
        confidence: 88,
      },
      sales: {
        docType: 'customer_po',
        customer: 'Royal Ceramics',
        poNumber: 'PO.RPR-' + Math.floor(Math.random() * 10000),
        poDate: new Date().toISOString().split('T')[0],
        deliveryDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        items: [
          { product: 'Pallet 1100x950x950', qty: 300, unit: 'pcs', price: 303, total: 90900 },
        ],
        total: 90900,
        confidence: 91,
      },
    }

    setExtractedData(mockExtraction[module] || mockExtraction.purchase)
    setConfidence(mockExtraction[module]?.confidence || 85)
    setSelectedCategory(mockExtraction[module]?.suggestedCategory || '')
    setProcessing(false)
    setStage('review')
  }

  const handleConfirm = () => {
    setStage('complete')
    if (onProcessed) {
      onProcessed({
        ...extractedData,
        category: selectedCategory || extractedData.suggestedCategory,
        file: file?.name,
        processedAt: new Date().toISOString(),
      })
    }
    setTimeout(() => {
      onClose()
      resetModal()
    }, 1500)
  }

  const resetModal = () => {
    setFile(null)
    setStage('upload')
    setExtractedData(null)
    setManualMode(false)
    setSelectedCategory('')
  }

  if (!isOpen) return null

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={t('upload.title', lang)} size="lg">
      {/* Stage: Upload */}
      {stage === 'upload' && (
        <div className="space-y-6">
          {/* Document Type Selection */}
          <div>
            <h3 className="font-medium text-gray-700 mb-3">
              {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' : 'Document Type'}
            </h3>
            <div className="grid grid-cols-2 gap-3">
              {(documentTypes[module] || documentTypes.purchase).map(dt => (
                <button
                  key={dt.id}
                  className="flex items-center gap-3 p-4 border rounded-lg hover:border-[#1A5276] hover:bg-gray-50 transition-all text-left"
                >
                  <div className="w-10 h-10 rounded-lg bg-[#1A5276]/10 flex items-center justify-center">
                    <dt.icon className="w-5 h-5 text-[#1A5276]" />
                  </div>
                  <div>
                    <div className="font-medium text-gray-800">{dt.name}</div>
                    <div className="text-sm text-gray-500">{dt.nameTh}</div>
                  </div>
                </button>
              ))}
            </div>
          </div>

          {/* Upload Zone */}
          <div
            onClick={() => inputRef.current?.click()}
            className="border-2 border-dashed border-gray-300 rounded-xl p-12 text-center cursor-pointer hover:border-[#1A5276] hover:bg-gray-50 transition-all"
          >
            <input
              ref={inputRef}
              type="file"
              className="hidden"
              accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls"
              onChange={(e) => e.target.files?.[0] && handleFile(e.target.files[0])}
            />
            <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-[#1A5276] to-[#2ECC40] flex items-center justify-center">
              <Upload className="w-8 h-8 text-white" />
            </div>
            <p className="text-gray-600 font-medium">
              {lang === 'th' ? '‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á' : 'Click to select file or drag and drop'}
            </p>
            <p className="text-sm text-gray-400 mt-2">PDF, JPG, PNG, Excel ‚Ä¢ Max 10MB</p>
          </div>

          {/* AI Features Badge */}
          <div className="flex items-center justify-center gap-2 text-sm text-gray-500">
            <Brain className="w-4 h-4 text-[#2ECC40]" />
            <span>{lang === 'th' ? 'AI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : 'AI will automatically extract data from document'}</span>
          </div>
        </div>
      )}

      {/* Stage: Processing */}
      {stage === 'processing' && (
        <div className="text-center py-12">
          <div className="relative w-24 h-24 mx-auto mb-6">
            <div className="absolute inset-0 rounded-full border-4 border-gray-200" />
            <div className="absolute inset-0 rounded-full border-4 border-t-[#1A5276] border-r-[#2ECC40] animate-spin" />
            <div className="absolute inset-4 rounded-full bg-gradient-to-br from-[#1A5276] to-[#2ECC40] flex items-center justify-center">
              <Brain className="w-8 h-8 text-white" />
            </div>
          </div>
          <h3 className="text-lg font-bold text-gray-800 mb-2">
            {lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' : 'Processing Document'}
          </h3>
          <p className="text-gray-500">{file?.name}</p>
          <div className="mt-6 space-y-2 text-sm text-gray-600">
            <div className="flex items-center justify-center gap-2">
              <Loader2 className="w-4 h-4 animate-spin text-[#1A5276]" />
              <span>{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...' : 'Reading text...'}</span>
            </div>
          </div>
        </div>
      )}

      {/* Stage: Review */}
      {stage === 'review' && extractedData && (
        <div className="space-y-6">
          {/* Confidence Score */}
          <div className="flex items-center justify-between bg-gray-50 rounded-lg p-4">
            <div className="flex items-center gap-3">
              <div className={`w-12 h-12 rounded-full flex items-center justify-center ${confidence >= 90 ? 'bg-green-100' : confidence >= 70 ? 'bg-yellow-100' : 'bg-red-100'}`}>
                <span className={`text-lg font-bold ${confidence >= 90 ? 'text-green-600' : confidence >= 70 ? 'text-yellow-600' : 'text-red-600'}`}>
                  {confidence}%
                </span>
              </div>
              <div>
                <div className="font-medium text-gray-800">
                  {lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô' : 'Extraction Confidence'}
                </div>
                <div className="text-sm text-gray-500">
                  {confidence >= 90 ? (lang === 'th' ? '‡∏™‡∏π‡∏á - ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'High - Ready to use') :
                   confidence >= 70 ? (lang === 'th' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á - ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : 'Medium - Please verify') :
                   (lang === 'th' ? '‡∏ï‡πà‡∏≥ - ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : 'Low - Needs review')}
                </div>
              </div>
            </div>
            <button
              onClick={() => setManualMode(!manualMode)}
              className="text-sm text-[#1A5276] hover:underline"
            >
              {manualMode ? (lang === 'th' ? '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : 'View Auto Data') : (lang === 'th' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á' : 'Edit Manually')}
            </button>
          </div>

          {/* Extracted Data */}
          <div className="bg-white border rounded-lg overflow-hidden">
            <div className="bg-gray-50 px-4 py-3 border-b">
              <h4 className="font-medium text-gray-800">
                {lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ' : 'Extracted Information'}
              </h4>
            </div>
            <div className="p-4 space-y-4">
              {extractedData.vendor && (
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor'}</label>
                    <p className="font-medium">{extractedData.vendor}</p>
                  </div>
                  <div>
                    <label className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice No.'}</label>
                    <p className="font-medium">{extractedData.invoiceNo}</p>
                  </div>
                </div>
              )}
              
              {extractedData.items && (
                <div>
                  <label className="text-sm text-gray-500 mb-2 block">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Items'}</label>
                  <table className="w-full text-sm">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Description'}</th>
                        <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                        <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price'}</th>
                        <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y">
                      {extractedData.items.map((item, idx) => (
                        <tr key={idx}>
                          <td className="px-3 py-2">{item.description || item.product}</td>
                          <td className="px-3 py-2 text-right">{item.qty} {item.unit}</td>
                          <td className="px-3 py-2 text-right">{formatCurrency(item.unitPrice || item.price)}</td>
                          <td className="px-3 py-2 text-right font-medium">{formatCurrency(item.total)}</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-gray-50 font-medium">
                      <tr>
                        <td colSpan="3" className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : 'Grand Total'}</td>
                        <td className="px-3 py-2 text-right text-[#1A5276]">{formatCurrency(extractedData.total)}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              )}

              {/* Category Selection */}
              {extractedData.suggestedCategory && categories && (
                <div>
                  <label className="text-sm text-gray-500 mb-2 block">
                    {lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Material Category'}
                  </label>
                  <select
                    value={selectedCategory || extractedData.suggestedCategory}
                    onChange={(e) => setSelectedCategory(e.target.value)}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    {categories.filter(c => c.type === 'raw_material').map(cat => (
                      <option key={cat.id} value={cat.id}>{cat.code} - {cat.nameEn}</option>
                    ))}
                  </select>
                  {!selectedCategory && (
                    <p className="text-xs text-green-600 mt-1 flex items-center gap-1">
                      <CheckCircle className="w-3 h-3" />
                      {lang === 'th' ? 'AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ' : 'AI suggested this category'}
                    </p>
                  )}
                </div>
              )}
            </div>
          </div>

          {/* Actions */}
          <div className="flex gap-3">
            <Button variant="outline" onClick={() => { resetModal(); }} className="flex-1">
              {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
            </Button>
            <Button onClick={handleConfirm} className="flex-1">
              <CheckCircle className="w-4 h-4" />
              {lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Confirm & Import'}
            </Button>
          </div>
        </div>
      )}

      {/* Stage: Complete */}
      {stage === 'complete' && (
        <div className="text-center py-12">
          <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-green-100 flex items-center justify-center">
            <CheckCircle className="w-10 h-10 text-green-600" />
          </div>
          <h3 className="text-xl font-bold text-gray-800 mb-2">
            {t('upload.success', lang)}
          </h3>
          <p className="text-gray-500">
            {lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : 'Data has been imported to the system'}
          </p>
        </div>
      )}
    </Modal>
  )
}

// File continues in next part...
// Total lines so far: ~1,450

// ============================================
// TRANSPORT MODULE (DEEP - WITH CALENDAR)
// ============================================
const TransportModule = ({ deliveries, setDeliveries, trucks, employees, salesOrders, lang }) => {
  const [activeTab, setActiveTab] = useState('calendar')
  const [selectedDate, setSelectedDate] = useState(new Date())
  const [showScheduleModal, setShowScheduleModal] = useState(false)
  const [selectedDelivery, setSelectedDelivery] = useState(null)
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth())
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear())

  const tabs = [
    { id: 'calendar', label: lang === 'th' ? '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô' : 'Calendar', icon: CalendarDays },
    { id: 'deliveries', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á' : 'Deliveries', icon: Truck },
    { id: 'allowances', label: lang === 'th' ? '‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á' : 'Allowances', icon: Banknote },
    { id: 'vehicles', label: lang === 'th' ? '‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞' : 'Vehicles', icon: Car },
    { id: 'routes', label: lang === 'th' ? '‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á' : 'Routes', icon: Navigation },
  ]

  const drivers = employees?.filter(e => e.department === 'transport') || []

  // ========== ALLOWANCE CALCULATION (Per Spec Section 32) ==========
  // Rules:
  // - Base allowance: 100% of furthest destination rate
  // - Additional stops: +50% of each additional stop rate
  // - Monthly bonus: 45+ trips = ‡∏ø500
  // - Late delivery (after 7PM): +‡∏ø50
  // - Holiday delivery: +‡∏ø50
  
  const DESTINATION_RATES = {
    'local': 100,      // Within Chonburi
    'rayong': 200,     // Rayong
    'chachoengsao': 180, // Chachoengsao
    'bangkok': 350,    // Bangkok
    'ayutthaya': 400,  // Ayutthaya
    'samut_prakan': 300, // Samut Prakan
    'pathum_thani': 380, // Pathum Thani
    'other': 250,      // Default
  }

  const HOLIDAYS_2026 = [
    '2026-01-01', '2026-02-26', '2026-04-06', '2026-04-13', '2026-04-14', '2026-04-15',
    '2026-05-01', '2026-05-04', '2026-05-13', '2026-06-03', '2026-07-10', '2026-07-28',
    '2026-08-12', '2026-10-13', '2026-10-23', '2026-12-05', '2026-12-10', '2026-12-31'
  ]

  const isHoliday = (dateStr) => HOLIDAYS_2026.includes(dateStr) || new Date(dateStr).getDay() === 0

  const calculateTripAllowance = (delivery) => {
    if (!delivery) return { base: 0, additional: 0, lateBonus: 0, holidayBonus: 0, total: 0 }
    
    // Get base rate for furthest destination
    const baseRate = DESTINATION_RATES[delivery.destination] || DESTINATION_RATES.other
    
    // Additional stops at 50%
    const additionalStops = delivery.additionalStops || 0
    const additionalRate = additionalStops * (baseRate * 0.5)
    
    // Late delivery bonus (after 7PM)
    const deliveryHour = delivery.completedTime ? parseInt(delivery.completedTime.split(':')[0]) : 0
    const lateBonus = deliveryHour >= 19 ? 50 : 0
    
    // Holiday bonus
    const holidayBonus = isHoliday(delivery.date) ? 50 : 0
    
    return {
      base: baseRate,
      additional: additionalRate,
      lateBonus,
      holidayBonus,
      total: baseRate + additionalRate + lateBonus + holidayBonus
    }
  }

  const calculateDriverMonthlyAllowance = (driverId, month, year) => {
    const monthDeliveries = deliveries?.filter(d => {
      const deliveryDate = new Date(d.date)
      return d.driverId === driverId && 
             d.status === 'delivered' &&
             deliveryDate.getMonth() === month && 
             deliveryDate.getFullYear() === year
    }) || []

    let totalAllowance = 0
    let totalTrips = monthDeliveries.length
    let totalBase = 0
    let totalAdditional = 0
    let totalLate = 0
    let totalHoliday = 0

    monthDeliveries.forEach(d => {
      const calc = calculateTripAllowance(d)
      totalBase += calc.base
      totalAdditional += calc.additional
      totalLate += calc.lateBonus
      totalHoliday += calc.holidayBonus
      totalAllowance += calc.total
    })

    // Monthly trip bonus: 45+ trips = ‡∏ø500
    const tripBonus = totalTrips >= 45 ? 500 : 0

    return {
      driverId,
      trips: totalTrips,
      baseAllowance: totalBase,
      additionalAllowance: totalAdditional,
      lateBonus: totalLate,
      holidayBonus: totalHoliday,
      tripBonus,
      totalAllowance: totalAllowance + tripBonus
    }
  }

  // Calendar helpers
  const getDaysInMonth = (date) => {
    const year = date.getFullYear()
    const month = date.getMonth()
    const firstDay = new Date(year, month, 1)
    const lastDay = new Date(year, month + 1, 0)
    const days = []
    
    // Add empty days for alignment
    for (let i = 0; i < firstDay.getDay(); i++) {
      days.push(null)
    }
    
    // Add actual days
    for (let i = 1; i <= lastDay.getDate(); i++) {
      days.push(new Date(year, month, i))
    }
    
    return days
  }

  const getDeliveriesForDate = (date) => {
    if (!date) return []
    const dateStr = date.toISOString().split('T')[0]
    return deliveries?.filter(d => d.date === dateStr) || []
  }

  const stats = {
    total: deliveries?.length || 0,
    scheduled: deliveries?.filter(d => d.status === 'scheduled').length || 0,
    inTransit: deliveries?.filter(d => d.status === 'in_transit').length || 0,
    delivered: deliveries?.filter(d => d.status === 'delivered').length || 0,
    pendingDriver: deliveries?.filter(d => d.status === 'pending_driver').length || 0,
    availableTrucks: trucks?.filter(t => t.status === 'available').length || 0,
  }

  const monthNames = lang === 'th' 
    ? ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°']
    : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

  const dayNames = lang === 'th'
    ? ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™']
    : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.transport', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞' : 'Manage deliveries and vehicles'}</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" icon={Upload}>
            {lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î' : 'Upload'}
          </Button>
          <Button icon={Plus} onClick={() => setShowScheduleModal(true)}>
            {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á' : 'Schedule Delivery'}
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total'}</div>
          <div className="text-2xl font-bold text-gray-800">{stats.total}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á' : 'Scheduled'}</div>
          <div className="text-2xl font-bold text-blue-600">{stats.scheduled}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á' : 'In Transit'}</div>
          <div className="text-2xl font-bold text-orange-600">{stats.inTransit}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered'}</div>
          <div className="text-2xl font-bold text-green-600">{stats.delivered}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-yellow-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Need Driver'}</div>
          <div className="text-2xl font-bold text-yellow-600">{stats.pendingDriver}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-cyan-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á' : 'Available'}</div>
          <div className="text-2xl font-bold text-cyan-600">{stats.availableTrucks}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Calendar View */}
      {activeTab === 'calendar' && (
        <Card className="p-6">
          {/* Calendar Header */}
          <div className="flex items-center justify-between mb-6">
            <button 
              onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() - 1, 1))}
              className="p-2 hover:bg-gray-100 rounded-lg"
            >
              <ChevronLeft className="w-5 h-5" />
            </button>
            <h3 className="text-xl font-bold text-gray-800">
              {monthNames[selectedDate.getMonth()]} {selectedDate.getFullYear()}
            </h3>
            <button 
              onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1))}
              className="p-2 hover:bg-gray-100 rounded-lg"
            >
              <ChevronRight className="w-5 h-5" />
            </button>
          </div>

          {/* Day Headers */}
          <div className="grid grid-cols-7 gap-2 mb-2">
            {dayNames.map(day => (
              <div key={day} className="text-center text-sm font-medium text-gray-500 py-2">
                {day}
              </div>
            ))}
          </div>

          {/* Calendar Grid */}
          <div className="grid grid-cols-7 gap-2">
            {getDaysInMonth(selectedDate).map((day, idx) => {
              const dayDeliveries = getDeliveriesForDate(day)
              const isToday = day && day.toDateString() === new Date().toDateString()
              
              return (
                <div
                  key={idx}
                  className={`min-h-[100px] p-2 rounded-lg border ${
                    day ? 'bg-white hover:bg-gray-50 cursor-pointer' : 'bg-gray-50'
                  } ${isToday ? 'ring-2 ring-[#2ECC40]' : ''}`}
                  onClick={() => day && dayDeliveries.length > 0 && setSelectedDelivery(dayDeliveries[0])}
                >
                  {day && (
                    <>
                      <div className={`text-sm font-medium ${isToday ? 'text-[#2ECC40]' : 'text-gray-700'}`}>
                        {day.getDate()}
                      </div>
                      <div className="mt-1 space-y-1">
                        {dayDeliveries.slice(0, 3).map(del => (
                          <div 
                            key={del.id}
                            className={`text-xs p-1 rounded truncate ${
                              del.status === 'delivered' ? 'bg-green-100 text-green-700' :
                              del.status === 'in_transit' ? 'bg-orange-100 text-orange-700' :
                              del.status === 'pending_driver' ? 'bg-yellow-100 text-yellow-700' :
                              'bg-blue-100 text-blue-700'
                            }`}
                          >
                            {del.customerName}
                          </div>
                        ))}
                        {dayDeliveries.length > 3 && (
                          <div className="text-xs text-gray-500 text-center">
                            +{dayDeliveries.length - 3} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'more'}
                          </div>
                        )}
                      </div>
                    </>
                  )}
                </div>
              )
            })}
          </div>
        </Card>
      )}

      {/* Deliveries List */}
      {activeTab === 'deliveries' && (
        <Card className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'ID'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á' : 'Destination'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ñ' : 'Vehicle'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Driver'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Items'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {(deliveries || INITIAL_SCHEDULED_DELIVERIES).map(del => {
                  const truck = trucks?.find(t => t.id === del.truckId)
                  const driver = employees?.find(e => e.id === del.driverId)
                  return (
                    <tr key={del.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{del.id}</td>
                      <td className="px-4 py-3">{formatDate(del.date)}</td>
                      <td className="px-4 py-3 font-medium">{del.customerName}</td>
                      <td className="px-4 py-3 flex items-center gap-1">
                        <MapPin className="w-4 h-4 text-gray-400" />
                        {del.destination}
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <Car className="w-4 h-4 text-gray-400" />
                          {truck?.nameEn || del.truckId}
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        {driver ? driver.name : (
                          <span className="text-yellow-600 text-sm">{lang === 'th' ? '‡∏£‡∏≠‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢' : 'Unassigned'}</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">{del.items}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          del.status === 'delivered' ? 'success' :
                          del.status === 'in_transit' ? 'orange' :
                          del.status === 'pending_driver' ? 'warning' :
                          'info'
                        }>
                          {del.status === 'delivered' ? (lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered') :
                           del.status === 'in_transit' ? (lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á' : 'In Transit') :
                           del.status === 'pending_driver' ? (lang === 'th' ? '‡∏£‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Need Driver') :
                           (lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Scheduled')}
                        </Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <button className="p-1 hover:bg-gray-100 rounded">
                          <Eye className="w-4 h-4 text-gray-500" />
                        </button>
                        <button className="p-1 hover:bg-gray-100 rounded">
                          <Edit3 className="w-4 h-4 text-gray-500" />
                        </button>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* Vehicles Tab */}
      {activeTab === 'vehicles' && (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {(trucks || INITIAL_TRUCKS).map(truck => (
            <Card key={truck.id} className="p-5">
              <div className="flex items-start justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                    truck.status === 'available' ? 'bg-green-100' :
                    truck.status === 'in_use' ? 'bg-blue-100' :
                    'bg-red-100'
                  }`}>
                    <Truck className={`w-6 h-6 ${
                      truck.status === 'available' ? 'text-green-600' :
                      truck.status === 'in_use' ? 'text-blue-600' :
                      'text-red-600'
                    }`} />
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-800">{truck.nameEn}</h3>
                    <p className="text-sm text-gray-500">{truck.nameTh}</p>
                  </div>
                </div>
                <Badge variant={
                  truck.status === 'available' ? 'success' :
                  truck.status === 'in_use' ? 'info' :
                  'danger'
                }>
                  {truck.status === 'available' ? (lang === 'th' ? '‡∏ß‡πà‡∏≤‡∏á' : 'Available') :
                   truck.status === 'in_use' ? (lang === 'th' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'In Use') :
                   (lang === 'th' ? '‡∏ã‡πà‡∏≠‡∏°' : 'Maintenance')}
                </Badge>
              </div>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-500">{lang === 'th' ? '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : 'License'}</span>
                  <span className="font-medium">{truck.licensePlate}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">{lang === 'th' ? '‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å' : 'Capacity'}</span>
                  <span className="font-medium">{truck.capacity}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-500">{lang === 'th' ? '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Driver'}</span>
                  <span className="font-medium">{truck.driver || '-'}</span>
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}

      {/* ========== ALLOWANCES TAB ========== */}
      {activeTab === 'allowances' && (
        <div className="space-y-6">
          {/* Policy Summary */}
          <Card className="p-4 bg-blue-50 border-blue-200">
            <h4 className="font-bold text-blue-800 mb-2">üìã {lang === 'th' ? '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á' : 'Allowance Policy'}</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-blue-700">
              <div><span className="font-medium">Base:</span> 100% furthest destination</div>
              <div><span className="font-medium">Additional:</span> +50% per extra stop</div>
              <div><span className="font-medium">Late (7PM+):</span> +‡∏ø50</div>
              <div><span className="font-medium">Holiday:</span> +‡∏ø50</div>
              <div className="col-span-2"><span className="font-medium">Monthly Bonus:</span> 45+ trips = ‡∏ø500</div>
            </div>
          </Card>

          {/* Month Selector */}
          <Card className="p-4">
            <div className="flex items-center justify-between">
              <h3 className="font-bold">{lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Monthly Allowance Summary'}</h3>
              <div className="flex gap-2">
                <select 
                  value={selectedMonth} 
                  onChange={(e) => setSelectedMonth(parseInt(e.target.value))}
                  className="px-3 py-2 border rounded-lg"
                >
                  {monthNames.map((name, idx) => (
                    <option key={idx} value={idx}>{name}</option>
                  ))}
                </select>
                <select 
                  value={selectedYear} 
                  onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                  className="px-3 py-2 border rounded-lg"
                >
                  <option value={2025}>2025</option>
                  <option value={2026}>2026</option>
                </select>
              </div>
            </div>
          </Card>

          {/* Driver Allowance Table */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-gradient-to-r from-green-50 to-emerald-50">
              <h3 className="font-bold text-green-800">
                {lang === 'th' ? '‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Driver Allowances'} - {monthNames[selectedMonth]} {selectedYear}
              </h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Driver'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß' : 'Trips'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á' : 'Base'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°' : 'Additional'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏•‡∏±‡∏á 7PM' : 'Late'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î' : 'Holiday'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÇ‡∏ö‡∏ô‡∏±‡∏™ 45+' : '45+ Bonus'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600 bg-green-100">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {drivers.map(driver => {
                    const calc = calculateDriverMonthlyAllowance(driver.id, selectedMonth, selectedYear)
                    return (
                      <tr key={driver.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3">
                          <div className="font-medium">{driver.name}</div>
                          <div className="text-xs text-gray-400">{driver.employeeId}</div>
                        </td>
                        <td className="px-4 py-3 text-center">
                          <span className={`font-bold ${calc.trips >= 45 ? 'text-green-600' : ''}`}>
                            {calc.trips}
                          </span>
                          {calc.trips >= 45 && <span className="ml-1 text-green-500">üéâ</span>}
                        </td>
                        <td className="px-4 py-3 text-right">{formatCurrency(calc.baseAllowance)}</td>
                        <td className="px-4 py-3 text-right text-blue-600">{formatCurrency(calc.additionalAllowance)}</td>
                        <td className="px-4 py-3 text-right text-orange-600">{calc.lateBonus > 0 ? formatCurrency(calc.lateBonus) : '-'}</td>
                        <td className="px-4 py-3 text-right text-purple-600">{calc.holidayBonus > 0 ? formatCurrency(calc.holidayBonus) : '-'}</td>
                        <td className="px-4 py-3 text-right text-green-600">{calc.tripBonus > 0 ? formatCurrency(calc.tripBonus) : '-'}</td>
                        <td className="px-4 py-3 text-right font-bold text-lg text-green-700 bg-green-50">
                          {formatCurrency(calc.totalAllowance)}
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
                <tfoot className="bg-gray-100">
                  <tr>
                    <td className="px-4 py-3 font-bold" colSpan="7">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Grand Total'}</td>
                    <td className="px-4 py-3 text-right font-bold text-xl text-green-700 bg-green-100">
                      {formatCurrency(drivers.reduce((sum, d) => sum + calculateDriverMonthlyAllowance(d.id, selectedMonth, selectedYear).totalAllowance, 0))}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </Card>

          {/* Destination Rate Reference */}
          <Card className="p-4">
            <h4 className="font-bold mb-3">{lang === 'th' ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢' : 'Destination Rates'}</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {Object.entries(DESTINATION_RATES).map(([dest, rate]) => (
                <div key={dest} className="flex justify-between p-2 bg-gray-50 rounded">
                  <span className="capitalize">{dest.replace('_', ' ')}</span>
                  <span className="font-bold">‡∏ø{rate}</span>
                </div>
              ))}
            </div>
          </Card>
        </div>
      )}

      {/* Routes Tab - Placeholder for GPS */}
      {activeTab === 'routes' && (
        <Card className="p-12 text-center">
          <div className="w-20 h-20 mx-auto mb-4 rounded-full bg-cyan-100 flex items-center justify-center">
            <Navigation className="w-10 h-10 text-cyan-600" />
          </div>
          <h3 className="text-xl font-bold text-gray-800 mb-2">
            {lang === 'th' ? '‡∏£‡∏∞‡∏ö‡∏ö GPS ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤' : 'GPS System Coming Soon'}
          </h3>
          <p className="text-gray-500 max-w-md mx-auto">
            {lang === 'th' 
              ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° GPS ‡πÅ‡∏ö‡∏ö Real-time ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ ‡∏à‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ' 
              : 'Real-time GPS tracking is under development. You will be able to track vehicles and routes.'}
          </p>
          <div className="mt-6 flex items-center justify-center gap-2 text-sm text-gray-400">
            <Cog className="w-4 h-4 animate-spin" />
            <span>Under Development</span>
          </div>
        </Card>
      )}
    </div>
  )
}

// ============================================
// ============================================
// MAINTENANCE MODULE - ENHANCED v7.5
// Types: Equipment, Vehicle, Building/Facility
// Features: Add Equipment, Request Form, Store, MWO
// MWO Format: MWO-YYMMDD-XXX
// ============================================
const MaintenanceModule = ({ tasks, setTasks, equipment, setEquipment, maintenanceStore, setMaintenanceStore, employees, lang }) => {
  const [activeTab, setActiveTab] = useState('dashboard')
  const [showMWOModal, setShowMWOModal] = useState(false)
  const [showAddEquipmentModal, setShowAddEquipmentModal] = useState(false)
  const [showRequestModal, setShowRequestModal] = useState(false)
  const [filterStatus, setFilterStatus] = useState('all')
  const [filterCategory, setFilterCategory] = useState('all')
  
  // MWO Detail Modal states
  const [showMWODetailModal, setShowMWODetailModal] = useState(false)
  const [selectedMWO, setSelectedMWO] = useState(null)
  const [mwoDetailTab, setMwoDetailTab] = useState('info') // 'info', 'worklog', 'parts', 'cost'
  const [newWorkLog, setNewWorkLog] = useState({ technicianId: '', hours: '', description: '' })
  
  // Scan & Issue states
  const [showScanIssueModal, setShowScanIssueModal] = useState(false)
  const [scanQuery, setScanQuery] = useState('')
  const [scannedItem, setScannedItem] = useState(null)
  const [issueQty, setIssueQty] = useState(1)
  const [issueMWO, setIssueMWO] = useState('')
  const [issueNotes, setIssueNotes] = useState('')
  const [issueHistory, setIssueHistory] = useState([
    // Demo issue records
    { id: 'ISS-001', itemId: 'MS-001', itemName: 'Motor Oil 15W-40', sku: 'LUB-OIL-15W40', qty: 4, unit: 'L', mwoNumber: 'MWO-2601-001', issuedBy: 'Boonlert J.', issuedAt: '2026-01-28T09:30:00', notes: 'For CNC Router #1 scheduled maintenance' },
    { id: 'ISS-002', itemId: 'MS-006', itemName: 'Bearing 6205 2RS', sku: 'BRG-6205', qty: 2, unit: 'pcs', mwoNumber: 'MWO-2601-002', issuedBy: 'Somchai Y.', issuedAt: '2026-01-28T14:15:00', notes: 'Replacement for Band Saw #3' },
    { id: 'ISS-003', itemId: 'MS-012', itemName: 'Cutting Disc 4"', sku: 'CON-DISC-CUT', qty: 5, unit: 'pcs', mwoNumber: null, issuedBy: 'Prasert T.', issuedAt: '2026-01-29T08:00:00', notes: 'General stock for production floor' },
    { id: 'ISS-004', itemId: 'MS-021', itemName: 'Electrical Wire 2.5mm¬≤', sku: 'ELC-WIRE-25', qty: 20, unit: 'm', mwoNumber: 'MWO-2601-003', issuedBy: 'Boonlert J.', issuedAt: '2026-01-30T10:45:00', notes: 'Rewiring control panel section B' },
    { id: 'ISS-005', itemId: 'MS-003', itemName: 'Multi-Purpose Grease', sku: 'LUB-GREASE', qty: 2, unit: 'kg', mwoNumber: null, issuedBy: 'Vichai K.', issuedAt: '2026-01-31T16:20:00', notes: 'For truck fleet maintenance' },
  ])
  const [storeViewMode, setStoreViewMode] = useState('inventory') // 'inventory' or 'history'
  
  // Get maintenance staff from employees
  const maintenanceStaff = (employees || []).filter(e => e.department === 'maintenance' && e.status === 'active')

  // New equipment form state
  const [newEquipment, setNewEquipment] = useState({
    name: '', type: 'machine', category: 'equipment', location: '', 
    brand: '', model: '', serialNo: '', serviceInterval: 90, notes: ''
  })

  // New request form state
  const [newRequest, setNewRequest] = useState({
    department: '', requestedBy: '', category: 'equipment', 
    subject: '', description: '', priority: 'medium'
  })

  const tabs = [
    { id: 'dashboard', label: lang === 'th' ? '‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å' : 'Dashboard', icon: Home },
    { id: 'requests', label: lang === 'th' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°' : 'Requests', icon: Bell },
    { id: 'mwo', label: lang === 'th' ? '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô' : 'Work Orders', icon: ClipboardList },
    { id: 'equipment', label: lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£' : 'Equipment', icon: Cog },
    { id: 'building', label: lang === 'th' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' : 'Building', icon: Building2 },
    { id: 'store', label: lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Parts Store', icon: Package },
    { id: 'pm', label: lang === 'th' ? 'PM Schedule' : 'PM Schedule', icon: Calendar },
  ]

  // Maintenance Categories
  const MAINT_CATEGORIES = {
    equipment: { label: lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£' : 'Equipment', color: 'blue' },
    vehicle: { label: lang === 'th' ? '‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞' : 'Vehicle', color: 'green' },
    building: { label: lang === 'th' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' : 'Building', color: 'purple' },
    electrical: { label: lang === 'th' ? '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤' : 'Electrical', color: 'yellow' },
    plumbing: { label: lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : 'Plumbing', color: 'cyan' },
    hvac: { label: lang === 'th' ? '‡πÅ‡∏≠‡∏£‡πå/‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®' : 'HVAC/AC', color: 'sky' },
    safety: { label: lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢' : 'Safety', color: 'red' },
    other: { label: lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other', color: 'gray' },
  }

  // Equipment Types
  const EQUIPMENT_TYPES = [
    { id: 'machine', label: lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£' : 'Machine' },
    { id: 'forklift', label: lang === 'th' ? '‡∏£‡∏ñ‡∏¢‡∏Å' : 'Forklift' },
    { id: 'oven', label: lang === 'th' ? '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö' : 'Oven/Kiln' },
    { id: 'compressor', label: lang === 'th' ? '‡∏õ‡∏±‡πä‡∏°‡∏•‡∏°' : 'Compressor' },
    { id: 'saw', label: lang === 'th' ? '‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏¢' : 'Saw' },
    { id: 'tool', label: lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠' : 'Tool' },
  ]

  // Building Work Types
  const BUILDING_WORK_TYPES = [
    { id: 'painting', label: lang === 'th' ? '‡∏ó‡∏≤‡∏™‡∏µ' : 'Painting', icon: 'üé®' },
    { id: 'repair', label: lang === 'th' ? '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°' : 'Repair', icon: 'üîß' },
    { id: 'electrical', label: lang === 'th' ? '‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤' : 'Electrical', icon: '‚ö°' },
    { id: 'plumbing', label: lang === 'th' ? '‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : 'Plumbing', icon: 'üöø' },
    { id: 'carpentry', label: lang === 'th' ? '‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πâ' : 'Carpentry', icon: 'ü™ö' },
  ]

  // Departments that can request maintenance
  const DEPARTMENTS = [
    { id: 'C1', label: 'C1 - Cutting 1' },
    { id: 'C2', label: 'C2 - Cutting 2' },
    { id: 'P1', label: 'P1 - Processing 1' },
    { id: 'P2', label: 'P2 - Processing 2' },
    { id: 'ASM1', label: 'ASM1 - Assembly 1' },
    { id: 'ASM2', label: 'ASM2 - Assembly 2' },
    { id: 'OVN', label: 'OVN - Oven/HT' },
    { id: 'QC', label: 'QC - Quality Control' },
    { id: 'warehouse', label: lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Warehouse' },
    { id: 'office', label: lang === 'th' ? '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Office' },
    { id: 'housing', label: lang === 'th' ? '‡∏´‡∏≠‡∏û‡∏±‡∏Å' : 'Staff Housing' },
  ]

  // Sample equipment data
  const equipmentList = equipment || [
    { id: 'EQ-001', name: 'Forklift 1', type: 'forklift', category: 'equipment', location: 'Warehouse', status: 'operational', brand: 'Toyota', lastService: '2026-01-15', nextService: '2026-04-15' },
    { id: 'EQ-002', name: 'Forklift 2', type: 'forklift', category: 'equipment', location: 'Production', status: 'operational', brand: 'Toyota', lastService: '2026-01-10', nextService: '2026-04-10' },
    { id: 'EQ-003', name: 'Table Saw 1', type: 'saw', category: 'equipment', location: 'C1', status: 'operational', brand: 'Makita', lastService: '2025-12-20', nextService: '2026-03-20' },
    { id: 'EQ-004', name: 'Table Saw 2', type: 'saw', category: 'equipment', location: 'C2', status: 'operational', brand: 'Makita', lastService: '2025-12-20', nextService: '2026-03-20' },
    { id: 'EQ-005', name: 'Heat Treatment Oven', type: 'oven', category: 'equipment', location: 'OVN', status: 'operational', brand: 'Custom', lastService: '2026-01-05', nextService: '2026-07-05' },
    { id: 'EQ-006', name: 'Air Compressor', type: 'compressor', category: 'equipment', location: 'Production', status: 'maintenance', brand: 'Atlas Copco', lastService: '2025-11-15', nextService: '2026-02-15' },
    { id: 'BLD-001', name: 'Production Building', type: 'building', category: 'building', location: 'Main', status: 'operational', lastPaint: '2024-06-01' },
    { id: 'BLD-002', name: 'Office Building', type: 'building', category: 'building', location: 'Front', status: 'operational', lastPaint: '2024-03-01' },
    { id: 'BLD-003', name: 'Staff Housing Block A', type: 'building', category: 'building', location: 'Housing', status: 'operational' },
  ]

  // Sample maintenance requests
  const [requests, setRequests] = useState([
    { id: 'REQ-001', date: '2026-02-01', department: 'C1', requestedBy: 'Singh', category: 'equipment', subject: 'Table Saw blade replacement', description: 'Blade is dull, need replacement', priority: 'high', status: 'pending' },
    { id: 'REQ-002', date: '2026-01-31', department: 'office', requestedBy: 'Noon', category: 'building', subject: 'AC not cooling', description: 'Office AC unit not cooling properly', priority: 'medium', status: 'pending' },
    { id: 'REQ-003', date: '2026-01-30', department: 'housing', requestedBy: 'Worker', category: 'plumbing', subject: 'Toilet leak Room 5', description: 'Water leaking from toilet', priority: 'high', status: 'in_progress' },
  ])

  // Maintenance store items (STORE5)
  const storeItems = maintenanceStore || []

  // MWO list (tasks)
  const tasksList = tasks || []

  // Generate MWO Number
  const generateMWONumber = () => {
    const now = new Date()
    const dateStr = `${now.getFullYear().toString().slice(-2)}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}`
    const seq = (tasksList.length + 1).toString().padStart(3, '0')
    return `MWO-${dateStr}-${seq}`
  }

  // Stats
  const stats = {
    totalMWO: tasksList.length,
    open: tasksList.filter(t => t.status === 'open').length,
    inProgress: tasksList.filter(t => t.status === 'in_progress').length,
    completed: tasksList.filter(t => t.status === 'completed').length,
    pendingRequests: requests.filter(r => r.status === 'pending').length,
    equipmentCount: equipmentList.filter(e => e.category === 'equipment').length,
    buildingCount: equipmentList.filter(e => e.category === 'building').length,
    needsService: equipmentList.filter(e => e.nextService && new Date(e.nextService) <= new Date(Date.now() + 30*24*60*60*1000)).length,
    lowStock: storeItems.filter(i => i.qty <= i.minQty).length,
    storeValue: storeItems.reduce((sum, i) => sum + (i.qty * (i.unitCost || 0)), 0),
  }

  // Scan/Search for item in store
  const handleScanLookup = (query) => {
    if (!query.trim()) { setScannedItem(null); return }
    const q = query.toLowerCase().trim()
    const found = storeItems.find(item => 
      item.id?.toLowerCase() === q || 
      item.sku?.toLowerCase() === q || 
      item.name?.toLowerCase().includes(q)
    )
    setScannedItem(found || null)
    if (found) setIssueQty(1)
  }

  // Issue item from store
  const handleIssueItem = () => {
    if (!scannedItem || issueQty <= 0 || issueQty > scannedItem.qty) return
    
    // Create issue record
    const issueRecord = {
      id: `ISS-${Date.now()}`,
      itemId: scannedItem.id,
      itemName: scannedItem.name,
      sku: scannedItem.sku,
      qty: issueQty,
      unit: scannedItem.unit,
      mwoNumber: issueMWO || null,
      issuedBy: 'Current User', // Would come from auth
      issuedAt: new Date().toISOString(),
      notes: issueNotes,
    }
    setIssueHistory([issueRecord, ...issueHistory])
    
    // Update store inventory
    if (setMaintenanceStore) {
      setMaintenanceStore(storeItems.map(item => 
        item.id === scannedItem.id 
          ? { ...item, qty: item.qty - issueQty, lastIssued: new Date().toISOString() }
          : item
      ))
    }
    
    // Reset form
    setScanQuery('')
    setScannedItem(null)
    setIssueQty(1)
    setIssueMWO('')
    setIssueNotes('')
    setShowScanIssueModal(false)
  }

  // Open MWO Detail Modal
  const openMWODetail = (mwo) => {
    setSelectedMWO(mwo)
    setMwoDetailTab('info')
    setShowMWODetailModal(true)
  }

  // Add Work Log Entry
  const handleAddWorkLog = () => {
    if (!selectedMWO || !newWorkLog.technicianId || !newWorkLog.hours) return
    
    const tech = maintenanceStaff.find(s => s.id === parseInt(newWorkLog.technicianId))
    const hours = parseFloat(newWorkLog.hours)
    const laborCost = hours * (tech?.hourlyRate || 100)
    
    const logEntry = {
      id: `WL-${Date.now()}`,
      date: new Date().toISOString().split('T')[0],
      technicianId: parseInt(newWorkLog.technicianId),
      hours: hours,
      description: newWorkLog.description,
      laborCost: laborCost,
    }
    
    // Update MWO with new work log
    const updatedMWO = {
      ...selectedMWO,
      workLogs: [...(selectedMWO.workLogs || []), logEntry],
      laborHours: (selectedMWO.laborHours || 0) + hours,
      laborCost: (selectedMWO.laborCost || 0) + laborCost,
      totalCost: (selectedMWO.partsCost || 0) + (selectedMWO.laborCost || 0) + laborCost,
    }
    
    if (setTasks) {
      setTasks(tasksList.map(t => t.id === selectedMWO.id ? updatedMWO : t))
    }
    setSelectedMWO(updatedMWO)
    setNewWorkLog({ technicianId: '', hours: '', description: '' })
  }

  // Calculate equipment cost statistics
  const getEquipmentCostStats = () => {
    const eqList = equipment || []
    return eqList.map(eq => {
      const eqMWOs = tasksList.filter(t => t.equipmentId === eq.id)
      const totalLaborCost = eqMWOs.reduce((sum, m) => sum + (m.laborCost || 0), 0)
      const totalPartsCost = eqMWOs.reduce((sum, m) => sum + (m.partsCost || 0), 0)
      const totalCost = eq.totalMaintenanceCost || (totalLaborCost + totalPartsCost)
      const mwoCount = eq.maintenanceCount || eqMWOs.length
      const costPerMonth = eq.purchaseDate ? totalCost / Math.max(1, Math.ceil((new Date() - new Date(eq.purchaseDate)) / (1000 * 60 * 60 * 24 * 30))) : 0
      
      return {
        ...eq,
        totalLaborCost,
        totalPartsCost,
        totalCost,
        mwoCount,
        costPerMonth: Math.round(costPerMonth),
        costEfficiency: eq.purchaseCost ? ((totalCost / eq.purchaseCost) * 100).toFixed(1) : 0,
      }
    }).sort((a, b) => b.totalCost - a.totalCost)
  }

  // Convert request to MWO
  const convertRequestToMWO = (request) => {
    const newMWO = {
      id: Date.now(),
      mwoNumber: generateMWONumber(),
      requestId: request.id,
      category: request.category,
      equipment: request.subject,
      description: request.description,
      priority: request.priority,
      status: 'open',
      requestedBy: request.requestedBy,
      department: request.department,
      createdAt: new Date().toISOString(),
    }
    if (setTasks) setTasks([...tasksList, newMWO])
    setRequests(requests.map(r => r.id === request.id ? { ...r, status: 'converted', mwoNumber: newMWO.mwoNumber } : r))
  }

  // Submit maintenance request
  const handleSubmitRequest = () => {
    const newReq = {
      id: `REQ-${(requests.length + 1).toString().padStart(3, '0')}`,
      ...newRequest,
      date: new Date().toISOString().split('T')[0],
      status: 'pending',
    }
    setRequests([newReq, ...requests])
    setNewRequest({ department: '', requestedBy: '', category: 'equipment', subject: '', description: '', priority: 'medium' })
    setShowRequestModal(false)
  }

  // Add equipment
  const handleAddEquipment = () => {
    const newEq = {
      id: newEquipment.category === 'building' 
        ? `BLD-${(equipmentList.filter(e => e.category === 'building').length + 1).toString().padStart(3, '0')}`
        : `EQ-${(equipmentList.filter(e => e.category === 'equipment').length + 1).toString().padStart(3, '0')}`,
      ...newEquipment,
      status: 'operational',
    }
    if (setEquipment) setEquipment([...equipmentList, newEq])
    setNewEquipment({ name: '', type: 'machine', category: 'equipment', location: '', brand: '', model: '', serialNo: '', serviceInterval: 90, notes: '' })
    setShowAddEquipmentModal(false)
  }

  const priorityColors = { low: 'bg-gray-100 text-gray-700', medium: 'bg-yellow-100 text-yellow-700', high: 'bg-orange-100 text-orange-700', critical: 'bg-red-100 text-red-700' }
  const statusColors = { pending: 'bg-yellow-100 text-yellow-700', open: 'bg-blue-100 text-blue-700', in_progress: 'bg-purple-100 text-purple-700', completed: 'bg-green-100 text-green-700', converted: 'bg-gray-100 text-gray-700' }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.maintenance', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Manage equipment, building & parts maintenance'}</p>
        </div>
        <div className="flex gap-2 flex-wrap">
          <Button variant="outline" icon={Bell} onClick={() => setShowRequestModal(true)}>
            {lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' : 'Request'}
            {stats.pendingRequests > 0 && <span className="ml-1 px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{stats.pendingRequests}</span>}
          </Button>
          <Button variant="outline" icon={Cog} onClick={() => setShowAddEquipmentModal(true)}>
            {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' : 'Add Equipment'}
          </Button>
          <Button icon={Plus} onClick={() => setShowMWOModal(true)}>
            {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô' : 'New MWO'}
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-10 gap-3">
        <Card className="p-3 border-l-4 border-l-orange-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠' : 'Pending'}</div>
          <div className="text-xl font-bold text-orange-600">{stats.pendingRequests}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-blue-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏á‡∏≤‡∏ô' : 'MWO'}</div>
          <div className="text-xl font-bold text-blue-600">{stats.totalMWO}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-yellow-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏ó‡∏≥' : 'Open'}</div>
          <div className="text-xl font-bold text-yellow-600">{stats.open}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-purple-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' : 'In Prog'}</div>
          <div className="text-xl font-bold text-purple-600">{stats.inProgress}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-green-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à' : 'Done'}</div>
          <div className="text-xl font-bold text-green-600">{stats.completed}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-cyan-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£' : 'Equipment'}</div>
          <div className="text-xl font-bold text-cyan-600">{stats.equipmentCount}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-indigo-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' : 'Building'}</div>
          <div className="text-xl font-bold text-indigo-600">{stats.buildingCount}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-red-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏ñ‡∏∂‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Due PM'}</div>
          <div className="text-xl font-bold text-red-600">{stats.needsService}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-pink-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : 'Low Stock'}</div>
          <div className="text-xl font-bold text-pink-600">{stats.lowStock}</div>
        </Card>
        <Card className="p-3 border-l-4 border-l-emerald-500">
          <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å' : 'Stock Value'}</div>
          <div className="text-lg font-bold text-emerald-600">‡∏ø{stats.storeValue.toLocaleString()}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-1 border-b overflow-x-auto">
        {tabs.map(tab => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all whitespace-nowrap ${
              activeTab === tab.id ? 'border-[#1A5276] text-[#1A5276] bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}>
            <tab.icon className="w-4 h-4" />
            {tab.label}
            {tab.id === 'requests' && stats.pendingRequests > 0 && <span className="px-1.5 py-0.5 bg-red-500 text-white text-xs rounded-full">{stats.pendingRequests}</span>}
          </button>
        ))}
      </div>

      {/* Dashboard Tab */}
      {activeTab === 'dashboard' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Pending Requests */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-orange-50 flex items-center justify-between">
              <h3 className="font-bold text-orange-800 flex items-center gap-2"><Bell className="w-5 h-5" />{lang === 'th' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Pending Requests'}</h3>
              <Button size="sm" variant="outline" onClick={() => setActiveTab('requests')}>{lang === 'th' ? '‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'View All'}</Button>
            </div>
            <div className="divide-y max-h-80 overflow-y-auto">
              {requests.filter(r => r.status === 'pending').slice(0, 5).map(req => (
                <div key={req.id} className="p-4 hover:bg-gray-50">
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-sm text-orange-600">{req.id}</span>
                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${priorityColors[req.priority]}`}>{req.priority}</span>
                      </div>
                      <div className="font-medium mt-1">{req.subject}</div>
                      <div className="text-sm text-gray-500">{req.department} ‚Ä¢ {req.requestedBy}</div>
                    </div>
                    <Button size="sm" onClick={() => convertRequestToMWO(req)}><ArrowRight className="w-4 h-4 mr-1" />MWO</Button>
                  </div>
                </div>
              ))}
              {requests.filter(r => r.status === 'pending').length === 0 && (
                <div className="p-8 text-center text-gray-400"><CheckCircle className="w-12 h-12 mx-auto mb-2 text-green-300" /><p>{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á' : 'No pending requests'}</p></div>
              )}
            </div>
          </Card>

          {/* Equipment Due Service */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-red-50">
              <h3 className="font-bold text-red-800 flex items-center gap-2"><AlertTriangle className="w-5 h-5" />{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Equipment Due for Service'}</h3>
            </div>
            <div className="divide-y max-h-60 overflow-y-auto">
              {equipmentList.filter(e => e.nextService && new Date(e.nextService) <= new Date(Date.now() + 30*24*60*60*1000)).map(eq => (
                <div key={eq.id} className="p-4 hover:bg-gray-50">
                  <div className="flex justify-between items-center">
                    <div>
                      <div className="font-medium">{eq.name}</div>
                      <div className="text-sm text-gray-500">{eq.location} ‚Ä¢ {eq.type}</div>
                    </div>
                    <div className="text-right">
                      <div className={`text-sm font-medium ${new Date(eq.nextService) <= new Date() ? 'text-red-600' : 'text-orange-600'}`}>{formatDate(eq.nextService)}</div>
                      <div className="text-xs text-gray-400">{new Date(eq.nextService) <= new Date() ? 'OVERDUE' : 'Due Soon'}</div>
                    </div>
                  </div>
                </div>
              ))}
              {equipmentList.filter(e => e.nextService && new Date(e.nextService) <= new Date(Date.now() + 30*24*60*60*1000)).length === 0 && (
                <div className="p-6 text-center text-gray-400"><CheckCircle className="w-10 h-10 mx-auto mb-2 text-green-300" /><p>{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'All equipment OK'}</p></div>
              )}
            </div>
          </Card>

          {/* Low Stock Alert */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-pink-50 flex items-center justify-between">
              <h3 className="font-bold text-pink-800 flex items-center gap-2"><Package className="w-5 h-5" />{lang === 'th' ? '‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' : 'Low Stock Parts'}</h3>
              <Button size="sm" variant="outline" onClick={() => setActiveTab('store')}>{lang === 'th' ? '‡∏î‡∏π‡∏Ñ‡∏•‡∏±‡∏á' : 'View Store'}</Button>
            </div>
            <div className="divide-y max-h-60 overflow-y-auto">
              {storeItems.filter(i => i.qty <= i.minQty).map(item => (
                <div key={item.id} className="p-4 hover:bg-gray-50">
                  <div className="flex justify-between items-center">
                    <div>
                      <div className="font-medium">{item.name}</div>
                      <div className="text-xs text-gray-500">{item.category} ‚Ä¢ {item.location}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-lg font-bold text-red-600">{item.qty} {item.unit}</div>
                      <div className="text-xs text-gray-500">Min: {item.minQty}</div>
                    </div>
                  </div>
                </div>
              ))}
              {storeItems.filter(i => i.qty <= i.minQty).length === 0 && (
                <div className="p-6 text-center text-gray-400"><CheckCircle className="w-10 h-10 mx-auto mb-2 text-green-300" /><p>{lang === 'th' ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠' : 'Stock levels OK'}</p></div>
              )}
            </div>
          </Card>

          {/* Building Work Types Quick Access */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-purple-50">
              <h3 className="font-bold text-purple-800 flex items-center gap-2"><Building2 className="w-5 h-5" />{lang === 'th' ? '‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£' : 'Building Maintenance'}</h3>
            </div>
            <div className="p-4 grid grid-cols-5 gap-3">
              {BUILDING_WORK_TYPES.map(work => (
                <button key={work.id} onClick={() => { setNewRequest({...newRequest, category: 'building', subject: work.label}); setShowRequestModal(true) }}
                  className="p-3 text-center hover:bg-purple-50 rounded-lg transition-colors">
                  <div className="text-2xl mb-1">{work.icon}</div>
                  <div className="text-xs font-medium text-gray-700">{work.label}</div>
                </button>
              ))}
            </div>
          </Card>

          {/* Maintenance Team */}
          <Card className="overflow-hidden lg:col-span-2">
            <div className="p-4 border-b bg-teal-50 flex items-center justify-between">
              <h3 className="font-bold text-teal-800 flex items-center gap-2">
                <Users className="w-5 h-5" />
                {lang === 'th' ? '‡∏ó‡∏µ‡∏°‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Maintenance Team'} ({maintenanceStaff.length} {lang === 'th' ? '‡∏Ñ‡∏ô' : 'staff'})
              </h3>
              <div className="text-sm text-teal-600">
                {lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : 'Currently Active'}: {maintenanceStaff.filter(s => tasksList.some(t => t.assignedTechnicians?.includes(s.id) && t.status === 'in_progress')).length}
              </div>
            </div>
            <div className="p-4">
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {maintenanceStaff.map(staff => {
                  const activeJobs = tasksList.filter(t => t.assignedTechnicians?.includes(staff.id) && t.status === 'in_progress')
                  const totalHours = tasksList.filter(t => t.assignedTechnicians?.includes(staff.id)).reduce((sum, t) => {
                    const logs = t.workLogs?.filter(l => l.technicianId === staff.id) || []
                    return sum + logs.reduce((s, l) => s + l.hours, 0)
                  }, 0)
                  
                  return (
                    <div key={staff.id} className={`p-3 rounded-lg border ${activeJobs.length > 0 ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                      <div className="flex items-center gap-3 mb-2">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold ${activeJobs.length > 0 ? 'bg-green-500' : 'bg-gray-400'}`}>
                          {staff.name.charAt(0)}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-sm truncate">{staff.name}</div>
                          <div className="text-xs text-gray-500">{staff.designation}</div>
                        </div>
                      </div>
                      <div className="flex items-center justify-between text-xs">
                        <span className="text-gray-500">‡∏ø{staff.hourlyRate}/hr</span>
                        <span className={activeJobs.length > 0 ? 'text-green-600 font-medium' : 'text-gray-400'}>
                          {activeJobs.length > 0 ? `${activeJobs.length} ${lang === 'th' ? '‡∏á‡∏≤‡∏ô' : 'jobs'}` : (lang === 'th' ? '‡∏ß‡πà‡∏≤‡∏á' : 'Available')}
                        </span>
                      </div>
                      {staff.skills && (
                        <div className="mt-2 flex flex-wrap gap-1">
                          {staff.skills.slice(0, 3).map((skill, i) => (
                            <span key={i} className="px-1.5 py-0.5 bg-white text-xs rounded text-gray-600">{skill}</span>
                          ))}
                        </div>
                      )}
                      <div className="mt-2 text-xs text-gray-500">
                        {lang === 'th' ? '‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : 'Hours logged'}: <span className="font-medium">{totalHours.toFixed(1)}</span>
                      </div>
                    </div>
                  )
                })}
                {maintenanceStaff.length === 0 && (
                  <div className="col-span-4 text-center text-gray-400 py-8">
                    <Users className="w-12 h-12 mx-auto mb-2 opacity-50" />
                    <p>{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏°‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'No maintenance staff data'}</p>
                  </div>
                )}
              </div>
            </div>
          </Card>
        </div>
      )}

      {/* Requests Tab */}
      {activeTab === 'requests' && (
        <div className="space-y-4">
          <Card className="p-4 bg-orange-50 border-orange-200">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Bell className="w-8 h-8 text-orange-600" />
                <div>
                  <h3 className="font-bold text-orange-800">{lang === 'th' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πà‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏∑‡πà‡∏ô' : 'Maintenance Requests'}</h3>
                  <p className="text-sm text-orange-600">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà' : 'Departments can submit repair requests here'}</p>
                </div>
              </div>
              <Button icon={Plus} onClick={() => setShowRequestModal(true)}>{lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà' : 'New Request'}</Button>
            </div>
          </Card>
          <Card className="overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'Request #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å' : 'Department'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á' : 'Subject'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : 'Priority'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {requests.map(req => (
                  <tr key={req.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 font-mono text-orange-600">{req.id}</td>
                    <td className="px-4 py-3 text-sm">{formatDate(req.date)}</td>
                    <td className="px-4 py-3">{req.department}</td>
                    <td className="px-4 py-3"><div className="font-medium">{req.subject}</div><div className="text-xs text-gray-500">{req.requestedBy}</div></td>
                    <td className="px-4 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-medium ${priorityColors[req.priority]}`}>{req.priority}</span></td>
                    <td className="px-4 py-3 text-center"><span className={`px-2 py-1 rounded text-xs font-medium ${statusColors[req.status]}`}>{req.status === 'converted' ? `‚Üí ${req.mwoNumber}` : req.status}</span></td>
                    <td className="px-4 py-3 text-center">{req.status === 'pending' && <Button size="sm" onClick={() => convertRequestToMWO(req)}><ArrowRight className="w-4 h-4 mr-1" />{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á MWO' : 'Create MWO'}</Button>}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </Card>
        </div>
      )}

      {/* Equipment Tab - Enhanced with Cost Analysis */}
      {activeTab === 'equipment' && (
        <div className="space-y-4">
          <div className="flex justify-between items-center">
            <h3 className="font-bold text-gray-700">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : 'Equipment Registry'}</h3>
            <Button icon={Plus} onClick={() => { setNewEquipment({...newEquipment, category: 'equipment'}); setShowAddEquipmentModal(true) }}>{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£' : 'Add Equipment'}</Button>
          </div>
          
          {/* Cost Analysis Summary */}
          <Card className="p-4 bg-gradient-to-r from-blue-50 to-emerald-50">
            <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
              <BarChart3 className="w-5 h-5" />
              {lang === 'th' ? '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤' : 'Maintenance Cost Analysis'}
            </h4>
            <div className="grid grid-cols-4 gap-4 mb-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">{(equipment || []).length}</div>
                <div className="text-xs text-gray-500">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total Equipment'}</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-emerald-600">‡∏ø{((equipment || []).reduce((sum, e) => sum + (e.totalMaintenanceCost || 0), 0)).toLocaleString()}</div>
                <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏ß‡∏°' : 'Total Maint. Cost'}</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-orange-600">{((equipment || []).reduce((sum, e) => sum + (e.maintenanceCount || 0), 0))}</div>
                <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô MWO ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total MWOs'}</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">
                  ‡∏ø{Math.round((equipment || []).reduce((sum, e) => sum + (e.totalMaintenanceCost || 0), 0) / Math.max(1, (equipment || []).length)).toLocaleString()}
                </div>
                <div className="text-xs text-gray-500">{lang === 'th' ? '‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á' : 'Avg per Equipment'}</div>
              </div>
            </div>
          </Card>

          {/* Equipment Table with Cost Data */}
          <Card className="overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á' : 'Location'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠' : 'Purchase'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Maint. Cost'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô MWO' : 'MWO Count'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠' : 'Cost Ratio'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {getEquipmentCostStats().map(eq => {
                  const costRatio = eq.purchaseCost ? ((eq.totalCost / eq.purchaseCost) * 100) : 0
                  const isHighCost = costRatio > 20
                  return (
                    <tr key={eq.id} className={`hover:bg-gray-50 ${isHighCost ? 'bg-red-50' : ''}`}>
                      <td className="px-4 py-3 font-mono text-sm text-[#1A5276]">{eq.code}</td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{eq.name}</div>
                        {eq.nameTh && <div className="text-xs text-gray-500">{eq.nameTh}</div>}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-600">{eq.location}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={eq.status === 'operational' ? 'success' : eq.status === 'under_repair' ? 'warning' : 'danger'}>
                          {eq.status === 'operational' ? (lang === 'th' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : 'OK') : eq.status === 'under_repair' ? (lang === 'th' ? '‡∏ã‡πà‡∏≠‡∏°' : 'Repair') : eq.status}
                        </Badge>
                      </td>
                      <td className="px-4 py-3 text-right text-gray-600">‡∏ø{(eq.purchaseCost || 0).toLocaleString()}</td>
                      <td className="px-4 py-3 text-right font-medium text-emerald-600">‡∏ø{(eq.totalCost || 0).toLocaleString()}</td>
                      <td className="px-4 py-3 text-center">{eq.mwoCount || 0}</td>
                      <td className="px-4 py-3 text-right">
                        <span className={`font-bold ${costRatio > 30 ? 'text-red-600' : costRatio > 20 ? 'text-orange-600' : costRatio > 10 ? 'text-yellow-600' : 'text-green-600'}`}>
                          {costRatio.toFixed(1)}%
                        </span>
                        {isHighCost && <AlertTriangle className="w-4 h-4 text-red-500 inline ml-1" />}
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </Card>
          
          {/* Cost Legend */}
          <div className="flex items-center gap-6 text-xs text-gray-500">
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-green-500"></span>{lang === 'th' ? '< 10% ‡∏î‡∏µ' : '< 10% Good'}</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-yellow-500"></span>{lang === 'th' ? '10-20% ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : '10-20% Average'}</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-orange-500"></span>{lang === 'th' ? '20-30% ‡∏™‡∏π‡∏á' : '20-30% High'}</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-red-500"></span>{lang === 'th' ? '> 30% ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : '> 30% Critical'}</div>
          </div>
        </div>
      )}

      {/* Building Tab */}
      {activeTab === 'building' && (
        <div className="space-y-4">
          <Card className="p-4 bg-purple-50 border-purple-200">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Building2 className="w-8 h-8 text-purple-600" />
                <div>
                  <h3 className="font-bold text-purple-800">{lang === 'th' ? '‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : 'Building & Facility Maintenance'}</h3>
                  <p className="text-sm text-purple-600">{lang === 'th' ? '‡∏ó‡∏≤‡∏™‡∏µ ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏° ‡∏á‡∏≤‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : 'Painting, repairs, electrical, plumbing'}</p>
                </div>
              </div>
              <Button icon={Plus} onClick={() => { setNewEquipment({...newEquipment, category: 'building', type: 'building'}); setShowAddEquipmentModal(true) }}>{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà' : 'Add Area'}</Button>
            </div>
          </Card>
          <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
            {BUILDING_WORK_TYPES.map(work => (
              <Card key={work.id} className="p-4 text-center hover:bg-purple-50 cursor-pointer transition-colors" onClick={() => { setNewRequest({...newRequest, category: 'building', subject: work.label}); setShowRequestModal(true) }}>
                <div className="text-3xl mb-2">{work.icon}</div>
                <div className="font-medium">{work.label}</div>
              </Card>
            ))}
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {equipmentList.filter(eq => eq.category === 'building').map(bld => (
              <Card key={bld.id} className="overflow-hidden">
                <div className="p-4 bg-purple-50">
                  <div className="flex items-center gap-3">
                    <Building2 className="w-8 h-8 text-purple-600" />
                    <div>
                      <div className="font-bold">{bld.name}</div>
                      <div className="text-sm text-gray-600">{bld.id}</div>
                    </div>
                  </div>
                </div>
                <div className="p-4 space-y-2 text-sm">
                  <div className="flex justify-between"><span className="text-gray-500">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á' : 'Location'}</span><span className="font-medium">{bld.location}</span></div>
                  {bld.lastPaint && <div className="flex justify-between"><span className="text-gray-500">{lang === 'th' ? '‡∏ó‡∏≤‡∏™‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Last Painted'}</span><span>{formatDate(bld.lastPaint)}</span></div>}
                </div>
                <div className="p-3 border-t bg-gray-50">
                  <Button size="sm" variant="outline" className="w-full" onClick={() => setShowRequestModal(true)}><Wrench className="w-4 h-4 mr-1" />{lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' : 'Request Repair'}</Button>
                </div>
              </Card>
            ))}
          </div>
        </div>
      )}

      {/* MWO Tab */}
      {activeTab === 'mwo' && (
        <div className="space-y-4">
          {/* Filters */}
          <Card className="p-4 flex items-center justify-between">
            <div className="flex gap-3">
              <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
                <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'All Status'}</option>
                <option value="scheduled">{lang === 'th' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Scheduled'}</option>
                <option value="in_progress">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' : 'In Progress'}</option>
                <option value="completed">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à' : 'Completed'}</option>
              </select>
            </div>
            <div className="flex items-center gap-4 text-sm">
              <span className="text-gray-500">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢' : 'Total Cost'}:</span>
              <span className="font-bold text-lg text-emerald-600">
                ‡∏ø{tasksList.reduce((sum, t) => sum + (t.totalCost || 0), 0).toLocaleString()}
              </span>
            </div>
          </Card>

          {/* MWO Cards */}
          <div className="space-y-3">
            {tasksList.filter(t => filterStatus === 'all' || t.status === filterStatus).map(mwo => {
              const assignedStaff = maintenanceStaff.filter(s => mwo.assignedTechnicians?.includes(s.id))
              const leadTech = maintenanceStaff.find(s => s.id === mwo.leadTechnician)
              
              return (
                <Card key={mwo.id} className={`overflow-hidden cursor-pointer hover:shadow-md transition-shadow ${mwo.status === 'completed' ? 'opacity-75' : ''}`} onClick={() => openMWODetail(mwo)}>
                  <div className="p-4">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <span className="font-mono text-lg font-bold text-[#1A5276]">{mwo.mwoNumber}</span>
                        <span className={`px-2 py-1 rounded text-xs font-medium ${priorityColors[mwo.priority]}`}>{mwo.priority}</span>
                        <span className={`px-2 py-1 rounded text-xs font-medium ${statusColors[mwo.status]}`}>{mwo.status}</span>
                      </div>
                      <div className="text-right">
                        <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Scheduled'}</div>
                        <div className="font-medium">{formatDate(mwo.scheduledDate)}</div>
                      </div>
                    </div>
                    
                    <div className="mb-3">
                      <div className="font-medium text-gray-800">{mwo.equipment}</div>
                      <div className="text-sm text-gray-500">{mwo.description}</div>
                    </div>

                    {/* Assigned Technicians */}
                    <div className="flex items-center justify-between border-t pt-3">
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-gray-500">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö' : 'Assigned'}:</span>
                        <div className="flex -space-x-2">
                          {assignedStaff.map(tech => (
                            <div key={tech.id} title={tech.name} className={`w-7 h-7 rounded-full flex items-center justify-center text-white text-xs font-bold border-2 border-white ${tech.id === mwo.leadTechnician ? 'bg-[#1A5276]' : 'bg-gray-400'}`}>
                              {tech.name.charAt(0)}
                            </div>
                          ))}
                        </div>
                        {leadTech && <span className="text-xs text-gray-600 ml-2">{leadTech.name} {lang === 'th' ? '(‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤)' : '(Lead)'}</span>}
                      </div>
                      
                      {/* Cost Summary */}
                      <div className="flex items-center gap-4 text-xs">
                        <div className="flex items-center gap-1">
                          <Clock className="w-3 h-3 text-blue-500" />
                          <span>{mwo.laborHours || 0}h</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <Package className="w-3 h-3 text-orange-500" />
                          <span>{mwo.partsUsed?.length || 0} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'parts'}</span>
                        </div>
                        <div className="font-bold text-emerald-600">
                          ‡∏ø{(mwo.totalCost || 0).toLocaleString()}
                        </div>
                      </div>
                    </div>

                    {/* Work Log Preview */}
                    {mwo.workLogs && mwo.workLogs.length > 0 && (
                      <div className="mt-3 pt-3 border-t">
                        <div className="text-xs text-gray-500 mb-2">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Latest Log'}:</div>
                        <div className="text-sm bg-gray-50 rounded p-2">
                          <div className="flex items-center justify-between">
                            <span className="text-gray-600">{maintenanceStaff.find(s => s.id === mwo.workLogs[mwo.workLogs.length - 1].technicianId)?.name || 'Unknown'}</span>
                            <span className="text-xs text-gray-400">{mwo.workLogs[mwo.workLogs.length - 1].hours}h ‚Ä¢ {mwo.workLogs[mwo.workLogs.length - 1].date}</span>
                          </div>
                          <div className="text-gray-500 text-xs mt-1 truncate">{mwo.workLogs[mwo.workLogs.length - 1].description}</div>
                        </div>
                      </div>
                    )}
                  </div>
                </Card>
              )
            })}
            
            {tasksList.filter(t => filterStatus === 'all' || t.status === filterStatus).length === 0 && (
              <Card className="p-12 text-center text-gray-400">
                <ClipboardList className="w-12 h-12 mx-auto mb-4 opacity-50" />
                <p className="font-medium">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô' : 'No work orders'}</p>
              </Card>
            )}
          </div>
        </div>
      )}

      {/* MWO Detail Modal */}
      {showMWODetailModal && selectedMWO && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={() => setShowMWODetailModal(false)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div className="px-6 py-4 bg-gradient-to-r from-[#1A5276] to-[#2ECC40] flex items-center justify-between">
              <div className="flex items-center gap-4">
                <span className="font-mono text-xl font-bold text-white">{selectedMWO.mwoNumber}</span>
                <span className={`px-2 py-1 rounded text-xs font-medium bg-white/20 text-white`}>{selectedMWO.status}</span>
              </div>
              <button onClick={() => setShowMWODetailModal(false)} className="text-white/80 hover:text-white"><X className="w-6 h-6" /></button>
            </div>
            
            {/* Tabs */}
            <div className="border-b px-6 flex gap-1">
              {[
                { id: 'info', label: lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : 'Info', icon: Info },
                { id: 'worklog', label: lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô' : 'Work Log', icon: ClipboardList },
                { id: 'parts', label: lang === 'th' ? '‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Parts Used', icon: Package },
                { id: 'cost', label: lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢' : 'Cost Summary', icon: DollarSign },
              ].map(tab => (
                <button key={tab.id} onClick={() => setMwoDetailTab(tab.id)}
                  className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${mwoDetailTab === tab.id ? 'border-[#1A5276] text-[#1A5276]' : 'border-transparent text-gray-500'}`}>
                  <tab.icon className="w-4 h-4" />{tab.label}
                </button>
              ))}
            </div>
            
            {/* Content */}
            <div className="flex-1 overflow-auto p-6">
              {/* Info Tab */}
              {mwoDetailTab === 'info' && (
                <div className="space-y-6">
                  <div className="grid grid-cols-2 gap-6">
                    <div>
                      <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : 'Equipment'}</label>
                      <div className="font-medium text-lg">{selectedMWO.equipment}</div>
                    </div>
                    <div>
                      <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</label>
                      <div className="font-medium capitalize">{selectedMWO.type}</div>
                    </div>
                    <div>
                      <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Scheduled'}</label>
                      <div className="font-medium">{formatDate(selectedMWO.scheduledDate)}</div>
                    </div>
                    <div>
                      <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : 'Priority'}</label>
                      <span className={`px-2 py-1 rounded text-xs font-medium ${priorityColors[selectedMWO.priority]}`}>{selectedMWO.priority}</span>
                    </div>
                  </div>
                  <div>
                    <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'Description'}</label>
                    <div className="mt-1 p-3 bg-gray-50 rounded-lg">{selectedMWO.description}</div>
                  </div>
                  <div>
                    <label className="text-sm text-gray-500 mb-2 block">{lang === 'th' ? '‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö' : 'Assigned Team'}</label>
                    <div className="flex flex-wrap gap-2">
                      {maintenanceStaff.filter(s => selectedMWO.assignedTechnicians?.includes(s.id)).map(tech => (
                        <div key={tech.id} className={`flex items-center gap-2 px-3 py-2 rounded-lg ${tech.id === selectedMWO.leadTechnician ? 'bg-[#1A5276] text-white' : 'bg-gray-100'}`}>
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${tech.id === selectedMWO.leadTechnician ? 'bg-white/20' : 'bg-gray-300'}`}>
                            {tech.name.charAt(0)}
                          </div>
                          <div>
                            <div className="font-medium text-sm">{tech.name}</div>
                            <div className="text-xs opacity-75">{tech.designation} ‚Ä¢ ‡∏ø{tech.hourlyRate}/hr</div>
                          </div>
                          {tech.id === selectedMWO.leadTechnician && <Badge variant="success" className="ml-2">Lead</Badge>}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Work Log Tab */}
              {mwoDetailTab === 'worklog' && (
                <div className="space-y-4">
                  {/* Add Work Log Form */}
                  <Card className="p-4 bg-blue-50 border-blue-200">
                    <h4 className="font-medium text-blue-800 mb-3">{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô' : 'Add Work Log Entry'}</h4>
                    <div className="grid grid-cols-3 gap-3">
                      <select value={newWorkLog.technicianId} onChange={e => setNewWorkLog({...newWorkLog, technicianId: e.target.value})} className="px-3 py-2 border rounded-lg">
                        <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≤‡∏á' : 'Select Technician'}</option>
                        {maintenanceStaff.filter(s => selectedMWO.assignedTechnicians?.includes(s.id)).map(tech => (
                          <option key={tech.id} value={tech.id}>{tech.name} (‡∏ø{tech.hourlyRate}/hr)</option>
                        ))}
                      </select>
                      <input type="number" step="0.5" min="0.5" placeholder={lang === 'th' ? '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á' : 'Hours'} value={newWorkLog.hours} onChange={e => setNewWorkLog({...newWorkLog, hours: e.target.value})} className="px-3 py-2 border rounded-lg" />
                      <Button onClick={handleAddWorkLog} disabled={!newWorkLog.technicianId || !newWorkLog.hours}>{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Add Entry'}</Button>
                    </div>
                    <textarea placeholder={lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥...' : 'Work description...'} value={newWorkLog.description} onChange={e => setNewWorkLog({...newWorkLog, description: e.target.value})} className="w-full mt-3 px-3 py-2 border rounded-lg" rows="2" />
                  </Card>
                  
                  {/* Work Log History */}
                  <div className="space-y-2">
                    {(selectedMWO.workLogs || []).map((log, idx) => {
                      const tech = maintenanceStaff.find(s => s.id === log.technicianId)
                      return (
                        <Card key={log.id || idx} className="p-4">
                          <div className="flex items-start justify-between">
                            <div className="flex items-center gap-3">
                              <div className="w-10 h-10 rounded-full bg-[#1A5276] flex items-center justify-center text-white font-bold">{tech?.name?.charAt(0) || '?'}</div>
                              <div>
                                <div className="font-medium">{tech?.name || 'Unknown'}</div>
                                <div className="text-sm text-gray-500">{log.date} ‚Ä¢ {log.hours} {lang === 'th' ? '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á' : 'hours'}</div>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="font-bold text-emerald-600">‡∏ø{(log.laborCost || 0).toLocaleString()}</div>
                              <div className="text-xs text-gray-400">‡∏ø{tech?.hourlyRate || 0}/hr</div>
                            </div>
                          </div>
                          {log.description && <div className="mt-2 text-sm text-gray-600 bg-gray-50 rounded p-2">{log.description}</div>}
                        </Card>
                      )
                    })}
                    {(!selectedMWO.workLogs || selectedMWO.workLogs.length === 0) && (
                      <div className="text-center text-gray-400 py-8">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô' : 'No work logs yet'}</div>
                    )}
                  </div>
                </div>
              )}
              
              {/* Parts Used Tab */}
              {mwoDetailTab === 'parts' && (
                <div className="space-y-4">
                  <Card className="overflow-hidden">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">SKU</th>
                          <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Item'}</th>
                          <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                          <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit Cost'}</th>
                          <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y">
                        {(selectedMWO.partsUsed || []).map((part, idx) => (
                          <tr key={idx} className="hover:bg-gray-50">
                            <td className="px-4 py-3 font-mono text-sm text-gray-600">{part.sku}</td>
                            <td className="px-4 py-3 font-medium">{part.itemName}</td>
                            <td className="px-4 py-3 text-right">{part.qty}</td>
                            <td className="px-4 py-3 text-right text-gray-500">‡∏ø{(part.unitCost || 0).toLocaleString()}</td>
                            <td className="px-4 py-3 text-right font-medium text-emerald-600">‡∏ø{(part.totalCost || 0).toLocaleString()}</td>
                          </tr>
                        ))}
                        {(!selectedMWO.partsUsed || selectedMWO.partsUsed.length === 0) && (
                          <tr><td colSpan="5" className="px-4 py-8 text-center text-gray-400">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ' : 'No parts used yet'}</td></tr>
                        )}
                      </tbody>
                      {selectedMWO.partsUsed && selectedMWO.partsUsed.length > 0 && (
                        <tfoot className="bg-gray-50">
                          <tr>
                            <td colSpan="4" className="px-4 py-3 text-right font-medium">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Total Parts Cost'}:</td>
                            <td className="px-4 py-3 text-right font-bold text-emerald-600">‡∏ø{(selectedMWO.partsCost || 0).toLocaleString()}</td>
                          </tr>
                        </tfoot>
                      )}
                    </table>
                  </Card>
                </div>
              )}
              
              {/* Cost Summary Tab */}
              {mwoDetailTab === 'cost' && (
                <div className="space-y-6">
                  <div className="grid grid-cols-3 gap-4">
                    <Card className="p-4 text-center bg-blue-50">
                      <Clock className="w-8 h-8 mx-auto mb-2 text-blue-500" />
                      <div className="text-2xl font-bold text-blue-600">{selectedMWO.laborHours || 0} hrs</div>
                      <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : 'Labor Hours'}</div>
                    </Card>
                    <Card className="p-4 text-center bg-orange-50">
                      <Package className="w-8 h-8 mx-auto mb-2 text-orange-500" />
                      <div className="text-2xl font-bold text-orange-600">{selectedMWO.partsUsed?.length || 0}</div>
                      <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Parts Used'}</div>
                    </Card>
                    <Card className="p-4 text-center bg-emerald-50">
                      <DollarSign className="w-8 h-8 mx-auto mb-2 text-emerald-500" />
                      <div className="text-2xl font-bold text-emerald-600">‡∏ø{(selectedMWO.totalCost || 0).toLocaleString()}</div>
                      <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°' : 'Total Cost'}</div>
                    </Card>
                  </div>
                  
                  <Card className="p-4">
                    <h4 className="font-medium mb-4">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢' : 'Cost Breakdown'}</h4>
                    <div className="space-y-3">
                      <div className="flex justify-between items-center py-2 border-b">
                        <span className="text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á' : 'Labor Cost'}</span>
                        <span className="font-medium">‡∏ø{(selectedMWO.laborCost || 0).toLocaleString()}</span>
                      </div>
                      <div className="flex justify-between items-center py-2 border-b">
                        <span className="text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Parts Cost'}</span>
                        <span className="font-medium">‡∏ø{(selectedMWO.partsCost || 0).toLocaleString()}</span>
                      </div>
                      <div className="flex justify-between items-center py-2 text-lg">
                        <span className="font-bold">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Grand Total'}</span>
                        <span className="font-bold text-emerald-600">‡∏ø{(selectedMWO.totalCost || 0).toLocaleString()}</span>
                      </div>
                    </div>
                  </Card>
                  
                  {/* Technician Breakdown */}
                  <Card className="p-4">
                    <h4 className="font-medium mb-4">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≤‡∏á' : 'Labor by Technician'}</h4>
                    <div className="space-y-2">
                      {maintenanceStaff.filter(s => selectedMWO.assignedTechnicians?.includes(s.id)).map(tech => {
                        const techLogs = (selectedMWO.workLogs || []).filter(l => l.technicianId === tech.id)
                        const techHours = techLogs.reduce((sum, l) => sum + l.hours, 0)
                        const techCost = techLogs.reduce((sum, l) => sum + (l.laborCost || 0), 0)
                        return (
                          <div key={tech.id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <div className="flex items-center gap-2">
                              <div className="w-8 h-8 rounded-full bg-[#1A5276] flex items-center justify-center text-white text-sm font-bold">{tech.name.charAt(0)}</div>
                              <span>{tech.name}</span>
                            </div>
                            <div className="text-right">
                              <span className="text-gray-500 mr-4">{techHours}h √ó ‡∏ø{tech.hourlyRate}</span>
                              <span className="font-medium">‡∏ø{techCost.toLocaleString()}</span>
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  </Card>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Store Tab */}
      {activeTab === 'store' && (
        <div className="space-y-4">
          {/* Store View Toggle */}
          <div className="flex items-center gap-2 bg-gray-100 p-1 rounded-lg w-fit">
            <button
              onClick={() => setStoreViewMode('inventory')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${storeViewMode === 'inventory' ? 'bg-white shadow text-emerald-700' : 'text-gray-600 hover:text-gray-800'}`}
            >
              <Package className="w-4 h-4 inline mr-2" />
              {lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Inventory'}
            </button>
            <button
              onClick={() => setStoreViewMode('history')}
              className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 ${storeViewMode === 'history' ? 'bg-white shadow text-blue-700' : 'text-gray-600 hover:text-gray-800'}`}
            >
              <ClipboardList className="w-4 h-4" />
              {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å' : 'Issue History'}
              {issueHistory.length > 0 && (
                <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs">{issueHistory.length}</span>
              )}
            </button>
          </div>

          {/* Inventory View */}
          {storeViewMode === 'inventory' && (
            <Card className="overflow-hidden">
              <div className="p-4 border-b bg-emerald-50 flex items-center justify-between">
                <h3 className="font-bold text-emerald-800 flex items-center gap-2"><Package className="w-5 h-5" />{lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (STORE5)' : 'Maintenance Parts Store (STORE5)'}</h3>
                <div className="flex items-center gap-4">
                  <button
                    onClick={() => setShowScanIssueModal(true)}
                    className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium"
                  >
                    <Scan className="w-4 h-4" />
                    {lang === 'th' ? '‡∏™‡πÅ‡∏Å‡∏ô / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á' : 'Scan & Issue'}
                  </button>
                  <div className="text-right">
                    <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Value'}</div>
                    <div className="text-lg font-bold text-emerald-600">‡∏ø{stats.storeValue.toLocaleString()}</div>
                  </div>
                </div>
              </div>
              
              {/* Issue History Summary */}
              {issueHistory.length > 0 && (
                <div 
                  className="p-3 bg-blue-50 border-b flex items-center justify-between cursor-pointer hover:bg-blue-100 transition-colors"
                  onClick={() => setStoreViewMode('history')}
                >
                  <div className="flex items-center gap-2 text-blue-700">
                    <Activity className="w-4 h-4" />
                    <span className="text-sm font-medium">{lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Recent Issues'}: {issueHistory.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'items'}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-sm text-blue-600">
                      {lang === 'th' ? '‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Last'}: {issueHistory[0]?.itemName} x{issueHistory[0]?.qty}
                    </span>
                    <ChevronRight className="w-4 h-4 text-blue-400" />
                  </div>
                </div>
              )}
              
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Item'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î' : 'Category'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Qty'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥' : 'Min'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {storeItems.map(item => (
                    <tr key={item.id} className={`hover:bg-gray-50 ${item.qty <= item.minQty ? 'bg-red-50' : ''}`}>
                      <td className="px-4 py-3 font-mono text-sm">{item.id}</td>
                      <td className="px-4 py-3 font-medium">{item.name}</td>
                      <td className="px-4 py-3 text-sm">{item.category}</td>
                      <td className="px-4 py-3 text-right font-medium">{item.qty} {item.unit}</td>
                      <td className="px-4 py-3 text-right text-gray-500">{item.minQty}</td>
                      <td className="px-4 py-3 text-right font-medium">‡∏ø{(item.qty * (item.unitCost || 0)).toLocaleString()}</td>
                      <td className="px-4 py-3 text-center">{item.qty <= item.minQty ? <Badge variant="danger">{lang === 'th' ? '‡∏ï‡πà‡∏≥' : 'Low'}</Badge> : <Badge variant="success">{lang === 'th' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : 'OK'}</Badge>}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Card>
          )}

          {/* Issue History View */}
          {storeViewMode === 'history' && (
            <Card className="overflow-hidden">
              <div className="p-4 border-b bg-blue-50 flex items-center justify-between">
                <h3 className="font-bold text-blue-800 flex items-center gap-2">
                  <ClipboardList className="w-5 h-5" />
                  {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Parts Issue History'}
                </h3>
                <div className="flex items-center gap-4">
                  <button
                    onClick={() => setShowScanIssueModal(true)}
                    className="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium"
                  >
                    <Plus className="w-4 h-4" />
                    {lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà' : 'New Issue'}
                  </button>
                  <div className="text-right">
                    <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total Issues'}</div>
                    <div className="text-lg font-bold text-blue-600">{issueHistory.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'records'}</div>
                  </div>
                </div>
              </div>
              
              {/* Stats Row */}
              <div className="grid grid-cols-4 gap-4 p-4 bg-gray-50 border-b">
                <div className="text-center">
                  <div className="text-2xl font-bold text-blue-600">{issueHistory.length}</div>
                  <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å' : 'Total Issues'}</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-emerald-600">{issueHistory.reduce((sum, i) => sum + i.qty, 0)}</div>
                  <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°' : 'Total Qty'}</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-purple-600">
                    {issueHistory.filter(i => i.mwoNumber).length}
                  </div>
                  <div className="text-xs text-gray-500">{lang === 'th' ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö MWO' : 'Linked to MWO'}</div>
                </div>
                <div className="text-center">
                  <div className="text-2xl font-bold text-orange-600">
                    ‡∏ø{issueHistory.reduce((sum, i) => {
                      const item = storeItems.find(s => s.id === i.itemId)
                      return sum + (i.qty * (item?.unitCost || 0))
                    }, 0).toLocaleString()}
                  </div>
                  <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Value'}</div>
                </div>
              </div>
              
              {issueHistory.length === 0 ? (
                <div className="p-12 text-center text-gray-500">
                  <ClipboardList className="w-12 h-12 mx-auto mb-4 text-gray-300" />
                  <p className="font-medium">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å' : 'No issue history yet'}</p>
                  <p className="text-sm mt-1">{lang === 'th' ? '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Click "New Issue" to get started'}</p>
                </div>
              ) : (
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤' : 'Date/Time'}</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™ SKU' : 'SKU'}</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Item'}</th>
                      <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                      <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? 'MWO #' : 'MWO #'}</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å' : 'Issued By'}</th>
                      <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes'}</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {issueHistory.map((issue, idx) => {
                      const item = storeItems.find(s => s.id === issue.itemId)
                      const issueCost = issue.qty * (item?.unitCost || 0)
                      const issueDate = new Date(issue.issuedAt)
                      return (
                        <tr key={issue.id || idx} className="hover:bg-gray-50">
                          <td className="px-4 py-3">
                            <div className="text-sm font-medium">{issueDate.toLocaleDateString('en-GB')}</div>
                            <div className="text-xs text-gray-500">{issueDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</div>
                          </td>
                          <td className="px-4 py-3 font-mono text-sm text-gray-600">{issue.sku}</td>
                          <td className="px-4 py-3">
                            <div className="font-medium">{issue.itemName}</div>
                            <div className="text-xs text-gray-500">{item?.category || '-'}</div>
                          </td>
                          <td className="px-4 py-3 text-right">
                            <span className="font-bold text-blue-600">{issue.qty}</span>
                            <span className="text-gray-500 text-sm ml-1">{issue.unit}</span>
                          </td>
                          <td className="px-4 py-3 text-right font-medium text-emerald-600">‡∏ø{issueCost.toLocaleString()}</td>
                          <td className="px-4 py-3">
                            {issue.mwoNumber ? (
                              <Badge variant="purple">{issue.mwoNumber}</Badge>
                            ) : (
                              <span className="text-gray-400 text-sm">-</span>
                            )}
                          </td>
                          <td className="px-4 py-3 text-sm">{issue.issuedBy}</td>
                          <td className="px-4 py-3 text-sm text-gray-500 max-w-[150px] truncate" title={issue.notes}>
                            {issue.notes || '-'}
                          </td>
                        </tr>
                      )
                    })}
                  </tbody>
                </table>
              )}
            </Card>
          )}
        </div>
      )}

      {/* PM Schedule Tab */}
      {activeTab === 'pm' && (
        <div className="space-y-4">
          <Card className="p-4 bg-blue-50 border-blue-200">
            <h3 className="font-bold text-blue-800">{lang === 'th' ? '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô' : 'Preventive Maintenance Schedule'}</h3>
            <p className="text-sm text-blue-600">{lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤' : 'Time-based maintenance schedule'}</p>
          </Card>
          <div className="space-y-3">
            {equipmentList.filter(e => e.nextService).map(eq => (
              <Card key={eq.id} className="p-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-4">
                    <div className={`w-3 h-3 rounded-full ${new Date(eq.nextService) <= new Date() ? 'bg-red-500' : new Date(eq.nextService) <= new Date(Date.now() + 7*24*60*60*1000) ? 'bg-orange-500' : 'bg-green-500'}`} />
                    <div>
                      <div className="font-medium">{eq.name}</div>
                      <div className="text-sm text-gray-500">{eq.location} ‚Ä¢ {eq.type}</div>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className={`text-lg font-bold ${new Date(eq.nextService) <= new Date() ? 'text-red-600' : 'text-gray-700'}`}>{formatDate(eq.nextService)}</div>
                    <div className="text-xs text-gray-500">{new Date(eq.nextService) <= new Date() ? 'OVERDUE' : `${Math.ceil((new Date(eq.nextService) - new Date()) / (1000*60*60*24))} days`}</div>
                  </div>
                </div>
              </Card>
            ))}
          </div>
        </div>
      )}

      {/* Scan & Issue Modal */}
      {showScanIssueModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={() => setShowScanIssueModal(false)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div className="px-6 py-4 bg-gradient-to-r from-emerald-600 to-teal-600 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Scan className="w-6 h-6 text-white" />
                <h2 className="text-lg font-bold text-white">{lang === 'th' ? '‡∏™‡πÅ‡∏Å‡∏ô / ‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà' : 'Scan & Issue Parts'}</h2>
              </div>
              <button onClick={() => setShowScanIssueModal(false)} className="text-white/80 hover:text-white"><X className="w-5 h-5" /></button>
            </div>
            
            {/* Scan Input */}
            <div className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  {lang === 'th' ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î / ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™ SKU' : 'Scan Barcode / Search SKU'}
                </label>
                <div className="relative">
                  <Scan className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                  <input
                    type="text"
                    value={scanQuery}
                    onChange={(e) => { setScanQuery(e.target.value); handleScanLookup(e.target.value) }}
                    placeholder={lang === 'th' ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™ ‡πÄ‡∏ä‡πà‡∏ô MS-001, LUB-OIL-15W40' : 'Scan or type code e.g. MS-001, LUB-OIL-15W40'}
                    className="w-full pl-10 pr-4 py-3 border-2 border-emerald-300 rounded-xl text-lg focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200"
                    autoFocus
                  />
                </div>
              </div>

              {/* Scanned Item Display */}
              {scannedItem ? (
                <div className="p-4 bg-emerald-50 border-2 border-emerald-200 rounded-xl space-y-4">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="text-xs font-medium text-emerald-600 mb-1">{scannedItem.sku || scannedItem.id}</div>
                      <div className="text-lg font-bold text-gray-800">{scannedItem.name}</div>
                      <div className="text-sm text-gray-500">{scannedItem.nameTh}</div>
                    </div>
                    <div className="text-right">
                      <div className={`text-2xl font-bold ${scannedItem.qty <= scannedItem.minQty ? 'text-red-600' : 'text-emerald-600'}`}>
                        {scannedItem.qty}
                      </div>
                      <div className="text-xs text-gray-500">{scannedItem.unit} {lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'available'}</div>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-3 gap-2 text-sm">
                    <div className="p-2 bg-white rounded-lg">
                      <div className="text-gray-500">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î' : 'Category'}</div>
                      <div className="font-medium">{scannedItem.category}</div>
                    </div>
                    <div className="p-2 bg-white rounded-lg">
                      <div className="text-gray-500">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö' : 'Location'}</div>
                      <div className="font-medium">{scannedItem.location}</div>
                    </div>
                    <div className="p-2 bg-white rounded-lg">
                      <div className="text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit Cost'}</div>
                      <div className="font-medium">‡∏ø{scannedItem.unitCost}</div>
                    </div>
                  </div>

                  {/* Issue Form */}
                  <div className="pt-4 border-t border-emerald-200 space-y-3">
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å' : 'Issue Qty'}</label>
                        <input
                          type="number"
                          min="1"
                          max={scannedItem.qty}
                          value={issueQty}
                          onChange={(e) => setIssueQty(Math.min(parseInt(e.target.value) || 1, scannedItem.qty))}
                          className="w-full px-3 py-2 border rounded-lg text-center text-lg font-bold"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏á‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)' : 'MWO# (optional)'}</label>
                        <select
                          value={issueMWO}
                          onChange={(e) => setIssueMWO(e.target.value)}
                          className="w-full px-3 py-2 border rounded-lg"
                        >
                          <option value="">{lang === 'th' ? '-- ‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ --' : '-- General Issue --'}</option>
                          {tasksList.filter(t => t.status !== 'completed').map(t => (
                            <option key={t.id} value={t.mwoNumber}>{t.mwoNumber} - {t.equipment}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes'}</label>
                      <input
                        type="text"
                        value={issueNotes}
                        onChange={(e) => setIssueNotes(e.target.value)}
                        placeholder={lang === 'th' ? '‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£...' : 'Purpose of issue...'}
                        className="w-full px-3 py-2 border rounded-lg"
                      />
                    </div>
                  </div>
                </div>
              ) : scanQuery && (
                <div className="p-6 bg-red-50 border border-red-200 rounded-xl text-center">
                  <AlertCircle className="w-12 h-12 text-red-400 mx-auto mb-2" />
                  <div className="text-red-700 font-medium">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Item not found'}</div>
                  <div className="text-sm text-red-500">{lang === 'th' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á' : 'Please check the code'}</div>
                </div>
              )}

              {/* Quick Pick List */}
              {!scannedItem && !scanQuery && (
                <div>
                  <div className="text-sm font-medium text-gray-500 mb-2">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢' : 'Frequently Used'}</div>
                  <div className="grid grid-cols-2 gap-2">
                    {storeItems.slice(0, 6).map(item => (
                      <button
                        key={item.id}
                        onClick={() => { setScanQuery(item.id); handleScanLookup(item.id) }}
                        className="p-2 text-left bg-gray-50 hover:bg-emerald-50 rounded-lg border hover:border-emerald-300 transition-colors"
                      >
                        <div className="text-xs text-gray-500">{item.sku || item.id}</div>
                        <div className="text-sm font-medium truncate">{item.name}</div>
                        <div className="text-xs text-emerald-600">{item.qty} {item.unit}</div>
                      </button>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="px-6 py-4 bg-gray-50 flex justify-between items-center">
              <button
                onClick={() => { setScanQuery(''); setScannedItem(null) }}
                className="px-4 py-2 text-gray-600 hover:text-gray-800"
              >
                {lang === 'th' ? '‡∏•‡πâ‡∏≤‡∏á' : 'Clear'}
              </button>
              <div className="flex gap-2">
                <button
                  onClick={() => setShowScanIssueModal(false)}
                  className="px-4 py-2 border rounded-lg hover:bg-gray-100"
                >
                  {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
                </button>
                <button
                  onClick={handleIssueItem}
                  disabled={!scannedItem || issueQty <= 0}
                  className="px-6 py-2 bg-emerald-600 text-white rounded-lg font-medium hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                >
                  <Check className="w-4 h-4" />
                  {lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ç‡∏≠‡∏á' : 'Issue Item'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Add Equipment Modal */}
      {showAddEquipmentModal && (
        <Modal isOpen={showAddEquipmentModal} onClose={() => setShowAddEquipmentModal(false)} title={lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : 'Add Equipment'} size="lg">
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Category'}</label>
                <select value={newEquipment.category} onChange={(e) => setNewEquipment({...newEquipment, category: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                  <option value="equipment">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : 'Equipment/Machinery'}</option>
                  <option value="building">{lang === 'th' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : 'Building/Facility'}</option>
                </select>
              </div>
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'} *</label>
                <input type="text" value={newEquipment.name} onChange={(e) => setNewEquipment({...newEquipment, name: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô Table Saw 3' : 'e.g., Table Saw 3'} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢' : 'Type'}</label>
                <select value={newEquipment.type} onChange={(e) => setNewEquipment({...newEquipment, type: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                  {EQUIPMENT_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á' : 'Location'}</label>
                <input type="text" value={newEquipment.location} onChange={(e) => setNewEquipment({...newEquipment, location: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô C1, Warehouse' : 'e.g., C1, Warehouse'} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠' : 'Brand'}</label>
                <input type="text" value={newEquipment.brand} onChange={(e) => setNewEquipment({...newEquipment, brand: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏≠‡∏ö‡∏ö‡∏≥‡∏£‡∏∏‡∏á (‡∏ß‡∏±‡∏ô)' : 'Service Interval (days)'}</label>
                <input type="number" value={newEquipment.serviceInterval} onChange={(e) => setNewEquipment({...newEquipment, serviceInterval: parseInt(e.target.value)})} className="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>
            <div className="flex gap-4 pt-4">
              <Button variant="outline" className="flex-1" onClick={() => setShowAddEquipmentModal(false)}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
              <Button className="flex-1" onClick={handleAddEquipment} disabled={!newEquipment.name}><Plus className="w-4 h-4 mr-2" />{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : 'Add'}</Button>
            </div>
          </div>
        </Modal>
      )}

      {/* Maintenance Request Modal */}
      {showRequestModal && (
        <Modal isOpen={showRequestModal} onClose={() => setShowRequestModal(false)} title={lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° / ‡∏Ç‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Maintenance Request Form'} size="lg">
          <div className="space-y-4">
            <div className="p-3 bg-blue-50 rounded-lg">
              <p className="text-sm text-blue-700">{lang === 'th' ? '‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Use this form to request maintenance service'}</p>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á' : 'Department'} *</label>
                <select value={newRequest.department} onChange={(e) => setNewRequest({...newRequest, department: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                  <option value="">{lang === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --' : '-- Select --'}</option>
                  {DEPARTMENTS.map(d => <option key={d.id} value={d.id}>{d.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á' : 'Requested By'} *</label>
                <input type="text" value={newRequest.requestedBy} onChange={(e) => setNewRequest({...newRequest, requestedBy: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á' : 'Your name'} />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô' : 'Category'}</label>
                <select value={newRequest.category} onChange={(e) => setNewRequest({...newRequest, category: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                  {Object.entries(MAINT_CATEGORIES).map(([key, val]) => <option key={key} value={key}>{val.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' : 'Priority'}</label>
                <select value={newRequest.priority} onChange={(e) => setNewRequest({...newRequest, priority: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
                  <option value="low">{lang === 'th' ? '‡∏ï‡πà‡∏≥' : 'Low'}</option>
                  <option value="medium">{lang === 'th' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : 'Medium'}</option>
                  <option value="high">{lang === 'th' ? '‡∏™‡∏π‡∏á' : 'High'}</option>
                  <option value="critical">{lang === 'th' ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : 'Critical'}</option>
                </select>
              </div>
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á' : 'Subject'} *</label>
                <input type="text" value={newRequest.subject} onChange={(e) => setNewRequest({...newRequest, subject: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢, ‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏£‡∏±‡πà‡∏ß' : 'e.g., Machine breakdown, Pipe leak'} />
              </div>
              <div className="col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'Description'}</label>
                <textarea value={newRequest.description} onChange={(e) => setNewRequest({...newRequest, description: e.target.value})} className="w-full px-3 py-2 border rounded-lg" rows="3" placeholder={lang === 'th' ? '‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤...' : 'Describe the issue...'} />
              </div>
            </div>
            <div className="flex gap-4 pt-4">
              <Button variant="outline" className="flex-1" onClick={() => setShowRequestModal(false)}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
              <Button className="flex-1" onClick={handleSubmitRequest} disabled={!newRequest.department || !newRequest.requestedBy || !newRequest.subject}><Send className="w-4 h-4 mr-2" />{lang === 'th' ? '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠' : 'Submit'}</Button>
            </div>
          </div>
        </Modal>
      )}

      {/* MWO Modal */}
      {showMWOModal && (
        <Modal isOpen={showMWOModal} onClose={() => setShowMWOModal(false)} title={lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' : 'Create MWO'} size="lg">
          <div className="space-y-4">
            <div className="p-3 bg-blue-50 rounded-lg text-center">
              <div className="font-mono text-lg font-bold text-blue-700">{generateMWONumber()}</div>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Category'}</label>
                <select className="w-full px-3 py-2 border rounded-lg">
                  {Object.entries(MAINT_CATEGORIES).map(([key, val]) => <option key={key} value={key}>{val.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : 'Priority'}</label>
                <select className="w-full px-3 py-2 border rounded-lg">
                  <option value="low">{lang === 'th' ? '‡∏ï‡πà‡∏≥' : 'Low'}</option>
                  <option value="medium">{lang === 'th' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : 'Medium'}</option>
                  <option value="high">{lang === 'th' ? '‡∏™‡∏π‡∏á' : 'High'}</option>
                  <option value="critical">{lang === 'th' ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : 'Critical'}</option>
                </select>
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà' : 'Equipment/Area'}</label>
              <select className="w-full px-3 py-2 border rounded-lg">
                <option value="">{lang === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --' : '-- Select --'}</option>
                {equipmentList.map(eq => <option key={eq.id} value={eq.id}>{eq.name} ({eq.location})</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô' : 'Description'}</label>
              <textarea className="w-full px-3 py-2 border rounded-lg" rows="3" placeholder={lang === 'th' ? '‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥...' : 'Describe the work...'}></textarea>
            </div>
            <div className="flex gap-4 pt-4">
              <Button variant="outline" className="flex-1" onClick={() => setShowMWOModal(false)}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
              <Button className="flex-1">{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏á‡∏≤‡∏ô' : 'Create MWO'}</Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  )
}

// ============================================
// v7.6 FEATURES - GLOBAL SEARCH (Cmd+K)
// Search across all records: customers, WOs, invoices, inventory
// ============================================
const GlobalSearch = ({ isOpen, onClose, customers, workOrders, salesOrders, invoices, inventory, purchaseOrders, employees, onNavigate, lang }) => {
  const [query, setQuery] = useState('')
  const [results, setResults] = useState({ customers: [], workOrders: [], invoices: [], inventory: [], purchaseOrders: [], employees: [] })
  const inputRef = useRef(null)

  useEffect(() => {
    if (isOpen && inputRef.current) inputRef.current.focus()
  }, [isOpen])

  useEffect(() => {
    if (!query.trim()) {
      setResults({ customers: [], workOrders: [], invoices: [], inventory: [], purchaseOrders: [], employees: [] })
      return
    }
    const q = query.toLowerCase()
    setResults({
      customers: (customers || []).filter(c => c.name?.toLowerCase().includes(q) || c.code?.toLowerCase().includes(q)).slice(0, 5),
      workOrders: (workOrders || []).filter(wo => wo.woNumber?.toLowerCase().includes(q) || wo.productName?.toLowerCase().includes(q) || wo.id?.toString().includes(q)).slice(0, 5),
      invoices: (invoices || []).filter(inv => inv.invoiceNumber?.toLowerCase().includes(q) || inv.customerName?.toLowerCase().includes(q)).slice(0, 5),
      inventory: (inventory || []).filter(item => item.name?.toLowerCase().includes(q) || item.sku?.toLowerCase().includes(q) || item.lotNumber?.toLowerCase().includes(q)).slice(0, 5),
      purchaseOrders: (purchaseOrders || []).filter(po => po.poNumber?.toLowerCase().includes(q) || po.vendorName?.toLowerCase().includes(q)).slice(0, 5),
      employees: (employees || []).filter(emp => emp.name?.toLowerCase().includes(q) || emp.empId?.toLowerCase().includes(q)).slice(0, 5),
    })
  }, [query, customers, workOrders, invoices, inventory, purchaseOrders, employees])

  const totalResults = Object.values(results).reduce((sum, arr) => sum + arr.length, 0)
  const handleSelect = (type, item) => { onNavigate(type, item); onClose(); setQuery('') }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-start justify-center pt-20 bg-black/50" onClick={onClose}>
      <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
        <div className="flex items-center gap-3 px-4 py-3 border-b">
          <Search className="w-5 h-5 text-gray-400" />
          <input ref={inputRef} type="text" value={query} onChange={(e) => setQuery(e.target.value)}
            placeholder={lang === 'th' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, WO, ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...' : 'Search customers, WOs, invoices, inventory...'}
            className="flex-1 text-lg outline-none" />
          <kbd className="px-2 py-1 text-xs bg-gray-100 rounded border">ESC</kbd>
        </div>
        <div className="max-h-96 overflow-y-auto">
          {!query.trim() ? (
            <div className="p-8 text-center text-gray-400">
              <Search className="w-12 h-12 mx-auto mb-3 opacity-50" />
              <p>{lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : 'Start typing to search...'}</p>
              <p className="text-sm mt-1">{lang === 'th' ? '‡∏Å‡∏î ‚åòK ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+K ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î' : 'Press ‚åòK or Ctrl+K to open'}</p>
            </div>
          ) : totalResults === 0 ? (
            <div className="p-8 text-center text-gray-400"><p>{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö' : 'No results for'} "{query}"</p></div>
          ) : (
            <div className="divide-y">
              {results.customers.length > 0 && (
                <div className="p-3">
                  <div className="text-xs font-medium text-gray-500 mb-2 flex items-center gap-2"><Building2 className="w-4 h-4" />{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customers'}</div>
                  {results.customers.map(c => (
                    <button key={c.id} onClick={() => handleSelect('customer', c)} className="w-full flex items-center gap-3 px-3 py-2 hover:bg-blue-50 rounded-lg text-left">
                      <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-sm">{c.code?.substring(0, 2) || c.name?.charAt(0)}</div>
                      <div className="flex-1"><div className="font-medium">{c.name}</div><div className="text-xs text-gray-500">{c.code}</div></div>
                      <ChevronRight className="w-4 h-4 text-gray-300" />
                    </button>
                  ))}
                </div>
              )}
              {results.workOrders.length > 0 && (
                <div className="p-3">
                  <div className="text-xs font-medium text-gray-500 mb-2 flex items-center gap-2"><Factory className="w-4 h-4" />{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Orders'}</div>
                  {results.workOrders.map(wo => (
                    <button key={wo.id} onClick={() => handleSelect('workOrder', wo)} className="w-full flex items-center gap-3 px-3 py-2 hover:bg-orange-50 rounded-lg text-left">
                      <div className="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center"><Factory className="w-4 h-4 text-orange-600" /></div>
                      <div className="flex-1"><div className="font-mono font-medium text-orange-600">{wo.woNumber || wo.id}</div><div className="text-xs text-gray-500">{wo.productName} ‚Ä¢ {wo.quantity} pcs</div></div>
                      <Badge variant={wo.status === 'completed' ? 'success' : wo.status === 'in_progress' ? 'warning' : 'default'}>{wo.status}</Badge>
                    </button>
                  ))}
                </div>
              )}
              {results.inventory.length > 0 && (
                <div className="p-3">
                  <div className="text-xs font-medium text-gray-500 mb-2 flex items-center gap-2"><Package className="w-4 h-4" />{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á' : 'Inventory'}</div>
                  {results.inventory.map(item => (
                    <button key={item.id} onClick={() => handleSelect('inventory', item)} className="w-full flex items-center gap-3 px-3 py-2 hover:bg-purple-50 rounded-lg text-left">
                      <div className="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center"><Package className="w-4 h-4 text-purple-600" /></div>
                      <div className="flex-1"><div className="font-medium">{item.name}</div><div className="text-xs text-gray-500">{item.sku}</div></div>
                      <div className="text-right"><div className="font-medium">{item.quantity} {item.unit}</div></div>
                    </button>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
        <div className="px-4 py-2 bg-gray-50 border-t text-xs text-gray-500 flex items-center justify-between">
          <div className="flex items-center gap-4"><span>‚Üë‚Üì Navigate</span><span>Enter Select</span></div>
          <div>{totalResults} {lang === 'th' ? '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå' : 'results'}</div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// v7.6 FEATURES - NOTIFICATION CENTER
// ============================================
const NotificationCenter = ({ isOpen, onClose, notifications, onAction, lang }) => {
  const [filter, setFilter] = useState('all')
  if (!isOpen) return null

  const filtered = notifications.filter(n => filter === 'all' || n.type === filter)
  const unreadCount = notifications.filter(n => !n.read).length

  return (
    <div className="absolute right-0 top-12 w-96 bg-white rounded-xl shadow-2xl border z-50 overflow-hidden">
      <div className="p-4 border-b bg-gradient-to-r from-[#1A5276] to-[#2ECC40]">
        <div className="flex items-center justify-between">
          <h3 className="font-bold text-white flex items-center gap-2"><Bell className="w-5 h-5" />{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : 'Notifications'}{unreadCount > 0 && <span className="px-2 py-0.5 bg-white/20 rounded-full text-sm">{unreadCount}</span>}</h3>
          <button onClick={onClose} className="p-1 hover:bg-white/20 rounded text-white"><X className="w-4 h-4" /></button>
        </div>
        <div className="flex gap-2 mt-3">
          {[{ id: 'all', label: lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All' }, { id: 'alert', label: lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : 'Alerts' }, { id: 'task', label: lang === 'th' ? '‡∏á‡∏≤‡∏ô' : 'Tasks' }].map(f => (
            <button key={f.id} onClick={() => setFilter(f.id)} className={`px-3 py-1 rounded-full text-xs font-medium ${filter === f.id ? 'bg-white text-[#1A5276]' : 'text-white/80 hover:bg-white/20'}`}>{f.label}</button>
          ))}
        </div>
      </div>
      <div className="max-h-80 overflow-y-auto divide-y">
        {filtered.length === 0 ? (
          <div className="p-8 text-center text-gray-400"><Bell className="w-12 h-12 mx-auto mb-2 opacity-30" /><p>{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : 'No notifications'}</p></div>
        ) : filtered.map(notif => (
          <div key={notif.id} className={`p-4 hover:bg-gray-50 ${!notif.read ? 'bg-blue-50/50' : ''}`}>
            <div className="flex gap-3">
              <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${notif.type === 'alert' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                {notif.type === 'alert' ? <AlertTriangle className="w-5 h-5" /> : <Bell className="w-5 h-5" />}
              </div>
              <div className="flex-1 min-w-0">
                <div className="font-medium text-gray-800">{notif.title}</div>
                <div className="text-sm text-gray-600">{notif.message}</div>
                <div className="flex items-center gap-3 mt-2">
                  <span className="text-xs text-gray-400">{notif.time}</span>
                  {notif.action && <button onClick={() => onAction(notif)} className="text-xs font-medium text-[#1A5276] hover:underline">{notif.action}</button>}
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}

// ============================================
// v7.6 FEATURES - QUICK ACTIONS (Press Q)
// ============================================
const QuickActionsMenu = ({ isOpen, onClose, onAction, lang }) => {
  if (!isOpen) return null
  const actions = [
    { id: 'new_wo', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order' : 'New Work Order', icon: Factory, color: 'bg-orange-100 text-orange-600' },
    { id: 'new_so', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'New Sales Order', icon: Receipt, color: 'bg-pink-100 text-pink-600' },
    { id: 'new_po', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : 'New Purchase Order', icon: ShoppingCart, color: 'bg-yellow-100 text-yellow-600' },
    { id: 'new_invoice', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'New Invoice', icon: FileText, color: 'bg-green-100 text-green-600' },
    { id: 'maint_request', label: lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' : 'Maintenance Request', icon: Wrench, color: 'bg-amber-100 text-amber-600' },
  ]
  return (
    <div className="absolute right-0 top-12 w-72 bg-white rounded-xl shadow-2xl border z-50 overflow-hidden">
      <div className="p-3 border-b bg-gray-50"><h3 className="font-bold text-gray-700 flex items-center gap-2"><Zap className="w-4 h-4 text-yellow-500" />{lang === 'th' ? '‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î' : 'Quick Actions'}</h3></div>
      <div className="p-2">
        {actions.map(action => (
          <button key={action.id} onClick={() => { onAction(action.id); onClose() }} className="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-lg text-left">
            <div className={`w-8 h-8 rounded-lg ${action.color} flex items-center justify-center`}><action.icon className="w-4 h-4" /></div>
            <span className="font-medium text-gray-700">{action.label}</span>
          </button>
        ))}
      </div>
      <div className="p-2 border-t bg-gray-50 text-xs text-gray-400 text-center">{lang === 'th' ? '‡∏Å‡∏î Q ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î' : 'Press Q to open'}</div>
    </div>
  )
}

// ============================================
// v7.6 FEATURES - KANBAN BOARD for Production
// ============================================
const KanbanBoard = ({ workOrders, setWorkOrders, customers, lang }) => {
  const [draggedWO, setDraggedWO] = useState(null)
  const DEPT_FLOW = ['C1', 'C2', 'P1', 'P2', 'P3', 'ASM1', 'ASM2', 'OVN', 'QC', 'FG']
  const DEPT_COLORS = {
    C1: { bg: 'bg-red-50', border: 'border-red-300', text: 'text-red-700', header: 'bg-red-100' },
    C2: { bg: 'bg-orange-50', border: 'border-orange-300', text: 'text-orange-700', header: 'bg-orange-100' },
    P1: { bg: 'bg-yellow-50', border: 'border-yellow-300', text: 'text-yellow-700', header: 'bg-yellow-100' },
    P2: { bg: 'bg-lime-50', border: 'border-lime-300', text: 'text-lime-700', header: 'bg-lime-100' },
    P3: { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-700', header: 'bg-green-100' },
    ASM1: { bg: 'bg-teal-50', border: 'border-teal-300', text: 'text-teal-700', header: 'bg-teal-100' },
    ASM2: { bg: 'bg-cyan-50', border: 'border-cyan-300', text: 'text-cyan-700', header: 'bg-cyan-100' },
    OVN: { bg: 'bg-blue-50', border: 'border-blue-300', text: 'text-blue-700', header: 'bg-blue-100' },
    QC: { bg: 'bg-purple-50', border: 'border-purple-300', text: 'text-purple-700', header: 'bg-purple-100' },
    FG: { bg: 'bg-emerald-50', border: 'border-emerald-300', text: 'text-emerald-700', header: 'bg-emerald-100' },
  }
  const getWOsForDept = (deptCode) => workOrders.filter(wo => (wo.currentDept || wo.department || 'C1') === deptCode && wo.status !== 'completed')
  const handleDragStart = (e, wo) => { setDraggedWO(wo); e.dataTransfer.effectAllowed = 'move' }
  const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move' }
  const handleDrop = (e, targetDept) => {
    e.preventDefault()
    if (!draggedWO) return
    setWorkOrders(workOrders.map(wo => wo.id === draggedWO.id ? { ...wo, currentDept: targetDept, status: targetDept === 'FG' ? 'completed' : 'in_progress' } : wo))
    setDraggedWO(null)
  }
  return (
    <div className="h-full overflow-x-auto p-4">
      <div className="flex gap-3 min-w-max">
        {DEPT_FLOW.map(deptCode => {
          const wos = getWOsForDept(deptCode)
          const colors = DEPT_COLORS[deptCode]
          return (
            <div key={deptCode} className={`w-56 flex-shrink-0 rounded-xl border-2 ${colors.border} ${colors.bg} overflow-hidden`} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, deptCode)}>
              <div className={`p-3 ${colors.header} border-b ${colors.border}`}>
                <div className="flex items-center justify-between">
                  <div className={`font-bold ${colors.text}`}>{deptCode}</div>
                  <div className={`px-2 py-0.5 rounded-full text-xs font-medium ${colors.bg} ${colors.text}`}>{wos.length}</div>
                </div>
              </div>
              <div className="p-2 space-y-2 min-h-64 max-h-96 overflow-y-auto">
                {wos.map(wo => {
                  const customer = customers?.find(c => c.id === wo.customerId)
                  return (
                    <div key={wo.id} draggable onDragStart={(e) => handleDragStart(e, wo)} className="bg-white rounded-lg shadow-sm border p-3 cursor-move hover:shadow-md">
                      <div className="font-mono text-sm font-bold text-[#1A5276]">{wo.woNumber || wo.id}</div>
                      <div className="text-sm mt-1 truncate">{wo.productName}</div>
                      <div className="text-xs text-gray-500 mt-1">{customer?.name}</div>
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs font-medium">{wo.quantity} pcs</span>
                        {wo.targetDate && <span className={`text-xs ${new Date(wo.targetDate) < new Date() ? 'text-red-600 font-medium' : 'text-gray-400'}`}>{formatDate(wo.targetDate)}</span>}
                      </div>
                    </div>
                  )
                })}
                {wos.length === 0 && <div className={`p-4 text-center ${colors.text} opacity-50 text-sm`}>{lang === 'th' ? '‡∏ß‡πà‡∏≤‡∏á' : 'Empty'}</div>}
              </div>
            </div>
          )
        })}
      </div>
    </div>
  )
}

// ============================================
// GLOBAL MAINTENANCE REQUEST MODAL
// Accessible from all departments via header button or Q shortcut
// ============================================
const GlobalMaintenanceRequestModal = ({ isOpen, onClose, onSubmit, currentUser, lang }) => {
  const [formData, setFormData] = useState({
    department: currentUser?.department || '',
    requestedBy: currentUser?.name || '',
    category: 'equipment',
    subject: '',
    description: '',
    priority: 'medium',
  })

  const DEPARTMENTS = [
    { id: 'C1', label: 'C1 - Cutting 1' },
    { id: 'C2', label: 'C2 - Cutting 2' },
    { id: 'P1', label: 'P1 - Processing 1' },
    { id: 'P2', label: 'P2 - Processing 2' },
    { id: 'P3', label: 'P3 - Processing 3' },
    { id: 'ASM1', label: 'ASM1 - Assembly 1' },
    { id: 'ASM2', label: 'ASM2 - Assembly 2' },
    { id: 'OVN', label: 'OVN - Oven/HT' },
    { id: 'QC', label: 'QC - Quality Control' },
    { id: 'FG', label: 'FG - Finished Goods' },
    { id: 'warehouse', label: lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Warehouse' },
    { id: 'office', label: lang === 'th' ? '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Office' },
    { id: 'housing', label: lang === 'th' ? '‡∏´‡∏≠‡∏û‡∏±‡∏Å' : 'Staff Housing' },
  ]

  const CATEGORIES = [
    { id: 'equipment', label: lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå' : 'Equipment/Machinery', icon: '‚öôÔ∏è' },
    { id: 'electrical', label: lang === 'th' ? '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤' : 'Electrical', icon: '‚ö°' },
    { id: 'plumbing', label: lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : 'Plumbing', icon: 'üöø' },
    { id: 'building', label: lang === 'th' ? '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á' : 'Building/Structure', icon: 'üè¢' },
    { id: 'hvac', label: lang === 'th' ? '‡πÅ‡∏≠‡∏£‡πå/‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®' : 'HVAC/AC', icon: '‚ùÑÔ∏è' },
    { id: 'vehicle', label: lang === 'th' ? '‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞' : 'Vehicle', icon: 'üöõ' },
    { id: 'safety', label: lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢' : 'Safety', icon: 'ü¶∫' },
    { id: 'other', label: lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other', icon: 'üìã' },
  ]

  const handleSubmit = (e) => {
    e.preventDefault()
    if (!formData.department || !formData.subject) return
    onSubmit(formData)
    setFormData({ department: currentUser?.department || '', requestedBy: currentUser?.name || '', category: 'equipment', subject: '', description: '', priority: 'medium' })
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" onClick={onClose}>
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="bg-gradient-to-r from-amber-500 to-orange-500 p-5">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <Wrench className="w-6 h-6 text-white" />
              </div>
              <div>
                <h2 className="text-xl font-bold text-white">{lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° / ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤' : 'Report Issue / Request Repair'}</h2>
                <p className="text-amber-100 text-sm">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ' : 'Maintenance team will receive this request'}</p>
              </div>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-lg text-white"><X className="w-5 h-5" /></button>
          </div>
        </div>

        {/* Form */}
        <form onSubmit={handleSubmit} className="p-5 space-y-4">
          {/* Category Selection */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏±‡∏ç‡∏´‡∏≤' : 'Issue Category'}</label>
            <div className="grid grid-cols-4 gap-2">
              {CATEGORIES.map(cat => (
                <button key={cat.id} type="button" onClick={() => setFormData({...formData, category: cat.id})}
                  className={`p-3 rounded-xl border-2 text-center transition-all ${formData.category === cat.id ? 'border-amber-500 bg-amber-50' : 'border-gray-200 hover:border-gray-300'}`}>
                  <div className="text-xl mb-1">{cat.icon}</div>
                  <div className="text-xs font-medium text-gray-700">{cat.label.split('/')[0]}</div>
                </button>
              ))}
            </div>
          </div>

          {/* Department & Requester */}
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á' : 'Your Department'} *</label>
              <select value={formData.department} onChange={(e) => setFormData({...formData, department: e.target.value})} className="w-full px-3 py-2 border rounded-lg" required>
                <option value="">{lang === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --' : '-- Select --'}</option>
                {DEPARTMENTS.map(d => <option key={d.id} value={d.id}>{d.label}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á' : 'Your Name'} *</label>
              <input type="text" value={formData.requestedBy} onChange={(e) => setFormData({...formData, requestedBy: e.target.value})} 
                className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' : 'Your name'} required />
            </div>
          </div>

          {/* Subject */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏õ‡∏±‡∏ç‡∏´‡∏≤' : 'Subject / Issue'} *</label>
            <input type="text" value={formData.subject} onChange={(e) => setFormData({...formData, subject: e.target.value})} 
              className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á, ‡∏ó‡πà‡∏≠‡∏ô‡πâ‡∏≥‡∏£‡∏±‡πà‡∏ß, ‡πÅ‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÄ‡∏¢‡πá‡∏ô' : 'e.g., Machine making noise, Water leak, AC not cooling'} required />
          </div>

          {/* Description */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' : 'Additional Details'}</label>
            <textarea value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} 
              className="w-full px-3 py-2 border rounded-lg" rows="3" placeholder={lang === 'th' ? '‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...' : 'Describe the issue in more detail...'} />
          </div>

          {/* Priority */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' : 'Priority'}</label>
            <div className="flex gap-3">
              {[
                { id: 'low', label: lang === 'th' ? '‡∏ï‡πà‡∏≥' : 'Low', color: 'bg-gray-100 border-gray-300 text-gray-700' },
                { id: 'medium', label: lang === 'th' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : 'Medium', color: 'bg-yellow-100 border-yellow-400 text-yellow-700' },
                { id: 'high', label: lang === 'th' ? '‡∏™‡∏π‡∏á' : 'High', color: 'bg-orange-100 border-orange-400 text-orange-700' },
                { id: 'critical', label: lang === 'th' ? '‡∏ß‡∏¥‡∏Å‡∏§‡∏ï' : 'Critical', color: 'bg-red-100 border-red-400 text-red-700' },
              ].map(p => (
                <button key={p.id} type="button" onClick={() => setFormData({...formData, priority: p.id})}
                  className={`flex-1 py-2 px-3 rounded-lg border-2 text-sm font-medium transition-all ${formData.priority === p.id ? p.color + ' ring-2 ring-offset-1' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>
                  {p.label}
                </button>
              ))}
            </div>
          </div>

          {/* Buttons */}
          <div className="flex gap-3 pt-2">
            <button type="button" onClick={onClose} className="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">
              {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
            </button>
            <button type="submit" disabled={!formData.department || !formData.subject} 
              className="flex-1 px-4 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg font-medium hover:from-amber-600 hover:to-orange-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
              <Send className="w-4 h-4" />
              {lang === 'th' ? '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠' : 'Submit Request'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}

// ============================================
// HR MODULE
// ============================================
const HRModule = ({ employees, setEmployees, lang }) => {
  const [activeTab, setActiveTab] = useState('employees')
  const [search, setSearch] = useState('')
  const [filterDept, setFilterDept] = useState('all')

  const tabs = [
    { id: 'employees', label: lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Employees', icon: Users },
    { id: 'attendance', label: lang === 'th' ? '‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : 'Attendance', icon: Clock },
    { id: 'payroll', label: lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Payroll', icon: Banknote },
  ]

  const employeeList = employees || INITIAL_EMPLOYEES
  
  const filtered = employeeList.filter(emp => {
    const matchSearch = emp.name.toLowerCase().includes(search.toLowerCase()) ||
                       emp.nameTh.includes(search) ||
                       emp.empId.toLowerCase().includes(search.toLowerCase())
    const matchDept = filterDept === 'all' || emp.department === filterDept
    return matchSearch && matchDept
  })

  const departments = [...new Set(employeeList.map(e => e.department))]

  const stats = {
    total: employeeList.length,
    active: employeeList.filter(e => e.status === 'active').length,
    fullTime: employeeList.filter(e => e.empType === 'FT').length,
    partTime: employeeList.filter(e => e.empType === 'PT').length,
    totalPayroll: employeeList.filter(e => e.empType === 'FT').reduce((sum, e) => {
      return sum + (e.salary || 0) + (e.positionInc || 0) + (e.labourInc || 0) + (e.phone || 0) - (e.socialSecurity || 0)
    }, 0),
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.hr', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Manage employees and payroll'}</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" icon={Upload}>
            {lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î' : 'Upload'}
          </Button>
          <Button icon={UserPlus}>
            {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Add Employee'}
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total'}</div>
          <div className="text-2xl font-bold text-gray-800">{stats.total}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà' : 'Active'}</div>
          <div className="text-2xl font-bold text-green-600">{stats.active}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏à‡∏≥' : 'Full-time'}</div>
          <div className="text-2xl font-bold text-blue-600">{stats.fullTime}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : 'Part-time'}</div>
          <div className="text-2xl font-bold text-orange-600">{stats.partTime}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-purple-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°' : 'Total Payroll'}</div>
          <div className="text-2xl font-bold text-purple-600">{formatCurrency(stats.totalPayroll)}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Employees List */}
      {activeTab === 'employees' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b flex gap-4">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="text"
                placeholder={t('action.search', lang)}
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border rounded-lg"
              />
            </div>
            <select
              value={filterDept}
              onChange={(e) => setFilterDept(e.target.value)}
              className="px-4 py-2 border rounded-lg"
            >
              <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å' : 'All Departments'}</option>
              {departments.map(d => (
                <option key={d} value={d}>{d}</option>
              ))}
            </select>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'ID'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å' : 'Department'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' : 'Position'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Salary'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏≤‡∏Ç‡∏≤' : 'Entity'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {filtered.map(emp => (
                  <tr key={emp.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 font-mono text-[#1A5276]">{emp.empId}</td>
                    <td className="px-4 py-3">
                      <div className="font-medium">{emp.name}</div>
                      <div className="text-sm text-gray-500">{emp.nameTh}</div>
                    </td>
                    <td className="px-4 py-3 capitalize">{emp.department}</td>
                    <td className="px-4 py-3">{emp.designation}</td>
                    <td className="px-4 py-3 text-center">
                      <Badge variant={emp.empType === 'FT' ? 'info' : 'orange'}>
                        {emp.empType === 'FT' ? (lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏à‡∏≥' : 'Full-time') : (lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : 'Daily')}
                      </Badge>
                    </td>
                    <td className="px-4 py-3 text-right font-medium">
                      {emp.empType === 'FT' ? formatCurrency(emp.salary) : `${formatCurrency(emp.dailyRate)}/day`}
                    </td>
                    <td className="px-4 py-3 text-center">
                      <Badge variant={emp.entity}>{emp.entity}</Badge>
                    </td>
                    <td className="px-4 py-3 text-center">
                      <Badge variant={emp.status === 'active' ? 'success' : 'danger'}>
                        {emp.status === 'active' ? (lang === 'th' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : 'Active') : (lang === 'th' ? '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å' : 'Inactive')}
                      </Badge>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* Payroll Tab */}
      {activeTab === 'payroll' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b bg-gray-50">
            <h3 className="font-bold text-gray-800">{lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥' : 'Payroll Summary - Full-time Employees'}</h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-3 py-2 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Employee'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Salary'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' : 'Position'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏¢‡∏±‡∏ô' : 'Diligence'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' : 'Phone'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏£‡∏±‡∏ö' : 'Gross'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°' : 'SSO'}</th>
                  <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏∏‡∏ó‡∏ò‡∏¥' : 'Net'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {employeeList.filter(e => e.empType === 'FT').map(emp => {
                  const gross = (emp.salary || 0) + (emp.positionInc || 0) + (emp.labourInc || 0) + (emp.phone || 0)
                  const net = gross - (emp.socialSecurity || 0)
                  return (
                    <tr key={emp.id} className="hover:bg-gray-50">
                      <td className="px-3 py-2">
                        <div className="font-medium">{emp.name}</div>
                        <div className="text-xs text-gray-500">{emp.empId}</div>
                      </td>
                      <td className="px-3 py-2 text-right">{formatCurrency(emp.salary)}</td>
                      <td className="px-3 py-2 text-right">{formatCurrency(emp.positionInc || 0)}</td>
                      <td className="px-3 py-2 text-right">{formatCurrency(emp.labourInc || 0)}</td>
                      <td className="px-3 py-2 text-right">{formatCurrency(emp.phone || 0)}</td>
                      <td className="px-3 py-2 text-right font-medium text-blue-600">{formatCurrency(gross)}</td>
                      <td className="px-3 py-2 text-right text-red-600">-{formatCurrency(emp.socialSecurity || 0)}</td>
                      <td className="px-3 py-2 text-right font-bold text-green-600">{formatCurrency(net)}</td>
                    </tr>
                  )
                })}
              </tbody>
              <tfoot className="bg-gray-100 font-bold">
                <tr>
                  <td className="px-3 py-3">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : 'TOTAL'}</td>
                  <td className="px-3 py-3 text-right">{formatCurrency(employeeList.filter(e => e.empType === 'FT').reduce((s, e) => s + (e.salary || 0), 0))}</td>
                  <td className="px-3 py-3 text-right">{formatCurrency(employeeList.filter(e => e.empType === 'FT').reduce((s, e) => s + (e.positionInc || 0), 0))}</td>
                  <td className="px-3 py-3 text-right">{formatCurrency(employeeList.filter(e => e.empType === 'FT').reduce((s, e) => s + (e.labourInc || 0), 0))}</td>
                  <td className="px-3 py-3 text-right">{formatCurrency(employeeList.filter(e => e.empType === 'FT').reduce((s, e) => s + (e.phone || 0), 0))}</td>
                  <td className="px-3 py-3 text-right text-blue-600">
                    {formatCurrency(employeeList.filter(e => e.empType === 'FT').reduce((s, e) => s + (e.salary || 0) + (e.positionInc || 0) + (e.labourInc || 0) + (e.phone || 0), 0))}
                  </td>
                  <td className="px-3 py-3 text-right text-red-600">
                    -{formatCurrency(employeeList.filter(e => e.empType === 'FT').reduce((s, e) => s + (e.socialSecurity || 0), 0))}
                  </td>
                  <td className="px-3 py-3 text-right text-green-600">{formatCurrency(stats.totalPayroll)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </Card>
      )}

      {/* Attendance Tab */}
      {activeTab === 'attendance' && (
        <Card className="p-12 text-center">
          <div className="w-20 h-20 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
            <Clock className="w-10 h-10 text-blue-600" />
          </div>
          <h3 className="text-xl font-bold text-gray-800 mb-2">
            {lang === 'th' ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : 'Attendance System'}
          </h3>
          <p className="text-gray-500">
            {lang === 'th' ? '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠' : 'Ready for fingerprint scanner integration'}
          </p>
        </Card>
      )}
    </div>
  )
}

// ============================================
// LANGUAGE SWITCHER
// ============================================
const LanguageSwitcher = () => {
  const { lang, setLang } = useContext(LanguageContext)
  const [isOpen, setIsOpen] = useState(false)

  return (
    <div className="relative">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-all"
      >
        <span className="text-lg">{LANGUAGES[lang].flag}</span>
        <span className="text-sm font-medium text-gray-700">{LANGUAGES[lang].name}</span>
        <ChevronDown className={`w-4 h-4 text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>
      
      {isOpen && (
        <>
          <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)} />
          <div className="absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-xl border z-50 py-1">
            {Object.entries(LANGUAGES).map(([code, { name, flag }]) => (
              <button
                key={code}
                onClick={() => { setLang(code); setIsOpen(false) }}
                className={`w-full flex items-center gap-3 px-4 py-2 text-left hover:bg-gray-50 ${lang === code ? 'bg-green-50 text-green-700' : 'text-gray-700'}`}
              >
                <span className="text-lg">{flag}</span>
                <span className="text-sm">{name}</span>
                {lang === code && <Check className="w-4 h-4 ml-auto" />}
              </button>
            ))}
          </div>
        </>
      )}
    </div>
  )
}

// ============================================
// LABEL PRINT MODAL (With QR Codes)
// ============================================
const LabelPrintModal = ({ isOpen, onClose, lots, lang, title, isPrePrint }) => {
  const printRef = useRef()
  
  const handlePrint = () => {
    const content = printRef.current
    const printWindow = window.open('', '_blank')
    printWindow.document.write('<html><head><title>Labels</title>')
    printWindow.document.write('<style>')
    printWindow.document.write(`
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font-family: Arial, sans-serif; }
      @page { size: 100mm 50mm; margin: 2mm; }
      .label { 
        width: 96mm; height: 46mm; border: 1px solid #000; 
        padding: 3mm; page-break-after: always; margin-bottom: 2mm;
        display: flex; justify-content: space-between;
      }
      .label-content { flex: 1; }
      .logo { font-weight: bold; font-size: 16pt; color: #1A5276; }
      .lot-no { font-size: 14pt; font-weight: bold; margin: 2mm 0; }
      .material-code { font-size: 10pt; font-family: monospace; background: #f0f0f0; padding: 1mm 2mm; }
      .details { font-size: 9pt; margin-top: 2mm; }
      .qr-placeholder { 
        width: 35mm; height: 35mm; border: 1px solid #ccc; 
        display: flex; align-items: center; justify-content: center;
        font-size: 8pt; color: #666;
      }
    `)
    printWindow.document.write('</style></head><body>')
    printWindow.document.write(content.innerHTML)
    printWindow.document.write('</body></html>')
    printWindow.document.close()
    printWindow.print()
  }

  if (!isOpen) return null

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={title || (lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å' : 'Print Labels')} size="lg">
      <div className="space-y-4">
        {isPrePrint && (
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3">
            <AlertTriangle className="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" />
            <div>
              <div className="font-medium text-amber-800">
                {lang === 'th' ? '‡∏â‡∏•‡∏≤‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤' : 'Pre-Print Labels'}
              </div>
              <div className="text-sm text-amber-700">
                {lang === 'th' 
                  ? '‡∏â‡∏•‡∏≤‡∏Å‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á ‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á'
                  : 'These labels are printed before goods receipt. Dimensions may change upon actual receipt.'}
              </div>
            </div>
          </div>
        )}
        
        <div className="border rounded-lg p-4 bg-gray-50 max-h-[400px] overflow-y-auto">
          <div ref={printRef}>
            {lots.map((lot, idx) => (
              <div key={idx} className="label bg-white mb-4 p-4 border rounded flex justify-between">
                <div className="label-content">
                  <div className="logo flex items-center gap-2">
                    <span className="text-[#1A5276] font-bold text-xl">IND</span>
                    <span className="text-xs text-gray-500">Thai Packwell</span>
                  </div>
                  <div className="lot-no text-lg font-bold mt-2">{lot.lotNo}</div>
                  <div className="material-code bg-gray-100 px-2 py-1 font-mono text-sm inline-block mt-1">{lot.code}</div>
                  <div className="details grid grid-cols-2 gap-x-4 gap-y-1 mt-3 text-sm">
                    <div><span className="text-gray-500">Category:</span> <strong>{lot.category}</strong></div>
                    <div><span className="text-gray-500">Qty:</span> <strong>{lot.qty} {lot.unit || 'pcs'}</strong></div>
                    <div><span className="text-gray-500">Store:</span> <strong>{lot.store || 'STORE1'}</strong></div>
                    <div><span className="text-gray-500">Date:</span> <strong>{lot.dateIn}</strong></div>
                    {lot.cbm && <div><span className="text-gray-500">CBM:</span> <strong>{lot.cbm.toFixed(3)}</strong></div>}
                    {lot.vendor && <div><span className="text-gray-500">Vendor:</span> <strong>{lot.vendor}</strong></div>}
                  </div>
                </div>
                <div className="qr-placeholder w-24 h-24 border border-gray-300 flex items-center justify-center text-xs text-gray-400">
                  [QR: {lot.lotNo}]
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="flex items-center justify-between pt-4 border-t">
          <div className="text-sm text-gray-500">
            {lots.length} {lang === 'th' ? '‡∏â‡∏•‡∏≤‡∏Å' : 'labels'} {lang === 'th' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå' : 'ready to print'}
          </div>
          <div className="flex gap-3">
            <Button variant="secondary" onClick={onClose}>{t('action.cancel', lang)}</Button>
            <Button icon={Printer} onClick={handlePrint}>
              {lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå' : 'Print'}
            </Button>
          </div>
        </div>
      </div>
    </Modal>
  )
}

// ============================================
// EDIT LOT MODAL (Correct quantities after receiving)
// ============================================
const EditLotModal = ({ isOpen, onClose, lot, categories, stores, onSave, onPrintLabel }) => {
  const [formData, setFormData] = useState(null)

  useEffect(() => {
    if (lot) {
      // Parse dimensions from code (e.g., IND-MLH/50/100/2400)
      const codeParts = lot.code?.split('/') || []
      const thickness = parseFloat(codeParts[1]) || 0
      const width = parseFloat(codeParts[2]) || 0
      const length = parseFloat(codeParts[3]) || 0
      
      setFormData({
        lotNo: lot.lotNo,
        category: lot.category,
        dateIn: lot.dateIn,
        qty: lot.qty,
        thickness,
        width,
        length,
        store: lot.store,
        reason: '',
        cost: lot.cost || 0,
        cbm: lot.cbm || 0,
        costPerCbm: lot.costPerCbm || 0,
      })
    }
  }, [lot])

  if (!isOpen || !formData) return null

  const generateMaterialCode = () => {
    const prefix = formData.store === 'STORE2' ? 'IND2' : 'IND'
    return `${prefix}-${formData.category}/${formData.thickness}/${formData.width}/${formData.length}`
  }

  const calculateCbm = () => {
    return (formData.thickness * formData.width * formData.length * formData.qty) / 1000000000
  }

  const handleSave = () => {
    const updatedLot = {
      ...lot,
      ...formData,
      code: generateMaterialCode(),
      cbm: calculateCbm(),
    }
    onSave(updatedLot)
    onClose()
  }

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Edit Lot / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πá‡∏≠‡∏ï" size="lg">
      <div className="space-y-6">
        {/* Info Banner */}
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
          <Info className="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm text-blue-700">
            Use this to correct quantities or sizes when actual goods differ from pre-printed labels.
            Don't forget to <strong>reprint the label</strong> after saving changes.
          </div>
        </div>

        {/* Form Grid */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Lot Number</label>
            <input
              type="text"
              value={formData.lotNo}
              disabled
              className="w-full px-3 py-2 border rounded-lg bg-gray-50"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select
              value={formData.category}
              onChange={(e) => setFormData({ ...formData, category: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            >
              {categories.filter(c => c.type === 'raw_material').map(c => (
                <option key={c.id} value={c.id}>{c.code} - {c.nameEn}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Date Received</label>
            <input
              type="date"
              value={formData.dateIn}
              onChange={(e) => setFormData({ ...formData, dateIn: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Quantity <span className="text-gray-400">(Original: {lot.qty})</span>
            </label>
            <input
              type="number"
              value={formData.qty}
              onChange={(e) => setFormData({ ...formData, qty: parseInt(e.target.value) || 0 })}
              className={`w-full px-3 py-2 border rounded-lg ${formData.qty !== lot.qty ? 'border-amber-400 bg-amber-50' : ''}`}
            />
          </div>
        </div>

        {/* Dimensions */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Dimensions (mm)</label>
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-xs text-gray-500 mb-1">Thickness</label>
              <input
                type="number"
                step="0.1"
                value={formData.thickness}
                onChange={(e) => setFormData({ ...formData, thickness: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">Width</label>
              <input
                type="number"
                step="0.1"
                value={formData.width}
                onChange={(e) => setFormData({ ...formData, width: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">Length</label>
              <input
                type="number"
                step="0.1"
                value={formData.length}
                onChange={(e) => setFormData({ ...formData, length: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>
        </div>

        {/* Auto-calculated fields */}
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Material Code (auto-generated)</label>
            <input
              type="text"
              value={generateMaterialCode()}
              disabled
              className="w-full px-3 py-2 border rounded-lg bg-gray-50 font-mono"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Store Location</label>
            <select
              value={formData.store}
              onChange={(e) => setFormData({ ...formData, store: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            >
              {stores.map(s => (
                <option key={s.id} value={s.id}>{s.code} - {s.nameEn}</option>
              ))}
            </select>
          </div>
        </div>

        {/* Reason for correction */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Reason for Correction</label>
          <textarea
            value={formData.reason}
            onChange={(e) => setFormData({ ...formData, reason: e.target.value })}
            rows={2}
            className="w-full px-3 py-2 border rounded-lg"
            placeholder="Explain why this correction is needed..."
          />
        </div>

        {/* Actions */}
        <div className="flex justify-end gap-3 pt-4 border-t">
          <Button variant="secondary" onClick={onClose}>Cancel</Button>
          <Button
            variant="outline"
            icon={Printer}
            onClick={() => onPrintLabel(formData)}
          >
            Save & Print Label
          </Button>
          <Button icon={Save} onClick={handleSave}>Save Changes</Button>
        </div>
      </div>
    </Modal>
  )
}

// ============================================
// INVENTORY MODULE (Full with CBM tracking)
// ============================================
const InventoryModule = ({ inventory, setInventory, stores, categories, maintenanceStore, setMaintenanceStore, lang }) => {
  const [selectedStore, setSelectedStore] = useState('all')
  const [selectedCategory, setSelectedCategory] = useState('all')
  const [search, setSearch] = useState('')
  const [showEditModal, setShowEditModal] = useState(false)
  const [showLabelModal, setShowLabelModal] = useState(false)
  const [selectedLot, setSelectedLot] = useState(null)
  const [lotsForLabels, setLotsForLabels] = useState([])
  const [expandedCodes, setExpandedCodes] = useState({})
  
  // Convert maintenance store items to inventory format for unified display
  const maintenanceItems = (maintenanceStore || []).map(item => ({
    id: item.id,
    lotNo: item.sku,
    category: 'MAINT',
    code: item.name,
    store: 'STORE5',
    qty: item.qty,
    cbm: 0,
    cost: item.qty * item.unitCost,
    costPerCbm: 0,
    status: item.qty <= item.minQty ? 'low' : 'available',
    dateIn: item.lastRestock,
    vendor: item.supplier,
    // Keep original maintenance fields for display
    _isMaintenance: true,
    _original: item
  }))
  
  // Combined inventory: regular inventory + maintenance store items
  const combinedInventory = [...inventory, ...maintenanceItems]

  const handlePrintLabel = (lot) => {
    setLotsForLabels([lot])
    setShowLabelModal(true)
  }

  const handlePrintAllLabels = () => {
    setLotsForLabels(filteredInventory)
    setShowLabelModal(true)
  }

  const handleSaveAndPrintLabel = (updatedLot) => {
    setInventory(inv => inv.map(i => i.id === updatedLot.id ? updatedLot : i))
    setLotsForLabels([updatedLot])
    setShowLabelModal(true)
  }

  // Filter inventory (using combined inventory that includes STORE5/maintenance items)
  const filteredInventory = combinedInventory.filter(item => {
    const matchStore = selectedStore === 'all' || item.store === selectedStore
    const matchCat = selectedCategory === 'all' || item.category === selectedCategory
    const matchSearch = !search || 
      item.code.toLowerCase().includes(search.toLowerCase()) ||
      item.lotNo.toLowerCase().includes(search.toLowerCase())
    return matchStore && matchCat && matchSearch
  })

  // Group by material code
  const groupedInventory = filteredInventory.reduce((acc, item) => {
    if (!acc[item.code]) {
      acc[item.code] = { code: item.code, category: item.category, lots: [], totalQty: 0, totalCbm: 0, totalCost: 0 }
    }
    acc[item.code].lots.push(item)
    acc[item.code].totalQty += item.qty
    acc[item.code].totalCbm += item.cbm || 0
    acc[item.code].totalCost += item.cost || 0
    return acc
  }, {})

  // Calculate totals
  const totals = {
    lots: filteredInventory.length,
    qty: filteredInventory.reduce((sum, i) => sum + i.qty, 0),
    cbm: filteredInventory.reduce((sum, i) => sum + (i.cbm || 0), 0),
    value: filteredInventory.reduce((sum, i) => sum + (i.cost || 0), 0),
    lowStock: filteredInventory.filter(i => i.status === 'low').length,
  }

  const rmCategories = categories.filter(c => c.type === 'raw_material')

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('inventory.title', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏±‡∏á' : 'Track inventory across all stores'}</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" icon={Upload}>
            {lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î' : 'Upload'}
          </Button>
          <Button variant="outline" icon={Printer} onClick={handlePrintAllLabels}>
            {lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Print All'}
          </Button>
        </div>
      </div>

      {/* Store Cards */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {stores.map(store => {
          const storeItems = combinedInventory.filter(i => i.store === store.id)
          const storeValue = storeItems.reduce((sum, i) => sum + (i.cost || 0), 0)
          const isSelected = selectedStore === store.id
          const isMaintenance = store.id === 'STORE5'
          return (
            <Card 
              key={store.id} 
              onClick={() => setSelectedStore(isSelected ? 'all' : store.id)}
              className={`p-4 cursor-pointer transition-all ${isSelected ? 'ring-2 ring-[#1A5276] bg-blue-50' : 'hover:bg-gray-50'} ${isMaintenance ? 'border-orange-200' : ''}`}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="text-sm font-medium text-gray-600">{store.code}</div>
                <Badge variant={store.type === 'raw_material' ? 'success' : store.type === 'finished_goods' ? 'info' : store.type === 'maintenance' ? 'orange' : 'default'}>
                  {storeItems.length}
                </Badge>
              </div>
              <div className="text-xs text-gray-500 truncate">{lang === 'th' ? store.nameTh : store.nameEn}</div>
              <div className="font-bold text-[#2ECC40] mt-2">{formatCurrency(storeValue)}</div>
              {isMaintenance && <div className="text-xs text-orange-500 mt-1">üîß Linked to Maintenance</div>}
            </Card>
          )
        })}
      </div>

      {/* Category Filter (8 Wood Types) */}
      <div>
        <div className="text-sm font-medium text-gray-700 mb-2">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (8 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏°‡πâ)' : 'Raw Material Categories (8 Wood Types)'}</div>
        <div className="flex flex-wrap gap-2">
          <button
            onClick={() => setSelectedCategory('all')}
            className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
              selectedCategory === 'all' 
                ? 'bg-gradient-to-r from-[#1A5276] to-[#2ECC40] text-white' 
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All'}
          </button>
          {rmCategories.map(cat => {
            const count = inventory.filter(i => i.category === cat.id).length
            return (
              <button
                key={cat.id}
                onClick={() => setSelectedCategory(selectedCategory === cat.id ? 'all' : cat.id)}
                className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all flex items-center gap-2 ${
                  selectedCategory === cat.id 
                    ? 'text-white' 
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
                style={selectedCategory === cat.id ? { backgroundColor: cat.color } : {}}
              >
                <span className="w-3 h-3 rounded-full" style={{ backgroundColor: cat.color }} />
                {cat.code}
                <span className="text-xs opacity-75">({count})</span>
              </button>
            )
          })}
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{t('inventory.totalLots', lang)}</div>
          <div className="text-2xl font-bold text-gray-800">{totals.lots}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°' : 'Total Qty'}</div>
          <div className="text-2xl font-bold text-gray-800">{formatNumber(totals.qty)}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏£‡∏ß‡∏°' : 'Total CBM'}</div>
          <div className="text-2xl font-bold text-blue-600">{totals.cbm.toFixed(2)} m¬≥</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{t('inventory.totalValue', lang)}</div>
          <div className="text-2xl font-bold text-[#2ECC40]">{formatCurrency(totals.value)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-red-500">
          <div className="text-sm text-gray-500">{t('inventory.lowStock', lang)}</div>
          <div className="text-2xl font-bold text-red-600">{totals.lowStock}</div>
        </Card>
      </div>

      {/* Search */}
      <div className="relative max-w-md">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
        <input
          type="text"
          placeholder={t('action.search', lang)}
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="w-full pl-10 pr-4 py-2 border rounded-lg"
        />
      </div>

      {/* Inventory Table */}
      {selectedStore === 'STORE5' ? (
        /* Maintenance Store (STORE5) - Special Table */
        <Card className="overflow-hidden">
          <div className="bg-orange-50 px-4 py-3 border-b flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Wrench className="w-5 h-5 text-orange-600" />
              <span className="font-medium text-orange-800">{lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á (STORE5)' : 'Maintenance Parts Store (STORE5)'}</span>
            </div>
            <Badge variant="orange">{filteredInventory.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'items'}</Badge>
          </div>
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™ SKU' : 'SKU'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Item Name'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Stock'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? 'Min/Max' : 'Min/Max'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö' : 'Location'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit Cost'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredInventory.map(item => {
                const orig = item._original || {}
                const isLow = item.qty <= (orig.minQty || 0)
                return (
                  <tr key={item.id} className={`hover:bg-gray-50 ${isLow ? 'bg-red-50' : ''}`}>
                    <td className="px-4 py-3 font-mono text-[#1A5276] text-sm">{item.lotNo}</td>
                    <td className="px-4 py-3">
                      <div className="font-medium">{orig.name || item.code}</div>
                      {orig.nameTh && <div className="text-xs text-gray-500">{orig.nameTh}</div>}
                    </td>
                    <td className="px-4 py-3">
                      <Badge variant="default">{orig.category || item.category}</Badge>
                    </td>
                    <td className="px-4 py-3 text-right font-bold">{item.qty}</td>
                    <td className="px-4 py-3 text-center text-sm text-gray-500">{orig.unit || '-'}</td>
                    <td className="px-4 py-3 text-right text-sm text-gray-500">{orig.minQty || 0}/{orig.maxQty || '-'}</td>
                    <td className="px-4 py-3 text-sm">{orig.location || '-'}</td>
                    <td className="px-4 py-3 text-right font-medium text-[#2ECC40]">{formatCurrency(orig.unitCost || 0)}</td>
                    <td className="px-4 py-3 text-center">
                      <Badge variant={isLow ? 'danger' : 'success'}>{isLow ? (lang === 'th' ? '‡∏ï‡πà‡∏≥' : 'LOW') : (lang === 'th' ? '‡∏õ‡∏Å‡∏ï‡∏¥' : 'OK')}</Badge>
                    </td>
                  </tr>
                )
              })}
              {filteredInventory.length === 0 && (
                <tr>
                  <td colSpan="9" className="px-4 py-8 text-center text-gray-500">
                    {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'No items found'}
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </Card>
      ) : (
        /* Regular Inventory Table */
        <Card className="overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Material Code'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡πá‡∏≠‡∏ï' : 'Lots'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">CBM</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {Object.values(groupedInventory).map(group => {
                const cat = categories.find(c => c.id === group.category)
                const isExpanded = expandedCodes[group.code]
                return (
                  <React.Fragment key={group.code}>
                    <tr 
                      className="hover:bg-gray-50 cursor-pointer"
                      onClick={() => setExpandedCodes(prev => ({ ...prev, [group.code]: !prev[group.code] }))}
                    >
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <ChevronRight className={`w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                          <span className="font-mono text-[#1A5276]">{group.code}</span>
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <span className="w-3 h-3 rounded-full" style={{ backgroundColor: cat?.color }} />
                          <span>{group.category}</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-right">{group.lots.length}</td>
                      <td className="px-4 py-3 text-right font-medium">{formatNumber(group.totalQty)}</td>
                      <td className="px-4 py-3 text-right">{group.totalCbm.toFixed(3)}</td>
                      <td className="px-4 py-3 text-right font-medium text-[#2ECC40]">{formatCurrency(group.totalCost)}</td>
                    </tr>
                    {isExpanded && group.lots.map(lot => (
                      <tr key={lot.id} className="bg-gray-50/50 hover:bg-gray-100">
                        <td className="px-4 py-2 pl-12">
                          <span className="text-sm font-mono text-gray-600">{lot.lotNo}</span>
                        </td>
                        <td className="px-4 py-2 text-sm text-gray-500">{lot.vendor || '-'}</td>
                        <td className="px-4 py-2 text-right text-sm">
                          <Badge variant={lot.status === 'low' ? 'warning' : 'success'}>{lot.status}</Badge>
                        </td>
                        <td className="px-4 py-2 text-right text-sm">{lot.qty}</td>
                        <td className="px-4 py-2 text-right text-sm">{(lot.cbm || 0).toFixed(3)}</td>
                        <td className="px-4 py-2 text-right text-sm text-[#2ECC40]">{formatCurrency(lot.cost)}</td>
                      </tr>
                    ))}
                  </React.Fragment>
                )
              })}
            </tbody>
          </table>
        </Card>
      )}

      {/* Modals */}
      <EditLotModal
        isOpen={showEditModal}
        onClose={() => { setShowEditModal(false); setSelectedLot(null) }}
        lot={selectedLot}
        categories={categories}
        stores={stores}
        onSave={(updatedLot) => setInventory(inv => inv.map(i => i.id === updatedLot.id ? updatedLot : i))}
        onPrintLabel={handleSaveAndPrintLabel}
      />

      <LabelPrintModal
        isOpen={showLabelModal}
        onClose={() => setShowLabelModal(false)}
        lots={lotsForLabels}
        lang={lang}
      />
    </div>
  )
}

// ============================================
// PURCHASE MODULE (Full with Import Costing)
// ============================================
const PurchaseModule = ({ purchaseOrders, setPurchaseOrders, vendors, categories, stores, inventory, setInventory, lang }) => {
  const [activeTab, setActiveTab] = useState('dashboard')
  const [showPOModal, setShowPOModal] = useState(false)
  const [showGRNModal, setShowGRNModal] = useState(false)
  const [showUploadModal, setShowUploadModal] = useState(false)
  const [selectedPO, setSelectedPO] = useState(null)
  const [showLabelModal, setShowLabelModal] = useState(false)
  const [pendingLots, setPendingLots] = useState([])
  
  // GLOBAL LOT SEQUENCE - shared across ALL materials
  const [globalLotSequence, setGlobalLotSequence] = useState(14926)
  
  // Generate lot number with correct prefix based on material and vendor
  const generateLotNumber = (categoryCode, vendor) => {
    const seq = globalLotSequence + 1
    setGlobalLotSequence(seq)
    
    let prefix
    switch (categoryCode) {
      case 'MLH':
        prefix = 'LP'
        break
      case 'PW':
        // Use vendor initials for PW
        prefix = vendor?.initials || vendor?.name?.substring(0, 2).toUpperCase() || 'PW'
        break
      case 'PLYRR':
        prefix = 'PLYRR'
        break
      case 'PLYRW':
        prefix = 'PLYRW'
        break
      case 'PLYWW':
        prefix = 'PLYWW'
        break
      case 'PLYWB':
        prefix = 'PLYWB'
        break
      case 'PRTB':
        prefix = 'PRTB'
        break
      case 'PRTW':
        prefix = 'PRTW'
        break
      default:
        prefix = categoryCode
    }
    
    return `${prefix}${seq}`
  }

  const tabs = [
    { id: 'dashboard', label: lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°' : 'Dashboard', icon: BarChart3 },
    { id: 'orders', label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : 'Purchase Orders', icon: FileText },
    { id: 'receiving', label: lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Goods Receipt', icon: Package },
    { id: 'import', label: lang === 'th' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import Tracking', icon: Truck },
    { id: 'vendors', label: lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendors', icon: Users },
    { id: 'reports', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' : 'Reports', icon: PieChart },
  ]


  // Stats
  const stats = {
    total: purchaseOrders.length,
    pending: purchaseOrders.filter(po => po.status === 'pending').length,
    inTransit: purchaseOrders.filter(po => po.status === 'in_transit').length,
    received: purchaseOrders.filter(po => po.status === 'received').length,
    totalValue: purchaseOrders.reduce((sum, po) => sum + (po.total || 0), 0),
    importCosts: purchaseOrders.reduce((sum, po) => sum + (po.totalImportCosts || 0), 0),
  }

  const handleReceive = (po) => {
    setSelectedPO(po)
    setShowGRNModal(true)
  }

  const handlePrePrint = (po) => {
    const vendor = vendors.find(v => v.id === po.vendorId)
    const lots = po.items.map((item, idx) => {
      const entityPrefix = po.type === 'import' ? 'IND2' : 'IND'
      return {
        lotNo: generateLotNumber(item.categoryId, vendor),
        code: `${entityPrefix}-${item.categoryId}/${item.thickness}/${item.width}/${item.length}`,
        category: item.categoryId,
        qty: item.qty,
        dateIn: po.deliveryDate || new Date().toISOString().split('T')[0],
      }
    })
    setPendingLots(lots)
    setShowLabelModal(true)
  }

  const handleGRNSave = (grnData) => {
    // Update PO status
    setPurchaseOrders(pos => pos.map(po => 
      po.id === grnData.poId ? { ...po, status: 'received', receivedDate: grnData.grnDate } : po
    ))
    
    const vendor = vendors.find(v => v.id === selectedPO.vendorId)
    
    // Add to inventory
    const newItems = grnData.items.map((item, idx) => {
      const entityPrefix = selectedPO.type === 'import' ? 'IND2' : 'IND'
      const store = selectedPO.type === 'import' || ['PLYWW', 'PLYRR', 'PLYRW'].includes(item.category) ? 'STORE2' : 'STORE1'
      const cbm = (item.thickness * item.width * item.length * item.qtyReceived) / 1000000000
      
      // Calculate cost including import costs if applicable
      let unitCost = item.unitPrice * (selectedPO.exchangeRate || 1)
      if (selectedPO.type === 'import' && selectedPO.totalImportCosts > 0) {
        const totalQty = selectedPO.items.reduce((s, i) => s + i.qtyOrdered, 0)
        const importCostShare = selectedPO.totalImportCosts / totalQty
        unitCost += importCostShare
      }
      
      return {
        id: Date.now() + idx,
        lotNo: generateLotNumber(item.category, vendor),
        category: item.category,
        code: `${entityPrefix}-${item.category}/${item.thickness}/${item.width}/${item.length}`,
        store,
        qty: item.qtyReceived,
        cbm,
        cost: item.qtyReceived * unitCost,
        costPerCbm: cbm > 0 ? (item.qtyReceived * unitCost) / cbm : 0,
        status: 'available',
        dateIn: grnData.grnDate,
        vendor: vendor?.name || '',
        poId: selectedPO.id,
      }
    })
    
    setInventory(inv => [...inv, ...newItems])
    setShowGRNModal(false)
    setSelectedPO(null)
  }

  const handleDocumentProcessed = (data) => {
    // Auto-create PO from uploaded document
    if (data.docType === 'vendor_invoice' && data.items) {
      const newPO = {
        id: `PO-${new Date().getFullYear().toString().slice(-2)}${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(purchaseOrders.length + 1).padStart(3, '0')}`,
        vendorId: data.vendorId,
        type: 'local',
        poDate: new Date().toISOString().split('T')[0],
        vendorInvoice: data.invoiceNo,
        vendorInvoiceDate: data.invoiceDate,
        items: data.items.map((item, idx) => ({
          id: idx + 1,
          categoryId: item.category || data.suggestedCategory,
          thickness: 50,
          width: 100,
          length: 2400,
          qty: item.qty,
          unit: 'pcs',
          cbm: item.cbm || 0,
          unitPrice: item.unitPrice,
          total: item.total,
        })),
        subtotal: data.subtotal,
        vat: data.vat,
        total: data.total,
        importCosts: {},
        totalImportCosts: 0,
        status: 'pending',
        entity: 'IND',
        uploadedFrom: data.file,
        processedAt: data.processedAt,
      }
      setPurchaseOrders(pos => [...pos, newPO])
    }
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.purchase', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Manage purchase orders and goods receipt'}</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" icon={Upload} onClick={() => setShowUploadModal(true)}>
            {lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' : 'Upload Invoice'}
          </Button>
          <Button icon={Plus} onClick={() => setShowPOModal(true)}>
            {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : 'New PO'}
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total'}</div>
          <div className="text-2xl font-bold text-gray-800">{stats.total}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-yellow-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Pending'}</div>
          <div className="text-2xl font-bold text-yellow-600">{stats.pending}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á' : 'In Transit'}</div>
          <div className="text-2xl font-bold text-blue-600">{stats.inTransit}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
          <div className="text-2xl font-bold text-green-600">{stats.received}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-purple-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Value'}</div>
          <div className="text-2xl font-bold text-purple-600">{formatCurrency(stats.totalValue)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import Costs'}</div>
          <div className="text-2xl font-bold text-orange-600">{formatCurrency(stats.importCosts)}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Dashboard Tab */}
      {activeTab === 'dashboard' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Recent POs */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Recent Purchase Orders'}</h3>
            <div className="space-y-3">
              {purchaseOrders.slice(0, 5).map(po => {
                const vendor = vendors.find(v => v.id === po.vendorId)
                return (
                  <div key={po.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <div className="font-mono text-[#1A5276] font-medium">{po.id}</div>
                      <div className="text-sm text-gray-500">{vendor?.name || po.vendorId}</div>
                    </div>
                    <div className="text-right">
                      <Badge variant={
                        po.status === 'received' ? 'success' :
                        po.status === 'in_transit' ? 'info' :
                        'warning'
                      }>
                        {po.status}
                      </Badge>
                      <div className="text-sm font-medium mt-1">{formatCurrency(po.total)}</div>
                    </div>
                  </div>
                )
              })}
            </div>
          </Card>

          {/* Pending Receipts */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Pending Receipts'}</h3>
            <div className="space-y-3">
              {purchaseOrders.filter(po => po.status === 'pending' || po.status === 'in_transit').map(po => {
                const vendor = vendors.find(v => v.id === po.vendorId)
                return (
                  <div key={po.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <div className="font-mono text-[#1A5276] font-medium">{po.id}</div>
                      <div className="text-sm text-gray-500">{vendor?.name}</div>
                      <div className="text-xs text-gray-400">{lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:' : 'Due:'} {po.deliveryDate}</div>
                    </div>
                    <div className="flex gap-2">
                      <Button size="sm" variant="outline" icon={Printer} onClick={() => handlePrePrint(po)}>
                        {lang === 'th' ? '‡∏â‡∏•‡∏≤‡∏Å' : 'Labels'}
                      </Button>
                      <Button size="sm" icon={Package} onClick={() => handleReceive(po)}>
                        {lang === 'th' ? '‡∏£‡∏±‡∏ö' : 'Receive'}
                      </Button>
                    </div>
                  </div>
                )
              })}
              {purchaseOrders.filter(po => po.status === 'pending' || po.status === 'in_transit').length === 0 && (
                <p className="text-gray-400 text-center py-4">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'No pending receipts'}</p>
              )}
            </div>
          </Card>
        </div>
      )}

      {/* Orders Tab */}
      {activeTab === 'orders' && (
        <Card className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO' : 'PO #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Materials'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {purchaseOrders.map(po => {
                  const vendor = vendors.find(v => v.id === po.vendorId)
                  return (
                    <tr key={po.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3">
                        <div className="font-mono text-[#1A5276] font-medium">{po.id}</div>
                        {po.vendorInvoice && <div className="text-xs text-gray-400">{po.vendorInvoice}</div>}
                      </td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{vendor?.name || po.vendorId}</div>
                        <div className="text-xs text-gray-400">{vendor?.country}</div>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={po.type === 'import' ? 'info' : 'success'}>
                          {po.type === 'import' ? 'üö¢ Import' : 'üè† Local'}
                        </Badge>
                      </td>
                      <td className="px-4 py-3 text-sm">{formatDate(po.poDate)}</td>
                      <td className="px-4 py-3 text-right">{formatCurrency(po.subtotal)}</td>
                      <td className="px-4 py-3 text-right text-orange-600">
                        {po.type === 'import' ? formatCurrency(po.totalImportCosts) : '-'}
                      </td>
                      <td className="px-4 py-3 text-right font-bold text-[#2ECC40]">{formatCurrency(po.total)}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          po.status === 'received' ? 'success' :
                          po.status === 'in_transit' ? 'info' :
                          'warning'
                        }>
                          {po.status}
                        </Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          <button className="p-1 hover:bg-gray-100 rounded" title="View">
                            <Eye className="w-4 h-4 text-gray-500" />
                          </button>
                          {po.status !== 'received' && (
                            <button 
                              className="p-1 hover:bg-gray-100 rounded" 
                              title="Receive"
                              onClick={() => handleReceive(po)}
                            >
                              <Package className="w-4 h-4 text-blue-500" />
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* Receiving Tab */}
      {activeTab === 'receiving' && (
        <Card className="overflow-hidden">
          <div className="p-4 bg-green-50 border-b border-green-100">
            <h3 className="font-bold text-green-800">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Goods Receipt Queue'}</h3>
            <p className="text-sm text-green-600">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å PO ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á' : 'Select PO to receive goods into inventory'}</p>
          </div>
          <div className="divide-y">
            {purchaseOrders.filter(po => po.status !== 'received').map(po => {
              const vendor = vendors.find(v => v.id === po.vendorId)
              return (
                <div key={po.id} className="p-4 flex items-center justify-between hover:bg-gray-50">
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center ${po.type === 'import' ? 'bg-blue-100' : 'bg-green-100'}`}>
                      {po.type === 'import' ? 'üö¢' : 'üè†'}
                    </div>
                    <div>
                      <div className="font-mono text-[#1A5276] font-bold">{po.id}</div>
                      <div className="text-sm text-gray-600">{vendor?.name}</div>
                      <div className="text-xs text-gray-400">
                        {po.items?.length || 0} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'items'} ‚Ä¢ 
                        {lang === 'th' ? ' ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ' : ' Due: '}{formatDate(po.deliveryDate)}
                      </div>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    <div className="text-right">
                      <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</div>
                      <div className="font-bold text-[#2ECC40]">{formatCurrency(po.total)}</div>
                    </div>
                    <div className="flex gap-2">
                      <Button variant="outline" size="sm" icon={Printer} onClick={() => handlePrePrint(po)}>
                        {lang === 'th' ? '‡∏â‡∏•‡∏≤‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤' : 'Pre-print'}
                      </Button>
                      <Button size="sm" icon={Package} onClick={() => handleReceive(po)}>
                        {lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Receive'}
                      </Button>
                    </div>
                  </div>
                </div>
              )
            })}
            {purchaseOrders.filter(po => po.status !== 'received').length === 0 && (
              <div className="p-8 text-center text-gray-400">
                {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'No items pending receipt'}
              </div>
            )}
          </div>
        </Card>
      )}

      {/* Vendors Tab */}
      {activeTab === 'vendors' && (
        <Card className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' : 'Contact'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : 'Terms'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {vendors.map(v => (
                  <tr key={v.id} className="hover:bg-gray-50">
                    <td className="px-4 py-3 font-mono text-[#1A5276]">{v.code}</td>
                    <td className="px-4 py-3">
                      <div className="font-medium">{v.name}</div>
                      <div className="text-sm text-gray-500">{v.nameTh}</div>
                    </td>
                    <td className="px-4 py-3 text-center">
                      <Badge variant={v.type === 'import' ? 'info' : 'success'}>
                        {v.type}
                      </Badge>
                    </td>
                    <td className="px-4 py-3">{v.category}</td>
                    <td className="px-4 py-3">
                      <div>{v.contact}</div>
                      <div className="text-sm text-gray-500">{v.phone}</div>
                    </td>
                    <td className="px-4 py-3 text-center">{v.paymentTerms} days</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* PO Form Modal */}
      {showPOModal && (
        <Modal isOpen={showPOModal} onClose={() => setShowPOModal(false)} title={lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : 'New Purchase Order'} size="xl">
          <PurchaseOrderForm
            vendors={vendors}
            categories={categories}
            lang={lang}
            onSave={(poData) => {
              const newPO = {
                id: `PO-${new Date().getFullYear().toString().slice(-2)}${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(purchaseOrders.length + 1).padStart(3, '0')}`,
                ...poData,
                status: 'pending',
                entity: poData.type === 'import' ? 'IND' : 'IND',
              }
              setPurchaseOrders([...purchaseOrders, newPO])
              setShowPOModal(false)
            }}
            onCancel={() => setShowPOModal(false)}
          />
        </Modal>
      )}

      {/* GRN Modal */}

      {/* GRN Modal - Enhanced with Split Lots */}
      {showGRNModal && selectedPO && (
        <Modal isOpen={showGRNModal} onClose={() => setShowGRNModal(false)} title={lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Goods Receipt'} size="xl">
          <GoodsReceiptForm
            po={selectedPO}
            vendors={vendors}
            categories={categories}
            globalLotSequence={globalLotSequence}
            setGlobalLotSequence={setGlobalLotSequence}
            lang={lang}
            onSave={handleGRNSave}
            onCancel={() => setShowGRNModal(false)}
          />
        </Modal>
      )}


      {/* Smart Upload Modal */}
      <SmartDocumentUploadModal
        isOpen={showUploadModal}
        onClose={() => setShowUploadModal(false)}
        module="purchase"
        lang={lang}
        categories={categories}
        vendors={vendors}
        onProcessed={handleDocumentProcessed}
      />

      {/* Label Print Modal */}
      <LabelPrintModal
        isOpen={showLabelModal}
        onClose={() => setShowLabelModal(false)}
        lots={pendingLots}
        lang={lang}
        title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤' : 'Pre-print Labels'}
        isPrePrint={true}
      />
    </div>
  )
}

// ============================================
// PURCHASE ORDER FORM (With 13 Import Cost Types)
// ============================================
const PurchaseOrderForm = ({ po, vendors, categories, onSave, onCancel, lang }) => {
  const rmCategories = categories.filter(c => c.type === 'raw_material')
  const [formData, setFormData] = useState({
    type: po?.type || 'local',
    vendorId: po?.vendorId || '',
    poDate: po?.poDate || new Date().toISOString().split('T')[0],
    vendorInvoice: po?.vendorInvoice || '',
    vendorInvoiceDate: po?.vendorInvoiceDate || '',
    container: po?.container || '',
    blNumber: po?.blNumber || '',
    deliveryDate: po?.deliveryDate || '',
    currency: po?.currency || 'THB',
    exchangeRate: po?.exchangeRate || 1,
    items: po?.items || [{ id: 1, categoryId: '', thickness: 0, width: 0, length: 0, qty: 0, unit: 'pcs', unitPrice: 0 }],
    importCosts: po?.importCosts || {},
  })

  const selectedVendor = vendors.find(v => v.id === formData.vendorId)

  useEffect(() => {
    if (selectedVendor) {
      setFormData(prev => ({
        ...prev,
        type: selectedVendor.type,
        currency: selectedVendor.type === 'import' ? 'USD' : 'THB',
        exchangeRate: selectedVendor.type === 'import' ? 35.50 : 1,
      }))
    }
  }, [formData.vendorId])

  const addItem = () => {
    setFormData(prev => ({
      ...prev,
      items: [...prev.items, { id: prev.items.length + 1, categoryId: '', thickness: 0, width: 0, length: 0, qty: 0, unit: 'pcs', unitPrice: 0 }]
    }))
  }

  const updateItem = (idx, field, value) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => i === idx ? { ...item, [field]: value } : item)
    }))
  }

  const removeItem = (idx) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.filter((_, i) => i !== idx)
    }))
  }

  const updateImportCost = (costId, value) => {
    setFormData(prev => ({
      ...prev,
      importCosts: { ...prev.importCosts, [costId]: parseFloat(value) || 0 }
    }))
  }

  // Calculations
  const subtotal = formData.items.reduce((sum, item) => sum + (item.qty * item.unitPrice * formData.exchangeRate), 0)
  const totalImportCosts = Object.values(formData.importCosts).reduce((sum, cost) => sum + (cost || 0), 0)
  const vat7 = (subtotal + totalImportCosts) * 0.07
  const withholding3 = formData.type === 'import' ? totalImportCosts * 0.03 : 0
  const grandTotal = subtotal + totalImportCosts + vat7 - withholding3

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave({
      ...formData,
      subtotal,
      totalImportCosts,
      vat: vat7,
      withholding: withholding3,
      total: grandTotal,
    })
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Type & Vendor */}
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠' : 'Purchase Type'}
          </label>
          <div className="flex gap-2">
            <button
              type="button"
              onClick={() => setFormData({ ...formData, type: 'local' })}
              className={`flex-1 py-2 px-4 rounded-lg border-2 transition-all ${formData.type === 'local' ? 'border-green-500 bg-green-50 text-green-700' : 'border-gray-200'}`}
            >
              üè† Local
            </button>
            <button
              type="button"
              onClick={() => setFormData({ ...formData, type: 'import' })}
              className={`flex-1 py-2 px-4 rounded-lg border-2 transition-all ${formData.type === 'import' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200'}`}
            >
              üö¢ Import
            </button>
          </div>
        </div>
        <div className="col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ *' : 'Vendor *'}
          </label>
          <select
            required
            value={formData.vendorId}
            onChange={(e) => setFormData({ ...formData, vendorId: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-[#1A5276]"
          >
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Select Vendor'}</option>
            {vendors.filter(v => formData.type === 'all' || v.type === formData.type).map(v => (
              <option key={v.id} value={v.id}>{v.name}</option>
            ))}
          </select>
        </div>
      </div>

      {/* Dates & Invoice */}
      <div className="grid grid-cols-4 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà PO *' : 'PO Date *'}
          </label>
          <input
            type="date"
            required
            value={formData.poDate}
            onChange={(e) => setFormData({ ...formData, poDate: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Vendor Invoice #'}
          </label>
          <input
            type="text"
            value={formData.vendorInvoice}
            onChange={(e) => setFormData({ ...formData, vendorInvoice: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á *' : 'Delivery Date *'}
          </label>
          <input
            type="date"
            required
            value={formData.deliveryDate}
            onChange={(e) => setFormData({ ...formData, deliveryDate: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        {formData.type === 'import' && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ï‡∏π‡πâ' : 'Container #'}
            </label>
            <input
              type="text"
              value={formData.container}
              onChange={(e) => setFormData({ ...formData, container: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder="MSCU1234567"
            />
          </div>
        )}
      </div>

      {/* Currency for Import */}
      {formData.type === 'import' && (
        <div className="grid grid-cols-3 gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô' : 'Currency'}
            </label>
            <select
              value={formData.currency}
              onChange={(e) => setFormData({ ...formData, currency: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (‚Ç¨)</option>
              <option value="THB">THB (‡∏ø)</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô' : 'Exchange Rate'}
            </label>
            <input
              type="number"
              step="0.01"
              value={formData.exchangeRate}
              onChange={(e) => setFormData({ ...formData, exchangeRate: parseFloat(e.target.value) || 1 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div className="flex items-end">
            <div className="text-sm text-blue-700 bg-blue-100 px-3 py-2 rounded-lg">
              1 {formData.currency} = ‡∏ø{formData.exchangeRate.toFixed(2)}
            </div>
          </div>
        </div>
      )}

      {/* Items */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="text-sm font-medium text-gray-700">
            {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Order Items'}
          </label>
          <Button type="button" size="sm" variant="outline" onClick={addItem}>
            + {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Add Item'}
          </Button>
        </div>
        <div className="border rounded-lg overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</th>
                <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏Ç‡∏ô‡∏≤‡∏î T x W x L (mm)' : 'T x W x L (mm)'}</th>
                <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit'}</th>
                <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit Price'}</th>
                <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                <th className="px-3 py-2"></th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {formData.items.map((item, idx) => (
                <tr key={idx}>
                  <td className="px-3 py-2">
                    <select
                      value={item.categoryId}
                      onChange={(e) => updateItem(idx, 'categoryId', e.target.value)}
                      className="w-full px-2 py-1 border rounded text-sm"
                    >
                      <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' : 'Select'}</option>
                      {rmCategories.map(c => (
                        <option key={c.id} value={c.id}>{c.code} - {c.nameEn}</option>
                      ))}
                    </select>
                  </td>
                  <td className="px-3 py-2">
                    <div className="flex gap-1">
                      <input
                        type="number"
                        placeholder="T"
                        value={item.thickness || ''}
                        onChange={(e) => updateItem(idx, 'thickness', parseFloat(e.target.value) || 0)}
                        className="w-16 px-2 py-1 border rounded text-sm"
                      />
                      <input
                        type="number"
                        placeholder="W"
                        value={item.width || ''}
                        onChange={(e) => updateItem(idx, 'width', parseFloat(e.target.value) || 0)}
                        className="w-16 px-2 py-1 border rounded text-sm"
                      />
                      <input
                        type="number"
                        placeholder="L"
                        value={item.length || ''}
                        onChange={(e) => updateItem(idx, 'length', parseFloat(e.target.value) || 0)}
                        className="w-20 px-2 py-1 border rounded text-sm"
                      />
                    </div>
                  </td>
                  <td className="px-3 py-2">
                    <input
                      type="number"
                      value={item.qty || ''}
                      onChange={(e) => updateItem(idx, 'qty', parseInt(e.target.value) || 0)}
                      className="w-20 px-2 py-1 border rounded text-sm text-right"
                    />
                  </td>
                  <td className="px-3 py-2">
                    <select
                      value={item.unit}
                      onChange={(e) => updateItem(idx, 'unit', e.target.value)}
                      className="w-20 px-2 py-1 border rounded text-sm"
                    >
                      <option value="pcs">pcs</option>
                      <option value="sheets">sheets</option>
                      <option value="m3">m¬≥</option>
                    </select>
                  </td>
                  <td className="px-3 py-2">
                    <input
                      type="number"
                      step="0.01"
                      value={item.unitPrice || ''}
                      onChange={(e) => updateItem(idx, 'unitPrice', parseFloat(e.target.value) || 0)}
                      className="w-24 px-2 py-1 border rounded text-sm text-right"
                    />
                  </td>
                  <td className="px-3 py-2 text-right font-medium">
                    {formatCurrency(item.qty * item.unitPrice * formData.exchangeRate)}
                  </td>
                  <td className="px-3 py-2">
                    {formData.items.length > 1 && (
                      <button type="button" onClick={() => removeItem(idx)} className="text-red-500 hover:text-red-700">
                        <Trash2 className="w-4 h-4" />
                      </button>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Import Costs - 13 Types */}
      {formData.type === 'import' && (
        <div>
          <label className="text-sm font-medium text-gray-700 mb-2 block">
            {lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (13 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)' : 'Import Costing (13 Types)'}
          </label>
          <div className="grid grid-cols-4 gap-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
            {IMPORT_COST_TYPES.map(cost => (
              <div key={cost.id}>
                <label className="block text-xs text-gray-600 mb-1">
                  {lang === 'th' ? cost.nameTh : cost.nameEn}
                </label>
                <input
                  type="number"
                  value={formData.importCosts[cost.id] || ''}
                  onChange={(e) => updateImportCost(cost.id, e.target.value)}
                  className="w-full px-2 py-1 border rounded text-sm text-right"
                  placeholder="‡∏ø0"
                />
              </div>
            ))}
          </div>
          <div className="mt-2 text-right text-sm text-blue-700">
            {lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:' : 'Total Import Costs:'} <strong>{formatCurrency(totalImportCosts)}</strong>
          </div>
        </div>
      )}

      {/* Totals */}
      <div className="bg-gray-50 rounded-lg p-4">
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-2 text-sm">
            <div className="flex justify-between">
              <span className="text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Subtotal (Materials)'}</span>
              <span className="font-medium">{formatCurrency(subtotal)}</span>
            </div>
            {formData.type === 'import' && (
              <div className="flex justify-between">
                <span className="text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import Costs'}</span>
                <span className="font-medium text-orange-600">{formatCurrency(totalImportCosts)}</span>
              </div>
            )}
            <div className="flex justify-between">
              <span className="text-gray-600">VAT 7%</span>
              <span className="font-medium">{formatCurrency(vat7)}</span>
            </div>
            {formData.type === 'import' && (
              <div className="flex justify-between">
                <span className="text-gray-600">{lang === 'th' ? '‡∏´‡∏±‡∏Å ‡∏ì ‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢ 3%' : 'Withholding 3%'}</span>
                <span className="font-medium text-red-600">-{formatCurrency(withholding3)}</span>
              </div>
            )}
          </div>
          <div className="flex items-end justify-end">
            <div className="text-right">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : 'Grand Total'}</div>
              <div className="text-3xl font-bold text-[#2ECC40]">{formatCurrency(grandTotal)}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>{t('action.save', lang)}</Button>
      </div>
    </form>
  )
}


// ============================================
// REJECT ITEM MODAL
// ============================================
const RejectItemModal = ({ item, lang, onReject, onCancel }) => {
  const [reason, setReason] = useState('')
  const [note, setNote] = useState('')

  const handleSubmit = (e) => {
    e.preventDefault()
    if (reason) onReject(reason, note)
  }

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
            <AlertOctagon className="w-6 h-6 text-red-600" />
          </div>
          <div>
            <h3 className="text-lg font-bold text-gray-800">
              {lang === 'th' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Reject Item'}
            </h3>
            <p className="text-sm text-gray-500">
              {item.categoryId} - {item.thickness}√ó{item.width}√ó{item.length}mm
            </p>
          </div>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò *' : 'Rejection Reason *'}
            </label>
            <select
              required
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="">{lang === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• --' : '-- Select Reason --'}</option>
              {REJECTION_REASONS.map(r => (
                <option key={r.id} value={r.id}>
                  {lang === 'th' ? r.labelTh : r.labelEn}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' : 'Additional Details'}
            </label>
            <textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              rows={2}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder={lang === 'th' ? '‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...' : 'Specify details...'}
            />
          </div>

          <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800">
            <AlertTriangle className="w-4 h-4 inline mr-1" />
            {lang === 'th' 
              ? '‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á Vendor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà (Revised Invoice)' 
              : 'Rejection will be recorded. Vendor must be notified for Revised Invoice.'}
          </div>

          <div className="flex justify-end gap-3 pt-2">
            <Button type="button" variant="secondary" onClick={onCancel}>
              {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
            </Button>
            <Button type="submit" variant="danger" icon={X}>
              {lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Confirm Reject'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  )
}

// ============================================
// ADD RECEIPT ITEM MODAL (Not on PO)
// ============================================
const AddReceiptItemModal = ({ categories, lang, onAdd, onCancel }) => {
  const rmCategories = categories?.filter(c => c.type === 'raw_material') || []
  const [formData, setFormData] = useState({
    categoryId: '',
    thickness: 0,
    width: 0,
    length: 0,
    qty: 0,
    unit: 'pcs',
    unitPrice: 0,
    note: '',
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    onAdd(formData)
  }

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
            <Plus className="w-6 h-6 text-blue-600" />
          </div>
          <div>
            <h3 className="text-lg font-bold text-gray-800">
              {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà' : 'Add New Item'}
            </h3>
            <p className="text-sm text-gray-500">
              {lang === 'th' ? '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô PO' : 'For items received but not in PO'}
            </p>
          </div>
        </div>

        <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-4 text-sm text-blue-800">
          <Info className="w-4 h-4 inline mr-1" />
          {lang === 'th' 
            ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô Variance ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Variance Report' 
            : 'This will be recorded as Variance and generate a Variance Report'}
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà *' : 'Category *'}
              </label>
              <select
                required
                value={formData.categoryId}
                onChange={(e) => setFormData({ ...formData, categoryId: e.target.value })}
                className="w-full px-3 py-2 border rounded-lg"
              >
                <option value="">{lang === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --' : '-- Select --'}</option>
                {rmCategories.map(c => (
                  <option key={c.id} value={c.id}>{c.code} - {c.nameEn}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *' : 'Quantity *'}
              </label>
              <input
                type="number"
                required
                min="1"
                value={formData.qty || ''}
                onChange={(e) => setFormData({ ...formData, qty: parseInt(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>

          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡∏´‡∏ô‡∏≤ (mm) *' : 'Thickness *'}
              </label>
              <input
                type="number"
                required
                step="0.1"
                value={formData.thickness || ''}
                onChange={(e) => setFormData({ ...formData, thickness: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡∏Å‡∏ß‡πâ‡∏≤‡∏á (mm) *' : 'Width *'}
              </label>
              <input
                type="number"
                required
                step="0.1"
                value={formData.width || ''}
                onChange={(e) => setFormData({ ...formData, width: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡∏¢‡∏≤‡∏ß (mm) *' : 'Length *'}
              </label>
              <input
                type="number"
                required
                step="0.1"
                value={formData.length || ''}
                onChange={(e) => setFormData({ ...formData, length: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border rounded-lg"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢ *' : 'Unit Price *'}
            </label>
            <input
              type="number"
              required
              step="0.01"
              value={formData.unitPrice || ''}
              onChange={(e) => setFormData({ ...formData, unitPrice: parseFloat(e.target.value) || 0 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Note'}
            </label>
            <input
              type="text"
              value={formData.note}
              onChange={(e) => setFormData({ ...formData, note: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder={lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°...' : 'Reason for adding...'}
            />
          </div>

          <div className="flex justify-end gap-3 pt-2">
            <Button type="button" variant="secondary" onClick={onCancel}>
              {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
            </Button>
            <Button type="submit" icon={Plus}>
              {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Add Item'}
            </Button>
          </div>
        </form>
      </div>
    </div>
  )
}

// ============================================
// ENHANCED GOODS RECEIPT FORM
// With Split Lots, Reject, Add Items (Spec 3-4)
// ============================================
const GoodsReceiptForm = ({ po, vendors, categories, globalLotSequence, setGlobalLotSequence, onSave, onCancel, lang }) => {
  const vendor = vendors.find(v => v.id === po.vendorId)
  const rmCategories = categories?.filter(c => c.type === 'raw_material') || []
  
  // State for receipt items - each PO item can have multiple lots
  const [receiptItems, setReceiptItems] = useState(
    po.items.map((item, idx) => ({
      poItemIdx: idx,
      poItem: item,
      lots: [{
        id: `lot-${idx}-0`,
        qtyToReceive: item.qty - (item.qtyReceived || 0),
        actualThickness: item.thickness,
        actualWidth: item.width,
        actualLength: item.length,
        hasVariance: false,
        varianceType: '',
        varianceNote: '',
      }],
      isRejected: false,
      rejectReason: '',
      rejectNote: '',
    }))
  )
  
  // State for newly added items (not on PO)
  const [additionalItems, setAdditionalItems] = useState([])
  
  // General receipt info
  const [grnDate, setGrnDate] = useState(new Date().toISOString().split('T')[0])
  const [grnNotes, setGrnNotes] = useState('')
  
  // Modal states
  const [showRejectModal, setShowRejectModal] = useState(false)
  const [rejectingItemIdx, setRejectingItemIdx] = useState(null)
  const [showAddItemModal, setShowAddItemModal] = useState(false)
  const [expandedItems, setExpandedItems] = useState(() => {
    const expanded = {}
    po.items.forEach((_, idx) => { expanded[idx] = true })
    return expanded
  })

  // Generate lot number
  const generateLotNumber = (categoryCode) => {
    const seq = (globalLotSequence || 14926) + 1
    if (setGlobalLotSequence) setGlobalLotSequence(seq)
    
    let prefix
    switch (categoryCode) {
      case 'MLH': prefix = 'LP'; break
      case 'PW': prefix = vendor?.initials || 'PW'; break
      case 'PWKD': prefix = vendor?.initials || 'PW'; break
      case 'PWGRN': prefix = vendor?.initials || 'PW'; break
      case 'PLYRR': prefix = 'PLYRR'; break
      case 'PLYRW': prefix = 'PLYRW'; break
      case 'PLYWW': prefix = 'PLYWW'; break
      case 'PRTB': prefix = 'PRTB'; break
      default: prefix = categoryCode
    }
    return `${prefix}${seq}`
  }

  // Toggle item expansion
  const toggleExpand = (idx) => {
    setExpandedItems(prev => ({ ...prev, [idx]: !prev[idx] }))
  }

  // Add a lot to a PO item (split)
  const addLotToItem = (itemIdx) => {
    setReceiptItems(items => items.map((item, idx) => {
      if (idx !== itemIdx) return item
      return {
        ...item,
        lots: [...item.lots, {
          id: `lot-${itemIdx}-${item.lots.length}`,
          qtyToReceive: 0,
          actualThickness: item.poItem.thickness,
          actualWidth: item.poItem.width,
          actualLength: item.poItem.length,
          hasVariance: false,
          varianceType: '',
          varianceNote: '',
        }]
      }
    }))
  }

  // Remove a lot from an item
  const removeLot = (itemIdx, lotIdx) => {
    setReceiptItems(items => items.map((item, idx) => {
      if (idx !== itemIdx || item.lots.length <= 1) return item
      return {
        ...item,
        lots: item.lots.filter((_, i) => i !== lotIdx)
      }
    }))
  }

  // Update a lot field
  const updateLot = (itemIdx, lotIdx, field, value) => {
    setReceiptItems(items => items.map((item, idx) => {
      if (idx !== itemIdx) return item
      return {
        ...item,
        lots: item.lots.map((lot, i) => {
          if (i !== lotIdx) return lot
          const updated = { ...lot, [field]: value }
          
          // Auto-detect variance based on dimensions
          const hasVariance = 
            updated.actualThickness !== item.poItem.thickness ||
            updated.actualWidth !== item.poItem.width ||
            updated.actualLength !== item.poItem.length
          
          updated.hasVariance = hasVariance
          if (hasVariance && !updated.varianceType) {
            updated.varianceType = 'size_different'
          }
          
          return updated
        })
      }
    }))
  }

  // Get total qty in lots for an item
  const getTotalInLots = (item) => {
    return item.lots.reduce((sum, lot) => sum + (lot.qtyToReceive || 0), 0)
  }

  // Reject an item
  const handleRejectItem = (itemIdx, reason, note) => {
    setReceiptItems(items => items.map((item, idx) => {
      if (idx !== itemIdx) return item
      return {
        ...item,
        isRejected: true,
        rejectReason: reason,
        rejectNote: note,
        lots: item.lots.map(lot => ({ ...lot, qtyToReceive: 0 }))
      }
    }))
    setShowRejectModal(false)
    setRejectingItemIdx(null)
  }

  // Un-reject an item
  const handleUnrejectItem = (itemIdx) => {
    setReceiptItems(items => items.map((item, idx) => {
      if (idx !== itemIdx) return item
      const remaining = item.poItem.qty - (item.poItem.qtyReceived || 0)
      return {
        ...item,
        isRejected: false,
        rejectReason: '',
        rejectNote: '',
        lots: [{
          id: `lot-${itemIdx}-0`,
          qtyToReceive: remaining,
          actualThickness: item.poItem.thickness,
          actualWidth: item.poItem.width,
          actualLength: item.poItem.length,
          hasVariance: false,
          varianceType: '',
          varianceNote: '',
        }]
      }
    }))
  }

  // Add additional item (not on PO)
  const handleAddAdditionalItem = (newItem) => {
    setAdditionalItems(items => [...items, {
      ...newItem,
      id: `ADD-${items.length + 1}`,
      isAdditional: true,
    }])
    setShowAddItemModal(false)
  }

  // Remove additional item
  const removeAdditionalItem = (idx) => {
    setAdditionalItems(items => items.filter((_, i) => i !== idx))
  }

  // Calculate totals
  const calculateTotals = () => {
    let totalLots = 0
    let totalQty = 0
    let totalValue = 0
    let totalRejected = 0
    let hasVariance = false

    receiptItems.forEach(item => {
      if (item.isRejected) {
        totalRejected++
      } else {
        item.lots.forEach(lot => {
          if (lot.qtyToReceive > 0) {
            totalLots++
            totalQty += lot.qtyToReceive
            totalValue += lot.qtyToReceive * item.poItem.unitPrice * (po.exchangeRate || 1)
            if (lot.hasVariance) hasVariance = true
          }
        })
      }
    })

    additionalItems.forEach(item => {
      totalLots++
      totalQty += item.qty
      totalValue += item.qty * item.unitPrice
      hasVariance = true
    })

    return { totalLots, totalQty, totalValue, totalRejected, hasVariance }
  }

  const totals = calculateTotals()

  // Submit receipt
  const handleSubmit = (e) => {
    e.preventDefault()
    
    const allLots = []
    const rejections = []
    
    receiptItems.forEach(item => {
      if (item.isRejected) {
        rejections.push({
          poItemIdx: item.poItemIdx,
          category: item.poItem.categoryId,
          orderedQty: item.poItem.qty,
          reason: item.rejectReason,
          note: item.rejectNote,
        })
        return
      }
      
      item.lots.forEach(lot => {
        if (lot.qtyToReceive <= 0) return
        
        allLots.push({
          poItemIdx: item.poItemIdx,
          id: item.poItem.id,
          category: item.poItem.categoryId,
          thickness: lot.actualThickness,
          width: lot.actualWidth,
          length: lot.actualLength,
          qtyReceived: lot.qtyToReceive,
          unitPrice: item.poItem.unitPrice,
          hasVariance: lot.hasVariance,
          varianceType: lot.varianceType,
          varianceNote: lot.varianceNote || (lot.hasVariance ? `Size: ${lot.actualThickness}x${lot.actualWidth}x${lot.actualLength} vs PO: ${item.poItem.thickness}x${item.poItem.width}x${item.poItem.length}` : ''),
          varianceReason: lot.varianceNote,
        })
      })
    })
    
    // Add additional items
    additionalItems.forEach(item => {
      allLots.push({
        poItemIdx: null,
        id: item.id,
        category: item.categoryId,
        thickness: item.thickness,
        width: item.width,
        length: item.length,
        qtyReceived: item.qty,
        unitPrice: item.unitPrice,
        hasVariance: true,
        varianceType: 'not_on_po',
        varianceNote: item.note || 'Additional item not on PO',
        varianceReason: item.note || 'Additional item not on PO',
        isAdditional: true,
      })
    })
    
    onSave({
      poId: po.id,
      grnDate,
      notes: grnNotes,
      items: allLots,
      rejections,
      hasVariance: totals.hasVariance,
      summary: totals,
    })
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6 max-h-[75vh] overflow-y-auto pr-2">
      {/* PO Info Header */}
      <div className="p-4 bg-gradient-to-r from-[#1A5276]/10 to-[#2ECC40]/10 rounded-lg border">
        <div className="grid grid-cols-5 gap-4 text-sm">
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO' : 'PO Number'}</div>
            <div className="font-bold text-[#1A5276] text-lg">{po.id}</div>
          </div>
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor'}</div>
            <div className="font-medium">{vendor?.name}</div>
          </div>
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'}</div>
            <div className="font-medium">{po.vendorInvoice || 'N/A'}</div>
          </div>
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</div>
            <Badge variant={po.type === 'import' ? 'info' : 'success'}>
              {po.type === 'import' ? 'üö¢ Import' : 'üè† Local'}
            </Badge>
          </div>
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö' : 'Receipt Date'}</div>
            <input
              type="date"
              required
              value={grnDate}
              onChange={(e) => setGrnDate(e.target.value)}
              className="mt-1 px-2 py-1 border rounded text-sm w-full"
            />
          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-600">
          {po.items.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô PO' : 'items in PO'}
        </div>
        <Button type="button" variant="outline" size="sm" icon={Plus} onClick={() => setShowAddItemModal(true)}>
          {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô PO)' : 'Add Item (Not in PO)'}
        </Button>
      </div>

      {/* Instructions */}
      <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm">
        <div className="flex items-start gap-2">
          <Info className="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" />
          <div className="text-blue-800">
            <strong>{lang === 'th' ? '‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:' : 'Tips:'}</strong>
            <span className="ml-1">
              {lang === 'th' 
                ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‚Ä¢ ‡πÉ‡∏ä‡πâ "‡πÅ‡∏¢‡∏Å‡∏•‡πá‡∏≠‡∏ï" ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î ‚Ä¢ ‡πÉ‡∏ä‡πâ "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò" ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'
                : 'Edit qty/size as received ‚Ä¢ Use "Split Lot" for multiple sizes ‚Ä¢ Use "Reject" if failed'}
            </span>
          </div>
        </div>
      </div>

      {/* Receipt Items */}
      <div className="space-y-4">
        {receiptItems.map((item, itemIdx) => {
          const poItem = item.poItem
          const ordered = poItem.qty - (poItem.qtyReceived || 0)
          const totalInLots = getTotalInLots(item)
          const remaining = ordered - totalInLots
          const isExpanded = expandedItems[itemIdx] !== false
          const hasAnyVariance = item.lots.some(l => l.hasVariance)
          
          return (
            <div 
              key={itemIdx} 
              className={`border rounded-lg overflow-hidden ${
                item.isRejected ? 'border-red-300 bg-red-50' :
                hasAnyVariance ? 'border-amber-300' :
                'border-gray-200'
              }`}
            >
              {/* Item Header */}
              <div 
                className={`px-4 py-3 flex items-center justify-between cursor-pointer ${
                  item.isRejected ? 'bg-red-100' :
                  hasAnyVariance ? 'bg-amber-50' :
                  'bg-gray-50'
                }`}
                onClick={() => toggleExpand(itemIdx)}
              >
                <div className="flex items-center gap-3">
                  <div className="text-gray-400">
                    {isExpanded ? <ChevronDown className="w-5 h-5" /> : <ChevronRight className="w-5 h-5" />}
                  </div>
                  <Badge variant="info">{poItem.categoryId}</Badge>
                  <div>
                    <span className="font-medium">{poItem.thickness} √ó {poItem.width} √ó {poItem.length} mm</span>
                    <span className="text-gray-500 text-sm ml-2">
                      (Ord: {ordered} | Lots: {totalInLots} | Left: {remaining})
                    </span>
                  </div>
                </div>
                
                <div className="flex items-center gap-2" onClick={(e) => e.stopPropagation()}>
                  {item.isRejected && (
                    <Badge variant="danger">‚ùå {lang === 'th' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Rejected'}</Badge>
                  )}
                  {hasAnyVariance && !item.isRejected && (
                    <Badge variant="warning">‚ö†Ô∏è Variance</Badge>
                  )}
                </div>
              </div>

              {/* Expanded Content */}
              {isExpanded && (
                <div className="p-4 border-t">
                  {item.isRejected ? (
                    <div className="text-center py-4">
                      <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-red-100 flex items-center justify-center">
                        <X className="w-6 h-6 text-red-500" />
                      </div>
                      <div className="font-bold text-red-700">
                        {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Item Rejected'}
                      </div>
                      <div className="text-sm text-red-600 mt-1">
                        {REJECTION_REASONS.find(r => r.id === item.rejectReason)?.[lang === 'th' ? 'labelTh' : 'labelEn']}
                        {item.rejectNote && ` - ${item.rejectNote}`}
                      </div>
                      <div className="mt-2 p-2 bg-yellow-100 rounded text-sm text-yellow-800">
                        <AlertTriangle className="w-4 h-4 inline mr-1" />
                        {lang === 'th' ? 'Vendor ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å Revised Invoice' : 'Vendor must issue Revised Invoice'}
                      </div>
                      <Button type="button" variant="outline" size="sm" className="mt-3" onClick={() => handleUnrejectItem(itemIdx)}>
                        <RotateCcw className="w-4 h-4 mr-1" /> {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Undo'}
                      </Button>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {item.lots.map((lot, lotIdx) => (
                        <div 
                          key={lot.id} 
                          className={`p-3 rounded-lg border ${
                            lot.hasVariance ? 'border-amber-300 bg-amber-50' : 'border-gray-200 bg-white'
                          }`}
                        >
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-medium text-gray-600">
                              <Layers className="w-4 h-4 inline mr-1" />
                              {lang === 'th' ? '‡∏•‡πá‡∏≠‡∏ï' : 'Lot'} #{lotIdx + 1}
                              {lot.hasVariance && <span className="ml-2 text-amber-600">‚ö†Ô∏è Size differs</span>}
                            </span>
                            {item.lots.length > 1 && (
                              <button type="button" onClick={() => removeLot(itemIdx, lotIdx)} className="p-1 text-red-500 hover:bg-red-50 rounded">
                                <Trash2 className="w-4 h-4" />
                              </button>
                            )}
                          </div>

                          <div className="grid grid-cols-6 gap-2">
                            <div>
                              <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'} *</label>
                              <input
                                type="number"
                                min="0"
                                value={lot.qtyToReceive}
                                onChange={(e) => updateLot(itemIdx, lotIdx, 'qtyToReceive', parseInt(e.target.value) || 0)}
                                className="w-full px-2 py-1.5 border rounded text-center font-bold"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-500 mb-1">T (mm)</label>
                              <input
                                type="number"
                                step="0.1"
                                value={lot.actualThickness}
                                onChange={(e) => updateLot(itemIdx, lotIdx, 'actualThickness', parseFloat(e.target.value) || 0)}
                                className={`w-full px-2 py-1.5 border rounded text-center ${lot.actualThickness !== poItem.thickness ? 'border-amber-400 bg-amber-50' : ''}`}
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-500 mb-1">W (mm)</label>
                              <input
                                type="number"
                                step="0.1"
                                value={lot.actualWidth}
                                onChange={(e) => updateLot(itemIdx, lotIdx, 'actualWidth', parseFloat(e.target.value) || 0)}
                                className={`w-full px-2 py-1.5 border rounded text-center ${lot.actualWidth !== poItem.width ? 'border-amber-400 bg-amber-50' : ''}`}
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-500 mb-1">L (mm)</label>
                              <input
                                type="number"
                                step="0.1"
                                value={lot.actualLength}
                                onChange={(e) => updateLot(itemIdx, lotIdx, 'actualLength', parseFloat(e.target.value) || 0)}
                                className={`w-full px-2 py-1.5 border rounded text-center ${lot.actualLength !== poItem.length ? 'border-amber-400 bg-amber-50' : ''}`}
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-gray-500 mb-1">CBM</label>
                              <div className="px-2 py-1.5 bg-gray-100 rounded text-center text-sm">
                                {((lot.actualThickness * lot.actualWidth * lot.actualLength * lot.qtyToReceive) / 1000000000).toFixed(3)}
                              </div>
                            </div>
                            <div>
                              <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</label>
                              <div className="px-2 py-1.5 bg-green-50 rounded text-center text-sm font-medium text-green-700">
                                ‡∏ø{(lot.qtyToReceive * poItem.unitPrice * (po.exchangeRate || 1)).toLocaleString()}
                              </div>
                            </div>
                          </div>

                          {lot.hasVariance && (
                            <div className="mt-2">
                              <input
                                type="text"
                                value={lot.varianceNote}
                                onChange={(e) => updateLot(itemIdx, lotIdx, 'varianceNote', e.target.value)}
                                placeholder={lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ variance...' : 'Variance note...'}
                                className="w-full px-2 py-1.5 border border-amber-300 rounded bg-amber-50 text-sm"
                              />
                            </div>
                          )}
                        </div>
                      ))}

                      {remaining !== 0 && (
                        <div className={`p-2 rounded text-sm text-center ${remaining > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                          {remaining > 0 ? `‚ö†Ô∏è ${remaining} pcs not assigned` : `‚ùå ${Math.abs(remaining)} pcs over-assigned`}
                        </div>
                      )}

                      <div className="flex items-center justify-between pt-2 border-t">
                        <Button type="button" variant="outline" size="sm" icon={Copy} onClick={() => addLotToItem(itemIdx)}>
                          {lang === 'th' ? '‡πÅ‡∏¢‡∏Å‡∏•‡πá‡∏≠‡∏ï' : 'Split Lot'}
                        </Button>
                        <Button type="button" variant="danger" size="sm" icon={X} onClick={() => { setRejectingItemIdx(itemIdx); setShowRejectModal(true); }}>
                          {lang === 'th' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Reject'}
                        </Button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          )
        })}
      </div>

      {/* Additional Items */}
      {additionalItems.length > 0 && (
        <div className="space-y-2">
          <h4 className="font-bold text-gray-700 flex items-center gap-2">
            <Plus className="w-4 h-4 text-blue-500" />
            {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô PO)' : 'Additional Items (Not in PO)'}
          </h4>
          {additionalItems.map((item, idx) => (
            <div key={idx} className="p-3 border-2 border-blue-300 bg-blue-50 rounded-lg flex items-center justify-between">
              <div>
                <span className="font-medium">{item.categoryId}</span>
                <span className="text-gray-600 ml-2">{item.thickness}√ó{item.width}√ó{item.length}mm √ó {item.qty}</span>
                {item.note && <span className="text-blue-600 ml-2 text-sm">({item.note})</span>}
              </div>
              <button type="button" onClick={() => removeAdditionalItem(idx)} className="p-1 text-red-500 hover:bg-red-100 rounded">
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          ))}
        </div>
      )}

      {/* Notes */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          {lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes'}
        </label>
        <textarea
          value={grnNotes}
          onChange={(e) => setGrnNotes(e.target.value)}
          rows={2}
          className="w-full px-3 py-2 border rounded-lg"
        />
      </div>

      {/* Summary */}
      <div className={`p-4 rounded-lg border ${totals.hasVariance ? 'border-amber-300 bg-amber-50' : 'border-green-300 bg-green-50'}`}>
        <div className="grid grid-cols-4 gap-4 text-center">
          <div>
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏•‡πá‡∏≠‡∏ï' : 'Lots'}</div>
            <div className="text-2xl font-bold text-blue-600">{totals.totalLots}</div>
          </div>
          <div>
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</div>
            <div className="text-2xl font-bold text-green-600">{totals.totalQty.toLocaleString()}</div>
          </div>
          <div>
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</div>
            <div className="text-xl font-bold text-emerald-600">‡∏ø{totals.totalValue.toLocaleString()}</div>
          </div>
          <div>
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Rejected'}</div>
            <div className="text-2xl font-bold text-red-600">{totals.totalRejected}</div>
          </div>
        </div>
        {totals.hasVariance && (
          <div className="mt-2 text-center text-sm text-amber-700">
            <AlertTriangle className="w-4 h-4 inline mr-1" />
            Variance detected - Report will be generated
          </div>
        )}
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>
          {lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Confirm Receipt'} ({totals.totalLots} lots)
        </Button>
      </div>

      {/* Modals */}
      {showRejectModal && rejectingItemIdx !== null && (
        <RejectItemModal
          item={receiptItems[rejectingItemIdx].poItem}
          lang={lang}
          onReject={(reason, note) => handleRejectItem(rejectingItemIdx, reason, note)}
          onCancel={() => { setShowRejectModal(false); setRejectingItemIdx(null); }}
        />
      )}

      {showAddItemModal && (
        <AddReceiptItemModal
          categories={categories}
          lang={lang}
          onAdd={handleAddAdditionalItem}
          onCancel={() => setShowAddItemModal(false)}
        />
      )}
    </form>
  )
}


// ============================================
// PRODUCTION MODULE (With Costing Analysis)
// ============================================
const ProductionModule = ({ workOrders, setWorkOrders, departments, customers, inventory, setInventory, categories, stores, salesOrders, lang }) => {
  const [activeTab, setActiveTab] = useState('po_tracker')
  const [showWOModal, setShowWOModal] = useState(false)
  const [showIssueModal, setShowIssueModal] = useState(false)
  const [selectedWO, setSelectedWO] = useState(null)
  const [filterDept, setFilterDept] = useState('all')
  const [filterStatus, setFilterStatus] = useState('all')
  const [expandedPOs, setExpandedPOs] = useState({})
  const [expandedWOs, setExpandedWOs] = useState({})
  const [expandedItems, setExpandedItems] = useState({})

  const tabs = [
    { id: 'po_tracker', label: lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° PO' : 'PO Tracker', icon: Package },
    { id: 'dashboard', label: lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°' : 'Dashboard', icon: BarChart3 },
    { id: 'orders', label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Orders', icon: ClipboardList },
    { id: 'floor', label: lang === 'th' ? '‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : 'Floor View', icon: Factory },
    { id: 'costing', label: lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô' : 'Costing', icon: Calculator },
  ]

  // PO Tracker Stats
  const poStats = {
    total: (salesOrders || []).length,
    awaitingProduction: (salesOrders || []).filter(so => so.status === 'confirmed' || so.status === 'pending').length,
    inProduction: (salesOrders || []).filter(so => so.status === 'in_production').length,
    ready: (salesOrders || []).filter(so => so.status === 'ready' || so.status === 'fg_complete').length,
    partialDelivered: (salesOrders || []).filter(so => so.status === 'partial').length,
    complete: (salesOrders || []).filter(so => so.status === 'delivered' || so.status === 'complete').length,
  }

  // Stats
  const stats = {
    total: workOrders.length,
    pending: workOrders.filter(wo => wo.status === 'pending').length,
    inProgress: workOrders.filter(wo => wo.status === 'in_progress').length,
    completed: workOrders.filter(wo => wo.status === 'completed').length,
    totalRevenue: workOrders.reduce((sum, wo) => sum + (wo.totalRevenue || 0), 0),
    totalCost: workOrders.reduce((sum, wo) => sum + (wo.costs?.total || 0), 0),
  }

  const handleStartOperation = (woId, dept) => {
    setWorkOrders(workOrders.map(wo => {
      if (wo.id !== woId) return wo
      const newOps = [...(wo.operations || []), {
        dept,
        status: 'in_progress',
        startTime: new Date().toISOString(),
        endTime: null,
        hours: 0,
        operator: 'Current User',
      }]
      return { ...wo, status: 'in_progress', operations: newOps }
    }))
  }

  const handleCompleteOperation = (woId, dept) => {
    setWorkOrders(workOrders.map(wo => {
      if (wo.id !== woId) return wo
      const newOps = wo.operations.map(op => {
        if (op.dept !== dept || op.status !== 'in_progress') return op
        const endTime = new Date()
        const startTime = new Date(op.startTime)
        const hours = (endTime - startTime) / (1000 * 60 * 60)
        return { ...op, status: 'completed', endTime: endTime.toISOString(), hours }
      })
      return { ...wo, operations: newOps }
    }))
  }

  const handleIssue = (wo) => {
    setSelectedWO(wo)
    setShowIssueModal(true)
  }

  const handleMaterialIssue = (issueData) => {
    // Deduct from inventory
    issueData.items.forEach(item => {
      setInventory(inv => inv.map(i => 
        i.lotNo === item.lotNo ? { ...i, qty: i.qty - item.qty } : i
      ))
    })

    // Update WO with issued materials
    setWorkOrders(workOrders.map(wo => {
      if (wo.id !== selectedWO.id) return wo
      const newIssued = [...(wo.materialsIssued || []), ...issueData.items]
      const materialCost = newIssued.reduce((sum, i) => sum + (i.cost || 0), 0)
      return {
        ...wo,
        materialsIssued: newIssued,
        costs: {
          ...wo.costs,
          material: materialCost,
          total: materialCost + (wo.costs?.labor || 0) + (wo.costs?.overhead || 0),
        },
      }
    }))
    
    setShowIssueModal(false)
    setSelectedWO(null)
  }

  // Filter WOs by department
  const filteredWOs = filterDept === 'all' 
    ? workOrders 
    : workOrders.filter(wo => wo.department === filterDept)

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.production', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô' : 'Manage production and costing'}</p>
        </div>
        <div className="flex gap-2">
          <select
            value={filterDept}
            onChange={(e) => setFilterDept(e.target.value)}
            className="px-3 py-2 border rounded-lg"
          >
            <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å' : 'All Depts'}</option>
            {departments.filter(d => d.isActive).map(d => (
              <option key={d.id} value={d.id}>{d.code} - {d.nameEn}</option>
            ))}
          </select>
          <Button icon={Plus} onClick={() => setShowWOModal(true)}>
            {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'New WO'}
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total'}</div>
          <div className="text-2xl font-bold text-gray-800">{stats.total}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-yellow-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠' : 'Pending'}</div>
          <div className="text-2xl font-bold text-yellow-600">{stats.pending}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ú‡∏•‡∏¥‡∏ï' : 'In Progress'}</div>
          <div className="text-2xl font-bold text-blue-600">{stats.inProgress}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à' : 'Completed'}</div>
          <div className="text-2xl font-bold text-green-600">{stats.completed}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-purple-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' : 'Revenue'}</div>
          <div className="text-2xl font-bold text-purple-600">{formatCurrency(stats.totalRevenue)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-red-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô' : 'Cost'}</div>
          <div className="text-2xl font-bold text-red-600">{formatCurrency(stats.totalCost)}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* ========== PO TRACKER TAB ========== */}
      {activeTab === 'po_tracker' && (
        <div className="space-y-6">
          {/* Status Summary Cards */}
          <div className="grid grid-cols-6 gap-4">
            <Card className={`p-4 bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200 cursor-pointer hover:shadow-md ${filterStatus === 'all' ? 'ring-2 ring-gray-500' : ''}`} onClick={() => setFilterStatus('all')}>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-gray-700">{poStats.total}</div>
                  <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total POs'}</div>
                </div>
                <ClipboardList className="w-8 h-8 text-gray-400" />
              </div>
            </Card>
            <Card className={`p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200 cursor-pointer hover:shadow-md ${filterStatus === 'awaiting' ? 'ring-2 ring-orange-500' : ''}`} onClick={() => setFilterStatus('awaiting')}>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-orange-600">{poStats.awaitingProduction}</div>
                  <div className="text-sm text-orange-500">{lang === 'th' ? '‡∏£‡∏≠‡∏ú‡∏•‡∏¥‡∏ï' : 'Awaiting'}</div>
                </div>
                <Clock className="w-8 h-8 text-orange-400" />
              </div>
            </Card>
            <Card className={`p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-200 cursor-pointer hover:shadow-md ${filterStatus === 'in_production' ? 'ring-2 ring-yellow-500' : ''}`} onClick={() => setFilterStatus('in_production')}>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-yellow-600">{poStats.inProduction}</div>
                  <div className="text-sm text-yellow-500">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Producing'}</div>
                </div>
                <Settings className="w-8 h-8 text-yellow-400" />
              </div>
            </Card>
            <Card className={`p-4 bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200 cursor-pointer hover:shadow-md ${filterStatus === 'ready' ? 'ring-2 ring-blue-500' : ''}`} onClick={() => setFilterStatus('ready')}>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-blue-600">{poStats.ready}</div>
                  <div className="text-sm text-blue-500">{lang === 'th' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' : 'Ready'}</div>
                </div>
                <CheckCircle2 className="w-8 h-8 text-blue-400" />
              </div>
            </Card>
            <Card className={`p-4 bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200 cursor-pointer hover:shadow-md ${filterStatus === 'partial' ? 'ring-2 ring-purple-500' : ''}`} onClick={() => setFilterStatus('partial')}>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-purple-600">{poStats.partialDelivered}</div>
                  <div className="text-sm text-purple-500">{lang === 'th' ? '‡∏™‡πà‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : 'Partial'}</div>
                </div>
                <Truck className="w-8 h-8 text-purple-400" />
              </div>
            </Card>
            <Card className={`p-4 bg-gradient-to-br from-green-50 to-green-100 border-green-200 cursor-pointer hover:shadow-md ${filterStatus === 'complete' ? 'ring-2 ring-green-500' : ''}`} onClick={() => setFilterStatus('complete')}>
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-green-600">{poStats.complete}</div>
                  <div className="text-sm text-green-500">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : 'Complete'}</div>
                </div>
                <CheckCircle className="w-8 h-8 text-green-400" />
              </div>
            </Card>
          </div>

          {/* Store Access Cards - Shows linked stores for Production */}
          <Card className="p-4 bg-gradient-to-r from-indigo-50 to-blue-50">
            <div className="flex items-center justify-between">
              <h4 className="font-bold text-indigo-700 flex items-center gap-2">
                <Database className="w-5 h-5" /> {lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠' : 'Linked Stores'}
              </h4>
              <div className="flex gap-3">
                <Badge className="bg-amber-100 text-amber-700">üì¶ RM Wood (STORE1)</Badge>
                <Badge className="bg-green-100 text-green-700">üì¶ IND2 (STORE2)</Badge>
                <Badge className="bg-orange-100 text-orange-700">üì¶ Consumables (STORE3)</Badge>
                <Badge className="bg-purple-100 text-purple-700">üì¶ FG (STORE6)</Badge>
              </div>
            </div>
          </Card>

          {/* PO Running Table - SAP/Odoo style with Production Mapping columns */}
          <Card className="overflow-hidden">
            <div className="px-4 py-3 bg-gradient-to-r from-indigo-600 to-blue-600 text-white flex justify-between items-center">
              <h3 className="font-bold flex items-center gap-2">
                <Package className="w-5 h-5" />
                {lang === 'th' ? 'PO Tracker - Production Plan from PO (‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï)' : 'PO Tracker - Production Plan from PO'}
              </h3>
              <div className="flex gap-2 text-xs">
                <Button size="sm" variant="outline" className="bg-white/20 border-white/30 text-white hover:bg-white/30">
                  <Download className="w-3 h-3 mr-1" /> Export
                </Button>
              </div>
            </div>
            
            {/* Table Header - EXACT columns from Production Plan from PO */}
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-100 sticky top-0">
                  <tr>
                    <th className="w-8 px-2 py-3"></th>
                    <th className="px-3 py-3 text-left font-semibold text-gray-700 whitespace-nowrap">Customer PO</th>
                    <th className="px-3 py-3 text-left font-semibold text-gray-700">Customer</th>
                    <th className="px-2 py-3 text-center font-semibold text-gray-700">Type</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700 whitespace-nowrap">Total Qty</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700">Produced</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700">Delivered</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700">Balance</th>
                    <th className="px-2 py-3 text-center font-semibold text-gray-700">PLN</th>
                    {/* Production Path columns - from Production Mapping */}
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-yellow-50 text-xs">Singh</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-yellow-50 text-xs">P1</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-gray-50 text-xs">QA</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-green-50 text-xs">P2</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-gray-50 text-xs">QA</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-cyan-50 text-xs">A1</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-gray-50 text-xs">QA</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-teal-50 text-xs">A2</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-gray-50 text-xs">QA</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-orange-50 text-xs">Oven</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-blue-50 text-xs">QC</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-purple-50 text-xs">FG</th>
                    <th className="px-1 py-3 text-center font-semibold text-gray-700 bg-pink-50 text-xs">Trans</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700">Status</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {(salesOrders || [])
                    .filter(so => {
                      if (filterStatus === 'all') return true
                      if (filterStatus === 'awaiting') return so.status === 'confirmed' || so.status === 'pending'
                      if (filterStatus === 'in_production') return so.status === 'in_production'
                      if (filterStatus === 'ready') return so.status === 'ready' || so.status === 'fg_complete'
                      if (filterStatus === 'partial') return so.status === 'partial'
                      if (filterStatus === 'complete') return so.status === 'delivered' || so.status === 'complete'
                      return true
                    })
                    .map(so => {
                      const customer = customers?.find(c => c.id === so.customerId)
                      const totalQty = so.items?.reduce((sum, i) => sum + (i.qty || 0), 0) || 0
                      const linkedWOs = workOrders.filter(wo => wo.soId === so.id || wo.customerPO === so.customerPO)
                      const producedQty = linkedWOs.reduce((sum, wo) => sum + (wo.completedQty || 0), 0)
                      const deliveredQty = so.items?.reduce((sum, i) => sum + (i.deliveredQty || 0), 0) || 0
                      const balanceQty = totalQty - deliveredQty
                      const isExpanded = expandedPOs[so.id]
                      
                      // Determine PLN scenario based on product type or customer
                      const plnScenario = so.productionScenario || so.items?.[0]?.productionScenario || 'PLN 1.1.1'
                      
                      // Production path progress (which depts have X)
                      const getPathProgress = (pln) => {
                        const paths = {
                          'PLN 0': { FG: true, Trans: true },
                          'PLN 1': { Singh: true, P1: true, QA1: true, FG: true, Trans: true },
                          'PLN 1.0.1': { Singh: true, P1: true, QA1: true, Oven: true, QC: true, FG: true, Trans: true },
                          'PLN 1.1.1': { Singh: true, P1: true, QA1: true, A1: true, QA3: true, QC: true, FG: true, Trans: true },
                          'PLN 1.1.2': { Singh: true, P1: true, QA1: true, A1: true, QA3: true, Oven: true, QC: true, FG: true, Trans: true },
                          'PLN 1.2.1': { Singh: true, P1: true, QA1: true, A2: true, QA4: true, QC: true, FG: true, Trans: true },
                          'PLN 1.2.2': { Singh: true, P1: true, QA1: true, A2: true, QA4: true, Oven: true, QC: true, FG: true, Trans: true },
                          'PLN 2': { P2: true, QA2: true, FG: true, Trans: true },
                          'PLN 2.0.1': { P2: true, QA2: true, Oven: true, QC: true, FG: true, Trans: true },
                          'PLN 2.1.1': { P2: true, QA2: true, A1: true, QA3: true, QC: true, FG: true, Trans: true },
                          'PLN 2.1.2': { P2: true, QA2: true, A1: true, QA3: true, Oven: true, QC: true, FG: true, Trans: true },
                          'PLN 2.2.1': { P2: true, QA2: true, A2: true, QA4: true, QC: true, FG: true, Trans: true },
                          'PLN 2.2.2': { P2: true, QA2: true, A2: true, QA4: true, Oven: true, QC: true, FG: true, Trans: true },
                        }
                        return paths[pln] || {}
                      }
                      
                      const pathProgress = getPathProgress(plnScenario)
                      
                      // Get current department based on WO status
                      const getCurrentDept = () => {
                        if (linkedWOs.length === 0) return null
                        const activeWO = linkedWOs.find(wo => wo.status === 'in_progress')
                        return activeWO?.department || linkedWOs[0]?.department
                      }
                      const currentDept = getCurrentDept()
                      
                      const getStatusBadge = (status) => {
                        const map = {
                          'confirmed': { bg: 'bg-gray-100', text: 'text-gray-700', label: '‚ö™ Await' },
                          'pending': { bg: 'bg-gray-100', text: 'text-gray-700', label: '‚ö™ Await' },
                          'in_production': { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'üü° Prod' },
                          'ready': { bg: 'bg-blue-100', text: 'text-blue-700', label: 'üîµ Ready' },
                          'fg_complete': { bg: 'bg-blue-100', text: 'text-blue-700', label: 'üîµ Ready' },
                          'partial': { bg: 'bg-orange-100', text: 'text-orange-700', label: 'üü† Partial' },
                          'delivered': { bg: 'bg-green-100', text: 'text-green-700', label: 'üü¢ Done' },
                          'complete': { bg: 'bg-green-100', text: 'text-green-700', label: 'üü¢ Done' },
                        }
                        return map[status] || { bg: 'bg-gray-100', text: 'text-gray-700', label: status }
                      }
                      const statusBadge = getStatusBadge(so.status)

                      return (
                        <React.Fragment key={so.id}>
                          {/* Main Row */}
                          <tr 
                            className={`hover:bg-gray-50 cursor-pointer ${isExpanded ? 'bg-blue-50' : ''}`}
                            onClick={() => setExpandedPOs(prev => ({ ...prev, [so.id]: !prev[so.id] }))}
                          >
                            <td className="px-2 py-3 text-center">
                              <ChevronRight className={`w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                            </td>
                            <td className="px-3 py-3">
                              <div className="font-mono font-bold text-blue-600 text-xs">{so.customerPO || so.id}</div>
                              <div className="text-[10px] text-gray-400">{formatDate(so.orderDate)}</div>
                            </td>
                            <td className="px-3 py-3">
                              <div className="font-medium text-sm">{customer?.name || 'Unknown'}</div>
                            </td>
                            <td className="px-2 py-3 text-center">
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${
                                so.orderType === 'PO' ? 'bg-green-100 text-green-700' :
                                so.orderType === 'PR' ? 'bg-blue-100 text-blue-700' :
                                'bg-yellow-100 text-yellow-700'
                              }`}>{so.orderType || 'PO'}</span>
                            </td>
                            <td className="px-3 py-3 text-center font-bold">{totalQty.toLocaleString()}</td>
                            <td className="px-3 py-3 text-center">
                              <span className={producedQty >= totalQty ? 'text-green-600 font-bold' : producedQty > 0 ? 'text-yellow-600' : 'text-gray-400'}>
                                {producedQty.toLocaleString()}
                              </span>
                            </td>
                            <td className="px-3 py-3 text-center">
                              <span className={deliveredQty >= totalQty ? 'text-green-600 font-bold' : deliveredQty > 0 ? 'text-blue-600' : 'text-gray-400'}>
                                {deliveredQty.toLocaleString()}
                              </span>
                            </td>
                            <td className="px-3 py-3 text-center">
                              <span className={balanceQty > 0 ? 'text-red-600 font-bold' : 'text-green-600'}>
                                {balanceQty.toLocaleString()}
                              </span>
                            </td>
                            <td className="px-2 py-3 text-center">
                              <span className="px-1.5 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-mono">{plnScenario}</span>
                            </td>
                            {/* Production Path X marks - from Production Mapping */}
                            <td className={`px-1 py-3 text-center ${pathProgress.Singh ? 'bg-yellow-100' : ''}`}>
                              {pathProgress.Singh && <span className={`text-xs font-bold ${currentDept === 'C1' ? 'text-green-600' : 'text-yellow-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.P1 ? 'bg-yellow-100' : ''}`}>
                              {pathProgress.P1 && <span className={`text-xs font-bold ${currentDept === 'P1' ? 'text-green-600' : 'text-yellow-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.QA1 ? 'bg-gray-100' : ''}`}>
                              {pathProgress.QA1 && <span className="text-xs font-bold text-gray-500">X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.P2 ? 'bg-green-100' : ''}`}>
                              {pathProgress.P2 && <span className={`text-xs font-bold ${currentDept === 'P2' ? 'text-green-600' : 'text-green-500'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.QA2 ? 'bg-gray-100' : ''}`}>
                              {pathProgress.QA2 && <span className="text-xs font-bold text-gray-500">X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.A1 ? 'bg-cyan-100' : ''}`}>
                              {pathProgress.A1 && <span className={`text-xs font-bold ${currentDept === 'A1' ? 'text-green-600' : 'text-cyan-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.QA3 ? 'bg-gray-100' : ''}`}>
                              {pathProgress.QA3 && <span className="text-xs font-bold text-gray-500">X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.A2 ? 'bg-teal-100' : ''}`}>
                              {pathProgress.A2 && <span className={`text-xs font-bold ${currentDept === 'A2' ? 'text-green-600' : 'text-teal-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.QA4 ? 'bg-gray-100' : ''}`}>
                              {pathProgress.QA4 && <span className="text-xs font-bold text-gray-500">X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.Oven ? 'bg-orange-100' : ''}`}>
                              {pathProgress.Oven && <span className={`text-xs font-bold ${currentDept === 'OVEN' ? 'text-green-600' : 'text-orange-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.QC ? 'bg-blue-100' : ''}`}>
                              {pathProgress.QC && <span className={`text-xs font-bold ${currentDept === 'QC' ? 'text-green-600' : 'text-blue-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.FG ? 'bg-purple-100' : ''}`}>
                              {pathProgress.FG && <span className={`text-xs font-bold ${currentDept === 'FG' ? 'text-green-600' : 'text-purple-600'}`}>X</span>}
                            </td>
                            <td className={`px-1 py-3 text-center ${pathProgress.Trans ? 'bg-pink-100' : ''}`}>
                              {pathProgress.Trans && <span className="text-xs font-bold text-pink-600">X</span>}
                            </td>
                            <td className="px-3 py-3 text-center">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${statusBadge.bg} ${statusBadge.text}`}>
                                {statusBadge.label}
                              </span>
                            </td>
                          </tr>

                          {/* Expanded Content - WO, BOM, Line Items */}
                          {isExpanded && (
                            <tr>
                              <td colSpan="24" className="p-0">
                                <div className="bg-gray-50 border-t border-l-4 border-l-blue-500 p-4">
                                  {/* Order Header */}
                                  <div className="flex flex-wrap gap-4 text-sm mb-4 bg-white p-3 rounded-lg">
                                    <div><span className="text-gray-500">Received:</span> <span className="font-medium text-green-600">{formatDate(so.receivedDate || so.orderDate)}</span></div>
                                    <div><span className="text-gray-500">Req. Delivery:</span> <span className="font-medium text-orange-600">{formatDate(so.requestedDeliveryDate || so.deliveryDate)}</span></div>
                                    <div><span className="text-gray-500">Location:</span> <span className="font-medium">{so.deliveryLocation || '-'}</span></div>
                                    <div><span className="text-gray-500">Terms:</span> <span className="font-medium">{so.paymentTerms || 30} days</span></div>
                                    <div><span className="text-gray-500">PLN Scenario:</span> <span className="font-mono font-bold text-indigo-600">{plnScenario}</span></div>
                                  </div>

                                  <div className="grid grid-cols-2 gap-4">
                                    {/* Left: Line Items & WO */}
                                    <div>
                                      <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <Package className="w-4 h-4" /> Line Items & Work Orders
                                      </h4>
                                      <table className="w-full text-sm bg-white rounded-lg overflow-hidden">
                                        <thead className="bg-gray-100">
                                          <tr>
                                            <th className="px-3 py-2 text-left text-xs">Item Code</th>
                                            <th className="px-3 py-2 text-left text-xs">Description</th>
                                            <th className="px-2 py-2 text-right text-xs">Qty</th>
                                            <th className="px-2 py-2 text-center text-xs">WO#</th>
                                            <th className="px-2 py-2 text-center text-xs">Status</th>
                                          </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                          {(so.items || []).map((item, idx) => {
                                            const itemWO = linkedWOs.find(wo => wo.productId === item.productId)
                                            return (
                                              <tr key={idx} className="hover:bg-gray-50">
                                                <td className="px-3 py-2 font-mono text-xs text-blue-600">{item.productId || item.itemCode}</td>
                                                <td className="px-3 py-2 text-xs">{item.productName || item.name}</td>
                                                <td className="px-2 py-2 text-right font-bold text-xs">{item.qty}</td>
                                                <td className="px-2 py-2 text-center">
                                                  {itemWO ? (
                                                    <span className="font-mono text-xs bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded">{itemWO.id}</span>
                                                  ) : (
                                                    <Button size="sm" className="h-5 text-xs px-2" onClick={(e) => { e.stopPropagation(); setShowWOModal(true); }}>+ WO</Button>
                                                  )}
                                                </td>
                                                <td className="px-2 py-2 text-center">
                                                  {itemWO && (
                                                    <Badge variant={itemWO.status === 'completed' ? 'success' : itemWO.status === 'in_progress' ? 'info' : 'warning'} className="text-xs">
                                                      {itemWO.status}
                                                    </Badge>
                                                  )}
                                                </td>
                                              </tr>
                                            )
                                          })}
                                        </tbody>
                                      </table>
                                    </div>

                                    {/* Right: BOM (Bill of Materials) */}
                                    <div>
                                      <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                        <FileText className="w-4 h-4" /> BOM (Bill of Materials)
                                      </h4>
                                      <div className="bg-white rounded-lg p-3">
                                        <table className="w-full text-sm">
                                          <thead className="bg-gray-100">
                                            <tr>
                                              <th className="px-2 py-2 text-left text-xs">Material</th>
                                              <th className="px-2 py-2 text-center text-xs">Store</th>
                                              <th className="px-2 py-2 text-right text-xs">Req Qty</th>
                                              <th className="px-2 py-2 text-right text-xs">Stock</th>
                                              <th className="px-2 py-2 text-center text-xs">Status</th>
                                            </tr>
                                          </thead>
                                          <tbody className="divide-y">
                                            {/* Sample BOM items - would come from product master */}
                                            <tr>
                                              <td className="px-2 py-2 text-xs">MLH Timber 40x40</td>
                                              <td className="px-2 py-2 text-center text-xs">
                                                <span className="bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">RM</span>
                                              </td>
                                              <td className="px-2 py-2 text-right text-xs font-medium">{(totalQty * 4).toLocaleString()}</td>
                                              <td className="px-2 py-2 text-right text-xs text-green-600">5,000</td>
                                              <td className="px-2 py-2 text-center">
                                                <span className="text-green-600 text-xs">‚úì OK</span>
                                              </td>
                                            </tr>
                                            <tr>
                                              <td className="px-2 py-2 text-xs">Nails 3 inch</td>
                                              <td className="px-2 py-2 text-center text-xs">
                                                <span className="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">CON</span>
                                              </td>
                                              <td className="px-2 py-2 text-right text-xs font-medium">{(totalQty * 20).toLocaleString()}</td>
                                              <td className="px-2 py-2 text-right text-xs text-green-600">50,000</td>
                                              <td className="px-2 py-2 text-center">
                                                <span className="text-green-600 text-xs">‚úì OK</span>
                                              </td>
                                            </tr>
                                            <tr>
                                              <td className="px-2 py-2 text-xs">Plywd 12mm</td>
                                              <td className="px-2 py-2 text-center text-xs">
                                                <span className="bg-green-100 text-green-700 px-1.5 py-0.5 rounded">IND2</span>
                                              </td>
                                              <td className="px-2 py-2 text-right text-xs font-medium">{totalQty.toLocaleString()}</td>
                                              <td className="px-2 py-2 text-right text-xs text-yellow-600">200</td>
                                              <td className="px-2 py-2 text-center">
                                                <span className="text-yellow-600 text-xs">‚ö† Low</span>
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                        <div className="mt-2 flex gap-2">
                                          <Button size="sm" variant="outline" className="text-xs">
                                            <Package className="w-3 h-3 mr-1" /> Issue Materials
                                          </Button>
                                          <Button size="sm" variant="outline" className="text-xs">
                                            <AlertTriangle className="w-3 h-3 mr-1" /> Create PR
                                          </Button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  {/* Production Path Visualization */}
                                  <div className="mt-4 bg-white p-3 rounded-lg">
                                    <h4 className="font-bold text-gray-700 mb-2">Production Path: {plnScenario}</h4>
                                    <div className="flex items-center gap-1 flex-wrap">
                                      {PRODUCTION_SCENARIOS.find(s => s.code === plnScenario)?.path.map((dept, idx, arr) => (
                                        <React.Fragment key={idx}>
                                          <div className={`px-3 py-1.5 rounded text-xs font-medium ${
                                            currentDept === dept ? 'bg-green-500 text-white animate-pulse' :
                                            'bg-gray-200 text-gray-700'
                                          }`}>
                                            {dept}
                                          </div>
                                          {idx < arr.length - 1 && <ArrowRight className="w-4 h-4 text-gray-400" />}
                                        </React.Fragment>
                                      )) || (
                                        <span className="text-gray-500 text-sm">Select PLN scenario</span>
                                      )}
                                    </div>
                                  </div>

                                  {/* Actions */}
                                  <div className="mt-3 flex gap-2">
                                    <Button size="sm" onClick={(e) => { e.stopPropagation(); setShowWOModal(true); }}>
                                      <Plus className="w-4 h-4 mr-1" /> Create WO
                                    </Button>
                                    <Button size="sm" variant="outline">
                                      <Package className="w-4 h-4 mr-1" /> Issue Materials
                                    </Button>
                                    <Button size="sm" variant="outline">
                                      <Eye className="w-4 h-4 mr-1" /> View BOM
                                    </Button>
                                  </div>
                                </div>
                              </td>
                            </tr>
                          )}
                        </React.Fragment>
                      )
                    })}
                  
                  {(!salesOrders || salesOrders.length === 0) && (
                    <tr>
                      <td colSpan="24" className="p-12 text-center text-gray-400">
                        <Package className="w-16 h-16 mx-auto mb-3 opacity-50" />
                        <div className="text-lg">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ PO' : 'No POs found'}</div>
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* Dashboard */}
      {activeTab === 'dashboard' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Active WOs */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Active Work Orders'}</h3>
            <div className="space-y-3">
              {workOrders.filter(wo => wo.status === 'in_progress').slice(0, 5).map(wo => {
                const customer = customers.find(c => c.id === wo.customerId)
                const progress = wo.quantity > 0 ? ((wo.completedQty || 0) / wo.quantity * 100) : 0
                return (
                  <div key={wo.id} className="p-3 bg-gray-50 rounded-lg">
                    <div className="flex items-center justify-between mb-2">
                      <div className="font-mono text-[#1A5276] font-medium">{wo.id}</div>
                      <Badge variant={wo.department === 'C1' ? 'danger' : wo.department === 'C2' ? 'orange' : 'info'}>
                        {wo.department}
                      </Badge>
                    </div>
                    <div className="text-sm text-gray-600">{wo.productName}</div>
                    <div className="text-xs text-gray-400">{customer?.name}</div>
                    <div className="mt-2">
                      <div className="flex justify-between text-xs text-gray-500 mb-1">
                        <span>{wo.completedQty || 0} / {wo.quantity}</span>
                        <span>{progress.toFixed(0)}%</span>
                      </div>
                      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-gradient-to-r from-[#1A5276] to-[#2ECC40]"
                          style={{ width: `${progress}%` }}
                        />
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </Card>

          {/* Department Status */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å' : 'Department Status'}</h3>
            <div className="grid grid-cols-2 gap-3">
              {departments.filter(d => d.isActive).slice(0, 6).map(dept => {
                const deptWOs = workOrders.filter(wo => wo.department === dept.id && wo.status === 'in_progress')
                const typeColor = DEPARTMENT_TYPES.find(t => t.id === dept.type)?.color || '#gray'
                return (
                  <div key={dept.id} className="p-3 rounded-lg border" style={{ borderLeftWidth: 4, borderLeftColor: typeColor }}>
                    <div className="flex items-center justify-between">
                      <div className="font-medium">{dept.code}</div>
                      <Badge variant={deptWOs.length > 0 ? 'success' : 'default'}>
                        {deptWOs.length} {lang === 'th' ? '‡∏á‡∏≤‡∏ô' : 'jobs'}
                      </Badge>
                    </div>
                    <div className="text-xs text-gray-500 mt-1">{dept.nameEn}</div>
                  </div>
                )
              })}
            </div>
          </Card>
        </div>
      )}

      {/* Work Orders List */}
      {activeTab === 'orders' && (
        <div className="space-y-4">
          {/* WO Filters and Actions */}
          <div className="flex justify-between items-center">
            <div className="flex gap-3">
              <select className="px-3 py-2 border rounded-lg text-sm">
                <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'All Status'}</option>
                <option value="pending">{lang === 'th' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Pending'}</option>
                <option value="in_progress">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'In Progress'}</option>
                <option value="completed">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : 'Completed'}</option>
              </select>
              <select className="px-3 py-2 border rounded-lg text-sm">
                <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å' : 'All Departments'}</option>
                {departments.filter(d => d.isActive).map(d => (
                  <option key={d.id} value={d.id}>{d.nameEn}</option>
                ))}
              </select>
            </div>
            <Button onClick={() => setShowWOModal(true)}>
              <Plus className="w-4 h-4 mr-1" /> {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á WO' : 'Create WO'}
            </Button>
          </div>

          {/* WO Running Table with Production Mapping Columns */}
          <Card className="overflow-hidden">
            <div className="px-4 py-3 bg-gradient-to-r from-orange-600 to-amber-600 text-white">
              <h3 className="font-bold flex items-center gap-2">
                <ClipboardList className="w-5 h-5" />
                {lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï (Work Orders)' : 'Work Orders - Production Mapping View'}
              </h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-100 sticky top-0">
                  <tr>
                    <th className="w-8 px-2 py-3"></th>
                    <th className="px-3 py-3 text-left font-semibold text-gray-700">WO #</th>
                    <th className="px-3 py-3 text-left font-semibold text-gray-700">Customer PO</th>
                    <th className="px-3 py-3 text-left font-semibold text-gray-700">Product</th>
                    <th className="px-2 py-3 text-center font-semibold text-gray-700">Qty</th>
                    <th className="px-2 py-3 text-center font-semibold text-gray-700">Done</th>
                    <th className="px-2 py-3 text-center font-semibold text-gray-700">PLN</th>
                    {/* Production Path columns */}
                    <th className="px-1 py-3 text-center font-semibold bg-yellow-50 text-xs">Singh</th>
                    <th className="px-1 py-3 text-center font-semibold bg-yellow-50 text-xs">P1</th>
                    <th className="px-1 py-3 text-center font-semibold bg-gray-50 text-xs">QA</th>
                    <th className="px-1 py-3 text-center font-semibold bg-green-50 text-xs">P2</th>
                    <th className="px-1 py-3 text-center font-semibold bg-cyan-50 text-xs">A1</th>
                    <th className="px-1 py-3 text-center font-semibold bg-teal-50 text-xs">A2</th>
                    <th className="px-1 py-3 text-center font-semibold bg-orange-50 text-xs">Oven</th>
                    <th className="px-1 py-3 text-center font-semibold bg-blue-50 text-xs">QC</th>
                    <th className="px-1 py-3 text-center font-semibold bg-purple-50 text-xs">FG</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700">Status</th>
                    <th className="px-3 py-3 text-center font-semibold text-gray-700">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {filteredWOs.map(wo => {
                    const customer = customers.find(c => c.id === wo.customerId)
                    const linkedSO = salesOrders?.find(so => so.id === wo.soId)
                    const plnScenario = wo.productionScenario || linkedSO?.productionScenario || 'PLN 1.1.1'
                    const isExpanded = expandedWOs[wo.id]
                    
                    // Get path progress based on WO current department
                    const getWOPathProgress = (dept) => {
                      const deptOrder = ['C1', 'P1', 'P2', 'A1', 'A2', 'OVEN', 'QC', 'FG']
                      const currentIdx = deptOrder.indexOf(dept)
                      return {
                        Singh: currentIdx >= 0,
                        P1: currentIdx >= 1 || dept === 'P1',
                        QA1: currentIdx >= 1,
                        P2: dept === 'P2' || (currentIdx >= 2 && plnScenario.includes('PLN 2')),
                        A1: currentIdx >= 3 || dept === 'A1',
                        A2: currentIdx >= 4 || dept === 'A2',
                        Oven: currentIdx >= 5 || dept === 'OVEN',
                        QC: currentIdx >= 6 || dept === 'QC',
                        FG: currentIdx >= 7 || dept === 'FG',
                      }
                    }
                    const pathProgress = getWOPathProgress(wo.department)
                    const progress = wo.quantity > 0 ? Math.round((wo.completedQty || 0) / wo.quantity * 100) : 0

                    return (
                      <React.Fragment key={wo.id}>
                        <tr 
                          className={`hover:bg-gray-50 cursor-pointer ${isExpanded ? 'bg-orange-50' : ''}`}
                          onClick={() => setExpandedWOs(prev => ({ ...prev, [wo.id]: !prev[wo.id] }))}
                        >
                          <td className="px-2 py-3 text-center">
                            <ChevronRight className={`w-4 h-4 text-gray-400 transition-transform ${isExpanded ? 'rotate-90' : ''}`} />
                          </td>
                          <td className="px-3 py-3">
                            <div className="font-mono text-orange-600 font-bold">{wo.id}</div>
                            <div className="text-xs text-gray-400">{formatDate(wo.createdAt)}</div>
                          </td>
                          <td className="px-3 py-3">
                            <div className="font-mono text-blue-600 text-xs">{linkedSO?.customerPO || wo.soId}</div>
                            <div className="text-xs text-gray-400">{customer?.name}</div>
                          </td>
                          <td className="px-3 py-3">
                            <div className="font-medium text-sm">{wo.productName}</div>
                            <div className="text-xs text-gray-400">{wo.materialType}</div>
                          </td>
                          <td className="px-2 py-3 text-center font-bold">{wo.quantity}</td>
                          <td className="px-2 py-3 text-center">
                            <span className={progress >= 100 ? 'text-green-600 font-bold' : progress > 0 ? 'text-yellow-600' : 'text-gray-400'}>
                              {wo.completedQty || 0}
                            </span>
                          </td>
                          <td className="px-2 py-3 text-center">
                            <span className="px-1.5 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs font-mono">{plnScenario}</span>
                          </td>
                          {/* Production Path X marks */}
                          <td className={`px-1 py-3 text-center ${pathProgress.Singh ? 'bg-yellow-100' : ''}`}>
                            {pathProgress.Singh && <span className={`text-xs font-bold ${wo.department === 'C1' ? 'text-green-600' : 'text-yellow-600'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.P1 ? 'bg-yellow-100' : ''}`}>
                            {pathProgress.P1 && <span className={`text-xs font-bold ${wo.department === 'P1' ? 'text-green-600' : 'text-yellow-600'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.QA1 ? 'bg-gray-100' : ''}`}>
                            {pathProgress.QA1 && <span className="text-xs font-bold text-gray-500">X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.P2 ? 'bg-green-100' : ''}`}>
                            {pathProgress.P2 && <span className={`text-xs font-bold ${wo.department === 'P2' ? 'text-green-600' : 'text-green-500'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.A1 ? 'bg-cyan-100' : ''}`}>
                            {pathProgress.A1 && <span className={`text-xs font-bold ${wo.department === 'A1' ? 'text-green-600' : 'text-cyan-600'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.A2 ? 'bg-teal-100' : ''}`}>
                            {pathProgress.A2 && <span className={`text-xs font-bold ${wo.department === 'A2' ? 'text-green-600' : 'text-teal-600'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.Oven ? 'bg-orange-100' : ''}`}>
                            {pathProgress.Oven && <span className={`text-xs font-bold ${wo.department === 'OVEN' ? 'text-green-600' : 'text-orange-600'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.QC ? 'bg-blue-100' : ''}`}>
                            {pathProgress.QC && <span className={`text-xs font-bold ${wo.department === 'QC' ? 'text-green-600' : 'text-blue-600'}`}>X</span>}
                          </td>
                          <td className={`px-1 py-3 text-center ${pathProgress.FG ? 'bg-purple-100' : ''}`}>
                            {pathProgress.FG && <span className={`text-xs font-bold ${wo.department === 'FG' ? 'text-green-600' : 'text-purple-600'}`}>X</span>}
                          </td>
                          <td className="px-3 py-3 text-center">
                            <Badge variant={
                              wo.status === 'completed' ? 'success' :
                              wo.status === 'in_progress' ? 'info' :
                              'warning'
                            }>
                              {wo.status === 'pending' ? '‚ö™ Pending' :
                               wo.status === 'in_progress' ? 'üü° Progress' :
                               wo.status === 'completed' ? 'üü¢ Done' : wo.status}
                            </Badge>
                          </td>
                          <td className="px-3 py-3 text-center">
                            <div className="flex items-center justify-center gap-1">
                              <button className="p-1 hover:bg-gray-100 rounded" title="Issue Materials" onClick={() => handleIssue(wo)}>
                                <Package className="w-4 h-4 text-blue-500" />
                              </button>
                              <button className="p-1 hover:bg-gray-100 rounded" title="View BOM">
                                <FileText className="w-4 h-4 text-green-500" />
                              </button>
                              <button className="p-1 hover:bg-gray-100 rounded" title="Print">
                                <Printer className="w-4 h-4 text-gray-500" />
                              </button>
                            </div>
                          </td>
                        </tr>

                        {/* Expanded WO Details - BOM and Production Log */}
                        {isExpanded && (
                          <tr>
                            <td colSpan="18" className="p-0">
                              <div className="bg-orange-50 border-t border-l-4 border-l-orange-500 p-4">
                                <div className="grid grid-cols-2 gap-4">
                                  {/* Left: BOM */}
                                  <div>
                                    <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                      <FileText className="w-4 h-4" /> BOM (Bill of Materials)
                                    </h4>
                                    <table className="w-full text-sm bg-white rounded-lg overflow-hidden">
                                      <thead className="bg-gray-100">
                                        <tr>
                                          <th className="px-2 py-2 text-left text-xs">Material</th>
                                          <th className="px-2 py-2 text-center text-xs">Store</th>
                                          <th className="px-2 py-2 text-right text-xs">Req</th>
                                          <th className="px-2 py-2 text-right text-xs">Issued</th>
                                          <th className="px-2 py-2 text-center text-xs">Status</th>
                                        </tr>
                                      </thead>
                                      <tbody className="divide-y">
                                        <tr>
                                          <td className="px-2 py-2 text-xs">{wo.materialType || 'MLH'} Timber</td>
                                          <td className="px-2 py-2 text-center"><span className="bg-amber-100 text-amber-700 px-1 py-0.5 rounded text-xs">RM</span></td>
                                          <td className="px-2 py-2 text-right text-xs">{(wo.quantity * 4).toLocaleString()}</td>
                                          <td className="px-2 py-2 text-right text-xs">{wo.status !== 'pending' ? (wo.quantity * 4).toLocaleString() : 0}</td>
                                          <td className="px-2 py-2 text-center">{wo.status !== 'pending' ? <span className="text-green-600 text-xs">‚úì</span> : <span className="text-gray-400 text-xs">-</span>}</td>
                                        </tr>
                                        <tr>
                                          <td className="px-2 py-2 text-xs">Nails 3"</td>
                                          <td className="px-2 py-2 text-center"><span className="bg-orange-100 text-orange-700 px-1 py-0.5 rounded text-xs">CON</span></td>
                                          <td className="px-2 py-2 text-right text-xs">{(wo.quantity * 20).toLocaleString()}</td>
                                          <td className="px-2 py-2 text-right text-xs">{wo.status !== 'pending' ? (wo.quantity * 20).toLocaleString() : 0}</td>
                                          <td className="px-2 py-2 text-center">{wo.status !== 'pending' ? <span className="text-green-600 text-xs">‚úì</span> : <span className="text-gray-400 text-xs">-</span>}</td>
                                        </tr>
                                      </tbody>
                                    </table>
                                  </div>

                                  {/* Right: Production Log */}
                                  <div>
                                    <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-2">
                                      <Clock className="w-4 h-4" /> Production Log
                                    </h4>
                                    <div className="bg-white rounded-lg p-3 space-y-2 text-sm">
                                      <div className="flex justify-between">
                                        <span className="text-gray-500">Created:</span>
                                        <span>{formatDate(wo.createdAt)} by {wo.createdBy || 'System'}</span>
                                      </div>
                                      <div className="flex justify-between">
                                        <span className="text-gray-500">Current Dept:</span>
                                        <Badge variant="info">{wo.department}</Badge>
                                      </div>
                                      <div className="flex justify-between">
                                        <span className="text-gray-500">Progress:</span>
                                        <span className="font-bold">{progress}%</span>
                                      </div>
                                      <div className="flex justify-between">
                                        <span className="text-gray-500">Material Cost:</span>
                                        <span>{formatCurrency(wo.costs?.material || 0)}</span>
                                      </div>
                                      <div className="flex justify-between">
                                        <span className="text-gray-500">Labor Cost:</span>
                                        <span>{formatCurrency(wo.costs?.labor || 0)}</span>
                                      </div>
                                      <div className="flex justify-between font-bold border-t pt-2">
                                        <span>Total Cost:</span>
                                        <span className="text-orange-600">{formatCurrency(wo.costs?.total || 0)}</span>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                {/* Production Path Visualization */}
                                <div className="mt-4 bg-white p-3 rounded-lg">
                                  <h4 className="font-bold text-gray-700 mb-2">Production Path: {plnScenario}</h4>
                                  <div className="flex items-center gap-1 flex-wrap">
                                    {PRODUCTION_SCENARIOS.find(s => s.code === plnScenario)?.path.map((dept, idx, arr) => (
                                      <React.Fragment key={idx}>
                                        <div className={`px-3 py-1.5 rounded text-xs font-medium ${
                                          wo.department === dept ? 'bg-orange-500 text-white animate-pulse' :
                                          pathProgress[dept] ? 'bg-green-100 text-green-700' :
                                          'bg-gray-200 text-gray-500'
                                        }`}>
                                          {wo.department === dept ? 'üü°' : pathProgress[dept] ? '‚úÖ' : '‚ö™'} {dept}
                                        </div>
                                        {idx < arr.length - 1 && <ArrowRight className="w-4 h-4 text-gray-400" />}
                                      </React.Fragment>
                                    )) || <span className="text-gray-500">No scenario selected</span>}
                                  </div>
                                </div>

                                {/* Actions */}
                                <div className="mt-3 flex gap-2">
                                  <Button size="sm" variant="outline">
                                    <Package className="w-4 h-4 mr-1" /> Issue Materials
                                  </Button>
                                  <Button size="sm" variant="outline">
                                    <ArrowRight className="w-4 h-4 mr-1" /> Move to Next Dept
                                  </Button>
                                  <Button size="sm" variant="outline">
                                    <CheckCircle className="w-4 h-4 mr-1" /> Complete WO
                                  </Button>
                                </div>
                              </div>
                            </td>
                          </tr>
                        )}
                      </React.Fragment>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* Floor View */}
      {activeTab === 'floor' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {departments.filter(d => d.isActive).map(dept => {
            const deptWOs = workOrders.filter(wo => wo.department === dept.id)
            const activeWOs = deptWOs.filter(wo => wo.status === 'in_progress')
            const typeColor = DEPARTMENT_TYPES.find(t => t.id === dept.type)?.color || '#6B7280'
            
            return (
              <Card key={dept.id} className="overflow-hidden">
                <div className="p-4" style={{ backgroundColor: typeColor + '20' }}>
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-bold text-gray-800">{dept.code}</div>
                      <div className="text-sm text-gray-600">{dept.nameEn}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-bold" style={{ color: typeColor }}>{activeWOs.length}</div>
                      <div className="text-xs text-gray-500">{lang === 'th' ? '‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' : 'active'}</div>
                    </div>
                  </div>
                </div>
                <div className="p-4 space-y-2">
                  {activeWOs.length === 0 ? (
                    <p className="text-sm text-gray-400 text-center py-4">
                      {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô' : 'No active jobs'}
                    </p>
                  ) : (
                    activeWOs.map(wo => (
                      <div key={wo.id} className="p-2 bg-gray-50 rounded flex items-center justify-between">
                        <div>
                          <div className="font-mono text-sm text-[#1A5276]">{wo.id}</div>
                          <div className="text-xs text-gray-500">{wo.productName}</div>
                        </div>
                        <Button 
                          size="sm" 
                          variant="success"
                          onClick={() => handleCompleteOperation(wo.id, dept.id)}
                        >
                          ‚úì
                        </Button>
                      </div>
                    ))
                  )}
                </div>
              </Card>
            )
          })}
        </div>
      )}

      {/* Costing Tab - THE FEATURE USER LOVES */}
      {activeTab === 'costing' && (
        <ProductionCosting workOrders={workOrders} customers={customers} lang={lang} />
      )}

      {/* WO Form Modal */}
      {showWOModal && (
        <Modal isOpen={showWOModal} onClose={() => setShowWOModal(false)} title={lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'New Work Order'} size="lg">
          <WorkOrderForm
            customers={customers}
            departments={departments}
            inventory={inventory}
            categories={categories}
            salesOrders={salesOrders}
            workOrders={workOrders}
            lang={lang}
            onSave={(woData) => {
              const newWO = {
                id: `WO-${new Date().getFullYear().toString().slice(-2)}${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(workOrders.length + 1).padStart(3, '0')}`,
                ...woData,
                status: 'pending',
                completedQty: 0,
                operations: [],
                materialsIssued: [],
                costs: { material: 0, labor: 0, overhead: 0, total: 0, perUnit: 0 },
                profit: { amount: 0, margin: 0 },
                createdAt: new Date().toISOString().split('T')[0],
              }
              setWorkOrders([...workOrders, newWO])
              setShowWOModal(false)
            }}
            onCancel={() => setShowWOModal(false)}
          />
        </Modal>
      )}

      {/* Material Issue Modal */}
      {showIssueModal && selectedWO && (
        <Modal isOpen={showIssueModal} onClose={() => setShowIssueModal(false)} title={lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Issue Materials'} size="lg">
          <MaterialIssueForm
            wo={selectedWO}
            inventory={inventory}
            lang={lang}
            onIssue={handleMaterialIssue}
            onCancel={() => setShowIssueModal(false)}
          />
        </Modal>
      )}
    </div>
  )
}

// ============================================
// OCR PO DOCUMENT UPLOAD COMPONENT
// ============================================
const PODocumentUpload = ({ onExtracted, existingDoc, lang }) => {
  const [uploading, setUploading] = useState(false)
  const [ocrProgress, setOcrProgress] = useState(0)
  const [extractedData, setExtractedData] = useState(null)
  const [documentData, setDocumentData] = useState(existingDoc || null)
  const fileInputRef = useRef(null)

  const handleFileUpload = async (e) => {
    const file = e.target.files[0]
    if (!file) return

    setUploading(true)
    setOcrProgress(0)

    // Simulate OCR processing
    const interval = setInterval(() => {
      setOcrProgress(prev => Math.min(prev + 15, 90))
    }, 300)

    // Simulated OCR extraction
    setTimeout(() => {
      clearInterval(interval)
      setOcrProgress(100)
      
      const simulatedExtraction = {
        poNumber: `PO.RPR${new Date().getFullYear().toString().slice(-2)}${String(Math.floor(Math.random()*9000)+1000)}`,
        poDate: new Date().toISOString().split('T')[0],
        items: [
          { itemCode: '21029994', description: 'PT 950 X 1400', qty: 100, uom: 'SET', price: 727.90 },
          { itemCode: '21029995', description: 'PT 950 X 1580', qty: 150, uom: 'SET', price: 785.50 },
        ],
        totalAmount: 190597.50,
        confidence: 92,
        rawText: `PURCHASE ORDER\nPO Number: ${`PO.RPR${new Date().getFullYear().toString().slice(-2)}${String(Math.floor(Math.random()*9000)+1000)}`}\nDate: ${new Date().toLocaleDateString()}\n\nItems:\n1. PT 950 X 1400 - 100 SET @ 727.90\n2. PT 950 X 1580 - 150 SET @ 785.50\n\nTotal: 190,597.50 THB`
      }

      setExtractedData(simulatedExtraction)
      setDocumentData({
        filename: file.name,
        uploadedAt: new Date().toISOString(),
        size: file.size,
      })
      setUploading(false)

      if (onExtracted) {
        onExtracted(simulatedExtraction, { filename: file.name, uploadedAt: new Date().toISOString() })
      }
    }, 2500)
  }

  return (
    <div className="space-y-4">
      {/* Upload Area */}
      <div 
        className={`border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors ${
          uploading ? 'border-blue-400 bg-blue-50' : 'border-yellow-400 bg-yellow-50 hover:bg-yellow-100'
        }`}
        onClick={() => !uploading && fileInputRef.current?.click()}
      >
        <input
          ref={fileInputRef}
          type="file"
          accept=".pdf,.png,.jpg,.jpeg"
          className="hidden"
          onChange={handleFileUpload}
        />
        
        {uploading ? (
          <div className="space-y-3">
            <Loader2 className="w-10 h-10 mx-auto text-blue-500 animate-spin" />
            <div className="text-blue-600 font-medium">
              {lang === 'th' ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô OCR... ${ocrProgress}%` : `Processing OCR... ${ocrProgress}%`}
            </div>
            <div className="w-64 mx-auto h-2 bg-gray-200 rounded-full overflow-hidden">
              <div className="h-full bg-blue-500 transition-all" style={{ width: `${ocrProgress}%` }} />
            </div>
          </div>
        ) : (
          <div className="space-y-2">
            <Upload className="w-10 h-10 mx-auto text-yellow-600" />
            <div className="font-medium text-yellow-800">
              üìÑ {lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î PO (OCR)' : 'Upload PO Document (OCR)'}
            </div>
            <div className="text-sm text-yellow-600">
              {lang === 'th' ? '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PDF, PNG, JPG - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : 'Supports PDF, PNG, JPG - Auto-extract PO data'}
            </div>
          </div>
        )}
      </div>

      {/* Extracted Data Preview */}
      {extractedData && (
        <div className="bg-green-50 border border-green-200 rounded-lg p-4 space-y-3">
          <div className="flex items-center justify-between">
            <h4 className="font-bold text-green-800 flex items-center gap-2">
              <CheckCircle className="w-5 h-5" />
              {lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ' : 'Extracted Data'}
            </h4>
            <Badge variant="success" className="text-xs">
              {extractedData.confidence}% {lang === 'th' ? '‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥' : 'confidence'}
            </Badge>
          </div>

          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span className="text-gray-500">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç PO:' : 'PO#:'}</span>
              <span className="ml-2 font-bold text-green-700">{extractedData.poNumber}</span>
            </div>
            <div>
              <span className="text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:' : 'Date:'}</span>
              <span className="ml-2 font-medium">{formatDate(extractedData.poDate)}</span>
            </div>
          </div>

          {extractedData.items && extractedData.items.length > 0 && (
            <div className="mt-2">
              <div className="text-sm text-gray-500 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:' : 'Items:'}</div>
              <div className="bg-white rounded border p-2 text-sm space-y-1">
                {extractedData.items.map((item, idx) => (
                  <div key={idx} className="flex justify-between">
                    <span>{item.description}</span>
                    <span className="text-gray-600">{item.qty} {item.uom}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="flex gap-2 mt-3">
            <Button size="sm" variant="success" onClick={() => {
              if (onExtracted) onExtracted(extractedData, documentData)
              alert(lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : 'Data applied successfully')
            }}>
              <Check className="w-4 h-4 mr-1" /> {lang === 'th' ? '‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ' : 'Apply Data'}
            </Button>
            <Button size="sm" variant="outline" onClick={() => setExtractedData(null)}>
              <X className="w-4 h-4 mr-1" /> {lang === 'th' ? '‡∏•‡πâ‡∏≤‡∏á' : 'Clear'}
            </Button>
          </div>
        </div>
      )}

      {/* Existing Document */}
      {documentData && !extractedData && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <FileText className="w-5 h-5 text-blue-600" />
            <div>
              <div className="font-medium text-blue-800">{documentData.filename}</div>
              <div className="text-xs text-blue-500">{lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠' : 'Uploaded'}: {formatDate(documentData.uploadedAt)}</div>
            </div>
          </div>
          <Button size="sm" variant="ghost" onClick={() => fileInputRef.current?.click()}>
            <RefreshCw className="w-4 h-4" />
          </Button>
        </div>
      )}
    </div>
  )
}

// ============================================
// PRODUCTION COSTING (Customer Profitability & WO Analysis)
// ============================================
const ProductionCosting = ({ workOrders, customers, lang }) => {
  const completedWOs = workOrders.filter(wo => wo.status === 'completed' || wo.status === 'delivered')
  
  const totalRevenue = completedWOs.reduce((sum, wo) => sum + (wo.totalRevenue || 0), 0)
  const totalCost = completedWOs.reduce((sum, wo) => sum + (wo.costs?.total || 0), 0)
  const totalProfit = totalRevenue - totalCost
  const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0

  // Customer profitability analysis
  const customerStats = customers.map(cust => {
    const custWOs = completedWOs.filter(wo => wo.customerId === cust.id)
    const revenue = custWOs.reduce((sum, wo) => sum + (wo.totalRevenue || 0), 0)
    const cost = custWOs.reduce((sum, wo) => sum + (wo.costs?.total || 0), 0)
    return {
      ...cust,
      orders: custWOs.length,
      revenue,
      cost,
      profit: revenue - cost,
      margin: revenue > 0 ? ((revenue - cost) / revenue * 100) : 0,
    }
  }).filter(c => c.orders > 0).sort((a, b) => b.profit - a.profit)

  return (
    <div className="space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-4 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Total Revenue'}</div>
          <div className="text-2xl font-bold text-gray-800">{formatCurrency(totalRevenue)}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°' : 'Total Cost'}</div>
          <div className="text-2xl font-bold text-red-600">{formatCurrency(totalCost)}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°' : 'Total Profit'}</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(totalProfit)}</div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' : 'Avg Margin'}</div>
          <div className={`text-2xl font-bold ${avgMargin >= 20 ? 'text-green-600' : avgMargin >= 10 ? 'text-amber-600' : 'text-red-600'}`}>
            {avgMargin.toFixed(1)}%
          </div>
        </Card>
      </div>

      {/* Customer Profitability Ranking */}
      <Card className="p-5">
        <h3 className="font-bold text-gray-800 mb-4">
          {lang === 'th' ? '‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Profitability Ranking'}
        </h3>
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö' : 'Rank'}</th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'Orders'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' : 'Revenue'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô' : 'Cost'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Å‡∏≥‡πÑ‡∏£' : 'Profit'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡πÑ‡∏£' : 'Margin'}</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {customerStats.map((cust, idx) => (
              <tr key={cust.id} className="hover:bg-gray-50">
                <td className="px-4 py-3">
                  <span className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                    idx === 0 ? 'bg-yellow-100 text-yellow-700' : 
                    idx === 1 ? 'bg-gray-200 text-gray-700' : 
                    idx === 2 ? 'bg-amber-100 text-amber-700' : 
                    'bg-gray-100 text-gray-500'
                  }`}>
                    {idx + 1}
                  </span>
                </td>
                <td className="px-4 py-3 font-medium text-gray-800">{cust.name}</td>
                <td className="px-4 py-3 text-right">{cust.orders}</td>
                <td className="px-4 py-3 text-right">{formatCurrency(cust.revenue)}</td>
                <td className="px-4 py-3 text-right text-red-600">{formatCurrency(cust.cost)}</td>
                <td className="px-4 py-3 text-right font-bold text-green-600">{formatCurrency(cust.profit)}</td>
                <td className="px-4 py-3 text-right">
                  <span className={`font-medium ${cust.margin >= 20 ? 'text-green-600' : cust.margin >= 10 ? 'text-amber-600' : 'text-red-600'}`}>
                    {cust.margin.toFixed(1)}%
                  </span>
                </td>
              </tr>
            ))}
            {customerStats.length === 0 && (
              <tr>
                <td colSpan="7" className="px-4 py-8 text-center text-gray-400">
                  {lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : 'No completed production data yet'}
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </Card>

      {/* Work Order Cost Details */}
      <Card className="p-5">
        <h3 className="font-bold text-gray-800 mb-4">
          {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Order Cost Details'}
        </h3>
        <table className="w-full text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-3 py-2 text-left font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'WO #'}</th>
              <th className="px-3 py-2 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Material'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô' : 'Labor'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡πÇ‡∏™‡∏´‡∏∏‡πâ‡∏¢' : 'Overhead'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢' : '$/Unit'}</th>
              <th className="px-3 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Å‡∏≥‡πÑ‡∏£' : 'Margin'}</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {workOrders.slice(0, 10).map(wo => (
              <tr key={wo.id} className="hover:bg-gray-50">
                <td className="px-3 py-2 font-mono text-[#1A5276]">{wo.id}</td>
                <td className="px-3 py-2">{wo.productName}</td>
                <td className="px-3 py-2 text-right">{wo.quantity}</td>
                <td className="px-3 py-2 text-right">{formatCurrency(wo.costs?.material || 0)}</td>
                <td className="px-3 py-2 text-right">{formatCurrency(wo.costs?.labor || 0)}</td>
                <td className="px-3 py-2 text-right">{formatCurrency(wo.costs?.overhead || 0)}</td>
                <td className="px-3 py-2 text-right font-medium">{formatCurrency(wo.costs?.total || 0)}</td>
                <td className="px-3 py-2 text-right">{formatCurrency(wo.costs?.perUnit || 0)}</td>
                <td className="px-3 py-2 text-right">
                  <span className={`font-medium ${(wo.profit?.margin || 0) >= 20 ? 'text-green-600' : (wo.profit?.margin || 0) >= 10 ? 'text-amber-600' : 'text-red-600'}`}>
                    {(wo.profit?.margin || 0).toFixed(1)}%
                  </span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </Card>
    </div>
  )
}

// ============================================
// WORK ORDER FORM
// ============================================
const WorkOrderForm = ({ wo, customers, departments, inventory, categories, salesOrders, workOrders, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    customerId: wo?.customerId || '',
    soId: wo?.soId || '',
    productName: wo?.productName || '',
    quantity: wo?.quantity || 0,
    materialType: wo?.materialType || '',
    department: wo?.department || '',
    priority: wo?.priority || 'medium',
    targetDate: wo?.targetDate || '',
    totalRevenue: wo?.totalRevenue || 0,
    entity: wo?.entity || 'IND',
  })

  // Get available SOs (not already linked to a WO)
  const linkedSOIds = workOrders?.map(w => w.soId).filter(Boolean) || []
  const availableSOs = salesOrders?.filter(so => 
    !linkedSOIds.includes(so.id) && 
    so.status !== 'delivered'
  ) || []

  const handleSOSelect = (soId) => {
    const selectedSO = salesOrders?.find(so => so.id === soId)
    if (selectedSO) {
      // Auto-fill from SO
      const firstItem = selectedSO.items?.[0]
      setFormData({
        ...formData,
        soId: soId,
        customerId: selectedSO.customerId,
        productName: firstItem?.productName || formData.productName,
        quantity: firstItem?.qty || formData.quantity,
        totalRevenue: selectedSO.subtotal || formData.totalRevenue,
        targetDate: selectedSO.items?.[0]?.deliverySchedule?.[0]?.deliveryDate || selectedSO.deliveryDate || formData.targetDate,
      })
    } else {
      setFormData({ ...formData, soId: soId })
    }
  }

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  const rmCategories = categories.filter(c => c.type === 'raw_material')

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Link to Sales Order - Production creates WO from SO */}
      <Card className="p-4 bg-blue-50 border-blue-200">
        <div className="flex items-center gap-2 mb-3">
          <ClipboardList className="w-5 h-5 text-blue-600" />
          <span className="font-medium text-blue-800">{lang === 'th' ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Link to Sales Order'}</span>
        </div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Select Sales Order'}
            </label>
            <select
              value={formData.soId}
              onChange={(e) => handleSOSelect(e.target.value)}
              className="w-full px-3 py-2 border rounded-lg bg-white"
            >
              <option value="">{lang === 'th' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SO --' : '-- Select SO --'}</option>
              {availableSOs.map(so => {
                const customer = customers.find(c => c.id === so.customerId)
                return (
                  <option key={so.id} value={so.id}>
                    {so.id} - {customer?.name} ({so.customerPO})
                  </option>
                )
              })}
            </select>
            {availableSOs.length === 0 && (
              <p className="text-xs text-orange-600 mt-1">
                {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ SO ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ú‡∏•‡∏¥‡∏ï' : 'No pending SOs available'}
              </p>
            )}
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏´‡∏£‡∏∑‡∏≠ ‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏Ç SO' : 'Or Enter SO #'}
            </label>
            <input
              type="text"
              value={formData.soId}
              onChange={(e) => setFormData({ ...formData, soId: e.target.value })}
              className="w-full px-3 py-2 border rounded-lg"
              placeholder="SO-2501-001"
            />
          </div>
        </div>
      </Card>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *' : 'Customer *'}
          </label>
          <select
            required
            value={formData.customerId}
            onChange={(e) => setFormData({ ...formData, customerId: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
            {customers.map(c => (
              <option key={c.id} value={c.id}>{c.name}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Entity'}
          </label>
          <select
            value={formData.entity}
            onChange={(e) => setFormData({ ...formData, entity: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="IND">IND Thai Packwell</option>
            <option value="IND2">IND-2 Thai Packwell</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          {lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *' : 'Product Name *'}
        </label>
        <input
          type="text"
          required
          value={formData.productName}
          onChange={(e) => setFormData({ ...formData, productName: e.target.value })}
          className="w-full px-3 py-2 border rounded-lg"
          placeholder="Pallet 1100x950x950"
        />
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô *' : 'Quantity *'}
          </label>
          <input
            type="number"
            required
            value={formData.quantity}
            onChange={(e) => setFormData({ ...formData, quantity: parseInt(e.target.value) || 0 })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏™‡∏î‡∏∏ *' : 'Material Type *'}
          </label>
          <select
            required
            value={formData.materialType}
            onChange={(e) => setFormData({ ...formData, materialType: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' : 'Select'}</option>
            {rmCategories.map(c => (
              <option key={c.id} value={c.id}>{c.code} - {c.nameEn}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Revenue'}
          </label>
          <input
            type="number"
            value={formData.totalRevenue}
            onChange={(e) => setFormData({ ...formData, totalRevenue: parseFloat(e.target.value) || 0 })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å *' : 'Department *'}
          </label>
          <select
            required
            value={formData.department}
            onChange={(e) => setFormData({ ...formData, department: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' : 'Select'}</option>
            {departments.filter(d => d.isActive).map(d => (
              <option key={d.id} value={d.id}>{d.code} - {d.nameEn}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç' : 'Priority'}
          </label>
          <select
            value={formData.priority}
            onChange={(e) => setFormData({ ...formData, priority: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="low">{lang === 'th' ? '‡∏ï‡πà‡∏≥' : 'Low'}</option>
            <option value="medium">{lang === 'th' ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : 'Medium'}</option>
            <option value="high">{lang === 'th' ? '‡∏™‡∏π‡∏á' : 'High'}</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á' : 'Target Date'}
          </label>
          <input
            type="date"
            value={formData.targetDate}
            onChange={(e) => setFormData({ ...formData, targetDate: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>{t('action.save', lang)}</Button>
      </div>
    </form>
  )
}

// ============================================
// MATERIAL ISSUE FORM
// ============================================
const MaterialIssueForm = ({ wo, inventory, onIssue, onCancel, lang }) => {
  const [selectedItems, setSelectedItems] = useState([])
  
  // Filter inventory by material type
  const availableInventory = inventory.filter(i => 
    i.category === wo.materialType && i.qty > 0
  )

  const toggleItem = (item, qty) => {
    const existing = selectedItems.find(i => i.lotNo === item.lotNo)
    if (existing) {
      setSelectedItems(selectedItems.filter(i => i.lotNo !== item.lotNo))
    } else {
      setSelectedItems([...selectedItems, { ...item, issueQty: qty || item.qty }])
    }
  }

  const updateQty = (lotNo, qty) => {
    setSelectedItems(selectedItems.map(i => 
      i.lotNo === lotNo ? { ...i, issueQty: qty } : i
    ))
  }

  const totalCost = selectedItems.reduce((sum, i) => {
    const unitCost = i.cost / i.qty
    return sum + (i.issueQty * unitCost)
  }, 0)

  const handleSubmit = () => {
    onIssue({
      woId: wo.id,
      items: selectedItems.map(i => ({
        lotNo: i.lotNo,
        category: i.category,
        code: i.code,
        qty: i.issueQty,
        cost: (i.cost / i.qty) * i.issueQty,
      }))
    })
  }

  return (
    <div className="space-y-4">
      {/* WO Info */}
      <div className="p-4 bg-gray-50 rounded-lg">
        <div className="grid grid-cols-3 gap-4 text-sm">
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Order'}</div>
            <div className="font-bold text-[#1A5276]">{wo.id}</div>
          </div>
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</div>
            <div className="font-medium">{wo.productName}</div>
          </div>
          <div>
            <div className="text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Material'}</div>
            <Badge variant="info">{wo.materialType}</Badge>
          </div>
        </div>
      </div>

      {/* Available Inventory */}
      <div>
        <label className="text-sm font-medium text-gray-700 mb-2 block">
          {lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ' : 'Available Inventory'} ({wo.materialType})
        </label>
        <div className="border rounded-lg max-h-60 overflow-y-auto">
          {availableInventory.length === 0 ? (
            <div className="p-4 text-center text-gray-400">
              {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ' : 'No inventory available for this material type'}
            </div>
          ) : (
            <table className="w-full text-sm">
              <thead className="bg-gray-50 sticky top-0">
                <tr>
                  <th className="px-3 py-2 text-left"></th>
                  <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏•‡πá‡∏≠‡∏ï' : 'Lot'}</th>
                  <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                  <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏°‡∏µ' : 'Avail'}</th>
                  <th className="px-3 py-2 text-right">{lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å' : 'Issue'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {availableInventory.map(item => {
                  const selected = selectedItems.find(i => i.lotNo === item.lotNo)
                  return (
                    <tr key={item.lotNo} className={`hover:bg-gray-50 ${selected ? 'bg-green-50' : ''}`}>
                      <td className="px-3 py-2">
                        <input
                          type="checkbox"
                          checked={!!selected}
                          onChange={() => toggleItem(item)}
                          className="rounded"
                        />
                      </td>
                      <td className="px-3 py-2 font-mono text-[#1A5276]">{item.lotNo}</td>
                      <td className="px-3 py-2 text-xs text-gray-600">{item.code}</td>
                      <td className="px-3 py-2 text-right">{item.qty}</td>
                      <td className="px-3 py-2 text-right">
                        {selected && (
                          <input
                            type="number"
                            value={selected.issueQty}
                            onChange={(e) => updateQty(item.lotNo, parseInt(e.target.value) || 0)}
                            max={item.qty}
                            className="w-20 px-2 py-1 border rounded text-right"
                          />
                        )}
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>

      {/* Summary */}
      {selectedItems.length > 0 && (
        <div className="p-4 bg-green-50 rounded-lg border border-green-200">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium text-green-800">
                {lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å' : 'Issue Summary'}
              </div>
              <div className="text-sm text-green-600">
                {selectedItems.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'items'} ‚Ä¢ 
                {selectedItems.reduce((sum, i) => sum + i.issueQty, 0)} {lang === 'th' ? '‡∏ä‡∏¥‡πâ‡∏ô' : 'pcs'}
              </div>
            </div>
            <div className="text-right">
              <div className="text-sm text-green-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Cost'}</div>
              <div className="text-xl font-bold text-green-700">{formatCurrency(totalCost)}</div>
            </div>
          </div>
        </div>
      )}

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button 
          onClick={handleSubmit} 
          icon={Package}
          disabled={selectedItems.length === 0}
        >
          {lang === 'th' ? '‡πÄ‡∏ö‡∏¥‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Issue Materials'}
        </Button>
      </div>
    </div>
  )
}

// ============================================
// DASHBOARD
// ============================================
// ============================================
// DEPARTMENT CALENDAR COMPONENT
// ============================================
const DepartmentCalendar = ({ department, events = [], workOrders = [], deliveries = [], leaves = [], lang }) => {
  const [currentMonth, setCurrentMonth] = useState(new Date())
  const [selectedDate, setSelectedDate] = useState(null)
  
  const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate()
  const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay()
  
  const monthNames = lang === 'th' 
    ? ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°']
    : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
  
  const dayNames = lang === 'th' 
    ? ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™']
    : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
  
  // Get events for a specific date
  const getEventsForDate = (date) => {
    const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`
    const dayEvents = []
    
    // Work Order deliveries
    workOrders.filter(wo => wo.deliveryDate === dateStr).forEach(wo => {
      dayEvents.push({ type: 'wo', color: 'bg-orange-500', title: `WO: ${wo.woNumber}` })
    })
    
    // Scheduled deliveries
    deliveries.filter(d => d.date === dateStr).forEach(d => {
      dayEvents.push({ type: 'delivery', color: 'bg-cyan-500', title: `${lang === 'th' ? '‡∏™‡πà‡∏á' : 'Delivery'}: ${d.customerName || d.id}` })
    })
    
    // Leave requests
    leaves.filter(l => l.startDate <= dateStr && l.endDate >= dateStr).forEach(l => {
      dayEvents.push({ type: 'leave', color: 'bg-pink-500', title: `${l.employeeName}: ${l.type}` })
    })
    
    // Custom events
    events.filter(e => e.date === dateStr).forEach(e => {
      dayEvents.push({ type: 'event', color: e.color || 'bg-blue-500', title: e.title })
    })
    
    return dayEvents
  }
  
  const prevMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))
  const nextMonth = () => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))
  
  return (
    <Card className="p-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-bold text-gray-800 flex items-center gap-2">
          <Calendar className="w-5 h-5 text-[#1A5276]" />
          {lang === 'th' ? '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å' : 'Department Calendar'}
        </h3>
        <div className="flex items-center gap-2">
          <button onClick={prevMonth} className="p-1 hover:bg-gray-100 rounded">
            <ChevronLeft className="w-5 h-5" />
          </button>
          <span className="font-medium min-w-[150px] text-center">
            {monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}
          </span>
          <button onClick={nextMonth} className="p-1 hover:bg-gray-100 rounded">
            <ChevronRight className="w-5 h-5" />
          </button>
        </div>
      </div>
      
      {/* Day names */}
      <div className="grid grid-cols-7 gap-1 mb-2">
        {dayNames.map(day => (
          <div key={day} className="text-center text-xs font-medium text-gray-500 py-1">{day}</div>
        ))}
      </div>
      
      {/* Calendar grid */}
      <div className="grid grid-cols-7 gap-1">
        {/* Empty cells for days before month starts */}
        {Array.from({ length: firstDayOfMonth }).map((_, i) => (
          <div key={`empty-${i}`} className="h-20 bg-gray-50 rounded" />
        ))}
        
        {/* Days of month */}
        {Array.from({ length: daysInMonth }).map((_, i) => {
          const date = i + 1
          const dayEvents = getEventsForDate(date)
          const isToday = new Date().toDateString() === new Date(currentMonth.getFullYear(), currentMonth.getMonth(), date).toDateString()
          
          return (
            <div 
              key={date}
              onClick={() => setSelectedDate(date)}
              className={`h-20 p-1 border rounded cursor-pointer hover:bg-gray-50 ${
                isToday ? 'border-[#1A5276] bg-blue-50' : 'border-gray-200'
              } ${selectedDate === date ? 'ring-2 ring-[#2ECC40]' : ''}`}
            >
              <div className={`text-sm font-medium ${isToday ? 'text-[#1A5276]' : 'text-gray-700'}`}>{date}</div>
              <div className="space-y-0.5 mt-1 overflow-hidden">
                {dayEvents.slice(0, 2).map((event, idx) => (
                  <div key={idx} className={`text-xs px-1 py-0.5 rounded truncate text-white ${event.color}`}>
                    {event.title}
                  </div>
                ))}
                {dayEvents.length > 2 && (
                  <div className="text-xs text-gray-500">+{dayEvents.length - 2} more</div>
                )}
              </div>
            </div>
          )
        })}
      </div>
      
      {/* Legend */}
      <div className="flex flex-wrap gap-4 mt-4 pt-4 border-t text-xs">
        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-orange-500" /> {lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Orders'}</div>
        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-cyan-500" /> {lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Deliveries'}</div>
        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-pink-500" /> {lang === 'th' ? '‡∏•‡∏≤‡∏á‡∏≤‡∏ô' : 'Leave'}</div>
        <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-blue-500" /> {lang === 'th' ? '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°' : 'Events'}</div>
      </div>
    </Card>
  )
}

// ============================================
// COMPANY CALENDAR (Admin - All Departments)
// ============================================
const CompanyCalendar = ({ workOrders = [], deliveries = [], leaves = [], departments = [], lang }) => {
  const [currentMonth, setCurrentMonth] = useState(new Date())
  
  const daysInMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0).getDate()
  const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay()
  
  const monthNames = lang === 'th' 
    ? ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°']
    : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
  
  const dayNames = lang === 'th' ? ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'] : ['S', 'M', 'T', 'W', 'T', 'F', 'S']
  
  // Department colors
  const deptColors = {
    production: 'bg-orange-500',
    sales: 'bg-pink-500',
    warehouse: 'bg-yellow-500',
    hr: 'bg-indigo-500',
    accounting: 'bg-green-500',
    transport: 'bg-cyan-500',
    maintenance: 'bg-purple-500',
    office: 'bg-blue-500'
  }
  
  const getEventsForDate = (date) => {
    const dateStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`
    const dayEvents = []
    
    workOrders.filter(wo => wo.deliveryDate === dateStr).forEach(wo => {
      dayEvents.push({ dept: 'production', color: deptColors.production, title: wo.woNumber })
    })
    
    deliveries.filter(d => d.date === dateStr).forEach(d => {
      dayEvents.push({ dept: 'transport', color: deptColors.transport, title: d.id })
    })
    
    return dayEvents
  }
  
  return (
    <Card className="p-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-bold text-gray-800 flex items-center gap-2">
          <Calendar className="w-5 h-5 text-[#1A5276]" />
          {lang === 'th' ? '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó' : 'Company Calendar'}
        </h3>
        <div className="flex items-center gap-2">
          <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1))} className="p-1 hover:bg-gray-100 rounded">
            <ChevronLeft className="w-5 h-5" />
          </button>
          <span className="font-medium">{monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}</span>
          <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1))} className="p-1 hover:bg-gray-100 rounded">
            <ChevronRight className="w-5 h-5" />
          </button>
        </div>
      </div>
      
      <div className="grid grid-cols-7 gap-1 mb-1">
        {dayNames.map(day => (
          <div key={day} className="text-center text-xs font-medium text-gray-500 py-1">{day}</div>
        ))}
      </div>
      
      <div className="grid grid-cols-7 gap-1">
        {Array.from({ length: firstDayOfMonth }).map((_, i) => (
          <div key={`e-${i}`} className="h-16 bg-gray-50 rounded" />
        ))}
        {Array.from({ length: daysInMonth }).map((_, i) => {
          const date = i + 1
          const dayEvents = getEventsForDate(date)
          const isToday = new Date().toDateString() === new Date(currentMonth.getFullYear(), currentMonth.getMonth(), date).toDateString()
          
          return (
            <div key={date} className={`h-16 p-1 border rounded ${isToday ? 'border-[#1A5276] bg-blue-50' : 'border-gray-200'}`}>
              <div className={`text-xs font-medium ${isToday ? 'text-[#1A5276]' : 'text-gray-700'}`}>{date}</div>
              <div className="flex flex-wrap gap-0.5 mt-1">
                {dayEvents.slice(0, 3).map((e, idx) => (
                  <div key={idx} className={`w-2 h-2 rounded-full ${e.color}`} title={e.title} />
                ))}
              </div>
            </div>
          )
        })}
      </div>
      
      <div className="flex flex-wrap gap-3 mt-3 pt-3 border-t text-xs">
        {Object.entries(deptColors).slice(0, 6).map(([dept, color]) => (
          <div key={dept} className="flex items-center gap-1">
            <div className={`w-2 h-2 rounded-full ${color}`} />
            <span className="capitalize">{dept}</span>
          </div>
        ))}
      </div>
    </Card>
  )
}

// ============================================
// ROLE-BASED DASHBOARD COMPONENT
// ============================================
const Dashboard = ({ stores, inventory, categories, purchaseOrders, workOrders, salesOrders, invoices, deliveries, employees = [], lang, currentUser }) => {
  const userRole = currentUser?.role || 'admin'
  
  // Calculate stats (only for roles that need them)
  const totalInventoryValue = inventory.reduce((sum, i) => sum + (i.cost || 0), 0)
  const totalLots = inventory.length
  const lowStockCount = inventory.filter(i => i.status === 'low').length
  const pendingPOs = (purchaseOrders || []).filter(po => po.status === 'pending').length
  const activeWOs = (workOrders || []).filter(wo => wo.status === 'in_progress').length
  const unpaidInvoices = (invoices || []).filter(inv => inv.balance > 0).length
  const todayDeliveries = (deliveries || []).filter(d => d.date === new Date().toISOString().split('T')[0]).length

  // Category distribution (only for inventory-related roles)
  const categoryStats = categories.filter(c => c.type === 'raw_material').map(cat => {
    const catItems = inventory.filter(i => i.category === cat.id)
    const value = catItems.reduce((sum, i) => sum + (i.cost || 0), 0)
    return { ...cat, items: catItems.length, value }
  }).sort((a, b) => b.value - a.value)

  // HR-specific dashboard
  if (userRole === 'hr') {
    const totalEmployees = employees.length
    const ftCount = employees.filter(e => e.type === 'FT').length
    const ptCount = employees.filter(e => e.type === 'PT').length
    const todayLeave = 2 // Mock data
    const pendingLeave = 3 // Mock data
    
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î HR' : 'HR Dashboard'}</h1>
            <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Human Resources Overview'}</p>
          </div>
          <div className="text-sm text-gray-500">
            {new Date().toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <Card className="p-4 col-span-1">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center">
                <Users className="w-5 h-5 text-indigo-600" />
              </div>
              <div>
                <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total Staff'}</div>
                <div className="text-2xl font-bold text-gray-800">{totalEmployees}</div>
              </div>
            </div>
          </Card>
          <Card className="p-4 border-l-4 border-l-blue-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏à‡∏≥' : 'Full-time'}</div>
            <div className="text-2xl font-bold text-blue-600">{ftCount}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-orange-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏ó‡∏°‡πå' : 'Part-time'}</div>
            <div className="text-2xl font-bold text-orange-600">{ptCount}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-pink-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : 'On Leave'}</div>
            <div className="text-2xl font-bold text-pink-600">{todayLeave}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-yellow-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'Pending'}</div>
            <div className="text-2xl font-bold text-yellow-600">{pendingLeave}</div>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <DepartmentCalendar department="hr" workOrders={[]} deliveries={[]} leaves={[]} lang={lang} />
          
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô' : 'Quick Actions'}</h3>
            <div className="grid grid-cols-2 gap-3">
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center mb-2">
                  <UserPlus className="w-5 h-5 text-indigo-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Add Employee'}</div>
              </button>
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-2">
                  <DollarSign className="w-5 h-5 text-green-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Run Payroll'}</div>
              </button>
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center mb-2">
                  <Calendar className="w-5 h-5 text-pink-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏≤' : 'Approve Leave'}</div>
              </button>
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mb-2">
                  <Clock className="w-5 h-5 text-blue-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ' : 'Attendance'}</div>
              </button>
            </div>
          </Card>
        </div>
      </div>
    )
  }

  // Sales-specific dashboard
  if (userRole === 'sales') {
    const totalOrders = salesOrders.length
    const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
    const totalReceived = invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0)
    const pendingOrders = salesOrders.filter(so => so.status === 'confirmed').length
    
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' : 'Sales Dashboard'}</h1>
            <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Sales & Customer Overview'}</p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Card className="p-4 col-span-1">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                <DollarSign className="w-5 h-5 text-green-600" />
              </div>
              <div>
                <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Revenue'}</div>
                <div className="text-xl font-bold text-[#2ECC40]">{formatCurrency(totalRevenue)}</div>
              </div>
            </div>
          </Card>
          <Card className="p-4 border-l-4 border-l-blue-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
            <div className="text-2xl font-bold text-blue-600">{formatCurrency(totalReceived)}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-orange-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
            <div className="text-2xl font-bold text-orange-600">{formatCurrency(totalRevenue - totalReceived)}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-pink-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Orders'}</div>
            <div className="text-2xl font-bold text-pink-600">{totalOrders}</div>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <DepartmentCalendar department="sales" workOrders={workOrders} deliveries={deliveries} leaves={[]} lang={lang} />
          
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô' : 'Quick Actions'}</h3>
            <div className="grid grid-cols-2 gap-3">
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center mb-2">
                  <ClipboardList className="w-5 h-5 text-pink-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà' : 'New Order'}</div>
              </button>
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-2">
                  <Receipt className="w-5 h-5 text-green-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'New Invoice'}</div>
              </button>
            </div>
          </Card>
        </div>
      </div>
    )
  }

  // Production-specific dashboard
  if (userRole === 'production') {
    const completedWOs = workOrders.filter(wo => wo.status === 'completed').length
    const inProgressWOs = workOrders.filter(wo => wo.status === 'in_progress').length
    
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : 'Production Dashboard'}</h1>
            <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : 'Production Overview'}</p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Card className="p-4 border-l-4 border-l-blue-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Orders'}</div>
            <div className="text-2xl font-bold text-blue-600">{workOrders.length}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-orange-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'In Progress'}</div>
            <div className="text-2xl font-bold text-orange-600">{inProgressWOs}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-green-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' : 'Completed'}</div>
            <div className="text-2xl font-bold text-green-600">{completedWOs}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-yellow-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' : 'Low Stock'}</div>
            <div className="text-2xl font-bold text-yellow-600">{lowStockCount}</div>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <DepartmentCalendar department="production" workOrders={workOrders} deliveries={deliveries} leaves={[]} lang={lang} />
          
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô' : 'Quick Actions'}</h3>
            <div className="grid grid-cols-2 gap-3">
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center mb-2">
                  <Factory className="w-5 h-5 text-orange-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà' : 'New WO'}</div>
              </button>
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-2">
                  <Package className="w-5 h-5 text-green-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å' : 'Check Stock'}</div>
              </button>
            </div>
          </Card>
        </div>
      </div>
    )
  }

  // Transport-specific dashboard
  if (userRole === 'transport') {
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏ô‡∏™‡πà‡∏á' : 'Transport Dashboard'}</h1>
            <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á' : 'Delivery Overview'}</p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Card className="p-4 border-l-4 border-l-cyan-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : 'Today'}</div>
            <div className="text-2xl font-bold text-cyan-600">{todayDeliveries}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-yellow-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏™‡πà‡∏á' : 'Pending'}</div>
            <div className="text-2xl font-bold text-yellow-600">{deliveries.filter(d => d.status === 'scheduled').length}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-green-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered'}</div>
            <div className="text-2xl font-bold text-green-600">{deliveries.filter(d => d.status === 'delivered').length}</div>
          </Card>
        </div>

        <DepartmentCalendar department="transport" workOrders={workOrders} deliveries={deliveries} leaves={[]} lang={lang} />
      </div>
    )
  }

  // Accounting-specific dashboard
  if (userRole === 'accounting') {
    const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
    const totalReceived = invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0)
    const totalOutstanding = totalRevenue - totalReceived
    
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' : 'Accounting Dashboard'}</h1>
            <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô' : 'Financial Overview'}</p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Card className="p-4 col-span-1">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                <DollarSign className="w-5 h-5 text-green-600" />
              </div>
              <div>
                <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Revenue'}</div>
                <div className="text-xl font-bold text-[#2ECC40]">{formatCurrency(totalRevenue)}</div>
              </div>
            </div>
          </Card>
          <Card className="p-4 border-l-4 border-l-blue-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
            <div className="text-2xl font-bold text-blue-600">{formatCurrency(totalReceived)}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-red-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
            <div className="text-2xl font-bold text-red-600">{formatCurrency(totalOutstanding)}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-orange-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices'}</div>
            <div className="text-2xl font-bold text-orange-600">{invoices.length}</div>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <DepartmentCalendar department="accounting" workOrders={[]} deliveries={[]} leaves={[]} lang={lang} />
          
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô' : 'Quick Actions'}</h3>
            <div className="grid grid-cols-2 gap-3">
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-2">
                  <Receipt className="w-5 h-5 text-green-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'New Invoice'}</div>
              </button>
              <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
                <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mb-2">
                  <CreditCard className="w-5 h-5 text-blue-600" />
                </div>
                <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' : 'Record Payment'}</div>
              </button>
            </div>
          </Card>
        </div>
      </div>
    )
  }

  // Warehouse-specific dashboard  
  if (userRole === 'warehouse') {
    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Warehouse Dashboard'}</h1>
            <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á' : 'Inventory Overview'}</p>
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <Card className="p-4 col-span-1">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center">
                <DollarSign className="w-5 h-5 text-green-600" />
              </div>
              <div>
                <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á' : 'Value'}</div>
                <div className="text-xl font-bold text-[#2ECC40]">{formatCurrency(totalInventoryValue)}</div>
              </div>
            </div>
          </Card>
          <Card className="p-4 border-l-4 border-l-blue-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏•‡πá‡∏≠‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Lots'}</div>
            <div className="text-2xl font-bold text-blue-600">{totalLots}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-red-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' : 'Low Stock'}</div>
            <div className="text-2xl font-bold text-red-600">{lowStockCount}</div>
          </Card>
          <Card className="p-4 border-l-4 border-l-yellow-500">
            <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Pending POs'}</div>
            <div className="text-2xl font-bold text-yellow-600">{pendingPOs}</div>
          </Card>
        </div>

        {/* Store Cards - Warehouse sees this */}
        <div>
          <h3 className="font-bold text-gray-800 mb-3">{lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Warehouses'}</h3>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            {stores.map(store => {
              const storeItems = inventory.filter(i => i.store === store.id)
              const storeValue = storeItems.reduce((sum, i) => sum + (i.cost || 0), 0)
              return (
                <Card key={store.id} className="p-4">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-mono text-[#1A5276] font-medium">{store.code}</span>
                    <Badge variant={store.type === 'raw_material' ? 'success' : 'info'}>{storeItems.length}</Badge>
                  </div>
                  <div className="text-sm text-gray-500 truncate">{lang === 'th' ? store.nameTh : store.nameEn}</div>
                  <div className="font-bold text-[#2ECC40] mt-2">{formatCurrency(storeValue)}</div>
                </Card>
              )
            })}
          </div>
        </div>

        <DepartmentCalendar department="warehouse" workOrders={[]} deliveries={deliveries} leaves={[]} lang={lang} />
      </div>
    )
  }

  // Admin/Default Dashboard - Full view with everything
  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.dashboard', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à' : 'Business Overview'}</p>
        </div>
        <div className="text-sm text-gray-500">
          {new Date().toLocaleDateString(lang === 'th' ? 'th-TH' : 'en-GB', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </div>
      </div>

      {/* Main Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
        <Card className="p-4 col-span-2">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 rounded-xl bg-green-100 flex items-center justify-center">
              <DollarSign className="w-6 h-6 text-green-600" />
            </div>
            <div>
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏•‡∏±‡∏á' : 'Inventory Value'}</div>
              <div className="text-2xl font-bold text-[#2ECC40]">{formatCurrency(totalInventoryValue)}</div>
            </div>
          </div>
        </Card>
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏•‡πá‡∏≠‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Total Lots'}</div>
          <div className="text-2xl font-bold text-gray-800">{totalLots}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-red-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' : 'Low Stock'}</div>
          <div className="text-2xl font-bold text-red-600">{lowStockCount}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-yellow-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Pending POs'}</div>
          <div className="text-2xl font-bold text-yellow-600">{pendingPOs}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Active WOs'}</div>
          <div className="text-2xl font-bold text-blue-600">{activeWOs}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞' : 'Unpaid Inv'}</div>
          <div className="text-2xl font-bold text-orange-600">{unpaidInvoices}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-cyan-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : 'Today Del'}</div>
          <div className="text-2xl font-bold text-cyan-600">{todayDeliveries}</div>
        </Card>
      </div>

      {/* Store Cards - Admin sees all stores */}
      <div>
        <h3 className="font-bold text-gray-800 mb-3">{lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (6 ‡∏Ñ‡∏•‡∏±‡∏á)' : 'Stores (6 Warehouses)'}</h3>
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
          {stores.map(store => {
            const storeItems = inventory.filter(i => i.store === store.id)
            const storeValue = storeItems.reduce((sum, i) => sum + (i.cost || 0), 0)
            return (
              <Card key={store.id} className="p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="font-mono text-[#1A5276] font-medium">{store.code}</span>
                  <Badge variant={store.type === 'raw_material' ? 'success' : store.type === 'finished_goods' ? 'info' : 'default'}>
                    {storeItems.length}
                  </Badge>
                </div>
                <div className="text-sm text-gray-500 truncate">{lang === 'th' ? store.nameTh : store.nameEn}</div>
                <div className="font-bold text-[#2ECC40] mt-2">{formatCurrency(storeValue)}</div>
              </Card>
            )
          })}
        </div>
      </div>

      {/* Three Column Layout with Calendar */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Category Distribution */}
        <Card className="p-5">
          <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Value by Category'}</h3>
          <div className="space-y-3">
            {categoryStats.slice(0, 8).map(cat => {
              const maxValue = Math.max(...categoryStats.map(c => c.value))
              const percent = maxValue > 0 ? (cat.value / maxValue * 100) : 0
              return (
                <div key={cat.id} className="flex items-center gap-3">
                  <div className="w-16 text-sm font-mono" style={{ color: cat.color }}>{cat.code}</div>
                  <div className="flex-1">
                    <div className="h-4 bg-gray-100 rounded-full overflow-hidden">
                      <div 
                        className="h-full rounded-full transition-all"
                        style={{ width: `${percent}%`, backgroundColor: cat.color }}
                      />
                    </div>
                  </div>
                  <div className="w-24 text-right text-sm font-medium">{formatCurrency(cat.value)}</div>
                </div>
              )
            })}
          </div>
        </Card>

        {/* Company Calendar */}
        <CompanyCalendar workOrders={workOrders} deliveries={deliveries} leaves={[]} lang={lang} />

        {/* Quick Actions */}
        <Card className="p-5">
          <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô' : 'Quick Actions'}</h3>
          <div className="grid grid-cols-2 gap-3">
            <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
              <div className="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mb-2">
                <ShoppingCart className="w-5 h-5 text-blue-600" />
              </div>
              <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : 'New PO'}</div>
            </button>
            <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
              <div className="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center mb-2">
                <Factory className="w-5 h-5 text-orange-600" />
              </div>
              <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'New WO'}</div>
            </button>
            <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
              <div className="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-2">
                <Receipt className="w-5 h-5 text-green-600" />
              </div>
              <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'New Invoice'}</div>
            </button>
            <button className="p-4 border rounded-lg hover:bg-gray-50 transition-all text-left">
              <div className="w-10 h-10 rounded-lg bg-cyan-100 flex items-center justify-center mb-2">
                <Truck className="w-5 h-5 text-cyan-600" />
              </div>
              <div className="font-medium text-gray-800">{lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á' : 'Schedule Delivery'}</div>
            </button>
          </div>
        </Card>
      </div>
    </div>
  )
}

// ============================================
// SALES MODULE (Simplified)
// ============================================
const SalesModule = ({ salesOrders, setSalesOrders, invoices, setInvoices, customers, workOrders, lang }) => {
  const [activeTab, setActiveTab] = useState('dashboard')

  const tabs = [
    { id: 'dashboard', label: lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°' : 'Dashboard', icon: BarChart3 },
    { id: 'orders', label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Sales Orders', icon: ClipboardList },
    { id: 'invoices', label: lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices', icon: Receipt },
    { id: 'payments', label: lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞' : 'Payments', icon: CreditCard },
  ]

  const stats = {
    totalOrders: salesOrders.length,
    pendingOrders: salesOrders.filter(so => so.status === 'confirmed').length,
    totalInvoices: invoices.length,
    unpaidInvoices: invoices.filter(inv => inv.balance > 0).length,
    totalRevenue: invoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0),
    totalReceived: invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0),
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.sales', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Manage sales and invoices'}</p>
        </div>
        <Button icon={Plus}>
          {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'New Sales Order'}
        </Button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Orders'}</div>
          <div className="text-2xl font-bold text-gray-800">{stats.totalOrders}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-yellow-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏ú‡∏•‡∏¥‡∏ï' : 'Pending'}</div>
          <div className="text-2xl font-bold text-yellow-600">{stats.pendingOrders}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices'}</div>
          <div className="text-2xl font-bold text-blue-600">{stats.totalInvoices}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-red-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞' : 'Unpaid'}</div>
          <div className="text-2xl font-bold text-red-600">{stats.unpaidInvoices}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-purple-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Revenue'}</div>
          <div className="text-2xl font-bold text-purple-600">{formatCurrency(stats.totalRevenue)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(stats.totalReceived)}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Sales Orders */}
      {activeTab === 'orders' && (
        <Card className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'SO #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? 'PO ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer PO'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {salesOrders.map(so => {
                  const customer = customers.find(c => c.id === so.customerId)
                  return (
                    <tr key={so.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{so.id}</td>
                      <td className="px-4 py-3">{customer?.name}</td>
                      <td className="px-4 py-3 text-sm text-gray-500">{so.customerPO}</td>
                      <td className="px-4 py-3">{formatDate(so.orderDate)}</td>
                      <td className="px-4 py-3 text-right font-medium">{formatCurrency(so.grandTotal)}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          so.status === 'delivered' ? 'success' :
                          so.status === 'in_production' ? 'info' :
                          'warning'
                        }>
                          {so.status}
                        </Badge>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* Invoices */}
      {activeTab === 'invoices' && (
        <Card className="overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'Invoice #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Total'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Balance'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {invoices.map(inv => {
                  const customer = customers.find(c => c.id === inv.customerId)
                  return (
                    <tr key={inv.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{inv.id}</td>
                      <td className="px-4 py-3">{customer?.name}</td>
                      <td className="px-4 py-3">{formatDate(inv.invoiceDate)}</td>
                      <td className="px-4 py-3 text-right font-medium">{formatCurrency(inv.grandTotal)}</td>
                      <td className="px-4 py-3 text-right text-green-600">{formatCurrency(inv.paidAmount)}</td>
                      <td className="px-4 py-3 text-right text-red-600">{formatCurrency(inv.balance)}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          inv.status === 'paid' ? 'success' :
                          inv.status === 'partial' ? 'warning' :
                          'info'
                        }>
                          {inv.status}
                        </Badge>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* Dashboard / Payments placeholder */}
      {(activeTab === 'dashboard' || activeTab === 'payments') && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Recent Invoices'}</h3>
            <div className="space-y-3">
              {invoices.slice(0, 5).map(inv => {
                const customer = customers.find(c => c.id === inv.customerId)
                return (
                  <div key={inv.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <div className="font-mono text-[#1A5276] font-medium">{inv.id}</div>
                      <div className="text-sm text-gray-500">{customer?.name}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-medium">{formatCurrency(inv.grandTotal)}</div>
                      <Badge variant={inv.balance > 0 ? 'warning' : 'success'}>
                        {inv.balance > 0 ? (lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding') : (lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid')}
                      </Badge>
                    </div>
                  </div>
                )
              })}
            </div>
          </Card>
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' : 'Revenue Summary'}</h3>
            <div className="space-y-4">
              <div className="p-4 bg-green-50 rounded-lg">
                <div className="text-sm text-green-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Total Revenue'}</div>
                <div className="text-3xl font-bold text-green-700">{formatCurrency(stats.totalRevenue)}</div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-blue-50 rounded-lg">
                  <div className="text-sm text-blue-600">{lang === 'th' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
                  <div className="text-xl font-bold text-blue-700">{formatCurrency(stats.totalReceived)}</div>
                </div>
                <div className="p-4 bg-red-50 rounded-lg">
                  <div className="text-sm text-red-600">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
                  <div className="text-xl font-bold text-red-700">{formatCurrency(stats.totalRevenue - stats.totalReceived)}</div>
                </div>
              </div>
            </div>
          </Card>
        </div>
      )}
    </div>
  )
}

// ============================================
// STORE BUILDER (Admin)
// ============================================
const StoreBuilder = ({ stores, setStores, categories, lang }) => {
  const [showForm, setShowForm] = useState(false)
  const [editStore, setEditStore] = useState(null)

  const handleSave = (storeData) => {
    if (editStore) {
      setStores(stores.map(s => s.id === editStore.id ? { ...s, ...storeData } : s))
    } else {
      const newStore = {
        id: `STORE${stores.length + 1}`,
        code: `STORE${stores.length + 1}`,
        ...storeData,
        isActive: true,
        itemCount: 0,
        value: 0,
      }
      setStores([...stores, newStore])
    }
    setShowForm(false)
    setEditStore(null)
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('admin.stores', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 6 ‡∏Ñ‡∏•‡∏±‡∏á' : 'Manage 6 warehouse locations'}</p>
        </div>
        <Button icon={Plus} onClick={() => { setEditStore(null); setShowForm(true) }}>
          {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á' : 'Add Store'}
        </Button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {stores.map(store => (
          <Card key={store.id} className="p-5">
            <div className="flex items-start justify-between mb-4">
              <div>
                <div className="font-bold text-xl text-[#1A5276]">{store.code}</div>
                <div className="text-gray-600">{lang === 'th' ? store.nameTh : store.nameEn}</div>
              </div>
              <Badge variant={store.isActive ? 'success' : 'danger'}>
                {store.isActive ? (lang === 'th' ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'Active') : (lang === 'th' ? '‡∏õ‡∏¥‡∏î' : 'Inactive')}
              </Badge>
            </div>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</span>
                <span className="font-medium">{store.type}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡∏™‡∏≤‡∏Ç‡∏≤' : 'Branch'}</span>
                <span className="font-medium">{store.branch}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Categories'}</span>
                <span className="font-medium">{store.categories?.length || 0}</span>
              </div>
            </div>
            <div className="mt-4 pt-4 border-t flex gap-2">
              <Button 
                size="sm" 
                variant="outline" 
                icon={Edit3}
                onClick={() => { setEditStore(store); setShowForm(true) }}
              >
                {t('action.edit', lang)}
              </Button>
            </div>
          </Card>
        ))}
      </div>

      {showForm && (
        <Modal isOpen={showForm} onClose={() => setShowForm(false)} title={editStore ? 'Edit Store' : 'New Store'} size="md">
          <StoreForm 
            store={editStore} 
            categories={categories}
            onSave={handleSave}
            onCancel={() => setShowForm(false)}
            lang={lang}
          />
        </Modal>
      )}
    </div>
  )
}

const StoreForm = ({ store, categories, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    nameEn: store?.nameEn || '',
    nameTh: store?.nameTh || '',
    type: store?.type || 'raw_material',
    branch: store?.branch || 'IND',
    categories: store?.categories || [],
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Name (EN)</label>
          <input
            type="text"
            required
            value={formData.nameEn}
            onChange={(e) => setFormData({ ...formData, nameEn: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Name (TH)</label>
          <input
            type="text"
            required
            value={formData.nameTh}
            onChange={(e) => setFormData({ ...formData, nameTh: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
          <select
            value={formData.type}
            onChange={(e) => setFormData({ ...formData, type: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            {STORE_TYPES.map(t => (
              <option key={t.id} value={t.id}>{t.nameEn}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Branch</label>
          <select
            value={formData.branch}
            onChange={(e) => setFormData({ ...formData, branch: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="IND">IND</option>
            <option value="IND-2">IND-2</option>
          </select>
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>{t('action.save', lang)}</Button>
      </div>
    </form>
  )
}

// ============================================
// CATEGORY MANAGER (Admin)
// ============================================
const CategoryManager = ({ categories, setCategories, lang }) => {
  const [showForm, setShowForm] = useState(false)
  const [editCat, setEditCat] = useState(null)

  const handleSave = (catData) => {
    if (editCat) {
      setCategories(categories.map(c => c.id === editCat.id ? { ...c, ...catData } : c))
    } else {
      const newCat = {
        id: catData.code,
        ...catData,
        isActive: true,
      }
      setCategories([...categories, newCat])
    }
    setShowForm(false)
    setEditCat(null)
  }

  const rmCategories = categories.filter(c => c.type === 'raw_material')
  const otherCategories = categories.filter(c => c.type !== 'raw_material')

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('admin.categories', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ß‡∏±‡∏™‡∏î‡∏∏ 12 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Manage 12 material categories'}</p>
        </div>
        <Button icon={Plus} onClick={() => { setEditCat(null); setShowForm(true) }}>
          {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Add Category'}
        </Button>
      </div>

      {/* Raw Materials (8 Wood Types) */}
      <div>
        <h3 className="font-bold text-gray-800 mb-3">
          {lang === 'th' ? '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πâ (8 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)' : 'Raw Materials - Wood Types (8)'}
        </h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {rmCategories.map(cat => (
            <Card key={cat.id} className="p-4" style={{ borderLeftWidth: 4, borderLeftColor: cat.color }}>
              <div className="flex items-start justify-between mb-2">
                <div>
                  <div className="font-bold text-lg" style={{ color: cat.color }}>{cat.code}</div>
                  <div className="text-sm text-gray-600">{lang === 'th' ? cat.nameTh : cat.nameEn}</div>
                </div>
                <Badge variant={cat.isActive ? 'success' : 'default'}>{cat.isActive ? '‚úì' : '‚úó'}</Badge>
              </div>
              <div className="text-xs text-gray-500 mt-2">
                {lang === 'th' ? '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:' : 'Cost Method:'} <strong>{cat.costMethod}</strong>
              </div>
              <button 
                onClick={() => { setEditCat(cat); setShowForm(true) }}
                className="mt-2 text-sm text-[#1A5276] hover:underline"
              >
                {t('action.edit', lang)}
              </button>
            </Card>
          ))}
        </div>
      </div>

      {/* Other Categories */}
      <div>
        <h3 className="font-bold text-gray-800 mb-3">
          {lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏≠‡∏∑‡πà‡∏ô‡πÜ (4 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)' : 'Other Categories (4)'}
        </h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {otherCategories.map(cat => (
            <Card key={cat.id} className="p-4" style={{ borderLeftWidth: 4, borderLeftColor: cat.color }}>
              <div className="flex items-start justify-between mb-2">
                <div>
                  <div className="font-bold text-lg" style={{ color: cat.color }}>{cat.code}</div>
                  <div className="text-sm text-gray-600">{lang === 'th' ? cat.nameTh : cat.nameEn}</div>
                </div>
                <Badge variant={cat.isActive ? 'success' : 'default'}>{cat.isActive ? '‚úì' : '‚úó'}</Badge>
              </div>
              <div className="text-xs text-gray-500 mt-2">
                {lang === 'th' ? '‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:' : 'Cost Method:'} <strong>{cat.costMethod}</strong>
              </div>
              <button 
                onClick={() => { setEditCat(cat); setShowForm(true) }}
                className="mt-2 text-sm text-[#1A5276] hover:underline"
              >
                {t('action.edit', lang)}
              </button>
            </Card>
          ))}
        </div>
      </div>

      {showForm && (
        <Modal isOpen={showForm} onClose={() => setShowForm(false)} title={editCat ? 'Edit Category' : 'New Category'} size="md">
          <CategoryForm 
            category={editCat}
            onSave={handleSave}
            onCancel={() => setShowForm(false)}
            lang={lang}
          />
        </Modal>
      )}
    </div>
  )
}

const CategoryForm = ({ category, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    code: category?.code || '',
    nameEn: category?.nameEn || '',
    nameTh: category?.nameTh || '',
    color: category?.color || '#6B7280',
    costMethod: category?.costMethod || 'FIFO',
    type: category?.type || 'raw_material',
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Code</label>
        <input
          type="text"
          required
          value={formData.code}
          onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}
          className="w-full px-3 py-2 border rounded-lg font-mono"
          disabled={!!category}
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Name (EN)</label>
          <input
            type="text"
            required
            value={formData.nameEn}
            onChange={(e) => setFormData({ ...formData, nameEn: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Name (TH)</label>
          <input
            type="text"
            required
            value={formData.nameTh}
            onChange={(e) => setFormData({ ...formData, nameTh: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Color</label>
          <input
            type="color"
            value={formData.color}
            onChange={(e) => setFormData({ ...formData, color: e.target.value })}
            className="w-full h-10 border rounded-lg cursor-pointer"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Cost Method</label>
          <select
            value={formData.costMethod}
            onChange={(e) => setFormData({ ...formData, costMethod: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="FIFO">FIFO</option>
            <option value="AVG">Average</option>
            <option value="STD">Standard</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
          <select
            value={formData.type}
            onChange={(e) => setFormData({ ...formData, type: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="raw_material">Raw Material</option>
            <option value="consumables">Consumables</option>
            <option value="finished_goods">Finished Goods</option>
            <option value="office">Office</option>
            <option value="maintenance">Maintenance</option>
          </select>
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>{t('action.save', lang)}</Button>
      </div>
    </form>
  )
}

// ============================================
// DEPARTMENT MANAGER (Admin)
// ============================================
const DepartmentManager = ({ departments, setDepartments, lang }) => {
  const [showForm, setShowForm] = useState(false)
  const [editDept, setEditDept] = useState(null)

  const handleSave = (deptData) => {
    if (editDept) {
      setDepartments(departments.map(d => d.id === editDept.id ? { ...d, ...deptData } : d))
    } else {
      const newDept = {
        id: deptData.code,
        ...deptData,
        isActive: true,
      }
      setDepartments([...departments, newDept])
    }
    setShowForm(false)
    setEditDept(null)
  }

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : 'Production Departments'}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï 10 ‡πÅ‡∏ú‡∏ô‡∏Å' : 'Manage 10 production departments'}</p>
        </div>
        <Button icon={Plus} onClick={() => { setEditDept(null); setShowForm(true) }}>
          {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å' : 'Add Department'}
        </Button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {departments.map(dept => {
          const typeInfo = DEPARTMENT_TYPES.find(t => t.id === dept.type)
          return (
            <Card key={dept.id} className="p-4" style={{ borderLeftWidth: 4, borderLeftColor: typeInfo?.color || '#6B7280' }}>
              <div className="flex items-start justify-between mb-2">
                <div>
                  <div className="font-bold text-lg">{dept.code}</div>
                  <div className="text-sm text-gray-600">{lang === 'th' ? dept.nameTh : dept.nameEn}</div>
                </div>
                <Badge variant={dept.isActive ? 'success' : 'default'}>{dept.isActive ? '‚úì' : '‚úó'}</Badge>
              </div>
              <div className="grid grid-cols-2 gap-2 text-xs text-gray-500 mt-3">
                <div>{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:' : 'Type:'} <strong>{typeInfo?.nameEn}</strong></div>
                <div>{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á/‡∏ä‡∏°:' : 'Rate:'} <strong>‡∏ø{dept.hourlyRate}</strong></div>
                <div>{lang === 'th' ? '‡∏•‡∏≥‡∏î‡∏±‡∏ö:' : 'Seq:'} <strong>{dept.sequence}</strong></div>
              </div>
              <button 
                onClick={() => { setEditDept(dept); setShowForm(true) }}
                className="mt-3 text-sm text-[#1A5276] hover:underline"
              >
                {t('action.edit', lang)}
              </button>
            </Card>
          )
        })}
      </div>

      {showForm && (
        <Modal isOpen={showForm} onClose={() => setShowForm(false)} title={editDept ? 'Edit Department' : 'New Department'} size="md">
          <DepartmentForm 
            department={editDept}
            onSave={handleSave}
            onCancel={() => setShowForm(false)}
            lang={lang}
          />
        </Modal>
      )}
    </div>
  )
}

const DepartmentForm = ({ department, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    code: department?.code || '',
    nameEn: department?.nameEn || '',
    nameTh: department?.nameTh || '',
    type: department?.type || 'cutting',
    hourlyRate: department?.hourlyRate || 180,
    sequence: department?.sequence || 1,
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Code</label>
        <input
          type="text"
          required
          value={formData.code}
          onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}
          className="w-full px-3 py-2 border rounded-lg font-mono"
          disabled={!!department}
        />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Name (EN)</label>
          <input
            type="text"
            required
            value={formData.nameEn}
            onChange={(e) => setFormData({ ...formData, nameEn: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Name (TH)</label>
          <input
            type="text"
            required
            value={formData.nameTh}
            onChange={(e) => setFormData({ ...formData, nameTh: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
          <select
            value={formData.type}
            onChange={(e) => setFormData({ ...formData, type: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            {DEPARTMENT_TYPES.map(t => (
              <option key={t.id} value={t.id}>{t.nameEn}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Hourly Rate (‡∏ø)</label>
          <input
            type="number"
            value={formData.hourlyRate}
            onChange={(e) => setFormData({ ...formData, hourlyRate: parseInt(e.target.value) || 0 })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Sequence</label>
          <input
            type="number"
            value={formData.sequence}
            onChange={(e) => setFormData({ ...formData, sequence: parseInt(e.target.value) || 1 })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>{t('action.save', lang)}</Button>
      </div>
    </form>
  )
}

// ============================================
// ADMIN HUB
// ============================================
const AdminHub = ({ stores, setStores, categories, setCategories, departments, setDepartments, vendors, customers, lang }) => {
  const [activeSection, setActiveSection] = useState('overview')

  const sections = [
    { id: 'overview', label: lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°' : 'Overview', icon: Settings },
    { id: 'stores', label: lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Stores', icon: Warehouse, count: stores.length },
    { id: 'categories', label: lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Categories', icon: Tag, count: categories.length },
    { id: 'departments', label: lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å' : 'Departments', icon: Factory, count: departments.length },
    { id: 'vendors', label: lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendors', icon: Users, count: vendors.length },
    { id: 'customers', label: lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customers', icon: Building2, count: customers.length },
    { id: 'users', label: lang === 'th' ? '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'Users', icon: Shield, count: DEMO_USERS.length },
  ]

  return (
    <div className="flex h-full">
      {/* Sidebar */}
      <div className="w-64 bg-gray-50 border-r p-4">
        <h2 className="font-bold text-gray-800 mb-4">{t('nav.admin', lang)}</h2>
        <nav className="space-y-1">
          {sections.map(section => (
            <button
              key={section.id}
              onClick={() => setActiveSection(section.id)}
              className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-left transition-all ${
                activeSection === section.id 
                  ? 'bg-[#1A5276] text-white' 
                  : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              <div className="flex items-center gap-2">
                <section.icon className="w-4 h-4" />
                {section.label}
              </div>
              {section.count !== undefined && (
                <Badge variant={activeSection === section.id ? 'default' : 'info'}>{section.count}</Badge>
              )}
            </button>
          ))}
        </nav>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-auto">
        {activeSection === 'overview' && (
          <div className="p-6 space-y-6">
            <h1 className="text-2xl font-bold text-gray-800">{lang === 'th' ? '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö' : 'Admin Control Center'}</h1>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {sections.filter(s => s.count !== undefined).map(section => (
                <Card 
                  key={section.id} 
                  className="p-4 cursor-pointer hover:shadow-md transition-all"
                  onClick={() => setActiveSection(section.id)}
                >
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-lg bg-[#1A5276]/10 flex items-center justify-center">
                      <section.icon className="w-5 h-5 text-[#1A5276]" />
                    </div>
                    <div>
                      <div className="text-2xl font-bold text-gray-800">{section.count}</div>
                      <div className="text-sm text-gray-500">{section.label}</div>
                    </div>
                  </div>
                </Card>
              ))}
            </div>

            {/* System Info */}
            <Card className="p-6">
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : 'System Information'}</h3>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div className="flex justify-between p-3 bg-gray-50 rounded-lg">
                  <span className="text-gray-500">{lang === 'th' ? '‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô' : 'Version'}</span>
                  <span className="font-mono font-bold text-[#1A5276]">{VERSION}</span>
                </div>
                <div className="flex justify-between p-3 bg-gray-50 rounded-lg">
                  <span className="text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Build Date'}</span>
                  <span className="font-mono">{VERSION_DATE}</span>
                </div>
                <div className="flex justify-between p-3 bg-gray-50 rounded-lg">
                  <span className="text-gray-500">{lang === 'th' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Entities'}</span>
                  <span className="font-mono">IND, IND2</span>
                </div>
                <div className="flex justify-between p-3 bg-gray-50 rounded-lg">
                  <span className="text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏©‡∏≤' : 'Languages'}</span>
                  <span className="font-mono">6</span>
                </div>
              </div>
            </Card>
          </div>
        )}
        {activeSection === 'stores' && (
          <StoreBuilder stores={stores} setStores={setStores} categories={categories} lang={lang} />
        )}
        {activeSection === 'categories' && (
          <CategoryManager categories={categories} setCategories={setCategories} lang={lang} />
        )}
        {activeSection === 'departments' && (
          <DepartmentManager departments={departments} setDepartments={setDepartments} lang={lang} />
        )}
        {activeSection === 'vendors' && (
          <div className="p-6">
            <h1 className="text-2xl font-bold text-gray-800 mb-6">{t('admin.vendors', lang)}</h1>
            <Card className="overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' : 'Contact'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : 'Terms'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {vendors.map(v => (
                    <tr key={v.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{v.code}</td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{v.name}</div>
                        <div className="text-sm text-gray-500">{v.nameTh}</div>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={v.type === 'import' ? 'info' : 'success'}>{v.type}</Badge>
                      </td>
                      <td className="px-4 py-3">{v.category}</td>
                      <td className="px-4 py-3">
                        <div>{v.contact}</div>
                        <div className="text-sm text-gray-500">{v.phone}</div>
                      </td>
                      <td className="px-4 py-3 text-center">{v.paymentTerms} days</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Card>
          </div>
        )}
        {activeSection === 'customers' && (
          <div className="p-6">
            <h1 className="text-2xl font-bold text-gray-800 mb-6">{t('admin.customers', lang)}</h1>
            <Card className="overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' : 'Contact'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡πà‡∏á' : 'Delivery'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : 'Terms'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {customers.map(c => (
                    <tr key={c.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{c.code}</td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{c.name}</div>
                        <div className="text-sm text-gray-500">{c.nameTh}</div>
                      </td>
                      <td className="px-4 py-3">
                        <div>{c.contact}</div>
                        <div className="text-sm text-gray-500">{c.phone}</div>
                      </td>
                      <td className="px-4 py-3">{c.deliveryAddress}</td>
                      <td className="px-4 py-3 text-center">{c.paymentTerms} days</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </Card>
          </div>
        )}
        {activeSection === 'users' && (
          <div className="p-6">
            <h1 className="text-2xl font-bold text-gray-800 mb-6">{t('admin.users', lang)}</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {DEMO_USERS.map(user => {
                const role = ROLES[user.role]
                return (
                  <Card key={user.id} className="p-4">
                    <div className="flex items-start gap-3">
                      <div className={`w-10 h-10 rounded-full ${role.color} flex items-center justify-center text-white font-bold`}>
                        {user.name.charAt(0)}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="font-medium text-gray-800 truncate">{user.name}</div>
                        <div className="text-sm text-gray-500 truncate">{user.nameTh}</div>
                        <Badge variant="info" className="mt-1">{role.name}</Badge>
                      </div>
                    </div>
                    <div className="mt-3 pt-3 border-t text-xs text-gray-500">
                      <div className="flex justify-between">
                        <span>{lang === 'th' ? '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' : 'Username'}</span>
                        <span className="font-mono">{user.username}</span>
                      </div>
                      <div className="flex justify-between mt-1">
                        <span>{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å' : 'Dept'}</span>
                        <span>{user.department}</span>
                      </div>
                    </div>
                  </Card>
                )
              })}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

// ============================================
// MAIN APP COMPONENT (Basic Version - Not Used)
// ============================================
function AppBasicVersion() {
  // Authentication
  const [currentUser, setCurrentUser] = useState(null)
  const [lang, setLang] = useState('en')

  // Master Data State
  const [stores, setStores] = useState(INITIAL_STORES)
  const [categories, setCategories] = useState(INITIAL_CATEGORIES)
  const [inventory, setInventory] = useState(INITIAL_INVENTORY)
  const [vendors, setVendors] = useState(INITIAL_VENDORS)
  const [customers, setCustomers] = useState(INITIAL_CUSTOMERS)
  const [departments, setDepartments] = useState(INITIAL_DEPARTMENTS)
  const [trucks, setTrucks] = useState(INITIAL_TRUCKS)
  const [employees, setEmployees] = useState(INITIAL_EMPLOYEES)
  const [equipment, setEquipment] = useState(INITIAL_EQUIPMENT)
  const [products, setProducts] = useState(INITIAL_PRODUCTS)

  // Transaction State
  const [purchaseOrders, setPurchaseOrders] = useState(INITIAL_PURCHASE_ORDERS)
  const [workOrders, setWorkOrders] = useState(INITIAL_WORK_ORDERS)
  const [salesOrders, setSalesOrders] = useState(INITIAL_SALES_ORDERS)
  const [invoices, setInvoices] = useState(INITIAL_INVOICES)
  const [deliveryOrders, setDeliveryOrders] = useState(INITIAL_DELIVERY_ORDERS)
  const [quotations, setQuotations] = useState(INITIAL_QUOTATIONS)
  const [rejections, setRejections] = useState(INITIAL_REJECTIONS)
  const [claims, setClaims] = useState(INITIAL_CLAIMS)
  const [creditNotes, setCreditNotes] = useState(INITIAL_CREDIT_NOTES)
  const [salesMeetings, setSalesMeetings] = useState(INITIAL_SALES_MEETINGS)
  const [scheduledDeliveries, setScheduledDeliveries] = useState(INITIAL_SCHEDULED_DELIVERIES)
  const [maintenanceTasks, setMaintenanceTasks] = useState(INITIAL_MAINTENANCE_TASKS)

  // UI State
  const [activeModule, setActiveModule] = useState('dashboard')
  const [sidebarOpen, setSidebarOpen] = useState(true)
  
  // v7.6 Features State
  const [showGlobalSearch, setShowGlobalSearch] = useState(false)
  const [showNotifications, setShowNotifications] = useState(false)
  const [showQuickActions, setShowQuickActions] = useState(false)
  const [productionView, setProductionView] = useState('tabs') // 'tabs' or 'kanban'

  // Generate notifications dynamically
  const notifications = [
    ...workOrders.filter(wo => wo.targetDate && new Date(wo.targetDate) < new Date() && wo.status !== 'completed').slice(0, 3).map(wo => ({
      id: `wo-${wo.id}`, type: 'alert', title: lang === 'th' ? 'WO ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'WO Overdue',
      message: `${wo.woNumber || wo.id} - ${wo.productName}`, time: formatDate(wo.targetDate), action: lang === 'th' ? '‡∏î‡∏π' : 'View', read: false
    })),
    ...inventory.filter(item => item.quantity <= (item.minQty || 10)).slice(0, 2).map(item => ({
      id: `inv-${item.id}`, type: 'alert', title: lang === 'th' ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : 'Low Stock',
      message: `${item.name}: ${item.quantity} ${item.unit}`, time: lang === 'th' ? '1 ‡∏ä‡∏°.' : '1h ago', action: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á PR' : 'Create PR', read: false
    })),
  ]

  // Keyboard shortcuts for v7.6 features
  useEffect(() => {
    const handleKeyDown = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); setShowGlobalSearch(true); setShowNotifications(false); setShowQuickActions(false) }
      if (e.key === 'q' && !['INPUT', 'TEXTAREA'].includes(document.activeElement?.tagName)) { e.preventDefault(); setShowQuickActions(!showQuickActions); setShowNotifications(false) }
      if (e.key === 'Escape') { setShowGlobalSearch(false); setShowNotifications(false); setShowQuickActions(false) }
    }
    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [showQuickActions])

  // Handle search navigation
  const handleSearchNavigate = (type, item) => {
    setShowGlobalSearch(false)
    switch(type) {
      case 'customer': setActiveModule('sales'); break
      case 'workOrder': setActiveModule('production'); break
      case 'inventory': setActiveModule('inventory'); break
      case 'purchaseOrder': setActiveModule('purchase'); break
      case 'employee': setActiveModule('hr'); break
    }
  }

  // Handle quick actions
  const handleQuickAction = (actionId) => {
    switch(actionId) {
      case 'new_wo': setActiveModule('production'); break
      case 'new_so': case 'new_invoice': setActiveModule('sales'); break
      case 'new_po': setActiveModule('purchase'); break
      case 'maint_request': setActiveModule('maintenance'); break
    }
  }

  // Handle notification action
  const handleNotificationAction = (notif) => {
    if (notif.id.startsWith('wo-')) setActiveModule('production')
    else if (notif.id.startsWith('inv-')) setActiveModule('inventory')
    else if (notif.id.startsWith('maint-')) setActiveModule('maintenance')
    setShowNotifications(false)
  }

  // Auth handlers
  const handleLogin = (user) => {
    setCurrentUser(user)
    setActiveModule('dashboard')
  }

  const handleLogout = () => {
    setCurrentUser(null)
    setActiveModule('dashboard')
  }

  // Check role permissions
  const hasAccess = (module) => {
    if (!currentUser) return false
    const role = ROLES[currentUser.role]
    return role?.modules.includes(module) || role?.permissions.includes('all')
  }

  // Navigation items based on role
  const navItems = [
    { id: 'dashboard', label: t('nav.dashboard', lang), icon: Home, color: 'text-blue-500' },
    { id: 'admin', label: t('nav.admin', lang), icon: Settings, color: 'text-purple-500' },
    { id: 'inventory', label: t('nav.inventory', lang), icon: Package, color: 'text-green-500' },
    { id: 'purchase', label: t('nav.purchase', lang), icon: ShoppingCart, color: 'text-yellow-500' },
    { id: 'production', label: t('nav.production', lang), icon: Factory, color: 'text-orange-500' },
    { id: 'sales', label: t('nav.sales', lang), icon: Receipt, color: 'text-pink-500' },
    { id: 'accounting', label: t('nav.accounting', lang), icon: Calculator, color: 'text-emerald-500' },
    { id: 'hr', label: t('nav.hr', lang), icon: Users, color: 'text-indigo-500' },
    { id: 'transport', label: t('nav.transport', lang), icon: Truck, color: 'text-cyan-500' },
    { id: 'maintenance', label: t('nav.maintenance', lang), icon: Wrench, color: 'text-amber-500' },
    { id: 'reports', label: t('nav.reports', lang), icon: BarChart3, color: 'text-violet-500' },
  ].filter(item => hasAccess(item.id))

  // Show login if not authenticated
  if (!currentUser) {
    return <LoginScreen onLogin={handleLogin} lang={lang} setLang={setLang} />
  }

  const role = ROLES[currentUser.role]

  return (
    <LanguageContext.Provider value={{ lang, setLang }}>
      <AuthContext.Provider value={{ user: currentUser, logout: handleLogout }}>
        <div className="flex h-screen bg-gray-100">
          {/* Sidebar */}
          <aside className={`${sidebarOpen ? 'w-64' : 'w-20'} bg-white border-r flex flex-col transition-all duration-300`}>
            {/* Logo */}
            <div className="p-4 border-b">
              <div className="flex items-center gap-3">
                <img src={IND_LOGO_SVG} alt="IND" className="w-10 h-10" />
                {sidebarOpen && (
                  <div>
                    <div className="font-bold text-[#1A5276]">IND Thai</div>
                    <div className="text-xs text-gray-500">ERP v{VERSION}</div>
                  </div>
                )}
              </div>
            </div>

            {/* Navigation */}
            <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
              {navItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => setActiveModule(item.id)}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all ${
                    activeModule === item.id
                      ? 'bg-gradient-to-r from-[#1A5276] to-[#2ECC40] text-white shadow-md'
                      : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  <item.icon className={`w-5 h-5 ${activeModule === item.id ? 'text-white' : item.color}`} />
                  {sidebarOpen && <span className="font-medium">{item.label}</span>}
                </button>
              ))}
            </nav>

            {/* User Info */}
            <div className="p-4 border-t">
              <div className="flex items-center gap-3">
                <div className={`w-10 h-10 rounded-full ${role.color} flex items-center justify-center text-white font-bold`}>
                  {currentUser.name.charAt(0)}
                </div>
                {sidebarOpen && (
                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-gray-800 truncate">{currentUser.name}</div>
                    <div className="text-xs text-gray-500 truncate">{role.name}</div>
                  </div>
                )}
              </div>
              {sidebarOpen && (
                <button
                  onClick={handleLogout}
                  className="w-full mt-3 flex items-center justify-center gap-2 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg"
                >
                  <LogOut className="w-4 h-4" />
                  {t('action.logout', lang)}
                </button>
              )}
            </div>
          </aside>

          {/* Main Content */}
          <main className="flex-1 flex flex-col overflow-hidden">
            {/* Top Bar */}
            <header className="h-16 bg-white border-b flex items-center justify-between px-6">
              <div className="flex items-center gap-4">
                <button 
                  onClick={() => setSidebarOpen(!sidebarOpen)}
                  className="p-2 hover:bg-gray-100 rounded-lg"
                >
                  <Menu className="w-5 h-5 text-gray-500" />
                </button>
                <div>
                  <h1 className="font-bold text-gray-800">
                    {navItems.find(n => n.id === activeModule)?.label || 'Dashboard'}
                  </h1>
                </div>
              </div>
              <div className="flex items-center gap-4">
                <LanguageSwitcher />
                <Badge variant={currentUser.entity}>{currentUser.entity}</Badge>
                <button className="p-2 hover:bg-gray-100 rounded-lg relative">
                  <Bell className="w-5 h-5 text-gray-500" />
                  <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" />
                </button>
              </div>
            </header>

            {/* Content Area */}
            <div className="flex-1 overflow-auto">
              {activeModule === 'dashboard' && (
                <Dashboard 
                  stores={stores}
                  inventory={inventory}
                  categories={categories}
                  purchaseOrders={purchaseOrders}
                  workOrders={workOrders}
                  salesOrders={salesOrders}
                  invoices={invoices}
                  deliveries={scheduledDeliveries}
                  employees={employees}
                  lang={lang}
                  currentUser={currentUser}
                />
              )}
              {activeModule === 'admin' && (
                <AdminHub 
                  stores={stores}
                  setStores={setStores}
                  categories={categories}
                  setCategories={setCategories}
                  departments={departments}
                  setDepartments={setDepartments}
                  vendors={vendors}
                  customers={customers}
                  lang={lang}
                />
              )}
              {activeModule === 'inventory' && (
                <InventoryModule
                  inventory={inventory}
                  setInventory={setInventory}
                  stores={stores}
                  categories={categories}
                  maintenanceStore={maintenanceStore}
                  setMaintenanceStore={setMaintenanceStore}
                  lang={lang}
                />
              )}
              {activeModule === 'purchase' && (
                <PurchaseModule
                  purchaseOrders={purchaseOrders}
                  setPurchaseOrders={setPurchaseOrders}
                  vendors={vendors}
                  categories={categories}
                  stores={stores}
                  inventory={inventory}
                  setInventory={setInventory}
                  lang={lang}
                />
              )}
              {activeModule === 'production' && (
                <div className="flex-1 flex flex-col overflow-hidden">
                  {/* Production View Toggle */}
                  <div className="p-4 bg-white border-b flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <h2 className="text-lg font-bold text-gray-800">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : 'Production'}</h2>
                      <span className="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
                        {workOrders.filter(wo => wo.status !== 'completed').length} {lang === 'th' ? '‡∏á‡∏≤‡∏ô' : 'Active'}
                      </span>
                    </div>
                    <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                      <button
                        onClick={() => setProductionView('tabs')}
                        className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                          productionView === 'tabs' ? 'bg-white shadow text-[#1A5276]' : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        <ClipboardList className="w-4 h-4 inline mr-1" />
                        {lang === 'th' ? '‡πÅ‡∏ó‡πá‡∏ö' : 'Tabs'}
                      </button>
                      <button
                        onClick={() => setProductionView('kanban')}
                        className={`px-3 py-1.5 rounded-md text-sm font-medium transition-colors ${
                          productionView === 'kanban' ? 'bg-white shadow text-[#1A5276]' : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        <Layers className="w-4 h-4 inline mr-1" />
                        Kanban
                      </button>
                    </div>
                  </div>
                  {productionView === 'kanban' ? (
                    <KanbanBoard
                      workOrders={workOrders}
                      setWorkOrders={setWorkOrders}
                      customers={customers}
                      lang={lang}
                    />
                  ) : (
                    <ProductionModule
                      workOrders={workOrders}
                      setWorkOrders={setWorkOrders}
                      departments={departments}
                      customers={customers}
                      inventory={inventory}
                      setInventory={setInventory}
                      categories={categories}
                      stores={stores}
                      salesOrders={salesOrders}
                      lang={lang}
                    />
                  )}
                </div>
              )}
              {activeModule === 'sales' && (
                <SalesModuleFull
                  quotations={quotations}
                  setQuotations={setQuotations}
                  salesOrders={salesOrders}
                  setSalesOrders={setSalesOrders}
                  deliveryOrders={deliveryOrders}
                  setDeliveryOrders={setDeliveryOrders}
                  invoices={invoices}
                  setInvoices={setInvoices}
                  rejections={rejections}
                  setRejections={setRejections}
                  claims={claims}
                  setClaims={setClaims}
                  creditNotes={creditNotes}
                  setCreditNotes={setCreditNotes}
                  salesMeetings={salesMeetings}
                  setSalesMeetings={setSalesMeetings}
                  customers={customers}
                  workOrders={workOrders}
                  products={products}
                  trucks={trucks}
                  employees={employees}
                  lang={lang}
                />
              )}
              {activeModule === 'hr' && (
                <HRModuleFull
                  employees={employees}
                  setEmployees={setEmployees}
                  lang={lang}
                />
              )}
              {activeModule === 'transport' && (
                <TransportModule
                  deliveries={scheduledDeliveries}
                  setDeliveries={setScheduledDeliveries}
                  trucks={trucks}
                  employees={employees}
                  salesOrders={salesOrders}
                  lang={lang}
                />
              )}
              {activeModule === 'maintenance' && (
                <MaintenanceModule
                  tasks={maintenanceTasks}
                  setTasks={setMaintenanceTasks}
                  equipment={equipment}
                  employees={employees}
                  lang={lang}
                />
              )}
              {activeModule === 'accounting' && (
                <AccountingModule
                  invoices={invoices}
                  purchaseOrders={purchaseOrders}
                  vendors={vendors}
                  customers={customers}
                  lang={lang}
                />
              )}
              {activeModule === 'reports' && (
                <ReportsModule
                  inventory={inventory}
                  purchaseOrders={purchaseOrders}
                  workOrders={workOrders}
                  salesOrders={salesOrders}
                  invoices={invoices}
                  categories={categories}
                  stores={stores}
                  customers={customers}
                  vendors={vendors}
                  employees={employees}
                  lang={lang}
                />
              )}
            </div>
          </main>
        </div>
      </AuthContext.Provider>
    </LanguageContext.Provider>
  )
}

// ============================================
// ACCOUNTING MODULE (Full)
// ============================================
const AccountingModule = ({ invoices, purchaseOrders, vendors, customers, lang }) => {
  const [activeTab, setActiveTab] = useState('dashboard')

  const tabs = [
    { id: 'dashboard', label: lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°' : 'Dashboard', icon: BarChart3 },
    { id: 'ap', label: lang === 'th' ? '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ' : 'Payables (AP)', icon: FileText },
    { id: 'ar', label: lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ' : 'Receivables (AR)', icon: Receipt },
    { id: 'journal', label: lang === 'th' ? '‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' : 'Journal', icon: BookOpen },
    { id: 'cashflow', label: lang === 'th' ? '‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'Cash Flow', icon: DollarSign },
  ]

  // Calculate AP (Accounts Payable)
  const apData = purchaseOrders.map(po => {
    const vendor = vendors.find(v => v.id === po.vendorId)
    const paidAmount = po.paidAmount || 0
    const balance = (po.total || po.grandTotal || 0) - paidAmount
    const dueDate = new Date(po.poDate)
    dueDate.setDate(dueDate.getDate() + (vendor?.paymentTerms || 30))
    const today = new Date()
    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))
    
    return {
      ...po,
      vendorName: vendor?.name || 'Unknown',
      total: po.total || po.grandTotal || 0,
      paidAmount,
      balance,
      dueDate: dueDate.toISOString().split('T')[0],
      daysOverdue: balance > 0 ? Math.max(0, daysOverdue) : 0,
      status: balance <= 0 ? 'paid' : daysOverdue > 0 ? 'overdue' : 'pending',
    }
  }).filter(po => po.balance > 0 || po.status === 'paid')

  // Calculate AR (Accounts Receivable)
  const arData = invoices.map(inv => {
    const customer = customers.find(c => c.id === inv.customerId)
    const dueDate = new Date(inv.invoiceDate)
    dueDate.setDate(dueDate.getDate() + (customer?.paymentTerms || 30))
    const today = new Date()
    const daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))
    
    return {
      ...inv,
      customerName: customer?.name || 'Unknown',
      dueDate: dueDate.toISOString().split('T')[0],
      daysOverdue: inv.balance > 0 ? Math.max(0, daysOverdue) : 0,
      status: inv.balance <= 0 ? 'paid' : daysOverdue > 0 ? 'overdue' : 'pending',
    }
  })

  // Aging buckets
  const getAgingBuckets = (data, balanceField = 'balance') => {
    return {
      current: data.filter(d => d.daysOverdue === 0 && d[balanceField] > 0).reduce((sum, d) => sum + d[balanceField], 0),
      days1to30: data.filter(d => d.daysOverdue > 0 && d.daysOverdue <= 30).reduce((sum, d) => sum + d[balanceField], 0),
      days31to60: data.filter(d => d.daysOverdue > 30 && d.daysOverdue <= 60).reduce((sum, d) => sum + d[balanceField], 0),
      days61to90: data.filter(d => d.daysOverdue > 60 && d.daysOverdue <= 90).reduce((sum, d) => sum + d[balanceField], 0),
      over90: data.filter(d => d.daysOverdue > 90).reduce((sum, d) => sum + d[balanceField], 0),
    }
  }

  const apAging = getAgingBuckets(apData)
  const arAging = getAgingBuckets(arData)

  const totalAP = apData.reduce((sum, d) => sum + d.balance, 0)
  const totalAR = arData.reduce((sum, d) => sum + d.balance, 0)

  // Mock journal entries
  const journalEntries = [
    { id: 'JE-001', date: '2025-01-28', description: 'Purchase - MLH Wood from KBB', debit: 'Inventory', credit: 'AP', amount: 245000 },
    { id: 'JE-002', date: '2025-01-27', description: 'Sales Invoice INV-2501-001', debit: 'AR', credit: 'Revenue', amount: 185000 },
    { id: 'JE-003', date: '2025-01-26', description: 'Payment to KBB Enterprise', debit: 'AP', credit: 'Cash', amount: 150000 },
    { id: 'JE-004', date: '2025-01-25', description: 'Receipt from Seagate', debit: 'Cash', credit: 'AR', amount: 320000 },
    { id: 'JE-005', date: '2025-01-24', description: 'Payroll - January', debit: 'Wage Expense', credit: 'Cash', amount: 485000 },
  ]

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.accounting', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô' : 'Manage accounting and finance'}</p>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Dashboard */}
      {activeTab === 'dashboard' && (
        <div className="space-y-6">
          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <Card className="p-4 border-l-4 border-l-red-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏° (AP)' : 'Total Payables'}</div>
              <div className="text-2xl font-bold text-red-600">{formatCurrency(totalAP)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏° (AR)' : 'Total Receivables'}</div>
              <div className="text-2xl font-bold text-green-600">{formatCurrency(totalAR)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏∏‡∏ó‡∏ò‡∏¥' : 'Net Position'}</div>
              <div className={`text-2xl font-bold ${totalAR - totalAP >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {formatCurrency(totalAR - totalAP)}
              </div>
            </Card>
            <Card className="p-4 border-l-4 border-l-orange-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Overdue'}</div>
              <div className="text-2xl font-bold text-orange-600">
                {formatCurrency(apAging.days1to30 + apAging.days31to60 + apAging.days61to90 + apAging.over90 + arAging.days1to30 + arAging.days31to60 + arAging.days61to90 + arAging.over90)}
              </div>
            </Card>
          </div>

          {/* Aging Summary */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* AP Aging */}
            <Card className="p-5">
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ (AP Aging)' : 'AP Aging'}</h3>
              <div className="space-y-3">
                {[
                  { label: lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Current', value: apAging.current, color: 'bg-green-500' },
                  { label: '1-30 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: apAging.days1to30, color: 'bg-yellow-500' },
                  { label: '31-60 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: apAging.days31to60, color: 'bg-orange-500' },
                  { label: '61-90 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: apAging.days61to90, color: 'bg-red-400' },
                  { label: '90+ ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: apAging.over90, color: 'bg-red-600' },
                ].map(bucket => (
                  <div key={bucket.label} className="flex items-center gap-3">
                    <div className={`w-3 h-3 rounded-full ${bucket.color}`} />
                    <div className="flex-1 text-sm text-gray-600">{bucket.label}</div>
                    <div className="font-medium">{formatCurrency(bucket.value)}</div>
                  </div>
                ))}
                <div className="pt-3 border-t flex justify-between font-bold">
                  <span>{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</span>
                  <span className="text-red-600">{formatCurrency(totalAP)}</span>
                </div>
              </div>
            </Card>

            {/* AR Aging */}
            <Card className="p-5">
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏≠‡∏≤‡∏¢‡∏∏‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (AR Aging)' : 'AR Aging'}</h3>
              <div className="space-y-3">
                {[
                  { label: lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Current', value: arAging.current, color: 'bg-green-500' },
                  { label: '1-30 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: arAging.days1to30, color: 'bg-yellow-500' },
                  { label: '31-60 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: arAging.days31to60, color: 'bg-orange-500' },
                  { label: '61-90 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: arAging.days61to90, color: 'bg-red-400' },
                  { label: '90+ ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), value: arAging.over90, color: 'bg-red-600' },
                ].map(bucket => (
                  <div key={bucket.label} className="flex items-center gap-3">
                    <div className={`w-3 h-3 rounded-full ${bucket.color}`} />
                    <div className="flex-1 text-sm text-gray-600">{bucket.label}</div>
                    <div className="font-medium">{formatCurrency(bucket.value)}</div>
                  </div>
                ))}
                <div className="pt-3 border-t flex justify-between font-bold">
                  <span>{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</span>
                  <span className="text-green-600">{formatCurrency(totalAR)}</span>
                </div>
              </div>
            </Card>
          </div>
        </div>
      )}

      {/* Accounts Payable */}
      {activeTab === 'ap' && (
        <Card className="overflow-hidden">
          <div className="p-4 bg-red-50 border-b border-red-100">
            <h3 className="font-bold text-red-800">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ' : 'Accounts Payable'}</h3>
            <p className="text-sm text-red-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Outstanding vendor balances'}</p>
          </div>
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO' : 'PO #'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Due Date'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Total'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Balance'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {apData.map(item => (
                <tr key={item.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 font-mono text-[#1A5276]">{item.id}</td>
                  <td className="px-4 py-3">{item.vendorName}</td>
                  <td className="px-4 py-3">
                    {formatDate(item.dueDate)}
                    {item.daysOverdue > 0 && (
                      <div className="text-xs text-red-500">{item.daysOverdue} {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô' : 'days over'}</div>
                    )}
                  </td>
                  <td className="px-4 py-3 text-right">{formatCurrency(item.total)}</td>
                  <td className="px-4 py-3 text-right text-green-600">{formatCurrency(item.paidAmount)}</td>
                  <td className="px-4 py-3 text-right font-bold text-red-600">{formatCurrency(item.balance)}</td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={item.status === 'paid' ? 'success' : item.status === 'overdue' ? 'danger' : 'warning'}>
                      {item.status === 'paid' ? (lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid') : 
                       item.status === 'overdue' ? (lang === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Overdue') : 
                       (lang === 'th' ? '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞' : 'Pending')}
                    </Badge>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>
      )}

      {/* Accounts Receivable */}
      {activeTab === 'ar' && (
        <Card className="overflow-hidden">
          <div className="p-4 bg-green-50 border-b border-green-100">
            <h3 className="font-bold text-green-800">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ' : 'Accounts Receivable'}</h3>
            <p className="text-sm text-green-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Outstanding customer balances'}</p>
          </div>
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice #'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Due Date'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Total'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Balance'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {arData.map(item => (
                <tr key={item.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 font-mono text-[#1A5276]">{item.id}</td>
                  <td className="px-4 py-3">{item.customerName}</td>
                  <td className="px-4 py-3">
                    {formatDate(item.dueDate)}
                    {item.daysOverdue > 0 && (
                      <div className="text-xs text-red-500">{item.daysOverdue} {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô' : 'days over'}</div>
                    )}
                  </td>
                  <td className="px-4 py-3 text-right">{formatCurrency(item.grandTotal)}</td>
                  <td className="px-4 py-3 text-right text-green-600">{formatCurrency(item.paidAmount)}</td>
                  <td className="px-4 py-3 text-right font-bold text-orange-600">{formatCurrency(item.balance)}</td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={item.status === 'paid' ? 'success' : item.status === 'overdue' ? 'danger' : 'warning'}>
                      {item.status === 'paid' ? (lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Paid') : 
                       item.status === 'overdue' ? (lang === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Overdue') : 
                       (lang === 'th' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'Pending')}
                    </Badge>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>
      )}

      {/* Journal Entries */}
      {activeTab === 'journal' && (
        <Card className="overflow-hidden">
          <div className="p-4 bg-blue-50 border-b border-blue-100 flex items-center justify-between">
            <div>
              <h3 className="font-bold text-blue-800">{lang === 'th' ? '‡∏™‡∏°‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : 'General Journal'}</h3>
              <p className="text-sm text-blue-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' : 'Accounting entries'}</p>
            </div>
            <Button icon={Plus} size="sm">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'New Entry'}</Button>
          </div>
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'Entry #'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'Description'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏î‡∏ö‡∏¥‡∏ï' : 'Debit'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : 'Credit'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : 'Amount'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {journalEntries.map(entry => (
                <tr key={entry.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 font-mono text-[#1A5276]">{entry.id}</td>
                  <td className="px-4 py-3">{formatDate(entry.date)}</td>
                  <td className="px-4 py-3">{entry.description}</td>
                  <td className="px-4 py-3">
                    <Badge variant="info">{entry.debit}</Badge>
                  </td>
                  <td className="px-4 py-3">
                    <Badge variant="success">{entry.credit}</Badge>
                  </td>
                  <td className="px-4 py-3 text-right font-medium">{formatCurrency(entry.amount)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>
      )}

      {/* Cash Flow */}
      {activeTab === 'cashflow' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤' : 'Cash In'}</h3>
            <div className="space-y-3">
              <div className="flex justify-between p-3 bg-green-50 rounded-lg">
                <span className="text-green-700">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Receipts'}</span>
                <span className="font-bold text-green-700">{formatCurrency(320000)}</span>
              </div>
              <div className="flex justify-between p-3 bg-green-50 rounded-lg">
                <span className="text-green-700">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô' : 'Other Income'}</span>
                <span className="font-bold text-green-700">{formatCurrency(15000)}</span>
              </div>
              <div className="pt-3 border-t flex justify-between font-bold text-lg">
                <span>{lang === 'th' ? '‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤' : 'Total In'}</span>
                <span className="text-green-600">{formatCurrency(335000)}</span>
              </div>
            </div>
          </Card>
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å' : 'Cash Out'}</h3>
            <div className="space-y-3">
              <div className="flex justify-between p-3 bg-red-50 rounded-lg">
                <span className="text-red-700">{lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor Payments'}</span>
                <span className="font-bold text-red-700">{formatCurrency(150000)}</span>
              </div>
              <div className="flex justify-between p-3 bg-red-50 rounded-lg">
                <span className="text-red-700">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Payroll'}</span>
                <span className="font-bold text-red-700">{formatCurrency(485000)}</span>
              </div>
              <div className="flex justify-between p-3 bg-red-50 rounded-lg">
                <span className="text-red-700">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô' : 'Other Expenses'}</span>
                <span className="font-bold text-red-700">{formatCurrency(45000)}</span>
              </div>
              <div className="pt-3 border-t flex justify-between font-bold text-lg">
                <span>{lang === 'th' ? '‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å' : 'Total Out'}</span>
                <span className="text-red-600">{formatCurrency(680000)}</span>
              </div>
            </div>
          </Card>
        </div>
      )}
    </div>
  )
}

// ============================================
// REPORTS MODULE (Full)
// ============================================
const ReportsModule = ({ inventory, purchaseOrders, workOrders, salesOrders, invoices, categories, stores, customers, vendors, employees, lang }) => {
  const [activeReport, setActiveReport] = useState('inventory')
  const [dateRange, setDateRange] = useState({ from: '2025-01-01', to: '2025-01-31' })

  const reports = [
    { id: 'inventory', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á' : 'Inventory Report', icon: Package },
    { id: 'purchase', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠' : 'Purchase Report', icon: ShoppingCart },
    { id: 'production', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : 'Production Report', icon: Factory },
    { id: 'sales', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' : 'Sales Report', icon: Receipt },
    { id: 'profitability', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡πÑ‡∏£' : 'Profitability Report', icon: TrendingUp },
    { id: 'payroll', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Payroll Report', icon: Users },
  ]

  // Calculate inventory by store
  const inventoryByStore = stores.map(store => {
    const items = inventory.filter(i => i.store === store.id)
    return {
      store: store.code,
      storeName: lang === 'th' ? store.nameTh : store.nameEn,
      items: items.length,
      qty: items.reduce((sum, i) => sum + i.qty, 0),
      cbm: items.reduce((sum, i) => sum + (i.cbm || 0), 0),
      value: items.reduce((sum, i) => sum + (i.cost || 0), 0),
    }
  })

  // Calculate inventory by category
  const inventoryByCategory = categories.filter(c => c.type === 'raw_material').map(cat => {
    const items = inventory.filter(i => i.category === cat.id)
    return {
      category: cat.code,
      categoryName: lang === 'th' ? cat.nameTh : cat.nameEn,
      color: cat.color,
      items: items.length,
      qty: items.reduce((sum, i) => sum + i.qty, 0),
      cbm: items.reduce((sum, i) => sum + (i.cbm || 0), 0),
      value: items.reduce((sum, i) => sum + (i.cost || 0), 0),
    }
  })

  // Purchase summary
  const purchaseSummary = {
    totalPOs: purchaseOrders.length,
    localPOs: purchaseOrders.filter(po => po.type === 'local').length,
    importPOs: purchaseOrders.filter(po => po.type === 'import').length,
    totalValue: purchaseOrders.reduce((sum, po) => sum + (po.total || po.grandTotal || 0), 0),
    importCosts: purchaseOrders.reduce((sum, po) => sum + (po.totalImportCosts || 0), 0),
    pending: purchaseOrders.filter(po => po.status === 'pending').length,
    received: purchaseOrders.filter(po => po.status === 'received').length,
  }

  // Production summary
  const productionSummary = {
    totalWOs: workOrders.length,
    completed: workOrders.filter(wo => wo.status === 'completed').length,
    inProgress: workOrders.filter(wo => wo.status === 'in_progress').length,
    totalRevenue: workOrders.reduce((sum, wo) => sum + (wo.totalRevenue || 0), 0),
    totalCost: workOrders.reduce((sum, wo) => sum + (wo.costs?.total || 0), 0),
    totalProfit: workOrders.reduce((sum, wo) => sum + (wo.totalRevenue || 0), 0) - workOrders.reduce((sum, wo) => sum + (wo.costs?.total || 0), 0),
  }

  // Sales summary
  const salesSummary = {
    totalOrders: salesOrders.length,
    totalInvoices: invoices.length,
    totalRevenue: invoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0),
    totalReceived: invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0),
    outstanding: invoices.reduce((sum, inv) => sum + (inv.balance || 0), 0),
  }

  // Payroll summary
  const payrollSummary = {
    totalEmployees: employees.length,
    fullTime: employees.filter(e => e.type === 'FT').length,
    partTime: employees.filter(e => e.type === 'PT').length,
    totalSalary: employees.reduce((sum, e) => sum + (e.salary || 0), 0),
    totalGross: employees.reduce((sum, e) => sum + (e.salary || 0) + (e.positionInc || 0) + (e.diligenceInc || 0) + (e.phoneAllowance || 0), 0),
    totalSSO: employees.filter(e => e.type === 'FT').reduce((sum, e) => sum + Math.min(((e.salary || 0) + (e.positionInc || 0)) * 0.05, 750), 0),
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.reports', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå' : 'Reports and Analytics'}</p>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2">
            <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏à‡∏≤‡∏Å' : 'From'}</label>
            <input
              type="date"
              value={dateRange.from}
              onChange={(e) => setDateRange({ ...dateRange, from: e.target.value })}
              className="px-3 py-2 border rounded-lg text-sm"
            />
          </div>
          <div className="flex items-center gap-2">
            <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏ñ‡∏∂‡∏á' : 'To'}</label>
            <input
              type="date"
              value={dateRange.to}
              onChange={(e) => setDateRange({ ...dateRange, to: e.target.value })}
              className="px-3 py-2 border rounded-lg text-sm"
            />
          </div>
          <Button variant="outline" icon={Download}>
            {lang === 'th' ? '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å' : 'Export'}
          </Button>
        </div>
      </div>

      {/* Report Selection */}
      <div className="flex flex-wrap gap-2">
        {reports.map(report => (
          <button
            key={report.id}
            onClick={() => setActiveReport(report.id)}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all ${
              activeReport === report.id
                ? 'bg-[#1A5276] text-white'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            <report.icon className="w-4 h-4" />
            {report.label}
          </button>
        ))}
      </div>

      {/* Inventory Report */}
      {activeReport === 'inventory' && (
        <div className="space-y-6">
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡πá‡∏≠‡∏ï' : 'Total Lots'}</div>
              <div className="text-2xl font-bold text-gray-800">{inventory.length}</div>
            </Card>
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°' : 'Total Qty'}</div>
              <div className="text-2xl font-bold text-gray-800">{formatNumber(inventory.reduce((sum, i) => sum + i.qty, 0))}</div>
            </Card>
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏£‡∏ß‡∏°' : 'Total CBM'}</div>
              <div className="text-2xl font-bold text-blue-600">{inventory.reduce((sum, i) => sum + (i.cbm || 0), 0).toFixed(2)} m¬≥</div>
            </Card>
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Value'}</div>
              <div className="text-2xl font-bold text-[#2ECC40]">{formatCurrency(inventory.reduce((sum, i) => sum + (i.cost || 0), 0))}</div>
            </Card>
          </div>

          {/* By Store */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏•‡∏±‡∏á (6 ‡∏Ñ‡∏•‡∏±‡∏á)' : 'Inventory by Store (6 Stores)'}</h3>
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á' : 'Store'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Items'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">CBM</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {inventoryByStore.map(row => (
                  <tr key={row.store} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="font-mono text-[#1A5276]">{row.store}</div>
                      <div className="text-sm text-gray-500">{row.storeName}</div>
                    </td>
                    <td className="px-4 py-3 text-right">{row.items}</td>
                    <td className="px-4 py-3 text-right">{formatNumber(row.qty)}</td>
                    <td className="px-4 py-3 text-right">{row.cbm.toFixed(3)}</td>
                    <td className="px-4 py-3 text-right font-medium text-[#2ECC40]">{formatCurrency(row.value)}</td>
                  </tr>
                ))}
              </tbody>
              <tfoot className="bg-gray-100 font-bold">
                <tr>
                  <td className="px-4 py-3">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</td>
                  <td className="px-4 py-3 text-right">{inventoryByStore.reduce((sum, r) => sum + r.items, 0)}</td>
                  <td className="px-4 py-3 text-right">{formatNumber(inventoryByStore.reduce((sum, r) => sum + r.qty, 0))}</td>
                  <td className="px-4 py-3 text-right">{inventoryByStore.reduce((sum, r) => sum + r.cbm, 0).toFixed(3)}</td>
                  <td className="px-4 py-3 text-right text-[#2ECC40]">{formatCurrency(inventoryByStore.reduce((sum, r) => sum + r.value, 0))}</td>
                </tr>
              </tfoot>
            </table>
          </Card>

          {/* By Category */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (8 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏°‡πâ)' : 'Inventory by Category (8 Wood Types)'}</h3>
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Items'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">CBM</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {inventoryByCategory.map(row => (
                  <tr key={row.category} className="hover:bg-gray-50">
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        <span className="w-3 h-3 rounded-full" style={{ backgroundColor: row.color }} />
                        <span className="font-mono" style={{ color: row.color }}>{row.category}</span>
                      </div>
                      <div className="text-sm text-gray-500 ml-5">{row.categoryName}</div>
                    </td>
                    <td className="px-4 py-3 text-right">{row.items}</td>
                    <td className="px-4 py-3 text-right">{formatNumber(row.qty)}</td>
                    <td className="px-4 py-3 text-right">{row.cbm.toFixed(3)}</td>
                    <td className="px-4 py-3 text-right font-medium text-[#2ECC40]">{formatCurrency(row.value)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </Card>
        </div>
      )}

      {/* Purchase Report */}
      {activeReport === 'purchase' && (
        <div className="space-y-6">
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total POs'}</div>
              <div className="text-2xl font-bold text-gray-800">{purchaseSummary.totalPOs}</div>
              <div className="text-xs text-gray-400 mt-1">
                üè† {purchaseSummary.localPOs} {lang === 'th' ? '‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' : 'Local'} | üö¢ {purchaseSummary.importPOs} {lang === 'th' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import'}
              </div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Value'}</div>
              <div className="text-2xl font-bold text-green-600">{formatCurrency(purchaseSummary.totalValue)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-orange-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏ß‡∏°' : 'Import Costs'}</div>
              <div className="text-2xl font-bold text-orange-600">{formatCurrency(purchaseSummary.importCosts)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</div>
              <div className="text-sm mt-1">
                <span className="text-yellow-600">‚è≥ {purchaseSummary.pending} {lang === 'th' ? '‡∏£‡∏≠' : 'Pending'}</span>
                <span className="mx-2">|</span>
                <span className="text-green-600">‚úì {purchaseSummary.received} {lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</span>
              </div>
            </Card>
          </div>

          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : 'Purchase Order List'}</h3>
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'PO #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Materials'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {purchaseOrders.map(po => {
                  const vendor = vendors.find(v => v.id === po.vendorId)
                  return (
                    <tr key={po.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{po.id}</td>
                      <td className="px-4 py-3">{vendor?.name || po.vendorId}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={po.type === 'import' ? 'info' : 'success'}>
                          {po.type === 'import' ? 'üö¢' : 'üè†'} {po.type}
                        </Badge>
                      </td>
                      <td className="px-4 py-3 text-right">{formatCurrency(po.subtotal || 0)}</td>
                      <td className="px-4 py-3 text-right text-orange-600">{formatCurrency(po.totalImportCosts || 0)}</td>
                      <td className="px-4 py-3 text-right font-bold">{formatCurrency(po.total || po.grandTotal || 0)}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={po.status === 'received' ? 'success' : 'warning'}>{po.status}</Badge>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </Card>
        </div>
      )}

      {/* Production Report */}
      {activeReport === 'production' && (
        <div className="space-y-6">
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total WOs'}</div>
              <div className="text-2xl font-bold text-gray-800">{productionSummary.totalWOs}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Total Revenue'}</div>
              <div className="text-2xl font-bold text-green-600">{formatCurrency(productionSummary.totalRevenue)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-red-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°' : 'Total Cost'}</div>
              <div className="text-2xl font-bold text-red-600">{formatCurrency(productionSummary.totalCost)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°' : 'Total Profit'}</div>
              <div className="text-2xl font-bold text-blue-600">{formatCurrency(productionSummary.totalProfit)}</div>
            </Card>
          </div>

          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Work Order List'}</h3>
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'WO #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô' : 'Cost'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' : 'Revenue'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Å‡∏≥‡πÑ‡∏£' : 'Margin'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {workOrders.map(wo => {
                  const customer = customers.find(c => c.id === wo.customerId)
                  const profit = (wo.totalRevenue || 0) - (wo.costs?.total || 0)
                  const margin = wo.totalRevenue > 0 ? (profit / wo.totalRevenue * 100) : 0
                  return (
                    <tr key={wo.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-[#1A5276]">{wo.id}</td>
                      <td className="px-4 py-3">{wo.productName}</td>
                      <td className="px-4 py-3">{customer?.name || wo.customerId}</td>
                      <td className="px-4 py-3 text-right">{wo.quantity}</td>
                      <td className="px-4 py-3 text-right text-red-600">{formatCurrency(wo.costs?.total || 0)}</td>
                      <td className="px-4 py-3 text-right text-green-600">{formatCurrency(wo.totalRevenue || 0)}</td>
                      <td className="px-4 py-3 text-right">
                        <span className={`font-medium ${margin >= 20 ? 'text-green-600' : margin >= 10 ? 'text-yellow-600' : 'text-red-600'}`}>
                          {margin.toFixed(1)}%
                        </span>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </Card>
        </div>
      )}

      {/* Sales Report */}
      {activeReport === 'sales' && (
        <div className="space-y-6">
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Sales Orders'}</div>
              <div className="text-2xl font-bold text-gray-800">{salesSummary.totalOrders}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Total Revenue'}</div>
              <div className="text-2xl font-bold text-green-600">{formatCurrency(salesSummary.totalRevenue)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
              <div className="text-2xl font-bold text-blue-600">{formatCurrency(salesSummary.totalReceived)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-orange-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
              <div className="text-2xl font-bold text-orange-600">{formatCurrency(salesSummary.outstanding)}</div>
            </Card>
          </div>
        </div>
      )}

      {/* Profitability Report */}
      {activeReport === 'profitability' && (
        <ProductionCosting workOrders={workOrders} customers={customers} lang={lang} />
      )}

      {/* Payroll Report */}
      {activeReport === 'payroll' && (
        <div className="space-y-6">
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total Employees'}</div>
              <div className="text-2xl font-bold text-gray-800">{payrollSummary.totalEmployees}</div>
              <div className="text-xs text-gray-400 mt-1">FT: {payrollSummary.fullTime} | PT: {payrollSummary.partTime}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°' : 'Total Salary'}</div>
              <div className="text-2xl font-bold text-blue-600">{formatCurrency(payrollSummary.totalSalary)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (Gross)' : 'Total Gross'}</div>
              <div className="text-2xl font-bold text-green-600">{formatCurrency(payrollSummary.totalGross)}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-red-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏£‡∏ß‡∏°' : 'Total SSO'}</div>
              <div className="text-2xl font-bold text-red-600">{formatCurrency(payrollSummary.totalSSO)}</div>
            </Card>
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// SALES ORDER FORM (Enhanced with Delivery Schedule)
// ============================================
const SalesOrderForm = ({ so, customers, products, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    customerId: so?.customerId || '',
    customerPO: so?.customerPO || '',
    orderDate: so?.orderDate || new Date().toISOString().split('T')[0],
    items: so?.items || [{ id: 1, productName: '', qty: 0, unit: 'pcs', unitPrice: 0, deliverySchedule: [] }],
    notes: so?.notes || '',
    entity: so?.entity || 'IND',
  })
  const [showDeliverySchedule, setShowDeliverySchedule] = useState(false)
  const [selectedItemIdx, setSelectedItemIdx] = useState(null)

  const selectedCustomer = customers.find(c => c.id === formData.customerId)
  const deliveryLocations = selectedCustomer?.deliveryLocations || []

  const addItem = () => {
    setFormData(prev => ({
      ...prev,
      items: [...prev.items, { id: prev.items.length + 1, productName: '', qty: 0, unit: 'pcs', unitPrice: 0, deliverySchedule: [] }]
    }))
  }

  const updateItem = (idx, field, value) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => i === idx ? { ...item, [field]: value } : item)
    }))
  }

  const removeItem = (idx) => {
    if (formData.items.length > 1) {
      setFormData(prev => ({
        ...prev,
        items: prev.items.filter((_, i) => i !== idx)
      }))
    }
  }

  // Add delivery schedule entry for an item
  const addDeliverySchedule = (itemIdx) => {
    const defaultLocation = deliveryLocations.find(l => l.isDefault) || deliveryLocations[0]
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => {
        if (i === itemIdx) {
          const remainingQty = item.qty - (item.deliverySchedule?.reduce((sum, s) => sum + s.qty, 0) || 0)
          return {
            ...item,
            deliverySchedule: [
              ...(item.deliverySchedule || []),
              { 
                id: (item.deliverySchedule?.length || 0) + 1,
                locationId: defaultLocation?.id || '',
                locationName: defaultLocation?.name || '',
                qty: Math.max(0, remainingQty),
                deliveryDate: '',
                status: 'planned'
              }
            ]
          }
        }
        return item
      })
    }))
  }

  const updateDeliverySchedule = (itemIdx, schedIdx, field, value) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => {
        if (i === itemIdx) {
          return {
            ...item,
            deliverySchedule: item.deliverySchedule.map((sched, j) => {
              if (j === schedIdx) {
                if (field === 'locationId') {
                  const loc = deliveryLocations.find(l => l.id === value)
                  return { ...sched, locationId: value, locationName: loc?.name || '' }
                }
                return { ...sched, [field]: value }
              }
              return sched
            })
          }
        }
        return item
      })
    }))
  }

  const removeDeliverySchedule = (itemIdx, schedIdx) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => {
        if (i === itemIdx) {
          return {
            ...item,
            deliverySchedule: item.deliverySchedule.filter((_, j) => j !== schedIdx)
          }
        }
        return item
      })
    }))
  }

  const subtotal = formData.items.reduce((sum, item) => sum + (item.qty * item.unitPrice), 0)
  const vat = subtotal * 0.07
  const grandTotal = subtotal + vat

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave({
      ...formData,
      subtotal,
      vat,
      grandTotal,
      status: 'confirmed',
    })
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Customer Selection with Order Type Badge */}
      <div className="grid grid-cols-4 gap-4">
        <div className="col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *' : 'Customer *'}
          </label>
          <select
            required
            value={formData.customerId}
            onChange={(e) => setFormData({ ...formData, customerId: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
            {customers.map(c => (
              <option key={c.id} value={c.id}>
                {c.name} ({c.orderType || 'PO'}) - {c.deliveryLocations?.length || 1} locations
              </option>
            ))}
          </select>
          {selectedCustomer && (
            <div className="mt-2 flex items-center gap-2">
              <Badge variant={selectedCustomer.orderType === 'PR' ? 'warning' : selectedCustomer.orderType === 'Direct' ? 'success' : 'info'}>
                {selectedCustomer.orderType || 'PO'} Customer
              </Badge>
              <span className="text-xs text-gray-500">
                {selectedCustomer.deliveryLocations?.length || 0} delivery location(s)
              </span>
              {selectedCustomer.specialRequirements?.qrLabels && <Badge variant="purple">QR Labels</Badge>}
              {selectedCustomer.specialRequirements?.htCertificate && <Badge variant="orange">HT Cert</Badge>}
            </div>
          )}
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? 'PO/PR ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer PO/PR #'}
          </label>
          <input
            type="text"
            value={formData.customerPO}
            onChange={(e) => setFormData({ ...formData, customerPO: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
            placeholder={selectedCustomer?.orderType === 'PR' ? 'PR-XXXXX' : 'PO-XXXXX'}
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Entity'}
          </label>
          <select
            value={formData.entity}
            onChange={(e) => setFormData({ ...formData, entity: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="IND">IND Thai Packwell</option>
            <option value="IND2">IND-2 Thai Packwell</option>
          </select>
        </div>
      </div>

      {/* Order Date */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ *' : 'Order Date *'}
          </label>
          <input
            type="date"
            required
            value={formData.orderDate}
            onChange={(e) => setFormData({ ...formData, orderDate: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div className="flex items-end">
          <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 w-full">
            <strong>üí° {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á' : 'Delivery'}:</strong> {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á' : 'Set delivery dates per item below'}
          </div>
        </div>
      </div>

      {/* Items with Delivery Schedule */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="text-sm font-medium text-gray-700">
            {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á' : 'Items & Delivery Schedule'}
          </label>
          <Button type="button" size="sm" variant="outline" onClick={addItem}>
            + {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Add Item'}
          </Button>
        </div>
        
        <div className="space-y-4">
          {formData.items.map((item, idx) => {
            const scheduledQty = item.deliverySchedule?.reduce((sum, s) => sum + (s.qty || 0), 0) || 0
            const unscheduledQty = (item.qty || 0) - scheduledQty
            
            return (
              <Card key={idx} className="p-4 border-l-4 border-l-blue-400">
                {/* Item Row */}
                <div className="grid grid-cols-12 gap-2 items-end">
                  <div className="col-span-4">
                    <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</label>
                    <input
                      type="text"
                      value={item.productName}
                      onChange={(e) => updateItem(idx, 'productName', e.target.value)}
                      className="w-full px-2 py-1.5 border rounded text-sm"
                      placeholder="PT 950 X 1400"
                    />
                  </div>
                  <div className="col-span-2">
                    <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ß‡∏°' : 'Total Qty'}</label>
                    <input
                      type="number"
                      value={item.qty || ''}
                      onChange={(e) => updateItem(idx, 'qty', parseInt(e.target.value) || 0)}
                      className="w-full px-2 py-1.5 border rounded text-sm text-right"
                    />
                  </div>
                  <div className="col-span-1">
                    <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit'}</label>
                    <select
                      value={item.unit}
                      onChange={(e) => updateItem(idx, 'unit', e.target.value)}
                      className="w-full px-2 py-1.5 border rounded text-sm"
                    >
                      <option value="pcs">pcs</option>
                      <option value="sets">sets</option>
                    </select>
                  </div>
                  <div className="col-span-2">
                    <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Price'}</label>
                    <input
                      type="number"
                      step="0.01"
                      value={item.unitPrice || ''}
                      onChange={(e) => updateItem(idx, 'unitPrice', parseFloat(e.target.value) || 0)}
                      className="w-full px-2 py-1.5 border rounded text-sm text-right"
                    />
                  </div>
                  <div className="col-span-2 text-right">
                    <label className="block text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</label>
                    <div className="font-bold text-green-600">{formatCurrency(item.qty * item.unitPrice)}</div>
                  </div>
                  <div className="col-span-1 flex justify-end gap-1">
                    {formData.items.length > 1 && (
                      <button type="button" onClick={() => removeItem(idx)} className="text-red-500 hover:text-red-700 p-1">
                        <Trash2 className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                </div>

                {/* Delivery Schedule Section */}
                <div className="mt-3 pt-3 border-t border-dashed">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Truck className="w-4 h-4 text-orange-500" />
                      <span className="text-sm font-medium text-gray-700">
                        {lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á' : 'Delivery Schedule'}
                      </span>
                      {unscheduledQty > 0 && (
                        <Badge variant="warning">{unscheduledQty} {lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'unscheduled'}</Badge>
                      )}
                      {unscheduledQty === 0 && item.qty > 0 && (
                        <Badge variant="success">‚úì {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏£‡∏ö' : 'Fully scheduled'}</Badge>
                      )}
                    </div>
                    <Button 
                      type="button" 
                      size="sm" 
                      variant="outline" 
                      onClick={() => addDeliverySchedule(idx)}
                      disabled={!formData.customerId || deliveryLocations.length === 0}
                    >
                      + {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ß‡∏î‡∏™‡πà‡∏á' : 'Add Delivery'}
                    </Button>
                  </div>

                  {/* Delivery Schedule Entries */}
                  {item.deliverySchedule?.length > 0 ? (
                    <div className="space-y-2">
                      {item.deliverySchedule.map((sched, schedIdx) => (
                        <div key={schedIdx} className="flex items-center gap-2 p-2 bg-orange-50 rounded-lg">
                          <span className="text-xs font-medium text-orange-600 w-16">
                            #{schedIdx + 1}
                          </span>
                          <select
                            value={sched.locationId}
                            onChange={(e) => updateDeliverySchedule(idx, schedIdx, 'locationId', e.target.value)}
                            className="flex-1 px-2 py-1 border rounded text-sm"
                          >
                            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' : 'Select Location'}</option>
                            {deliveryLocations.map(loc => (
                              <option key={loc.id} value={loc.id}>
                                {loc.name} - {loc.address}
                              </option>
                            ))}
                          </select>
                          <input
                            type="number"
                            value={sched.qty || ''}
                            onChange={(e) => updateDeliverySchedule(idx, schedIdx, 'qty', parseInt(e.target.value) || 0)}
                            className="w-20 px-2 py-1 border rounded text-sm text-right"
                            placeholder="Qty"
                          />
                          <span className="text-xs text-gray-500">{item.unit}</span>
                          <input
                            type="date"
                            value={sched.deliveryDate || ''}
                            onChange={(e) => updateDeliverySchedule(idx, schedIdx, 'deliveryDate', e.target.value)}
                            className="w-36 px-2 py-1 border rounded text-sm"
                          />
                          <button 
                            type="button" 
                            onClick={() => removeDeliverySchedule(idx, schedIdx)}
                            className="text-red-400 hover:text-red-600 p-1"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-3 text-sm text-gray-400 bg-gray-50 rounded">
                      {!formData.customerId 
                        ? (lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á' : 'Select customer first')
                        : (lang === 'th' ? '‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ß‡∏î‡∏™‡πà‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á' : 'Click "Add Delivery" to schedule deliveries')
                      }
                    </div>
                  )}
                </div>
              </Card>
            )
          })}
        </div>
      </div>

      {/* Notes */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">
          {lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes'}
        </label>
        <textarea
          value={formData.notes}
          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
          rows={2}
          className="w-full px-3 py-2 border rounded-lg"
          placeholder={lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°, ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©...' : 'Additional notes, special requirements...'}
        />
      </div>

      {/* Totals */}
      <div className="bg-gray-50 rounded-lg p-4">
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-2 text-sm">
            <div className="flex justify-between">
              <span className="text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Subtotal'}</span>
              <span className="font-medium">{formatCurrency(subtotal)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">VAT 7%</span>
              <span className="font-medium">{formatCurrency(vat)}</span>
            </div>
          </div>
          <div className="flex items-end justify-end">
            <div className="text-right">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : 'Grand Total'}</div>
              <div className="text-3xl font-bold text-[#2ECC40]">{formatCurrency(grandTotal)}</div>
            </div>
          </div>
        </div>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>{t('action.cancel', lang)}</Button>
        <Button type="submit" icon={Save}>{t('action.save', lang)}</Button>
      </div>
    </form>
  )
}

// ============================================
// INVOICE VIEW (For printing)
// ============================================
const InvoiceView = ({ invoice, customer, entity, lang }) => {
  const printRef = useRef()

  const handlePrint = () => {
    const content = printRef.current
    const printWindow = window.open('', '_blank')
    printWindow.document.write('<html><head><title>Invoice ' + invoice.id + '</title>')
    printWindow.document.write('<style>')
    printWindow.document.write(`
      * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
      body { padding: 15mm; }
      .invoice { max-width: 210mm; }
      .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
      .logo-container { display: flex; align-items: center; gap: 15px; }
      .logo img { width: 80px; height: auto; }
      .company-info { font-size: 9pt; line-height: 1.4; }
      .company-name { font-size: 14pt; font-weight: bold; color: #1A5276; }
      .company-name-th { font-size: 12pt; color: #333; }
      .invoice-header { text-align: right; }
      .invoice-title { font-size: 20pt; font-weight: bold; color: #1A5276; border: 2px solid #1A5276; padding: 5px 15px; display: inline-block; }
      .invoice-title-th { font-size: 14pt; color: #1A5276; }
      .invoice-number { font-size: 14pt; font-weight: bold; margin-top: 10px; }
      .divider { border-bottom: 2px solid #1A5276; margin: 15px 0; }
      .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
      .info-box { border: 1px solid #ddd; padding: 10px; }
      .info-label { font-size: 9pt; color: #666; margin-bottom: 3px; }
      .info-value { font-size: 11pt; font-weight: 500; }
      table { width: 100%; border-collapse: collapse; margin: 15px 0; }
      th { background: #1A5276; color: white; padding: 8px; text-align: left; font-size: 10pt; }
      th.text-right { text-align: right; }
      td { padding: 8px; border-bottom: 1px solid #eee; font-size: 10pt; }
      .text-right { text-align: right; }
      .totals-container { display: flex; justify-content: flex-end; }
      .totals { width: 250px; }
      .total-row { display: flex; justify-content: space-between; padding: 5px 0; }
      .total-row.grand { border-top: 2px solid #1A5276; padding-top: 10px; margin-top: 5px; }
      .grand-total { font-size: 16pt; font-weight: bold; color: #2ECC40; }
      .qr-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; }
      .qr-code { width: 80px; height: 80px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 8pt; color: #999; }
      .signature-line { width: 150px; border-top: 1px solid #333; margin-top: 50px; padding-top: 5px; text-align: center; font-size: 9pt; }
      .footer { margin-top: 20px; font-size: 8pt; color: #666; text-align: center; }
    `)
    printWindow.document.write('</style></head><body>')
    printWindow.document.write(content.innerHTML)
    printWindow.document.write('</body></html>')
    printWindow.document.close()
    printWindow.print()
  }

  const companyInfo = COMPANY_ENTITIES.find(e => e.id === (entity || 'IND'))
  const invoiceDate = new Date(invoice.invoiceDate)
  const dueDate = new Date(invoiceDate.getTime() + (customer?.paymentTerms || 30) * 24 * 60 * 60 * 1000)

  return (
    <div className="space-y-4">
      <div ref={printRef} className="invoice bg-white p-6 border rounded-lg shadow-sm">
        {/* Header with Logo */}
        <div className="flex justify-between items-start mb-4">
          <div className="flex items-start gap-4">
            <img src={IND_LOGO_SVG} alt="IND" className="w-20 h-20" />
            <div className="text-sm">
              <div className="text-lg font-bold text-[#1A5276]">{companyInfo?.name || 'IND Thai Packwell Industries Co., Ltd.'}</div>
              <div className="text-[#1A5276]">{lang === 'th' ? '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏≠‡∏¥‡∏ô‡∏î‡πå ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ï‡∏£‡∏µ‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î' : ''}</div>
              <div className="text-gray-600 mt-1">{companyInfo?.address}</div>
              <div className="text-gray-600">Tel: {companyInfo?.phone || '02-XXX-XXXX'} | Fax: {companyInfo?.fax || '02-XXX-XXXX'}</div>
              <div className="text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ' : 'Tax ID'}: {companyInfo?.taxId}</div>
            </div>
          </div>
          <div className="text-right">
            <div className="inline-block border-2 border-[#1A5276] px-4 py-2">
              <div className="text-xl font-bold text-[#1A5276]">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : 'TAX INVOICE'}</div>
              <div className="text-sm text-[#1A5276]">{lang !== 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : 'TAX INVOICE'}</div>
            </div>
            <div className="mt-3">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'No.'}</div>
              <div className="text-lg font-bold font-mono">{invoice.id}</div>
            </div>
          </div>
        </div>

        <div className="border-b-2 border-[#1A5276] mb-4" />

        {/* Customer & Invoice Info */}
        <div className="grid grid-cols-2 gap-6 mb-4">
          <div className="border rounded p-4">
            <div className="text-xs text-gray-500 mb-1">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / Customer' : 'Bill To / Customer'}</div>
            <div className="font-bold text-lg">{customer?.name}</div>
            <div className="text-sm text-gray-600">{customer?.address}</div>
            <div className="text-sm text-gray-600 mt-1">
              <span className="text-gray-500">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:' : 'Tax ID:'}</span> {customer?.taxId || '-'}
            </div>
            <div className="text-sm text-gray-600">
              <span className="text-gray-500">{lang === 'th' ? '‡∏™‡∏≤‡∏Ç‡∏≤:' : 'Branch:'}</span> {customer?.branch || lang === 'th' ? '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà' : 'Head Office'}
            </div>
          </div>
          <div className="border rounded p-4">
            <div className="grid grid-cols-2 gap-y-2 text-sm">
              <div className="text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:' : 'Date:'}</div>
              <div className="font-medium">{formatDate(invoice.invoiceDate)}</div>
              
              <div className="text-gray-500">{lang === 'th' ? '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:' : 'Due Date:'}</div>
              <div className="font-medium">{formatDate(dueDate.toISOString().split('T')[0])}</div>
              
              <div className="text-gray-500">{lang === 'th' ? 'PO ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:' : 'Customer PO:'}</div>
              <div className="font-medium">{invoice.customerPO || '-'}</div>
              
              <div className="text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢:' : 'Sales Order:'}</div>
              <div className="font-medium">{invoice.soId || '-'}</div>
              
              <div className="text-gray-500">{lang === 'th' ? '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡∏≥‡∏£‡∏∞:' : 'Credit Terms:'}</div>
              <div className="font-medium">{customer?.paymentTerms || 30} {lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'Days'}</div>
              
              <div className="text-gray-500">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢:' : 'Salesperson:'}</div>
              <div className="font-medium">{invoice.salesperson || '-'}</div>
            </div>
          </div>
        </div>

        {/* Items Table */}
        <table className="w-full mb-4">
          <thead>
            <tr className="bg-[#1A5276] text-white">
              <th className="px-3 py-2 text-left w-12">{lang === 'th' ? '‡∏•‡∏≥‡∏î‡∏±‡∏ö' : 'No.'}</th>
              <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Description'}</th>
              <th className="px-3 py-2 text-right w-24">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
              <th className="px-3 py-2 text-right w-20">{lang === 'th' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit'}</th>
              <th className="px-3 py-2 text-right w-28">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit Price'}</th>
              <th className="px-3 py-2 text-right w-32">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : 'Amount'}</th>
            </tr>
          </thead>
          <tbody>
            {(invoice.items || []).map((item, idx) => (
              <tr key={idx} className="border-b">
                <td className="px-3 py-2 text-center">{idx + 1}</td>
                <td className="px-3 py-2">
                  <div>{item.productName || item.description}</div>
                  {item.lotNo && <div className="text-xs text-gray-500">Lot: {item.lotNo}</div>}
                </td>
                <td className="px-3 py-2 text-right">{item.qty?.toLocaleString()}</td>
                <td className="px-3 py-2 text-right">{item.unit || 'pcs'}</td>
                <td className="px-3 py-2 text-right">{formatCurrency(item.unitPrice)}</td>
                <td className="px-3 py-2 text-right">{formatCurrency(item.qty * item.unitPrice)}</td>
              </tr>
            ))}
            {/* Empty rows for minimum 5 lines */}
            {Array.from({ length: Math.max(0, 5 - (invoice.items || []).length) }).map((_, idx) => (
              <tr key={`empty-${idx}`} className="border-b h-10">
                <td className="px-3 py-2"></td>
                <td className="px-3 py-2"></td>
                <td className="px-3 py-2"></td>
                <td className="px-3 py-2"></td>
                <td className="px-3 py-2"></td>
                <td className="px-3 py-2"></td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* Totals & QR Code Section */}
        <div className="flex justify-between items-end">
          {/* Thai Amount in Words */}
          <div className="flex-1">
            <div className="text-sm text-gray-500 mb-1">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)' : 'Amount in Words'}</div>
            <div className="border rounded p-2 bg-gray-50 text-sm min-h-[40px]">
              {/* Amount in Thai words would go here */}
              {lang === 'th' ? `(${formatCurrency(invoice.grandTotal)})` : `${formatCurrency(invoice.grandTotal)} THB`}
            </div>
          </div>
          
          {/* Totals */}
          <div className="w-72 ml-4">
            <div className="flex justify-between py-1 border-b">
              <span className="text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô' : 'Subtotal'}</span>
              <span className="font-medium">{formatCurrency(invoice.subtotal)}</span>
            </div>
            {invoice.discount > 0 && (
              <div className="flex justify-between py-1 border-b">
                <span className="text-gray-600">{lang === 'th' ? '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î' : 'Discount'}</span>
                <span className="font-medium text-red-600">-{formatCurrency(invoice.discount)}</span>
              </div>
            )}
            <div className="flex justify-between py-1 border-b">
              <span className="text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô VAT' : 'Before VAT'}</span>
              <span className="font-medium">{formatCurrency(invoice.subtotal - (invoice.discount || 0))}</span>
            </div>
            <div className="flex justify-between py-1 border-b">
              <span className="text-gray-600">{lang === 'th' ? '‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°' : 'VAT'} 7%</span>
              <span className="font-medium">{formatCurrency(invoice.vat)}</span>
            </div>
            <div className="flex justify-between py-2 bg-gray-100 px-2 rounded mt-1">
              <span className="font-bold text-[#1A5276]">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : 'Grand Total'}</span>
              <span className="text-xl font-bold text-[#2ECC40]">{formatCurrency(invoice.grandTotal)}</span>
            </div>
          </div>
        </div>

        {/* Footer with QR and Signatures */}
        <div className="flex justify-between items-end mt-6 pt-4 border-t">
          {/* QR Code */}
          <div className="text-center">
            <div className="w-20 h-20 border-2 border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-400">
              QR Code
            </div>
            <div className="text-xs text-gray-500 mt-1">{lang === 'th' ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' : 'Scan to Pay'}</div>
          </div>

          {/* Signature Lines */}
          <div className="flex gap-8">
            <div className="text-center">
              <div className="w-32 border-t border-gray-400 mt-10" />
              <div className="text-xs text-gray-500 mt-1">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Received By'}</div>
              <div className="text-xs text-gray-400">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ____/____/____' : 'Date ____/____/____'}</div>
            </div>
            <div className="text-center">
              <div className="w-32 border-t border-gray-400 mt-10" />
              <div className="text-xs text-gray-500 mt-1">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏•‡∏á‡∏ô‡∏≤‡∏°' : 'Authorized Signature'}</div>
              <div className="text-xs text-gray-400">{companyInfo?.name?.split(' ')[0] || 'IND'}</div>
            </div>
          </div>
        </div>

        {/* Document Footer */}
        <div className="text-center text-xs text-gray-400 mt-4 pt-2 border-t">
          {lang === 'th' ? '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå' : 'This document is computer generated'}
        </div>
      </div>

      {/* Action Buttons */}
      <div className="flex justify-end gap-3">
        <Button variant="outline" icon={Download}>
          {lang === 'th' ? '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF' : 'Download PDF'}
        </Button>
        <Button icon={Printer} onClick={handlePrint}>
          {lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå' : 'Print'}
        </Button>
      </div>
    </div>
  )
}

// ============================================
// PAYMENT TRACKER
// ============================================
const PaymentTracker = ({ invoices, setInvoices, customers, lang }) => {
  const [showPaymentModal, setShowPaymentModal] = useState(false)
  const [selectedInvoice, setSelectedInvoice] = useState(null)
  const [paymentAmount, setPaymentAmount] = useState(0)
  const [paymentDate, setPaymentDate] = useState(new Date().toISOString().split('T')[0])
  const [paymentMethod, setPaymentMethod] = useState('transfer')
  const [paymentRef, setPaymentRef] = useState('')

  const unpaidInvoices = invoices.filter(inv => inv.balance > 0)
  const totalOutstanding = unpaidInvoices.reduce((sum, inv) => sum + inv.balance, 0)

  const handleRecordPayment = () => {
    if (!selectedInvoice || paymentAmount <= 0) return

    setInvoices(invoices.map(inv => {
      if (inv.id !== selectedInvoice.id) return inv
      const newPaid = (inv.paidAmount || 0) + paymentAmount
      const newBalance = inv.grandTotal - newPaid
      return {
        ...inv,
        paidAmount: newPaid,
        balance: newBalance,
        status: newBalance <= 0 ? 'paid' : 'partial',
        payments: [...(inv.payments || []), {
          id: Date.now(),
          amount: paymentAmount,
          date: paymentDate,
          method: paymentMethod,
          ref: paymentRef,
        }]
      }
    }))

    setShowPaymentModal(false)
    setSelectedInvoice(null)
    setPaymentAmount(0)
    setPaymentRef('')
  }

  return (
    <div className="space-y-6">
      {/* Summary */}
      <div className="grid grid-cols-3 gap-4">
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Unpaid Invoices'}</div>
          <div className="text-2xl font-bold text-orange-600">{unpaidInvoices.length}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-red-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏£‡∏ß‡∏°' : 'Total Outstanding'}</div>
          <div className="text-2xl font-bold text-red-600">{formatCurrency(totalOutstanding)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Total Received'}</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0))}</div>
        </Card>
      </div>

      {/* Unpaid Invoices List */}
      <Card className="overflow-hidden">
        <div className="p-4 bg-orange-50 border-b border-orange-100">
          <h3 className="font-bold text-orange-800">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞' : 'Pending Payments'}</h3>
        </div>
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'Invoice #'}</th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Total'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Balance'}</th>
              <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Action'}</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {unpaidInvoices.map(inv => {
              const customer = customers.find(c => c.id === inv.customerId)
              return (
                <tr key={inv.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 font-mono text-[#1A5276]">{inv.id}</td>
                  <td className="px-4 py-3">{customer?.name}</td>
                  <td className="px-4 py-3">{formatDate(inv.invoiceDate)}</td>
                  <td className="px-4 py-3 text-right">{formatCurrency(inv.grandTotal)}</td>
                  <td className="px-4 py-3 text-right text-green-600">{formatCurrency(inv.paidAmount || 0)}</td>
                  <td className="px-4 py-3 text-right font-bold text-red-600">{formatCurrency(inv.balance)}</td>
                  <td className="px-4 py-3 text-center">
                    <Button 
                      size="sm" 
                      onClick={() => { setSelectedInvoice(inv); setPaymentAmount(inv.balance); setShowPaymentModal(true) }}
                    >
                      {lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞' : 'Record Payment'}
                    </Button>
                  </td>
                </tr>
              )
            })}
            {unpaidInvoices.length === 0 && (
              <tr>
                <td colSpan="7" className="px-4 py-8 text-center text-gray-400">
                  {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'No outstanding invoices'}
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </Card>

      {/* Payment Modal */}
      {showPaymentModal && selectedInvoice && (
        <Modal isOpen={showPaymentModal} onClose={() => setShowPaymentModal(false)} title={lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞' : 'Record Payment'} size="md">
          <div className="space-y-4">
            <div className="p-4 bg-gray-50 rounded-lg">
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <div className="text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'}</div>
                  <div className="font-bold text-[#1A5276]">{selectedInvoice.id}</div>
                </div>
                <div className="text-right">
                  <div className="text-gray-500">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
                  <div className="font-bold text-red-600">{formatCurrency(selectedInvoice.balance)}</div>
                </div>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô *' : 'Amount *'}
              </label>
              <input
                type="number"
                value={paymentAmount}
                onChange={(e) => setPaymentAmount(parseFloat(e.target.value) || 0)}
                max={selectedInvoice.balance}
                className="w-full px-3 py-2 border rounded-lg text-right text-lg font-bold"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö' : 'Date'}
                </label>
                <input
                  type="date"
                  value={paymentDate}
                  onChange={(e) => setPaymentDate(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  {lang === 'th' ? '‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞' : 'Method'}
                </label>
                <select
                  value={paymentMethod}
                  onChange={(e) => setPaymentMethod(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="transfer">{lang === 'th' ? '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : 'Bank Transfer'}</option>
                  <option value="cash">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'Cash'}</option>
                  <option value="cheque">{lang === 'th' ? '‡πÄ‡∏ä‡πá‡∏Ñ' : 'Cheque'}</option>
                </select>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                {lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : 'Reference'}
              </label>
              <input
                type="text"
                value={paymentRef}
                onChange={(e) => setPaymentRef(e.target.value)}
                className="w-full px-3 py-2 border rounded-lg"
                placeholder={lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô / ‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ' : 'Transfer ref / Cheque no.'}
              />
            </div>

            <div className="flex justify-end gap-3 pt-4 border-t">
              <Button variant="secondary" onClick={() => setShowPaymentModal(false)}>
                {t('action.cancel', lang)}
              </Button>
              <Button icon={Save} onClick={handleRecordPayment}>
                {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save Payment'}
              </Button>
            </div>
          </div>
        </Modal>
      )}
    </div>
  )
}

// ============================================
// HR MODULE (Full with Payroll)
// ============================================
const HRModuleFull = ({ employees, setEmployees, lang }) => {
  const [activeTab, setActiveTab] = useState('employees')
  const [selectedMonth, setSelectedMonth] = useState('01')
  const [selectedYear, setSelectedYear] = useState('2025')
  const [showEmployeeForm, setShowEmployeeForm] = useState(false)
  const [editingEmployee, setEditingEmployee] = useState(null)

  const tabs = [
    { id: 'employees', label: lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Employees', icon: Users },
    { id: 'payroll', label: lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Payroll', icon: DollarSign },
    { id: 'attendance', label: lang === 'th' ? '‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : 'Attendance', icon: Clock },
    { id: 'leave', label: lang === 'th' ? '‡∏•‡∏≤‡∏á‡∏≤‡∏ô' : 'Leave', icon: Calendar },
  ]

  // Payroll calculations
  const calculatePayroll = (emp) => {
    const baseSalary = emp.salary || 0
    const positionInc = emp.positionInc || 0
    const diligenceInc = emp.diligenceInc || 0
    const phoneAllowance = emp.phoneAllowance || 0
    const otHours = emp.otHours || 0
    const otRate = (baseSalary / 30 / 8) * 1.5 // OT rate = 1.5x hourly
    const otPay = otHours * otRate
    
    const gross = baseSalary + positionInc + diligenceInc + phoneAllowance + otPay
    
    // SSO calculation (5% of salary+position, max 750)
    const ssoBase = baseSalary + positionInc
    const sso = emp.type === 'FT' ? Math.min(ssoBase * 0.05, 750) : 0
    
    // Tax calculation (simplified)
    const annualIncome = gross * 12
    let tax = 0
    if (annualIncome > 150000) {
      if (annualIncome <= 300000) tax = (annualIncome - 150000) * 0.05
      else if (annualIncome <= 500000) tax = 7500 + (annualIncome - 300000) * 0.10
      else if (annualIncome <= 750000) tax = 27500 + (annualIncome - 500000) * 0.15
      else tax = 65000 + (annualIncome - 750000) * 0.20
    }
    const monthlyTax = tax / 12

    const deductions = sso + monthlyTax
    const net = gross - deductions

    return { baseSalary, positionInc, diligenceInc, phoneAllowance, otHours, otPay, gross, sso, tax: monthlyTax, deductions, net }
  }

  const ftEmployees = employees.filter(e => e.type === 'FT')
  const ptEmployees = employees.filter(e => e.type === 'PT')

  const payrollData = employees.map(emp => ({
    ...emp,
    payroll: calculatePayroll(emp)
  }))

  const totals = {
    employees: employees.length,
    ft: ftEmployees.length,
    pt: ptEmployees.length,
    totalGross: payrollData.reduce((sum, e) => sum + e.payroll.gross, 0),
    totalSSO: payrollData.reduce((sum, e) => sum + e.payroll.sso, 0),
    totalTax: payrollData.reduce((sum, e) => sum + e.payroll.tax, 0),
    totalNet: payrollData.reduce((sum, e) => sum + e.payroll.net, 0),
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.hr', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Manage employees and payroll'}</p>
        </div>
        <Button icon={Plus} onClick={() => { setEditingEmployee(null); setShowEmployeeForm(true) }}>
          {lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Add Employee'}
        </Button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total'}</div>
          <div className="text-2xl font-bold text-gray-800">{totals.employees}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (FT)' : 'Full-time'}</div>
          <div className="text-2xl font-bold text-blue-600">{totals.ft}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏ó‡∏°‡πå (PT)' : 'Part-time'}</div>
          <div className="text-2xl font-bold text-orange-600">{totals.pt}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Gross'}</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(totals.totalGross)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-red-500">
          <div className="text-sm text-gray-500">SSO</div>
          <div className="text-2xl font-bold text-red-600">{formatCurrency(totals.totalSSO)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-purple-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏†‡∏≤‡∏©‡∏µ' : 'Tax'}</div>
          <div className="text-2xl font-bold text-purple-600">{formatCurrency(totals.totalTax)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-cyan-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏™‡∏∏‡∏ó‡∏ò‡∏¥' : 'Net'}</div>
          <div className="text-2xl font-bold text-cyan-600">{formatCurrency(totals.totalNet)}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-2 border-b">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276]' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* Employees List */}
      {activeTab === 'employees' && (
        <Card className="overflow-hidden">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'ID'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠' : 'Name'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å' : 'Department'}</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' : 'Position'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Salary'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Entity'}</th>
                <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {employees.map(emp => (
                <tr key={emp.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3 font-mono text-[#1A5276]">{emp.id}</td>
                  <td className="px-4 py-3">
                    <div className="font-medium">{emp.nameEn}</div>
                    <div className="text-sm text-gray-500">{emp.nameTh}</div>
                  </td>
                  <td className="px-4 py-3">{emp.department}</td>
                  <td className="px-4 py-3">{emp.position}</td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={emp.type === 'FT' ? 'info' : 'warning'}>{emp.type}</Badge>
                  </td>
                  <td className="px-4 py-3 text-right font-medium">{formatCurrency(emp.salary)}</td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={emp.entity === 'IND' ? 'success' : 'default'}>{emp.entity}</Badge>
                  </td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={emp.status === 'active' ? 'success' : 'danger'}>
                      {emp.status === 'active' ? (lang === 'th' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô' : 'Active') : (lang === 'th' ? '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å' : 'Inactive')}
                    </Badge>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </Card>
      )}

      {/* Payroll */}
      {activeTab === 'payroll' && (
        <div className="space-y-6">
          {/* Period Selector */}
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2">
              <label className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Month'}</label>
              <select
                value={selectedMonth}
                onChange={(e) => setSelectedMonth(e.target.value)}
                className="px-3 py-2 border rounded-lg"
              >
                {['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'].map(m => (
                  <option key={m} value={m}>{m}</option>
                ))}
              </select>
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏õ‡∏µ' : 'Year'}</label>
              <select
                value={selectedYear}
                onChange={(e) => setSelectedYear(e.target.value)}
                className="px-3 py-2 border rounded-lg"
              >
                <option value="2025">2025</option>
                <option value="2024">2024</option>
              </select>
            </div>
            <Button variant="outline" icon={Download}>
              {lang === 'th' ? '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel' : 'Export Excel'}
            </Button>
          </div>

          {/* Payroll Table */}
          <Card className="overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-50">{lang === 'th' ? '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Employee'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Salary'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' : 'Position'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Ç‡∏¢‡∏±‡∏ô' : 'Diligence'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' : 'Phone'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600">OT</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600 bg-blue-50">{lang === 'th' ? '‡∏£‡∏ß‡∏° (Gross)' : 'Gross'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600 bg-red-50">SSO</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600 bg-red-50">{lang === 'th' ? '‡∏†‡∏≤‡∏©‡∏µ' : 'Tax'}</th>
                    <th className="px-3 py-3 text-right font-medium text-gray-600 bg-green-50">{lang === 'th' ? '‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)' : 'Net'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {payrollData.filter(e => e.type === 'FT').map(emp => (
                    <tr key={emp.id} className="hover:bg-gray-50">
                      <td className="px-3 py-3 sticky left-0 bg-white">
                        <div className="font-medium">{emp.nameEn}</div>
                        <div className="text-xs text-gray-400">{emp.position}</div>
                      </td>
                      <td className="px-3 py-3 text-right">{formatCurrency(emp.payroll.baseSalary)}</td>
                      <td className="px-3 py-3 text-right">{formatCurrency(emp.payroll.positionInc)}</td>
                      <td className="px-3 py-3 text-right">{formatCurrency(emp.payroll.diligenceInc)}</td>
                      <td className="px-3 py-3 text-right">{formatCurrency(emp.payroll.phoneAllowance)}</td>
                      <td className="px-3 py-3 text-right">{formatCurrency(emp.payroll.otPay)}</td>
                      <td className="px-3 py-3 text-right font-bold text-blue-600 bg-blue-50">{formatCurrency(emp.payroll.gross)}</td>
                      <td className="px-3 py-3 text-right text-red-600 bg-red-50">{formatCurrency(emp.payroll.sso)}</td>
                      <td className="px-3 py-3 text-right text-red-600 bg-red-50">{formatCurrency(emp.payroll.tax)}</td>
                      <td className="px-3 py-3 text-right font-bold text-green-600 bg-green-50">{formatCurrency(emp.payroll.net)}</td>
                    </tr>
                  ))}
                </tbody>
                <tfoot className="bg-gray-100 font-bold">
                  <tr>
                    <td className="px-3 py-3 sticky left-0 bg-gray-100">{lang === 'th' ? '‡∏£‡∏ß‡∏° (FT)' : 'Total (FT)'}</td>
                    <td className="px-3 py-3 text-right">{formatCurrency(ftEmployees.reduce((s, e) => s + (e.salary || 0), 0))}</td>
                    <td className="px-3 py-3 text-right">{formatCurrency(ftEmployees.reduce((s, e) => s + (e.positionInc || 0), 0))}</td>
                    <td className="px-3 py-3 text-right">{formatCurrency(ftEmployees.reduce((s, e) => s + (e.diligenceInc || 0), 0))}</td>
                    <td className="px-3 py-3 text-right">{formatCurrency(ftEmployees.reduce((s, e) => s + (e.phoneAllowance || 0), 0))}</td>
                    <td className="px-3 py-3 text-right">-</td>
                    <td className="px-3 py-3 text-right text-blue-700 bg-blue-100">{formatCurrency(payrollData.filter(e => e.type === 'FT').reduce((s, e) => s + e.payroll.gross, 0))}</td>
                    <td className="px-3 py-3 text-right text-red-700 bg-red-100">{formatCurrency(payrollData.filter(e => e.type === 'FT').reduce((s, e) => s + e.payroll.sso, 0))}</td>
                    <td className="px-3 py-3 text-right text-red-700 bg-red-100">{formatCurrency(payrollData.filter(e => e.type === 'FT').reduce((s, e) => s + e.payroll.tax, 0))}</td>
                    <td className="px-3 py-3 text-right text-green-700 bg-green-100">{formatCurrency(payrollData.filter(e => e.type === 'FT').reduce((s, e) => s + e.payroll.net, 0))}</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* Attendance */}
      {activeTab === 'attendance' && (
        <Card className="p-8 text-center">
          <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Clock className="w-8 h-8 text-gray-400" />
          </div>
          <h3 className="font-bold text-gray-800 mb-2">{lang === 'th' ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤' : 'Time Attendance'}</h3>
          <p className="text-gray-500 mb-4">{lang === 'th' ? '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏≤‡∏¢‡∏ô‡∏¥‡πâ‡∏ß‡∏°‡∏∑‡∏≠' : 'Integration with fingerprint scanner'}</p>
          <Badge variant="warning">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤' : 'Coming Soon'}</Badge>
        </Card>
      )}

      {/* Leave */}
      {activeTab === 'leave' && (
        <Card className="p-8 text-center">
          <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Calendar className="w-8 h-8 text-gray-400" />
          </div>
          <h3 className="font-bold text-gray-800 mb-2">{lang === 'th' ? '‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏á‡∏≤‡∏ô' : 'Leave Management'}</h3>
          <p className="text-gray-500 mb-4">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ ‡∏•‡∏≤‡∏Å‡∏¥‡∏à' : 'Manage annual, sick, and personal leave'}</p>
          <Badge variant="warning">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤' : 'Coming Soon'}</Badge>
        </Card>
      )}
    </div>
  )
}

// ============================================
// ORDER-TO-DELIVERY TRACKER COMPONENT (v9.0)
// Complete tracking: PO ‚Üí Sales ‚Üí Production ‚Üí FG ‚Üí Delivery
// Features: Running table, 4 calendar views, revision history
// ============================================
const OrderTrackerComponent = ({ 
  salesOrders, setSalesOrders, 
  customers, workOrders, products, 
  deliveryOrders, setDeliveryOrders,
  invoices, setInvoices, 
  trucks, employees,
  lang = 'en' 
}) => {
  const [activeView, setActiveView] = useState('tracker')
  const [calendarView, setCalendarView] = useState('monthly')
  const [expandedOrders, setExpandedOrders] = useState({})
  const [expandedLines, setExpandedLines] = useState({})
  const [expandedSchedules, setExpandedSchedules] = useState({})
  const [filterCustomer, setFilterCustomer] = useState('all')
  const [filterStatus, setFilterStatus] = useState('all')
  const [filterType, setFilterType] = useState('all')
  const [selectedCustomerView, setSelectedCustomerView] = useState('')
  const [calendarDate, setCalendarDate] = useState(new Date())
  const [showUpdateModal, setShowUpdateModal] = useState(false)
  const [selectedOrderForUpdate, setSelectedOrderForUpdate] = useState(null)
  const [showAddScheduleModal, setShowAddScheduleModal] = useState(false)
  const [selectedLineForSchedule, setSelectedLineForSchedule] = useState(null)

  // Generate DO from schedule
  const handleCreateDO = (order, item, sched, schedIdx) => {
    const customer = customers?.find(c => c.id === order.customerId)
    const newDONumber = `${customer?.code || 'DO'}-${new Date().getFullYear().toString().slice(-2)}-${String((deliveryOrders?.length || 0) + 1).padStart(3, '0')}`
    
    const newDO = {
      id: newDONumber,
      soId: order.id,
      customerId: order.customerId,
      deliveryDate: sched.revisedDate || sched.deliveryDate,
      location: sched.locationName || sched.location,
      items: [{ ...item, qty: sched.qty }],
      status: 'pending',
      createdAt: new Date().toISOString(),
      createdBy: 'Sales'
    }
    
    setDeliveryOrders([...(deliveryOrders || []), newDO])
    
    // Update schedule with DO number
    setSalesOrders(salesOrders.map(so => {
      if (so.id !== order.id) return so
      return {
        ...so,
        items: so.items.map((itm, iIdx) => {
          if (itm.productId !== item.productId) return itm
          return {
            ...itm,
            deliverySchedule: itm.deliverySchedule.map((s, sIdx) => {
              if (sIdx !== schedIdx) return s
              return { ...s, doNumber: newDONumber, status: 'dispatched' }
            })
          }
        })
      }
    }))
    
    alert(`DO Created: ${newDONumber}`)
  }

  // Generate Invoice from DO
  const handleCreateInvoice = (order, item, sched) => {
    if (!sched.doNumber) {
      alert('Please create DO first')
      return
    }
    
    const newInvoiceNumber = `IV-${new Date().toISOString().slice(2, 7).replace('-', '')}-${String((invoices?.length || 0) + 1).padStart(3, '0')}`
    const amount = (sched.qty || 0) * (item.unitPrice || 0)
    const vat = amount * 0.07
    
    const newInvoice = {
      id: newInvoiceNumber,
      doId: sched.doNumber,
      soId: order.id,
      customerId: order.customerId,
      invoiceDate: new Date().toISOString().split('T')[0],
      dueDate: new Date(Date.now() + (order.paymentTerms || 30) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
      items: [{ ...item, qty: sched.qty, amount }],
      subtotal: amount,
      vatAmount: vat,
      grandTotal: amount + vat,
      balance: amount + vat,
      paidAmount: 0,
      status: 'pending',
      createdAt: new Date().toISOString()
    }
    
    setInvoices([...(invoices || []), newInvoice])
    
    // Update schedule with invoice number
    setSalesOrders(salesOrders.map(so => {
      if (so.id !== order.id) return so
      return {
        ...so,
        items: so.items.map((itm, iIdx) => {
          if (itm.productId !== item.productId) return itm
          return {
            ...itm,
            deliverySchedule: itm.deliverySchedule.map((s, sIdx) => {
              if (s.doNumber !== sched.doNumber) return s
              return { ...s, invoiceNumber: newInvoiceNumber }
            })
          }
        })
      }
    }))
    
    alert(`Invoice Created: ${newInvoiceNumber}`)
  }

  // Update order dates
  const handleUpdateOrder = (orderId, updates) => {
    setSalesOrders(salesOrders.map(so => {
      if (so.id !== orderId) return so
      return {
        ...so,
        ...updates,
        lastUpdated: new Date().toISOString(),
        updateHistory: [
          ...(so.updateHistory || []),
          { timestamp: new Date().toISOString(), updatedBy: 'Sales', changes: updates }
        ]
      }
    }))
    setShowUpdateModal(false)
  }

  // Add delivery schedule
  const handleAddSchedule = (orderId, itemIdx, scheduleData) => {
    setSalesOrders(salesOrders.map(so => {
      if (so.id !== orderId) return so
      return {
        ...so,
        lastUpdated: new Date().toISOString(),
        items: so.items.map((item, iIdx) => {
          if (iIdx !== itemIdx) return item
          return {
            ...item,
            deliverySchedule: [
              ...(item.deliverySchedule || []),
              {
                ...scheduleData,
                status: 'planned',
                currentVersion: 1,
                createdAt: new Date().toISOString(),
                revisionHistory: [{ version: 1, timestamp: new Date().toISOString(), changedBy: 'Sales', changeType: 'create', changes: { action: 'Schedule created' } }]
              }
            ]
          }
        })
      }
    }))
    setShowAddScheduleModal(false)
  }

  // Production scenarios (from Production Mapping tab)
  const productionScenarios = {
    'PLN 0': { path: ['FG', 'Transport'], name: 'FG + Transport', ht: false },
    'PLN 1': { path: ['P1', 'FG', 'Transport'], name: 'P1 + FG', ht: false },
    'PLN 1.0.1': { path: ['P1', 'Oven', 'FG', 'Transport'], name: 'P1 + Oven', ht: true },
    'PLN 1.1.1': { path: ['P1', 'QA', 'A1', 'Oven', 'QC', 'FG', 'Transport'], name: 'Full with Oven', ht: true },
    'PLN 1.1.2': { path: ['P1', 'QA', 'A1', 'QC', 'FG', 'Transport'], name: 'No Oven', ht: false },
    'PLN 2': { path: ['P2', 'FG', 'Transport'], name: 'P2 Line', ht: false },
    'PLN 2.1.1': { path: ['P2', 'A1', 'Oven', 'QC', 'FG', 'Transport'], name: 'P2 + Oven', ht: true },
  }

  // Status configurations
  const statusConfig = {
    draft: { bg: 'bg-gray-100', text: 'text-gray-600', icon: '‚ö™', label: lang === 'th' ? '‡∏£‡πà‡∏≤‡∏á' : 'Draft' },
    forecast: { bg: 'bg-gray-100', text: 'text-gray-500', icon: '‚ö™', label: 'PR' },
    confirmed: { bg: 'bg-blue-100', text: 'text-blue-600', icon: 'üîµ', label: lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : 'Confirmed' },
    in_production: { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'üü°', label: lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Producing' },
    ready: { bg: 'bg-cyan-100', text: 'text-cyan-600', icon: 'üîµ', label: lang === 'th' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' : 'Ready' },
    partial: { bg: 'bg-orange-100', text: 'text-orange-600', icon: 'üü†', label: lang === 'th' ? '‡∏™‡πà‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : 'Partial' },
    dispatched: { bg: 'bg-purple-100', text: 'text-purple-600', icon: 'üöö', label: lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á' : 'Dispatched' },
    delivered: { bg: 'bg-green-100', text: 'text-green-600', icon: 'üü¢', label: lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered' },
    complete: { bg: 'bg-green-100', text: 'text-green-600', icon: 'üü¢', label: lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : 'Complete' },
    cancelled: { bg: 'bg-red-100', text: 'text-red-600', icon: 'üî¥', label: lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancelled' },
    revised: { bg: 'bg-amber-100', text: 'text-amber-700', icon: 'üü†', label: lang === 'th' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß' : 'Revised' },
    planned: { bg: 'bg-slate-100', text: 'text-slate-600', icon: '‚ö™', label: lang === 'th' ? '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô' : 'Planned' },
  }

  // Transform sales orders into tracker format
  const orderData = useMemo(() => {
    return (salesOrders || []).map(so => {
      const customer = customers?.find(c => c.id === so.customerId)
      let totalQty = 0, totalProduced = 0, totalDelivered = 0
      
      so.items?.forEach(item => {
        totalQty += item.qty || 0
        const wo = workOrders?.find(w => w.soId === so.id)
        if (wo?.status === 'completed') totalProduced += item.qty || 0
        item.deliverySchedule?.forEach(sched => {
          if (sched.status === 'delivered') totalDelivered += sched.actualQty || sched.qty || 0
        })
      })
      
      let status = so.status || 'draft'
      if (so.orderType === 'PR') status = 'forecast'
      else if (totalDelivered >= totalQty && totalQty > 0) status = 'complete'
      else if (totalDelivered > 0) status = 'partial'
      else if (totalProduced >= totalQty && totalQty > 0) status = 'ready'
      else if (totalProduced > 0) status = 'in_production'
      
      return { ...so, customer, totalQty, totalProduced, totalDelivered, totalBalance: totalQty - totalDelivered, overallStatus: status }
    })
  }, [salesOrders, customers, workOrders])

  // Filter orders
  const filteredOrders = useMemo(() => {
    return orderData.filter(order => {
      if (filterCustomer !== 'all' && order.customerId !== filterCustomer) return false
      if (filterStatus !== 'all' && order.overallStatus !== filterStatus) return false
      if (filterType !== 'all' && order.orderType !== filterType) return false
      return true
    })
  }, [orderData, filterCustomer, filterStatus, filterType])

  // Get all schedules for calendar
  const allSchedules = useMemo(() => {
    const schedules = []
    orderData.forEach(order => {
      order.items?.forEach((item, itemIdx) => {
        item.deliverySchedule?.forEach((sched, schedIdx) => {
          schedules.push({
            ...sched, orderId: order.id, orderType: order.orderType,
            customerPO: order.customerPO, customer: order.customer,
            item, itemIdx, schedIdx, deliveryDate: sched.revisedDate || sched.deliveryDate
          })
        })
      })
    })
    return schedules
  }, [orderData])

  // Toggle functions
  const toggleOrder = (id) => setExpandedOrders(prev => ({ ...prev, [id]: !prev[id] }))
  const toggleLine = (orderId, idx) => setExpandedLines(prev => ({ ...prev, [`${orderId}-${idx}`]: !prev[`${orderId}-${idx}`] }))
  const toggleSchedule = (orderId, lineIdx, schedIdx) => setExpandedSchedules(prev => ({ ...prev, [`${orderId}-${lineIdx}-${schedIdx}`]: !prev[`${orderId}-${lineIdx}-${schedIdx}`] }))

  // Revise schedule
  const handleReviseSchedule = (orderId, itemIdx, schedIdx, changes, reason) => {
    setSalesOrders(salesOrders.map(so => {
      if (so.id !== orderId) return so
      return {
        ...so,
        items: so.items.map((item, iIdx) => {
          if (iIdx !== itemIdx) return item
          return {
            ...item,
            deliverySchedule: item.deliverySchedule.map((sched, sIdx) => {
              if (sIdx !== schedIdx) return sched
              const newVersion = (sched.currentVersion || 1) + 1
              return {
                ...sched, ...changes,
                originalDate: sched.originalDate || sched.deliveryDate,
                revisedDate: changes.deliveryDate || sched.revisedDate,
                status: 'revised',
                currentVersion: newVersion,
                revisionHistory: [
                  ...(sched.revisionHistory || []),
                  { version: newVersion, timestamp: new Date().toISOString(), changedBy: 'Sales',
                    changeType: changes.deliveryDate ? 'date_change' : 'update',
                    changes: { field: 'deliveryDate', from: sched.deliveryDate, to: changes.deliveryDate, reason } }
                ]
              }
            })
          }
        })
      }
    }))
  }

  // Calendar helpers
  const getDaysInMonth = (date) => {
    const year = date.getFullYear(), month = date.getMonth()
    const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0)
    const days = []
    for (let i = 0; i < firstDay.getDay(); i++) days.push(null)
    for (let d = 1; d <= lastDay.getDate(); d++) days.push(new Date(year, month, d))
    return days
  }

  const getSchedulesForDate = (date) => {
    if (!date) return []
    const dateStr = date.toISOString().split('T')[0]
    return allSchedules.filter(s => s.deliveryDate === dateStr)
  }

  const getWeekDates = (date) => {
    const week = [], start = new Date(date)
    start.setDate(start.getDate() - start.getDay() + 1)
    for (let i = 0; i < 7; i++) { const d = new Date(start); d.setDate(start.getDate() + i); week.push(d) }
    return week
  }

  // Stats
  const stats = {
    total: filteredOrders.length,
    producing: filteredOrders.filter(o => o.overallStatus === 'in_production').length,
    ready: filteredOrders.filter(o => o.overallStatus === 'ready').length,
    partial: filteredOrders.filter(o => o.overallStatus === 'partial').length,
    complete: filteredOrders.filter(o => o.overallStatus === 'complete').length,
  }

  // Components
  const StatusBadge = ({ status }) => {
    const cfg = statusConfig[status] || statusConfig.draft
    return <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${cfg.bg} ${cfg.text}`}>{cfg.icon} {cfg.label}</span>
  }

  const OrderTypeBadge = ({ type }) => {
    const cfg = { PR: { bg: 'bg-blue-100', text: 'text-blue-600', icon: 'üîµ' }, PO: { bg: 'bg-green-100', text: 'text-green-600', icon: 'üü¢' }, Direct: { bg: 'bg-yellow-100', text: 'text-yellow-700', icon: 'üü°' } }[type] || { bg: 'bg-gray-100', text: 'text-gray-600', icon: '‚ö™' }
    return <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium ${cfg.bg} ${cfg.text}`}>{cfg.icon} {type}</span>
  }

  const ProductionPath = ({ scenario, currentDept }) => {
    const cfg = productionScenarios[scenario] || productionScenarios['PLN 1']
    const currentIdx = cfg.path.indexOf(currentDept)
    return (
      <div className="flex items-center gap-1 flex-wrap text-xs">
        {cfg.path.map((dept, idx) => (
          <React.Fragment key={idx}>
            {idx > 0 && <span className="text-gray-300">‚Üí</span>}
            <span className={`px-1.5 py-0.5 rounded ${idx < currentIdx ? 'bg-green-100 text-green-700' : idx === currentIdx ? 'bg-yellow-100 text-yellow-700 font-medium' : 'bg-gray-100 text-gray-500'}`}>
              {idx < currentIdx ? '‚úÖ' : idx === currentIdx ? 'üü°' : '‚ö™'} {dept}
            </span>
          </React.Fragment>
        ))}
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <Package className="w-6 h-6 text-blue-600" />
            {lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á' : 'Order-to-Delivery Tracker'}
          </h2>
          <div className="flex bg-gray-100 rounded-lg p-1">
            <button onClick={() => setActiveView('tracker')} className={`px-4 py-2 rounded-md text-sm font-medium ${activeView === 'tracker' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
              <List className="w-4 h-4 inline mr-1" /> {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Tracker'}
            </button>
            <button onClick={() => setActiveView('calendar')} className={`px-4 py-2 rounded-md text-sm font-medium ${activeView === 'calendar' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
              <CalendarDays className="w-4 h-4 inline mr-1" /> {lang === 'th' ? '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô' : 'Calendar'}
            </button>
          </div>
        </div>
        <Button className="gap-2"><Plus className="w-4 h-4" /> {lang === 'th' ? '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà' : 'New Order'}</Button>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-5 gap-4">
        <Card className="p-4 bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
          <div className="flex justify-between"><div><p className="text-sm text-blue-600">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total'}</p><p className="text-2xl font-bold text-blue-700">{stats.total}</p></div><ClipboardList className="w-8 h-8 text-blue-400" /></div>
        </Card>
        <Card className="p-4 bg-gradient-to-br from-yellow-50 to-yellow-100 border-yellow-200">
          <div className="flex justify-between"><div><p className="text-sm text-yellow-600">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Producing'}</p><p className="text-2xl font-bold text-yellow-700">{stats.producing}</p></div><Settings className="w-8 h-8 text-yellow-400" /></div>
        </Card>
        <Card className="p-4 bg-gradient-to-br from-cyan-50 to-cyan-100 border-cyan-200">
          <div className="flex justify-between"><div><p className="text-sm text-cyan-600">{lang === 'th' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' : 'Ready'}</p><p className="text-2xl font-bold text-cyan-700">{stats.ready}</p></div><CheckCircle2 className="w-8 h-8 text-cyan-400" /></div>
        </Card>
        <Card className="p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
          <div className="flex justify-between"><div><p className="text-sm text-orange-600">{lang === 'th' ? '‡∏™‡πà‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : 'Partial'}</p><p className="text-2xl font-bold text-orange-700">{stats.partial}</p></div><Truck className="w-8 h-8 text-orange-400" /></div>
        </Card>
        <Card className="p-4 bg-gradient-to-br from-green-50 to-green-100 border-green-200">
          <div className="flex justify-between"><div><p className="text-sm text-green-600">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : 'Complete'}</p><p className="text-2xl font-bold text-green-700">{stats.complete}</p></div><CheckCircle className="w-8 h-8 text-green-400" /></div>
        </Card>
      </div>

      {/* Linked Stores - Sales has access to RM Wood, IND2, FG */}
      <Card className="p-4 bg-gradient-to-r from-blue-50 to-indigo-50">
        <div className="flex items-center justify-between">
          <h4 className="font-bold text-blue-700 flex items-center gap-2">
            <Database className="w-5 h-5" /> {lang === 'th' ? '‡∏Ñ‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Sales)' : 'Linked Stores (Sales)'}
          </h4>
          <div className="flex gap-3">
            <Badge className="bg-amber-100 text-amber-700">üì¶ RM Wood (STORE1)</Badge>
            <Badge className="bg-green-100 text-green-700">üì¶ IND2 (STORE2)</Badge>
            <Badge className="bg-purple-100 text-purple-700">üì¶ FG (STORE6)</Badge>
          </div>
        </div>
      </Card>

      {/* TRACKER VIEW */}
      {activeView === 'tracker' && (
        <Card className="overflow-hidden">
          {/* Filters */}
          <div className="p-4 border-b bg-gray-50 flex flex-wrap gap-3 items-center">
            <div className="flex items-center gap-2">
              <Search className="w-4 h-4 text-gray-400" />
              <input type="text" placeholder={lang === 'th' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : 'Search...'} className="px-3 py-2 border rounded-lg text-sm w-48" />
            </div>
            <select value={filterCustomer} onChange={(e) => setFilterCustomer(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
              <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'All Customers'}</option>
              {customers?.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
            <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
              <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'All Status'}</option>
              <option value="in_production">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'Producing'}</option>
              <option value="ready">{lang === 'th' ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á' : 'Ready'}</option>
              <option value="partial">{lang === 'th' ? '‡∏™‡πà‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : 'Partial'}</option>
              <option value="complete">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : 'Complete'}</option>
            </select>
            <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
              <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'All Types'}</option>
              <option value="PR">PR (Forecast)</option>
              <option value="PO">PO (Confirmed)</option>
              <option value="Direct">Direct Order</option>
            </select>
          </div>

          {/* Running Table */}
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-gray-100 sticky top-0">
                <tr>
                  <th className="w-10 px-2 py-3"></th>
                  <th className="px-3 py-3 text-left font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà PO' : 'Customer PO'}</th>
                  <th className="px-3 py-3 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-3 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                  <th className="px-3 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠' : 'Received'}</th>
                  <th className="px-3 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£' : 'Req. Del'}</th>
                  <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                  <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏•‡∏¥‡∏ï' : 'Prod'}</th>
                  <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏™‡πà‡∏á' : 'Del'}</th>
                  <th className="px-3 py-3 text-right font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Bal'}</th>
                  <th className="px-3 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {filteredOrders.map(order => (
                  <React.Fragment key={order.id}>
                    {/* Level 1: Order Row */}
                    <tr className={`hover:bg-gray-50 cursor-pointer ${expandedOrders[order.id] ? 'bg-blue-50' : ''}`} onClick={() => toggleOrder(order.id)}>
                      <td className="px-2 py-3 text-center"><ChevronRight className={`w-4 h-4 text-gray-400 transition-transform ${expandedOrders[order.id] ? 'rotate-90' : ''}`} /></td>
                      <td className="px-3 py-3"><div className="font-mono text-blue-600 font-medium text-xs">{order.customerPO || order.id}</div><div className="text-[10px] text-gray-400">SO: {order.id}</div></td>
                      <td className="px-3 py-3"><div className="font-medium text-sm">{order.customer?.name}</div><div className="text-[10px] text-gray-400">{order.customer?.code}</div></td>
                      <td className="px-3 py-3 text-center"><OrderTypeBadge type={order.orderType || 'PO'} /></td>
                      <td className="px-3 py-3 text-center text-xs text-green-600">{order.receivedDate?.slice(5) || order.orderDate?.slice(5) || '-'}</td>
                      <td className="px-3 py-3 text-center text-xs text-orange-600 font-medium">{order.requestedDeliveryDate?.slice(5) || order.deliveryDate?.slice(5) || '-'}</td>
                      <td className="px-3 py-3 text-right font-medium text-sm">{order.totalQty?.toLocaleString()}</td>
                      <td className="px-3 py-3 text-right text-sm"><span className={order.totalProduced > 0 ? 'text-green-600' : 'text-gray-400'}>{order.totalProduced?.toLocaleString()}</span></td>
                      <td className="px-3 py-3 text-right text-sm"><span className={order.totalDelivered > 0 ? 'text-blue-600 font-medium' : 'text-gray-400'}>{order.totalDelivered?.toLocaleString()}</span></td>
                      <td className="px-3 py-3 text-right text-sm"><span className={order.totalBalance > 0 ? 'text-orange-600 font-medium' : 'text-green-600'}>{order.totalBalance?.toLocaleString()}</span></td>
                      <td className="px-3 py-3 text-center"><StatusBadge status={order.overallStatus} /></td>
                    </tr>

                    {/* Level 2: Expanded - Line Items */}
                    {expandedOrders[order.id] && (
                      <tr><td colSpan="11" className="p-0">
                        <div className="bg-blue-50/50 border-l-4 border-blue-400 ml-4">
                          {/* Header Info - Enhanced with Received/Updated dates */}
                          <div className="p-3 bg-white/80 border-b">
                            <div className="flex flex-wrap gap-4 text-sm mb-2">
                              <div className="flex items-center gap-1">
                                <Calendar className="w-3 h-3 text-gray-400" />
                                <span className="text-gray-500">Received:</span> 
                                <span className="font-medium text-green-600">{order.receivedDate || order.orderDate || order.createdAt?.split('T')[0] || '-'}</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <Clock className="w-3 h-3 text-gray-400" />
                                <span className="text-gray-500">Updated:</span> 
                                <span className="font-medium text-blue-600">{order.lastUpdated?.split('T')[0] || order.updatedAt?.split('T')[0] || '-'}</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <Target className="w-3 h-3 text-gray-400" />
                                <span className="text-gray-500">Req. Delivery:</span> 
                                <span className="font-medium text-orange-600">{order.requestedDeliveryDate || order.deliveryDate || '-'}</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <MapPin className="w-3 h-3 text-gray-400" />
                                <span className="text-gray-500">Location:</span> 
                                <span className="font-medium">{order.deliveryLocation || order.customer?.deliveryLocations?.[0]?.name || '-'}</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <CreditCard className="w-3 h-3 text-gray-400" />
                                <span className="text-gray-500">Terms:</span> 
                                <span className="font-medium">{order.paymentTerms || 30} days</span>
                              </div>
                            </div>
                            {/* Quick Actions for Order */}
                            <div className="flex gap-2 mt-2">
                              <Button size="sm" variant="outline" className="gap-1 text-xs" onClick={(e) => {
                                e.stopPropagation()
                                setSelectedOrderForUpdate(order)
                                setShowUpdateModal(true)
                              }}>
                                <Edit3 className="w-3 h-3" /> Update Order
                              </Button>
                            </div>
                          </div>
                          
                          {/* Line Items */}
                          <table className="w-full text-sm">
                            <thead className="bg-gray-100/80"><tr>
                              <th className="w-8 px-2 py-2"></th>
                              <th className="px-3 py-2 text-left font-medium text-gray-600">#</th>
                              <th className="px-3 py-2 text-left font-medium text-gray-600">Item</th>
                              <th className="px-3 py-2 text-left font-medium text-gray-600">Description</th>
                              <th className="px-3 py-2 text-right font-medium text-gray-600">Qty</th>
                              <th className="px-3 py-2 text-left font-medium text-gray-600">WO#</th>
                              <th className="px-3 py-2 text-center font-medium text-gray-600">Status</th>
                              <th className="px-3 py-2 text-right font-medium text-gray-600">Amount</th>
                            </tr></thead>
                            <tbody className="divide-y divide-gray-100">
                              {order.items?.map((item, itemIdx) => {
                                const lineKey = `${order.id}-${itemIdx}`
                                const wo = workOrders?.find(w => w.soId === order.id)
                                return (
                                  <React.Fragment key={itemIdx}>
                                    <tr className={`hover:bg-white/80 cursor-pointer ${expandedLines[lineKey] ? 'bg-white' : ''}`} onClick={(e) => { e.stopPropagation(); toggleLine(order.id, itemIdx) }}>
                                      <td className="px-2 py-2 text-center"><ChevronRight className={`w-3 h-3 text-gray-400 ${expandedLines[lineKey] ? 'rotate-90' : ''}`} /></td>
                                      <td className="px-3 py-2 font-medium text-gray-500">{itemIdx + 1}</td>
                                      <td className="px-3 py-2 font-mono text-blue-600 text-xs">{item.itemCode || item.productId}</td>
                                      <td className="px-3 py-2">{item.productName || item.description}</td>
                                      <td className="px-3 py-2 text-right font-medium">{item.qty?.toLocaleString()} {item.unit}</td>
                                      <td className="px-3 py-2 font-mono text-purple-600 text-xs">{wo?.woNumber || item.woNumber || '-'}</td>
                                      <td className="px-3 py-2 text-center">{wo ? <StatusBadge status={wo.status === 'completed' ? 'complete' : 'in_production'} /> : <span className="text-gray-400 text-xs">No WO</span>}</td>
                                      <td className="px-3 py-2 text-right font-medium">‡∏ø{((item.qty || 0) * (item.unitPrice || 0)).toLocaleString()}</td>
                                    </tr>

                                    {/* Level 3: Expanded Line - Schedule */}
                                    {expandedLines[lineKey] && (
                                      <tr><td colSpan="8" className="p-0">
                                        <div className="bg-white border-l-4 border-purple-400 ml-6 p-3 space-y-3">
                                          {/* Production Path */}
                                          <div className="p-2 bg-gray-50 rounded-lg">
                                            <div className="text-xs font-medium text-gray-500 mb-1">Production: {item.productionScenario || 'PLN 1'}</div>
                                            <ProductionPath scenario={item.productionScenario || 'PLN 1'} currentDept={wo?.currentDept || 'FG'} />
                                          </div>

                                          {/* Delivery Schedule */}
                                          <div>
                                            <div className="flex justify-between items-center mb-2">
                                              <h4 className="font-medium text-gray-700 text-sm">Delivery Schedule</h4>
                                              <Button size="sm" variant="outline" className="gap-1 text-xs" onClick={(e) => {
                                                e.stopPropagation()
                                                const qty = prompt('Quantity to schedule:', item.qty - (item.deliverySchedule?.reduce((s, d) => s + (d.qty || 0), 0) || 0))
                                                const date = prompt('Delivery date (YYYY-MM-DD):')
                                                const location = prompt('Location:')
                                                if (qty && date) {
                                                  handleAddSchedule(order.id, itemIdx, { qty: parseInt(qty), deliveryDate: date, locationName: location })
                                                }
                                              }}><Plus className="w-3 h-3" /> Add Schedule</Button>
                                            </div>
                                            <table className="w-full text-xs border rounded overflow-hidden">
                                              <thead className="bg-gray-100"><tr>
                                                <th className="w-6 px-1 py-1.5"></th>
                                                <th className="px-2 py-1.5 text-left">Sch#</th>
                                                <th className="px-2 py-1.5 text-right">Qty</th>
                                                <th className="px-2 py-1.5 text-center">Req. Date</th>
                                                <th className="px-2 py-1.5 text-center">Plan Date</th>
                                                <th className="px-2 py-1.5 text-left">Location</th>
                                                <th className="px-2 py-1.5 text-left">DO#</th>
                                                <th className="px-2 py-1.5 text-left">INV#</th>
                                                <th className="px-2 py-1.5 text-center">Status</th>
                                                <th className="px-2 py-1.5 text-center">Rev</th>
                                                <th className="px-2 py-1.5 text-center">Actions</th>
                                              </tr></thead>
                                              <tbody>
                                                {item.deliverySchedule?.length > 0 ? item.deliverySchedule.map((sched, schedIdx) => {
                                                  const schedKey = `${order.id}-${itemIdx}-${schedIdx}`
                                                  return (
                                                    <React.Fragment key={schedIdx}>
                                                      <tr className={`hover:bg-gray-50 ${sched.status === 'revised' ? 'bg-amber-50' : ''}`}>
                                                        <td className="px-1 py-1.5 text-center">
                                                          {sched.revisionHistory?.length > 0 && (
                                                            <button onClick={(e) => { e.stopPropagation(); toggleSchedule(order.id, itemIdx, schedIdx) }}>
                                                              <ChevronRight className={`w-3 h-3 text-gray-400 ${expandedSchedules[schedKey] ? 'rotate-90' : ''}`} />
                                                            </button>
                                                          )}
                                                        </td>
                                                        <td className="px-2 py-1.5 font-medium">{schedIdx + 1}</td>
                                                        <td className="px-2 py-1.5 text-right font-medium">{sched.qty?.toLocaleString()}</td>
                                                        <td className="px-2 py-1.5 text-center text-orange-600 text-[10px]">{sched.requestedDate || sched.originalDate || sched.deliveryDate}</td>
                                                        <td className="px-2 py-1.5 text-center">
                                                          {sched.revisedDate ? (
                                                            <div><div className="line-through text-gray-400" style={{fontSize: '9px'}}>{sched.originalDate}</div><div className="text-blue-600 font-medium">{sched.revisedDate}</div></div>
                                                          ) : <span>{sched.deliveryDate}</span>}
                                                        </td>
                                                        <td className="px-2 py-1.5 text-orange-600">{sched.locationName || sched.location || '-'}</td>
                                                        <td className="px-2 py-1.5 font-mono text-green-600">{sched.doNumber || '-'}</td>
                                                        <td className="px-2 py-1.5 font-mono text-purple-600">{sched.invoiceNumber || '-'}</td>
                                                        <td className="px-2 py-1.5 text-center"><StatusBadge status={sched.status || 'planned'} /></td>
                                                        <td className="px-2 py-1.5 text-center text-gray-500">{sched.revisionHistory?.length > 0 ? `v${sched.currentVersion || sched.revisionHistory.length}` : '-'}</td>
                                                        <td className="px-2 py-1.5 text-center">
                                                          <div className="flex items-center justify-center gap-0.5">
                                                            {/* Revise Date */}
                                                            <button className="p-1 hover:bg-blue-100 rounded text-blue-600" title="Revise Date"
                                                              onClick={(e) => {
                                                                e.stopPropagation()
                                                                const newDate = prompt('New delivery date (YYYY-MM-DD):', sched.revisedDate || sched.deliveryDate)
                                                                const reason = prompt('Reason for change:')
                                                                if (newDate && reason) handleReviseSchedule(order.id, itemIdx, schedIdx, { deliveryDate: newDate }, reason)
                                                              }}>
                                                              <Edit3 className="w-3 h-3" />
                                                            </button>
                                                            {/* Create DO - only if ready and no DO yet */}
                                                            {(sched.status === 'planned' || sched.status === 'revised' || sched.status === 'ready') && !sched.doNumber && (
                                                              <button className="p-1 hover:bg-green-100 rounded text-green-600" title="Create DO"
                                                                onClick={(e) => {
                                                                  e.stopPropagation()
                                                                  if (confirm(`Create DO for ${sched.qty} ${item.unit} delivery on ${sched.revisedDate || sched.deliveryDate}?`)) {
                                                                    handleCreateDO(order, item, sched, schedIdx)
                                                                  }
                                                                }}>
                                                                <Truck className="w-3 h-3" />
                                                              </button>
                                                            )}
                                                            {/* Create Invoice - only if DO exists and no invoice */}
                                                            {sched.doNumber && !sched.invoiceNumber && (
                                                              <button className="p-1 hover:bg-purple-100 rounded text-purple-600" title="Create Invoice"
                                                                onClick={(e) => {
                                                                  e.stopPropagation()
                                                                  if (confirm(`Create Invoice for DO ${sched.doNumber}?`)) {
                                                                    handleCreateInvoice(order, item, sched)
                                                                  }
                                                                }}>
                                                                <Receipt className="w-3 h-3" />
                                                              </button>
                                                            )}
                                                            {/* Mark Delivered */}
                                                            {sched.doNumber && sched.status !== 'delivered' && (
                                                              <button className="p-1 hover:bg-green-100 rounded text-green-700" title="Mark Delivered"
                                                                onClick={(e) => {
                                                                  e.stopPropagation()
                                                                  if (confirm('Mark as delivered?')) {
                                                                    handleReviseSchedule(order.id, itemIdx, schedIdx, { status: 'delivered', actualQty: sched.qty, actualDate: new Date().toISOString().split('T')[0] }, 'Delivery confirmed')
                                                                  }
                                                                }}>
                                                                <CheckCircle className="w-3 h-3" />
                                                              </button>
                                                            )}
                                                          </div>
                                                        </td>
                                                      </tr>
                                                      
                                                      {/* Level 4: Revision History */}
                                                      {expandedSchedules[schedKey] && sched.revisionHistory?.length > 0 && (
                                                        <tr><td colSpan="11" className="p-0">
                                                          <div className="bg-amber-50 border-l-4 border-amber-400 ml-4 p-2">
                                                            <div className="text-xs font-medium text-amber-700 mb-1 flex items-center gap-1"><History className="w-3 h-3" /> Revision History</div>
                                                            <table className="w-full text-xs">
                                                              <thead className="bg-amber-100/50"><tr>
                                                                <th className="px-2 py-1 text-left">Ver</th>
                                                                <th className="px-2 py-1 text-left">Date</th>
                                                                <th className="px-2 py-1 text-left">By</th>
                                                                <th className="px-2 py-1 text-left">Change</th>
                                                                <th className="px-2 py-1 text-left">Reason</th>
                                                              </tr></thead>
                                                              <tbody>
                                                                {sched.revisionHistory.map((rev, revIdx) => (
                                                                  <tr key={revIdx} className="border-t border-amber-200">
                                                                    <td className="px-2 py-1 font-medium">v{rev.version}</td>
                                                                    <td className="px-2 py-1 text-gray-600">{rev.timestamp?.split('T')[0]}</td>
                                                                    <td className="px-2 py-1">{rev.changedBy}</td>
                                                                    <td className="px-2 py-1">{rev.changes?.from} ‚Üí <span className="text-blue-600 font-medium">{rev.changes?.to}</span></td>
                                                                    <td className="px-2 py-1 text-gray-600 italic">{rev.changes?.reason}</td>
                                                                  </tr>
                                                                ))}
                                                              </tbody>
                                                            </table>
                                                          </div>
                                                        </td></tr>
                                                      )}
                                                    </React.Fragment>
                                                  )
                                                }) : (
                                                  <tr><td colSpan="11" className="px-3 py-4 text-center text-gray-400">No schedule yet. Click "+ Add Schedule" to create one.</td></tr>
                                                )}
                                              </tbody>
                                            </table>
                                            {/* Remaining qty */}
                                            <div className="mt-2 text-xs">
                                              <span className="text-gray-500">Scheduled:</span> <span className="font-medium">{item.deliverySchedule?.reduce((s, d) => s + (d.qty || 0), 0) || 0}</span> / {item.qty} {item.unit}
                                              {item.qty - (item.deliverySchedule?.reduce((s, d) => s + (d.qty || 0), 0) || 0) > 0 && (
                                                <span className="text-orange-600 ml-2">({item.qty - (item.deliverySchedule?.reduce((s, d) => s + (d.qty || 0), 0) || 0)} remaining)</span>
                                              )}
                                            </div>
                                          </div>
                                        </div>
                                      </td></tr>
                                    )}
                                  </React.Fragment>
                                )
                              })}
                            </tbody>
                          </table>
                          
                          {/* Actions */}
                          <div className="p-2 bg-gray-50/80 border-t flex gap-2">
                            <Button size="sm" variant="outline" className="gap-1 text-xs"><Plus className="w-3 h-3" /> Add Line</Button>
                            <Button size="sm" variant="outline" className="gap-1 text-xs"><History className="w-3 h-3" /> History</Button>
                            <Button size="sm" variant="outline" className="gap-1 text-xs"><Printer className="w-3 h-3" /> Print</Button>
                          </div>
                        </div>
                      </td></tr>
                    )}
                  </React.Fragment>
                ))}
              </tbody>
            </table>
          </div>
          
          {filteredOrders.length === 0 && (
            <div className="p-12 text-center text-gray-500"><Package className="w-12 h-12 mx-auto mb-4 text-gray-300" /><p>{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'No orders found'}</p></div>
          )}
        </Card>
      )}

      {/* CALENDAR VIEW */}
      {activeView === 'calendar' && (
        <div className="space-y-4">
          {/* Calendar View Tabs */}
          <div className="flex items-center gap-4">
            <div className="flex bg-gray-100 rounded-lg p-1">
              {[{ id: 'monthly', label: lang === 'th' ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Monthly', icon: CalendarDays }, { id: 'weekly', label: lang === 'th' ? '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå' : 'Weekly', icon: Calendar }, { id: 'customer', label: lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer', icon: Building2 }].map(v => (
                <button key={v.id} onClick={() => setCalendarView(v.id)} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 ${calendarView === v.id ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>
                  <v.icon className="w-4 h-4" /> {v.label}
                </button>
              ))}
            </div>
            {calendarView === 'customer' && (
              <select value={selectedCustomerView} onChange={(e) => setSelectedCustomerView(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
                <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
                {customers?.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
            )}
          </div>

          {/* Monthly Calendar */}
          {calendarView === 'monthly' && (
            <Card className="overflow-hidden">
              <div className="p-4 border-b flex justify-between items-center">
                <button onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() - 1, 1))} className="p-2 hover:bg-gray-100 rounded"><ChevronLeft className="w-5 h-5" /></button>
                <h3 className="text-lg font-bold">{calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                <button onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 1))} className="p-2 hover:bg-gray-100 rounded"><ChevronRight className="w-5 h-5" /></button>
              </div>
              <div className="grid grid-cols-7">
                {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => <div key={day} className="p-2 text-center text-sm font-medium text-gray-500 bg-gray-50 border-b">{day}</div>)}
                {getDaysInMonth(calendarDate).map((date, idx) => {
                  const schedules = date ? getSchedulesForDate(date) : []
                  const isToday = date?.toDateString() === new Date().toDateString()
                  return (
                    <div key={idx} className={`min-h-[90px] p-1 border-b border-r ${!date ? 'bg-gray-50' : isToday ? 'bg-blue-50' : 'hover:bg-gray-50'}`}>
                      {date && (
                        <>
                          <div className={`text-sm font-medium mb-1 ${isToday ? 'text-blue-600' : ''}`}>{date.getDate()}</div>
                          <div className="space-y-0.5">
                            {schedules.slice(0, 3).map((s, i) => {
                              const cfg = statusConfig[s.status] || statusConfig.planned
                              return <div key={i} className={`text-[10px] px-1 py-0.5 rounded truncate ${cfg.bg} ${cfg.text}`} title={`${s.customer?.name}: ${s.qty}`}>{cfg.icon} {s.customer?.name?.slice(0, 8)}</div>
                            })}
                            {schedules.length > 3 && <div className="text-[10px] text-gray-500 px-1">+{schedules.length - 3}</div>}
                          </div>
                        </>
                      )}
                    </div>
                  )
                })}
              </div>
              <div className="p-2 bg-gray-50 border-t flex flex-wrap gap-3 text-xs">
                {Object.entries(statusConfig).slice(0, 6).map(([k, v]) => <div key={k} className="flex items-center gap-1"><span className={`w-3 h-3 rounded ${v.bg}`}></span> {v.label}</div>)}
              </div>
            </Card>
          )}

          {/* Weekly Calendar */}
          {calendarView === 'weekly' && (
            <Card className="overflow-hidden">
              <div className="p-4 border-b flex justify-between items-center">
                <button onClick={() => setCalendarDate(new Date(calendarDate.getTime() - 7 * 24 * 60 * 60 * 1000))} className="p-2 hover:bg-gray-100 rounded flex items-center gap-1"><ChevronLeft className="w-5 h-5" /> Prev</button>
                <h3 className="text-lg font-bold">Week of {getWeekDates(calendarDate)[0].toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</h3>
                <button onClick={() => setCalendarDate(new Date(calendarDate.getTime() + 7 * 24 * 60 * 60 * 1000))} className="p-2 hover:bg-gray-100 rounded flex items-center gap-1">Next <ChevronRight className="w-5 h-5" /></button>
              </div>
              <div className="divide-y">
                {getWeekDates(calendarDate).map((date, idx) => {
                  const schedules = getSchedulesForDate(date)
                  const isToday = date.toDateString() === new Date().toDateString()
                  const isWeekend = date.getDay() === 0 || date.getDay() === 6
                  return (
                    <div key={idx} className={`flex ${isWeekend ? 'bg-gray-50' : ''}`}>
                      <div className={`w-20 p-3 border-r flex-shrink-0 ${isToday ? 'bg-blue-100' : ''}`}>
                        <div className={`font-medium text-sm ${isToday ? 'text-blue-600' : ''}`}>{date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                        <div className={`text-xl font-bold ${isToday ? 'text-blue-600' : ''}`}>{date.getDate()}</div>
                      </div>
                      <div className="flex-1 p-2 space-y-1 min-h-[70px]">
                        {schedules.length > 0 ? schedules.map((s, i) => {
                          const cfg = statusConfig[s.status] || statusConfig.planned
                          return (
                            <div key={i} className={`p-2 rounded border text-sm ${cfg.bg}`}>
                              <div className="font-medium">{cfg.icon} {s.customer?.name}</div>
                              <div className="text-xs text-gray-600">{s.item?.productName} ‚îÇ {s.qty} {s.item?.unit}</div>
                            </div>
                          )
                        }) : <div className="text-gray-400 text-sm italic">{isWeekend ? 'Weekend' : 'No deliveries'}</div>}
                      </div>
                    </div>
                  )
                })}
              </div>
            </Card>
          )}

          {/* Customer View */}
          {calendarView === 'customer' && selectedCustomerView && (() => {
            const customer = customers?.find(c => c.id === selectedCustomerView)
            const customerSchedules = allSchedules.filter(s => s.customer?.id === selectedCustomerView)
            const customerOrders = orderData.filter(o => o.customerId === selectedCustomerView)
            return (
              <Card className="overflow-hidden">
                <div className="p-4 border-b bg-gradient-to-r from-blue-50 to-cyan-50">
                  <h3 className="text-xl font-bold flex items-center gap-2"><Building2 className="w-5 h-5 text-blue-600" /> {customer?.name}</h3>
                  <p className="text-sm text-gray-600">{customer?.code} ‚îÇ Active: {customerOrders.filter(o => o.overallStatus !== 'complete').length} ‚îÇ Pending: {customerOrders.reduce((s, o) => s + o.totalBalance, 0).toLocaleString()}</p>
                </div>
                <div className="p-4 border-b">
                  <h4 className="font-medium mb-2">Delivery Timeline</h4>
                  <div className="flex items-center gap-1 overflow-x-auto pb-2">
                    {customerSchedules.sort((a, b) => new Date(a.deliveryDate) - new Date(b.deliveryDate)).slice(0, 10).map((s, i) => {
                      const cfg = statusConfig[s.status] || statusConfig.planned
                      return (
                        <div key={i} className="flex-shrink-0 text-center">
                          <div className="flex items-center">{i > 0 && <div className="w-6 h-0.5 bg-gray-200"></div>}<div className={`w-3 h-3 rounded-full ${cfg.bg} border-2`}></div></div>
                          <div className="text-[10px] font-medium mt-1">{s.deliveryDate?.slice(5)}</div>
                          <div className="text-[10px] text-gray-500">{s.qty}</div>
                        </div>
                      )
                    })}
                  </div>
                </div>
                <table className="w-full text-sm">
                  <thead className="bg-gray-50"><tr>
                    <th className="px-4 py-2 text-left">PO#</th><th className="px-4 py-2 text-left">Product</th><th className="px-4 py-2 text-right">Total</th><th className="px-4 py-2 text-right">Delivered</th><th className="px-4 py-2 text-right">Balance</th><th className="px-4 py-2 text-center">Next</th><th className="px-4 py-2 text-center">Status</th>
                  </tr></thead>
                  <tbody className="divide-y">
                    {customerOrders.flatMap(o => o.items?.map((item, idx) => {
                      const delivered = item.deliverySchedule?.filter(s => s.status === 'delivered').reduce((sum, s) => sum + (s.qty || 0), 0) || 0
                      const next = item.deliverySchedule?.find(s => s.status !== 'delivered' && s.status !== 'cancelled')
                      return (
                        <tr key={`${o.id}-${idx}`} className="hover:bg-gray-50">
                          <td className="px-4 py-2 font-mono text-blue-600">{o.customerPO || o.id}</td>
                          <td className="px-4 py-2">{item.productName}</td>
                          <td className="px-4 py-2 text-right">{item.qty?.toLocaleString()}</td>
                          <td className="px-4 py-2 text-right text-green-600">{delivered.toLocaleString()}</td>
                          <td className="px-4 py-2 text-right text-orange-600 font-medium">{(item.qty - delivered).toLocaleString()}</td>
                          <td className="px-4 py-2 text-center text-blue-600">{next?.deliveryDate || '-'}</td>
                          <td className="px-4 py-2 text-center"><StatusBadge status={delivered >= item.qty ? 'complete' : delivered > 0 ? 'partial' : 'planned'} /></td>
                        </tr>
                      )
                    }))}
                  </tbody>
                </table>
              </Card>
            )
          })()}
          
          {calendarView === 'customer' && !selectedCustomerView && (
            <Card className="p-12 text-center text-gray-500"><Building2 className="w-12 h-12 mx-auto mb-4 text-gray-300" /><p>{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select a customer'}</p></Card>
          )}
        </div>
      )}

      {/* ========== UPDATE ORDER MODAL ========== */}
      {showUpdateModal && selectedOrderForUpdate && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowUpdateModal(false)}>
          <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b flex justify-between items-center sticky top-0 bg-white">
              <h3 className="text-lg font-bold flex items-center gap-2">
                <Edit3 className="w-5 h-5 text-blue-600" />
                {lang === 'th' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î PO' : 'Update Order / Upload PO'}
              </h3>
              <button onClick={() => setShowUpdateModal(false)} className="p-1 hover:bg-gray-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-4 space-y-4">
              <div className="bg-blue-50 p-3 rounded-lg">
                <div className="text-sm text-blue-600">Order: <span className="font-bold">{selectedOrderForUpdate.customerPO || selectedOrderForUpdate.id}</span></div>
                <div className="text-sm text-blue-600">Customer: <span className="font-medium">{selectedOrderForUpdate.customer?.name}</span></div>
              </div>

              {/* OCR PO Upload Section */}
              <div className="border-2 border-dashed border-yellow-400 rounded-lg p-4 bg-yellow-50">
                <div className="flex items-center gap-3 mb-3">
                  <div className="p-2 bg-yellow-100 rounded-full">
                    <Upload className="w-6 h-6 text-yellow-600" />
                  </div>
                  <div>
                    <div className="font-bold text-yellow-800">üìÑ {lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î PO (OCR)' : 'Upload PO Document (OCR)'}</div>
                    <div className="text-sm text-yellow-600">{lang === 'th' ? '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û/PDF ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : 'Upload image/PDF - auto-extract PO data'}</div>
                  </div>
                </div>
                <PODocumentUpload
                  existingDoc={selectedOrderForUpdate.poDocument}
                  lang={lang}
                  onExtracted={(data, docData) => {
                    if (data?.poNumber) {
                      document.getElementById('updateCustomerPO').value = data.poNumber
                    }
                    if (data?.poDate) {
                      document.getElementById('updateReceivedDate').value = data.poDate
                    }
                  }}
                />
              </div>

              {/* Customer PO Number - Editable */}
              <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                <label className="block text-sm font-bold text-green-700 mb-1">
                  üìã {lang === 'th' ? '‡πÄ‡∏•‡∏Ç PO/PR ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer PO/PR Number'}
                </label>
                <input 
                  type="text" 
                  defaultValue={selectedOrderForUpdate.customerPO || ''}
                  placeholder={lang === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô 25-263106287, PO.RPR6802-003' : 'e.g., 25-263106287, PO.RPR6802-003'}
                  className="w-full px-3 py-2 border border-green-300 rounded-lg bg-white"
                  id="updateCustomerPO"
                />
                <div className="text-xs text-green-600 mt-1">
                  üí° {lang === 'th' ? '‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç PO ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ OCR ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô' : 'Enter PO# when received, or use OCR above'}
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'Order Received Date'}
                  </label>
                  <input 
                    type="date" 
                    defaultValue={selectedOrderForUpdate.receivedDate || selectedOrderForUpdate.orderDate || ''}
                    className="w-full px-3 py-2 border rounded-lg"
                    id="updateReceivedDate"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£' : 'Requested Delivery Date'}
                  </label>
                  <input 
                    type="date" 
                    defaultValue={selectedOrderForUpdate.requestedDeliveryDate || selectedOrderForUpdate.deliveryDate || ''}
                    className="w-full px-3 py-2 border rounded-lg"
                    id="updateRequestedDate"
                  />
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  {lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á' : 'Delivery Location'}
                </label>
                <input 
                  type="text" 
                  defaultValue={selectedOrderForUpdate.deliveryLocation || ''}
                  placeholder="e.g., PLOT 1, Factory A"
                  className="w-full px-3 py-2 border rounded-lg"
                  id="updateLocation"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {lang === 'th' ? '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡∏≥‡∏£‡∏∞' : 'Payment Terms (days)'}
                  </label>
                  <select 
                    defaultValue={selectedOrderForUpdate.paymentTerms || 30}
                    className="w-full px-3 py-2 border rounded-lg"
                    id="updateTerms"
                  >
                    <option value={15}>15 days</option>
                    <option value={30}>30 days</option>
                    <option value={45}>45 days</option>
                    <option value={60}>60 days</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'Order Type'}
                  </label>
                  <select 
                    defaultValue={selectedOrderForUpdate.orderType || 'PO'}
                    className="w-full px-3 py-2 border rounded-lg"
                    id="updateType"
                  >
                    <option value="PR">PR (Forecast)</option>
                    <option value="PO">PO (Confirmed)</option>
                    <option value="Direct">Direct Order</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  {lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes / Remarks'}
                </label>
                <textarea 
                  defaultValue={selectedOrderForUpdate.notes || ''}
                  rows={2}
                  className="w-full px-3 py-2 border rounded-lg"
                  id="updateNotes"
                  placeholder="Any special instructions..."
                />
              </div>
            </div>
            <div className="p-4 border-t bg-gray-50 flex justify-end gap-2 sticky bottom-0">
              <Button variant="outline" onClick={() => setShowUpdateModal(false)}>
                {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
              </Button>
              <Button onClick={() => {
                const updates = {
                  receivedDate: document.getElementById('updateReceivedDate').value,
                  requestedDeliveryDate: document.getElementById('updateRequestedDate').value,
                  deliveryLocation: document.getElementById('updateLocation').value,
                  paymentTerms: parseInt(document.getElementById('updateTerms').value),
                  orderType: document.getElementById('updateType').value,
                  notes: document.getElementById('updateNotes').value,
                }
                handleUpdateOrder(selectedOrderForUpdate.id, updates)
                alert(lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : 'Order updated successfully!')
              }}>
                <Save className="w-4 h-4 mr-1" />
                {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save Changes'}
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// ENHANCED SALES MODULE
// ============================================
const SalesModuleFull = ({ 
  quotations, setQuotations,
  salesOrders, setSalesOrders, 
  deliveryOrders, setDeliveryOrders,
  invoices, setInvoices,
  rejections, setRejections,
  claims, setClaims,
  creditNotes, setCreditNotes,
  salesMeetings, setSalesMeetings,
  customers, workOrders, products, trucks, employees, lang 
}) => {
  const [activeTab, setActiveTab] = useState('dashboard')
  const [showQuotationModal, setShowQuotationModal] = useState(false)
  const [showSOModal, setShowSOModal] = useState(false)
  const [showDOModal, setShowDOModal] = useState(false)
  const [showInvoiceModal, setShowInvoiceModal] = useState(false)
  const [showPaymentModal, setShowPaymentModal] = useState(false)
  const [showRejectionModal, setShowRejectionModal] = useState(false)
  const [showClaimModal, setShowClaimModal] = useState(false)
  const [showCreditNoteModal, setShowCreditNoteModal] = useState(false)
  const [showMeetingModal, setShowMeetingModal] = useState(false)
  const [selectedItem, setSelectedItem] = useState(null)
  const [editMode, setEditMode] = useState(false)
  // Print modals
  const [showPrintInvoice, setShowPrintInvoice] = useState(false)
  const [showPrintExportInvoice, setShowPrintExportInvoice] = useState(false)
  const [showPrintDO, setShowPrintDO] = useState(false)
  const [showPrintQuotation, setShowPrintQuotation] = useState(false)
  const [showHTCertModal, setShowHTCertModal] = useState(false)
  const [showAllianzLabels, setShowAllianzLabels] = useState(false)
  const [showPolyplexLabels, setShowPolyplexLabels] = useState(false)
  const [showCustomerStatement, setShowCustomerStatement] = useState(false)
  const [selectedCustomerForStatement, setSelectedCustomerForStatement] = useState(null)
  const [showCreditNotePrint, setShowCreditNotePrint] = useState(false)
  const [showReceiptAck, setShowReceiptAck] = useState(false)
  
  // Filters
  const [agingCustomerFilter, setAgingCustomerFilter] = useState('')
  const [agingBucketFilter, setAgingBucketFilter] = useState('all')
  
  // Price History
  const [priceHistory, setPriceHistory] = useState([
    { id: 1, productId: 'PLT-STD-001', productName: 'Standard Pallet 1200x1000', oldPrice: 280, newPrice: 295, effectiveDate: '2026-01-15', reason: 'material_cost_increase', emailRef: 'Email dated 2026-01-10', approvedBy: 'CEO', changedBy: 'Sales Manager', changedAt: '2026-01-10' },
    { id: 2, productId: 'PLT-HD-001', productName: 'Heavy Duty Pallet 1200x1000', oldPrice: 450, newPrice: 420, effectiveDate: '2026-01-01', reason: 'volume_discount', emailRef: 'Customer negotiation email', approvedBy: 'CEO', changedBy: 'Sales Manager', changedAt: '2025-12-28' },
  ])

  const tabs = [
    { id: 'dashboard', label: lang === 'th' ? '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°' : 'Dashboard', icon: BarChart3 },
    { id: 'quotations', label: lang === 'th' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotations', icon: FileText },
    { id: 'orders', label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Sales Orders', icon: ClipboardList },
    { id: 'tracker', label: lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'Order Tracker', icon: Package },
    { id: 'delivery', label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Delivery', icon: Truck },
    { id: 'invoices', label: lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices', icon: Receipt },
    { id: 'payments', label: lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞' : 'Payments', icon: CreditCard },
    { id: 'aging', label: lang === 'th' ? '‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ' : 'AR Aging', icon: Calendar },
    { id: 'reports', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢' : 'Sales Report', icon: PieChart },
    { id: 'customers', label: lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customers', icon: Building2 },
    { id: 'pricing', label: lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price History', icon: TrendingUp },
    { id: 'rejections', label: lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Returns', icon: RotateCcw },
    { id: 'claims', label: lang === 'th' ? '‡πÄ‡∏Ñ‡∏•‡∏°' : 'Claims', icon: AlertCircle },
    { id: 'meetings', label: lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Meetings', icon: Users },
  ]

  // Calculate stats
  const stats = {
    totalQuotations: quotations?.length || 0,
    pendingQuotations: quotations?.filter(q => q.status === 'sent' || q.status === 'draft').length || 0,
    totalOrders: salesOrders?.length || 0,
    pendingOrders: salesOrders?.filter(so => so.status === 'confirmed').length || 0,
    totalDOs: deliveryOrders?.length || 0,
    pendingDOs: deliveryOrders?.filter(d => d.status === 'pending' || d.status === 'dispatched').length || 0,
    totalInvoices: invoices?.length || 0,
    unpaidInvoices: invoices?.filter(inv => inv.balance > 0).length || 0,
    totalRevenue: invoices?.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0) || 0,
    totalReceived: invoices?.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0) || 0,
    openRejections: rejections?.filter(r => r.status !== 'resolved').length || 0,
    openClaims: claims?.filter(c => c.status !== 'closed' && c.status !== 'resolved').length || 0,
    totalCreditNotes: creditNotes?.length || 0,
    meetingsThisMonth: salesMeetings?.filter(m => {
      const meetingDate = new Date(m.date)
      const now = new Date()
      return meetingDate.getMonth() === now.getMonth() && meetingDate.getFullYear() === now.getFullYear()
    }).length || 0,
    followupsDue: salesMeetings?.filter(m => m.nextFollowupDate && new Date(m.nextFollowupDate) <= new Date()).length || 0,
  }

  // Enhanced KPIs
  const kpis = {
    collectionRate: stats.totalRevenue > 0 ? ((stats.totalReceived / stats.totalRevenue) * 100).toFixed(1) : 0,
    dso: (() => {
      // Days Sales Outstanding = (AR / Total Credit Sales) √ó Number of Days
      const totalAR = stats.totalRevenue - stats.totalReceived
      const avgDailyRevenue = stats.totalRevenue / 30 // Simplified 30-day avg
      return avgDailyRevenue > 0 ? Math.round(totalAR / avgDailyRevenue) : 0
    })(),
    overdueAmount: invoices?.filter(inv => {
      const dueDate = new Date(inv.dueDate)
      return dueDate < new Date() && inv.balance > 0
    }).reduce((sum, inv) => sum + (inv.balance || 0), 0) || 0,
    overdueCount: invoices?.filter(inv => {
      const dueDate = new Date(inv.dueDate)
      return dueDate < new Date() && inv.balance > 0
    }).length || 0,
    qtConversionRate: stats.totalQuotations > 0 ? 
      ((quotations?.filter(q => q.status === 'accepted').length / stats.totalQuotations) * 100).toFixed(1) : 0,
    avgOrderValue: stats.totalInvoices > 0 ? stats.totalRevenue / stats.totalInvoices : 0,
  }

  // Top Customers by Revenue
  const topCustomers = [...new Set(invoices?.map(inv => inv.customerId) || [])]
    .map(custId => {
      const customer = customers.find(c => c.id === custId)
      const custInvoices = invoices?.filter(inv => inv.customerId === custId) || []
      const revenue = custInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
      const outstanding = custInvoices.reduce((sum, inv) => sum + (inv.balance || 0), 0)
      const paidAmount = custInvoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0)
      return {
        id: custId,
        name: customer?.name || 'Unknown',
        code: customer?.code || '',
        revenue,
        outstanding,
        paidAmount,
        invoiceCount: custInvoices.length,
      }
    })
    .filter(c => c.revenue > 0)
    .sort((a, b) => b.revenue - a.revenue)
    .slice(0, 5)

  // Generate IDs
  const generateId = (prefix) => {
    const now = new Date()
    const yy = now.getFullYear().toString().slice(-2)
    const mm = String(now.getMonth() + 1).padStart(2, '0')
    let seq = 1
    if (prefix === 'QT') seq = (quotations?.length || 0) + 1
    else if (prefix === 'SO') seq = (salesOrders?.length || 0) + 1
    else if (prefix === 'DO') seq = (deliveryOrders?.length || 0) + 1
    else if (prefix === 'INV') seq = (invoices?.length || 0) + 1
    else if (prefix === 'REJ') seq = (rejections?.length || 0) + 1
    else if (prefix === 'CLM') seq = (claims?.length || 0) + 1
    else if (prefix === 'CN') seq = (creditNotes?.length || 0) + 1
    else if (prefix === 'MTG') seq = (salesMeetings?.length || 0) + 1
    return `${prefix}-${yy}${mm}-${String(seq).padStart(3, '0')}`
  }

  // REJECTION Functions
  const handleSaveRejection = (data) => {
    if (editMode && selectedItem) {
      setRejections(rejections.map(r => r.id === selectedItem.id ? { ...r, ...data } : r))
    } else {
      const newRej = {
        id: generateId('REJ'),
        ...data,
        status: 'open',
        createdAt: new Date().toISOString().split('T')[0],
      }
      setRejections([...rejections, newRej])
    }
    setShowRejectionModal(false)
    setSelectedItem(null)
    setEditMode(false)
  }

  const handleCreateCreditNote = (rejection) => {
    const invoice = invoices?.find(inv => inv.id === rejection.invoiceId)
    const newCN = {
      id: generateId('CN'),
      date: new Date().toISOString().split('T')[0],
      customerId: rejection.customerId,
      originalInvoiceId: rejection.invoiceId,
      rejectionId: rejection.id,
      claimId: null,
      reason: `Goods returned - ${rejection.reason}`,
      items: rejection.items.map((item, idx) => ({
        id: idx + 1,
        description: item.productName,
        qty: item.qtyRejected,
        unitPrice: invoice?.items?.find(i => i.description === item.productName)?.unitPrice || 0,
        total: item.qtyRejected * (invoice?.items?.find(i => i.description === item.productName)?.unitPrice || 0),
      })),
      subtotal: 0,
      vatRate: 7,
      vat: 0,
      grandTotal: 0,
      status: 'draft',
      appliedToInvoice: null,
      appliedDate: null,
      preparedBy: '',
      approvedBy: '',
      entity: invoice?.entity || 'IND',
      createdAt: new Date().toISOString().split('T')[0],
    }
    newCN.subtotal = newCN.items.reduce((sum, item) => sum + item.total, 0)
    newCN.vat = newCN.subtotal * 0.07
    newCN.grandTotal = newCN.subtotal + newCN.vat
    
    setCreditNotes([...creditNotes, newCN])
    
    // CRITICAL: Apply CN to invoice balance automatically
    if (invoice) {
      setInvoices(invoices.map(inv => {
        if (inv.id === invoice.id) {
          const newBalance = Math.max(0, (inv.balance || inv.grandTotal) - newCN.grandTotal)
          return { 
            ...inv, 
            balance: newBalance,
            creditNoteApplied: (inv.creditNoteApplied || 0) + newCN.grandTotal,
            creditNotes: [...(inv.creditNotes || []), newCN.id]
          }
        }
        return inv
      }))
    }
    
    setRejections(rejections.map(r => r.id === rejection.id ? { ...r, creditNoteId: newCN.id, status: 'resolved', resolutionDate: new Date().toISOString().split('T')[0] } : r))
  }

  // CLAIM Functions
  const handleSaveClaim = (data) => {
    if (editMode && selectedItem) {
      setClaims(claims.map(c => c.id === selectedItem.id ? { ...c, ...data } : c))
    } else {
      const newClaim = {
        id: generateId('CLM'),
        ...data,
        status: 'open',
        createdAt: new Date().toISOString().split('T')[0],
      }
      setClaims([...claims, newClaim])
    }
    setShowClaimModal(false)
    setSelectedItem(null)
    setEditMode(false)
  }

  // MEETING Functions
  const handleSaveMeeting = (data) => {
    if (editMode && selectedItem) {
      setSalesMeetings(salesMeetings.map(m => m.id === selectedItem.id ? { ...m, ...data } : m))
    } else {
      const newMeeting = {
        id: generateId('MTG'),
        ...data,
        createdAt: new Date().toISOString().split('T')[0],
      }
      setSalesMeetings([...salesMeetings, newMeeting])
    }
    setShowMeetingModal(false)
    setSelectedItem(null)
    setEditMode(false)
  }

  // QUOTATION Functions
  const handleSaveQuotation = (data) => {
    if (editMode && selectedItem) {
      setQuotations(quotations.map(q => q.id === selectedItem.id ? { ...q, ...data } : q))
    } else {
      const newQt = {
        id: generateId('QT'),
        ...data,
        status: 'draft',
        createdAt: new Date().toISOString().split('T')[0],
        convertedToSO: null,
      }
      setQuotations([...quotations, newQt])
    }
    setShowQuotationModal(false)
    setSelectedItem(null)
    setEditMode(false)
  }

  const handleConvertToSO = (qt) => {
    const newSO = {
      id: generateId('SO'),
      customerId: qt.customerId,
      customerPO: '',
      quotationId: qt.id,
      orderDate: new Date().toISOString().split('T')[0],
      dueDate: '',
      deliveryDate: '',
      status: 'confirmed',
      items: qt.items.map((item, idx) => ({
        ...item,
        id: idx + 1,
        qtyDelivered: 0,
        woId: null,
      })),
      subtotal: qt.subtotal,
      vatRate: qt.vatRate,
      vat: qt.vat,
      discount: qt.discount,
      grandTotal: qt.grandTotal,
      entity: qt.entity,
      paymentTerms: qt.paymentTerms,
      deliveryAddress: customers.find(c => c.id === qt.customerId)?.deliveryAddress || '',
      notes: qt.notes,
      createdAt: new Date().toISOString().split('T')[0],
    }
    setSalesOrders([...salesOrders, newSO])
    setQuotations(quotations.map(q => q.id === qt.id ? { ...q, status: 'accepted', convertedToSO: newSO.id } : q))
  }

  // SALES ORDER Functions
  const handleSaveSO = (data) => {
    if (editMode && selectedItem) {
      setSalesOrders(salesOrders.map(so => so.id === selectedItem.id ? { ...so, ...data } : so))
    } else {
      const newSO = {
        id: generateId('SO'),
        ...data,
        status: data.status || 'confirmed',
        createdAt: new Date().toISOString().split('T')[0],
      }
      setSalesOrders([...salesOrders, newSO])
    }
    setShowSOModal(false)
    setSelectedItem(null)
    setEditMode(false)
  }

  // DELIVERY ORDER Functions
  const handleCreateDO = (so) => {
    const pendingItems = so.items.filter(item => (item.qty - (item.qtyDelivered || 0)) > 0)
    if (pendingItems.length === 0) {
      alert(lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏™‡πà‡∏á' : 'No items pending delivery')
      return
    }
    setSelectedItem({ ...so, pendingItems })
    setShowDOModal(true)
  }

  const handleSaveDO = (data) => {
    const newDO = {
      id: generateId('DO'),
      soId: data.soId,
      customerId: data.customerId,
      deliveryDate: data.deliveryDate || new Date().toISOString().split('T')[0],
      scheduledTime: data.scheduledTime || '09:00',
      truckId: data.truckId || '',
      driverId: data.driverId || null,
      status: 'pending',
      items: data.items,
      deliveryAddress: data.deliveryAddress,
      notes: data.notes || '',
      entity: data.entity,
      receivedBy: '',
      receivedAt: null,
      createdAt: new Date().toISOString().split('T')[0],
    }
    setDeliveryOrders([...deliveryOrders, newDO])
    
    // Update SO with delivered quantities
    setSalesOrders(salesOrders.map(so => {
      if (so.id === data.soId) {
        const updatedItems = so.items.map(item => {
          const deliveredItem = data.items.find(di => di.productName === item.productName)
          if (deliveredItem) {
            return { ...item, qtyDelivered: (item.qtyDelivered || 0) + deliveredItem.qty }
          }
          return item
        })
        const allDelivered = updatedItems.every(item => item.qtyDelivered >= item.qty)
        return { ...so, items: updatedItems, status: allDelivered ? 'delivered' : 'in_production' }
      }
      return so
    }))
    
    setShowDOModal(false)
    setSelectedItem(null)
  }

  // INVOICE Functions
  const handleCreateInvoice = (doItem) => {
    const so = salesOrders.find(s => s.id === doItem.soId)
    const newInvoice = {
      id: generateId('INV'),
      entity: doItem.entity || 'IND',
      soId: doItem.soId,
      doId: doItem.id,
      customerId: doItem.customerId,
      customerPO: so?.customerPO || '',
      invoiceDate: new Date().toISOString().split('T')[0],
      dueDate: (() => {
        const customer = customers.find(c => c.id === doItem.customerId)
        const terms = customer?.paymentTerms || 30
        const due = new Date()
        due.setDate(due.getDate() + terms)
        return due.toISOString().split('T')[0]
      })(),
      items: doItem.items.map((item, idx) => ({
        id: idx + 1,
        description: item.productName,
        descriptionTh: item.productName,
        qty: item.qty,
        unit: item.unit || 'pcs',
        unitPrice: so?.items.find(i => i.productName === item.productName)?.unitPrice || 0,
        total: item.qty * (so?.items.find(i => i.productName === item.productName)?.unitPrice || 0),
      })),
      subtotal: 0,
      vatRate: 7,
      vat: 0,
      discount: 0,
      grandTotal: 0,
      status: 'pending',
      paidAmount: 0,
      balance: 0,
      payments: [],
      createdAt: new Date().toISOString().split('T')[0],
    }
    // Calculate totals
    newInvoice.subtotal = newInvoice.items.reduce((sum, item) => sum + item.total, 0)
    newInvoice.vat = newInvoice.subtotal * (newInvoice.vatRate / 100)
    newInvoice.grandTotal = newInvoice.subtotal + newInvoice.vat - newInvoice.discount
    newInvoice.balance = newInvoice.grandTotal
    
    setInvoices([...invoices, newInvoice])
    setDeliveryOrders(deliveryOrders.map(d => d.id === doItem.id ? { ...d, invoiceId: newInvoice.id } : d))
  }

  // PAYMENT Functions
  const handleRecordPayment = (invoice, paymentData) => {
    const newPayment = {
      id: (invoice.payments?.length || 0) + 1,
      date: paymentData.date || new Date().toISOString().split('T')[0],
      amount: parseFloat(paymentData.amount),
      method: paymentData.method,
      reference: paymentData.reference,
      notes: paymentData.notes,
    }
    const newPaidAmount = (invoice.paidAmount || 0) + newPayment.amount
    const newBalance = invoice.grandTotal - newPaidAmount
    const newStatus = newBalance <= 0 ? 'paid' : newPaidAmount > 0 ? 'partial' : 'pending'
    
    setInvoices(invoices.map(inv => 
      inv.id === invoice.id 
        ? { 
            ...inv, 
            payments: [...(inv.payments || []), newPayment],
            paidAmount: newPaidAmount,
            balance: Math.max(0, newBalance),
            status: newStatus,
          }
        : inv
    ))
    setShowPaymentModal(false)
    setSelectedItem(null)
  }

  // AR Aging calculation
  const getAgingData = () => {
    const today = new Date()
    const aging = { current: [], days30: [], days60: [], days90: [], days120: [] }
    
    invoices?.filter(inv => inv.balance > 0).forEach(inv => {
      const dueDate = new Date(inv.dueDate)
      const daysPast = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24))
      const customer = customers.find(c => c.id === inv.customerId)
      const record = { ...inv, customerName: customer?.name, daysPast }
      
      if (daysPast <= 0) aging.current.push(record)
      else if (daysPast <= 30) aging.days30.push(record)
      else if (daysPast <= 60) aging.days60.push(record)
      else if (daysPast <= 90) aging.days90.push(record)
      else aging.days120.push(record)
    })
    
    return aging
  }

  const agingData = getAgingData()
  const agingTotals = {
    current: agingData.current.reduce((sum, inv) => sum + inv.balance, 0),
    days30: agingData.days30.reduce((sum, inv) => sum + inv.balance, 0),
    days60: agingData.days60.reduce((sum, inv) => sum + inv.balance, 0),
    days90: agingData.days90.reduce((sum, inv) => sum + inv.balance, 0),
    days120: agingData.days120.reduce((sum, inv) => sum + inv.balance, 0),
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">{t('nav.sales', lang)}</h1>
          <p className="text-gray-500">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£: ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‚Üí ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢ ‚Üí ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ ‚Üí ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' : 'Complete sales flow: Quotation ‚Üí SO ‚Üí DO ‚Üí Invoice ‚Üí Payment'}</p>
        </div>
        <div className="flex gap-2">
          <Button icon={Plus} onClick={() => { setEditMode(false); setSelectedItem(null); setShowQuotationModal(true) }}>
            {lang === 'th' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'New Quote'}
          </Button>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="p-4 border-l-4 border-l-purple-500 cursor-pointer hover:shadow-md" onClick={() => setActiveTab('quotations')}>
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotations'}</div>
          <div className="text-2xl font-bold text-purple-600">{stats.totalQuotations}</div>
          <div className="text-xs text-purple-400">{stats.pendingQuotations} {lang === 'th' ? '‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö' : 'pending'}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500 cursor-pointer hover:shadow-md" onClick={() => setActiveTab('orders')}>
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Sales Orders'}</div>
          <div className="text-2xl font-bold text-blue-600">{stats.totalOrders}</div>
          <div className="text-xs text-blue-400">{stats.pendingOrders} {lang === 'th' ? '‡∏£‡∏≠‡∏ú‡∏•‡∏¥‡∏ï' : 'pending'}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500 cursor-pointer hover:shadow-md" onClick={() => setActiveTab('delivery')}>
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Delivery Orders'}</div>
          <div className="text-2xl font-bold text-orange-600">{stats.totalDOs}</div>
          <div className="text-xs text-orange-400">{stats.pendingDOs} {lang === 'th' ? '‡∏£‡∏≠‡∏™‡πà‡∏á' : 'pending'}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-teal-500 cursor-pointer hover:shadow-md" onClick={() => setActiveTab('invoices')}>
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices'}</div>
          <div className="text-2xl font-bold text-teal-600">{stats.totalInvoices}</div>
          <div className="text-xs text-red-400">{stats.unpaidInvoices} {lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'unpaid'}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500 cursor-pointer hover:shadow-md" onClick={() => setActiveTab('payments')}>
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(stats.totalReceived)}</div>
          <div className="text-xs text-red-400">{formatCurrency(stats.totalRevenue - stats.totalReceived)} {lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á' : 'due'}</div>
        </Card>
      </div>

      {/* Tabs */}
      <div className="flex gap-1 border-b overflow-x-auto">
        {tabs.map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center gap-2 px-4 py-3 border-b-2 transition-all whitespace-nowrap ${
              activeTab === tab.id 
                ? 'border-[#1A5276] text-[#1A5276] bg-blue-50' 
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <tab.icon className="w-4 h-4" />
            {tab.label}
          </button>
        ))}
      </div>

      {/* ========== DASHBOARD TAB ========== */}
      {activeTab === 'dashboard' && (
        <div className="space-y-6">
          {/* KPI Cards Row */}
          <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <Card className="p-4 bg-gradient-to-br from-green-50 to-green-100 border-green-200">
              <div className="text-xs text-green-600 font-medium">{lang === 'th' ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' : 'Collection Rate'}</div>
              <div className="text-2xl font-bold text-green-700">{kpis.collectionRate}%</div>
              <div className="text-xs text-green-500">{lang === 'th' ? '‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'of total sales'}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
              <div className="text-xs text-blue-600 font-medium">{lang === 'th' ? 'DSO' : 'Days Sales Outstanding'}</div>
              <div className="text-2xl font-bold text-blue-700">{kpis.dso} <span className="text-sm">{lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'}</span></div>
              <div className="text-xs text-blue-500">{lang === 'th' ? '‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' : 'avg collection time'}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-red-50 to-red-100 border-red-200">
              <div className="text-xs text-red-600 font-medium">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Overdue'}</div>
              <div className="text-2xl font-bold text-red-700">{formatCurrency(kpis.overdueAmount)}</div>
              <div className="text-xs text-red-500">{kpis.overdueCount} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'invoices'}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
              <div className="text-xs text-purple-600 font-medium">{lang === 'th' ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏¥‡∏î QT' : 'Quote Win Rate'}</div>
              <div className="text-2xl font-bold text-purple-700">{kpis.qtConversionRate}%</div>
              <div className="text-xs text-purple-500">{lang === 'th' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‚Üí‡∏Ç‡∏≤‡∏¢' : 'quotes converted'}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-teal-50 to-teal-100 border-teal-200">
              <div className="text-xs text-teal-600 font-medium">{lang === 'th' ? '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' : 'Avg Order Value'}</div>
              <div className="text-2xl font-bold text-teal-700">{formatCurrency(kpis.avgOrderValue)}</div>
              <div className="text-xs text-teal-500">{lang === 'th' ? '‡∏ï‡πà‡∏≠‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'per invoice'}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
              <div className="text-xs text-orange-600 font-medium">{lang === 'th' ? '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á' : 'Open Issues'}</div>
              <div className="text-2xl font-bold text-orange-700">{stats.openRejections + stats.openClaims}</div>
              <div className="text-xs text-orange-500">{stats.openRejections} {lang === 'th' ? '‡∏Ñ‡∏∑‡∏ô' : 'returns'} / {stats.openClaims} {lang === 'th' ? '‡πÄ‡∏Ñ‡∏•‡∏°' : 'claims'}</div>
            </Card>
          </div>

          {/* Sales Flow Visual */}
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' : 'Sales Flow'}</h3>
            <div className="flex items-center justify-between bg-gradient-to-r from-purple-50 via-blue-50 via-orange-50 via-teal-50 to-green-50 rounded-xl p-4">
              {[
                { label: lang === 'th' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quote', icon: FileText, color: 'purple', count: stats.pendingQuotations },
                { label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'SO', icon: ClipboardList, color: 'blue', count: stats.pendingOrders },
                { label: lang === 'th' ? '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'DO', icon: Truck, color: 'orange', count: stats.pendingDOs },
                { label: lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice', icon: Receipt, color: 'teal', count: stats.unpaidInvoices },
                { label: lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' : 'Payment', icon: CreditCard, color: 'green', count: 0 },
              ].map((step, idx) => (
                <React.Fragment key={step.label}>
                  <div className="flex flex-col items-center">
                    <div className={`w-12 h-12 rounded-full bg-${step.color}-100 flex items-center justify-center mb-2`}>
                      <step.icon className={`w-6 h-6 text-${step.color}-600`} />
                    </div>
                    <span className="text-sm font-medium">{step.label}</span>
                    {step.count > 0 && (
                      <Badge variant="warning" className="mt-1">{step.count}</Badge>
                    )}
                  </div>
                  {idx < 4 && <ArrowRight className="w-6 h-6 text-gray-400" />}
                </React.Fragment>
              ))}
            </div>
          </Card>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Top Customers */}
            <Card className="p-5 lg:col-span-2">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-gray-800">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' : 'Top Customers by Revenue'}</h3>
                <Button size="sm" variant="ghost" onClick={() => setShowCustomerStatement(true)}>
                  {lang === 'th' ? '‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î' : 'Statement'}
                </Button>
              </div>
              <div className="space-y-3">
                {topCustomers.map((cust, idx) => (
                  <div key={cust.id} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer"
                       onClick={() => { setSelectedCustomerForStatement(cust.id); setShowCustomerStatement(true) }}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                      idx === 0 ? 'bg-yellow-500' : idx === 1 ? 'bg-gray-400' : idx === 2 ? 'bg-amber-600' : 'bg-gray-300'
                    }`}>
                      {idx + 1}
                    </div>
                    <div className="flex-grow">
                      <div className="font-medium">{cust.name}</div>
                      <div className="text-xs text-gray-500">{cust.code} ‚Ä¢ {cust.invoiceCount} {lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'invoices'}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold text-green-600">{formatCurrency(cust.revenue)}</div>
                      {cust.outstanding > 0 && (
                        <div className="text-xs text-red-500">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á' : 'Due'}: {formatCurrency(cust.outstanding)}</div>
                      )}
                    </div>
                  </div>
                ))}
                {topCustomers.length === 0 && (
                  <div className="text-center text-gray-400 py-8">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : 'No data yet'}</div>
                )}
              </div>
            </Card>

            {/* AR Aging Summary */}
            <Card className="p-5">
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ' : 'AR Aging'}</h3>
              <div className="space-y-2">
                {[
                  { label: lang === 'th' ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'Current', amount: agingTotals.current, color: 'green' },
                  { label: '1-30 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days30, color: 'yellow' },
                  { label: '31-60 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days60, color: 'orange' },
                  { label: '61-90 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days90, color: 'red' },
                  { label: '90+ ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days120, color: 'purple' },
                ].map(bucket => (
                  <div key={bucket.label} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                    <span className="text-sm">{bucket.label}</span>
                    <span className={`font-bold text-${bucket.color}-600`}>{formatCurrency(bucket.amount)}</span>
                  </div>
                ))}
                <div className="border-t pt-2 mt-2">
                  <div className="flex items-center justify-between font-bold">
                    <span>{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</span>
                    <span className="text-lg">{formatCurrency(agingTotals.current + agingTotals.days30 + agingTotals.days60 + agingTotals.days90 + agingTotals.days120)}</span>
                  </div>
                </div>
              </div>
            </Card>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Recent Quotations */}
            <Card className="p-5">
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î' : 'Recent Quotations'}</h3>
              <div className="space-y-3">
                {quotations?.slice(0, 5).map(qt => {
                  const customer = customers.find(c => c.id === qt.customerId)
                  return (
                    <div key={qt.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div>
                        <div className="font-mono text-purple-600 font-medium">{qt.id}</div>
                        <div className="text-sm text-gray-500">{customer?.name}</div>
                        {qt.customerCategory && (
                          <Badge variant={qt.customerCategory === 'new' ? 'success' : qt.customerCategory === 'potential' ? 'warning' : 'info'} className="mt-1">
                            {qt.customerCategory}
                          </Badge>
                        )}
                      </div>
                      <div className="text-right">
                        <div className="font-medium">{formatCurrency(qt.grandTotal)}</div>
                        <Badge variant={
                          qt.status === 'accepted' ? 'success' :
                          qt.status === 'sent' ? 'info' :
                          qt.status === 'rejected' ? 'danger' :
                          'warning'
                        }>{qt.status}</Badge>
                      </div>
                    </div>
                  )
                })}
              </div>
            </Card>

            {/* Revenue Summary */}
            <Card className="p-5">
              <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ' : 'Revenue Summary'}</h3>
              <div className="space-y-4">
                <div className="p-4 bg-green-50 rounded-lg">
                  <div className="text-sm text-green-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°' : 'Total Revenue'}</div>
                  <div className="text-3xl font-bold text-green-700">{formatCurrency(stats.totalRevenue)}</div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="p-4 bg-blue-50 rounded-lg">
                    <div className="text-sm text-blue-600">{lang === 'th' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</div>
                    <div className="text-xl font-bold text-blue-700">{formatCurrency(stats.totalReceived)}</div>
                  </div>
                  <div className="p-4 bg-red-50 rounded-lg">
                    <div className="text-sm text-red-600">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
                    <div className="text-xl font-bold text-red-700">{formatCurrency(stats.totalRevenue - stats.totalReceived)}</div>
                  </div>
                </div>
              </div>
            </Card>
          </div>
        </div>
      )}

      {/* ========== QUOTATIONS TAB ========== */}
      {activeTab === 'quotations' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b flex justify-between items-center">
            <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotations List'}</h3>
            <Button size="sm" icon={Plus} onClick={() => { setEditMode(false); setSelectedItem(null); setShowQuotationModal(true) }}>
              {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà' : 'New Quote'}
            </Button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'Quote #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Category'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á' : 'Valid Until'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {quotations?.map(qt => {
                  const customer = customers.find(c => c.id === qt.customerId)
                  const isExpired = new Date(qt.validUntil) < new Date() && qt.status !== 'accepted' && qt.status !== 'converted'
                  const getCategoryBadge = (cat) => {
                    switch(cat) {
                      case 'new': return { color: 'success', label: lang === 'th' ? '‡πÉ‡∏´‡∏°‡πà' : 'New' }
                      case 'potential': return { color: 'warning', label: lang === 'th' ? '‡∏°‡∏µ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û' : 'Potential' }
                      case 'existing': return { color: 'info', label: lang === 'th' ? '‡πÄ‡∏î‡∏¥‡∏°' : 'Existing' }
                      default: return { color: 'default', label: '-' }
                    }
                  }
                  const getReasonLabel = (reason) => {
                    switch(reason) {
                      case 'new_product': return lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Product'
                      case 'price_change': return lang === 'th' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price Change'
                      case 'new_customer': return lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Customer'
                      case 'special_request': return lang === 'th' ? '‡∏û‡∏¥‡πÄ‡∏®‡∏©' : 'Special'
                      default: return '-'
                    }
                  }
                  const catBadge = getCategoryBadge(qt.customerCategory)
                  return (
                    <tr key={qt.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-purple-600">{qt.id}</td>
                      <td className="px-4 py-3">
                        <div>{customer?.name}</div>
                        <div className="text-xs text-gray-400">{customer?.code}</div>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={catBadge.color}>{catBadge.label}</Badge>
                      </td>
                      <td className="px-4 py-3 text-sm">
                        {qt.quotationReason === 'price_change' && <span className="text-orange-600">üí∞ </span>}
                        {qt.quotationReason === 'new_product' && <span className="text-blue-600">üì¶ </span>}
                        {qt.quotationReason === 'new_customer' && <span className="text-green-600">ü§ù </span>}
                        {qt.quotationReason === 'special_request' && <span className="text-purple-600">‚≠ê </span>}
                        {getReasonLabel(qt.quotationReason)}
                      </td>
                      <td className="px-4 py-3">{formatDate(qt.quoteDate)}</td>
                      <td className="px-4 py-3">
                        <span className={isExpired ? 'text-red-500' : ''}>{formatDate(qt.validUntil)}</span>
                      </td>
                      <td className="px-4 py-3 text-right font-medium">{formatCurrency(qt.grandTotal)}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          qt.status === 'accepted' ? 'success' :
                          qt.status === 'sent' ? 'info' :
                          qt.status === 'rejected' ? 'danger' :
                          isExpired ? 'danger' :
                          'warning'
                        }>{isExpired && qt.status === 'sent' ? 'expired' : qt.status}</Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          {qt.status === 'draft' && (
                            <Button size="sm" variant="outline" onClick={() => setQuotations(quotations.map(q => q.id === qt.id ? {...q, status: 'sent'} : q))}>
                              <Send className="w-3 h-3" />
                            </Button>
                          )}
                          {(qt.status === 'sent' || qt.status === 'draft') && !qt.convertedToSO && (
                            <Button size="sm" variant="success" onClick={() => handleConvertToSO(qt)}>
                              {lang === 'th' ? '‚Üí SO' : '‚Üí SO'}
                            </Button>
                          )}
                          {qt.convertedToSO && (
                            <span className="text-xs text-green-600">{qt.convertedToSO}</span>
                          )}
                          <Button size="sm" variant="ghost" onClick={() => { setSelectedItem(qt); setEditMode(true); setShowQuotationModal(true) }}>
                            <Edit3 className="w-3 h-3" />
                          </Button>
                          <Button size="sm" variant="ghost" onClick={() => { setSelectedItem(qt); setShowPrintQuotation(true) }} title="Print">
                            <Printer className="w-3 h-3" />
                          </Button>
                        </div>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* ========== SALES ORDERS TAB ========== */}
      {activeTab === 'orders' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b flex justify-between items-center">
            <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Sales Orders List'}</h3>
            <Button size="sm" icon={Plus} onClick={() => { setEditMode(false); setSelectedItem(null); setShowSOModal(true) }}>
              {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà' : 'New SO'}
            </Button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'SO #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? 'PO ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer PO'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Value'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? 'WO' : 'WO'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {salesOrders?.map(so => {
                  const customer = customers.find(c => c.id === so.customerId)
                  const totalQty = so.items?.reduce((sum, item) => sum + item.qty, 0) || 0
                  const deliveredQty = so.items?.reduce((sum, item) => sum + (item.qtyDelivered || 0), 0) || 0
                  const hasDO = deliveryOrders?.some(d => d.soId === so.id)
                  const linkedWO = workOrders?.find(wo => wo.soId === so.id)
                  return (
                    <tr key={so.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-blue-600">{so.id}</td>
                      <td className="px-4 py-3">{customer?.name}</td>
                      <td className="px-4 py-3 text-sm text-gray-500">{so.customerPO}</td>
                      <td className="px-4 py-3">{formatDate(so.orderDate)}</td>
                      <td className="px-4 py-3 text-right font-medium">{formatCurrency(so.grandTotal)}</td>
                      <td className="px-4 py-3 text-center">
                        {linkedWO ? (
                          <span className="font-mono text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded">
                            {linkedWO.id}
                          </span>
                        ) : (
                          <span className="text-gray-400 text-xs">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <span className={deliveredQty >= totalQty ? 'text-green-600' : 'text-orange-600'}>
                          {deliveredQty}/{totalQty}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          so.status === 'delivered' ? 'success' :
                          so.status === 'in_production' ? 'info' :
                          'warning'
                        }>{so.status}</Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          {/* WO is created by PRODUCTION, not Sales - Sales only views linked WO */}
                          {deliveredQty < totalQty && (
                            <Button size="sm" variant="outline" onClick={() => handleCreateDO(so)}>
                              {lang === 'th' ? '‚Üí DO' : '‚Üí DO'}
                            </Button>
                          )}
                          <Button size="sm" variant="ghost" onClick={() => { setSelectedItem(so); setEditMode(true); setShowSOModal(true) }}>
                            <Eye className="w-3 h-3" />
                          </Button>
                        </div>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* ========== ORDER TRACKER TAB (Full Order-to-Delivery Tracking v9.0) ========== */}
      {activeTab === 'tracker' && (
        <OrderTrackerComponent 
          salesOrders={salesOrders}
          setSalesOrders={setSalesOrders}
          customers={customers}
          workOrders={workOrders}
          products={products}
          deliveryOrders={deliveryOrders}
          setDeliveryOrders={setDeliveryOrders}
          invoices={invoices}
          setInvoices={setInvoices}
          trucks={trucks}
          employees={employees}
          lang={lang}
        />
      )}

      {/* Legacy Delivery Schedule Table - kept for reference */}
      {activeTab === 'schedule_legacy' && (
        <div className="space-y-4">
          <Card className="p-4 bg-gradient-to-r from-blue-50 to-cyan-50 border-blue-200">
            <div className="flex items-start gap-3">
              <CalendarDays className="w-6 h-6 text-blue-600 mt-1" />
              <div>
                <h3 className="font-bold text-blue-800">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Delivery Schedule - Customer Request Based'}</h3>
                <p className="text-sm text-blue-600 mt-1">
                  {lang === 'th' 
                    ? '‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' 
                    : 'Revise delivery schedules based on customer requests. All changes are logged.'}
                </p>
              </div>
            </div>
          </Card>
          <Card className="overflow-hidden">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Pending Deliveries'}</h3>
              <div className="flex gap-2">
                <select className="px-3 py-2 border rounded-lg text-sm">
                  <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'All Customers'}</option>
                  {customers.map(c => (
                    <option key={c.id} value={c.id}>{c.name}</option>
                  ))}
                </select>
                <select className="px-3 py-2 border rounded-lg text-sm">
                  <option value="all">{lang === 'th' ? '‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'All Status'}</option>
                  <option value="planned">{lang === 'th' ? '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 'Planned'}</option>
                  <option value="revised">{lang === 'th' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß' : 'Revised'}</option>
                  <option value="confirmed">{lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 'Confirmed'}</option>
                </select>
              </div>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{lang === 'th' ? 'SO #' : 'SO #'}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
                    <th className="px-4 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                    <th className="px-4 py-3 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á' : 'Location'}</th>
                    <th className="px-4 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°' : 'Original Date'}</th>
                    <th className="px-4 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà' : 'New Date'}</th>
                    <th className="px-4 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                    <th className="px-4 py-3 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {salesOrders?.flatMap(so => {
                    const customer = customers.find(c => c.id === so.customerId)
                    return so.items?.flatMap((item, itemIdx) => {
                      if (!item.deliverySchedule || item.deliverySchedule.length === 0) {
                        // Show items without schedule
                        return [{
                          soId: so.id,
                          customerPO: so.customerPO,
                          customer,
                          item,
                          itemIdx,
                          schedule: null,
                          schedIdx: -1
                        }]
                      }
                      return item.deliverySchedule.map((sched, schedIdx) => ({
                        soId: so.id,
                        customerPO: so.customerPO,
                        customer,
                        item,
                        itemIdx,
                        schedule: sched,
                        schedIdx
                      }))
                    }) || []
                  }).map((row, idx) => (
                    <tr key={idx} className={`hover:bg-gray-50 ${row.schedule?.status === 'revised' ? 'bg-yellow-50' : ''}`}>
                      <td className="px-4 py-3">
                        <span className="font-mono text-blue-600">{row.soId}</span>
                        <div className="text-xs text-gray-400">{row.customerPO}</div>
                      </td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{row.customer?.name}</div>
                        <div className="text-xs text-gray-400">{row.customer?.orderType || 'PO'}</div>
                      </td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{row.item.productName}</div>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <span className="font-medium">{row.schedule?.qty || row.item.qty}</span>
                        <span className="text-gray-400 text-xs ml-1">{row.item.unit}</span>
                      </td>
                      <td className="px-4 py-3">
                        {row.schedule?.locationName ? (
                          <div>
                            <div className="font-medium text-orange-600">{row.schedule.locationName}</div>
                          </div>
                        ) : (
                          <span className="text-gray-400 text-xs">{lang === 'th' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Not set'}</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        {row.schedule?.originalDate ? (
                          <span className="text-gray-500 line-through text-xs">{formatDate(row.schedule.originalDate)}</span>
                        ) : row.schedule?.deliveryDate ? (
                          <span className="text-gray-600">{formatDate(row.schedule.deliveryDate)}</span>
                        ) : (
                          <span className="text-gray-400">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        {row.schedule?.revisedDate ? (
                          <span className="font-medium text-blue-600">{formatDate(row.schedule.revisedDate)}</span>
                        ) : row.schedule?.deliveryDate ? (
                          <span className="text-gray-600">{formatDate(row.schedule.deliveryDate)}</span>
                        ) : (
                          <span className="text-red-400">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ' : 'None'}</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          row.schedule?.status === 'confirmed' ? 'success' :
                          row.schedule?.status === 'revised' ? 'warning' :
                          row.schedule?.status === 'planned' ? 'info' :
                          'default'
                        }>
                          {row.schedule?.status || (lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô' : 'No Plan')}
                        </Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          <Button 
                            size="sm" 
                            variant="outline"
                            onClick={() => {
                              const newDate = prompt(lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà (YYYY-MM-DD):' : 'Enter new delivery date (YYYY-MM-DD):')
                              const reason = prompt(lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤):' : 'Reason for change (customer request):')
                              if (newDate && reason) {
                                setSalesOrders(salesOrders.map(so => {
                                  if (so.id === row.soId) {
                                    return {
                                      ...so,
                                      items: so.items.map((item, iIdx) => {
                                        if (iIdx === row.itemIdx && item.deliverySchedule) {
                                          return {
                                            ...item,
                                            deliverySchedule: item.deliverySchedule.map((sched, sIdx) => {
                                              if (sIdx === row.schedIdx) {
                                                return {
                                                  ...sched,
                                                  originalDate: sched.originalDate || sched.deliveryDate,
                                                  revisedDate: newDate,
                                                  deliveryDate: newDate,
                                                  status: 'revised',
                                                  revisionHistory: [
                                                    ...(sched.revisionHistory || []),
                                                    {
                                                      date: new Date().toISOString(),
                                                      from: sched.deliveryDate,
                                                      to: newDate,
                                                      reason: reason,
                                                      requestedBy: 'Customer',
                                                      changedBy: 'Sales'
                                                    }
                                                  ]
                                                }
                                              }
                                              return sched
                                            })
                                          }
                                        }
                                        return item
                                      })
                                    }
                                  }
                                  return so
                                }))
                                alert(lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Change saved!')
                              }
                            }}
                            title={lang === 'th' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á' : 'Change Date'}
                          >
                            <Edit3 className="w-3 h-3" />
                          </Button>
                          {row.schedule?.status === 'revised' && (
                            <Button 
                              size="sm" 
                              variant="success"
                              onClick={() => {
                                setSalesOrders(salesOrders.map(so => {
                                  if (so.id === row.soId) {
                                    return {
                                      ...so,
                                      items: so.items.map((item, iIdx) => {
                                        if (iIdx === row.itemIdx && item.deliverySchedule) {
                                          return {
                                            ...item,
                                            deliverySchedule: item.deliverySchedule.map((sched, sIdx) => {
                                              if (sIdx === row.schedIdx) {
                                                return { ...sched, status: 'confirmed' }
                                              }
                                              return sched
                                            })
                                          }
                                        }
                                        return item
                                      })
                                    }
                                  }
                                  return so
                                }))
                              }}
                              title={lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : 'Confirm'}
                            >
                              <Check className="w-3 h-3" />
                            </Button>
                          )}
                          {row.schedule?.revisionHistory?.length > 0 && (
                            <Button 
                              size="sm" 
                              variant="ghost"
                              onClick={() => {
                                const history = row.schedule.revisionHistory.map(h => 
                                  `${h.date.split('T')[0]}: ${h.from} ‚Üí ${h.to}\nReason: ${h.reason}`
                                ).join('\n\n')
                                alert(`Revision History:\n\n${history}`)
                              }}
                              title={lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô' : 'History'}
                            >
                              <History className="w-3 h-3" />
                            </Button>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Card>

          {/* Summary Cards */}
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total Scheduled'}</div>
              <div className="text-2xl font-bold text-blue-600">
                {salesOrders?.reduce((sum, so) => sum + (so.items?.reduce((iSum, item) => iSum + (item.deliverySchedule?.length || 0), 0) || 0), 0) || 0}
              </div>
            </Card>
            <Card className="p-4 border-l-4 border-l-yellow-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : 'Pending Revision'}</div>
              <div className="text-2xl font-bold text-yellow-600">
                {salesOrders?.reduce((sum, so) => sum + (so.items?.reduce((iSum, item) => 
                  iSum + (item.deliverySchedule?.filter(s => s.status === 'revised').length || 0), 0) || 0), 0) || 0}
              </div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : 'Confirmed'}</div>
              <div className="text-2xl font-bold text-green-600">
                {salesOrders?.reduce((sum, so) => sum + (so.items?.reduce((iSum, item) => 
                  iSum + (item.deliverySchedule?.filter(s => s.status === 'confirmed').length || 0), 0) || 0), 0) || 0}
              </div>
            </Card>
            <Card className="p-4 border-l-4 border-l-red-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô' : 'No Schedule'}</div>
              <div className="text-2xl font-bold text-red-600">
                {salesOrders?.reduce((sum, so) => sum + (so.items?.filter(item => !item.deliverySchedule || item.deliverySchedule.length === 0).length || 0), 0) || 0}
              </div>
            </Card>
          </div>
        </div>
      )}

      {/* ========== DELIVERY ORDERS TAB ========== */}
      {activeTab === 'delivery' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b">
            <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Delivery Orders List'}</h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà DO' : 'DO #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? 'SO ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : 'SO Ref'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á' : 'Delivery Date'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ñ/‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö' : 'Truck/Driver'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {deliveryOrders?.map(doItem => {
                  const customer = customers.find(c => c.id === doItem.customerId)
                  const truck = trucks?.find(t => t.id === doItem.truckId)
                  const driver = employees?.find(e => e.id === doItem.driverId)
                  const hasInvoice = invoices?.some(inv => inv.doId === doItem.id)
                  return (
                    <tr key={doItem.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-orange-600">{doItem.id}</td>
                      <td className="px-4 py-3 font-mono text-blue-500 text-sm">{doItem.soId}</td>
                      <td className="px-4 py-3">{customer?.name}</td>
                      <td className="px-4 py-3">{formatDate(doItem.deliveryDate)}</td>
                      <td className="px-4 py-3 text-sm">
                        {truck?.code || '-'} / {driver?.name || '-'}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          doItem.status === 'delivered' ? 'success' :
                          doItem.status === 'dispatched' ? 'info' :
                          'warning'
                        }>{doItem.status}</Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        {hasInvoice ? (
                          <span className="text-green-600 text-sm">{invoices.find(inv => inv.doId === doItem.id)?.id}</span>
                        ) : (
                          <Button size="sm" variant="outline" onClick={() => handleCreateInvoice(doItem)}>
                            {lang === 'th' ? '‚Üí INV' : '‚Üí INV'}
                          </Button>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          {doItem.status === 'pending' && (
                            <Button size="sm" variant="info" onClick={() => setDeliveryOrders(deliveryOrders.map(d => d.id === doItem.id ? {...d, status: 'dispatched'} : d))}>
                              {lang === 'th' ? '‡∏≠‡∏≠‡∏Å' : 'Dispatch'}
                            </Button>
                          )}
                          {doItem.status === 'dispatched' && (
                            <Button size="sm" variant="success" onClick={() => setDeliveryOrders(deliveryOrders.map(d => d.id === doItem.id ? {...d, status: 'delivered', receivedAt: new Date().toISOString()} : d))}>
                              {lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered'}
                            </Button>
                          )}
                          <Button size="sm" variant="ghost" onClick={() => { setSelectedItem(doItem); setShowPrintDO(true) }} title="Print DO">
                            <Printer className="w-3 h-3" />
                          </Button>
                        </div>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* ========== INVOICES TAB ========== */}
      {activeTab === 'invoices' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b">
            <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices List'}</h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'Invoice #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Due Date'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Total'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Balance'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {invoices?.map(inv => {
                  const customer = customers.find(c => c.id === inv.customerId)
                  const isOverdue = new Date(inv.dueDate) < new Date() && inv.balance > 0
                  return (
                    <tr key={inv.id} className={`hover:bg-gray-50 ${isOverdue ? 'bg-red-50' : ''}`}>
                      <td className="px-4 py-3 font-mono text-teal-600">{inv.id}</td>
                      <td className="px-4 py-3">{customer?.name}</td>
                      <td className="px-4 py-3">{formatDate(inv.invoiceDate)}</td>
                      <td className="px-4 py-3">
                        <span className={isOverdue ? 'text-red-600 font-bold' : ''}>{formatDate(inv.dueDate)}</span>
                        {isOverdue && <AlertTriangle className="w-3 h-3 inline ml-1 text-red-500" />}
                      </td>
                      <td className="px-4 py-3 text-right font-medium">{formatCurrency(inv.grandTotal)}</td>
                      <td className="px-4 py-3 text-right text-green-600">{formatCurrency(inv.paidAmount || 0)}</td>
                      <td className="px-4 py-3 text-right text-red-600 font-bold">{formatCurrency(inv.balance || 0)}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          inv.status === 'paid' ? 'success' :
                          inv.status === 'partial' ? 'warning' :
                          isOverdue ? 'danger' :
                          'info'
                        }>{isOverdue && inv.status !== 'paid' ? 'overdue' : inv.status}</Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          {inv.balance > 0 && (
                            <Button size="sm" variant="success" onClick={() => { setSelectedItem(inv); setShowPaymentModal(true) }}>
                              {lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞' : 'Pay'}
                            </Button>
                          )}
                          <Button size="sm" variant="ghost" onClick={() => { setSelectedItem(inv); setShowInvoiceModal(true) }} title="View">
                            <Eye className="w-3 h-3" />
                          </Button>
                          <Button size="sm" variant="ghost" onClick={() => { 
                            setSelectedItem(inv); 
                            const cust = customers.find(c => c.id === inv.customerId);
                            if (cust?.type === 'export') {
                              setShowPrintExportInvoice(true);
                            } else {
                              setShowPrintInvoice(true);
                            }
                          }} title="Print">
                            <Printer className="w-3 h-3" />
                          </Button>
                          {(customers.find(c => c.id === inv.customerId)?.specialRequirements?.htCertificate || 
                            customers.find(c => c.id === inv.customerId)?.type === 'export') && (
                            <Button size="sm" variant="warning" onClick={() => { setSelectedItem(inv); setShowHTCertModal(true) }} title="HT Certificate">
                              <BadgeCheck className="w-3 h-3" />
                            </Button>
                          )}
                          {/* Allianz QR Labels - show for Allianz customer (ALL-013) */}
                          {(customers.find(c => c.id === inv.customerId)?.specialRequirements?.qrLabels ||
                            customers.find(c => c.id === inv.customerId)?.code?.includes('ALL')) && (
                            <Button size="sm" variant="info" onClick={() => { setSelectedItem(inv); setShowAllianzLabels(true) }} title="Allianz QR Labels">
                              <QrCode className="w-3 h-3" />
                            </Button>
                          )}
                          {/* Polyplex Labels - show for Polyplex customer (PLX-002) */}
                          {(customers.find(c => c.id === inv.customerId)?.specialRequirements?.labelFormat ||
                            customers.find(c => c.id === inv.customerId)?.code?.includes('PLX')) && (
                            <Button size="sm" variant="outline" onClick={() => { setSelectedItem(inv); setShowPolyplexLabels(true) }} title="Polyplex Labels">
                              <Tag className="w-3 h-3" />
                            </Button>
                          )}
                          {/* Receipt Acknowledgment - for driver to get customer signature */}
                          <Button size="sm" variant="success" onClick={() => { setSelectedItem(inv); setShowReceiptAck(true) }} title={lang === 'th' ? '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Receipt'}>
                            <CheckCircle className="w-3 h-3" />
                          </Button>
                        </div>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* ========== PAYMENTS TAB ========== */}
      {activeTab === 'payments' && (
        <div className="space-y-6">
          <Card className="p-5">
            <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' : 'Payment History'}</h3>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Amount'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞' : 'Method'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : 'Reference'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {invoices?.flatMap(inv => 
                    (inv.payments || []).map(pmt => ({
                      ...pmt,
                      invoiceId: inv.id,
                      customerId: inv.customerId,
                    }))
                  ).sort((a, b) => new Date(b.date) - new Date(a.date)).map((pmt, idx) => {
                    const customer = customers.find(c => c.id === pmt.customerId)
                    return (
                      <tr key={`${pmt.invoiceId}-${idx}`} className="hover:bg-gray-50">
                        <td className="px-4 py-3">{formatDate(pmt.date)}</td>
                        <td className="px-4 py-3 font-mono text-teal-600">{pmt.invoiceId}</td>
                        <td className="px-4 py-3">{customer?.name}</td>
                        <td className="px-4 py-3 text-right font-bold text-green-600">{formatCurrency(pmt.amount)}</td>
                        <td className="px-4 py-3">
                          <Badge variant={pmt.method === 'transfer' ? 'info' : pmt.method === 'cash' ? 'success' : 'warning'}>
                            {pmt.method}
                          </Badge>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-500">{pmt.reference}</td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* ========== AR AGING TAB ========== */}
      {activeTab === 'aging' && (
        <div className="space-y-6">
          {/* Filter Bar */}
          <Card className="p-4">
            <div className="flex flex-wrap gap-4 items-end">
              <div className="flex-grow min-w-[200px]">
                <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'th' ? '‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Filter by Customer'}</label>
                <select 
                  value={agingCustomerFilter} 
                  onChange={(e) => setAgingCustomerFilter(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Customers'}</option>
                  {[...new Set(invoices?.filter(inv => inv.balance > 0).map(inv => inv.customerId))].map(custId => {
                    const cust = customers.find(c => c.id === custId)
                    return <option key={custId} value={custId}>{cust?.name}</option>
                  })}
                </select>
              </div>
              <div className="min-w-[150px]">
                <label className="block text-sm font-medium text-gray-600 mb-1">{lang === 'th' ? '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏' : 'Aging Bucket'}</label>
                <select 
                  value={agingBucketFilter} 
                  onChange={(e) => setAgingBucketFilter(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="all">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All'}</option>
                  <option value="current">{lang === 'th' ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'Current'}</option>
                  <option value="days30">1-30 {lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'}</option>
                  <option value="days60">31-60 {lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'}</option>
                  <option value="days90">61-90 {lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'}</option>
                  <option value="days120">90+ {lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'}</option>
                  <option value="overdue">{lang === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Overdue'}</option>
                </select>
              </div>
              <div className="flex gap-2">
                <Button size="sm" variant="ghost" onClick={() => { setAgingCustomerFilter(''); setAgingBucketFilter('all') }}>
                  {lang === 'th' ? '‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á' : 'Clear Filters'}
                </Button>
                {agingCustomerFilter && (
                  <Button size="sm" icon={FileText} onClick={() => { setSelectedCustomerForStatement(agingCustomerFilter); setShowCustomerStatement(true) }}>
                    {lang === 'th' ? '‡∏î‡∏π‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î' : 'View Statement'}
                  </Button>
                )}
              </div>
            </div>
          </Card>

          {/* Aging Summary Cards */}
          <div className="grid grid-cols-5 gap-4">
            {[
              { label: lang === 'th' ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'Current', amount: agingTotals.current, count: agingData.current.length, color: 'green', bucket: 'current' },
              { label: '1-30 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days30, count: agingData.days30.length, color: 'yellow', bucket: 'days30' },
              { label: '31-60 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days60, count: agingData.days60.length, color: 'orange', bucket: 'days60' },
              { label: '61-90 ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days90, count: agingData.days90.length, color: 'red', bucket: 'days90' },
              { label: '90+ ' + (lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'), amount: agingTotals.days120, count: agingData.days120.length, color: 'purple', bucket: 'days120' },
            ].map(bucket => (
              <Card 
                key={bucket.label} 
                className={`p-4 border-l-4 border-l-${bucket.color}-500 cursor-pointer hover:shadow-md transition-shadow ${agingBucketFilter === bucket.bucket ? 'ring-2 ring-blue-500' : ''}`}
                onClick={() => setAgingBucketFilter(agingBucketFilter === bucket.bucket ? 'all' : bucket.bucket)}
              >
                <div className="text-sm text-gray-500">{bucket.label}</div>
                <div className={`text-2xl font-bold text-${bucket.color}-600`}>{formatCurrency(bucket.amount)}</div>
                <div className="text-xs text-gray-400">{bucket.count} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'items'}</div>
              </Card>
            ))}
          </div>

          {/* Aging Detail Table */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding Receivables Detail'}</h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Due Date'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏Å‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô)' : 'Days Over'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á' : 'Balance'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≤‡∏¢‡∏∏' : 'Bucket'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {[...agingData.days120, ...agingData.days90, ...agingData.days60, ...agingData.days30, ...agingData.current]
                    .filter(inv => !agingCustomerFilter || inv.customerId === agingCustomerFilter)
                    .filter(inv => {
                      if (agingBucketFilter === 'all') return true
                      if (agingBucketFilter === 'current') return inv.daysPast <= 0
                      if (agingBucketFilter === 'days30') return inv.daysPast > 0 && inv.daysPast <= 30
                      if (agingBucketFilter === 'days60') return inv.daysPast > 30 && inv.daysPast <= 60
                      if (agingBucketFilter === 'days90') return inv.daysPast > 60 && inv.daysPast <= 90
                      if (agingBucketFilter === 'days120') return inv.daysPast > 90
                      if (agingBucketFilter === 'overdue') return inv.daysPast > 0
                      return true
                    })
                    .map(inv => (
                      <tr key={inv.id} className={`hover:bg-gray-50 ${inv.daysPast > 60 ? 'bg-red-50' : inv.daysPast > 30 ? 'bg-orange-50' : ''}`}>
                        <td className="px-4 py-3 font-medium">{inv.customerName}</td>
                        <td className="px-4 py-3 font-mono text-teal-600">{inv.id}</td>
                        <td className="px-4 py-3">{formatDate(inv.dueDate)}</td>
                        <td className="px-4 py-3 text-center">
                          <span className={inv.daysPast > 60 ? 'text-red-600 font-bold' : inv.daysPast > 30 ? 'text-orange-600' : ''}>
                            {inv.daysPast > 0 ? inv.daysPast : '-'}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-right font-bold text-red-600">{formatCurrency(inv.balance)}</td>
                        <td className="px-4 py-3 text-center">
                          <Badge variant={
                            inv.daysPast <= 0 ? 'success' :
                            inv.daysPast <= 30 ? 'warning' :
                            inv.daysPast <= 60 ? 'warning' :
                            'danger'
                          }>
                            {inv.daysPast <= 0 ? (lang === 'th' ? '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'Current') :
                             inv.daysPast <= 30 ? '1-30' :
                             inv.daysPast <= 60 ? '31-60' :
                             inv.daysPast <= 90 ? '61-90' : '90+'}
                          </Badge>
                        </td>
                      </tr>
                    ))}
                </tbody>
                <tfoot className="bg-gray-100">
                  <tr>
                    <td colSpan="4" className="px-4 py-3 font-bold text-right">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Total Outstanding'}</td>
                    <td className="px-4 py-3 text-right font-bold text-red-600 text-lg">
                      {formatCurrency(agingTotals.current + agingTotals.days30 + agingTotals.days60 + agingTotals.days90 + agingTotals.days120)}
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* ========== SALES REPORT TAB - Monthly Consolidated (Inspired by Salesforce/NetSuite) ========== */}
      {activeTab === 'reports' && (
        <div className="space-y-6">
          {/* Report Filters */}
          <Card className="p-4">
            <div className="flex flex-wrap gap-4 items-center">
              <div>
                <label className="block text-sm text-gray-500 mb-1">{lang === 'th' ? '‡∏õ‡∏µ' : 'Year'}</label>
                <select className="px-3 py-2 border rounded-lg">
                  <option value="2026">2026</option>
                  <option value="2025">2025</option>
                  <option value="2024">2024</option>
                </select>
              </div>
              <div>
                <label className="block text-sm text-gray-500 mb-1">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</label>
                <select className="px-3 py-2 border rounded-lg min-w-[200px]">
                  <option value="">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All Customers'}</option>
                  {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                </select>
              </div>
              <div className="ml-auto flex gap-2">
                <Button variant="outline"><Download className="w-4 h-4 mr-1" /> Excel</Button>
                <Button variant="outline"><Printer className="w-4 h-4 mr-1" /> Print</Button>
              </div>
            </div>
          </Card>

          {/* Summary Cards */}
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4 bg-gradient-to-br from-blue-50 to-blue-100">
              <div className="text-sm text-blue-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°' : 'Total Sales'}</div>
              <div className="text-2xl font-bold text-blue-700">{formatCurrency(invoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0))}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-green-50 to-green-100">
              <div className="text-sm text-green-600">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Collected'}</div>
              <div className="text-2xl font-bold text-green-700">{formatCurrency(invoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0))}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-orange-50 to-orange-100">
              <div className="text-sm text-orange-600">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</div>
              <div className="text-2xl font-bold text-orange-700">{formatCurrency(invoices.reduce((sum, inv) => sum + (inv.balance || 0), 0))}</div>
            </Card>
            <Card className="p-4 bg-gradient-to-br from-purple-50 to-purple-100">
              <div className="text-sm text-purple-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices'}</div>
              <div className="text-2xl font-bold text-purple-700">{invoices.length}</div>
            </Card>
          </div>

          {/* Monthly Breakdown - Expandable */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-gradient-to-r from-indigo-600 to-blue-600 text-white">
              <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Monthly Sales Report'}</h3>
            </div>
            <div className="divide-y">
              {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((month, idx) => {
                const monthInvoices = invoices.filter(inv => {
                  const invMonth = new Date(inv.invoiceDate || inv.createdAt).getMonth()
                  return invMonth === idx
                })
                const monthTotal = monthInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
                const monthPaid = monthInvoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0)
                
                return (
                  <div key={month} className="p-4 hover:bg-gray-50">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <div className="w-16 font-bold text-gray-700">{month}</div>
                        <div className="text-sm text-gray-500">{monthInvoices.length} invoices</div>
                      </div>
                      <div className="flex items-center gap-8">
                        <div className="text-right">
                          <div className="text-sm text-gray-500">Sales</div>
                          <div className="font-bold text-blue-600">{formatCurrency(monthTotal)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm text-gray-500">Collected</div>
                          <div className="font-bold text-green-600">{formatCurrency(monthPaid)}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm text-gray-500">Outstanding</div>
                          <div className="font-bold text-orange-600">{formatCurrency(monthTotal - monthPaid)}</div>
                        </div>
                        <div className="w-32">
                          <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-green-500" 
                              style={{ width: `${monthTotal > 0 ? (monthPaid / monthTotal) * 100 : 0}%` }}
                            />
                          </div>
                          <div className="text-xs text-gray-400 text-right mt-1">
                            {monthTotal > 0 ? Math.round((monthPaid / monthTotal) * 100) : 0}% collected
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>
          </Card>

          {/* Top Customers */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b">
              <h3 className="font-bold">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î' : 'Top Customers'}</h3>
            </div>
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">#</th>
                  <th className="px-4 py-3 text-left">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-right">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢' : 'Sales'}</th>
                  <th className="px-4 py-3 text-right">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞' : 'Paid'}</th>
                  <th className="px-4 py-3 text-right">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Balance'}</th>
                  <th className="px-4 py-3 text-center">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoices'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {customers.slice(0, 10).map((customer, idx) => {
                  const custInvoices = invoices.filter(inv => inv.customerId === customer.id)
                  const custTotal = custInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
                  const custPaid = custInvoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0)
                  return (
                    <tr key={customer.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-medium">{idx + 1}</td>
                      <td className="px-4 py-3">
                        <div className="font-medium">{customer.name}</div>
                        <div className="text-xs text-gray-400">{customer.code}</div>
                      </td>
                      <td className="px-4 py-3 text-right font-bold text-blue-600">{formatCurrency(custTotal)}</td>
                      <td className="px-4 py-3 text-right text-green-600">{formatCurrency(custPaid)}</td>
                      <td className="px-4 py-3 text-right text-orange-600">{formatCurrency(custTotal - custPaid)}</td>
                      <td className="px-4 py-3 text-center">{custInvoices.length}</td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </Card>
        </div>
      )}

      {/* ========== CUSTOMERS TAB ========== */}
      {activeTab === 'customers' && (
        <div className="space-y-6">
          <Card className="overflow-hidden">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer List'}</h3>
              <div className="text-sm text-gray-500">
                {customers.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢' : 'customers'}
              </div>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Name'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç' : 'Terms'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©' : 'Special Requirements'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢' : 'Revenue'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Outstanding'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {customers.map(cust => {
                    const custInvoices = invoices?.filter(inv => inv.customerId === cust.id) || []
                    const revenue = custInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
                    const outstanding = custInvoices.reduce((sum, inv) => sum + (inv.balance || 0), 0)
                    return (
                      <tr key={cust.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 font-mono text-blue-600">{cust.code}</td>
                        <td className="px-4 py-3">
                          <div className="font-medium">{cust.name}</div>
                          <div className="text-xs text-gray-400">{cust.contact}</div>
                        </td>
                        <td className="px-4 py-3 text-center">
                          <Badge variant={cust.type === 'export' ? 'info' : 'default'}>
                            {cust.type === 'export' ? (lang === 'th' ? '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å' : 'Export') : (lang === 'th' ? '‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' : 'Local')}
                          </Badge>
                        </td>
                        <td className="px-4 py-3 text-center text-sm">{cust.paymentTerms || 'Net 30'}</td>
                        <td className="px-4 py-3 text-center">
                          <div className="flex justify-center gap-1 flex-wrap">
                            {cust.specialRequirements?.htCertificate && (
                              <Badge variant="warning" className="text-xs">HT Cert</Badge>
                            )}
                            {cust.specialRequirements?.qrLabels && (
                              <Badge variant="info" className="text-xs">QR Labels</Badge>
                            )}
                            {cust.specialRequirements?.labelFormat && (
                              <Badge variant="outline" className="text-xs">Custom Labels</Badge>
                            )}
                            {cust.code?.includes('ALL') && (
                              <Badge variant="info" className="text-xs">Allianz</Badge>
                            )}
                            {cust.code?.includes('PLX') && (
                              <Badge variant="outline" className="text-xs">Polyplex</Badge>
                            )}
                            {!cust.specialRequirements?.htCertificate && !cust.specialRequirements?.qrLabels && 
                             !cust.specialRequirements?.labelFormat && !cust.code?.includes('ALL') && !cust.code?.includes('PLX') && (
                              <span className="text-gray-400 text-xs">-</span>
                            )}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-right font-medium text-green-600">{formatCurrency(revenue)}</td>
                        <td className="px-4 py-3 text-right">
                          {outstanding > 0 ? (
                            <span className="font-bold text-red-600">{formatCurrency(outstanding)}</span>
                          ) : (
                            <span className="text-gray-400">-</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center">
                          <div className="flex justify-center gap-1">
                            <Button size="sm" variant="ghost" onClick={() => { setSelectedCustomerForStatement(cust.id); setShowCustomerStatement(true) }} title={lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î' : 'Statement'}>
                              <FileText className="w-3 h-3" />
                            </Button>
                          </div>
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>

          {/* Customer Requirements Legend */}
          <Card className="p-4">
            <h4 className="font-bold mb-3">{lang === 'th' ? '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Special Requirements'}</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div className="p-3 bg-blue-50 rounded-lg">
                <div className="font-bold text-blue-700">Allianz (ALL-013)</div>
                <ul className="text-blue-600 text-xs mt-1 space-y-1">
                  <li>‚Ä¢ QR Code Labels (Invoice + Packaging)</li>
                  <li>‚Ä¢ Heat Treatment Certificate</li>
                  <li>‚Ä¢ Vendor Code: 115050</li>
                </ul>
              </div>
              <div className="p-3 bg-green-50 rounded-lg">
                <div className="font-bold text-green-700">Polyplex (PLX-002)</div>
                <ul className="text-green-600 text-xs mt-1 space-y-1">
                  <li>‚Ä¢ 4-Column Label Sheet</li>
                  <li>‚Ä¢ Color Coded (FILM/CPP/Line 10)</li>
                  <li>‚Ä¢ Delivery Location on Labels</li>
                </ul>
              </div>
              <div className="p-3 bg-orange-50 rounded-lg">
                <div className="font-bold text-orange-700">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å' : 'Export Customers'}</div>
                <ul className="text-orange-600 text-xs mt-1 space-y-1">
                  <li>‚Ä¢ Heat Treatment Certificate (ISPM15)</li>
                  <li>‚Ä¢ Export Invoice (No VAT)</li>
                  <li>‚Ä¢ Packing List Required</li>
                </ul>
              </div>
              <div className="p-3 bg-purple-50 rounded-lg">
                <div className="font-bold text-purple-700">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' : 'Standard Customers'}</div>
                <ul className="text-purple-600 text-xs mt-1 space-y-1">
                  <li>‚Ä¢ Tax Invoice with VAT</li>
                  <li>‚Ä¢ Delivery Order</li>
                  <li>‚Ä¢ Receipt Acknowledgment</li>
                </ul>
              </div>
            </div>
          </Card>
        </div>
      )}

      {/* ========== PRICE HISTORY TAB ========== */}
      {activeTab === 'pricing' && (
        <div className="space-y-6">
          <Card className="p-5">
            <div className="flex justify-between items-center mb-4">
              <div>
                <h3 className="font-bold">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price Change History'}</h3>
                <p className="text-sm text-gray-500">{lang === 'th' ? '‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Per policy: Email notification with reason required for all price changes'}</p>
              </div>
              <Button size="sm" icon={Plus}>
                {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Log Price Change'}
              </Button>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•' : 'Effective Date'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°' : 'Old Price'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Price'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : 'Change'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•' : 'Email Ref'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢' : 'Approved By'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {priceHistory.map((record, idx) => {
                    const change = ((record.newPrice - record.oldPrice) / record.oldPrice * 100).toFixed(1)
                    const isIncrease = record.newPrice > record.oldPrice
                    const getReasonLabel = (reason) => {
                      switch(reason) {
                        case 'material_cost_increase': return lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°' : 'Material Cost ‚Üë'
                        case 'material_cost_decrease': return lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏•‡∏î' : 'Material Cost ‚Üì'
                        case 'customer_negotiation': return lang === 'th' ? '‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Negotiation'
                        case 'volume_discount': return lang === 'th' ? '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì' : 'Volume Discount'
                        case 'market_adjustment': return lang === 'th' ? '‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î' : 'Market Adjustment'
                        case 'annual_review': return lang === 'th' ? '‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ' : 'Annual Review'
                        default: return reason
                      }
                    }
                    return (
                      <tr key={idx} className="hover:bg-gray-50">
                        <td className="px-4 py-3">{formatDate(record.effectiveDate)}</td>
                        <td className="px-4 py-3">
                          <div className="font-medium">{record.productName}</div>
                          <div className="text-xs text-gray-400 font-mono">{record.productId}</div>
                        </td>
                        <td className="px-4 py-3 text-right text-gray-500">{formatCurrency(record.oldPrice)}</td>
                        <td className="px-4 py-3 text-right font-bold">{formatCurrency(record.newPrice)}</td>
                        <td className="px-4 py-3 text-center">
                          <span className={`font-bold ${isIncrease ? 'text-red-600' : 'text-green-600'}`}>
                            {isIncrease ? '‚Üë' : '‚Üì'} {Math.abs(change)}%
                          </span>
                        </td>
                        <td className="px-4 py-3">
                          <Badge variant={isIncrease ? 'danger' : 'success'} className="text-xs">
                            {getReasonLabel(record.reason)}
                          </Badge>
                        </td>
                        <td className="px-4 py-3 text-xs text-blue-600">{record.emailRef || '-'}</td>
                        <td className="px-4 py-3 text-sm">{record.approvedBy}</td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>

          {/* Price Change Policy */}
          <Card className="p-4 bg-yellow-50 border-yellow-200">
            <h4 className="font-bold text-yellow-800 mb-2">üìã {lang === 'th' ? '‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price Change Policy'}</h4>
            <ul className="text-sm text-yellow-700 space-y-1">
              <li>‚Ä¢ {lang === 'th' ? '‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏ú‡∏•' : 'Customer must be notified via official email before effective date'}</li>
              <li>‚Ä¢ {lang === 'th' ? '‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•' : 'Reason for price change must be included in email'}</li>
              <li>‚Ä¢ {lang === 'th' ? '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å CEO' : 'ALL discounts require CEO approval - no exceptions'}</li>
              <li>‚Ä¢ {lang === 'th' ? '‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : 'All price changes must be logged for audit trail'}</li>
            </ul>
          </Card>
        </div>
      )}

      {/* ========== REJECTIONS TAB ========== */}
      {activeTab === 'rejections' && (
        <div className="space-y-6">
          <Card className="overflow-hidden">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏£‡∏±‡∏ö' : 'Returns & Rejections'}</h3>
              <Button size="sm" icon={Plus} onClick={() => { setEditMode(false); setSelectedItem(null); setShowRejectionModal(true) }}>
                {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô' : 'New Return'}
              </Button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'REJ #'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? 'Invoice/DO' : 'Invoice/DO'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏' : 'Reason'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {rejections?.map(rej => {
                    const customer = customers.find(c => c.id === rej.customerId)
                    return (
                      <tr key={rej.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 font-mono text-red-600">{rej.id}</td>
                        <td className="px-4 py-3">{formatDate(rej.date)}</td>
                        <td className="px-4 py-3">{customer?.name}</td>
                        <td className="px-4 py-3 text-sm">
                          <span className="font-mono text-teal-600">{rej.invoiceId}</span>
                          {rej.doId && <span className="text-gray-400 ml-1">/ {rej.doId}</span>}
                        </td>
                        <td className="px-4 py-3 text-center font-bold text-red-600">{rej.totalRejected}</td>
                        <td className="px-4 py-3">
                          <Badge variant={
                            rej.reason === 'damaged' ? 'danger' :
                            rej.reason === 'quality_issue' ? 'warning' :
                            'default'
                          }>{rej.reason}</Badge>
                        </td>
                        <td className="px-4 py-3 text-center">
                          <Badge variant={
                            rej.status === 'resolved' ? 'success' :
                            rej.status === 'in_progress' ? 'info' :
                            'warning'
                          }>{rej.status}</Badge>
                        </td>
                        <td className="px-4 py-3 text-center">
                          <div className="flex items-center justify-center gap-1">
                            {rej.status === 'open' && !rej.creditNoteId && (
                              <Button size="sm" variant="warning" onClick={() => handleCreateCreditNote(rej)}>
                                {lang === 'th' ? '‡∏≠‡∏≠‡∏Å CN' : 'Issue CN'}
                              </Button>
                            )}
                            {rej.creditNoteId && (
                              <span className="text-xs text-green-600 font-mono">{rej.creditNoteId}</span>
                            )}
                          </div>
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>

          {/* Credit Notes Section */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b bg-yellow-50">
              <h3 className="font-bold text-yellow-800">{lang === 'th' ? '‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ (Credit Notes)' : 'Credit Notes'}</h3>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'CN #'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? 'Invoice ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : 'Ref Invoice'}</th>
                    <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Amount'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {creditNotes?.map(cn => {
                    const customer = customers.find(c => c.id === cn.customerId)
                    return (
                      <tr key={cn.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 font-mono text-yellow-600">{cn.id}</td>
                        <td className="px-4 py-3">{formatDate(cn.date)}</td>
                        <td className="px-4 py-3">{customer?.name}</td>
                        <td className="px-4 py-3 font-mono text-teal-600">{cn.originalInvoiceId}</td>
                        <td className="px-4 py-3 text-right font-bold text-yellow-600">{formatCurrency(cn.grandTotal)}</td>
                        <td className="px-4 py-3 text-center">
                          <Badge variant={cn.status === 'applied' ? 'success' : cn.status === 'issued' ? 'info' : 'warning'}>
                            {cn.status}
                          </Badge>
                        </td>
                        <td className="px-4 py-3 text-center">
                          <Button size="sm" variant="ghost" onClick={() => { 
                            setSelectedItem({ ...cn, amount: cn.grandTotal, invoiceId: cn.originalInvoiceId }); 
                            setShowCreditNotePrint(true) 
                          }} title="Print">
                            <Printer className="w-3 h-3" />
                          </Button>
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* ========== CLAIMS TAB ========== */}
      {activeTab === 'claims' && (
        <Card className="overflow-hidden">
          <div className="p-4 border-b flex justify-between items-center">
            <h3 className="font-bold">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°/‡∏Ç‡πâ‡∏≠‡∏û‡∏¥‡∏û‡∏≤‡∏ó' : 'Claims & Disputes'}</h3>
            <Button size="sm" icon={Plus} onClick={() => { setEditMode(false); setSelectedItem(null); setShowClaimModal(true) }}>
              {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏•‡∏°' : 'New Claim'}
            </Button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'CLM #'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                  <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏•‡∏°' : 'Claim Amt'}</th>
                  <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'Description'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
                  <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : 'Resolution'}</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {claims?.map(claim => {
                  const customer = customers.find(c => c.id === claim.customerId)
                  return (
                    <tr key={claim.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3 font-mono text-orange-600">{claim.id}</td>
                      <td className="px-4 py-3">{formatDate(claim.date)}</td>
                      <td className="px-4 py-3">{customer?.name}</td>
                      <td className="px-4 py-3">
                        <Badge variant={
                          claim.claimType === 'quality' ? 'warning' :
                          claim.claimType === 'damage' ? 'danger' :
                          claim.claimType === 'shortage' ? 'info' :
                          'default'
                        }>{claim.claimType}</Badge>
                      </td>
                      <td className="px-4 py-3 text-right font-bold">{claim.claimAmount ? formatCurrency(claim.claimAmount) : '-'}</td>
                      <td className="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">{claim.description}</td>
                      <td className="px-4 py-3 text-center">
                        <Badge variant={
                          claim.status === 'closed' || claim.status === 'resolved' ? 'success' :
                          claim.status === 'under_review' ? 'info' :
                          'warning'
                        }>{claim.status}</Badge>
                      </td>
                      <td className="px-4 py-3 text-center">
                        {claim.resolution ? (
                          <Badge variant={claim.resolution === 'accepted_full' ? 'success' : claim.resolution === 'rejected' ? 'danger' : 'warning'}>
                            {claim.resolution}
                          </Badge>
                        ) : '-'}
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </Card>
      )}

      {/* ========== MEETINGS TAB ========== */}
      {activeTab === 'meetings' && (
        <div className="space-y-6">
          {/* Meeting Stats */}
          <div className="grid grid-cols-4 gap-4">
            <Card className="p-4 border-l-4 border-l-blue-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ' : 'This Month'}</div>
              <div className="text-2xl font-bold text-blue-600">{stats.meetingsThisMonth}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-red-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' : 'Follow-ups Due'}</div>
              <div className="text-2xl font-bold text-red-600">{stats.followupsDue}</div>
            </Card>
            <Card className="p-4 border-l-4 border-l-green-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'Orders Won'}</div>
              <div className="text-2xl font-bold text-green-600">
                {salesMeetings?.filter(m => m.outcome === 'order_received').length || 0}
              </div>
            </Card>
            <Card className="p-4 border-l-4 border-l-purple-500">
              <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quote Requested'}</div>
              <div className="text-2xl font-bold text-purple-600">
                {salesMeetings?.filter(m => m.outcome === 'quotation_requested').length || 0}
              </div>
            </Card>
          </div>

          {/* Meeting List */}
          <Card className="overflow-hidden">
            <div className="p-4 border-b flex justify-between items-center">
              <h3 className="font-bold">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Sales Meeting Log'}</h3>
              <Button size="sm" icon={Plus} onClick={() => { setEditMode(false); setSelectedItem(null); setShowMeetingModal(true) }}>
                {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°' : 'Log Meeting'}
              </Button>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' : 'Location'}</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå' : 'Outcome'}</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Follow-up'}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {salesMeetings?.sort((a, b) => new Date(b.date) - new Date(a.date)).map(meeting => {
                    const customer = customers.find(c => c.id === meeting.customerId)
                    const isFollowupDue = meeting.nextFollowupDate && new Date(meeting.nextFollowupDate) <= new Date()
                    return (
                      <tr key={meeting.id} className={`hover:bg-gray-50 ${isFollowupDue ? 'bg-red-50' : ''}`}>
                        <td className="px-4 py-3">
                          <div className="font-medium">{formatDate(meeting.date)}</div>
                          <div className="text-xs text-gray-500">{meeting.timeStart} - {meeting.timeEnd}</div>
                        </td>
                        <td className="px-4 py-3">
                          <div className="font-medium">{customer?.name || meeting.customerId}</div>
                          <div className="text-xs text-gray-500">{meeting.contactPerson}</div>
                        </td>
                        <td className="px-4 py-3">
                          <Badge variant={
                            meeting.customerType === 'existing' ? 'success' :
                            meeting.customerType === 'potential' ? 'warning' :
                            'info'
                          }>{meeting.customerType}</Badge>
                        </td>
                        <td className="px-4 py-3 text-sm">{meeting.reason?.replace('_', ' ')}</td>
                        <td className="px-4 py-3 text-sm">
                          {meeting.location === 'customer_site' ? 'üè≠ Customer' : 
                           meeting.location === 'ind' ? 'üè¢ IND' : 'üìç Other'}
                        </td>
                        <td className="px-4 py-3 text-center">
                          <Badge variant={
                            meeting.outcome === 'order_received' ? 'success' :
                            meeting.outcome === 'quotation_requested' ? 'info' :
                            meeting.outcome === 'lost' ? 'danger' :
                            'warning'
                          }>{meeting.outcome?.replace('_', ' ')}</Badge>
                        </td>
                        <td className="px-4 py-3">
                          {meeting.nextFollowupDate && (
                            <span className={isFollowupDue ? 'text-red-600 font-bold' : ''}>
                              {formatDate(meeting.nextFollowupDate)}
                              {isFollowupDue && <AlertTriangle className="w-3 h-3 inline ml-1" />}
                            </span>
                          )}
                        </td>
                      </tr>
                    )
                  })}
                </tbody>
              </table>
            </div>
          </Card>
        </div>
      )}

      {/* ========== MODALS ========== */}
      
      {/* Quotation Modal */}
      {showQuotationModal && (
        <Modal isOpen={showQuotationModal} onClose={() => { setShowQuotationModal(false); setSelectedItem(null); setEditMode(false) }} 
               title={editMode ? (lang === 'th' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Edit Quotation') : (lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'New Quotation')} size="xl">
          <QuotationForm
            quotation={selectedItem}
            customers={customers}
            products={products}
            lang={lang}
            onSave={handleSaveQuotation}
            onCancel={() => { setShowQuotationModal(false); setSelectedItem(null); setEditMode(false) }}
          />
        </Modal>
      )}

      {/* SO Modal */}
      {showSOModal && (
        <Modal isOpen={showSOModal} onClose={() => { setShowSOModal(false); setSelectedItem(null); setEditMode(false) }}
               title={editMode ? (lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'Sales Order Details') : (lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢' : 'New Sales Order')} size="xl">
          <SalesOrderForm
            so={selectedItem}
            customers={customers}
            products={products || []}
            lang={lang}
            onSave={handleSaveSO}
            onCancel={() => { setShowSOModal(false); setSelectedItem(null); setEditMode(false) }}
          />
        </Modal>
      )}

      {/* DO Modal */}
      {showDOModal && selectedItem && (
        <Modal isOpen={showDOModal} onClose={() => { setShowDOModal(false); setSelectedItem(null) }}
               title={lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Create Delivery Order'} size="lg">
          <DeliveryOrderForm
            so={selectedItem}
            customers={customers}
            trucks={trucks}
            employees={employees}
            lang={lang}
            onSave={handleSaveDO}
            onCancel={() => { setShowDOModal(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Payment Modal */}
      {showPaymentModal && selectedItem && (
        <Modal isOpen={showPaymentModal} onClose={() => { setShowPaymentModal(false); setSelectedItem(null) }}
               title={lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' : 'Record Payment'} size="md">
          <PaymentForm
            invoice={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            lang={lang}
            onSave={(data) => handleRecordPayment(selectedItem, data)}
            onCancel={() => { setShowPaymentModal(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Invoice View Modal */}
      {showInvoiceModal && selectedItem && (
        <Modal isOpen={showInvoiceModal} onClose={() => { setShowInvoiceModal(false); setSelectedItem(null) }} 
               title={`${lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'} ${selectedItem.id}`} size="lg">
          <InvoiceView
            invoice={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            entity={selectedItem.entity}
            lang={lang}
          />
        </Modal>
      )}

      {/* Rejection Modal */}
      {showRejectionModal && (
        <Modal isOpen={showRejectionModal} onClose={() => { setShowRejectionModal(false); setSelectedItem(null); setEditMode(false) }}
               title={lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Record Return/Rejection'} size="lg">
          <RejectionForm
            rejection={selectedItem}
            customers={customers}
            invoices={invoices}
            deliveryOrders={deliveryOrders}
            lang={lang}
            onSave={handleSaveRejection}
            onCancel={() => { setShowRejectionModal(false); setSelectedItem(null); setEditMode(false) }}
          />
        </Modal>
      )}

      {/* Claim Modal */}
      {showClaimModal && (
        <Modal isOpen={showClaimModal} onClose={() => { setShowClaimModal(false); setSelectedItem(null); setEditMode(false) }}
               title={lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏•‡∏°' : 'Record Claim'} size="lg">
          <ClaimForm
            claim={selectedItem}
            customers={customers}
            invoices={invoices}
            rejections={rejections}
            lang={lang}
            onSave={handleSaveClaim}
            onCancel={() => { setShowClaimModal(false); setSelectedItem(null); setEditMode(false) }}
          />
        </Modal>
      )}

      {/* Meeting Modal */}
      {showMeetingModal && (
        <Modal isOpen={showMeetingModal} onClose={() => { setShowMeetingModal(false); setSelectedItem(null); setEditMode(false) }}
               title={lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Log Customer Meeting'} size="lg">
          <MeetingForm
            meeting={selectedItem}
            customers={customers}
            lang={lang}
            onSave={handleSaveMeeting}
            onCancel={() => { setShowMeetingModal(false); setSelectedItem(null); setEditMode(false) }}
          />
        </Modal>
      )}

      {/* ========== PRINT MODALS ========== */}
      
      {/* Print Tax Invoice (Local) */}
      {showPrintInvoice && selectedItem && (
        <Modal isOpen={showPrintInvoice} onClose={() => { setShowPrintInvoice(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ' : 'Print Tax Invoice'} size="xl">
          <InvoicePrintView
            invoice={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            entity={selectedItem.entity}
            onClose={() => { setShowPrintInvoice(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Print Export Invoice + Packing List */}
      {showPrintExportInvoice && selectedItem && (
        <Modal isOpen={showPrintExportInvoice} onClose={() => { setShowPrintExportInvoice(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å' : 'Print Export Invoice + Packing List'} size="xl">
          <ExportInvoicePrintView
            invoice={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            entity={selectedItem.entity}
            onClose={() => { setShowPrintExportInvoice(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Print Heat Treatment Certificate */}
      {showHTCertModal && selectedItem && (
        <Modal isOpen={showHTCertModal} onClose={() => { setShowHTCertModal(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô' : 'Print Heat Treatment Certificate'} size="lg">
          <HeatTreatmentCertPrintView
            certificate={{
              certNo: `${new Date().getFullYear().toString().slice(-2)}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}`,
              date: new Date(),
              treatmentDate: new Date(),
            }}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            items={selectedItem.items?.map(item => ({
              partNo: item.partNo || '',
              productName: item.productName || item.description,
              qty: item.qty,
            }))}
            onClose={() => { setShowHTCertModal(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Print Delivery Order */}
      {showPrintDO && selectedItem && (
        <Modal isOpen={showPrintDO} onClose={() => { setShowPrintDO(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Print Delivery Order'} size="xl">
          <DeliveryOrderPrintView
            deliveryOrder={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            truck={trucks?.find(t => t.id === selectedItem.truckId)}
            driver={employees?.find(e => e.id === selectedItem.driverId)}
            entity={selectedItem.entity}
            onClose={() => { setShowPrintDO(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Print Quotation */}
      {showPrintQuotation && selectedItem && (
        <Modal isOpen={showPrintQuotation} onClose={() => { setShowPrintQuotation(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Print Quotation'} size="xl">
          <QuotationPrintView
            quotation={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            entity={selectedItem.entity}
            onClose={() => { setShowPrintQuotation(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Allianz QR Labels */}
      {showAllianzLabels && selectedItem && (
        <Modal isOpen={showAllianzLabels} onClose={() => { setShowAllianzLabels(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏õ‡πâ‡∏≤‡∏¢ QR Allianz' : 'Allianz QR Labels'} size="xl">
          <AllianzLabelPrintView
            invoice={selectedItem}
            deliveryOrder={deliveryOrders.find(d => d.id === selectedItem.doId)}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            onClose={() => { setShowAllianzLabels(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Polyplex 4-Column Labels */}
      {showPolyplexLabels && selectedItem && (
        <Modal isOpen={showPolyplexLabels} onClose={() => { setShowPolyplexLabels(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏õ‡πâ‡∏≤‡∏¢ Polyplex' : 'Polyplex Labels'} size="xl">
          <PolyplexLabelPrintView
            invoice={selectedItem}
            deliveryOrder={deliveryOrders.find(d => d.id === selectedItem.doId)}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            onClose={() => { setShowPolyplexLabels(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Customer Statement */}
      {showCustomerStatement && (
        <Modal isOpen={showCustomerStatement} onClose={() => { setShowCustomerStatement(false); setSelectedCustomerForStatement(null) }} 
               title={lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Statement'} size="xl">
          <CustomerStatementPrintView
            customer={customers.find(c => c.id === selectedCustomerForStatement)}
            invoices={invoices}
            payments={[]}
            creditNotes={creditNotes}
            onClose={() => { setShowCustomerStatement(false); setSelectedCustomerForStatement(null) }}
          />
        </Modal>
      )}

      {/* Credit Note Print */}
      {showCreditNotePrint && selectedItem && (
        <Modal isOpen={showCreditNotePrint} onClose={() => { setShowCreditNotePrint(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ' : 'Print Credit Note'} size="xl">
          <CreditNotePrintView
            creditNote={selectedItem}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            invoice={invoices.find(inv => inv.id === selectedItem.invoiceId)}
            entity={selectedItem.entity}
            onClose={() => { setShowCreditNotePrint(false); setSelectedItem(null) }}
          />
        </Modal>
      )}

      {/* Receipt Acknowledgment */}
      {showReceiptAck && selectedItem && (
        <Modal isOpen={showReceiptAck} onClose={() => { setShowReceiptAck(false); setSelectedItem(null) }} 
               title={lang === 'th' ? '‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Receipt Acknowledgment'} size="lg">
          <ReceiptAcknowledgmentPrintView
            invoice={selectedItem}
            deliveryOrder={deliveryOrders.find(d => d.id === selectedItem.doId)}
            customer={customers.find(c => c.id === selectedItem.customerId)}
            entity={selectedItem.entity}
            onClose={() => { setShowReceiptAck(false); setSelectedItem(null) }}
          />
        </Modal>
      )}
    </div>
  )
}

// ============================================
// REJECTION FORM
// ============================================
const RejectionForm = ({ rejection, customers, invoices, deliveryOrders, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    date: rejection?.date || new Date().toISOString().split('T')[0],
    customerId: rejection?.customerId || '',
    invoiceId: rejection?.invoiceId || '',
    doId: rejection?.doId || '',
    items: rejection?.items || [{ productName: '', qtyRejected: 0, qtyDelivered: 0, reason: 'damaged', notes: '' }],
    totalRejected: rejection?.totalRejected || 0,
    reason: rejection?.reason || 'damaged',
    description: rejection?.description || '',
    action: rejection?.action || 'credit_note',
    handledBy: rejection?.handledBy || '',
  })

  const reasonOptions = [
    { id: 'wrong_size', label: lang === 'th' ? '‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á' : 'Wrong Size' },
    { id: 'damaged', label: lang === 'th' ? '‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢' : 'Damaged' },
    { id: 'quality_issue', label: lang === 'th' ? '‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û' : 'Quality Issue' },
    { id: 'wrong_product', label: lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏¥‡∏î' : 'Wrong Product' },
    { id: 'other', label: lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other' },
  ]

  const actionOptions = [
    { id: 'replace', label: lang === 'th' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà' : 'Replace' },
    { id: 'repair', label: lang === 'th' ? '‡∏ã‡πà‡∏≠‡∏°' : 'Repair' },
    { id: 'credit_note', label: lang === 'th' ? '‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ' : 'Credit Note' },
    { id: 'scrap_invoice', label: lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Scrap Invoice' },
  ]

  const handleSubmit = (e) => {
    e.preventDefault()
    const totalRej = formData.items.reduce((sum, item) => sum + (item.qtyRejected || 0), 0)
    onSave({ ...formData, totalRejected: totalRej })
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</label>
          <input type="date" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'} *</label>
          <select required value={formData.customerId} onChange={(e) => setFormData({...formData, customerId: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
            {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? 'Invoice ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : 'Reference Invoice'}</label>
          <select value={formData.invoiceId} onChange={(e) => setFormData({...formData, invoiceId: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Invoice' : 'Select Invoice'}</option>
            {invoices?.filter(inv => inv.customerId === formData.customerId).map(inv => <option key={inv.id} value={inv.id}>{inv.id}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏' : 'Reason'}</label>
          <select value={formData.reason} onChange={(e) => setFormData({...formData, reason: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {reasonOptions.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'Description'} *</label>
        <textarea required value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} className="w-full px-3 py-2 border rounded-lg" rows="2" />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : 'Qty Rejected'}</label>
          <input type="number" value={formData.items[0]?.qtyRejected || 0} onChange={(e) => setFormData({...formData, items: [{...formData.items[0], qtyRejected: parseInt(e.target.value) || 0}]})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Action'}</label>
          <select value={formData.action} onChange={(e) => setFormData({...formData, action: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {actionOptions.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="ghost" onClick={onCancel}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
        <Button type="submit" icon={Save}>{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}</Button>
      </div>
    </form>
  )
}

// ============================================
// CLAIM FORM
// ============================================
const ClaimForm = ({ claim, customers, invoices, rejections, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    date: claim?.date || new Date().toISOString().split('T')[0],
    customerId: claim?.customerId || '',
    relatedDocs: claim?.relatedDocs || { invoiceId: null, doId: null, rejectionId: null },
    claimType: claim?.claimType || 'quality',
    claimAmount: claim?.claimAmount || 0,
    description: claim?.description || '',
    investigationNotes: claim?.investigationNotes || '',
  })

  const claimTypes = [
    { id: 'quality', label: lang === 'th' ? '‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û' : 'Quality' },
    { id: 'shortage', label: lang === 'th' ? '‡∏Ç‡∏≤‡∏î/‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö' : 'Shortage' },
    { id: 'damage', label: lang === 'th' ? '‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢' : 'Damage' },
    { id: 'price_dispute', label: lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á' : 'Price Dispute' },
    { id: 'other', label: lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other' },
  ]

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</label>
          <input type="date" value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'} *</label>
          <select required value={formData.customerId} onChange={(e) => setFormData({...formData, customerId: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
            {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏•‡∏°' : 'Claim Type'}</label>
          <select value={formData.claimType} onChange={(e) => setFormData({...formData, claimType: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {claimTypes.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏•‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)' : 'Claim Amount (if any)'}</label>
          <input type="number" value={formData.claimAmount} onChange={(e) => setFormData({...formData, claimAmount: parseFloat(e.target.value) || 0})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏•‡∏°' : 'Claim Description'} *</label>
        <textarea required value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} className="w-full px-3 py-2 border rounded-lg" rows="3" />
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' : 'Investigation Notes'}</label>
        <textarea value={formData.investigationNotes} onChange={(e) => setFormData({...formData, investigationNotes: e.target.value})} className="w-full px-3 py-2 border rounded-lg" rows="2" />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="ghost" onClick={onCancel}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
        <Button type="submit" icon={Save}>{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}</Button>
      </div>
    </form>
  )
}

// ============================================
// MEETING FORM
// ============================================
const MeetingForm = ({ meeting, customers, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    date: meeting?.date || new Date().toISOString().split('T')[0],
    timeStart: meeting?.timeStart || '09:00',
    timeEnd: meeting?.timeEnd || '10:00',
    customerId: meeting?.customerId || '',
    customerType: meeting?.customerType || 'existing',
    contactPerson: meeting?.contactPerson || '',
    indAttendees: meeting?.indAttendees || [],
    location: meeting?.location || 'customer_site',
    locationDetail: meeting?.locationDetail || '',
    reason: meeting?.reason || 'relationship',
    meetingNotes: meeting?.meetingNotes || '',
    outcome: meeting?.outcome || 'followup_required',
    nextAction: meeting?.nextAction || '',
    nextFollowupDate: meeting?.nextFollowupDate || '',
  })

  const customerTypes = [
    { id: 'new', label: lang === 'th' ? '‡πÉ‡∏´‡∏°‡πà' : 'New' },
    { id: 'potential', label: lang === 'th' ? '‡∏™‡∏ô‡πÉ‡∏à' : 'Potential' },
    { id: 'existing', label: lang === 'th' ? '‡πÄ‡∏î‡∏¥‡∏°' : 'Existing' },
  ]

  const locations = [
    { id: 'customer_site', label: lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Site' },
    { id: 'ind', label: lang === 'th' ? 'IND' : 'IND Office' },
    { id: 'other', label: lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô' : 'Other' },
  ]

  const reasons = [
    { id: 'new_business', label: lang === 'th' ? '‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà' : 'New Business' },
    { id: 'quotation_followup', label: lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotation Follow-up' },
    { id: 'complaint', label: lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Complaint Resolution' },
    { id: 'relationship', label: lang === 'th' ? '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå' : 'Relationship' },
    { id: 'price_negotiation', label: lang === 'th' ? '‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price Negotiation' },
    { id: 'technical', label: lang === 'th' ? '‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ' : 'Technical Discussion' },
    { id: 'other', label: lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other' },
  ]

  const outcomes = [
    { id: 'order_received', label: lang === 'th' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' : 'Order Received' },
    { id: 'quotation_requested', label: lang === 'th' ? '‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotation Requested' },
    { id: 'followup_required', label: lang === 'th' ? '‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠' : 'Follow-up Required' },
    { id: 'no_action', label: lang === 'th' ? '‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'No Action Needed' },
    { id: 'lost', label: lang === 'th' ? '‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡πÇ‡∏≠‡∏Å‡∏≤‡∏™' : 'Lost Opportunity' },
  ]

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'} *</label>
          <input type="date" required value={formData.date} onChange={(e) => setFormData({...formData, date: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°' : 'Start Time'}</label>
          <input type="time" value={formData.timeStart} onChange={(e) => setFormData({...formData, timeStart: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î' : 'End Time'}</label>
          <input type="time" value={formData.timeEnd} onChange={(e) => setFormData({...formData, timeEnd: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'} *</label>
          <select required value={formData.customerId} onChange={(e) => setFormData({...formData, customerId: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
            {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Type'}</label>
          <select value={formData.customerType} onChange={(e) => setFormData({...formData, customerType: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {customerTypes.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' : 'Contact Person'}</label>
          <input type="text" value={formData.contactPerson} onChange={(e) => setFormData({...formData, contactPerson: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà' : 'Location'}</label>
          <select value={formData.location} onChange={(e) => setFormData({...formData, location: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {locations.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏ö' : 'Meeting Reason'}</label>
          <select value={formData.reason} onChange={(e) => setFormData({...formData, reason: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {reasons.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°' : 'Meeting Notes'} *</label>
        <textarea required value={formData.meetingNotes} onChange={(e) => setFormData({...formData, meetingNotes: e.target.value})} className="w-full px-3 py-2 border rounded-lg" rows="3" />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå' : 'Outcome'}</label>
          <select value={formData.outcome} onChange={(e) => setFormData({...formData, outcome: e.target.value})} className="w-full px-3 py-2 border rounded-lg">
            {outcomes.map(opt => <option key={opt.id} value={opt.id}>{opt.label}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°' : 'Follow-up Date'}</label>
          <input type="date" value={formData.nextFollowupDate} onChange={(e) => setFormData({...formData, nextFollowupDate: e.target.value})} className="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡πà‡∏≠' : 'Next Action'}</label>
        <input type="text" value={formData.nextAction} onChange={(e) => setFormData({...formData, nextAction: e.target.value})} className="w-full px-3 py-2 border rounded-lg" placeholder={lang === 'th' ? '‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'e.g., Send quotation'} />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="ghost" onClick={onCancel}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
        <Button type="submit" icon={Save}>{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}</Button>
      </div>
    </form>
  )
}

// ============================================
// QUOTATION FORM
// ============================================
const QuotationForm = ({ quotation, customers, products, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    customerId: quotation?.customerId || '',
    customerContact: quotation?.customerContact || '',
    customerCategory: quotation?.customerCategory || 'existing', // new, potential, existing
    quotationReason: quotation?.quotationReason || 'new_product', // new_product, price_change, new_customer, special_request
    quoteDate: quotation?.quoteDate || new Date().toISOString().split('T')[0],
    validUntil: quotation?.validUntil || (() => { const d = new Date(); d.setDate(d.getDate() + 30); return d.toISOString().split('T')[0] })(),
    items: quotation?.items || [{ id: 1, productName: '', description: '', qty: 0, unit: 'pcs', unitPrice: 0, total: 0 }],
    discount: quotation?.discount || 0,
    discountReason: quotation?.discountReason || '',
    paymentTerms: quotation?.paymentTerms || 'net30',
    deliveryTerms: quotation?.deliveryTerms || '',
    notes: quotation?.notes || '',
    entity: quotation?.entity || 'IND',
    preparedBy: quotation?.preparedBy || '',
  })

  const addItem = () => {
    setFormData(prev => ({
      ...prev,
      items: [...prev.items, { id: prev.items.length + 1, productName: '', description: '', qty: 0, unit: 'pcs', unitPrice: 0, total: 0 }]
    }))
  }

  const updateItem = (idx, field, value) => {
    setFormData(prev => ({
      ...prev,
      items: prev.items.map((item, i) => {
        if (i === idx) {
          const updated = { ...item, [field]: value }
          if (field === 'qty' || field === 'unitPrice') {
            updated.total = (updated.qty || 0) * (updated.unitPrice || 0)
          }
          return updated
        }
        return item
      })
    }))
  }

  const removeItem = (idx) => {
    if (formData.items.length > 1) {
      setFormData(prev => ({ ...prev, items: prev.items.filter((_, i) => i !== idx) }))
    }
  }

  const subtotal = formData.items.reduce((sum, item) => sum + (item.total || 0), 0)
  const vat = subtotal * 0.07
  const grandTotal = subtotal + vat - (formData.discount || 0)

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave({
      ...formData,
      subtotal,
      vatRate: 7,
      vat,
      grandTotal,
    })
  }

  // Helper to get customer category badge color
  const getCategoryBadge = (cat) => {
    switch(cat) {
      case 'new': return 'bg-green-100 text-green-800'
      case 'potential': return 'bg-yellow-100 text-yellow-800'
      case 'existing': return 'bg-blue-100 text-blue-800'
      default: return 'bg-gray-100'
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Customer Category & Reason - NEW SECTION */}
      <div className="p-3 bg-purple-50 rounded-lg border border-purple-200">
        <div className="text-sm font-medium text-purple-800 mb-2">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotation Type'}</div>
        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-xs font-medium text-gray-600 mb-1">
              {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer Category'}
            </label>
            <select 
              value={formData.customerCategory} 
              onChange={(e) => setFormData({ ...formData, customerCategory: e.target.value })} 
              className={`w-full px-3 py-2 border rounded-lg ${getCategoryBadge(formData.customerCategory)}`}
            >
              <option value="existing">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'Existing Customer'}</option>
              <option value="potential">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à' : 'Potential Customer'}</option>
              <option value="new">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Customer'}</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-medium text-gray-600 mb-1">
              {lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quotation Reason'}
            </label>
            <select 
              value={formData.quotationReason} 
              onChange={(e) => setFormData({ ...formData, quotationReason: e.target.value })} 
              className="w-full px-3 py-2 border rounded-lg"
            >
              <option value="new_product">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Product'}</option>
              <option value="price_change">{lang === 'th' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price Change'}</option>
              <option value="new_customer">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°' : 'New Customer Inquiry'}</option>
              <option value="special_request">{lang === 'th' ? '‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©' : 'Special Request'}</option>
            </select>
          </div>
        </div>
        <div className="mt-2 text-xs text-purple-600">
          {formData.quotationReason === 'new_product' && (lang === 'th' ? 'üí° ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà - ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö' : 'üí° New product - Product code will be created after customer accepts')}
          {formData.quotationReason === 'price_change' && (lang === 'th' ? 'üí° ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ - ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'üí° Price change - Email with reason required')}
          {formData.quotationReason === 'new_customer' && (lang === 'th' ? 'üí° ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà - ‡∏Ñ‡∏ß‡∏£‡∏ô‡∏±‡∏î‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' : 'üí° New customer - Schedule a meeting for discussion')}
          {formData.quotationReason === 'special_request' && (lang === 'th' ? 'üí° ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏© - ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'üí° Special request - Add details in notes')}
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ *' : 'Customer *'}</label>
          <select required value={formData.customerId} onChange={(e) => setFormData({ ...formData, customerId: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Select Customer'}</option>
            {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' : 'Contact Person'}</label>
          <input type="text" value={formData.customerContact} onChange={(e) => setFormData({ ...formData, customerContact: e.target.value })} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Entity'}</label>
          <select value={formData.entity} onChange={(e) => setFormData({ ...formData, entity: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
            <option value="IND">IND Thai Packwell</option>
            <option value="IND2">IND-2 Thai Packwell</option>
          </select>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Quote Date'}</label>
          <input type="date" value={formData.quoteDate} onChange={(e) => setFormData({ ...formData, quoteDate: e.target.value })} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á' : 'Valid Until'}</label>
          <input type="date" value={formData.validUntil} onChange={(e) => setFormData({ ...formData, validUntil: e.target.value })} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ä‡∏≥‡∏£‡∏∞' : 'Payment Terms'}</label>
          <select value={formData.paymentTerms} onChange={(e) => setFormData({ ...formData, paymentTerms: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
            {PAYMENT_TERMS.map(pt => <option key={pt.id} value={pt.id}>{pt.label}</option>)}
          </select>
        </div>
      </div>

      {/* Items */}
      <div>
        <div className="flex items-center justify-between mb-2">
          <label className="text-sm font-medium text-gray-700">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Items'}</label>
          <Button type="button" size="sm" variant="outline" icon={Plus} onClick={addItem}>{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' : 'Add Item'}</Button>
        </div>
        <div className="border rounded-lg overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
                <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'Description'}</th>
                <th className="px-3 py-2 text-center w-20">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : 'Qty'}</th>
                <th className="px-3 py-2 text-center w-20">{lang === 'th' ? '‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit'}</th>
                <th className="px-3 py-2 text-right w-28">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢' : 'Unit Price'}</th>
                <th className="px-3 py-2 text-right w-28">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
                <th className="px-3 py-2 w-10"></th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {formData.items.map((item, idx) => (
                <tr key={idx}>
                  <td className="px-2 py-1">
                    <input type="text" value={item.productName} onChange={(e) => updateItem(idx, 'productName', e.target.value)} className="w-full px-2 py-1 border rounded" placeholder="Product name" />
                  </td>
                  <td className="px-2 py-1">
                    <input type="text" value={item.description} onChange={(e) => updateItem(idx, 'description', e.target.value)} className="w-full px-2 py-1 border rounded" placeholder="Description" />
                  </td>
                  <td className="px-2 py-1">
                    <input type="number" value={item.qty} onChange={(e) => updateItem(idx, 'qty', parseFloat(e.target.value) || 0)} className="w-full px-2 py-1 border rounded text-center" />
                  </td>
                  <td className="px-2 py-1">
                    <input type="text" value={item.unit} onChange={(e) => updateItem(idx, 'unit', e.target.value)} className="w-full px-2 py-1 border rounded text-center" />
                  </td>
                  <td className="px-2 py-1">
                    <input type="number" value={item.unitPrice} onChange={(e) => updateItem(idx, 'unitPrice', parseFloat(e.target.value) || 0)} className="w-full px-2 py-1 border rounded text-right" />
                  </td>
                  <td className="px-2 py-1 text-right font-medium">{formatCurrency(item.total || 0)}</td>
                  <td className="px-2 py-1">
                    <button type="button" onClick={() => removeItem(idx)} className="text-red-500 hover:text-red-700"><Trash2 className="w-4 h-4" /></button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Totals */}
      <div className="flex justify-end">
        <div className="w-80 space-y-2">
          <div className="flex justify-between"><span>{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Subtotal'}:</span><span>{formatCurrency(subtotal)}</span></div>
          
          {/* Discount with CEO Approval Workflow */}
          <div className="p-3 border rounded-lg bg-orange-50 border-orange-200">
            <div className="flex justify-between items-center mb-2">
              <span className="font-medium text-orange-800">{lang === 'th' ? '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î' : 'Discount'}:</span>
              <input 
                type="number" 
                value={formData.discount} 
                onChange={(e) => setFormData({ ...formData, discount: parseFloat(e.target.value) || 0, discountApproved: false })} 
                className="w-24 px-2 py-1 border rounded text-right" 
              />
            </div>
            
            {formData.discount > 0 && (
              <>
                {/* Warning */}
                <div className="flex items-center gap-2 text-red-600 text-sm mb-2">
                  <AlertTriangle className="w-4 h-4" />
                  <span>{lang === 'th' ? '‚ö†Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å CEO' : '‚ö†Ô∏è ALL discounts require CEO approval'}</span>
                </div>
                
                {/* Discount Reason */}
                <div className="mb-2">
                  <label className="block text-xs font-medium text-gray-600 mb-1">
                    {lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î *' : 'Reason for Discount *'}
                  </label>
                  <select 
                    value={formData.discountReason} 
                    onChange={(e) => setFormData({ ...formData, discountReason: e.target.value })}
                    className="w-full px-2 py-1 border rounded text-sm"
                    required
                  >
                    <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Select reason'}</option>
                    <option value="volume">{lang === 'th' ? '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å' : 'Volume order'}</option>
                    <option value="long_term">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß' : 'Long-term customer'}</option>
                    <option value="competitive">{lang === 'th' ? '‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏Ç‡πà‡∏á' : 'Competitive pricing'}</option>
                    <option value="negotiation">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏à‡∏≤' : 'Negotiation'}</option>
                    <option value="promotion">{lang === 'th' ? '‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô' : 'Promotion'}</option>
                    <option value="other">{lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other'}</option>
                  </select>
                </div>
                
                {/* CEO Approval Checkbox */}
                <div className="flex items-center gap-2 p-2 bg-white rounded border">
                  <input 
                    type="checkbox" 
                    id="discountApproved"
                    checked={formData.discountApproved || false}
                    onChange={(e) => setFormData({ ...formData, discountApproved: e.target.checked, discountApprovedBy: e.target.checked ? 'CEO' : '', discountApprovedDate: e.target.checked ? new Date().toISOString().split('T')[0] : '' })}
                    className="w-4 h-4"
                  />
                  <label htmlFor="discountApproved" className="text-sm font-medium">
                    {lang === 'th' ? '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å CEO ‡πÅ‡∏•‡πâ‡∏ß' : 'Approved by CEO'}
                  </label>
                  {formData.discountApproved && (
                    <span className="ml-auto text-green-600 text-sm">‚úì {formData.discountApprovedDate}</span>
                  )}
                </div>
                
                {/* Approval Status Badge */}
                <div className="mt-2 text-center">
                  <Badge variant={formData.discountApproved ? 'success' : 'danger'}>
                    {formData.discountApproved 
                      ? (lang === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : 'APPROVED') 
                      : (lang === 'th' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'PENDING APPROVAL')}
                  </Badge>
                </div>
              </>
            )}
          </div>
          
          <div className="flex justify-between"><span>VAT 7%:</span><span>{formatCurrency(vat)}</span></div>
          <div className="flex justify-between font-bold text-lg border-t pt-2"><span>{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô' : 'Grand Total'}:</span><span>{formatCurrency(grandTotal)}</span></div>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes'}</label>
        <textarea value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} className="w-full px-3 py-2 border rounded-lg" rows="2" />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="ghost" onClick={onCancel}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
        <Button 
          type="submit" 
          icon={Save}
          disabled={formData.discount > 0 && !formData.discountApproved}
        >
          {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}
        </Button>
        {formData.discount > 0 && !formData.discountApproved && (
          <span className="text-sm text-red-500 self-center">
            {lang === 'th' ? '‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô' : 'Discount approval required'}
          </span>
        )}
      </div>
    </form>
  )
}

// ============================================
// DELIVERY ORDER FORM
// ============================================
const DeliveryOrderForm = ({ so, customers, trucks, employees, onSave, onCancel, lang }) => {
  const customer = customers.find(c => c.id === so.customerId)
  const drivers = employees?.filter(e => e.department === 'transport') || []
  
  const [formData, setFormData] = useState({
    soId: so.id,
    customerId: so.customerId,
    deliveryDate: new Date().toISOString().split('T')[0],
    scheduledTime: '09:00',
    truckId: '',
    driverId: '',
    deliveryAddress: customer?.deliveryAddress || '',
    items: so.pendingItems?.map(item => ({
      ...item,
      deliverQty: item.qty - (item.qtyDelivered || 0),
    })) || so.items?.filter(item => (item.qty - (item.qtyDelivered || 0)) > 0).map(item => ({
      ...item,
      deliverQty: item.qty - (item.qtyDelivered || 0),
    })) || [],
    notes: '',
    entity: so.entity,
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave({
      ...formData,
      items: formData.items.filter(item => item.deliverQty > 0).map(item => ({
        productName: item.productName,
        qty: item.deliverQty,
        unit: item.unit || 'pcs',
      })),
    })
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="p-3 bg-blue-50 rounded-lg">
        <div className="text-sm text-blue-600">{lang === 'th' ? '‡∏à‡∏≤‡∏Å SO' : 'From SO'}: <span className="font-mono font-bold">{so.id}</span></div>
        <div className="text-lg font-bold">{customer?.name}</div>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á' : 'Delivery Date'}</label>
          <input type="date" value={formData.deliveryDate} onChange={(e) => setFormData({ ...formData, deliveryDate: e.target.value })} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏ß‡∏•‡∏≤' : 'Time'}</label>
          <input type="time" value={formData.scheduledTime} onChange={(e) => setFormData({ ...formData, scheduledTime: e.target.value })} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏£‡∏ñ' : 'Truck'}</label>
          <select value={formData.truckId} onChange={(e) => setFormData({ ...formData, truckId: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ' : 'Select Truck'}</option>
            {trucks?.map(t => <option key={t.id} value={t.id}>{t.code} - {t.nameEn}</option>)}
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á' : 'Delivery Address'}</label>
        <textarea value={formData.deliveryAddress} onChange={(e) => setFormData({ ...formData, deliveryAddress: e.target.value })} className="w-full px-3 py-2 border rounded-lg" rows="2" />
      </div>

      {/* Items to deliver */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á' : 'Items to Deliver'}</label>
        <div className="border rounded-lg overflow-hidden">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
                <th className="px-3 py-2 text-center">{lang === 'th' ? '‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Ordered'}</th>
                <th className="px-3 py-2 text-center">{lang === 'th' ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : 'Delivered'}</th>
                <th className="px-3 py-2 text-center">{lang === 'th' ? '‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ' : 'This Delivery'}</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {formData.items.map((item, idx) => (
                <tr key={idx}>
                  <td className="px-3 py-2">{item.productName}</td>
                  <td className="px-3 py-2 text-center">{item.qty}</td>
                  <td className="px-3 py-2 text-center text-green-600">{item.qtyDelivered || 0}</td>
                  <td className="px-3 py-2 text-center">
                    <input 
                      type="number" 
                      value={item.deliverQty} 
                      onChange={(e) => {
                        const maxQty = item.qty - (item.qtyDelivered || 0)
                        const newQty = Math.min(Math.max(0, parseFloat(e.target.value) || 0), maxQty)
                        setFormData(prev => ({
                          ...prev,
                          items: prev.items.map((it, i) => i === idx ? { ...it, deliverQty: newQty } : it)
                        }))
                      }}
                      max={item.qty - (item.qtyDelivered || 0)}
                      className="w-20 px-2 py-1 border rounded text-center"
                    />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="ghost" onClick={onCancel}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
        <Button type="submit" icon={Truck}>{lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Create DO'}</Button>
      </div>
    </form>
  )
}

// ============================================
// PAYMENT FORM
// ============================================
const PaymentForm = ({ invoice, customer, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    amount: invoice.balance,
    method: 'transfer',
    reference: '',
    notes: '',
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    if (formData.amount <= 0) {
      alert(lang === 'th' ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : 'Please enter amount')
      return
    }
    if (formData.amount > invoice.balance) {
      alert(lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : 'Amount exceeds balance')
      return
    }
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="p-4 bg-gray-50 rounded-lg">
        <div className="flex justify-between mb-2">
          <span className="text-gray-600">{lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Invoice'}:</span>
          <span className="font-mono font-bold">{invoice.id}</span>
        </div>
        <div className="flex justify-between mb-2">
          <span className="text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}:</span>
          <span className="font-bold">{customer?.name}</span>
        </div>
        <div className="flex justify-between mb-2">
          <span className="text-gray-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'Total'}:</span>
          <span>{formatCurrency(invoice.grandTotal)}</span>
        </div>
        <div className="flex justify-between mb-2">
          <span className="text-gray-600">{lang === 'th' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : 'Paid'}:</span>
          <span className="text-green-600">{formatCurrency(invoice.paidAmount || 0)}</span>
        </div>
        <div className="flex justify-between font-bold text-lg border-t pt-2">
          <span className="text-red-600">{lang === 'th' ? '‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á' : 'Balance'}:</span>
          <span className="text-red-600">{formatCurrency(invoice.balance)}</span>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞' : 'Payment Date'}</label>
          <input type="date" value={formData.date} onChange={(e) => setFormData({ ...formData, date: e.target.value })} className="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞' : 'Method'}</label>
          <select value={formData.method} onChange={(e) => setFormData({ ...formData, method: e.target.value })} className="w-full px-3 py-2 border rounded-lg">
            <option value="transfer">{lang === 'th' ? '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : 'Bank Transfer'}</option>
            <option value="cheque">{lang === 'th' ? '‡πÄ‡∏ä‡πá‡∏Ñ' : 'Cheque'}</option>
            <option value="cash">{lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'Cash'}</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' : 'Amount'} *</label>
        <input 
          type="number" 
          value={formData.amount} 
          onChange={(e) => setFormData({ ...formData, amount: parseFloat(e.target.value) || 0 })}
          max={invoice.balance}
          className="w-full px-3 py-2 border rounded-lg text-xl font-bold text-right"
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á' : 'Reference'}</label>
        <input type="text" value={formData.reference} onChange={(e) => setFormData({ ...formData, reference: e.target.value })} className="w-full px-3 py-2 border rounded-lg" placeholder="e.g., TRF-2601-001" />
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{lang === 'th' ? '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' : 'Notes'}</label>
        <textarea value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} className="w-full px-3 py-2 border rounded-lg" rows="2" />
      </div>

      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="ghost" onClick={onCancel}>{lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}</Button>
        <Button type="submit" variant="success" icon={CreditCard}>{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞' : 'Record Payment'}</Button>
      </div>
    </form>
  )
}

// ============================================
// PRINT VIEW - TAX INVOICE (LOCAL)
// ============================================
const InvoicePrintView = ({ invoice, customer, entity, onClose }) => {
  const companyInfo = COMPANY_ENTITIES.find(e => e.id === entity) || COMPANY_ENTITIES[0]
  
  const handlePrint = () => {
    window.print()
  }

  return (
    <div className="bg-white">
      {/* Print Controls - Hidden when printing */}
      <div className="print:hidden p-4 bg-gray-100 flex justify-between items-center mb-4">
        <h2 className="font-bold text-lg">Print Preview - Tax Invoice</h2>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Invoice Content */}
      <div className="p-8 max-w-4xl mx-auto print:p-0 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        {/* Header */}
        <div className="border-2 border-black">
          {/* Company Header */}
          <div className="flex justify-between items-start p-4 border-b-2 border-black">
            <div className="flex items-center gap-4">
              <img src={IND_LOGO_SVG} alt="IND Logo" className="w-16 h-16" />
              <div>
                <div className="font-bold text-lg">{companyInfo.name}</div>
                <div className="text-sm">{companyInfo.nameTh}</div>
                <div className="text-xs text-gray-600">{companyInfo.address}</div>
                <div className="text-xs text-gray-600">Tax ID: {companyInfo.taxId}</div>
                <div className="text-xs text-gray-600">Tel: {companyInfo.tel}</div>
              </div>
            </div>
            <div className="text-right">
              <div className="text-xl font-bold border-2 border-black px-4 py-2 mb-2">
                TAX INVOICE / ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
              </div>
              <div className="font-mono text-lg font-bold text-red-600">{invoice.id}</div>
            </div>
          </div>

          {/* Customer & Invoice Info */}
          <div className="grid grid-cols-2 border-b border-black">
            <div className="p-4 border-r border-black">
              <div className="font-bold mb-2">Bill To / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</div>
              <div className="font-medium">{customer?.name}</div>
              <div className="text-sm">{customer?.nameTh}</div>
              <div className="text-xs text-gray-600">{customer?.deliveryAddress}</div>
              <div className="text-xs text-gray-600">Tax ID: {customer?.taxId || '-'}</div>
            </div>
            <div className="p-4 text-sm">
              <div className="grid grid-cols-2 gap-1">
                <span>Invoice Date:</span><span className="font-medium">{formatDate(invoice.invoiceDate)}</span>
                <span>Due Date:</span><span className="font-medium text-red-600">{formatDate(invoice.dueDate)}</span>
                <span>Customer PO:</span><span className="font-mono">{invoice.customerPO || '-'}</span>
                <span>SO Ref:</span><span className="font-mono">{invoice.soId || '-'}</span>
                <span>DO Ref:</span><span className="font-mono">{invoice.doId || '-'}</span>
                <span>Payment Terms:</span><span>{customer?.paymentTerms || 30} days</span>
              </div>
            </div>
          </div>

          {/* Items Table */}
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-gray-100 border-b border-black">
                <th className="px-2 py-2 text-center border-r border-black w-12">No.</th>
                <th className="px-2 py-2 text-left border-r border-black">Description / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Qty</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Unit</th>
                <th className="px-2 py-2 text-right border-r border-black w-24">Unit Price</th>
                <th className="px-2 py-2 text-right w-28">Amount</th>
              </tr>
            </thead>
            <tbody>
              {invoice.items?.map((item, idx) => (
                <tr key={idx} className="border-b border-gray-300">
                  <td className="px-2 py-2 text-center border-r border-gray-300">{idx + 1}</td>
                  <td className="px-2 py-2 border-r border-gray-300">{item.description || item.productName}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.qty}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.unit || 'pcs'}</td>
                  <td className="px-2 py-2 text-right border-r border-gray-300">{formatCurrency(item.unitPrice)}</td>
                  <td className="px-2 py-2 text-right">{formatCurrency(item.qty * item.unitPrice)}</td>
                </tr>
              ))}
              {/* Empty rows for minimum 5 */}
              {Array.from({ length: Math.max(0, 5 - (invoice.items?.length || 0)) }).map((_, idx) => (
                <tr key={`empty-${idx}`} className="border-b border-gray-300">
                  <td className="px-2 py-4 border-r border-gray-300">&nbsp;</td>
                  <td className="px-2 py-4 border-r border-gray-300"></td>
                  <td className="px-2 py-4 border-r border-gray-300"></td>
                  <td className="px-2 py-4 border-r border-gray-300"></td>
                  <td className="px-2 py-4 border-r border-gray-300"></td>
                  <td className="px-2 py-4"></td>
                </tr>
              ))}
            </tbody>
          </table>

          {/* Totals */}
          <div className="grid grid-cols-2 border-t border-black">
            <div className="p-4 border-r border-black">
              <div className="text-xs mb-2">Amount in words / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£:</div>
              <div className="font-medium text-sm italic">
                {invoice.grandTotal?.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
              </div>
            </div>
            <div className="p-2 text-sm">
              <div className="flex justify-between py-1"><span>Subtotal / ‡∏£‡∏ß‡∏°:</span><span>{formatCurrency(invoice.subtotal)}</span></div>
              {invoice.discount > 0 && <div className="flex justify-between py-1"><span>Discount / ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span><span>-{formatCurrency(invoice.discount)}</span></div>}
              <div className="flex justify-between py-1"><span>VAT 7% / ‡∏†‡∏≤‡∏©‡∏µ:</span><span>{formatCurrency(invoice.vat)}</span></div>
              <div className="flex justify-between py-2 text-lg font-bold border-t border-black mt-2">
                <span>TOTAL / ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                <span className="text-red-600">{formatCurrency(invoice.grandTotal)}</span>
              </div>
            </div>
          </div>

          {/* Signatures */}
          <div className="grid grid-cols-3 border-t border-black text-center text-sm">
            <div className="p-4 border-r border-black">
              <div className="mb-8">Received by / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
              <div className="border-t border-black pt-2">Date / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____________</div>
            </div>
            <div className="p-4 border-r border-black">
              <div className="mb-8">Checked by / ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</div>
              <div className="border-t border-black pt-2">Date / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____________</div>
            </div>
            <div className="p-4">
              <div className="mb-8">Authorized / ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
              <div className="border-t border-black pt-2">Date / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: _____________</div>
            </div>
          </div>

          {/* Footer */}
          <div className="p-2 border-t border-black text-center text-xs text-gray-500">
            This document is computer generated. / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PRINT VIEW - EXPORT INVOICE WITH PACKING LIST (NO VAT)
// ============================================
const ExportInvoicePrintView = ({ invoice, customer, entity, packingList, onClose }) => {
  const companyInfo = COMPANY_ENTITIES.find(e => e.id === entity) || COMPANY_ENTITIES[0]
  
  const handlePrint = () => {
    window.print()
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-gray-100 flex justify-between items-center mb-4">
        <h2 className="font-bold text-lg">Print Preview - Commercial Invoice + Packing List</h2>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Commercial Invoice */}
      <div className="p-8 max-w-4xl mx-auto print:p-0 print:max-w-none mb-8" style={{ fontFamily: 'Arial, sans-serif' }}>
        <div className="border-2 border-black">
          {/* Header */}
          <div className="flex justify-between items-start p-4 border-b-2 border-black">
            <div className="flex items-center gap-4">
              <img src={IND_LOGO_SVG} alt="IND Logo" className="w-16 h-16" />
              <div>
                <div className="font-bold text-lg">{companyInfo.name}</div>
                <div className="text-xs text-gray-600">{companyInfo.address}</div>
                <div className="text-xs text-gray-600">Tax ID: {companyInfo.taxId}</div>
              </div>
            </div>
            <div className="text-right">
              <div className="text-xl font-bold border-2 border-black px-4 py-2 mb-2">
                COMMERCIAL INVOICE
              </div>
              <div className="font-mono text-lg font-bold text-blue-600">{invoice.id}</div>
              <div className="text-xs text-gray-500">EXPORT - NO VAT</div>
            </div>
          </div>

          {/* Buyer Info */}
          <div className="grid grid-cols-2 border-b border-black">
            <div className="p-4 border-r border-black">
              <div className="font-bold mb-2">Consignee / Buyer:</div>
              <div className="font-medium">{customer?.name}</div>
              <div className="text-sm text-gray-600">{customer?.deliveryAddress}</div>
              <div className="text-xs text-gray-600">Contact: {customer?.contact}</div>
            </div>
            <div className="p-4 text-sm">
              <div className="grid grid-cols-2 gap-1">
                <span>Invoice No:</span><span className="font-mono font-bold">{invoice.id}</span>
                <span>Date:</span><span>{formatDate(invoice.invoiceDate)}</span>
                <span>Customer PO:</span><span className="font-mono">{invoice.customerPO || '-'}</span>
                <span>Payment Terms:</span><span>{customer?.paymentTerms || 30} days</span>
                <span>Incoterms:</span><span>FOB Thailand</span>
              </div>
            </div>
          </div>

          {/* Items Table */}
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-gray-100 border-b border-black">
                <th className="px-2 py-2 text-center border-r border-black w-12">No.</th>
                <th className="px-2 py-2 text-left border-r border-black">Description of Goods</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Qty</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Unit</th>
                <th className="px-2 py-2 text-right border-r border-black w-24">Unit Price</th>
                <th className="px-2 py-2 text-right w-28">Amount (THB)</th>
              </tr>
            </thead>
            <tbody>
              {invoice.items?.map((item, idx) => (
                <tr key={idx} className="border-b border-gray-300">
                  <td className="px-2 py-2 text-center border-r border-gray-300">{idx + 1}</td>
                  <td className="px-2 py-2 border-r border-gray-300">{item.description || item.productName}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.qty}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.unit || 'pcs'}</td>
                  <td className="px-2 py-2 text-right border-r border-gray-300">{formatCurrency(item.unitPrice)}</td>
                  <td className="px-2 py-2 text-right">{formatCurrency(item.qty * item.unitPrice)}</td>
                </tr>
              ))}
            </tbody>
          </table>

          {/* Totals - NO VAT */}
          <div className="grid grid-cols-2 border-t border-black">
            <div className="p-4 border-r border-black">
              <div className="text-xs mb-2">Country of Origin: Thailand</div>
              <div className="text-xs">HS Code: 4415.20</div>
            </div>
            <div className="p-2 text-sm">
              <div className="flex justify-between py-1"><span>Subtotal:</span><span>{formatCurrency(invoice.subtotal)}</span></div>
              <div className="flex justify-between py-1 text-gray-500"><span>VAT:</span><span>EXEMPT (Export)</span></div>
              <div className="flex justify-between py-2 text-lg font-bold border-t border-black mt-2">
                <span>TOTAL:</span>
                <span className="text-blue-600">{formatCurrency(invoice.subtotal)}</span>
              </div>
            </div>
          </div>

          {/* Declaration */}
          <div className="p-4 border-t border-black text-xs">
            <p>We hereby certify that the goods described above are of Thailand origin and were manufactured by IND Thai Packwell Industries Co., Ltd.</p>
            <div className="mt-4 flex justify-end">
              <div className="text-center">
                <div className="mb-8">Authorized Signature</div>
                <div className="border-t border-black pt-2 w-48">For {companyInfo.name}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Packing List - Page Break */}
      <div className="print:break-before-page p-8 max-w-4xl mx-auto print:p-0 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        <div className="border-2 border-black">
          <div className="flex justify-between items-start p-4 border-b-2 border-black">
            <div className="flex items-center gap-4">
              <img src={IND_LOGO_SVG} alt="IND Logo" className="w-16 h-16" />
              <div>
                <div className="font-bold text-lg">{companyInfo.name}</div>
                <div className="text-xs text-gray-600">{companyInfo.address}</div>
              </div>
            </div>
            <div className="text-right">
              <div className="text-xl font-bold border-2 border-black px-4 py-2 mb-2">
                PACKING LIST
              </div>
              <div className="font-mono text-sm">Ref: {invoice.id}</div>
            </div>
          </div>

          {/* Packing Details */}
          <div className="p-4 border-b border-black">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="font-bold">Consignee:</div>
                <div>{customer?.name}</div>
                <div className="text-sm text-gray-600">{customer?.deliveryAddress}</div>
              </div>
              <div className="text-sm">
                <div><span className="font-medium">Date:</span> {formatDate(invoice.invoiceDate)}</div>
                <div><span className="font-medium">Invoice No:</span> {invoice.id}</div>
                <div><span className="font-medium">PO No:</span> {invoice.customerPO || '-'}</div>
              </div>
            </div>
          </div>

          {/* Packing Table */}
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-gray-100 border-b border-black">
                <th className="px-2 py-2 text-center border-r border-black w-16">Carton No.</th>
                <th className="px-2 py-2 text-left border-r border-black">Description</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Qty/Ctn</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Total Qty</th>
                <th className="px-2 py-2 text-center border-r border-black w-24">Gross Wt (kg)</th>
                <th className="px-2 py-2 text-center w-24">Net Wt (kg)</th>
              </tr>
            </thead>
            <tbody>
              {invoice.items?.map((item, idx) => (
                <tr key={idx} className="border-b border-gray-300">
                  <td className="px-2 py-2 text-center border-r border-gray-300">{idx + 1}</td>
                  <td className="px-2 py-2 border-r border-gray-300">{item.description || item.productName}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.qty}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.qty}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{(item.qty * 15).toFixed(1)}</td>
                  <td className="px-2 py-2 text-center">{(item.qty * 12).toFixed(1)}</td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr className="bg-gray-100 font-bold">
                <td colSpan="3" className="px-2 py-2 text-right border-r border-black">TOTAL:</td>
                <td className="px-2 py-2 text-center border-r border-black">{invoice.items?.reduce((sum, i) => sum + i.qty, 0)}</td>
                <td className="px-2 py-2 text-center border-r border-black">{(invoice.items?.reduce((sum, i) => sum + i.qty, 0) * 15).toFixed(1)}</td>
                <td className="px-2 py-2 text-center">{(invoice.items?.reduce((sum, i) => sum + i.qty, 0) * 12).toFixed(1)}</td>
              </tr>
            </tfoot>
          </table>

          {/* Footer */}
          <div className="p-4 border-t border-black">
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <div><span className="font-medium">Total Packages:</span> {invoice.items?.length || 0}</div>
                <div><span className="font-medium">Total Gross Weight:</span> {(invoice.items?.reduce((sum, i) => sum + i.qty, 0) * 15).toFixed(1)} kg</div>
                <div><span className="font-medium">Total Net Weight:</span> {(invoice.items?.reduce((sum, i) => sum + i.qty, 0) * 12).toFixed(1)} kg</div>
              </div>
              <div className="text-right">
                <div className="mb-8 mt-4">Packed by: _____________</div>
                <div>Date: _____________</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PRINT VIEW - HEAT TREATMENT CERTIFICATE (ISPM15)
// ============================================
const HeatTreatmentCertPrintView = ({ certificate, customer, items, onClose }) => {
  const handlePrint = () => {
    window.print()
  }

  // Generate certificate number: YYMMDD + sequence
  const certNo = certificate?.certNo || (() => {
    const d = new Date()
    return `${d.getFullYear().toString().slice(-2)}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`
  })()

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-gray-100 flex justify-between items-center mb-4">
        <h2 className="font-bold text-lg">Print Preview - Heat Treatment Certificate (ISPM15)</h2>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Certificate Content */}
      <div className="p-8 max-w-3xl mx-auto print:p-0 print:max-w-none" style={{ fontFamily: 'Times New Roman, serif' }}>
        <div className="border border-black p-8">
          {/* Company Header */}
          <div className="text-center mb-6">
            <div className="font-bold text-xl">IND THAI PACKWELL INDUSTRIES CO., LTD</div>
            <div className="text-lg">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏µ ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡πá‡∏Ñ‡πÄ‡∏ß‡∏• ‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° ‡∏à‡∏≥‡∏Å‡∏±‡∏î</div>
            <div className="text-sm mt-2">399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270 ‡πÇ‡∏ó‡∏£ 038-119430</div>
            <div className="text-sm">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ : 0-2055-56010-51-8 (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà)</div>
          </div>

          <hr className="border-black mb-6" />

          {/* Certificate Title */}
          <div className="text-center mb-8">
            <div className="font-bold text-xl underline">CERTIFICATE OF HEAT TREATMENT</div>
          </div>

          {/* Certificate Details */}
          <div className="flex justify-between mb-8">
            <div>
              <span className="font-bold">Certificate No. : </span>
              <span className="text-lg">{certNo}</span>
            </div>
            <div>
              <span className="font-bold">DATE : </span>
              <span>{formatDate(certificate?.date || new Date())}</span>
            </div>
          </div>

          {/* Body Text */}
          <div className="mb-8 text-justify leading-relaxed">
            <p className="mb-4">
              This is to certify that the wooden pallets described below have been treated by Heat Treatment 
              to a minimum internal wood core temperature of <span className="font-bold">56¬∞C for 30 minutes</span> in a controlled environment 
              industrial drying chamber. The process is met the standard set by <span className="font-bold">ISPM15</span>
            </p>
            <p className="mb-4">
              <span className="font-bold">IND thai packwell industries co.,ltd.</span> is an official <span className="font-bold">ISPM15 certified body TH-0950</span>
            </p>
            <p>
              Authorized by the <span className="font-bold">Department of Agriculture, Ministry of Agriculture, Thailand.</span>
            </p>
          </div>

          {/* Products Table */}
          <div className="mb-8">
            <div className="font-bold mb-2">Number and Description of Packages :</div>
            <div className="ml-8">
              {items?.map((item, idx) => (
                <div key={idx} className="mb-1">
                  : {item.partNo || item.productName} {item.description} = {item.qty} Pcs.
                </div>
              )) || (
                <>
                  <div>: 70653302 PALLET,T30 TUMBLER V7 = 20 Pcs.</div>
                  <div>: 70659301 PALLET,WOOD 30 HEAT TREAT = 10 Pcs.</div>
                  <div>: F8314501 PALLET,WOOD(C60) V7 = 20 Pcs.</div>
                </>
              )}
            </div>
          </div>

          {/* Treatment Details */}
          <div className="mb-8 space-y-2">
            <div>
              <span className="font-bold">Date of Heat Treatment</span>
              <span className="ml-8">: {formatDate(certificate?.treatmentDate || new Date())}</span>
            </div>
            <div>
              <span className="font-bold">Location</span>
              <span className="ml-8">: WAREHOUSE OF IND THAI PACKWELL INDUSTRIES CO.,LTD.</span>
            </div>
            <div>
              <span className="font-bold">Name and address of Shipper</span>
              <span className="ml-8">: <span className="font-bold italic">{customer?.name || 'Customer Name'}</span></span>
            </div>
          </div>

          {/* Stamps and Signatures */}
          <div className="flex justify-between items-end mt-12">
            {/* ISPM15 Stamp */}
            <div className="text-center">
              <div className="border-2 border-black p-4 inline-block">
                <div className="flex items-center gap-2">
                  <div className="text-3xl">üåæ</div>
                  <div>
                    <div className="font-bold">TH - 0950</div>
                    <div className="font-bold">HT</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Company Stamp (Placeholder) */}
            <div className="text-center">
              <div className="w-32 h-32 border-2 border-gray-300 rounded-full flex items-center justify-center text-gray-400">
                <div className="text-center text-xs">
                  <div>Company</div>
                  <div>Stamp</div>
                </div>
              </div>
            </div>
          </div>

          {/* Signature Line */}
          <div className="text-center mt-8">
            <div className="border-t border-black w-48 mx-auto pt-2">
              AUTHORIZED CERTIFICATE
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PRINT VIEW - DELIVERY ORDER
// ============================================
const DeliveryOrderPrintView = ({ deliveryOrder, customer, truck, driver, entity, onClose }) => {
  const companyInfo = COMPANY_ENTITIES.find(e => e.id === entity) || COMPANY_ENTITIES[0]
  
  const handlePrint = () => {
    window.print()
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-gray-100 flex justify-between items-center mb-4">
        <h2 className="font-bold text-lg">Print Preview - Delivery Order</h2>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* DO Content */}
      <div className="p-8 max-w-4xl mx-auto print:p-0 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        <div className="border-2 border-black">
          {/* Header */}
          <div className="flex justify-between items-start p-4 border-b-2 border-black">
            <div className="flex items-center gap-4">
              <img src={IND_LOGO_SVG} alt="IND Logo" className="w-16 h-16" />
              <div>
                <div className="font-bold text-lg">{companyInfo.name}</div>
                <div className="text-xs text-gray-600">{companyInfo.address}</div>
                <div className="text-xs text-gray-600">Tel: {companyInfo.tel}</div>
              </div>
            </div>
            <div className="text-right">
              <div className="text-xl font-bold border-2 border-black px-4 py-2 mb-2">
                DELIVERY ORDER / ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
              </div>
              <div className="font-mono text-lg font-bold text-green-600">{deliveryOrder.id}</div>
            </div>
          </div>

          {/* Customer & Delivery Info */}
          <div className="grid grid-cols-2 border-b border-black">
            <div className="p-4 border-r border-black">
              <div className="font-bold mb-2">Deliver To / ‡∏™‡πà‡∏á‡∏ñ‡∏∂‡∏á:</div>
              <div className="font-medium">{customer?.name}</div>
              <div className="text-sm text-gray-600">{deliveryOrder.deliveryAddress || customer?.deliveryAddress}</div>
              <div className="text-xs text-gray-600">Contact: {customer?.contact}</div>
            </div>
            <div className="p-4 text-sm">
              <div className="grid grid-cols-2 gap-1">
                <span>Delivery Date:</span><span className="font-medium">{formatDate(deliveryOrder.deliveryDate)}</span>
                <span>Time:</span><span>{deliveryOrder.scheduledTime || '-'}</span>
                <span>SO Ref:</span><span className="font-mono">{deliveryOrder.soId}</span>
                <span>Invoice:</span><span className="font-mono">{deliveryOrder.invoiceId || 'Pending'}</span>
                <span>Truck:</span><span>{truck?.code || deliveryOrder.truckId}</span>
                <span>Driver:</span><span>{driver?.name || 'TBD'}</span>
              </div>
            </div>
          </div>

          {/* Items Table */}
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-gray-100 border-b border-black">
                <th className="px-2 py-2 text-center border-r border-black w-12">No.</th>
                <th className="px-2 py-2 text-left border-r border-black">Description / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th className="px-2 py-2 text-center border-r border-black w-20">Qty</th>
                <th className="px-2 py-2 text-center w-16">Unit</th>
              </tr>
            </thead>
            <tbody>
              {deliveryOrder.items?.map((item, idx) => (
                <tr key={idx} className="border-b border-gray-300">
                  <td className="px-2 py-3 text-center border-r border-gray-300">{idx + 1}</td>
                  <td className="px-2 py-3 border-r border-gray-300">{item.productName || item.description}</td>
                  <td className="px-2 py-3 text-center border-r border-gray-300 font-bold">{item.qty}</td>
                  <td className="px-2 py-3 text-center">{item.unit || 'pcs'}</td>
                </tr>
              ))}
              {/* Empty rows */}
              {Array.from({ length: Math.max(0, 5 - (deliveryOrder.items?.length || 0)) }).map((_, idx) => (
                <tr key={`empty-${idx}`} className="border-b border-gray-300">
                  <td className="px-2 py-4 border-r border-gray-300">&nbsp;</td>
                  <td className="px-2 py-4 border-r border-gray-300"></td>
                  <td className="px-2 py-4 border-r border-gray-300"></td>
                  <td className="px-2 py-4"></td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr className="bg-gray-100 font-bold">
                <td colSpan="2" className="px-2 py-2 text-right border-r border-black">TOTAL / ‡∏£‡∏ß‡∏°:</td>
                <td className="px-2 py-2 text-center border-r border-black">{deliveryOrder.items?.reduce((sum, i) => sum + i.qty, 0)}</td>
                <td className="px-2 py-2 text-center">pcs</td>
              </tr>
            </tfoot>
          </table>

          {/* Notes */}
          {deliveryOrder.notes && (
            <div className="p-4 border-t border-black">
              <span className="font-bold">Notes / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: </span>
              <span>{deliveryOrder.notes}</span>
            </div>
          )}

          {/* Signatures */}
          <div className="grid grid-cols-4 border-t border-black text-center text-sm">
            <div className="p-4 border-r border-black">
              <div className="mb-8">Prepared by / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
              <div className="border-t border-black pt-2">Date: ________</div>
            </div>
            <div className="p-4 border-r border-black">
              <div className="mb-8">Checked by / ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</div>
              <div className="border-t border-black pt-2">Date: ________</div>
            </div>
            <div className="p-4 border-r border-black">
              <div className="mb-8">Driver / ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</div>
              <div className="border-t border-black pt-2">Out: ______ In: ______</div>
            </div>
            <div className="p-4">
              <div className="mb-8">Received by / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
              <div className="border-t border-black pt-2">Date: ________</div>
            </div>
          </div>

          {/* Footer */}
          <div className="p-2 border-t border-black text-center text-xs text-gray-500">
            Please sign and return this copy to driver. / ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ô‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PRINT VIEW - QUOTATION
// ============================================
const QuotationPrintView = ({ quotation, customer, entity, onClose }) => {
  const companyInfo = COMPANY_ENTITIES.find(e => e.id === entity) || COMPANY_ENTITIES[0]
  
  const handlePrint = () => {
    window.print()
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-gray-100 flex justify-between items-center mb-4">
        <h2 className="font-bold text-lg">Print Preview - Quotation</h2>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Quotation Content */}
      <div className="p-8 max-w-4xl mx-auto print:p-0 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        <div className="border-2 border-black">
          {/* Header */}
          <div className="flex justify-between items-start p-4 border-b-2 border-black">
            <div className="flex items-center gap-4">
              <img src={IND_LOGO_SVG} alt="IND Logo" className="w-16 h-16" />
              <div>
                <div className="font-bold text-lg">{companyInfo.name}</div>
                <div className="text-sm">{companyInfo.nameTh}</div>
                <div className="text-xs text-gray-600">{companyInfo.address}</div>
                <div className="text-xs text-gray-600">Tax ID: {companyInfo.taxId}</div>
                <div className="text-xs text-gray-600">Tel: {companyInfo.tel}</div>
              </div>
            </div>
            <div className="text-right">
              <div className="text-xl font-bold border-2 border-black px-4 py-2 mb-2">
                QUOTATION / ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
              </div>
              <div className="font-mono text-lg font-bold text-purple-600">{quotation.id}</div>
            </div>
          </div>

          {/* Customer & Quote Info */}
          <div className="grid grid-cols-2 border-b border-black">
            <div className="p-4 border-r border-black">
              <div className="font-bold mb-2">To / ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</div>
              <div className="font-medium">{customer?.name}</div>
              <div className="text-sm">{customer?.nameTh}</div>
              <div className="text-xs text-gray-600">{customer?.deliveryAddress}</div>
              <div className="text-xs text-gray-600">Attn: {quotation.customerContact || customer?.contact}</div>
            </div>
            <div className="p-4 text-sm">
              <div className="grid grid-cols-2 gap-1">
                <span>Quote Date:</span><span className="font-medium">{formatDate(quotation.quoteDate)}</span>
                <span className="text-red-600 font-medium">Valid Until:</span><span className="text-red-600 font-medium">{formatDate(quotation.validUntil)}</span>
                <span>Prepared By:</span><span>{quotation.preparedBy || '-'}</span>
                <span>Payment Terms:</span><span>{quotation.paymentTerms}</span>
              </div>
            </div>
          </div>

          {/* Items Table */}
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-gray-100 border-b border-black">
                <th className="px-2 py-2 text-center border-r border-black w-12">No.</th>
                <th className="px-2 py-2 text-left border-r border-black">Description / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Qty</th>
                <th className="px-2 py-2 text-center border-r border-black w-16">Unit</th>
                <th className="px-2 py-2 text-right border-r border-black w-24">Unit Price</th>
                <th className="px-2 py-2 text-right w-28">Amount</th>
              </tr>
            </thead>
            <tbody>
              {quotation.items?.map((item, idx) => (
                <tr key={idx} className="border-b border-gray-300">
                  <td className="px-2 py-2 text-center border-r border-gray-300">{idx + 1}</td>
                  <td className="px-2 py-2 border-r border-gray-300">
                    <div>{item.productName}</div>
                    {item.description && <div className="text-xs text-gray-500">{item.description}</div>}
                  </td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.qty}</td>
                  <td className="px-2 py-2 text-center border-r border-gray-300">{item.unit || 'pcs'}</td>
                  <td className="px-2 py-2 text-right border-r border-gray-300">{formatCurrency(item.unitPrice)}</td>
                  <td className="px-2 py-2 text-right">{formatCurrency(item.total || item.qty * item.unitPrice)}</td>
                </tr>
              ))}
            </tbody>
          </table>

          {/* Totals */}
          <div className="grid grid-cols-2 border-t border-black">
            <div className="p-4 border-r border-black">
              <div className="font-bold mb-2">Terms & Conditions:</div>
              <div className="text-xs space-y-1">
                <div>1. Prices are in Thai Baht and include VAT 7%</div>
                <div>2. Delivery: {quotation.deliveryTerms || 'To be agreed'}</div>
                <div>3. Payment Terms: {quotation.paymentTerms}</div>
                <div>4. This quotation is valid until {formatDate(quotation.validUntil)}</div>
              </div>
            </div>
            <div className="p-2 text-sm">
              <div className="flex justify-between py-1"><span>Subtotal:</span><span>{formatCurrency(quotation.subtotal)}</span></div>
              {quotation.discount > 0 && (
                <div className="flex justify-between py-1 text-red-600">
                  <span>Discount:</span><span>-{formatCurrency(quotation.discount)}</span>
                </div>
              )}
              <div className="flex justify-between py-1"><span>VAT 7%:</span><span>{formatCurrency(quotation.vat)}</span></div>
              <div className="flex justify-between py-2 text-lg font-bold border-t border-black mt-2">
                <span>TOTAL:</span>
                <span className="text-purple-600">{formatCurrency(quotation.grandTotal)}</span>
              </div>
            </div>
          </div>

          {/* Notes */}
          {quotation.notes && (
            <div className="p-4 border-t border-black">
              <span className="font-bold">Notes / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: </span>
              <span className="text-sm">{quotation.notes}</span>
            </div>
          )}

          {/* Signatures */}
          <div className="grid grid-cols-2 border-t border-black text-center text-sm">
            <div className="p-4 border-r border-black">
              <div className="font-bold mb-2">For {companyInfo.name}</div>
              <div className="mb-8">&nbsp;</div>
              <div className="border-t border-black pt-2">
                Authorized Signature
              </div>
            </div>
            <div className="p-4">
              <div className="font-bold mb-2">Customer Acceptance</div>
              <div className="mb-8">&nbsp;</div>
              <div className="border-t border-black pt-2">
                Signature & Company Stamp
              </div>
            </div>
          </div>

          {/* Footer */}
          <div className="p-2 border-t border-black text-center text-xs text-gray-500">
            Thank you for your interest. We look forward to serving you. / ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// ALLIANZ QR LABEL GENERATOR
// ============================================
const AllianzLabelPrintView = ({ invoice, deliveryOrder, customer, onClose }) => {
  const handlePrint = () => {
    window.print()
  }

  // Allianz vendor code for IND
  const VENDOR_CODE = '115050'
  const VENDOR_NAME = 'IND THAI PACKWELL CO.,LTD'
  const PLANT = '6000'

  // Generate QR code data for invoice
  const generateInvoiceQR = () => {
    // Format: PO Number$Invoice Number$Vendor Code
    return `${invoice.customerPO || ''}$${invoice.id}$${VENDOR_CODE}`
  }

  // Generate QR code data for packaging
  const generatePackagingQR = (item) => {
    // Format: ALS Part Number$Quantity$PO Number$Vendor Code
    return `${item.partNo || item.productName}$${item.qty}$${invoice.customerPO || ''}$${VENDOR_CODE}`
  }

  // Simple QR code SVG generator (data matrix style)
  const QRCodeSVG = ({ data, size = 80 }) => {
    // Create a simple visual representation (in production, use a proper QR library)
    const hash = data.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)
    const pattern = []
    for (let i = 0; i < 64; i++) {
      pattern.push((hash * (i + 1)) % 2 === 0)
    }
    
    return (
      <svg width={size} height={size} viewBox="0 0 80 80" className="border border-black">
        <rect width="80" height="80" fill="white" />
        {/* Corner patterns */}
        <rect x="4" y="4" width="20" height="20" fill="black" />
        <rect x="7" y="7" width="14" height="14" fill="white" />
        <rect x="10" y="10" width="8" height="8" fill="black" />
        
        <rect x="56" y="4" width="20" height="20" fill="black" />
        <rect x="59" y="7" width="14" height="14" fill="white" />
        <rect x="62" y="10" width="8" height="8" fill="black" />
        
        <rect x="4" y="56" width="20" height="20" fill="black" />
        <rect x="7" y="59" width="14" height="14" fill="white" />
        <rect x="10" y="62" width="8" height="8" fill="black" />
        
        {/* Data pattern */}
        {pattern.map((filled, idx) => {
          const row = Math.floor(idx / 8)
          const col = idx % 8
          if (row < 3 && col < 3) return null
          if (row < 3 && col > 4) return null
          if (row > 4 && col < 3) return null
          return filled ? (
            <rect key={idx} x={28 + col * 3} y={28 + row * 3} width="3" height="3" fill="black" />
          ) : null
        })}
        
        {/* QR text below */}
        <text x="40" y="78" fontSize="4" textAnchor="middle" fill="black">{data.substring(0, 20)}...</text>
      </svg>
    )
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-blue-100 flex justify-between items-center mb-4">
        <div>
          <h2 className="font-bold text-lg">Allianz QR Labels</h2>
          <p className="text-sm text-blue-700">Invoice QR + Packaging Labels for Alliance Laundry</p>
        </div>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print All Labels</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Label Content */}
      <div className="p-4 max-w-4xl mx-auto print:p-0 print:max-w-none">
        
        {/* Invoice QR Label */}
        <div className="mb-8 print:mb-4">
          <h3 className="font-bold text-lg mb-2 print:hidden">Invoice QR Code Label</h3>
          <div className="border-2 border-black p-4 inline-block bg-white" style={{ width: '300px' }}>
            <div className="text-center font-bold text-sm mb-2">INVOICE QR CODE</div>
            <div className="flex justify-center mb-2">
              <QRCodeSVG data={generateInvoiceQR()} size={100} />
            </div>
            <div className="text-center text-xs font-mono break-all">
              {generateInvoiceQR()}
            </div>
            <div className="mt-2 text-xs border-t pt-2">
              <div><span className="font-bold">Invoice:</span> {invoice.id}</div>
              <div><span className="font-bold">PO:</span> {invoice.customerPO}</div>
              <div><span className="font-bold">Vendor:</span> {VENDOR_CODE}</div>
            </div>
          </div>
        </div>

        {/* Packaging Labels - One per item */}
        <div>
          <h3 className="font-bold text-lg mb-2 print:hidden">Packaging Labels (1 per product line)</h3>
          <div className="grid grid-cols-2 gap-4 print:gap-2">
            {invoice.items?.map((item, idx) => (
              <div key={idx} className="border-2 border-black p-3 bg-white print:break-inside-avoid" style={{ minWidth: '280px' }}>
                {/* Header */}
                <div className="text-center font-bold text-xs border-b pb-1 mb-2">
                  ALLIANCE LAUNDRY THAILAND
                </div>
                
                {/* QR Code and Details */}
                <div className="flex gap-3">
                  <div className="flex-shrink-0">
                    <QRCodeSVG data={generatePackagingQR(item)} size={70} />
                  </div>
                  <div className="text-xs flex-grow">
                    <table className="w-full">
                      <tbody>
                        <tr>
                          <td className="font-bold pr-1">Part No:</td>
                          <td className="font-mono">{item.partNo || item.productName.substring(0, 15)}</td>
                        </tr>
                        <tr>
                          <td className="font-bold pr-1">Description:</td>
                          <td className="text-xs">{item.description || item.productName}</td>
                        </tr>
                        <tr>
                          <td className="font-bold pr-1">Plant:</td>
                          <td>{PLANT}</td>
                        </tr>
                        <tr>
                          <td className="font-bold pr-1">Qty:</td>
                          <td className="font-bold text-lg">{item.qty}</td>
                        </tr>
                        <tr>
                          <td className="font-bold pr-1">UoM:</td>
                          <td>PC</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
                {/* Footer */}
                <div className="text-xs border-t mt-2 pt-1">
                  <div className="flex justify-between">
                    <span><span className="font-bold">Vendor:</span> {VENDOR_CODE}</span>
                    <span><span className="font-bold">PO:</span> {invoice.customerPO}</span>
                  </div>
                  <div><span className="font-bold">Vendor Name:</span> {VENDOR_NAME}</div>
                  <div><span className="font-bold">Delivery Date:</span> {formatDate(deliveryOrder?.deliveryDate || invoice.invoiceDate)}</div>
                </div>
                
                {/* QR Data String */}
                <div className="mt-1 pt-1 border-t text-center">
                  <div className="font-mono text-xs break-all text-gray-600">
                    {generatePackagingQR(item)}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Print Summary */}
        <div className="mt-6 p-4 bg-gray-100 rounded print:hidden">
          <h4 className="font-bold mb-2">Label Summary</h4>
          <ul className="text-sm space-y-1">
            <li>‚úì 1 Invoice QR Code label</li>
            <li>‚úì {invoice.items?.length || 0} Packaging labels (1 per product line)</li>
            <li>‚úì Total labels to print: {1 + (invoice.items?.length || 0)}</li>
          </ul>
        </div>
      </div>
    </div>
  )
}

// ============================================
// POLYPLEX 4-COLUMN LABEL SHEET
// ============================================
const PolyplexLabelPrintView = ({ invoice, deliveryOrder, customer, onClose }) => {
  const handlePrint = () => {
    window.print()
  }

  // Color coding for delivery location
  const getLocationColor = (location) => {
    const loc = (location || '').toUpperCase()
    if (loc.includes('CPP')) return '#FFDAB9' // Peach
    if (loc.includes('LINE 10') || loc.includes('LINE10')) return '#FF0000' // Red
    if (loc.includes('FILM')) return '#FFFFFF' // White
    return '#FFFFFF' // Default white
  }

  const getLocationTextColor = (location) => {
    const loc = (location || '').toUpperCase()
    if (loc.includes('LINE 10') || loc.includes('LINE10')) return '#FFFFFF' // White text on red
    return '#000000' // Black text
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-green-100 flex justify-between items-center mb-4">
        <div>
          <h2 className="font-bold text-lg">Polyplex 4-Column Label Sheet</h2>
          <p className="text-sm text-green-700">Color-coded labels for Polyplex Thailand</p>
          <div className="flex gap-4 mt-2 text-xs">
            <span className="px-2 py-1 border">FILM = White</span>
            <span className="px-2 py-1 border" style={{ backgroundColor: '#FFDAB9' }}>CPP = Peach</span>
            <span className="px-2 py-1 border text-white" style={{ backgroundColor: '#FF0000' }}>Line 10 = Red</span>
          </div>
        </div>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print Label Sheet</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Label Sheet Content */}
      <div className="p-4 max-w-4xl mx-auto print:p-2 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        {/* Header */}
        <div className="text-center mb-4">
          <div className="font-bold text-lg">POLYPLEX (THAILAND) PUBLIC COMPANY LIMITED</div>
          <div className="text-sm">Delivery Labels - {formatDate(invoice.invoiceDate)}</div>
          <div className="text-sm">PO: {invoice.customerPO} | Invoice: {invoice.id}</div>
        </div>

        {/* 4-Column Table */}
        <table className="w-full border-collapse border-2 border-black text-sm">
          <thead>
            <tr className="bg-gray-200">
              <th className="border border-black px-2 py-2 text-left w-24">ITEM CODE</th>
              <th className="border border-black px-2 py-2 text-left">DESCRIPTION</th>
              <th className="border border-black px-2 py-2 text-center w-40">ORDER NO / DEL LOCATION</th>
              <th className="border border-black px-2 py-2 text-left w-32">PO NO</th>
            </tr>
          </thead>
          <tbody>
            {invoice.items?.map((item, idx) => {
              const deliveryLocation = item.deliveryLocation || item.orderNo || deliveryOrder?.deliveryAddress || 'FILM'
              const bgColor = getLocationColor(deliveryLocation)
              const textColor = getLocationTextColor(deliveryLocation)
              
              return (
                <tr key={idx} className="hover:bg-gray-50">
                  <td className="border border-black px-2 py-3 font-mono font-bold">
                    {item.itemCode || item.partNo || `PLX-${String(idx + 1).padStart(3, '0')}`}
                  </td>
                  <td className="border border-black px-2 py-3">
                    {item.description || item.productName}
                    {item.dimensions && <div className="text-xs text-gray-600">{item.dimensions}</div>}
                  </td>
                  <td 
                    className="border border-black px-2 py-3 text-center font-bold"
                    style={{ backgroundColor: bgColor, color: textColor }}
                  >
                    {deliveryLocation}
                  </td>
                  <td className="border border-black px-2 py-3 font-mono">
                    {invoice.customerPO}
                  </td>
                </tr>
              )
            })}
            
            {/* Add empty rows to fill page if needed */}
            {Array.from({ length: Math.max(0, 10 - (invoice.items?.length || 0)) }).map((_, idx) => (
              <tr key={`empty-${idx}`}>
                <td className="border border-black px-2 py-3">&nbsp;</td>
                <td className="border border-black px-2 py-3"></td>
                <td className="border border-black px-2 py-3"></td>
                <td className="border border-black px-2 py-3"></td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* Footer */}
        <div className="mt-4 flex justify-between text-sm">
          <div>
            <div><span className="font-bold">Total Items:</span> {invoice.items?.length || 0}</div>
            <div><span className="font-bold">Total Qty:</span> {invoice.items?.reduce((sum, i) => sum + i.qty, 0)} pcs</div>
          </div>
          <div className="text-right">
            <div><span className="font-bold">Supplier:</span> IND THAI PACKWELL CO., LTD</div>
            <div><span className="font-bold">Date:</span> {formatDate(new Date())}</div>
          </div>
        </div>

        {/* Individual Cut Labels - Print on separate page */}
        <div className="print:break-before-page mt-8 print:mt-0">
          <h3 className="font-bold text-lg mb-4 print:hidden">Individual Labels (for cutting)</h3>
          <div className="grid grid-cols-2 gap-2 print:gap-1">
            {invoice.items?.map((item, idx) => {
              const deliveryLocation = item.deliveryLocation || item.orderNo || deliveryOrder?.deliveryAddress || 'FILM'
              const bgColor = getLocationColor(deliveryLocation)
              const textColor = getLocationTextColor(deliveryLocation)
              
              return (
                <div 
                  key={idx} 
                  className="border-2 border-black p-2 print:break-inside-avoid"
                  style={{ minHeight: '80px' }}
                >
                  <div className="flex justify-between items-start mb-1">
                    <div className="font-mono font-bold text-sm">
                      {item.itemCode || item.partNo || `PLX-${String(idx + 1).padStart(3, '0')}`}
                    </div>
                    <div 
                      className="px-2 py-0.5 text-xs font-bold rounded"
                      style={{ backgroundColor: bgColor, color: textColor, border: '1px solid black' }}
                    >
                      {deliveryLocation}
                    </div>
                  </div>
                  <div className="text-sm mb-1">{item.description || item.productName}</div>
                  <div className="flex justify-between text-xs">
                    <span><span className="font-bold">Qty:</span> {item.qty}</span>
                    <span className="font-mono">{invoice.customerPO}</span>
                  </div>
                </div>
              )
            })}
          </div>
        </div>

        {/* Print Instructions */}
        <div className="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded print:hidden">
          <h4 className="font-bold mb-2">üìã Printing Instructions</h4>
          <ul className="text-sm space-y-1">
            <li>‚Ä¢ Page 1: Full 4-column sheet for reference/filing</li>
            <li>‚Ä¢ Page 2: Individual labels for cutting and attaching to pallets</li>
            <li>‚Ä¢ Color coding: FILM=White, CPP=Peach, Line 10=Red</li>
            <li>‚Ä¢ Attach one label per pallet/package</li>
          </ul>
        </div>
      </div>
    </div>
  )
}

// ============================================
// CUSTOMER STATEMENT PRINT VIEW
// ============================================
const CustomerStatementPrintView = ({ customer, invoices, payments, creditNotes, dateRange, onClose }) => {
  const handlePrint = () => {
    window.print()
  }

  // Filter transactions for this customer
  const customerInvoices = invoices?.filter(inv => inv.customerId === customer?.id) || []
  const customerCNs = creditNotes?.filter(cn => cn.customerId === customer?.id) || []
  
  // Build transaction list
  const transactions = [
    ...customerInvoices.map(inv => ({
      date: inv.invoiceDate,
      type: 'invoice',
      ref: inv.id,
      description: `Invoice - ${inv.items?.map(i => i.productName).join(', ').substring(0, 50)}...`,
      debit: inv.grandTotal || 0,
      credit: 0,
      payments: inv.payments || [],
    })),
    ...customerCNs.map(cn => ({
      date: cn.date,
      type: 'credit_note',
      ref: cn.id,
      description: `Credit Note - ${cn.reason || 'Adjustment'}`,
      debit: 0,
      credit: cn.amount || 0,
    })),
  ].sort((a, b) => new Date(a.date) - new Date(b.date))

  // Calculate totals
  const totalInvoiced = customerInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0)
  const totalPaid = customerInvoices.reduce((sum, inv) => sum + (inv.paidAmount || 0), 0)
  const totalCN = customerCNs.reduce((sum, cn) => sum + (cn.amount || 0), 0)
  const balance = totalInvoiced - totalPaid - totalCN

  const companyInfo = {
    name: 'IND THAI PACKWELL INDUSTRIES CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏µ ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    tel: '038-211-xxx',
    taxId: '0205556010518',
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-indigo-100 flex justify-between items-center mb-4">
        <div>
          <h2 className="font-bold text-lg">Customer Statement / ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
          <p className="text-sm text-indigo-700">{customer?.name}</p>
        </div>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print Statement</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Statement Content */}
      <div className="p-6 max-w-4xl mx-auto print:p-4 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        {/* Header */}
        <div className="border-2 border-black">
          <div className="bg-indigo-800 text-white p-4 text-center">
            <div className="text-xl font-bold">{companyInfo.name}</div>
            <div className="text-sm">{companyInfo.nameTh}</div>
          </div>
          
          <div className="p-4 border-b border-black">
            <div className="text-center text-2xl font-bold mb-4">STATEMENT OF ACCOUNT / ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="font-bold">Customer / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</div>
                <div className="text-lg">{customer?.name}</div>
                <div className="text-sm text-gray-600">{customer?.code}</div>
                <div className="text-sm">{customer?.address}</div>
                <div className="text-sm">Tax ID: {customer?.taxId}</div>
              </div>
              <div className="text-right">
                <div><span className="font-bold">Statement Date:</span> {formatDate(new Date())}</div>
                <div><span className="font-bold">Payment Terms:</span> {customer?.paymentTerms || 'Net 30'}</div>
                <div><span className="font-bold">Currency:</span> THB</div>
              </div>
            </div>
          </div>

          {/* Transaction Table */}
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="border-b border-black px-3 py-2 text-left">Date</th>
                <th className="border-b border-black px-3 py-2 text-left">Reference</th>
                <th className="border-b border-black px-3 py-2 text-left">Description</th>
                <th className="border-b border-black px-3 py-2 text-right">Debit (‡∏ø)</th>
                <th className="border-b border-black px-3 py-2 text-right">Credit (‡∏ø)</th>
                <th className="border-b border-black px-3 py-2 text-right">Balance (‡∏ø)</th>
              </tr>
            </thead>
            <tbody>
              {(() => {
                let runningBalance = 0
                return transactions.map((txn, idx) => {
                  runningBalance += txn.debit - txn.credit
                  // Add payments as credits
                  if (txn.payments) {
                    txn.payments.forEach(pmt => {
                      runningBalance -= pmt.amount
                    })
                  }
                  return (
                    <React.Fragment key={idx}>
                      <tr className={txn.type === 'credit_note' ? 'bg-green-50' : ''}>
                        <td className="border-b px-3 py-2">{formatDate(txn.date)}</td>
                        <td className="border-b px-3 py-2 font-mono text-xs">
                          <span className={txn.type === 'invoice' ? 'text-blue-600' : 'text-green-600'}>
                            {txn.ref}
                          </span>
                        </td>
                        <td className="border-b px-3 py-2">{txn.description}</td>
                        <td className="border-b px-3 py-2 text-right">{txn.debit > 0 ? formatCurrency(txn.debit) : '-'}</td>
                        <td className="border-b px-3 py-2 text-right text-green-600">{txn.credit > 0 ? formatCurrency(txn.credit) : '-'}</td>
                        <td className="border-b px-3 py-2 text-right font-medium">{formatCurrency(runningBalance)}</td>
                      </tr>
                      {/* Show payments for this invoice */}
                      {txn.payments?.map((pmt, pIdx) => {
                        return (
                          <tr key={`pmt-${idx}-${pIdx}`} className="bg-blue-50 text-xs">
                            <td className="border-b px-3 py-1 pl-6">{formatDate(pmt.date)}</td>
                            <td className="border-b px-3 py-1 font-mono text-green-600">PMT-{pmt.date}</td>
                            <td className="border-b px-3 py-1">Payment received - {pmt.method}</td>
                            <td className="border-b px-3 py-1 text-right">-</td>
                            <td className="border-b px-3 py-1 text-right text-green-600">{formatCurrency(pmt.amount)}</td>
                            <td className="border-b px-3 py-1 text-right"></td>
                          </tr>
                        )
                      })}
                    </React.Fragment>
                  )
                })
              })()}
            </tbody>
          </table>

          {/* Summary */}
          <div className="p-4 bg-gray-50 border-t border-black">
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-1 text-sm">
                <div className="font-bold">Aging Summary / ‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ:</div>
                <div className="flex justify-between"><span>Current:</span><span>{formatCurrency(0)}</span></div>
                <div className="flex justify-between"><span>1-30 days:</span><span>{formatCurrency(0)}</span></div>
                <div className="flex justify-between"><span>31-60 days:</span><span>{formatCurrency(0)}</span></div>
                <div className="flex justify-between"><span>61-90 days:</span><span>{formatCurrency(0)}</span></div>
                <div className="flex justify-between text-red-600"><span>90+ days:</span><span>{formatCurrency(0)}</span></div>
              </div>
              <div className="text-right">
                <div className="space-y-2">
                  <div className="flex justify-between"><span>Total Invoiced:</span><span className="font-bold">{formatCurrency(totalInvoiced)}</span></div>
                  <div className="flex justify-between"><span>Total Paid:</span><span className="font-bold text-green-600">({formatCurrency(totalPaid)})</span></div>
                  <div className="flex justify-between"><span>Credit Notes:</span><span className="font-bold text-green-600">({formatCurrency(totalCN)})</span></div>
                  <div className="border-t pt-2 flex justify-between text-lg">
                    <span className="font-bold">BALANCE DUE:</span>
                    <span className={`font-bold ${balance > 0 ? 'text-red-600' : 'text-green-600'}`}>
                      {formatCurrency(balance)}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Footer */}
          <div className="p-4 border-t border-black text-center text-xs text-gray-500">
            <div>Please remit payment to: Kasikorn Bank, A/C: 123-4-56789-0, A/C Name: IND THAI PACKWELL INDUSTRIES CO., LTD</div>
            <div className="mt-2">For inquiries, please contact: {companyInfo.tel}</div>
            <div className="mt-4 text-gray-400">This statement was generated on {formatDate(new Date())} and reflects all transactions up to this date.</div>
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// CREDIT NOTE PRINT VIEW
// ============================================
const CreditNotePrintView = ({ creditNote, customer, invoice, entity, onClose }) => {
  const handlePrint = () => {
    window.print()
  }

  const companyInfo = entity === 'IND2' ? {
    name: 'IND-2 THAI PACKWELL CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏µ-2 ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    tel: '038-211-xxx',
    taxId: '0205556010526',
  } : {
    name: 'IND THAI PACKWELL INDUSTRIES CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏µ ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    tel: '038-211-xxx',
    taxId: '0205556010518',
  }

  const vatAmount = (creditNote?.amount || 0) * 0.07 / 1.07 // Extract VAT from total
  const subtotal = (creditNote?.amount || 0) - vatAmount

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-red-100 flex justify-between items-center mb-4">
        <div>
          <h2 className="font-bold text-lg">Credit Note / ‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ</h2>
          <p className="text-sm text-red-700">{creditNote?.id}</p>
        </div>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print Credit Note</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Credit Note Content */}
      <div className="p-6 max-w-4xl mx-auto print:p-4 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        <div className="border-2 border-black">
          {/* Header */}
          <div className="bg-red-700 text-white p-4">
            <div className="flex justify-between items-start">
              <div>
                <div className="text-xl font-bold">{companyInfo.name}</div>
                <div className="text-sm">{companyInfo.nameTh}</div>
                <div className="text-xs mt-1">{companyInfo.address}</div>
                <div className="text-xs">Tax ID: {companyInfo.taxId}</div>
              </div>
              <div className="text-right">
                <div className="text-2xl font-bold">CREDIT NOTE</div>
                <div className="text-lg">‡πÉ‡∏ö‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ</div>
              </div>
            </div>
          </div>

          {/* Document Info */}
          <div className="grid grid-cols-2 border-b border-black">
            <div className="p-4 border-r border-black">
              <div className="text-sm text-gray-500">Customer / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
              <div className="font-bold text-lg">{customer?.name}</div>
              <div className="text-sm">{customer?.address}</div>
              <div className="text-sm">Tax ID: {customer?.taxId}</div>
            </div>
            <div className="p-4">
              <table className="w-full text-sm">
                <tbody>
                  <tr>
                    <td className="font-bold py-1">CN Number:</td>
                    <td className="text-right font-mono text-red-600">{creditNote?.id}</td>
                  </tr>
                  <tr>
                    <td className="font-bold py-1">Date:</td>
                    <td className="text-right">{formatDate(creditNote?.date)}</td>
                  </tr>
                  <tr>
                    <td className="font-bold py-1">Original Invoice:</td>
                    <td className="text-right font-mono text-blue-600">{creditNote?.invoiceId}</td>
                  </tr>
                  <tr>
                    <td className="font-bold py-1">Related REJ/CLM:</td>
                    <td className="text-right font-mono">{creditNote?.rejectionId || creditNote?.claimId || '-'}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          {/* Reason */}
          <div className="p-4 border-b border-black bg-red-50">
            <div className="text-sm font-bold text-gray-600">Reason for Credit Note / ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏´‡∏ô‡∏µ‡πâ:</div>
            <div className="mt-1">{creditNote?.reason || 'Goods returned / Quality issue'}</div>
          </div>

          {/* Items Table */}
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="border-b border-black px-3 py-2 text-center w-12">#</th>
                <th className="border-b border-black px-3 py-2 text-left">Description / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th className="border-b border-black px-3 py-2 text-center w-20">Qty</th>
                <th className="border-b border-black px-3 py-2 text-right w-28">Unit Price</th>
                <th className="border-b border-black px-3 py-2 text-right w-32">Amount</th>
              </tr>
            </thead>
            <tbody>
              {creditNote?.items?.map((item, idx) => (
                <tr key={idx}>
                  <td className="border-b px-3 py-2 text-center">{idx + 1}</td>
                  <td className="border-b px-3 py-2">{item.description || item.productName}</td>
                  <td className="border-b px-3 py-2 text-center">{item.qty}</td>
                  <td className="border-b px-3 py-2 text-right">{formatCurrency(item.unitPrice || 0)}</td>
                  <td className="border-b px-3 py-2 text-right">{formatCurrency(item.amount || item.qty * (item.unitPrice || 0))}</td>
                </tr>
              )) || (
                <tr>
                  <td className="border-b px-3 py-2 text-center">1</td>
                  <td className="border-b px-3 py-2">{creditNote?.reason || 'Credit adjustment'}</td>
                  <td className="border-b px-3 py-2 text-center">-</td>
                  <td className="border-b px-3 py-2 text-right">-</td>
                  <td className="border-b px-3 py-2 text-right">{formatCurrency(subtotal)}</td>
                </tr>
              )}
              {/* Empty rows */}
              {Array.from({ length: Math.max(0, 3 - (creditNote?.items?.length || 1)) }).map((_, idx) => (
                <tr key={`empty-${idx}`}>
                  <td className="border-b px-3 py-2">&nbsp;</td>
                  <td className="border-b px-3 py-2"></td>
                  <td className="border-b px-3 py-2"></td>
                  <td className="border-b px-3 py-2"></td>
                  <td className="border-b px-3 py-2"></td>
                </tr>
              ))}
            </tbody>
          </table>

          {/* Totals */}
          <div className="flex">
            <div className="flex-grow p-4 border-r border-black">
              <div className="text-sm text-gray-500">Amount in words:</div>
              <div className="font-medium">({creditNote?.amount?.toLocaleString() || 0} Baht)</div>
            </div>
            <div className="w-64 p-4">
              <div className="flex justify-between py-1 border-b">
                <span>Subtotal:</span>
                <span>{formatCurrency(subtotal)}</span>
              </div>
              <div className="flex justify-between py-1 border-b">
                <span>VAT 7%:</span>
                <span>{formatCurrency(vatAmount)}</span>
              </div>
              <div className="flex justify-between py-2 text-lg font-bold text-red-600">
                <span>CREDIT TOTAL:</span>
                <span>{formatCurrency(creditNote?.amount || 0)}</span>
              </div>
            </div>
          </div>

          {/* Signatures */}
          <div className="grid grid-cols-3 border-t border-black text-center text-sm">
            <div className="p-4 border-r border-black">
              <div className="mb-8">&nbsp;</div>
              <div className="border-t border-black pt-2">Prepared By / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</div>
              <div className="text-xs text-gray-500">{creditNote?.preparedBy || '_____________'}</div>
            </div>
            <div className="p-4 border-r border-black">
              <div className="mb-8">&nbsp;</div>
              <div className="border-t border-black pt-2">Approved By / ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
              <div className="text-xs text-gray-500">{creditNote?.approvedBy || '_____________'}</div>
            </div>
            <div className="p-4">
              <div className="mb-8">&nbsp;</div>
              <div className="border-t border-black pt-2">Customer Acknowledged / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</div>
              <div className="text-xs text-gray-500">Date: _____________</div>
            </div>
          </div>

          {/* Footer */}
          <div className="p-2 border-t border-black text-center text-xs text-gray-500">
            This credit note will be applied to your account. For any questions, please contact our accounts department.
          </div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PRICE HISTORY LOG COMPONENT
// ============================================
const PriceHistoryLog = ({ product, priceHistory, onAddChange, lang }) => {
  const [showAddModal, setShowAddModal] = useState(false)
  const [newPrice, setNewPrice] = useState({
    price: product?.price || 0,
    effectiveDate: new Date().toISOString().split('T')[0],
    reason: '',
    emailRef: '',
    approvedBy: '',
  })

  const handleSave = () => {
    onAddChange({
      productId: product.id,
      productName: product.name,
      oldPrice: product.price,
      newPrice: newPrice.price,
      effectiveDate: newPrice.effectiveDate,
      reason: newPrice.reason,
      emailRef: newPrice.emailRef,
      approvedBy: newPrice.approvedBy,
      changedBy: 'Current User',
      changedAt: new Date().toISOString(),
    })
    setShowAddModal(false)
  }

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h4 className="font-bold">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Price Change History'}</h4>
        <Button size="sm" icon={Plus} onClick={() => setShowAddModal(true)}>
          {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Log Price Change'}
        </Button>
      </div>

      {/* Current Price */}
      <div className="p-4 bg-blue-50 rounded-lg">
        <div className="text-sm text-blue-600">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : 'Current Price'}</div>
        <div className="text-2xl font-bold text-blue-700">{formatCurrency(product?.price || 0)}</div>
        <div className="text-xs text-blue-500">{lang === 'th' ? '‡∏ï‡πà‡∏≠' : 'per'} {product?.unit || 'pc'}</div>
      </div>

      {/* History Table */}
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•' : 'Effective Date'}</th>
              <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏î‡∏¥‡∏°' : 'Old Price'}</th>
              <th className="px-3 py-2 text-right">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Price'}</th>
              <th className="px-3 py-2 text-center">{lang === 'th' ? '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á' : 'Change'}</th>
              <th className="px-3 py-2 text-left">{lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'}</th>
              <th className="px-3 py-2 text-left">{lang === 'th' ? '‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•' : 'Email Ref'}</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {priceHistory?.filter(h => h.productId === product?.id).map((record, idx) => {
              const change = ((record.newPrice - record.oldPrice) / record.oldPrice * 100).toFixed(1)
              const isIncrease = record.newPrice > record.oldPrice
              return (
                <tr key={idx} className="hover:bg-gray-50">
                  <td className="px-3 py-2">{formatDate(record.effectiveDate)}</td>
                  <td className="px-3 py-2 text-right">{formatCurrency(record.oldPrice)}</td>
                  <td className="px-3 py-2 text-right font-bold">{formatCurrency(record.newPrice)}</td>
                  <td className="px-3 py-2 text-center">
                    <span className={isIncrease ? 'text-red-600' : 'text-green-600'}>
                      {isIncrease ? '‚Üë' : '‚Üì'} {Math.abs(change)}%
                    </span>
                  </td>
                  <td className="px-3 py-2">{record.reason}</td>
                  <td className="px-3 py-2 text-xs text-blue-600">{record.emailRef || '-'}</td>
                </tr>
              )
            })}
            {(!priceHistory || priceHistory.filter(h => h.productId === product?.id).length === 0) && (
              <tr>
                <td colSpan="6" className="px-3 py-8 text-center text-gray-400">
                  {lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤' : 'No price change history'}
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* Add Price Change Modal */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 className="font-bold text-lg mb-4">{lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : 'Log Price Change'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">{lang === 'th' ? '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà' : 'New Price'} *</label>
                <input 
                  type="number" 
                  value={newPrice.price} 
                  onChange={(e) => setNewPrice({ ...newPrice, price: parseFloat(e.target.value) })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•' : 'Effective Date'} *</label>
                <input 
                  type="date" 
                  value={newPrice.effectiveDate} 
                  onChange={(e) => setNewPrice({ ...newPrice, effectiveDate: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">{lang === 'th' ? '‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Reason'} *</label>
                <select 
                  value={newPrice.reason} 
                  onChange={(e) => setNewPrice({ ...newPrice, reason: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•' : 'Select reason'}</option>
                  <option value="material_cost_increase">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°' : 'Material cost increase'}</option>
                  <option value="material_cost_decrease">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏•‡∏î' : 'Material cost decrease'}</option>
                  <option value="customer_negotiation">{lang === 'th' ? '‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer negotiation'}</option>
                  <option value="volume_discount">{lang === 'th' ? '‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì' : 'Volume discount'}</option>
                  <option value="market_adjustment">{lang === 'th' ? '‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ï‡∏•‡∏≤‡∏î' : 'Market adjustment'}</option>
                  <option value="annual_review">{lang === 'th' ? '‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ' : 'Annual review'}</option>
                  <option value="other">{lang === 'th' ? '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : 'Other'}</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">{lang === 'th' ? '‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•' : 'Email Reference'}</label>
                <input 
                  type="text" 
                  value={newPrice.emailRef} 
                  onChange={(e) => setNewPrice({ ...newPrice, emailRef: e.target.value })}
                  placeholder="e.g., Email dated 2026-01-15"
                  className="w-full px-3 py-2 border rounded-lg"
                />
                <div className="text-xs text-gray-500 mt-1">
                  {lang === 'th' ? '* ‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤' : '* Per policy, email with reason required for price changes'}
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">{lang === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢' : 'Approved By'}</label>
                <input 
                  type="text" 
                  value={newPrice.approvedBy} 
                  onChange={(e) => setNewPrice({ ...newPrice, approvedBy: e.target.value })}
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>
            </div>
            <div className="flex justify-end gap-2 mt-6">
              <Button variant="ghost" onClick={() => setShowAddModal(false)}>
                {lang === 'th' ? '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : 'Cancel'}
              </Button>
              <Button onClick={handleSave} disabled={!newPrice.price || !newPrice.reason}>
                {lang === 'th' ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : 'Save'}
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

// ============================================
// RECEIPT ACKNOWLEDGMENT PRINT VIEW
// ============================================
const ReceiptAcknowledgmentPrintView = ({ invoice, deliveryOrder, customer, entity, onClose }) => {
  const handlePrint = () => {
    window.print()
  }

  const companyInfo = entity === 'IND2' ? {
    name: 'IND-2 THAI PACKWELL CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏µ-2 ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    tel: '038-211-xxx',
    taxId: '0205556010526',
  } : {
    name: 'IND THAI PACKWELL INDUSTRIES CO., LTD',
    nameTh: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏ô‡∏î‡∏µ ‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏û‡∏Ñ‡πÄ‡∏ß‡∏•‡∏•‡πå ‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î',
    address: '399 ‡∏´‡∏°‡∏π‡πà 8 ‡∏ï.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏≠.‡∏ö‡πà‡∏≠‡∏ó‡∏≠‡∏á ‡∏à.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ 20270',
    tel: '038-211-xxx',
    taxId: '0205556010518',
  }

  return (
    <div className="bg-white">
      {/* Print Controls */}
      <div className="print:hidden p-4 bg-green-100 flex justify-between items-center mb-4">
        <div>
          <h2 className="font-bold text-lg">Receipt Acknowledgment / ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          <p className="text-sm text-green-700">{invoice?.id} - {customer?.name}</p>
        </div>
        <div className="flex gap-2">
          <Button onClick={handlePrint} icon={Printer}>Print Receipt</Button>
          <Button variant="ghost" onClick={onClose}>Close</Button>
        </div>
      </div>

      {/* Receipt Content - A5 Size for easy signing */}
      <div className="p-6 max-w-2xl mx-auto print:p-4 print:max-w-none" style={{ fontFamily: 'Arial, sans-serif' }}>
        <div className="border-2 border-black">
          {/* Header */}
          <div className="bg-green-700 text-white p-3 text-center">
            <div className="text-lg font-bold">GOODS RECEIPT ACKNOWLEDGMENT</div>
            <div className="text-sm">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡πÉ‡∏ö‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
          </div>

          {/* Company & Customer Info */}
          <div className="grid grid-cols-2 border-b border-black text-sm">
            <div className="p-3 border-r border-black">
              <div className="font-bold text-gray-600">FROM / ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á:</div>
              <div className="font-bold">{companyInfo.name}</div>
              <div className="text-xs">{companyInfo.address}</div>
              <div className="text-xs">Tel: {companyInfo.tel}</div>
            </div>
            <div className="p-3">
              <div className="font-bold text-gray-600">TO / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</div>
              <div className="font-bold">{customer?.name}</div>
              <div className="text-xs">{customer?.deliveryAddress || customer?.address}</div>
            </div>
          </div>

          {/* Document References */}
          <div className="grid grid-cols-3 border-b border-black text-sm">
            <div className="p-2 border-r border-black">
              <div className="text-gray-500 text-xs">Invoice No.</div>
              <div className="font-mono font-bold text-teal-600">{invoice?.id}</div>
            </div>
            <div className="p-2 border-r border-black">
              <div className="text-gray-500 text-xs">DO No.</div>
              <div className="font-mono font-bold">{deliveryOrder?.id || '-'}</div>
            </div>
            <div className="p-2">
              <div className="text-gray-500 text-xs">Delivery Date</div>
              <div className="font-bold">{formatDate(deliveryOrder?.deliveryDate || invoice?.invoiceDate)}</div>
            </div>
          </div>

          {/* Items Summary */}
          <div className="p-3 border-b border-black">
            <div className="text-sm font-bold text-gray-600 mb-2">ITEMS DELIVERED / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á:</div>
            <table className="w-full text-sm">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-2 py-1 text-left border">#</th>
                  <th className="px-2 py-1 text-left border">Description / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                  <th className="px-2 py-1 text-center border">Qty / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                  <th className="px-2 py-1 text-center border">Received ‚úì</th>
                </tr>
              </thead>
              <tbody>
                {invoice?.items?.map((item, idx) => (
                  <tr key={idx}>
                    <td className="px-2 py-1 border">{idx + 1}</td>
                    <td className="px-2 py-1 border">{item.productName}</td>
                    <td className="px-2 py-1 border text-center font-bold">{item.qty} {item.unit}</td>
                    <td className="px-2 py-1 border text-center">‚òê</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Condition Check */}
          <div className="p-3 border-b border-black">
            <div className="text-sm font-bold text-gray-600 mb-2">GOODS CONDITION / ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</div>
            <div className="flex gap-6 text-sm">
              <label className="flex items-center gap-2">
                <span className="text-lg">‚òê</span> Good condition / ‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏µ
              </label>
              <label className="flex items-center gap-2">
                <span className="text-lg">‚òê</span> Damaged / ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
              </label>
              <label className="flex items-center gap-2">
                <span className="text-lg">‚òê</span> Shortage / ‡∏Ç‡∏≤‡∏î
              </label>
            </div>
            <div className="mt-2">
              <div className="text-xs text-gray-500">Remarks / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</div>
              <div className="border-b border-dashed border-gray-400 h-6 mt-1"></div>
            </div>
          </div>

          {/* Signature Section */}
          <div className="grid grid-cols-2">
            <div className="p-4 border-r border-black text-center">
              <div className="text-sm font-bold text-gray-600 mb-8">DELIVERED BY / ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</div>
              <div className="border-b border-black w-3/4 mx-auto mb-2"></div>
              <div className="text-xs text-gray-500">Driver Name / ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</div>
              <div className="mt-4">
                <div className="text-xs text-gray-500">Time Out / ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: __________</div>
              </div>
            </div>
            <div className="p-4 text-center bg-yellow-50">
              <div className="text-sm font-bold text-gray-600 mb-8">RECEIVED BY / ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</div>
              <div className="border-b border-black w-3/4 mx-auto mb-2"></div>
              <div className="text-xs text-gray-500">Name & Signature / ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</div>
              <div className="mt-2">
                <div className="text-xs text-gray-500">Date / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: __________</div>
                <div className="text-xs text-gray-500 mt-1">Time / ‡πÄ‡∏ß‡∏•‡∏≤: __________</div>
              </div>
              <div className="mt-3 border border-dashed border-gray-400 p-2 text-xs text-gray-400">
                Company Stamp / ‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
              </div>
            </div>
          </div>

          {/* Footer Note */}
          <div className="p-2 border-t border-black bg-gray-100 text-xs text-center text-gray-500">
            Please return this signed receipt to driver / ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ô‡∏≤‡∏°
            <br />
            For any discrepancy, please contact us within 24 hours / ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
          </div>
        </div>

        {/* Driver Copy Label */}
        <div className="mt-4 text-center text-sm text-gray-400 print:block">
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚úÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DRIVER COPY / ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚úÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        </div>
      </div>
    </div>
  )
}

// ============================================
// UPDATED MAIN APP WITH ALL MODULES
// ============================================
// Override the previous App component export with full version
const AppFull = () => {
  // Authentication
  const [currentUser, setCurrentUser] = useState(null)
  const [lang, setLang] = useState('en')

  // Master Data State
  const [stores, setStores] = useState(INITIAL_STORES)
  const [categories, setCategories] = useState(INITIAL_CATEGORIES)
  const [inventory, setInventory] = useState(INITIAL_INVENTORY)
  const [vendors, setVendors] = useState(INITIAL_VENDORS)
  const [customers, setCustomers] = useState(INITIAL_CUSTOMERS)
  const [departments, setDepartments] = useState(INITIAL_DEPARTMENTS)
  const [trucks, setTrucks] = useState(INITIAL_TRUCKS)
  const [employees, setEmployees] = useState(INITIAL_EMPLOYEES)
  const [equipment, setEquipment] = useState(INITIAL_EQUIPMENT)
  const [products, setProducts] = useState(INITIAL_PRODUCTS)

  // Transaction State
  const [purchaseOrders, setPurchaseOrders] = useState(INITIAL_PURCHASE_ORDERS)
  const [workOrders, setWorkOrders] = useState(INITIAL_WORK_ORDERS)
  const [salesOrders, setSalesOrders] = useState(INITIAL_SALES_ORDERS)
  const [invoices, setInvoices] = useState(INITIAL_INVOICES)
  const [deliveryOrders, setDeliveryOrders] = useState(INITIAL_DELIVERY_ORDERS)
  const [quotations, setQuotations] = useState(INITIAL_QUOTATIONS)
  const [rejections, setRejections] = useState(INITIAL_REJECTIONS)
  const [claims, setClaims] = useState(INITIAL_CLAIMS)
  const [creditNotes, setCreditNotes] = useState(INITIAL_CREDIT_NOTES)
  const [salesMeetings, setSalesMeetings] = useState(INITIAL_SALES_MEETINGS)
  const [scheduledDeliveries, setScheduledDeliveries] = useState(INITIAL_SCHEDULED_DELIVERIES)
  const [maintenanceTasks, setMaintenanceTasks] = useState(INITIAL_MAINTENANCE_TASKS)
  const [maintenanceStore, setMaintenanceStore] = useState(INITIAL_MAINTENANCE_STORE)

  // UI State
  const [activeModule, setActiveModule] = useState('dashboard')
  const [sidebarOpen, setSidebarOpen] = useState(true)

  // v7.6 Feature States
  const [showGlobalSearch, setShowGlobalSearch] = useState(false)
  const [showNotifications, setShowNotifications] = useState(false)
  const [showQuickActions, setShowQuickActions] = useState(false)
  const [productionView, setProductionView] = useState('tabs') // 'tabs' or 'kanban'
  const [showMaintenanceRequest, setShowMaintenanceRequest] = useState(false)
  
  // Global maintenance requests (shared across all modules)
  const [maintenanceRequests, setMaintenanceRequests] = useState([
    { id: 'REQ-001', date: '2026-02-01', department: 'C1', requestedBy: 'Singh', category: 'equipment', subject: 'Table Saw blade worn', description: 'Blade needs replacement', priority: 'high', status: 'pending' },
    { id: 'REQ-002', date: '2026-01-31', department: 'office', requestedBy: 'Noon', category: 'building', subject: 'AC not cooling', description: 'Office AC unit not working properly', priority: 'medium', status: 'pending' },
  ])

  // Submit maintenance request from anywhere
  const handleSubmitMaintenanceRequest = (request) => {
    const newRequest = {
      id: `REQ-${(maintenanceRequests.length + 1).toString().padStart(3, '0')}`,
      ...request,
      date: new Date().toISOString().split('T')[0],
      status: 'pending',
    }
    setMaintenanceRequests([newRequest, ...maintenanceRequests])
    setShowMaintenanceRequest(false)
  }

  // Generate notifications from data
  const notifications = [
    ...workOrders.filter(wo => wo.targetDate && new Date(wo.targetDate) < new Date() && wo.status !== 'completed')
      .map(wo => ({ id: `wo-overdue-${wo.id}`, type: 'alert', title: lang === 'th' ? 'WO ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : 'Overdue WO', message: `${wo.woNumber || wo.id} - ${wo.productName}`, time: formatDate(wo.targetDate), action: lang === 'th' ? '‡∏î‡∏π' : 'View' })),
    ...workOrders.filter(wo => wo.currentDept === 'QC' && !wo.labelsPrinted)
      .map(wo => ({ id: `wo-qc-${wo.id}`, type: 'task', title: lang === 'th' ? '‡∏£‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å' : 'Labels Pending', message: `${wo.woNumber || wo.id} at QC`, time: 'Now', action: lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå' : 'Print' })),
    ...inventory.filter(item => item.quantity <= (item.minQty || 10))
      .slice(0, 3).map(item => ({ id: `inv-low-${item.id}`, type: 'alert', title: lang === 'th' ? '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥' : 'Low Stock', message: `${item.name}: ${item.quantity} ${item.unit}`, time: 'Now' })),
    ...purchaseOrders.filter(po => po.status === 'pending' && po.totalAmount > 50000)
      .map(po => ({ id: `po-approval-${po.id}`, type: 'approval', title: lang === 'th' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ PO' : 'PO Pending Approval', message: `${po.poNumber} - ‡∏ø${po.totalAmount?.toLocaleString()}`, time: formatDate(po.date), action: lang === 'th' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : 'Approve' })),
  ]

  // Keyboard shortcuts: Cmd+K for search, Q for quick actions, ESC to close
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Cmd+K or Ctrl+K for Global Search
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        setShowGlobalSearch(true)
        setShowNotifications(false)
        setShowQuickActions(false)
      }
      // Q for Quick Actions (only when not in input)
      if (e.key === 'q' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) {
        e.preventDefault()
        setShowQuickActions(prev => !prev)
        setShowGlobalSearch(false)
        setShowNotifications(false)
      }
      // ESC to close all
      if (e.key === 'Escape') {
        setShowGlobalSearch(false)
        setShowNotifications(false)
        setShowQuickActions(false)
      }
    }
    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [])

  // Handle search navigation
  const handleSearchNavigate = (type, item) => {
    setShowGlobalSearch(false)
    switch (type) {
      case 'customer': setActiveModule('sales'); break
      case 'workOrder': setActiveModule('production'); break
      case 'invoice': setActiveModule('sales'); break
      case 'inventory': setActiveModule('inventory'); break
      case 'purchaseOrder': setActiveModule('purchase'); break
      case 'employee': setActiveModule('hr'); break
    }
  }

  // Handle quick actions
  const handleQuickAction = (actionId) => {
    setShowQuickActions(false)
    switch (actionId) {
      case 'new_wo': setActiveModule('production'); break
      case 'new_so': setActiveModule('sales'); break
      case 'new_po': setActiveModule('purchase'); break
      case 'new_invoice': setActiveModule('sales'); break
      case 'maint_request': setShowMaintenanceRequest(true); break // Opens global modal instead of navigating
    }
  }

  // Handle notification action
  const handleNotificationAction = (notif) => {
    setShowNotifications(false)
    if (notif.id.startsWith('wo-')) setActiveModule('production')
    else if (notif.id.startsWith('inv-')) setActiveModule('inventory')
    else if (notif.id.startsWith('po-')) setActiveModule('purchase')
    else if (notif.id.startsWith('maint-')) setActiveModule('maintenance')
  }

  // Auth handlers
  const handleLogin = (user) => {
    setCurrentUser(user)
    setActiveModule('dashboard')
  }

  const handleLogout = () => {
    setCurrentUser(null)
    setActiveModule('dashboard')
  }

  // Check role permissions
  const hasAccess = (module) => {
    if (!currentUser) return false
    const role = ROLES[currentUser.role]
    return role?.modules.includes(module) || role?.permissions.includes('all')
  }

  // Full navigation items
  const navItems = [
    { id: 'dashboard', label: t('nav.dashboard', lang), icon: Home, color: 'text-blue-500' },
    { id: 'admin', label: t('nav.admin', lang), icon: Settings, color: 'text-purple-500' },
    { id: 'inventory', label: t('nav.inventory', lang), icon: Package, color: 'text-green-500' },
    { id: 'purchase', label: t('nav.purchase', lang), icon: ShoppingCart, color: 'text-yellow-500' },
    { id: 'production', label: t('nav.production', lang), icon: Factory, color: 'text-orange-500' },
    { id: 'sales', label: t('nav.sales', lang), icon: Receipt, color: 'text-pink-500' },
    { id: 'accounting', label: t('nav.accounting', lang), icon: Calculator, color: 'text-emerald-500' },
    { id: 'hr', label: t('nav.hr', lang), icon: Users, color: 'text-indigo-500' },
    { id: 'transport', label: t('nav.transport', lang), icon: Truck, color: 'text-cyan-500' },
    { id: 'maintenance', label: t('nav.maintenance', lang), icon: Wrench, color: 'text-amber-500' },
    { id: 'reports', label: t('nav.reports', lang), icon: BarChart3, color: 'text-violet-500' },
  ].filter(item => hasAccess(item.id))

  // Show login if not authenticated
  if (!currentUser) {
    return <LoginScreen onLogin={handleLogin} lang={lang} setLang={setLang} />
  }

  const role = ROLES[currentUser.role]

  return (
    <LanguageContext.Provider value={{ lang, setLang }}>
      <AuthContext.Provider value={{ user: currentUser, logout: handleLogout }}>
        <div className="flex h-screen bg-gray-100">
          {/* Sidebar */}
          <aside className={`${sidebarOpen ? 'w-64' : 'w-20'} bg-white border-r flex flex-col transition-all duration-300`}>
            {/* Logo */}
            <div className="p-4 border-b">
              <div className="flex items-center gap-3">
                <img src={IND_LOGO_SVG} alt="IND" className="w-10 h-10" />
                {sidebarOpen && (
                  <div>
                    <div className="font-bold text-[#1A5276]">IND Thai</div>
                    <div className="text-xs text-gray-500">ERP v{VERSION}</div>
                  </div>
                )}
              </div>
            </div>

            {/* Navigation */}
            <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
              {navItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => setActiveModule(item.id)}
                  className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all ${
                    activeModule === item.id
                      ? 'bg-gradient-to-r from-[#1A5276] to-[#2ECC40] text-white shadow-md'
                      : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  <item.icon className={`w-5 h-5 ${activeModule === item.id ? 'text-white' : item.color}`} />
                  {sidebarOpen && <span className="font-medium">{item.label}</span>}
                </button>
              ))}
            </nav>

            {/* User Info */}
            <div className="p-4 border-t">
              <div className="flex items-center gap-3">
                <div className={`w-10 h-10 rounded-full ${role.color} flex items-center justify-center text-white font-bold`}>
                  {currentUser.name.charAt(0)}
                </div>
                {sidebarOpen && (
                  <div className="flex-1 min-w-0">
                    <div className="font-medium text-gray-800 truncate">{currentUser.name}</div>
                    <div className="text-xs text-gray-500 truncate">{role.name}</div>
                  </div>
                )}
              </div>
              {sidebarOpen && (
                <button
                  onClick={handleLogout}
                  className="w-full mt-3 flex items-center justify-center gap-2 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg"
                >
                  <LogOut className="w-4 h-4" />
                  {t('action.logout', lang)}
                </button>
              )}
            </div>
          </aside>

          {/* Main Content */}
          <main className="flex-1 flex flex-col overflow-hidden">
            {/* Top Bar with v7.6 Features */}
            <header className="h-16 bg-white border-b flex items-center justify-between px-6">
              <div className="flex items-center gap-4">
                <button 
                  onClick={() => setSidebarOpen(!sidebarOpen)}
                  className="p-2 hover:bg-gray-100 rounded-lg"
                >
                  <Menu className="w-5 h-5 text-gray-500" />
                </button>
                <div>
                  <h1 className="font-bold text-gray-800">
                    {navItems.find(n => n.id === activeModule)?.label || 'Dashboard'}
                  </h1>
                </div>
              </div>
              <div className="flex items-center gap-3">
                {/* Global Search Button */}
                <button 
                  onClick={() => setShowGlobalSearch(true)}
                  className="flex items-center gap-2 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm text-gray-600 transition-colors"
                >
                  <Search className="w-4 h-4" />
                  <span className="hidden md:inline">{lang === 'th' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : 'Search'}</span>
                  <kbd className="hidden md:inline px-1.5 py-0.5 bg-white rounded text-xs border">‚åòK</kbd>
                </button>
                
                {/* Quick Actions Button */}
                <div className="relative">
                  <button 
                    onClick={() => { setShowQuickActions(!showQuickActions); setShowNotifications(false) }}
                    className="p-2 hover:bg-gray-100 rounded-lg"
                    title={lang === 'th' ? '‡∏ó‡∏≤‡∏á‡∏•‡∏±‡∏î (Q)' : 'Quick Actions (Q)'}
                  >
                    <Zap className="w-5 h-5 text-yellow-500" />
                  </button>
                  <QuickActionsMenu 
                    isOpen={showQuickActions} 
                    onClose={() => setShowQuickActions(false)} 
                    onAction={handleQuickAction} 
                    lang={lang} 
                  />
                </div>
                
                {/* Report Issue Button - Visible to ALL departments */}
                <button 
                  onClick={() => setShowMaintenanceRequest(true)}
                  className="flex items-center gap-2 px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg text-sm font-medium transition-colors"
                  title={lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° / ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤' : 'Report Issue / Request Repair'}
                >
                  <Wrench className="w-4 h-4" />
                  <span className="hidden lg:inline">{lang === 'th' ? '‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°' : 'Report Issue'}</span>
                </button>
                
                {/* Notifications */}
                <div className="relative">
                  <button 
                    onClick={() => { setShowNotifications(!showNotifications); setShowQuickActions(false) }}
                    className="p-2 hover:bg-gray-100 rounded-lg relative"
                  >
                    <Bell className="w-5 h-5 text-gray-500" />
                    {notifications.filter(n => !n.read).length > 0 && (
                      <span className="absolute top-1 right-1 w-4 h-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
                        {notifications.filter(n => !n.read).length}
                      </span>
                    )}
                  </button>
                  <NotificationCenter 
                    isOpen={showNotifications} 
                    onClose={() => setShowNotifications(false)} 
                    notifications={notifications} 
                    onAction={handleNotificationAction} 
                    lang={lang} 
                  />
                </div>
                
                <LanguageSwitcher />
                <Badge variant={currentUser.entity}>{currentUser.entity}</Badge>
              </div>
            </header>
            
            {/* Global Search Modal */}
            <GlobalSearch 
              isOpen={showGlobalSearch} 
              onClose={() => setShowGlobalSearch(false)}
              customers={customers}
              workOrders={workOrders}
              salesOrders={salesOrders}
              invoices={invoices}
              inventory={inventory}
              purchaseOrders={purchaseOrders}
              employees={employees}
              onNavigate={handleSearchNavigate}
              lang={lang}
            />
            
            {/* Global Maintenance Request Modal - Accessible from ALL departments */}
            <GlobalMaintenanceRequestModal
              isOpen={showMaintenanceRequest}
              onClose={() => setShowMaintenanceRequest(false)}
              onSubmit={handleSubmitMaintenanceRequest}
              currentUser={currentUser}
              lang={lang}
            />

            {/* Content Area - All Modules */}
            <div className="flex-1 overflow-auto">
              {activeModule === 'dashboard' && (
                <Dashboard 
                  stores={stores}
                  inventory={inventory}
                  categories={categories}
                  purchaseOrders={purchaseOrders}
                  workOrders={workOrders}
                  salesOrders={salesOrders}
                  invoices={invoices}
                  deliveries={scheduledDeliveries}
                  lang={lang}
                />
              )}
              {activeModule === 'admin' && (
                <AdminHub 
                  stores={stores}
                  setStores={setStores}
                  categories={categories}
                  setCategories={setCategories}
                  departments={departments}
                  setDepartments={setDepartments}
                  vendors={vendors}
                  customers={customers}
                  lang={lang}
                />
              )}
              {activeModule === 'inventory' && (
                <InventoryModule
                  inventory={inventory}
                  setInventory={setInventory}
                  stores={stores}
                  categories={categories}
                  maintenanceStore={maintenanceStore}
                  setMaintenanceStore={setMaintenanceStore}
                  lang={lang}
                />
              )}
              {activeModule === 'purchase' && (
                <PurchaseModule
                  purchaseOrders={purchaseOrders}
                  setPurchaseOrders={setPurchaseOrders}
                  vendors={vendors}
                  categories={categories}
                  stores={stores}
                  inventory={inventory}
                  setInventory={setInventory}
                  lang={lang}
                />
              )}
              {activeModule === 'production' && (
                <div className="flex flex-col h-full">
                  {/* Production View Toggle - v7.6 Feature */}
                  <div className="bg-white border-b px-6 py-3 flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <h2 className="font-bold text-gray-700">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï' : 'Production'}</h2>
                      <span className="text-sm text-gray-500">
                        {workOrders.filter(wo => wo.status !== 'completed').length} {lang === 'th' ? '‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'active WOs'}
                      </span>
                    </div>
                    <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                      <button 
                        onClick={() => setProductionView('tabs')}
                        className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${productionView === 'tabs' ? 'bg-white shadow text-[#1A5276]' : 'text-gray-500 hover:text-gray-700'}`}
                      >
                        {lang === 'th' ? '‡πÅ‡∏ó‡πá‡∏ö' : 'Tabs'}
                      </button>
                      <button 
                        onClick={() => setProductionView('kanban')}
                        className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${productionView === 'kanban' ? 'bg-white shadow text-[#1A5276]' : 'text-gray-500 hover:text-gray-700'}`}
                      >
                        Kanban
                      </button>
                    </div>
                  </div>
                  
                  {/* Production Content */}
                  <div className="flex-1 overflow-hidden">
                    {productionView === 'kanban' ? (
                      <KanbanBoard
                        workOrders={workOrders}
                        setWorkOrders={setWorkOrders}
                        customers={customers}
                        lang={lang}
                      />
                    ) : (
                      <ProductionModule
                        workOrders={workOrders}
                        setWorkOrders={setWorkOrders}
                        departments={departments}
                        customers={customers}
                        inventory={inventory}
                        setInventory={setInventory}
                        categories={categories}
                        stores={stores}
                        salesOrders={salesOrders}
                        lang={lang}
                      />
                    )}
                  </div>
                </div>
              )}
              {activeModule === 'sales' && (
                <SalesModuleFull
                  quotations={quotations}
                  setQuotations={setQuotations}
                  salesOrders={salesOrders}
                  setSalesOrders={setSalesOrders}
                  deliveryOrders={deliveryOrders}
                  setDeliveryOrders={setDeliveryOrders}
                  invoices={invoices}
                  setInvoices={setInvoices}
                  rejections={rejections}
                  setRejections={setRejections}
                  claims={claims}
                  setClaims={setClaims}
                  creditNotes={creditNotes}
                  setCreditNotes={setCreditNotes}
                  salesMeetings={salesMeetings}
                  setSalesMeetings={setSalesMeetings}
                  customers={customers}
                  workOrders={workOrders}
                  products={products}
                  trucks={trucks}
                  employees={employees}
                  lang={lang}
                />
              )}
              {activeModule === 'accounting' && (
                <AccountingModule
                  invoices={invoices}
                  purchaseOrders={purchaseOrders}
                  vendors={vendors}
                  customers={customers}
                  lang={lang}
                />
              )}
              {activeModule === 'hr' && (
                <HRModuleFull
                  employees={employees}
                  setEmployees={setEmployees}
                  lang={lang}
                />
              )}
              {activeModule === 'transport' && (
                <TransportModule
                  deliveries={scheduledDeliveries}
                  setDeliveries={setScheduledDeliveries}
                  trucks={trucks}
                  employees={employees}
                  salesOrders={salesOrders}
                  lang={lang}
                />
              )}
              {activeModule === 'maintenance' && (
                <MaintenanceModule
                  tasks={maintenanceTasks}
                  setTasks={setMaintenanceTasks}
                  equipment={equipment}
                  setEquipment={setEquipment}
                  employees={employees}
                  maintenanceRequests={maintenanceRequests}
                  setMaintenanceRequests={setMaintenanceRequests}
                  maintenanceStore={maintenanceStore}
                  setMaintenanceStore={setMaintenanceStore}
                  lang={lang}
                />
              )}
              {activeModule === 'reports' && (
                <ReportsModule
                  inventory={inventory}
                  purchaseOrders={purchaseOrders}
                  workOrders={workOrders}
                  salesOrders={salesOrders}
                  invoices={invoices}
                  categories={categories}
                  stores={stores}
                  customers={customers}
                  vendors={vendors}
                  employees={employees}
                  lang={lang}
                />
              )}
            </div>
          </main>
        </div>
      </AuthContext.Provider>
    </LanguageContext.Provider>
  )
}

// ============================================
// PURCHASE DASHBOARD COMPONENT
// ============================================
const PurchaseDashboard = ({ stats, purchaseOrders, vendors, onReceive, onPrePrint, lang }) => {
  const pendingOrders = purchaseOrders.filter(p => p.status !== 'received').slice(0, 5)

  return (
    <div className="space-y-6">
      {/* Stats Cards */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <Card className="p-4">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'Total POs'}</div>
          <div className="text-2xl font-bold text-gray-800">{stats.totalPOs}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-yellow-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Pending'}</div>
          <div className="text-2xl font-bold text-yellow-600">{stats.pendingPOs}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-orange-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : 'Partial'}</div>
          <div className="text-2xl font-bold text-orange-600">{stats.partialPOs || 0}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-green-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°' : 'Total Value'}</div>
          <div className="text-2xl font-bold text-green-600">{formatCurrency(stats.totalValue)}</div>
        </Card>
        <Card className="p-4 border-l-4 border-l-blue-500">
          <div className="text-sm text-gray-500">{lang === 'th' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'Pending Value'}</div>
          <div className="text-2xl font-bold text-blue-600">{formatCurrency(stats.pendingValue)}</div>
        </Card>
      </div>

      {/* Two Column Layout */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Pending Orders */}
        <Card className="p-5">
          <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Pending Receipt'}</h3>
          <div className="space-y-3">
            {pendingOrders.map(po => {
              const vendor = vendors.find(v => v.id === po.vendorId)
              return (
                <div key={po.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div>
                    <div className="flex items-center gap-2">
                      <span className="font-mono text-[#1A5276]">{po.id}</span>
                      <Badge variant={po.type === 'import' ? 'info' : 'success'}>
                        {po.type === 'import' ? 'üö¢' : 'üè†'}
                      </Badge>
                    </div>
                    <div className="text-sm text-gray-500">{vendor?.name}</div>
                  </div>
                  <div className="flex gap-2">
                    <Button size="sm" variant="outline" icon={Printer} onClick={() => onPrePrint(po)}>
                      {lang === 'th' ? '‡∏â‡∏•‡∏≤‡∏Å' : 'Labels'}
                    </Button>
                    <Button size="sm" icon={Package} onClick={() => onReceive(po)}>
                      {lang === 'th' ? '‡∏£‡∏±‡∏ö' : 'Receive'}
                    </Button>
                  </div>
                </div>
              )
            })}
            {pendingOrders.length === 0 && (
              <p className="text-gray-400 text-center py-4">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'No pending orders'}</p>
            )}
          </div>
        </Card>

        {/* Import Summary */}
        <Card className="p-5">
          <h3 className="font-bold text-gray-800 mb-4">{lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import Summary'}</h3>
          <div className="space-y-4">
            {purchaseOrders.filter(po => po.type === 'import').slice(0, 3).map(po => {
              const vendor = vendors.find(v => v.id === po.vendorId)
              return (
                <div key={po.id} className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-mono text-[#1A5276]">{po.id}</span>
                    <Badge variant={po.status === 'received' ? 'success' : 'warning'}>{po.status}</Badge>
                  </div>
                  <div className="text-sm text-gray-600">{vendor?.name}</div>
                  <div className="grid grid-cols-2 gap-2 mt-2 text-xs">
                    <div>
                      <span className="text-gray-500">{lang === 'th' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏:' : 'Materials:'}</span>
                      <span className="ml-1 font-medium">{formatCurrency(po.subtotal || 0)}</span>
                    </div>
                    <div>
                      <span className="text-gray-500">{lang === 'th' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:' : 'Import:'}</span>
                      <span className="ml-1 font-medium text-orange-600">{formatCurrency(po.totalImportCosts || 0)}</span>
                    </div>
                  </div>
                </div>
              )
            })}
          </div>
        </Card>
      </div>
    </div>
  )
}

// ============================================
// PURCHASE ORDER LIST
// ============================================
const PurchaseOrderList = ({ purchaseOrders, vendors, onEdit, onReceive, onPrintLabels, lang }) => {
  const [filter, setFilter] = useState('all')
  const [search, setSearch] = useState('')

  const filteredPOs = purchaseOrders.filter(po => {
    const matchFilter = filter === 'all' || po.status === filter || po.type === filter
    const matchSearch = !search || 
      po.id.toLowerCase().includes(search.toLowerCase()) ||
      vendors.find(v => v.id === po.vendorId)?.name.toLowerCase().includes(search.toLowerCase())
    return matchFilter && matchSearch
  })

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex items-center gap-4">
        <div className="relative flex-1 max-w-md">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
          <input
            type="text"
            placeholder={lang === 'th' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PO ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...' : 'Search PO or vendor...'}
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border rounded-lg"
          />
        </div>
        <select
          value={filter}
          onChange={(e) => setFilter(e.target.value)}
          className="px-3 py-2 border rounded-lg"
        >
          <option value="all">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All'}</option>
          <option value="pending">{lang === 'th' ? '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Pending'}</option>
          <option value="partial">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' : 'Partial'}</option>
          <option value="received">{lang === 'th' ? '‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'Received'}</option>
          <option value="local">{lang === 'th' ? '‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' : 'Local'}</option>
          <option value="import">{lang === 'th' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import'}</option>
        </select>
      </div>

      {/* Table */}
      <Card className="overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'PO #'}</th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Vendor'}</th>
              <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}</th>
              <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Materials'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import'}</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°' : 'Total'}</th>
              <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
              <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£' : 'Actions'}</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {filteredPOs.map(po => {
              const vendor = vendors.find(v => v.id === po.vendorId)
              return (
                <tr key={po.id} className="hover:bg-gray-50">
                  <td className="px-4 py-3">
                    <div className="font-mono text-[#1A5276] font-medium">{po.id}</div>
                    {po.vendorInvoice && <div className="text-xs text-gray-400">{po.vendorInvoice}</div>}
                  </td>
                  <td className="px-4 py-3">
                    <div className="font-medium">{vendor?.name}</div>
                    <div className="text-xs text-gray-400">{vendor?.country}</div>
                  </td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={po.type === 'import' ? 'info' : 'success'}>
                      {po.type === 'import' ? 'üö¢ Import' : 'üè† Local'}
                    </Badge>
                  </td>
                  <td className="px-4 py-3 text-sm">{formatDate(po.poDate)}</td>
                  <td className="px-4 py-3 text-right">{formatCurrency(po.subtotal || 0)}</td>
                  <td className="px-4 py-3 text-right text-orange-600">
                    {po.type === 'import' ? formatCurrency(po.totalImportCosts || 0) : '-'}
                  </td>
                  <td className="px-4 py-3 text-right font-bold text-[#2ECC40]">
                    {formatCurrency(po.total || po.grandTotal || 0)}
                  </td>
                  <td className="px-4 py-3 text-center">
                    <Badge variant={
                      po.status === 'received' ? 'success' :
                      po.status === 'partial' ? 'warning' :
                      po.status === 'in_transit' ? 'info' :
                      'default'
                    }>
                      {po.status}
                    </Badge>
                  </td>
                  <td className="px-4 py-3 text-center">
                    <div className="flex items-center justify-center gap-1">
                      <button 
                        className="p-1 hover:bg-gray-100 rounded" 
                        title={lang === 'th' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : 'Edit'}
                        onClick={() => onEdit(po)}
                      >
                        <Edit3 className="w-4 h-4 text-gray-500" />
                      </button>
                      {po.status !== 'received' && (
                        <>
                          <button 
                            className="p-1 hover:bg-gray-100 rounded" 
                            title={lang === 'th' ? '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å' : 'Print Labels'}
                            onClick={() => onPrintLabels(po)}
                          >
                            <Printer className="w-4 h-4 text-blue-500" />
                          </button>
                          <button 
                            className="p-1 hover:bg-gray-100 rounded" 
                            title={lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Receive'}
                            onClick={() => onReceive(po)}
                          >
                            <Package className="w-4 h-4 text-green-500" />
                          </button>
                        </>
                      )}
                    </div>
                  </td>
                </tr>
              )
            })}
          </tbody>
        </table>
      </Card>
    </div>
  )
}

// ============================================
// GOODS RECEIPT LIST
// ============================================
const GoodsReceiptList = ({ purchaseOrders, vendors, onReceive, lang }) => {
  const pendingPOs = purchaseOrders.filter(po => po.status !== 'received')

  return (
    <div className="space-y-4">
      <Card className="p-4 bg-green-50 border-green-100">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
            <Package className="w-5 h-5 text-green-600" />
          </div>
          <div>
            <h3 className="font-bold text-green-800">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Goods Receipt Queue'}</h3>
            <p className="text-sm text-green-600">
              {pendingPOs.length} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'items pending receipt'}
            </p>
          </div>
        </div>
      </Card>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {pendingPOs.map(po => {
          const vendor = vendors.find(v => v.id === po.vendorId)
          return (
            <Card key={po.id} className="p-4 hover:shadow-md transition-all">
              <div className="flex items-start justify-between mb-3">
                <div>
                  <div className="font-mono text-[#1A5276] font-bold">{po.id}</div>
                  <Badge variant={po.type === 'import' ? 'info' : 'success'} className="mt-1">
                    {po.type === 'import' ? 'üö¢ Import' : 'üè† Local'}
                  </Badge>
                </div>
                <Badge variant={po.status === 'partial' ? 'warning' : 'default'}>{po.status}</Badge>
              </div>
              <div className="text-sm text-gray-600 mb-2">{vendor?.name}</div>
              <div className="text-xs text-gray-400 mb-3">
                {lang === 'th' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á:' : 'Due:'} {formatDate(po.deliveryDate || po.expectedDelivery)}
              </div>
              <div className="flex items-center justify-between">
                <div className="font-bold text-[#2ECC40]">{formatCurrency(po.total || po.grandTotal || 0)}</div>
                <Button size="sm" icon={Package} onClick={() => onReceive(po)}>
                  {lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Receive'}
                </Button>
              </div>
            </Card>
          )
        })}
      </div>

      {pendingPOs.length === 0 && (
        <Card className="p-8 text-center">
          <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Check className="w-8 h-8 text-green-500" />
          </div>
          <h3 className="font-bold text-gray-800 mb-2">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏£‡∏±‡∏ö' : 'All Caught Up!'}</h3>
          <p className="text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß' : 'All purchase orders have been received'}</p>
        </Card>
      )}
    </div>
  )
}

// ============================================
// VENDOR LIST
// ============================================
const VendorList = ({ vendors, lang }) => {
  const [search, setSearch] = useState('')
  const [filter, setFilter] = useState('all')

  const filteredVendors = vendors.filter(v => {
    const matchFilter = filter === 'all' || v.type === filter
    const matchSearch = !search || 
      v.name.toLowerCase().includes(search.toLowerCase()) ||
      v.code.toLowerCase().includes(search.toLowerCase())
    return matchFilter && matchSearch
  })

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex items-center gap-4">
        <div className="relative flex-1 max-w-md">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
          <input
            type="text"
            placeholder={lang === 'th' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢...' : 'Search vendors...'}
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border rounded-lg"
          />
        </div>
        <select
          value={filter}
          onChange={(e) => setFilter(e.target.value)}
          className="px-3 py-2 border rounded-lg"
        >
          <option value="all">{lang === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All'}</option>
          <option value="local">{lang === 'th' ? '‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' : 'Local'}</option>
          <option value="import">{lang === 'th' ? '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import'}</option>
        </select>
        <Button icon={Plus}>{lang === 'th' ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢' : 'Add Vendor'}</Button>
      </div>

      {/* Vendor Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {filteredVendors.map(v => (
          <Card key={v.id} className="p-4">
            <div className="flex items-start justify-between mb-3">
              <div>
                <div className="font-bold text-gray-800">{v.name}</div>
                <div className="text-sm text-gray-500">{v.nameTh}</div>
              </div>
              <Badge variant={v.type === 'import' ? 'info' : 'success'}>{v.type}</Badge>
            </div>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡∏£‡∏´‡∏±‡∏™' : 'Code'}</span>
                <span className="font-mono">{v.code}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : 'Category'}</span>
                <span>{v.category}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' : 'Country'}</span>
                <span>{v.country}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">{lang === 'th' ? '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' : 'Terms'}</span>
                <span>{v.paymentTerms} {lang === 'th' ? '‡∏ß‡∏±‡∏ô' : 'days'}</span>
              </div>
            </div>
            <div className="mt-4 pt-4 border-t">
              <div className="text-sm">
                <div className="text-gray-500">{lang === 'th' ? '‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' : 'Contact'}</div>
                <div className="font-medium">{v.contact}</div>
                <div className="text-gray-500">{v.phone}</div>
              </div>
            </div>
          </Card>
        ))}
      </div>
    </div>
  )
}

// ============================================
// DELIVERY ORDER LIST (For Sales)
// ============================================
const DeliveryOrderList = ({ deliveryOrders, salesOrders, customers, trucks, lang }) => {
  return (
    <Card className="overflow-hidden">
      <div className="p-4 bg-cyan-50 border-b border-cyan-100">
        <h3 className="font-bold text-cyan-800">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Delivery Orders'}</h3>
      </div>
      <table className="w-full">
        <thead className="bg-gray-50">
          <tr>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà' : 'DO #'}</th>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' : 'Customer'}</th>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' : 'Date'}</th>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏£‡∏ñ' : 'Vehicle'}</th>
            <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}</th>
          </tr>
        </thead>
        <tbody className="divide-y">
          {deliveryOrders.map(d => {
            const so = salesOrders.find(s => s.id === d.soId)
            const customer = customers.find(c => c.id === (d.customerId || so?.customerId))
            const truck = trucks.find(t => t.id === d.vehicleId)
            return (
              <tr key={d.id} className="hover:bg-gray-50">
                <td className="px-4 py-3 font-mono text-[#1A5276]">{d.id}</td>
                <td className="px-4 py-3">{customer?.name}</td>
                <td className="px-4 py-3">{formatDate(d.deliveryDate || d.date)}</td>
                <td className="px-4 py-3">
                  {truck ? `${truck.licensePlate} - ${truck.driver}` : '-'}
                </td>
                <td className="px-4 py-3 text-center">
                  <Badge variant={
                    d.status === 'delivered' ? 'success' :
                    d.status === 'in_transit' ? 'info' :
                    'warning'
                  }>
                    {d.status}
                  </Badge>
                </td>
              </tr>
            )
          })}
        </tbody>
      </table>
    </Card>
  )
}


// ============================================
// PRODUCTION FLOOR VIEW (Detailed)
// ============================================
const ProductionFloorView = ({ workOrders, departments, onComplete, lang }) => {
  const activeWOs = workOrders.filter(wo => wo.status === 'in_progress')
  
  const getWOsByDepartment = (deptId) => {
    return activeWOs.filter(wo => wo.currentDepartment === deptId || wo.department === deptId)
  }

  return (
    <div className="space-y-6">
      {/* Summary Stats */}
      <div className="grid grid-cols-4 gap-4">
        <Card className="p-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white">
          <div className="text-blue-100">{lang === 'th' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï' : 'In Production'}</div>
          <div className="text-3xl font-bold">{activeWOs.length}</div>
        </Card>
        <Card className="p-4 bg-gradient-to-r from-green-500 to-green-600 text-white">
          <div className="text-green-100">{lang === 'th' ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : 'Completed Today'}</div>
          <div className="text-3xl font-bold">{workOrders.filter(wo => wo.status === 'completed' && wo.completedDate === new Date().toISOString().split('T')[0]).length}</div>
        </Card>
        <Card className="p-4 bg-gradient-to-r from-orange-500 to-orange-600 text-white">
          <div className="text-orange-100">{lang === 'th' ? '‡∏£‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Waiting Material'}</div>
          <div className="text-3xl font-bold">{workOrders.filter(wo => wo.status === 'waiting_material').length}</div>
        </Card>
        <Card className="p-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white">
          <div className="text-purple-100">{lang === 'th' ? '‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤' : 'Delayed'}</div>
          <div className="text-3xl font-bold">{workOrders.filter(wo => wo.status === 'delayed').length}</div>
        </Card>
      </div>

      {/* Department Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {departments.map(dept => {
          const deptWOs = getWOsByDepartment(dept.id)
          const typeInfo = DEPARTMENT_TYPES.find(t => t.id === dept.type)
          return (
            <Card key={dept.id} className="overflow-hidden">
              <div 
                className="p-3 text-white flex items-center justify-between"
                style={{ backgroundColor: typeInfo?.color || '#6B7280' }}
              >
                <div>
                  <div className="font-bold">{dept.code}</div>
                  <div className="text-sm opacity-80">{lang === 'th' ? dept.nameTh : dept.nameEn}</div>
                </div>
                <div className="text-2xl font-bold">{deptWOs.length}</div>
              </div>
              <div className="p-3 space-y-2 max-h-64 overflow-y-auto">
                {deptWOs.length > 0 ? deptWOs.map(wo => (
                  <div key={wo.id} className="p-2 bg-gray-50 rounded-lg text-sm">
                    <div className="flex items-center justify-between">
                      <span className="font-mono text-[#1A5276] font-medium">{wo.id}</span>
                      <Badge variant={wo.priority === 'high' ? 'danger' : wo.priority === 'medium' ? 'warning' : 'default'}>
                        {wo.priority}
                      </Badge>
                    </div>
                    <div className="text-gray-600 truncate">{wo.productName}</div>
                    <div className="flex items-center justify-between mt-2">
                      <span className="text-gray-400">{wo.quantity} pcs</span>
                      {wo.progress !== undefined && (
                        <div className="w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-green-500 rounded-full" 
                            style={{ width: `${wo.progress || 0}%` }}
                          />
                        </div>
                      )}
                    </div>
                  </div>
                )) : (
                  <p className="text-gray-400 text-center py-4">{lang === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô' : 'No jobs'}</p>
                )}
              </div>
            </Card>
          )
        })}
      </div>
    </div>
  )
}

// ============================================
// EMPLOYEE FORM
// ============================================
const EmployeeForm = ({ employee, departments, onSave, onCancel, lang }) => {
  const [formData, setFormData] = useState({
    nameEn: employee?.nameEn || '',
    nameTh: employee?.nameTh || '',
    department: employee?.department || '',
    position: employee?.position || '',
    type: employee?.type || 'FT',
    salary: employee?.salary || 0,
    positionInc: employee?.positionInc || 0,
    diligenceInc: employee?.diligenceInc || 0,
    phoneAllowance: employee?.phoneAllowance || 0,
    entity: employee?.entity || 'IND',
    startDate: employee?.startDate || new Date().toISOString().split('T')[0],
    status: employee?.status || 'active',
    bankAccount: employee?.bankAccount || '',
    taxId: employee?.taxId || '',
  })

  const handleSubmit = (e) => {
    e.preventDefault()
    onSave(formData)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Basic Info */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠ (EN) *' : 'Name (EN) *'}
          </label>
          <input
            type="text"
            required
            value={formData.nameEn}
            onChange={(e) => setFormData({ ...formData, nameEn: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ä‡∏∑‡πà‡∏≠ (TH) *' : 'Name (TH) *'}
          </label>
          <input
            type="text"
            required
            value={formData.nameTh}
            onChange={(e) => setFormData({ ...formData, nameTh: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
      </div>

      {/* Department & Position */}
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏Å *' : 'Department *'}
          </label>
          <select
            required
            value={formData.department}
            onChange={(e) => setFormData({ ...formData, department: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="">{lang === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å' : 'Select Department'}</option>
            {departments.map(d => (
              <option key={d.id} value={d.code}>{d.code} - {lang === 'th' ? d.nameTh : d.nameEn}</option>
            ))}
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á *' : 'Position *'}
          </label>
          <input
            type="text"
            required
            value={formData.position}
            onChange={(e) => setFormData({ ...formData, position: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' : 'Type'}
          </label>
          <select
            value={formData.type}
            onChange={(e) => setFormData({ ...formData, type: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="FT">{lang === 'th' ? '‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (FT)' : 'Full-time (FT)'}</option>
            <option value="PT">{lang === 'th' ? '‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏ó‡∏°‡πå (PT)' : 'Part-time (PT)'}</option>
            <option value="CT">{lang === 'th' ? '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á (CT)' : 'Contract (CT)'}</option>
          </select>
        </div>
      </div>

      {/* Salary Info */}
      <div className="p-4 bg-gray-50 rounded-lg">
        <h4 className="font-medium text-gray-800 mb-3">{lang === 'th' ? '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Salary Information'}</h4>
        <div className="grid grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : 'Base Salary'}
            </label>
            <input
              type="number"
              value={formData.salary || ''}
              onChange={(e) => setFormData({ ...formData, salary: parseFloat(e.target.value) || 0 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á' : 'Position Inc'}
            </label>
            <input
              type="number"
              value={formData.positionInc || ''}
              onChange={(e) => setFormData({ ...formData, positionInc: parseFloat(e.target.value) || 0 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡∏Ç‡∏¢‡∏±‡∏ô' : 'Diligence Inc'}
            </label>
            <input
              type="number"
              value={formData.diligenceInc || ''}
              onChange={(e) => setFormData({ ...formData, diligenceInc: parseFloat(e.target.value) || 0 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {lang === 'th' ? '‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå' : 'Phone Allow'}
            </label>
            <input
              type="number"
              value={formData.phoneAllowance || ''}
              onChange={(e) => setFormData({ ...formData, phoneAllowance: parseFloat(e.target.value) || 0 })}
              className="w-full px-3 py-2 border rounded-lg"
            />
          </div>
        </div>
      </div>

      {/* Entity & Start Date */}
      <div className="grid grid-cols-3 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•' : 'Entity'}
          </label>
          <select
            value={formData.entity}
            onChange={(e) => setFormData({ ...formData, entity: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="IND">IND</option>
            <option value="IND2">IND-2</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô' : 'Start Date'}
          </label>
          <input
            type="date"
            value={formData.startDate}
            onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {lang === 'th' ? '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' : 'Status'}
          </label>
          <select
            value={formData.status}
            onChange={(e) => setFormData({ ...formData, status: e.target.value })}
            className="w-full px-3 py-2 border rounded-lg"
          >
            <option value="active">{lang === 'th' ? '‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà' : 'Active'}</option>
            <option value="inactive">{lang === 'th' ? '‡∏•‡∏≤‡∏≠‡∏≠‡∏Å' : 'Inactive'}</option>
          </select>
        </div>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3 pt-4 border-t">
        <Button type="button" variant="secondary" onClick={onCancel}>
          {t('action.cancel', lang)}
        </Button>
        <Button type="submit" icon={Save}>
          {t('action.save', lang)}
        </Button>
      </div>
    </form>
  )
}

// ============================================
// PARTIAL DELIVERY MODAL
// ============================================
const PartialDeliveryModal = ({ so, customers, onClose, onCreateInvoice, lang }) => {
  const [deliveryItems, setDeliveryItems] = useState(
    (so.items || []).map(item => ({
      ...item,
      qtyToDeliver: Math.min(item.qtyRemaining || (item.qty - (item.qtyDelivered || 0)), item.qty),
      maxQty: item.qtyRemaining || (item.qty - (item.qtyDelivered || 0)),
    })).filter(item => item.maxQty > 0)
  )

  const customer = customers.find(c => c.id === so.customerId)

  const updateDeliveryQty = (idx, qty) => {
    const items = [...deliveryItems]
    items[idx].qtyToDeliver = Math.min(Math.max(0, qty), items[idx].maxQty)
    setDeliveryItems(items)
  }

  const totalToDeliver = deliveryItems.reduce((sum, item) => sum + item.qtyToDeliver, 0)
  const totalAmount = deliveryItems.reduce((sum, item) => sum + (item.qtyToDeliver * item.unitPrice), 0)

  // Determine entity based on material
  const hasPlyMaterial = deliveryItems.filter(i => i.qtyToDeliver > 0).some(item => 
    ['PLYRW', 'PLYRR', 'PLYWW', 'PRTB'].includes(item.materialType)
  )
  const entity = hasPlyMaterial ? 'IND2' : 'IND'

  const handleCreate = () => {
    const itemsToInvoice = deliveryItems.filter(item => item.qtyToDeliver > 0)
    if (itemsToInvoice.length > 0) {
      onCreateInvoice(itemsToInvoice, entity)
    }
  }

  return (
    <div className="space-y-4">
      {/* SO Info */}
      <div className="bg-gray-50 rounded-lg p-4">
        <div className="grid grid-cols-3 gap-4 text-sm">
          <div>
            <span className="text-gray-500">{lang === 'th' ? '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢:' : 'Sales Order:'}</span>
            <span className="ml-2 font-mono font-medium text-[#1A5276]">{so.id}</span>
          </div>
          <div>
            <span className="text-gray-500">{lang === 'th' ? 'PO ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:' : 'Customer PO:'}</span>
            <span className="ml-2 font-medium">{so.customerPO || '-'}</span>
          </div>
          <div>
            <span className="text-gray-500">{lang === 'th' ? '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:' : 'Customer:'}</span>
            <span className="ml-2 font-medium">{customer?.name}</span>
          </div>
        </div>
      </div>

      {/* Entity Badge */}
      <div className="flex items-center justify-between">
        <div className="text-sm text-gray-500">
          {lang === 'th' ? '‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏ô‡∏≤‡∏°:' : 'Invoice will be issued under:'}
        </div>
        <Badge variant={entity === 'IND2' ? 'info' : 'success'}>{entity}</Badge>
      </div>

      {/* Items Table */}
      <div className="border rounded-lg overflow-hidden">
        <table className="w-full text-sm">
          <thead className="bg-gray-100">
            <tr>
              <th className="px-4 py-2 text-left font-medium text-gray-600">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Product'}</th>
              <th className="px-4 py-2 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏ß‡∏±‡∏™‡∏î‡∏∏' : 'Material'}</th>
              <th className="px-4 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : 'Remaining'}</th>
              <th className="px-4 py-2 text-center font-medium text-gray-600">{lang === 'th' ? '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πà‡∏á' : 'Qty to Deliver'}</th>
              <th className="px-4 py-2 text-right font-medium text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤' : 'Amount'}</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {deliveryItems.map((item, idx) => (
              <tr key={idx} className="hover:bg-gray-50">
                <td className="px-4 py-3">
                  <div className="font-medium">{item.productName}</div>
                </td>
                <td className="px-4 py-3 text-center">
                  <Badge variant={['PLYRW', 'PLYRR', 'PLYWW', 'PRTB'].includes(item.materialType) ? 'info' : 'default'}>
                    {item.materialType || '-'}
                  </Badge>
                </td>
                <td className="px-4 py-3 text-right text-amber-600 font-medium">
                  {item.maxQty} {item.unit}
                </td>
                <td className="px-4 py-3">
                  <div className="flex items-center justify-center gap-2">
                    <button 
                      onClick={() => updateDeliveryQty(idx, item.qtyToDeliver - 1)}
                      className="p-1 bg-gray-100 hover:bg-gray-200 rounded"
                    >
                      <ChevronLeft className="w-4 h-4" />
                    </button>
                    <input
                      type="number"
                      value={item.qtyToDeliver}
                      onChange={(e) => updateDeliveryQty(idx, parseInt(e.target.value) || 0)}
                      className="w-16 px-2 py-1 border rounded text-center"
                      min={0}
                      max={item.maxQty}
                    />
                    <button 
                      onClick={() => updateDeliveryQty(idx, item.qtyToDeliver + 1)}
                      className="p-1 bg-gray-100 hover:bg-gray-200 rounded"
                    >
                      <ChevronRight className="w-4 h-4" />
                    </button>
                  </div>
                </td>
                <td className="px-4 py-3 text-right font-medium">
                  {formatCurrency(item.qtyToDeliver * item.unitPrice)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Totals */}
      <div className="bg-gray-50 rounded-lg p-4">
        <div className="flex justify-between items-center">
          <div>
            <span className="text-gray-600">{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πà‡∏á:' : 'Total Qty:'}</span>
            <span className="ml-2 font-bold text-lg">{totalToDeliver}</span>
          </div>
          <div>
            <span className="text-gray-600">{lang === 'th' ? '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏£‡∏ß‡∏°:' : 'Total Amount:'}</span>
            <span className="ml-2 font-bold text-lg text-[#2ECC40]">{formatCurrency(totalAmount)}</span>
          </div>
        </div>
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-3">
        <Button variant="secondary" onClick={onClose}>
          {t('action.cancel', lang)}
        </Button>
        <Button icon={Receipt} onClick={handleCreate} disabled={totalToDeliver === 0}>
          {lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ' : 'Create Invoice'}
        </Button>
      </div>
    </div>
  )
}

// ============================================
// COST METHOD SELECTOR
// ============================================
const CostMethodSelector = ({ currentMethod, onSelect, lang }) => {
  const methods = [
    { id: 'FIFO', name: 'FIFO', desc: lang === 'th' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô' : 'First In First Out' },
    { id: 'AVG', name: 'Average', desc: lang === 'th' ? '‡∏ñ‡∏±‡∏ß‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢' : 'Weighted Average' },
    { id: 'STD', name: 'Standard', desc: lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô' : 'Standard Cost' },
  ]

  return (
    <div className="flex gap-2">
      {methods.map(method => (
        <button
          key={method.id}
          onClick={() => onSelect(method.id)}
          className={`px-3 py-2 rounded-lg border-2 transition-all ${
            currentMethod === method.id 
              ? 'border-[#1A5276] bg-[#1A5276]/5 text-[#1A5276]' 
              : 'border-gray-200 hover:border-gray-300'
          }`}
        >
          <div className="font-medium text-sm">{method.name}</div>
          <div className="text-xs text-gray-500">{method.desc}</div>
        </button>
      ))}
    </div>
  )
}

// ============================================
// CBM CALCULATOR
// ============================================
const CBMCalculator = ({ items, lang }) => {
  const totalCBM = items.reduce((sum, item) => {
    const cbm = (item.thickness * item.width * item.length * item.qty) / 1000000000
    return sum + cbm
  }, 0)

  const totalCost = items.reduce((sum, item) => sum + (item.cost || 0), 0)
  const costPerCBM = totalCBM > 0 ? totalCost / totalCBM : 0

  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h4 className="font-bold text-blue-800 mb-3">{lang === 'th' ? '‡∏™‡∏£‡∏∏‡∏õ CBM' : 'CBM Summary'}</h4>
      <div className="grid grid-cols-3 gap-4 text-sm">
        <div>
          <div className="text-blue-600">{lang === 'th' ? '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏£‡∏ß‡∏°' : 'Total Volume'}</div>
          <div className="text-2xl font-bold text-blue-800">{totalCBM.toFixed(4)} m¬≥</div>
        </div>
        <div>
          <div className="text-blue-600">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°' : 'Total Cost'}</div>
          <div className="text-2xl font-bold text-blue-800">{formatCurrency(totalCost)}</div>
        </div>
        <div>
          <div className="text-blue-600">{lang === 'th' ? '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô/CBM' : 'Cost per CBM'}</div>
          <div className="text-2xl font-bold text-blue-800">{formatCurrency(costPerCBM)}</div>
        </div>
      </div>
    </div>
  )
}

// ============================================
// IMPORT COST BREAKDOWN
// ============================================
const ImportCostBreakdown = ({ importCosts, total, lang }) => {
  if (!importCosts || Object.keys(importCosts).length === 0) return null

  const costItems = IMPORT_COST_TYPES.map(type => ({
    ...type,
    amount: importCosts[type.id] || 0
  })).filter(c => c.amount > 0)

  const totalImportCost = costItems.reduce((sum, c) => sum + c.amount, 0)
  const percentOfTotal = total > 0 ? (totalImportCost / total * 100) : 0

  return (
    <Card className="p-4 border-orange-200 bg-orange-50">
      <div className="flex items-center justify-between mb-3">
        <h4 className="font-bold text-orange-800">{lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Import Cost Breakdown'}</h4>
        <Badge variant="warning">{percentOfTotal.toFixed(1)}% {lang === 'th' ? '‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°' : 'of total'}</Badge>
      </div>
      <div className="space-y-2">
        {costItems.map(cost => (
          <div key={cost.id} className="flex justify-between text-sm">
            <span className="text-gray-600">{lang === 'th' ? cost.nameTh : cost.nameEn}</span>
            <span className="font-medium">{formatCurrency(cost.amount)}</span>
          </div>
        ))}
        <div className="pt-2 mt-2 border-t border-orange-200 flex justify-between font-bold">
          <span>{lang === 'th' ? '‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤' : 'Total Import Cost'}</span>
          <span className="text-orange-700">{formatCurrency(totalImportCost)}</span>
        </div>
      </div>
    </Card>
  )
}

// ============================================
// QUICK ACTIONS WIDGET
// ============================================
const QuickActions = ({ onAction, userRole, lang }) => {
  const actions = [
    { id: 'newPO', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á PO' : 'New PO', icon: ShoppingCart, color: 'bg-yellow-500', module: 'purchase' },
    { id: 'newWO', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á WO' : 'New WO', icon: Factory, color: 'bg-orange-500', module: 'production' },
    { id: 'newSO', label: lang === 'th' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢' : 'New SO', icon: Receipt, color: 'bg-pink-500', module: 'sales' },
    { id: 'receive', label: lang === 'th' ? '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : 'Receive', icon: Package, color: 'bg-green-500', module: 'purchase' },
    { id: 'schedule', label: lang === 'th' ? '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á' : 'Schedule', icon: Truck, color: 'bg-cyan-500', module: 'transport' },
    { id: 'report', label: lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô' : 'Reports', icon: BarChart3, color: 'bg-purple-500', module: 'reports' },
  ]

  const role = ROLES[userRole]
  const availableActions = actions.filter(a => role?.modules.includes(a.module) || role?.permissions.includes('all'))

  return (
    <Card className="p-4">
      <h3 className="font-bold text-gray-800 mb-3">{lang === 'th' ? '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô' : 'Quick Actions'}</h3>
      <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
        {availableActions.map(action => (
          <button
            key={action.id}
            onClick={() => onAction(action.id)}
            className={`${action.color} text-white p-3 rounded-lg hover:opacity-90 transition-all flex flex-col items-center justify-center gap-1`}
          >
            <action.icon className="w-5 h-5" />
            <span className="text-xs font-medium">{action.label}</span>
          </button>
        ))}
      </div>
    </Card>
  )
}

// ============================================
// NOTIFICATION BADGE
// ============================================
const NotificationBadge = ({ count, onClick }) => {
  if (!count || count === 0) return null
  return (
    <button 
      onClick={onClick}
      className="relative p-2 hover:bg-gray-100 rounded-lg"
    >
      <Bell className="w-5 h-5 text-gray-500" />
      <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">
        {count > 9 ? '9+' : count}
      </span>
    </button>
  )
}

// ============================================
// LOW STOCK ALERT
// ============================================
const LowStockAlert = ({ inventory, threshold = 100, lang }) => {
  const lowStockItems = inventory.filter(item => item.qty < threshold && item.qty > 0)
  
  if (lowStockItems.length === 0) return null

  return (
    <Card className="p-4 border-red-200 bg-red-50">
      <div className="flex items-center gap-2 mb-3">
        <AlertTriangle className="w-5 h-5 text-red-500" />
        <h4 className="font-bold text-red-800">{lang === 'th' ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î' : 'Low Stock Alert'}</h4>
        <Badge variant="danger">{lowStockItems.length}</Badge>
      </div>
      <div className="space-y-2 max-h-40 overflow-y-auto">
        {lowStockItems.slice(0, 5).map(item => (
          <div key={item.id} className="flex justify-between text-sm p-2 bg-white rounded">
            <span className="font-mono text-red-700">{item.code}</span>
            <span className="text-red-600 font-medium">{item.qty} {lang === 'th' ? '‡∏ä‡∏¥‡πâ‡∏ô' : 'pcs'}</span>
          </div>
        ))}
        {lowStockItems.length > 5 && (
          <p className="text-sm text-red-500 text-center">
            +{lowStockItems.length - 5} {lang === 'th' ? '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' : 'more items'}
          </p>
        )}
      </div>
    </Card>
  )
}

// ============================================
// CURRENCY DISPLAY
// ============================================
const CurrencyDisplay = ({ amount, currency = 'THB', showSymbol = true }) => {
  const symbols = { THB: '‡∏ø', USD: '$', EUR: '‚Ç¨', MYR: 'RM' }
  const formatted = formatCurrency(amount)
  
  if (currency === 'THB') return <span>{formatted}</span>
  return <span>{showSymbol && symbols[currency]}{amount.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>
}

// ============================================
// DATE RANGE PICKER
// ============================================
const DateRangePicker = ({ from, to, onChange, lang }) => {
  return (
    <div className="flex items-center gap-2">
      <div className="flex items-center gap-2">
        <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏à‡∏≤‡∏Å' : 'From'}</label>
        <input
          type="date"
          value={from}
          onChange={(e) => onChange({ from: e.target.value, to })}
          className="px-3 py-2 border rounded-lg text-sm"
        />
      </div>
      <span className="text-gray-400">‚Üí</span>
      <div className="flex items-center gap-2">
        <label className="text-sm text-gray-500">{lang === 'th' ? '‡∏ñ‡∏∂‡∏á' : 'To'}</label>
        <input
          type="date"
          value={to}
          onChange={(e) => onChange({ from, to: e.target.value })}
          className="px-3 py-2 border rounded-lg text-sm"
        />
      </div>
    </div>
  )
}

// ============================================
// EXPORT BUTTON
// ============================================
const ExportButton = ({ data, filename, format = 'xlsx', lang }) => {
  const handleExport = () => {
    // In a real app, this would use xlsx library
    console.log('Exporting:', { data, filename, format })
    alert(`${lang === 'th' ? '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô' : 'Exporting as'} ${filename}.${format}`)
  }

  return (
    <Button variant="outline" icon={Download} onClick={handleExport}>
      {lang === 'th' ? '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å' : 'Export'} {format.toUpperCase()}
    </Button>
  )
}

// ============================================
// SEARCH INPUT
// ============================================
const SearchInput = ({ value, onChange, placeholder, lang }) => {
  return (
    <div className="relative">
      <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder || (lang === 'th' ? '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : 'Search...')}
        className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1A5276] focus:border-transparent"
      />
      {value && (
        <button 
          onClick={() => onChange('')}
          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
        >
          <X className="w-4 h-4" />
        </button>
      )}
    </div>
  )
}

// ============================================
// LOADING SPINNER
// ============================================
const LoadingSpinner = ({ size = 'md', text }) => {
  const sizes = { sm: 'w-4 h-4', md: 'w-8 h-8', lg: 'w-12 h-12' }
  return (
    <div className="flex flex-col items-center justify-center p-8">
      <div className={`${sizes[size]} border-4 border-gray-200 border-t-[#1A5276] rounded-full animate-spin`} />
      {text && <p className="mt-4 text-gray-500">{text}</p>}
    </div>
  )
}

// ============================================
// EMPTY STATE
// ============================================
const EmptyState = ({ icon: Icon, title, description, action, lang }) => {
  return (
    <div className="flex flex-col items-center justify-center p-12 text-center">
      <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
        <Icon className="w-8 h-8 text-gray-400" />
      </div>
      <h3 className="font-bold text-gray-800 mb-2">{title}</h3>
      {description && <p className="text-gray-500 mb-4 max-w-md">{description}</p>}
      {action && action}
    </div>
  )
}

// ============================================
// CONFIRMATION DIALOG
// ============================================
const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, confirmText, cancelText, variant = 'danger' }) => {
  if (!isOpen) return null

  const variants = {
    danger: 'bg-red-500 hover:bg-red-600',
    warning: 'bg-yellow-500 hover:bg-yellow-600',
    info: 'bg-blue-500 hover:bg-blue-600',
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
        <h3 className="text-lg font-bold text-gray-800 mb-2">{title}</h3>
        <p className="text-gray-600 mb-6">{message}</p>
        <div className="flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
          >
            {cancelText || 'Cancel'}
          </button>
          <button
            onClick={onConfirm}
            className={`px-4 py-2 text-white rounded-lg transition-colors ${variants[variant]}`}
          >
            {confirmText || 'Confirm'}
          </button>
        </div>
      </div>
    </div>
  )
}

// ============================================
// PROGRESS BAR
// ============================================
const ProgressBar = ({ value, max = 100, color = 'green', showLabel = true, size = 'md' }) => {
  const percent = Math.min((value / max) * 100, 100)
  const colors = {
    green: 'bg-green-500',
    blue: 'bg-blue-500',
    yellow: 'bg-yellow-500',
    red: 'bg-red-500',
    purple: 'bg-purple-500',
  }
  const sizes = { sm: 'h-1', md: 'h-2', lg: 'h-3' }

  return (
    <div className="w-full">
      <div className={`w-full bg-gray-200 rounded-full overflow-hidden ${sizes[size]}`}>
        <div 
          className={`h-full ${colors[color]} rounded-full transition-all duration-300`}
          style={{ width: `${percent}%` }}
        />
      </div>
      {showLabel && (
        <div className="text-xs text-gray-500 mt-1 text-right">{percent.toFixed(0)}%</div>
      )}
    </div>
  )
}

// ============================================
// TOOLTIP
// ============================================
const Tooltip = ({ children, content, position = 'top' }) => {
  const [show, setShow] = useState(false)
  
  const positions = {
    top: 'bottom-full left-1/2 -translate-x-1/2 mb-2',
    bottom: 'top-full left-1/2 -translate-x-1/2 mt-2',
    left: 'right-full top-1/2 -translate-y-1/2 mr-2',
    right: 'left-full top-1/2 -translate-y-1/2 ml-2',
  }

  return (
    <div 
      className="relative inline-block"
      onMouseEnter={() => setShow(true)}
      onMouseLeave={() => setShow(false)}
    >
      {children}
      {show && (
        <div className={`absolute z-50 px-2 py-1 text-xs text-white bg-gray-800 rounded whitespace-nowrap ${positions[position]}`}>
          {content}
        </div>
      )}
    </div>
  )
}

// ============================================
// TABS COMPONENT
// ============================================
const Tabs = ({ tabs, activeTab, onChange, variant = 'underline' }) => {
  const variants = {
    underline: 'border-b',
    pills: 'bg-gray-100 p-1 rounded-lg',
  }

  return (
    <div className={`flex gap-1 ${variants[variant]}`}>
      {tabs.map(tab => (
        <button
          key={tab.id}
          onClick={() => onChange(tab.id)}
          className={`flex items-center gap-2 px-4 py-2 transition-all ${
            variant === 'underline'
              ? `border-b-2 ${activeTab === tab.id ? 'border-[#1A5276] text-[#1A5276]' : 'border-transparent text-gray-500 hover:text-gray-700'}`
              : `rounded-md ${activeTab === tab.id ? 'bg-white shadow text-[#1A5276]' : 'text-gray-500 hover:text-gray-700'}`
          }`}
        >
          {tab.icon && <tab.icon className="w-4 h-4" />}
          {tab.label}
          {tab.count !== undefined && (
            <span className={`text-xs px-1.5 py-0.5 rounded-full ${activeTab === tab.id ? 'bg-[#1A5276] text-white' : 'bg-gray-200'}`}>
              {tab.count}
            </span>
          )}
        </button>
      ))}
    </div>
  )
}

// ============================================
// AVATAR
// ============================================
const Avatar = ({ name, size = 'md', color }) => {
  const sizes = { sm: 'w-8 h-8 text-sm', md: 'w-10 h-10 text-base', lg: 'w-12 h-12 text-lg' }
  const initial = name ? name.charAt(0).toUpperCase() : '?'
  
  return (
    <div className={`${sizes[size]} ${color || 'bg-[#1A5276]'} rounded-full flex items-center justify-center text-white font-bold`}>
      {initial}
    </div>
  )
}

// ============================================
// DROPDOWN MENU
// ============================================
const DropdownMenu = ({ trigger, items }) => {
  const [isOpen, setIsOpen] = useState(false)
  const ref = useRef(null)

  useEffect(() => {
    const handleClickOutside = (event) => {
      if (ref.current && !ref.current.contains(event.target)) {
        setIsOpen(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  return (
    <div className="relative" ref={ref}>
      <div onClick={() => setIsOpen(!isOpen)}>{trigger}</div>
      {isOpen && (
        <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-50">
          {items.map((item, idx) => (
            <button
              key={idx}
              onClick={() => { item.onClick(); setIsOpen(false) }}
              className="w-full flex items-center gap-2 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 first:rounded-t-lg last:rounded-b-lg"
            >
              {item.icon && <item.icon className="w-4 h-4" />}
              {item.label}
            </button>
          ))}
        </div>
      )}
    </div>
  )
}

// ============================================
// FINAL VERSION INFO
// ============================================
const VersionInfo = ({ lang }) => {
  return (
    <div className="text-center text-xs text-gray-400 py-4">
      <p>IND Thai Packwell ERP v{VERSION}</p>
      <p>{VERSION_DATE}</p>
      <p>{lang === 'th' ? '‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢' : 'Developed by'} Claude AI</p>
    </div>
  )
}

// End of IND ERP v7.0 - Full Build with Enhanced Purchase Module
// Total Features: 9 Modules, 6 Stores, 12 Categories, 13 Import Cost Types
// NEW in v7: Split Lots, Reject/Add Items GRN, Approval Hierarchy, Import/LC Tracking
// Languages: EN, TH, MY, KH, ZH, JP
// Roles: Admin, Sales, Production, Warehouse, HR, Accounting, Transport, Maintenance

// ============================================
// DEFAULT EXPORT
// ============================================
export default AppFull
